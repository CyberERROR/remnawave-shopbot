{% extends "base.html" %}
{% block title %}Главная{% endblock %}

{% block content %}

<!-- ===== ЗАГОЛОВОК СТРАНИЦЫ ===== -->
<div class="mb-8 flex items-center justify-between">
    <div class="space-y-1">
        <h2 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
            Дашборд
            <span
                class="px-2 py-0.5 rounded-md bg-primary/10 text-primary text-[10px] font-semibold uppercase tracking-widest border border-primary/20">System</span>
        </h2>
        <p class="text-white/40 text-xs font-medium uppercase tracking-[0.2em] ml-1 flex items-center gap-2">
            Статистика и мониторинг ресурсов
            <button onclick="togglePaymentStats()" class="hover:text-white transition-colors flex items-center"
                id="btn-toggle-payments" title="Скрыть/показать доход">
                <span class="material-symbols-outlined text-[16px]" id="icon-toggle-payments">visibility</span>
            </button>
        </p>
    </div>
</div>

<script>
    // Мгновенная инициализация состояния до рендеринга статистики
    (function () {
        const isHidden = localStorage.getItem('hide_payment_stats') === 'true';
        if (isHidden) {
            document.addEventListener('DOMContentLoaded', () => {
                const statsCont = document.getElementById('dash-stats');
                if (statsCont) statsCont.classList.add('hide-payments');
                const icon = document.getElementById('icon-toggle-payments');
                if (icon) icon.innerText = 'visibility_off';
            });
        }
    })();

    function togglePaymentStats() {
        const statsCont = document.getElementById('dash-stats');
        const icon = document.getElementById('icon-toggle-payments');
        if (!statsCont) return;

        const isHidden = statsCont.classList.toggle('hide-payments');
        localStorage.setItem('hide_payment_stats', isHidden);

        if (icon) {
            icon.innerText = isHidden ? 'visibility_off' : 'visibility';
        }

        // Немедленное обновление данных при переключении
        if (typeof refreshSection === 'function') {
            refreshSection('dash-stats');
        }
    }
</script>

<style>
    #dash-stats.hide-payments .payment-stat-block {
        display: none !important;
    }
</style>
<!-- ===== Конец заголовка ===== -->

<!-- ===== СЕКЦИЯ: Карточки статистики ===== -->
<section id="dash-stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8"
    data-fetch-url="{{ url_for('dashboard_stats_partial') }}" data-fetch-interval="120000">
    {% include 'partials/dashboard_stats.html' %}
</section>

<!-- ===== СЕКЦИЯ: Проверка скорости SSH ===== (Стиль Settings) -->
<section class="mb-8">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md relative z-20">
        <div
            class="flex flex-col sm:flex-row items-center sm:items-center justify-between gap-4 mb-6 text-center sm:text-left">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10 flex-shrink-0">
                    <span class="material-symbols-outlined text-3xl">speed</span>
                </div>
                <div class="text-left">
                    <h3 class="text-xl font-bold text-white tracking-tight">Speedtest SSH</h3>
                    <p class="text-white/60 text-xs font-medium">Проверка скорости соединения на серверах</p>
                </div>
            </div>

            <div
                class="bg-black/20 border border-white/5 rounded-xl px-4 py-2 flex items-center sm:items-start justify-center min-w-[140px] w-full sm:w-auto h-fit">
                <div class="flex flex-col items-center sm:items-start w-full">
                    <span class="text-[10px] font-bold text-white/30 uppercase tracking-widest block mb-1">Последний
                        замер:
                        <span id="st-latest-date" class="text-white/50 normal-case tracking-normal ml-1">—</span></span>
                    <div id="st-latest"
                        class="text-xs text-white font-medium text-center sm:text-left leading-relaxed break-words whitespace-normal mt-1">
                        —
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row items-start justify-between gap-6 mb-6">
            <div class="flex-1 w-full">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label
                            class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">SSH
                            цель</label>
                        <div class="soft-select w-full" data-target="st-target">
                            <button type="button"
                                class="soft-select-toggle w-full text-left bg-black/30 border border-white/10 rounded-xl px-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 transition-all font-medium flex items-center justify-between"
                                id="st_target_toggle">
                                <span>Выберите сервер...</span>
                                <span class="material-symbols-outlined text-white/50 text-sm">expand_more</span>
                            </button>
                            <div class="soft-select-menu" id="st_target_menu"></div>
                            <select id="st-target" class="hidden">
                                <!-- Options loaded via JS -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-auto">
                <form id="st-run-form" method="post" class="m-0 w-full sm:w-auto">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="method" value="both" />
                    <button type="submit"
                        class="w-full sm:w-auto px-5 py-2.5 rounded-xl bg-primary/10 border border-primary/20 text-primary font-bold text-xs uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">play_arrow</span>
                        Проверить
                    </button>
                </form>

                <form id="st-run-all-form" action="{{ url_for('run_all_ssh_target_speedtests_route') }}" method="post"
                    class="m-0 w-full sm:w-auto">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit"
                        class="w-full sm:w-auto px-5 py-2.5 rounded-xl bg-white/5 border border-white/10 text-white font-bold text-xs uppercase tracking-widest hover:bg-white/10 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">playlist_play</span>
                        Запустить все
                    </button>
                </form>
            </div>
        </div>

        <div class="h-64 mt-4 bg-black/20 rounded-xl border border-white/5 p-4">
            <canvas id="st-top-canvas"></canvas>
        </div>
    </div>
</section>

<!-- ===== СЕКЦИЯ: Аналитика доходов ===== -->
<section class="mb-8">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center text-green-400">
                    <span class="material-symbols-outlined text-xl">payments</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white">Аналитика доходов</h3>
                    <div class="flex flex-wrap items-center gap-3 mt-1">
                        <div class="flex gap-1 bg-black/30 p-0.5 rounded-lg border border-white/5">
                            <button onclick="setIncomePeriod('today', this)"
                                class="px-2 py-0.5 text-[9px] font-bold uppercase tracking-wider rounded-md transition-all text-white/40 hover:text-white"
                                id="p-today">Сегодня</button>
                            <button onclick="setIncomePeriod('7d', this)"
                                class="px-2 py-0.5 text-[9px] font-bold uppercase tracking-wider rounded-md transition-all text-white/40 hover:text-white"
                                id="p-7d">7 дней</button>
                            <button onclick="setIncomePeriod('30d', this)"
                                class="px-2 py-0.5 text-[9px] font-bold uppercase tracking-wider rounded-md transition-all bg-white/10 text-white"
                                id="p-30d">30 дней</button>
                            <button onclick="setIncomePeriod('3m', this)"
                                class="px-2 py-0.5 text-[9px] font-bold uppercase tracking-wider rounded-md transition-all text-white/40 hover:text-white"
                                id="p-3m">3 мес</button>
                            <button onclick="setIncomePeriod('6m', this)"
                                class="px-2 py-0.5 text-[9px] font-bold uppercase tracking-wider rounded-md transition-all text-white/40 hover:text-white"
                                id="p-6m">6 мес</button>
                            <button onclick="setIncomePeriod('12m', this)"
                                class="px-2 py-0.5 text-[9px] font-bold uppercase tracking-wider rounded-md transition-all text-white/40 hover:text-white"
                                id="p-12m">1 год</button>
                            <button onclick="setIncomePeriod('all', this)"
                                class="px-2 py-0.5 text-[9px] font-bold uppercase tracking-wider rounded-md transition-all text-white/40 hover:text-white"
                                id="p-all">Все</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2 bg-black/30 border border-white/5 rounded-xl px-4 py-2">
                <span class="text-[10px] font-bold text-white/30 uppercase tracking-widest">Итого за период:</span>
                <span id="period-total" class="text-sm font-bold text-green-400">— ₽</span>
            </div>
        </div>
        <div class="h-80"><canvas id="incomeChart"></canvas></div>
    </div>
</section>

<!-- ===== СЕКЦИЯ: Аналитические графики ===== -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                <span class="material-symbols-outlined text-xl">person_add</span>
            </div>
            <h3 class="text-lg font-bold text-white">Новые пользователи</h3>
        </div>
        <div class="h-64"><canvas id="newUsersChart"></canvas></div>
    </div>
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400">
                <span class="material-symbols-outlined text-xl">vpn_key</span>
            </div>
            <h3 class="text-lg font-bold text-white">Новые ключи</h3>
        </div>
        <div class="h-64"><canvas id="newKeysChart"></canvas></div>
    </div>
</section>

<!-- ===== СЕКЦИЯ: Транзакции и Трайлы ===== -->
<section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Transactions -->
    <div
        class="lg:col-span-2 bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md flex flex-col">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center text-green-400">
                <span class="material-symbols-outlined text-xl">receipt_long</span>
            </div>
            <h3 class="text-lg font-bold text-white">Недавние транзакции</h3>
        </div>

        <div id="transactions-wrapper" class="overflow-x-auto rounded-xl border border-white/5 bg-black/20">
            <table class="w-full text-left border-collapse">
                <thead class="bg-white/5 border-b border-white/10">
                    <tr>
                        <th class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40">Пользователь
                        </th>
                        <th class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40">Услуга</th>
                        <th class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40">Сумма</th>
                        <th class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40">Дата</th>
                        <th class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-right">
                        </th>
                    </tr>
                </thead>
                <tbody id="dash-transactions" class="divide-y divide-white/5"
                    data-fetch-url="{{ url_for('dashboard_transactions_partial') }}" data-fetch-interval="120000">
                    <tr>
                        <td colspan="5" class="p-8 text-center">
                            <div class="flex flex-col items-center justify-center text-white/30">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mb-2"></div>
                                <span class="text-xs">Загрузка транзакций...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="transactions-pagination" class="flex justify-center mt-4 gap-1"></div>

        <div id="transactions-empty" class="hidden flex flex-col items-center justify-center py-12 text-white/30">
            <span class="material-symbols-outlined text-4xl mb-2">receipt_long</span>
            <p class="text-sm">Транзакций пока нет</p>
        </div>
    </div>

    <!-- Trials -->
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md flex flex-col h-fit">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-lg bg-orange-500/10 flex items-center justify-center text-orange-400">
                <span class="material-symbols-outlined text-xl">history_toggle_off</span>
            </div>
            <h3 class="text-lg font-bold text-white">Пробные периоды</h3>
        </div>

        <div id="trials-wrapper" class="overflow-x-auto rounded-xl border border-white/5 bg-black/20">
            <table class="w-full text-left border-collapse">
                <thead class="bg-white/5 border-b border-white/10">
                    <tr>
                        <th class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40">Пользователь
                        </th>
                        <th class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40">Дата</th>
                        <th class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-right">
                        </th>
                    </tr>
                </thead>
                <tbody id="dash-trials" class="divide-y divide-white/5"
                    data-fetch-url="{{ url_for('dashboard_trials_partial') }}" data-fetch-interval="120000">
                    <tr>
                        <td colspan="3" class="p-8 text-center">
                            <div class="flex flex-col items-center justify-center text-white/30">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-orange-400 mb-2"></div>
                                <span class="text-xs">Загрузка триалов...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="trials-pagination" class="flex justify-center mt-4 gap-1"></div>

        <div id="trials-empty" class="hidden flex flex-col items-center justify-center py-12 text-white/30">
            <span class="material-symbols-outlined text-4xl mb-2">history_toggle_off</span>
            <p class="text-sm">Триалов пока нет</p>
        </div>
    </div>
</section>

<!-- ===== МОДАЛЬНЫЕ ОКНА ===== -->
<div id="speedtestRunningModal" class="modal-overlay">
    <div class="modal-content p-6">
        <div class="flex items-center gap-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <div>
                <div class="font-semibold text-white">Идёт измерение скорости…</div>
                <div class="text-white/50 text-sm">Пожалуйста, подождите 10–30 секунд</div>
            </div>
        </div>
    </div>
</div>

<div id="speedtestModal" class="modal-overlay modal-xl">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">Скорость — <span id="st-modal-host"></span></h5>
            <button onclick="closeModal('speedtestModal')" class="text-white/50 hover:text-white"><span
                    class="material-symbols-outlined">close</span></button>
        </div>
        <div class="p-6">
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <label class="text-white/70">Метрика:</label>
                <select id="st-metric"
                    class="bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-white text-sm">
                    <option value="download_mbps" selected>Скорость загрузки (Mbps)</option>
                    <option value="upload_mbps">Скорость отдачи (Mbps)</option>
                    <option value="ping_ms">Пинг (ms)</option>
                </select>
                <label class="text-white/70">Период:</label>
                <select id="st-range"
                    class="bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-white text-sm">
                    <option value="24">24 точки</option>
                    <option value="60" selected>60 точек</option>
                    <option value="120">120 точек</option>
                </select>
                <button id="st-refresh"
                    class="px-4 py-1.5 rounded-lg bg-primary/20 text-primary text-sm font-medium hover:bg-primary/30">Обновить</button>
            </div>
            <div class="h-80"><canvas id="st-detail-canvas"></canvas></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        window.dashCharts = {};
        window.topChart = null;
        window.detailChart = null;

        // ===== НАСТРОЙКИ: Графики =====
        const getChartColors = () => {
            const isDark = document.documentElement.classList.contains('dark');
            return {
                bg: isDark ? 'rgba(0, 0, 0, 0.95)' : 'rgba(167, 243, 208, 0.98)',
                text: isDark ? '#e0e0e0' : '#102219',
                border: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(16, 77, 48, 0.2)'
            };
        };

        const chartConfig = {
            type: 'line',
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: true, position: 'top', align: 'end', labels: { color: '#e0e0e0', boxWidth: 12, padding: 20, font: { size: 14 } } },
                    tooltip: {
                        backgroundColor: () => getChartColors().bg,
                        titleColor: () => getChartColors().text,
                        bodyColor: () => getChartColors().text,
                        borderColor: () => getChartColors().border,
                        borderWidth: 1, padding: 10, cornerRadius: 12,
                        usePointStyle: true,
                        boxPadding: 6,
                        titleFont: { family: 'Inter', size: 14, weight: 'bold' },
                        bodyFont: { family: 'Inter', size: 13 }
                    }
                },
                scales: {
                    x: { ticks: { color: 'rgba(224, 224, 224, 0.5)' }, grid: { color: 'rgba(255, 255, 255, 0.1)', drawOnChartArea: false } },
                    y: { ticks: { color: 'rgba(224, 224, 224, 0.5)' }, grid: { color: 'rgba(255, 255, 255, 0.1)', borderDash: [2, 4] }, beginAtZero: true }
                }
            }
        };

        // Слушатель для обновления графиков при смене темы
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    Object.values(window.dashCharts).forEach(chart => {
                        if (chart) chart.update('none');
                    });
                    if (window.topChart) window.topChart.update('none');
                    if (window.detailChart) window.detailChart.update('none');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });

        // ===== ФУНКЦИЯ: Загрузка JSON =====
        const fetchJSON = async (url, params = {}) => {
            const query = new URLSearchParams(params).toString();
            try {
                const data = await apiRequest(url + (query ? '?' + query : ''), { headers: { 'Accept': 'application/json' } });
                return typeof data === 'string' ? JSON.parse(data) : data;
            } catch (e) { return null; }
        };

        // ===== ФУНКЦИЯ: Градиент =====
        const createGrad = (ctx, col) => {
            const g = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
            g.addColorStop(0, col.replace('1)', '0.3)')); g.addColorStop(1, col.replace('1)', '0)'));
            return g;
        };

        // ===== ФУНКЦИЯ: UI Пагинации =====
        const updatePagUI = (type, cp, tp) => {
            const el = document.getElementById(`${type}-pagination`);
            if (!el) return;
            if (tp <= 1) { el.innerHTML = ''; return; }

            const url = new URL(window.location.href); const key = type === 'transactions' ? 'page' : 'trials_page';
            let html = `<div class="flex items-center gap-1 bg-white/5 p-1 rounded-xl border border-white/10 shadow-lg backdrop-blur-sm">`;

            if (cp > 1) {
                url.searchParams.set(key, cp - 1);
                html += `<a href="${url.toString()}" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/10 text-white/50 hover:text-white transition-all transform hover:-translate-x-0.5"><span class="material-symbols-outlined text-sm">chevron_left</span></a>`;
            }

            html += `<span class="px-3 py-1 flex items-center text-white/50 text-xs font-bold">${cp} <span class="mx-1 opacity-50">/</span> ${tp}</span>`;

            if (cp < tp) {
                url.searchParams.set(key, cp + 1);
                html += `<a href="${url.toString()}" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/10 text-white/50 hover:text-white transition-all transform hover:translate-x-0.5"><span class="material-symbols-outlined text-sm">chevron_right</span></a>`;
            }

            html += `</div>`;
            el.innerHTML = html;
        };

        // ===== СИСТЕМА АВТООБНОВЛЕНИЯ РАЗДЕЛОВ =====
        const autoRefreshRegistry = {};

        const refreshSection = async (id) => {
            const el = document.getElementById(id);
            if (!el || !el.dataset.fetchUrl) return;

            let fetchUrl = el.dataset.fetchUrl;
            if (id === 'dash-stats') {
                const isHidden = localStorage.getItem('hide_payment_stats') === 'true';
                const urlObj = new URL(fetchUrl, window.location.origin);
                urlObj.searchParams.set('hide_payments', isHidden);
                fetchUrl = urlObj.toString();
            }

            try {
                const res = await fetch(fetchUrl, { headers: { 'Accept': 'text/html' } });
                if (res.ok) {
                    const html = await res.text();
                    if (isLoginPage(html)) { window.location.reload(); return; }

                    // Для таблиц, если пришел пустой ответ или ответ без строк - надо обработать отдельно
                    // Но здесь endpoint возвращает <tr>...</tr> или "ничего".

                    if (el.innerHTML !== html) {
                        el.style.opacity = '0.5';
                        setTimeout(() => {
                            el.innerHTML = html;
                            el.style.opacity = '1';
                        }, 150);
                    }
                }
            } catch (e) { console.error(`Refresh error (${id}):`, e); }
        };

        const initAutoRefresh = () => {
            document.querySelectorAll('[data-fetch-url][data-fetch-interval]').forEach(el => {
                const id = el.id;
                const interval = parseInt(el.dataset.fetchInterval);
                if (!id || !interval || autoRefreshRegistry[id]) return;

                // Start auto-refresh interval
                autoRefreshRegistry[id] = setInterval(() => refreshSection(id), interval);

                // If this is the stats section (which is not handled by loadTableData), 
                // trigger an immediate refresh to load initial data
                if (id === 'dash-stats') {
                    refreshSection(id);
                }
            });
        };

        // ===== ФУНКЦИЯ: Загрузка таблиц (Транзакции, Триалы) =====
        const loadTableData = async (type) => {
            const cont = document.getElementById(`dash-${type}`);
            const wrapper = document.getElementById(`${type}-wrapper`);
            const emptyEl = document.getElementById(`${type}-empty`);
            if (!cont) return;

            const urlObj = new URL(window.location.href);
            const pageParam = type === 'transactions' ? 'page' : 'trials_page';
            const page = urlObj.searchParams.get(pageParam) || 1;
            const baseUrl = cont.dataset.fetchUrl;

            try {
                const data = await fetchJSON(baseUrl, { page, lazy_load: 1 });
                if (data && data.html && data.html.trim().length > 0) {
                    cont.innerHTML = data.html;
                    wrapper.style.display = 'block';
                    if (emptyEl) emptyEl.style.display = 'none';
                    updatePagUI(type, parseInt(data.current_page), parseInt(data.total_pages));

                    // Start auto-refresh after successful load
                    if (!autoRefreshRegistry[`dash-${type}`] && cont.dataset.fetchInterval) {
                        autoRefreshRegistry[`dash-${type}`] = setInterval(() => refreshSection(`dash-${type}`), parseInt(cont.dataset.fetchInterval));
                    }
                } else {
                    wrapper.style.display = 'none';
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    if (emptyEl) emptyEl.style.display = 'flex';
                    updatePagUI(type, 1, 1);
                }
            } catch (e) {
                console.error(`Load error (${type}):`, e);
                cont.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-400">Ошибка загрузки</td></tr>`;
            }
        };


        // ===== ОБРАБОТКА ПАГИНАЦИИ (AJAX) =====
        const handlePag = async (e, type) => {
            const link = e.target.closest('a');
            if (!link) return;

            e.preventDefault();
            const urlObj = new URL(link.href);
            const page = urlObj.searchParams.get(type === 'transactions' ? 'page' : 'trials_page');
            const cont = document.getElementById(`dash-${type}`);
            const url = type === 'transactions' ? "{{ url_for('dashboard_transactions_partial') }}" : "{{ url_for('dashboard_trials_partial') }}";

            cont.style.opacity = '0.5';
            const data = await fetchJSON(url, { page, ajax_pagination: 1 });

            if (data) {
                cont.innerHTML = data.html;
                cont.dataset.fetchUrl = `${url}?page=${page}`; // Update base URL for auto-refresh
                updatePagUI(type, parseInt(data.current_page), parseInt(data.total_pages));
                history.pushState({}, '', link.href);
            }
            cont.style.opacity = '1';
        };

        ['transactions', 'trials'].forEach(t => {
            const pag = document.getElementById(`${t}-pagination`);
            if (pag) {
                pag.addEventListener('click', e => handlePag(e, t));
            }
            // Initial Load
            loadTableData(t);
        });

        // ===== УПРАВЛЕНИЕ ГРАФИКАМИ =====
        window.dashCharts = {};

        const initMainChart = (id, label, obj) => {
            const ctx = document.getElementById(id)?.getContext('2d');
            if (!ctx) return;
            const dates = Object.keys(obj || {}).sort();

            window.dashCharts[id] = new Chart(ctx, {
                ...chartConfig,
                data: {
                    labels: dates.map(d => d.slice(5, 10).replace(/-/g, '.')),
                    datasets: [{
                        label,
                        data: dates.map(d => obj[d] || 0),
                        borderColor: id === 'newUsersChart' ? '#13ec80' : '#3b82f6',
                        backgroundColor: createGrad(ctx, id === 'newUsersChart' ? 'rgba(19, 236, 128, 1)' : 'rgba(59, 130, 246, 1)'),
                        fill: true, tension: 0.4, pointBackgroundColor: id === 'newUsersChart' ? '#13ec80' : '#3b82f6',
                        pointRadius: 4, pointHoverRadius: 6, borderWidth: 2
                    }]
                },
                options: { ...chartConfig.options, plugins: { ...chartConfig.options.plugins, legend: { display: false } } }
            });
        };

        let currentIncomePeriod = '30d';

        window.setIncomePeriod = function (period, btn) {
            currentIncomePeriod = period;
            document.querySelectorAll('[onclick^="setIncomePeriod"]').forEach(b => {
                b.classList.remove('bg-white/10', 'text-white');
                b.classList.add('text-white/40');
            });
            btn.classList.add('bg-white/10', 'text-white');
            btn.classList.remove('text-white/40');
            refreshCharts();
        };

        const refreshCharts = async () => {
            const data = await fetchJSON(`{{ url_for('dashboard_charts_json') }}?period=${currentIncomePeriod}`);
            if (!data) return;

            if (!window.dashCharts['newUsersChart']) {
                initMainChart('newUsersChart', 'Новые пользователи', data.users);
                initMainChart('newKeysChart', 'Новые ключи', data.keys);
                initIncomeChart(data.income);
            } else {
                const update = (id, obj) => {
                    const chart = window.dashCharts[id];
                    if (!chart) return;
                    const dates = Object.keys(obj || {}).sort();
                    chart.data.labels = dates.map(d => {
                        if (currentIncomePeriod === 'today') return d.slice(11, 16);
                        return d.slice(5, 10).replace(/-/g, '.');
                    });
                    if (chart.data.datasets[0]) {
                        chart.data.datasets[0].data = dates.map(d => obj[d] || 0);
                    }
                    chart.update('none');
                };
                update('newUsersChart', data.users);
                update('newKeysChart', data.keys);
                updateIncomeChart(data.income);
            }
        };

        const methodColors = {
            'YooKassa': '#6366f1',
            'Platega': '#06b6d4',
            'Telegram Stars': '#f59e0b',
            'CryptoBot': '#8b5cf6',
            'Heleket': '#10b981',
            'TON Connect': '#00bfff',
            'Other': '#94a3b8'
        };

        const hexToRgba = (hex, alpha) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const getRelativeTimeJS = (dateStr, isHourly = false) => {
            if (isHourly) {
                const target = new Date(dateStr.replace(' ', 'T'));
                if (isNaN(target.getTime())) return "";
                const now = new Date();
                let diffHours = Math.floor((now - target) / 3600000);
                if (diffHours <= 0) return "менее 1 ч. назад";
                return `${diffHours} ч. назад`;
            }

            const parts = dateStr.split(' ')[0].split('-');
            const y = parts[0], m = parts[1], d = parts[2];
            if (!y || !m || !d) return "";

            const target = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            const diffTime = Math.max(0, now - target);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return "сегодня";
            if (diffDays === 1) return "вчера";

            if (diffDays < 30) {
                return `${diffDays} д. назад`;
            }

            const diffMonths = Math.floor(diffDays / 30);
            if (diffMonths < 12) {
                return `${diffMonths} м. назад`;
            }

            const diffYears = Math.floor(diffDays / 365);
            return `${diffYears} г. назад`;
        };

        const initIncomeChart = (incomeData) => {
            const ctx = document.getElementById('incomeChart').getContext('2d');
            const dates = Object.keys(incomeData || {}).sort();

            const methods = new Set();
            Object.values(incomeData || {}).forEach(day => {
                Object.keys(day).forEach(m => methods.add(m));
            });
            if (!methods.size) ['YooKassa', 'Platega', 'Telegram Stars', 'CryptoBot', 'Heleket', 'TON Connect'].forEach(m => methods.add(m));

            const datasets = Array.from(methods).map(method => ({
                label: method,
                data: dates.map(d => (incomeData[d] && incomeData[d][method]) || 0),
                borderColor: methodColors[method] || '#94a3b8',
                backgroundColor: createGrad(ctx, hexToRgba(methodColors[method] || '#94a3b8', 1)),
                fill: true,
                tension: 0.4,
                pointRadius: (ctx) => {
                    const val = ctx.dataset.data[ctx.dataIndex];
                    return val > 0 ? (dates.length > 50 ? 0 : 4) : 0;
                },
                borderWidth: 2,
                pointHoverRadius: (ctx) => {
                    const val = ctx.dataset.data[ctx.dataIndex];
                    return val > 0 ? 6 : 0;
                },
                pointBackgroundColor: methodColors[method] || '#94a3b8'
            }));

            let total = 0;
            Object.values(incomeData || {}).forEach(day => {
                Object.values(day).forEach(amt => total += amt);
            });
            document.getElementById('period-total').textContent = total.toLocaleString('ru-RU') + ' ₽';

            window.dashCharts['incomeChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => {
                        if (currentIncomePeriod === 'today') return d.slice(11, 16);
                        return d.slice(5, 10).replace(/-/g, '.');
                    }),
                    fullDates: dates,
                    datasets: datasets
                },
                options: {
                    ...chartConfig.options,
                    plugins: {
                        ...chartConfig.options.plugins,
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: 'rgba(255,255,255,0.6)', usePointStyle: true, font: { family: 'Inter', size: 10 }, padding: 20 }
                        },
                        tooltip: {
                            ...chartConfig.options.plugins.tooltip,
                            mode: 'index',
                            intersect: false,
                            filter: function (tooltipItem) {
                                return tooltipItem.raw > 0;
                            },
                            callbacks: {
                                title: function (context) {
                                    if (!context || !context.length) return '';
                                    let chart = context[0].chart;
                                    let idx = context[0].dataIndex;
                                    let rawDate = chart.config.data.fullDates ? chart.config.data.fullDates[idx] : null;
                                    let displayTitle = context[0].label;
                                    if (rawDate) {
                                        let isHourly = currentIncomePeriod === 'today';
                                        let relTime = getRelativeTimeJS(rawDate, isHourly);

                                        let parts = rawDate.split(' ')[0].split('-');
                                        if (parts.length >= 3) {
                                            let dateFmt = `${parts[2]}.${parts[1]}.${parts[0].slice(-2)}`;
                                            if (isHourly) {
                                                displayTitle = `${dateFmt} ${context[0].label}`;
                                            } else {
                                                displayTitle = dateFmt;
                                            }
                                        }

                                        if (relTime) {
                                            return `${displayTitle} (${relTime})`;
                                        }
                                    }
                                    return displayTitle;
                                },
                                label: (context) => ` ${context.dataset.label}: ${context.parsed.y.toLocaleString('ru-RU')} ₽`
                            }
                        }
                    },
                    scales: {
                        x: { ...chartConfig.options.scales.x, stacked: false },
                        y: { ...chartConfig.options.scales.y, stacked: false }
                    }
                }
            });
        };

        const updateIncomeChart = (incomeData) => {
            const chart = window.dashCharts['incomeChart'];
            if (!chart) return;
            const dates = Object.keys(incomeData || {}).sort();

            const methods = new Set();
            Object.values(incomeData).forEach(day => {
                Object.keys(day).forEach(m => methods.add(m));
            });

            const datasets = Array.from(methods).map(method => ({
                label: method,
                data: dates.map(d => (incomeData[d] && incomeData[d][method]) || 0),
                borderColor: methodColors[method] || '#94a3b8',
                backgroundColor: createGrad(chart.ctx, hexToRgba(methodColors[method] || '#94a3b8', 1)),
                fill: true,
                tension: 0.4,
                pointRadius: (ctx) => {
                    const val = ctx.dataset.data[ctx.dataIndex];
                    return val > 0 ? (dates.length > 50 ? 0 : 4) : 0;
                },
                borderWidth: 2,
                pointHoverRadius: (ctx) => {
                    const val = ctx.dataset.data[ctx.dataIndex];
                    return val > 0 ? 6 : 0;
                },
                pointBackgroundColor: methodColors[method] || '#94a3b8'
            }));

            let total = 0;
            Object.values(incomeData).forEach(day => {
                Object.values(day).forEach(amt => total += amt);
            });
            document.getElementById('period-total').textContent = total.toLocaleString('ru-RU') + ' ₽';

            chart.data.labels = dates.map(d => {
                if (currentIncomePeriod === 'today') return d.slice(11, 16);
                return d.slice(5, 10).replace(/-/g, '.');
            });
            chart.data.fullDates = dates;
            chart.data.datasets = datasets;
            chart.update('none');
        };

        // Initialize charts immediately
        refreshCharts();

        // Автообновление графиков раз в 2 минуты
        setInterval(refreshCharts, 120000);

        // ===== ФУНКЦИЯ: Загрузка SSH данных =====
        const targetSelect = document.getElementById('st-target');
        const latestBox = document.getElementById('st-latest');
        const topCanvas = document.getElementById('st-top-canvas');

        const loadSSHTargets = async () => {
            const data = await fetchJSON("{{ url_for('dashboard_ssh_targets_json') }}");
            if (data && data.targets) {
                // Populate Select
                targetSelect.innerHTML = data.targets.map(t => `<option value="${t.target_name}">${t.target_name}</option>`).join('');

                // Restore cache choice
                const cache = localStorage.getItem('st_target_cache');
                if (cache && Array.from(targetSelect.options).some(o => o.value === cache)) {
                    targetSelect.value = cache;
                }

                // Init SoftSelect after population
                window.initSoftSelect('st-target', 'Выберите SSH цель...');

                // Add listener
                targetSelect.addEventListener('change', () => {
                    localStorage.setItem('st_target_cache', targetSelect.value);
                    localStorage.setItem('st_target_time', Date.now());
                    loadTop();
                });

                // Load data immediately if value exists
                if (targetSelect.value) {
                    loadTop();
                } else {
                    // If no targets, show empty state
                    latestBox.textContent = 'Нет целей';
                }
            }
        };

        const loadTop = async () => {
            if (!targetSelect?.value || !topCanvas) return;
            const data = await fetchJSON(`{{ url_for('host_speedtests_json', host_name='__H__') }}`.replace('__H__', encodeURIComponent(targetSelect.value)), { limit: 60 });
            if (!data?.ok) return;
            const items = (data.items || []).slice().reverse();
            if (latestBox) {
                const dateEl = document.getElementById('st-latest-date');
                if (items.length) {
                    const last = items[items.length - 1];
                    if (dateEl) dateEl.textContent = last.created_at;
                    const method = last.method ? `<span class='px-2 py-0.5 rounded bg-primary/20 text-primary text-[10px] font-bold uppercase tracking-wider'>${last.method.toUpperCase()}</span>` : '';
                    const ping = `<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[14px] text-white/70">timer</span>${last.ping_ms ?? '—'} ms</span>`;
                    const down = `<span class="whitespace-nowrap"><span class="text-[#13ec80] font-bold">↓</span> ${last.download_mbps ?? '—'} Mbps</span>`;
                    const up = `<span class="whitespace-nowrap"><span class="text-[#00bfff] font-bold">↑</span> ${last.upload_mbps ?? '—'} Mbps</span>`;

                    latestBox.innerHTML = `
                        <div class="flex flex-wrap items-center justify-center sm:justify-start gap-x-2 gap-y-1">
                            ${method}
                            <span class="text-white/20">·</span>
                            ${ping}
                            <span class="text-white/20">·</span>
                            ${down}
                            <span class="text-white/20">·</span>
                            ${up}
                        </div>
                    `;
                } else {
                    latestBox.textContent = 'Нет данных';
                    if (dateEl) dateEl.textContent = '—';
                }
            }
            const ctx = topCanvas.getContext('2d'); if (topChart) topChart.destroy();
            topChart = new Chart(ctx, {
                ...chartConfig,
                data: {
                    labels: items.map(it => it.created_at.slice(5, 16).replace(/-/g, '.')),
                    datasets: [
                        { label: 'Загрузка Mbps', data: items.map(it => parseFloat(it.download_mbps) || 0), borderColor: '#13ec80', backgroundColor: createGrad(ctx, 'rgba(19, 236, 128, 1)'), fill: true, tension: 0.3, pointRadius: 4, pointHoverRadius: 6, borderWidth: 2 },
                        { label: 'Отдача Mbps', data: items.map(it => parseFloat(it.upload_mbps) || 0), borderColor: '#00bfff', backgroundColor: createGrad(ctx, 'rgba(0, 191, 255, 1)'), fill: true, tension: 0.3, pointRadius: 4, pointHoverRadius: 6, borderWidth: 2 }
                    ]
                }
            });
        };

        // Trigger SSH target load
        if (targetSelect) loadSSHTargets();


        // ===== ФУНКЦИЯ: Формы Speedtest =====
        const handleForm = (id, getUrl, delay) => {
            const form = document.getElementById(id);
            form?.addEventListener('submit', async (e) => {
                e.preventDefault(); openModal('speedtestRunningModal');
                try {
                    await fetch(getUrl(), { method: 'POST', body: new FormData(form), credentials: 'same-origin' });
                    setTimeout(() => { loadTop(); closeModal('speedtestRunningModal'); }, delay);
                } catch (e) { closeModal('speedtestRunningModal'); }
            });
        };
        handleForm('st-run-form', () => `{{ url_for('run_ssh_target_speedtest_route', target_name='__T__') }}`.replace('__T__', encodeURIComponent(targetSelect.value)), 800);
        handleForm('st-run-all-form', () => document.getElementById('st-run-all-form').action, 1200);

        // ===== МОДАЛЬНЫЕ ОКНА =====
        let detailUrl = null;
        window.openSpeedtestModal = (host, url) => {
            detailUrl = url; const title = document.getElementById('st-modal-host');
            if (title) title.textContent = host; openModal('speedtestModal'); drawDetail();
        };
        const drawDetail = async () => {
            const canvas = document.getElementById('st-detail-canvas'); if (!canvas || !detailUrl) return;
            const metric = document.getElementById('st-metric')?.value || 'download_mbps';
            const data = await fetchJSON(detailUrl, { limit: document.getElementById('st-range')?.value || 60 });
            if (!data?.ok) return;
            const items = data.items.slice().reverse();
            const ctx = canvas.getContext('2d'); if (detailChart) detailChart.destroy();
            detailChart = new Chart(ctx, {
                ...chartConfig,
                data: {
                    labels: items.map(it => it.created_at),
                    datasets: [{
                        label: metric, data: items.map(it => Number(it[metric] || 0)),
                        borderColor: metric === 'ping_ms' ? '#f59e0b' : (metric === 'upload_mbps' ? '#00bfff' : '#13ec80'),
                        backgroundColor: 'rgba(19, 236, 128, 0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 4, pointHoverRadius: 6
                    }]
                }
            });
        };
        ['st-metric', 'st-range', 'st-refresh'].forEach(id => {
            const el = document.getElementById(id); el?.addEventListener(el.tagName === 'BUTTON' ? 'click' : 'change', drawDetail);
        });

        initAutoRefresh();
    });
</script>
{% endblock %}