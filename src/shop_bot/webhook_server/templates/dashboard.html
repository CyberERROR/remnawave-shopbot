{% extends "base.html" %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞{% endblock %}

{% block content %}
<!-- Stats Cards -->
<section id="dash-stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8"
    data-fetch-url="{{ url_for('dashboard_stats_partial') }}" data-fetch-interval="8000">
    {% include 'partials/dashboard_stats.html' %}
</section>

<!-- SSH Speedtest Section -->
<section class="mb-8">
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <div class="flex flex-col lg:flex-row items-start justify-between gap-6 mb-6">
            <div class="flex-1">
                <div class="flex items-center gap-4 mb-2">
                    <label class="text-lg font-bold text-white">SSH —Ü–µ–ª—å</label>
                    <div class="soft-select min-w-[200px]" data-target="st-target">
                        <button type="button" class="soft-select-toggle" id="st_target_toggle">–í—ã–±–µ—Ä–∏—Ç–µ SSH
                            —Ü–µ–ª—å...</button>
                        <div class="soft-select-menu" id="st_target_menu"></div>
                        <select id="st-target" class="hidden">
                            {% for t in ssh_targets %}
                            <option value="{{ t.target_name }}">{{ t.target_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="mt-2">
                    <p class="text-white/70 text-sm font-medium mb-1">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                    <p id="st-latest" class="text-white/50 text-sm">‚Äî</p>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                <form id="st-run-form" method="post" class="m-0">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="method" value="both" />
                    <button type="submit"
                        class="flex w-full sm:w-auto items-center justify-center gap-2 rounded-lg bg-white/10 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-white/20">
                        <span class="material-symbols-outlined text-base">play_arrow</span>
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π
                    </button>
                </form>
                <form id="st-run-all-form" action="{{ url_for('run_all_ssh_target_speedtests_route') }}" method="post"
                    class="m-0">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit"
                        class="flex w-full sm:w-auto items-center justify-center gap-2 rounded-lg bg-primary/80 px-4 py-2 text-sm font-semibold text-background-dark transition-colors hover:bg-primary">
                        <span class="material-symbols-outlined text-base">skip_next</span>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö
                    </button>
                </form>
            </div>
        </div>
        <div class="h-64"><canvas id="st-top-canvas"></canvas></div>
    </div>
</section>

<!-- Charts Section -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h2 class="text-white text-xl font-bold leading-tight tracking-[-0.015em] mb-4">–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (30 –¥–Ω–µ–π)
        </h2>
        <div class="h-64"><canvas id="newUsersChart"></canvas></div>
    </div>
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h2 class="text-white text-xl font-bold leading-tight tracking-[-0.015em] mb-4">–ù–æ–≤—ã–µ –∫–ª—é—á–∏ (30 –¥–Ω–µ–π)</h2>
        <div class="h-64"><canvas id="newKeysChart"></canvas></div>
    </div>
</section>

<!-- Transactions Section -->
<section class="mb-8">
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h2 class="text-white text-xl font-bold leading-tight tracking-[-0.015em] mb-4">–ù–µ–¥–∞–≤–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2>
        {% if transactions %}
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-white/5">
                    <tr>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        </th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–•–æ—Å—Ç</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ü–ª–∞–Ω</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–¶–µ–Ω–∞</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–¢–∏–ø</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–î–∞—Ç–∞</th>
                    </tr>
                </thead>
                <tbody id="dash-transactions" class="divide-y divide-white/10"
                    data-fetch-url="{{ url_for('dashboard_transactions_partial', page=current_page) }}"
                    data-fetch-interval="10000">
                    {% include 'partials/dashboard_transactions.html' %}
                </tbody>
            </table>
        </div>
        {% if total_pages and total_pages > 1 %}
        <div class="flex justify-center mt-4 gap-2">
            {% set cp = current_page or 1 %}
            {% set tp = total_pages or 1 %}
            {% set ns = namespace(last_m=1, last_d=1) %}
            {% if cp > 1 %}
            <a href="{{ url_for('dashboard_page', page=cp - 1) }}"
                class="px-3 py-1 rounded bg-white/10 hover:bg-white/20 text-white text-sm">¬´</a>
            {% endif %}
            <a href="{{ url_for('dashboard_page', page=1) }}"
                class="px-3 py-1 rounded {% if 1 == cp %}bg-primary text-background-dark{% else %}bg-white/10 hover:bg-white/20 text-white{% endif %} text-sm">1</a>
            {% for p in range(2, tp + 1) %}
            {% set diff = (p - cp)|abs %}
            {% set is_m = (p == tp) or (diff <= 1) %} {% set is_d=(p==tp) or (p <=4) or (p>= tp - 3) or (diff <= 2) %}
                    {% if is_m or is_d %} {% set gap_m=is_m and (p - ns.last_m> 1) %}
                    {% set gap_d = is_d and (p - ns.last_d > 1) %}
                    {% if gap_m and gap_d %}
                    <span class="px-1 text-white/50 text-sm">...</span>
                    {% elif gap_d %}
                    <span class="px-1 text-white/50 text-sm hidden md:inline-block">...</span>
                    {% elif gap_m %}
                    <span class="px-1 text-white/50 text-sm md:hidden">...</span>
                    {% endif %}
                    <a href="{{ url_for('dashboard_page', page=p) }}"
                        class="px-3 py-1 rounded {% if p == cp %}bg-primary text-background-dark{% else %}bg-white/10 hover:bg-white/20 text-white{% endif %} text-sm {% if not is_m %}hidden md:inline-block{% endif %}">{{
                        p }}</a>
                    {% if is_m %}{% set ns.last_m = p %}{% endif %}
                    {% if is_d %}{% set ns.last_d = p %}{% endif %}
                    {% endif %}
                    {% endfor %}
                    {% if cp < tp %} <a href="{{ url_for('dashboard_page', page=cp + 1) }}"
                        class="px-3 py-1 rounded bg-white/10 hover:bg-white/20 text-white text-sm">¬ª</a>
                        {% endif %}
        </div>
        {% endif %}
        {% else %}
        <p class="text-white/50">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>
        {% endif %}
    </div>
</section>

<!-- Speedtest Running Modal -->
<div id="speedtestRunningModal" class="modal-overlay">
    <div class="modal-content p-6">
        <div class="flex items-center gap-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <div>
                <div class="font-semibold text-white">–ò–¥—ë—Ç –∏–∑–º–µ—Ä–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏‚Ä¶</div>
                <div class="text-white/50 text-sm">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ 10‚Äì30 —Å–µ–∫—É–Ω–¥</div>
            </div>
        </div>
    </div>
</div>

<!-- Speedtest Detail Modal -->
<div id="speedtestModal" class="modal-overlay modal-xl">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–°–∫–æ—Ä–æ—Å—Ç—å ‚Äî <span id="st-modal-host"></span></h5>
            <button onclick="closeModal('speedtestModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <label class="text-white/70">–ú–µ—Ç—Ä–∏–∫–∞:</label>
                <select id="st-metric"
                    class="bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-white text-sm">
                    <option value="download_mbps" selected>–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ (Mbps)</option>
                    <option value="upload_mbps">–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–¥–∞—á–∏ (Mbps)</option>
                    <option value="ping_ms">–ü–∏–Ω–≥ (ms)</option>
                </select>
                <label class="text-white/70">–ü–µ—Ä–∏–æ–¥:</label>
                <select id="st-range"
                    class="bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-white text-sm">
                    <option value="24">24 —Ç–æ—á–∫–∏</option>
                    <option value="60" selected>60 —Ç–æ—á–µ–∫</option>
                    <option value="120">120 —Ç–æ—á–µ–∫</option>
                </select>
                <button id="st-refresh"
                    class="px-4 py-1.5 rounded-lg bg-primary/20 text-primary text-sm font-medium hover:bg-primary/30">
                    –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
            <div class="h-80"><canvas id="st-detail-canvas"></canvas></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script id="chart-data" type="application/json">{{ chart_data | tojson }}</script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const CHART_DATA = JSON.parse(document.getElementById('chart-data')?.textContent || '{}');

        // Chart config
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', align: 'end', labels: { color: '#e0e0e0', boxWidth: 12, padding: 20, font: { size: 14 } } },
                    tooltip: { backgroundColor: '#102219', titleColor: '#e0e0e0', bodyColor: '#e0e0e0', borderColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 1, padding: 10, cornerRadius: 8 }
                },
                scales: {
                    x: { ticks: { color: 'rgba(224, 224, 224, 0.5)' }, grid: { color: 'rgba(255, 255, 255, 0.1)', drawOnChartArea: false } },
                    y: { ticks: { color: 'rgba(224, 224, 224, 0.5)' }, grid: { color: 'rgba(255, 255, 255, 0.1)', borderDash: [2, 4] }, beginAtZero: true }
                }
            }
        };

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ {users: {date: count}, keys: {date: count}} –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Chart.js
        let usersLabels = [], usersData = [], keysLabels = [], keysData = [];

        if (CHART_DATA.users && typeof CHART_DATA.users === 'object') {
            const sortedDates = Object.keys(CHART_DATA.users).sort();
            usersLabels = sortedDates.map(d => d.slice(5)); // MM-DD —Ñ–æ—Ä–º–∞—Ç
            usersData = sortedDates.map(d => CHART_DATA.users[d] || 0);
        }

        if (CHART_DATA.keys && typeof CHART_DATA.keys === 'object') {
            const sortedDates = Object.keys(CHART_DATA.keys).sort();
            keysLabels = sortedDates.map(d => d.slice(5)); // MM-DD —Ñ–æ—Ä–º–∞—Ç
            keysData = sortedDates.map(d => CHART_DATA.keys[d] || 0);
        }

        // New Users Chart
        const usersCtx = document.getElementById('newUsersChart')?.getContext('2d');
        if (usersCtx && usersLabels.length > 0) {
            const gradient = usersCtx.createLinearGradient(0, 0, 0, usersCtx.canvas.height);
            gradient.addColorStop(0, 'rgba(19, 236, 128, 0.3)');
            gradient.addColorStop(1, 'rgba(19, 236, 128, 0)');
            new Chart(usersCtx, {
                ...chartConfig,
                data: {
                    labels: usersLabels,
                    datasets: [{
                        label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                        data: usersData,
                        borderColor: '#13ec80', backgroundColor: gradient, fill: true, tension: 0.4,
                        pointBackgroundColor: '#13ec80', pointRadius: 4, pointHoverRadius: 8
                    }]
                },
                options: { ...chartConfig.options, plugins: { ...chartConfig.options.plugins, legend: { display: false } } }
            });
        } else {
            console.log('New Users chart: no data', CHART_DATA);
        }

        // New Keys Chart
        const keysCtx = document.getElementById('newKeysChart')?.getContext('2d');
        if (keysCtx && keysLabels.length > 0) {
            const gradient = keysCtx.createLinearGradient(0, 0, 0, keysCtx.canvas.height);
            gradient.addColorStop(0, 'rgba(19, 236, 128, 0.3)');
            gradient.addColorStop(1, 'rgba(19, 236, 128, 0)');
            new Chart(keysCtx, {
                ...chartConfig,
                data: {
                    labels: keysLabels,
                    datasets: [{
                        label: '–ù–æ–≤—ã–µ –∫–ª—é—á–∏',
                        data: keysData,
                        borderColor: '#13ec80', backgroundColor: gradient, fill: true, tension: 0.4,
                        pointBackgroundColor: '#13ec80', pointRadius: 4, pointHoverRadius: 8
                    }]
                },
                options: { ...chartConfig.options, plugins: { ...chartConfig.options.plugins, legend: { display: false } } }
            });
        } else {
            console.log('New Keys chart: no data', CHART_DATA);
        }

        // SSH Target functionality
        const targetSelect = document.getElementById('st-target');
        const latestBox = document.getElementById('st-latest');
        const topCanvas = document.getElementById('st-top-canvas');
        const runForm = document.getElementById('st-run-form');
        const runAllForm = document.getElementById('st-run-all-form');
        let topChart = null;

        window.initSoftSelect('st-target', '–í—ã–±–µ—Ä–∏—Ç–µ SSH —Ü–µ–ª—å...');

        async function loadAndDrawTop() {
            if (!targetSelect || !topCanvas) return;
            const name = targetSelect.value;
            if (!name) return;

            const url = `{{ url_for('host_speedtests_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(name));
            try {
                const resp = await fetch(url + '?limit=60', { headers: { 'Accept': 'application/json' } });
                const data = await resp.json();
                if (!data || !data.ok) return;

                const items = (data.items || []).slice().reverse();

                // Latest result
                if (items.length && latestBox) {
                    const last = items[items.length - 1];
                    const parts = [];
                    if (last.method) parts.push(`<span class='px-2 py-0.5 rounded bg-primary/20 text-primary text-xs'>${String(last.method).toUpperCase()}</span>`);
                    parts.push(`‚è± ${last.ping_ms ?? '‚Äî'} ms`);
                    parts.push(`‚Üì ${last.download_mbps ?? '‚Äî'} Mbps`);
                    parts.push(`‚Üë ${last.upload_mbps ?? '‚Äî'} Mbps`);
                    if (last.server_name) parts.push(`üìç ${last.server_name}`);
                    parts.push(`<span class='text-white/50'>${last.created_at}</span>`);
                    latestBox.innerHTML = parts.join(' ¬∑ ');
                } else if (latestBox) {
                    latestBox.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                }

                // Chart
                const labels = items.map(it => it.created_at);
                const seriesDown = items.map(it => parseFloat(String(it.download_mbps ?? '0')) || 0);
                const seriesUp = items.map(it => parseFloat(String(it.upload_mbps ?? '0')) || 0);

                const ctx = topCanvas.getContext('2d');
                const gradDown = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
                gradDown.addColorStop(0, 'rgba(19, 236, 128, 0.3)');
                gradDown.addColorStop(1, 'rgba(19, 236, 128, 0)');
                const gradUp = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
                gradUp.addColorStop(0, 'rgba(0, 191, 255, 0.3)');
                gradUp.addColorStop(1, 'rgba(0, 191, 255, 0)');

                if (topChart) topChart.destroy();
                topChart = new Chart(ctx, {
                    ...chartConfig,
                    data: {
                        labels,
                        datasets: [
                            { label: 'Download Mbps', data: seriesDown, borderColor: '#13ec80', backgroundColor: gradDown, fill: true, tension: 0.3, pointRadius: 4, pointHoverRadius: 8, borderWidth: 2 },
                            { label: 'Upload Mbps', data: seriesUp, borderColor: '#00bfff', backgroundColor: gradUp, fill: true, tension: 0.3, pointRadius: 4, pointHoverRadius: 8, borderWidth: 2 }
                        ]
                    }
                });
            } catch (e) { console.error('Speedtest fetch failed:', e); }
        }

        if (targetSelect) {
            targetSelect.addEventListener('change', loadAndDrawTop);
            await loadAndDrawTop();
        }

        function showRunning() { openModal('speedtestRunningModal'); }
        function hideRunning() { closeModal('speedtestRunningModal'); }

        if (runForm) {
            runForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = targetSelect?.value || '';
                const fd = new FormData(runForm);
                try {
                    showRunning();
                    const runUrl = `{{ url_for('run_ssh_target_speedtest_route', target_name='__TARGET__') }}`.replace('__TARGET__', encodeURIComponent(name));
                    await fetch(runUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
                    setTimeout(async () => { await loadAndDrawTop(); hideRunning(); }, 800);
                } catch (e) { hideRunning(); }
            });
        }

        if (runAllForm) {
            runAllForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fd = new FormData(runAllForm);
                try {
                    showRunning();
                    await fetch(runAllForm.action, { method: 'POST', body: fd, credentials: 'same-origin' });
                    setTimeout(async () => { await loadAndDrawTop(); hideRunning(); }, 1200);
                } catch (e) { hideRunning(); }
            });
        }

        // Detail modal functionality
        const modalEl = document.getElementById('speedtestModal');
        const titleHost = document.getElementById('st-modal-host');
        const metricEl = document.getElementById('st-metric');
        const rangeEl = document.getElementById('st-range');
        const refreshBtn = document.getElementById('st-refresh');
        const detailCanvas = document.getElementById('st-detail-canvas');
        let detailChart = null;
        let currentUrl = null;

        window.openSpeedtestModal = async function (host, url) {
            currentUrl = url;
            if (titleHost) titleHost.textContent = host;
            openModal('speedtestModal');
            await drawDetail();
        };

        async function drawDetail() {
            if (!detailCanvas || !currentUrl) return;
            const metric = metricEl?.value || 'download_mbps';
            const limit = parseInt(rangeEl?.value || '60', 10);
            try {
                const resp = await fetch(currentUrl + '?limit=' + limit, { headers: { 'Accept': 'application/json' } });
                const data = await resp.json();
                if (!data || !data.ok) return;
                const items = (data.items || []).slice().reverse();
                const labels = items.map(it => it.created_at);
                const series = items.map(it => Number(it[metric] || 0));
                const ctx = detailCanvas.getContext('2d');
                if (detailChart) detailChart.destroy();
                detailChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: metric,
                            data: series,
                            borderColor: metric === 'ping_ms' ? '#f59e0b' : (metric === 'upload_mbps' ? '#00bfff' : '#13ec80'),
                            backgroundColor: 'rgba(19, 236, 128, 0.1)',
                            borderWidth: 2, fill: true, tension: 0.3, pointRadius: 2
                        }]
                    },
                    options: chartConfig.options
                });
            } catch (e) { }
        }

        if (refreshBtn) refreshBtn.addEventListener('click', drawDetail);
        if (metricEl) metricEl.addEventListener('change', drawDetail);
        if (rangeEl) rangeEl.addEventListener('change', drawDetail);
    });
</script>
{% endblock %}