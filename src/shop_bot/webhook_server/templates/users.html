{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-bold text-white">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
            <p class="text-white/50 text-sm">–°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</p>
        </div>
        <div class="relative w-full md:w-80">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/50">search</span>
            <input id="users-search" type="text" value="{{ q or '' }}"
                class="w-full bg-white/5 border border-white/10 rounded-lg pl-10 pr-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-colors"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ Username..." />
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table id="users-table" class="w-full text-left">
            <thead class="bg-white/5">
                <tr>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Telegram ID</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Username</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–°—Ç–∞—Ç—É—Å</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ë–∞–ª–∞–Ω—Å</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70 text-right">–î–µ–π—Å—Ç–≤–∏—è
                    </th>
                </tr>
            </thead>
            <tbody id="users-tbody" class="divide-y divide-white/10"
                data-fetch-url="{{ url_for('users_table_partial', page=current_page, per_page=per_page, q=q) }}"
                data-fetch-interval="100000">
                {% include 'partials/users_table.html' %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if total_pages and total_pages > 1 %}
<div class="flex justify-center mt-4 gap-2" id="users-pagination"
    data-src="{{ url_for('users_pagination_partial', page=current_page, q=q, per_page=per_page) }}">
    {% include 'partials/users_pagination.html' %}
</div>
{% endif %}

<!-- Balance Modal -->
<div id="balanceModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
            <button onclick="closeModal('balanceModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-3 text-white/70" id="bm-user"></div>
            <div class="mb-4 text-white">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <strong id="bm-balance">0.00</strong> RUB</div>
            <form id="bm-form" class="flex gap-3" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input
                    class="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                    type="text" inputmode="decimal" name="delta" placeholder="¬± —Å—É–º–º–∞" required />
                <button
                    class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors"
                    type="submit">
                    –ò–∑–º–µ–Ω–∏—Ç—å
                </button>
            </form>
            <hr class="border-white/10 my-4" />
            <div class="mb-2 text-white">–†–µ—Ñ–µ—Ä–∞–ª—ã: <strong id="bm-refcount">0</strong></div>
            <div class="text-sm text-white/50 max-h-36 overflow-auto">
                <ul id="bm-reflist" class="space-y-1"></ul>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div id="messageModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h5>
            <button onclick="closeModal('messageModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-3 text-white/70" id="mm-user"></div>
            <form id="mm-form" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="mb-4">
                    <label class="block text-white/70 text-sm mb-2">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                    <p class="text-white/50 text-sm mb-2">üì© –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</p>
                    <textarea
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        name="message" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..." required></textarea>
                </div>
                <button
                    class="w-full px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors"
                    type="submit">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </form>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal-overlay modal-xl">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
            <button onclick="closeModal('userDetailsModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div id="udm-loading" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
                <p class="text-white/50 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div id="udm-content" class="hidden">
                <!-- Basic Info & Referrals -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Basic Info -->
                    <div class="bg-white/5 border border-white/10 rounded-lg p-4">
                        <h4 class="text-white font-bold mb-4">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                        <table class="w-full text-sm">
                            <tbody class="divide-y divide-white/10">
                                <tr>
                                    <td class="py-2 text-white/70">Telegram ID:</td>
                                    <td class="py-2 text-white" id="udm-telegram-id"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">Username:</td>
                                    <td class="py-2 text-white" id="udm-username"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</td>
                                    <td class="py-2 text-white" id="udm-registration"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ:</td>
                                    <td class="py-2 text-white" id="udm-total-spent"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ –º–µ—Å—è—Ü–µ–≤:</td>
                                    <td class="py-2 text-white" id="udm-total-months"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ü—Ä–æ–±–Ω—ã–π:</td>
                                    <td class="py-2">
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="udm-trial-toggle" data-user-id=""
                                                class="sr-only peer">
                                            <div
                                                class="relative w-11 h-6 bg-white/10 peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                                            </div>
                                            <span class="ml-2 text-white/70 text-sm" id="udm-trial-label"></span>
                                        </label>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Referral Info -->
                    <div class="bg-white/5 border border-white/10 rounded-lg p-4">
                        <h4 class="text-white font-bold mb-4">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h4>
                        <table class="w-full text-sm">
                            <tbody class="divide-y divide-white/10">
                                <tr>
                                    <td class="py-2 text-white/70">–†–µ—Ñ. –∫–æ–¥:</td>
                                    <td class="py-2 text-white" id="udm-ref-code"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤:</td>
                                    <td class="py-2 text-white" id="udm-ref-count"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ü—Ä–∏–≥–ª–∞—à—ë–Ω:</td>
                                    <td class="py-2 text-white" id="udm-referred-by"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ë–∞–ª–∞–Ω—Å:</td>
                                    <td class="py-2 text-white" id="udm-balance"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Subscriptions -->
                <div class="mb-6">
                    <div class="bg-white/5 border border-white/10 rounded-lg">
                        <div class="p-4 border-b border-white/10">
                            <h4 class="text-white font-bold">–ü–æ–¥–ø–∏—Å–∫–∏ <span id="udm-subs-stats"
                                    class="text-white/50 text-sm font-normal"></span></h4>
                        </div>
                        <div id="udm-subs-list" class="max-h-64 overflow-y-auto divide-y divide-white/10"></div>
                    </div>
                </div>

                <!-- Payment History -->
                <div class="mb-6">
                    <div class="bg-white/5 border border-white/10 rounded-lg">
                        <div class="p-4 border-b border-white/10">
                            <h4 class="text-white font-bold">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-white/5">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-white/70">–î–∞—Ç–∞</th>
                                        <th class="px-4 py-2 text-left text-white/70">–¢–∞—Ä–∏—Ñ</th>
                                        <th class="px-4 py-2 text-left text-white/70">–°—É–º–º–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="udm-payment-history" class="divide-y divide-white/10"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Balance History -->
                <div>
                    <div class="bg-white/5 border border-white/10 rounded-lg">
                        <div class="p-4 border-b border-white/10">
                            <h4 class="text-white font-bold">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–∞–ª–∞–Ω—Å–∞</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-white/5">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-white/70">–î–∞—Ç–∞</th>
                                        <th class="px-4 py-2 text-left text-white/70">–¢–∏–ø</th>
                                        <th class="px-4 py-2 text-left text-white/70">–°—É–º–º–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="udm-balance-history" class="divide-y divide-white/10"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const input = document.getElementById('users-search');
        const table = document.getElementById('users-table');
        const tbody = document.getElementById('users-tbody');
        if (!input || !table || !tbody) return;

        // Open keys state
        const LS_KEY = 'users_open_keys_ids';
        function loadOpenSet() {
            try {
                const raw = localStorage.getItem(LS_KEY);
                return new Set(raw ? JSON.parse(raw) : []);
            } catch (_) { return new Set(); }
        }
        function saveOpenSet(set) {
            try { localStorage.setItem(LS_KEY, JSON.stringify(Array.from(set))); } catch (_) { }
        }
        const openSet = loadOpenSet();

        function getRows() {
            return Array.from(tbody.children).filter(tr => tr.tagName === 'TR' && !tr.classList.contains('keys-row'));
        }

        function getKeysRowByUid(uid) { return document.getElementById('keys-' + uid); }

        async function ensureKeysLoaded(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            const body = row.querySelector('[data-lazy="keys"]');
            if (!body || body.getAttribute('data-loaded') === '1') return;
            const src = row.getAttribute('data-src');
            if (!src) return;
            try {
                const resp = await fetch(src, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                if (resp.ok) {
                    body.innerHTML = await resp.text();
                    body.setAttribute('data-loaded', '1');
                }
            } catch (_) { }
        }

        function openKeysForUid(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            row.classList.remove('hidden');
            openSet.add(String(uid));
            saveOpenSet(openSet);
        }

        function closeKeysForUid(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            row.classList.add('hidden');
            openSet.delete(String(uid));
            saveOpenSet(openSet);
        }

        function restoreOpenedKeys() {
            openSet.forEach(uid => {
                const row = getKeysRowByUid(uid);
                if (row) row.classList.remove('hidden');
            });
        }

        function applyFilter() {
            const q = (input.value || '').toLowerCase().trim();
            getRows().forEach(tr => {
                const id = (tr.querySelector('.user-id')?.textContent || '').toLowerCase();
                const name = (tr.querySelector('.user-name')?.textContent || '').toLowerCase();
                tr.classList.toggle('hidden', q && !id.includes(q) && !name.includes(q));
            });
        }

        input.addEventListener('input', applyFilter);
        input.addEventListener('search', applyFilter);

        // Server search with debounce
        let searchTimeout = null;
        input.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const url = new URL(tbody.getAttribute('data-fetch-url'), location.origin);
                url.searchParams.set('q', input.value || '');
                url.searchParams.set('page', '1');
                try {
                    const resp = await fetch(url, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                    if (resp.ok) {
                        tbody.innerHTML = await resp.text();
                        restoreOpenedKeys();
                        applyFilter();
                    }
                } catch (_) { }
            }, 400);
        });

        // Keys toggle
        table.addEventListener('click', function (e) {
            const btn = e.target.closest('[data-toggle="keys"]');
            if (!btn) return;
            const uid = btn.getAttribute('data-user');
            const row = getKeysRowByUid(uid);
            if (!row) return;
            if (row.classList.contains('hidden')) {
                openKeysForUid(uid);
                ensureKeysLoaded(uid);
            } else {
                closeKeysForUid(uid);
            }
        });

        // Balance modal
        table.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-user-balance-sign');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');
            const uname = btn.getAttribute('data-username') || 'N/A';
            const balance = btn.getAttribute('data-balance') || '0.00';
            const sign = btn.getAttribute('data-sign') || '';

            // Fetch referrals
            let refs = [];
            try {
                const resp = await fetch(`{{ url_for('user_referrals_json', user_id=0) }}`.replace('/0/', `/${uid}/`), { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
                const data = await resp.json();
                refs = (data && data.ok) ? (data.items || []) : [];
            } catch (_) { }

            document.getElementById('bm-user').textContent = `@${uname} (#${uid})`;
            document.getElementById('bm-balance').textContent = balance;
            document.getElementById('bm-form').action = `{{ url_for('adjust_balance_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
            document.getElementById('bm-refcount').textContent = refs.length;
            document.getElementById('bm-reflist').innerHTML = refs.map(r => `<li>#${r.telegram_id} ‚Äî @${r.username || 'N/A'} ¬∑ ${r.registration_date}</li>`).join('');

            const deltaInput = document.querySelector('#bm-form input[name="delta"]');
            if (deltaInput) {
                deltaInput.value = sign;
                setTimeout(() => { deltaInput.focus(); deltaInput.setSelectionRange(1, 1); }, 100);
            }
            openModal('balanceModal');
        });

        // Balance form submit
        document.getElementById('bm-form')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = this;
            try {
                const fd = new FormData(form);
                const resp = await fetch(form.action, {
                    method: 'POST', body: fd,
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                });
                const data = await resp.json().catch(() => null);
                if (resp.ok && data && data.ok) {
                    showToast('success', data.message || '–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—ë–Ω');
                    closeModal('balanceModal');
                    refreshContainerById('users-tbody');
                } else {
                    showToast('danger', (data && data.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å');
                }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        // Message modal
        table.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-user-message');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');
            const uname = btn.getAttribute('data-username') || 'N/A';
            document.getElementById('mm-user').textContent = `@${uname} (#${uid})`;
            document.getElementById('mm-form').action = `{{ url_for('send_user_message_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
            document.querySelector('#mm-form textarea[name="message"]').value = '';
            openModal('messageModal');
        });

        // Message form submit
        document.getElementById('mm-form')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = this;
            try {
                const fd = new FormData(form);
                const resp = await fetch(form.action, {
                    method: 'POST', body: fd,
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                });
                const data = await resp.json().catch(() => null);
                if (resp.ok && data && data.ok) {
                    showToast('success', data.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                    closeModal('messageModal');
                } else {
                    showToast('danger', (data && data.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        // User details modal
        table.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-user-details');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');

            document.getElementById('udm-loading').classList.remove('hidden');
            document.getElementById('udm-content').classList.add('hidden');
            openModal('userDetailsModal');

            try {
                const resp = await fetch(`{{ url_for('user_details_json', user_id=0) }}`.replace('/0/', `/${uid}/`), {
                    headers: { 'Accept': 'application/json' }, credentials: 'same-origin'
                });
                const data = await resp.json();

                if (data && data.ok) {
                    // Basic info
                    document.getElementById('udm-telegram-id').textContent = data.user.telegram_id || 'N/A';
                    document.getElementById('udm-username').textContent = '@' + (data.user.username || 'N/A');
                    document.getElementById('udm-registration').textContent = data.user.registration_date || 'N/A';
                    document.getElementById('udm-total-spent').textContent = (data.user.total_spent || 0).toFixed(2) + ' RUB';
                    document.getElementById('udm-total-months').textContent = (data.user.total_months || 0) + ' –º–µ—Å.';

                    // Trial toggle
                    const trialToggle = document.getElementById('udm-trial-toggle');
                    const trialLabel = document.getElementById('udm-trial-label');
                    trialToggle.checked = data.user.trial_used || false;
                    trialToggle.setAttribute('data-user-id', uid);
                    trialLabel.textContent = data.user.trial_used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ' : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ';

                    // Referral info
                    document.getElementById('udm-ref-code').textContent = data.user.referral_code || 'N/A';
                    document.getElementById('udm-ref-count').textContent = data.user.referral_count || '0';
                    document.getElementById('udm-referred-by').textContent = data.user.referred_by?.username ?
                        `@${data.user.referred_by.username} (#${data.user.referred_by.telegram_id})` : '–ù–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω';
                    document.getElementById('udm-balance').textContent = (data.user.balance || 0).toFixed(2) + ' RUB';

                    // Subscriptions
                    const subsStats = document.getElementById('udm-subs-stats');
                    const subsList = document.getElementById('udm-subs-list');
                    subsStats.textContent = data.subs_stats ?
                        `(–í—Å–µ–≥–æ: ${data.subs_stats.total}, –ê–∫—Ç–∏–≤–Ω–æ: ${data.subs_stats.active}, –ò—Å—Ç–µ–∫–ª–æ: ${data.subs_stats.expired})` : '';
                    subsList.innerHTML = data.subscriptions?.length ? data.subscriptions.map(sub => `
                    <div class="p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="${sub.is_expired ? 'text-red-400' : 'text-primary'} font-bold text-sm">${sub.status_text}</span>
                            <span class="text-white/50 text-sm">–ò—Å—Ç–µ–∫–∞–µ—Ç: ${sub.expire_date}</span>
                        </div>
                        <div class="bg-white/5 rounded p-2 font-mono text-sm text-primary break-all mb-2">${sub.key}</div>
                        <div class="flex gap-2 flex-wrap">
                            <div class="bg-white/5 rounded px-2 py-1 text-xs text-white/70 cursor-pointer hover:bg-white/10 transition-colors" 
                                 onclick="copyToClipboard('${sub.email}', this)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è">
                                <span class="text-white/50">Email:</span> ${sub.email}
                            </div>
                            <div class="bg-white/5 rounded px-2 py-1 text-xs text-white/70 cursor-pointer hover:bg-white/10 transition-colors" 
                                 onclick="copyToClipboard('${sub.remnawave_user_uuid}', this)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è">
                                <span class="text-white/50">UUID:</span> ${sub.remnawave_user_uuid}
                            </div>
                        </div>
                    </div>
                `).join('') : '<div class="p-4 text-center text-white/50">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</div>';

                    // Payment history
                    const paymentHistory = document.getElementById('udm-payment-history');
                    paymentHistory.innerHTML = data.payment_history?.length ? data.payment_history.map(p => `
                    <tr><td class="px-4 py-2 text-white">${p.date || 'N/A'}</td>
                    <td class="px-4 py-2 text-white">${p.plan || 'N/A'}</td>
                    <td class="px-4 py-2 text-white">${(p.amount || 0).toFixed(2)} RUB</td></tr>
                `).join('') : '<tr><td colspan="3" class="px-4 py-4 text-center text-white/50">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';

                    // Balance history
                    const balanceHistory = document.getElementById('udm-balance-history');
                    balanceHistory.innerHTML = data.balance_history?.length ? data.balance_history.map(t => `
                    <tr><td class="px-4 py-2 text-white">${t.date || 'N/A'}</td>
                    <td class="px-4 py-2 text-white">${t.type || 'N/A'}</td>
                    <td class="px-4 py-2 text-white">${(t.amount || 0).toFixed(2)} RUB</td></tr>
                `).join('') : '<tr><td colspan="3" class="px-4 py-4 text-center text-white/50">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';

                    document.getElementById('udm-loading').classList.add('hidden');
                    document.getElementById('udm-content').classList.remove('hidden');
                } else {
                    showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    closeModal('userDetailsModal');
                }
            } catch (_) {
                showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                closeModal('userDetailsModal');
            }
        });

        // Trial toggle handler
        document.addEventListener('change', async function (e) {
            if (e.target?.id !== 'udm-trial-toggle') return;
            const toggle = e.target;
            const userId = toggle.getAttribute('data-user-id');
            const label = document.getElementById('udm-trial-label');

            try {
                const resp = await fetch(`{{ url_for('toggle_trial_used_route', user_id=0) }}`.replace('/0/', `/${userId}/`), {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCsrfToken() },
                    credentials: 'same-origin'
                });
                const data = await resp.json();
                if (data && data.ok) {
                    label.textContent = data.trial_used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ' : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ';
                    showToast('success', data.message);
                } else {
                    toggle.checked = !toggle.checked;
                    showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
                }
            } catch (_) {
                toggle.checked = !toggle.checked;
                showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        });

        // Initialize
        restoreOpenedKeys();
    })();

    // Copy to clipboard function
    function copyToClipboard(text, element) {
        navigator.clipboard.writeText(text).then(() => {
            const originalBg = element.className;
            element.classList.add('bg-primary/20');
            showToast('success', '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
            setTimeout(() => {
                element.className = originalBg;
            }, 300);
        }).catch(() => {
            showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        });
    }
</script>
{% endblock %}