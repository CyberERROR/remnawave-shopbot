{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %}

{% block content %}
<!-- ===== –ó–ê–ì–û–õ–û–í–û–ö –°–¢–†–ê–ù–ò–¶–´ ===== -->
<div class="mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
    <div class="space-y-1">
        <h2 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            <span
                class="px-2 py-0.5 rounded-md bg-primary/10 text-primary text-[10px] font-semibold uppercase tracking-widest border border-primary/20">–ö–ª–∏–µ–Ω—Ç—ã</span>
        </h2>
        <p class="text-white/40 text-xs font-medium uppercase tracking-[0.2em] ml-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
    </div>

    <div class="relative w-full md:w-96 group">
        <span
            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within:text-primary transition-colors">person_search</span>
        <input id="users-search" type="text" value="{{ q or '' }}"
            class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-10 py-2.5 text-white text-sm placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all shadow-lg backdrop-blur-sm"
            placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ Username..." />
        <button id="search-clear"
            class="absolute right-3 top-1/2 -translate-y-1/2 text-white/30 hover:text-white transition-colors hidden">
            <span class="material-symbols-outlined text-lg">close</span>
        </button>
    </div>
</div>

</style>

<div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-xl backdrop-blur-md">
    <div class="overflow-x-auto">
        <table id="users-table" class="w-full text-left border-collapse">
            <thead>
                <tr class="border-b border-white/5 bg-white/[0.02]">
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">Telegram ID</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">Username</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">–°—Ç–∞—Ç—É—Å</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40 text-center">
                        –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">–ë–∞–ª–∞–Ω—Å</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40 text-right">
                        –î–µ–π—Å—Ç–≤–∏—è
                    </th>
                </tr>
            </thead>
            <tbody id="users-tbody" class="divide-y divide-white/5"
                data-fetch-url="{{ url_for('users_table_partial', page=current_page, per_page=per_page, q=q) }}"
                data-fetch-interval="120000">
                <tr>
                    <td colspan="6" class="p-8 text-center">
                        <div class="flex flex-col items-center justify-center text-white/30">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-2"></div>
                            <span class="text-xs">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="flex justify-center mt-6 gap-2" id="users-pagination"
    data-src="{{ url_for('users_pagination_partial', page=current_page, q=q, per_page=per_page) }}">
    {% include 'partials/users_pagination.html' %}
</div>

<div id="balanceModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content bg-[#101815] border border-white/10 rounded-2xl shadow-2xl backdrop-blur-xl">
        <div class="p-6 border-b border-white/5 flex items-center justify-between">
            <h5 class="text-white font-bold text-lg">–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
            <button onclick="closeModal('balanceModal')" class="text-white/50 hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-4 flex items-center gap-3 bg-white/5 p-3 rounded-xl border border-white/5">
                <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined">person</span>
                </div>
                <div>
                    <div class="text-white/50 text-xs uppercase font-bold tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    <div class="text-white font-bold text-sm" id="bm-user"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white/5 p-3 rounded-xl border border-white/5">
                    <div class="text-white/50 text-[10px] uppercase font-bold tracking-wider mb-1">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                    <div class="text-2xl font-bold text-white"><span id="bm-balance">0.00</span> <span
                            class="text-white/50 text-lg font-normal">‚ÇΩ</span></div>
                </div>
                <div class="bg-white/5 p-3 rounded-xl border border-white/5">
                    <div class="text-white/50 text-[10px] uppercase font-bold tracking-wider mb-1">–†–µ—Ñ–µ—Ä–∞–ª—ã</div>
                    <div class="text-2xl font-bold text-white"><span id="bm-refcount">0</span></div>
                </div>
            </div>

            <form id="bm-form" class="flex gap-3 ajax-form" method="post" data-success-msg="–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω"
                data-refresh="users-tbody">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="relative flex-1">
                    <span
                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg">payments</span>
                    <input
                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/40 font-mono"
                        type="text" inputmode="decimal" name="delta" placeholder="¬± –°—É–º–º–∞" required />
                </div>
                <button
                    class="px-6 py-2 rounded-xl bg-primary text-background-dark font-bold hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 flex items-center gap-2"
                    type="submit">
                    <span class="material-symbols-outlined text-lg">save</span>
                    <span>–ò–∑–º–µ–Ω–∏—Ç—å</span>
                </button>
            </form>

            <div class="mt-6">
                <div class="text-white/50 text-[10px] uppercase font-bold tracking-wider mb-2">–°–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                <div class="bg-black/30 rounded-xl border border-white/5 p-2 max-h-36 overflow-y-auto custom-scroll">
                    <ul id="bm-reflist" class="space-y-1 text-xs text-white/70"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="messageModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content bg-[#101815] border border-white/10 rounded-2xl shadow-2xl backdrop-blur-xl">
        <div class="p-6 border-b border-white/5 flex items-center justify-between">
            <h5 class="text-white font-bold text-lg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
            <button onclick="closeModal('messageModal')" class="text-white/50 hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-4 text-white/70 text-sm" id="mm-user"></div>
            <form id="mm-form" method="post" class="ajax-form" data-success-msg="–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="mb-4">
                    <label class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-2">üì© –°–æ–æ–±—â–µ–Ω–∏–µ
                        –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</label>
                    <div class="relative">
                        <textarea
                            class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white placeholder:text-white/20 focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all min-h-[120px] resize-y text-sm"
                            name="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." required></textarea>
                        <div class="absolute bottom-3 right-3 text-white/20 text-xs pointer-events-none">–û—Ç –ª–∏—Ü–∞ –±–æ—Ç–∞
                        </div>
                    </div>
                </div>
                <button
                    class="w-full py-3 rounded-xl bg-primary text-background-dark font-bold hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 flex items-center justify-center gap-2 uppercase tracking-wider text-xs"
                    type="submit">
                    <span class="material-symbols-outlined text-lg">send</span>
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Key Comment Modal -->
<div id="commentModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∫–ª—é—á—É</h5>
            <button onclick="closeModal('commentModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div id="commentModalLoading" class="hidden text-center py-4">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"></div>
            </div>
            <div id="commentModalContent">
                <input type="text" id="commentInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            </div>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('commentModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">–û—Ç–º–µ–Ω–∞</button>
            <button id="commentSaveBtn"
                class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Key Expiry Modal -->
<div id="expiryModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</h5>
            <button onclick="closeModal('expiryModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <label class="block text-white/70 text-sm mb-2">–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–∏–±–∞–≤–∏—Ç—å/—É–±–∞–≤–∏—Ç—å</label>
            <input type="number" id="expiryDelta" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 7 –∏–ª–∏ -7"
                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            <p class="text-white/50 text-sm mt-2">–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ ‚Äî –ø—Ä–æ–¥–ª–∏—Ç—å, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ ‚Äî —Å–æ–∫—Ä–∞—Ç–∏—Ç—å.</p>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('expiryModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">–û—Ç–º–µ–Ω–∞</button>
            <button id="expirySaveBtn"
                class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Revoke Key Confirmation Modal -->
<div id="revokeConfirmModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content overflow-hidden">
        <div class="p-4 border-b border-red-500/30 flex items-center justify-between bg-red-500/10">
            <h5 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-red-400">warning</span>
                –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
            </h5>
            <button onclick="closeModal('revokeConfirmModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <p class="text-white mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å <span class="text-red-400 font-bold">—ç—Ç–æ—Ç</span>
                –∫–ª—é—á?</p>
            <p class="text-white/40 text-xs uppercase font-bold tracking-widest">‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ</p>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2 bg-black/20">
            <button onclick="closeModal('revokeConfirmModal')"
                class="px-4 py-2 rounded-xl bg-white/5 text-white/70 hover:bg-white/10 transition-colors text-sm font-bold uppercase tracking-wider">–û—Ç–º–µ–Ω–∞</button>
            <button id="revokeConfirmBtn"
                class="px-5 py-2 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition-all shadow-lg shadow-red-500/20 text-sm uppercase tracking-wider">–û—Ç–æ–∑–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- Revoke ALL Keys Confirmation Modal -->
<div id="revokeAllConfirmModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content overflow-hidden">
        <div class="p-4 border-b border-red-500/30 flex items-center justify-between bg-red-500/10">
            <h5 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-red-400">delete_forever</span>
                –û—Ç–æ–∑–≤–∞—Ç—å –í–°–ï –∫–ª—é—á–∏
            </h5>
            <button onclick="closeModal('revokeAllConfirmModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <p class="text-white mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å <span
                    class="text-red-500 font-bold underline">–í–°–ï</span> –∫–ª—é—á–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</p>
            <p class="text-red-400/80 text-xs font-bold uppercase tracking-widest">‚ö†Ô∏è –í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –±—É–¥—É—Ç –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω—ã
                –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ!</p>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2 bg-black/20">
            <button onclick="closeModal('revokeAllConfirmModal')"
                class="px-4 py-2 rounded-xl bg-white/5 text-white/70 hover:bg-white/10 transition-colors text-sm font-bold uppercase tracking-wider">–û—Ç–º–µ–Ω–∞</button>
            <button id="revokeAllConfirmBtn"
                class="px-5 py-2 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition-all shadow-lg shadow-red-600/20 text-sm uppercase tracking-wider">–û—Ç–æ–∑–≤–∞—Ç—å
                –≤—Å—ë</button>
        </div>
    </div>
</div>

<!-- Ban User Confirmation Modal -->
<div id="banConfirmModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content overflow-hidden">
        <div class="p-4 border-b border-orange-500/30 flex items-center justify-between bg-orange-500/10">
            <h5 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-orange-400">block</span>
                –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç—É–ø–∞
            </h5>
            <button onclick="closeModal('banConfirmModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <p class="text-white mb-2" id="banModalText">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
            </p>
            <p class="text-white/40 text-[10px] uppercase font-bold tracking-widest">üì© –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                –≤ –±–æ—Ç–µ</p>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2 bg-black/20">
            <button onclick="closeModal('banConfirmModal')"
                class="px-4 py-2 rounded-xl bg-white/5 text-white/70 hover:bg-white/10 transition-colors text-sm font-bold uppercase tracking-wider">–û—Ç–º–µ–Ω–∞</button>
            <button id="banConfirmBtn"
                class="px-5 py-2 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600 transition-all shadow-lg shadow-orange-500/20 text-sm uppercase tracking-wider">–ò–∑–º–µ–Ω–∏—Ç—å
                —Å—Ç–∞—Ç—É—Å</button>
        </div>
    </div>
</div>

<!-- Generic Confirmation Modal for Clear Actions -->
<div id="confirmClearModal" class="modal-overlay" style="z-index: 1200;">
    <div class="modal-content overflow-hidden border border-red-500/20 shadow-2xl shadow-red-500/10">
        <div class="p-5 border-b border-red-500/20 flex items-center justify-between bg-red-500/5">
            <h5 class="text-white font-bold flex items-center gap-2 text-sm uppercase tracking-wider">
                <span class="material-symbols-outlined text-red-500">warning</span>
                <span id="ccm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span>
            </h5>
            <button onclick="closeModal('confirmClearModal')" class="text-white/30 hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <p class="text-white/80 text-sm leading-relaxed mb-1" id="ccm-message"></p>
            <p class="text-red-500/60 text-[10px] uppercase font-black tracking-widest italic">–î–µ–π—Å—Ç–≤–∏–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ
                –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!</p>
        </div>
        <div class="p-4 border-t border-white/5 flex justify-end gap-3 bg-black/20">
            <button onclick="closeModal('confirmClearModal')"
                class="px-5 py-2 rounded-xl bg-white/5 text-white/60 hover:bg-white/10 transition-colors text-[10px] font-black uppercase tracking-widest border border-white/10">
                –û—Ç–º–µ–Ω–∞
            </button>
            <button id="ccm-confirm-btn"
                class="px-6 py-2 rounded-xl bg-red-500 text-white font-black hover:bg-red-600 transition-all shadow-lg shadow-red-500/20 text-[10px] uppercase tracking-widest border border-red-400/30">
                –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<div id="userDetailsModal" class="modal-overlay modal-xl" style="z-index: 1050;">
    <div class="modal-content bg-[#101815] border border-white/10 rounded-2xl shadow-2xl backdrop-blur-xl">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
            <button onclick="closeModal('userDetailsModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div id="udm-loading" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
                <p class="text-white/50 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div id="udm-content" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- LEFT COLUMN: User Profile & Finance -->
                    <div class="flex flex-col gap-4 h-full">
                        <!-- Profile Block -->
                        <div
                            class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-inner relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-6xl text-white">person</span>
                            </div>
                            <div class="relative z-10 flex items-start gap-4">
                                <div
                                    class="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center text-primary border border-primary/20 shadow-lg shadow-primary/5">
                                    <span class="material-symbols-outlined text-3xl">badge</span>
                                </div>
                                <div class="flex-1 min-w-0 pt-1">
                                    <div class="flex items-center gap-2">
                                        <h4 class="text-white font-bold text-xl leading-tight truncate select-all"
                                            id="udm-username"></h4>
                                        <span id="udm-pinned-badge"
                                            class="hidden material-symbols-outlined text-primary text-lg">push_pin</span>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-x-2.5 gap-y-2 mt-2.5">
                                        <span
                                            class="text-white/40 text-sm font-mono bg-black/30 px-2 py-0.5 rounded select-all"
                                            id="udm-telegram-id"></span>
                                        <div class="flex items-center gap-2">
                                            <div class="px-1.5 py-0.5 rounded bg-white/5 text-white/40 text-[10px] uppercase font-bold tracking-wider"
                                                title="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">
                                                <span
                                                    class="material-symbols-outlined text-[13px] opacity-30">calendar_today</span>
                                                <span id="udm-registration" class="font-mono pt-px"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Finance Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Balance -->
                            <div
                                class="bg-white/5 border border-white/10 rounded-2xl p-4 shadow-inner flex flex-col justify-between h-full relative overflow-hidden group">
                                <div
                                    class="absolute -bottom-4 -right-4 w-20 h-20 bg-primary/5 rounded-full blur-xl group-hover:bg-primary/10 transition-colors">
                                </div>
                                <div class="flex items-center gap-2 text-primary/80">
                                    <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                                    <span class="text-[10px] font-bold uppercase tracking-wider">–ë–∞–ª–∞–Ω—Å</span>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-white tracking-tight" id="udm-balance"></div>
                                    <div class="text-[10px] text-white/40 mt-1">–¢–µ–∫—É—â–∏–π —Å—á–µ—Ç</div>
                                </div>
                            </div>

                            <!-- Spent & Months -->
                            <div class="flex flex-col gap-4">
                                <div
                                    class="bg-white/5 border border-white/10 rounded-2xl p-3 flex-1 flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-white/50">
                                        <span class="material-symbols-outlined text-xl">payments</span>
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-white" id="udm-total-spent"></div>
                                        <div class="text-[9px] text-white/30 uppercase font-bold tracking-wider">
                                            –ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                                    </div>
                                </div>
                                <div
                                    class="bg-white/5 border border-white/10 rounded-2xl p-3 flex-1 flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-white/50">
                                        <span class="material-symbols-outlined text-xl">calendar_month</span>
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-white" id="udm-total-months"></div>
                                        <div class="text-[9px] text-white/30 uppercase font-bold tracking-wider">–ú–µ—Å—è—Ü–µ–≤
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Details Block (Reg & Trial) -->
                        <div
                            class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-inner space-y-5 flex-1 flex flex-col justify-center">
                            <div class="flex items-center justify-between group">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-orange-500/10 flex items-center justify-center text-orange-400">
                                        <span class="material-symbols-outlined text-lg">history_toggle_off</span>
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-white uppercase tracking-wide">–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥
                                        </div>
                                        <div class="text-[10px] text-white/40" id="udm-trial-label"></div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="udm-trial-toggle" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-black/40 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500">
                                    </div>
                                </label>
                            </div>



                            <!-- INDIVIDUAL SETTINGS BLOCK -->
                            <div class="border-t border-white/5 pt-3 mt-1">
                                <div class="flex items-center justify-between">
                                    <span
                                        class="text-[10px] uppercase font-bold text-white/30 tracking-wider">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ
                                        –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="udm-seller-active" class="sr-only peer">
                                        <div
                                            class="w-9 h-5 bg-white/10 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/40 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                        </div>
                                    </label>
                                </div>

                                <div id="udm-seller-settings"
                                    class="hidden mt-3 space-y-3 bg-white/5 p-3 rounded-xl border border-white/10">
                                    <div class="grid grid-cols-3 gap-3">
                                        <div>
                                            <label
                                                class="flex items-center text-[9px] uppercase font-bold text-white/30 mb-1">
                                                –°–∫–∏–¥–∫–∞ (%)
                                                <span
                                                    class="material-symbols-outlined text-[10px] ml-1 opacity-40">info</span>
                                            </label>
                                            <input type="number" step="0.1" id="udm-seller-sale"
                                                class="w-full bg-black/30 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white focus:outline-none focus:border-primary/50"
                                                placeholder="0">
                                        </div>
                                        <div>
                                            <label
                                                class="flex items-center text-[9px] uppercase font-bold text-white/30 mb-1">
                                                –†–µ—Ñ. (%)
                                                <span
                                                    class="material-symbols-outlined text-[10px] ml-1 opacity-40">info</span>
                                            </label>
                                            <input type="number" step="0.1" id="udm-seller-ref"
                                                class="w-full bg-black/30 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white focus:outline-none focus:border-primary/50"
                                                placeholder="0">
                                        </div>
                                        <div>
                                            <label
                                                class="flex items-center text-[9px] uppercase font-bold text-white/30 mb-1">
                                                UUID
                                                <span
                                                    class="material-symbols-outlined text-[10px] ml-1 opacity-40">info</span>
                                            </label>
                                            <input type="text" id="udm-seller-uuid"
                                                class="w-full bg-black/30 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white font-mono focus:outline-none focus:border-primary/50"
                                                placeholder="0">
                                        </div>
                                    </div>
                                    <button id="udm-save-seller-btn"
                                        class="w-full py-1.5 rounded-lg bg-primary/10 border border-primary/20 text-primary text-[10px] font-bold uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all mt-1">
                                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Referral System -->
                    <div
                        class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-inner flex flex-col h-full min-h-[300px] relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-6 opacity-5 pointer-events-none">
                            <span class="material-symbols-outlined text-9xl text-white">group_add</span>
                        </div>

                        <div class="flex items-center gap-4 mb-6 relative z-10">
                            <div
                                class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500/20 to-purple-500/5 flex items-center justify-center text-purple-400 border border-purple-500/20 shadow-lg shadow-purple-500/5">
                                <span class="material-symbols-outlined text-2xl">diversity_3</span>
                            </div>
                            <div>
                                <h4 class="text-white font-bold text-lg leading-tight">–†–µ—Ñ–µ—Ä–∞–ª—ã</h4>
                                <p class="text-white/40 text-xs mt-0.5">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</p>
                            </div>
                        </div>

                        <div class="space-y-2 flex-1 flex flex-col relative z-10">
                            <!-- Ref Info Cards Compact -->
                            <div class="flex gap-2">
                                <div class="flex-1 bg-black/20 border border-white/5 rounded-xl px-3 py-2 hover:bg-white/5 transition-colors cursor-pointer group flex h-10 items-center justify-between"
                                    onclick="copyToClipboard(document.getElementById('udm-ref-code').innerText, this)">
                                    <div
                                        class="text-[8px] font-bold text-white/40 uppercase tracking-widest group-hover:text-purple-400 transition-colors">
                                        –≤–∞—à –ö–æ–¥</div>
                                    <div class="text-[11px] font-bold text-white font-mono flex items-center gap-1.5">
                                        <span id="udm-ref-code"></span>
                                        <span
                                            class="material-symbols-outlined text-[10px] opacity-0 group-hover:opacity-50">content_copy</span>
                                    </div>
                                </div>
                                <div
                                    class="flex-1 bg-black/20 border border-white/5 rounded-xl px-3 py-2 flex h-10 items-center justify-between overflow-hidden">
                                    <div
                                        class="text-[8px] font-bold text-white/40 uppercase tracking-widest flex-shrink-0 mr-2">
                                        –ü—Ä–∏–≥–ª–∞—Å–∏–ª</div>
                                    <div class="text-[11px] font-bold text-white truncate text-purple-300 text-right"
                                        id="udm-referred-by"></div>
                                </div>
                            </div>

                            <!-- Ref List Section -->
                            <div
                                class="flex-1 bg-black/20 border border-white/5 rounded-2xl p-4 flex flex-col relative overflow-hidden">
                                <div class="flex items-center justify-between mb-3 flex-shrink-0">
                                    <div class="flex items-center gap-3">
                                        <span
                                            class="text-[10px] font-bold text-white/40 uppercase tracking-widest">–°–ø–∏—Å–æ–∫
                                            –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö</span>
                                        <label
                                            class="relative inline-flex items-center cursor-pointer scale-75 origin-left"
                                            title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ—Ö, –∫—Ç–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª > 0‚ÇΩ, –ø–µ—Ä–≤—ã–º–∏">
                                            <input type="checkbox" id="udm-ref-filter-spent" class="sr-only peer">
                                            <div
                                                class="w-9 h-5 bg-black/40 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white/60 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary/60 peer-checked:after:bg-white">
                                            </div>
                                            <span
                                                class="ml-2 text-[9px] font-bold text-white/30 uppercase tracking-widest peer-checked:text-primary transition-colors">–ê–∫—Ç–∏–≤–Ω—ã–µ</span>
                                        </label>
                                    </div>
                                    <span
                                        class="px-2 py-0.5 rounded-md bg-purple-500/10 text-purple-400 border border-purple-500/20 text-[10px] font-bold"
                                        id="udm-ref-count-badge">
                                        <span id="udm-ref-count">0</span> / <span id="udm-refs-total">0</span>
                                    </span>
                                </div>

                                <div class="custom-scroll pr-1 -mr-1 overflow-y-auto h-[222px]">
                                    <ul id="udm-referrals-list" class="space-y-2 pb-2"></ul>
                                </div>

                                <div>
                                    <button id="udm-refs-load-more"
                                        class="w-full py-2.5 rounded-xl bg-white/5 border border-white/10 text-white/60 text-[10px] font-bold uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all flex items-center justify-center gap-2 hidden">
                                        <span class="material-symbols-outlined text-sm">expand_circle_down</span>
                                        –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–æ–ª—å—à–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Toolbar -->
                <div class="mb-6 grid grid-cols-4 md:grid-cols-7 gap-3">
                    <button id="udm-action-pin"
                        class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center gap-2 hover:bg-white/10 hover:border-white/20 transition-all group">
                        <span id="udm-action-pin-icon"
                            class="material-symbols-outlined text-white/50 group-hover:text-primary transition-colors">push_pin</span>
                        <span id="udm-action-pin-text"
                            class="text-[10px] font-bold text-white/60 uppercase tracking-wide">–ó–∞–∫—Ä–µ–ø</span>
                    </button>
                    <button id="udm-action-issue"
                        class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center gap-2 hover:bg-white/10 hover:border-white/20 transition-all group">
                        <span
                            class="material-symbols-outlined text-white/50 group-hover:text-primary transition-colors">vpn_key</span>
                        <span class="text-[10px] font-bold text-white/60 uppercase tracking-wide">–í—ã–¥–∞—Ç—å</span>
                    </button>
                    <button id="udm-action-add-bal"
                        class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center gap-2 hover:bg-white/10 hover:border-white/20 transition-all group">
                        <span
                            class="material-symbols-outlined text-white/50 group-hover:text-green-400 transition-colors">add_card</span>
                        <span class="text-[10px] font-bold text-white/60 uppercase tracking-wide">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</span>
                    </button>
                    <button id="udm-action-sub-bal"
                        class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center gap-2 hover:bg-white/10 hover:border-white/20 transition-all group">
                        <span
                            class="material-symbols-outlined text-white/50 group-hover:text-red-400 transition-colors">credit_card_off</span>
                        <span class="text-[10px] font-bold text-white/60 uppercase tracking-wide">–°–ø–∏—Å–∞—Ç—å</span>
                    </button>
                    <button id="udm-action-msg"
                        class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center gap-2 hover:bg-white/10 hover:border-white/20 transition-all group">
                        <span
                            class="material-symbols-outlined text-white/50 group-hover:text-blue-400 transition-colors">mail</span>
                        <span class="text-[10px] font-bold text-white/60 uppercase tracking-wide">–ù–∞–ø–∏—Å–∞—Ç—å</span>
                    </button>
                    <button id="udm-action-ban"
                        class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center gap-2 hover:bg-white/10 hover:border-white/20 transition-all group">
                        <span
                            class="material-symbols-outlined text-white/50 group-hover:text-red-500 transition-colors">block</span>
                        <span class="text-[10px] font-bold text-white/60 uppercase tracking-wide">–ë–∞–Ω</span>
                    </button>
                    <button id="udm-action-revoke-all"
                        class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center gap-2 hover:bg-white/10 hover:border-white/20 transition-all group">
                        <span
                            class="material-symbols-outlined text-white/50 group-hover:text-red-500 transition-colors">delete_forever</span>
                        <span class="text-[10px] font-bold text-white/60 uppercase tracking-wide">–û—Ç–æ–∑–≤–∞—Ç—å</span>
                    </button>
                </div>

                <!-- Subscriptions Section -->
                <div class="mb-6">
                    <div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-inner group">
                        <div class="p-5 border-b border-white/10 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400">
                                    <span class="material-symbols-outlined text-xl">vpn_key</span>
                                </div>
                                <div>
                                    <h4 class="text-white font-bold text-sm uppercase tracking-wide">–ü–æ–¥–ø–∏—Å–∫–∏</h4>
                                    <p class="text-white/40 text-[10px] font-medium" id="udm-subs-stats"></p>
                                </div>
                            </div>
                        </div>
                        <div id="udm-subs-list" class="max-h-[450px] overflow-y-auto divide-y divide-white/5 p-2"></div>
                    </div>
                </div>

                <!-- Payment History Section -->
                <div class="mb-6">
                    <div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-inner group">
                        <div class="p-5 border-b border-white/10 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-green-500/10 flex items-center justify-center text-green-400">
                                    <span class="material-symbols-outlined text-xl">receipt_long</span>
                                </div>
                                <div>
                                    <h4 class="text-white font-bold text-sm uppercase tracking-wide">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
                                    </h4>
                                    <p class="text-white/40 text-[10px] font-medium">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫</p>
                                </div>
                            </div>
                            <button id="udm-clear-payment-history"
                                class="px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-all flex items-center gap-1.5 text-[10px] font-bold uppercase tracking-wider border border-red-500/20 hover:shadow-lg hover:shadow-red-500/10"
                                title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞—Ç–µ–∂–µ–π">
                                <span class="material-symbols-outlined text-sm">delete_sweep</span>
                                –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                            </button>
                        </div>
                        <div class="overflow-x-auto max-h-[300px] overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-black/20 border-b border-white/5 sticky top-0 backdrop-blur-md">
                                    <tr>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –î–∞—Ç–∞</th>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –¢–∞—Ä–∏—Ñ</th>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –•–æ—Å—Ç</th>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –¢–∏–ø</th>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –°—É–º–º–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="udm-payment-history" class="divide-y divide-white/5"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Balance History Section -->
                <div>
                    <div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-inner group">
                        <div class="p-5 border-b border-white/10 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-orange-500/10 flex items-center justify-center text-orange-400">
                                    <span class="material-symbols-outlined text-xl">account_balance</span>
                                </div>
                                <div>
                                    <h4 class="text-white font-bold text-sm uppercase tracking-wide">–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞
                                    </h4>
                                    <p class="text-white/40 text-[10px] font-medium">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å–ø–∏—Å–∞–Ω–∏—è</p>
                                </div>
                            </div>
                            <button id="udm-clear-balance-history"
                                class="px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-all flex items-center gap-1.5 text-[10px] font-bold uppercase tracking-wider border border-red-500/20 hover:shadow-lg hover:shadow-red-500/10"
                                title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞">
                                <span class="material-symbols-outlined text-sm">delete_sweep</span>
                                –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                            </button>
                        </div>
                        <div class="overflow-x-auto max-h-[300px] overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-black/20 border-b border-white/5 sticky top-0 backdrop-blur-md">
                                    <tr>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –î–∞—Ç–∞</th>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –¢–∞—Ä–∏—Ñ</th>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –•–æ—Å—Ç</th>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –¢–∏–ø</th>
                                        <th
                                            class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white/40 text-left">
                                            –°—É–º–º–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="udm-balance-history" class="divide-y divide-white/5"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {

        async function clearBalanceHistory(uid) {
            showConfirmModal(
                '–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞',
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?',
                async () => {
                    try {
                        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                        const resp = await fetch(`{{ url_for('clear_balance_history_route', user_id=0) }}`.replace('/0/', `/${uid}/`), {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrfToken },
                            credentials: 'same-origin'
                        });
                        const data = await resp.json();
                        if (data && data.ok) {
                            showToast('success', data.message || '–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
                            document.getElementById('udm-balance-history').innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-white/50">–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞</td></tr>';
                        } else {
                            showToast('danger', (data && data.error) || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ');
                        }
                    } catch (e) {
                        showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + e.message);
                    }
                }
            );
        }

        async function clearPaymentHistory(uid) {
            showConfirmModal(
                '–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π',
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–Ω–µ—à–Ω–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?',
                async () => {
                    try {
                        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                        const resp = await fetch(`{{ url_for('clear_payment_history_route', user_id=0) }}`.replace('/0/', `/${uid}/`), {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrfToken },
                            credentials: 'same-origin'
                        });
                        const data = await resp.json();
                        if (data && data.ok) {
                            showToast('success', data.message || '–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
                            document.getElementById('udm-payment-history').innerHTML = '<tr><td colspan="5" class="px-5 py-8 text-center text-white/30 text-xs uppercase tracking-widest font-bold">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';
                        } else {
                            showToast('danger', (data && data.error) || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ');
                        }
                    } catch (e) {
                        showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + e.message);
                    }
                }
            );
        }

        document.getElementById('udm-clear-balance-history')?.addEventListener('click', function () {
            const uid = document.getElementById('udm-trial-toggle').getAttribute('data-user-id');
            if (uid) clearBalanceHistory(uid);
        });

        document.getElementById('udm-clear-payment-history')?.addEventListener('click', function () {
            const uid = document.getElementById('udm-trial-toggle').getAttribute('data-user-id');
            if (uid) clearPaymentHistory(uid);
        });

        const input = document.getElementById('users-search');
        const clearBtn = document.getElementById('search-clear');
        const table = document.getElementById('users-table');
        const tbody = document.getElementById('users-tbody');
        if (!input || !table || !tbody) return;

        const toggleClearBtn = () => {
            if (clearBtn) clearBtn.classList.toggle('hidden', !input.value);
        };
        input.addEventListener('input', toggleClearBtn);
        clearBtn?.addEventListener('click', () => {
            input.value = '';
            toggleClearBtn();
            input.focus();
            input.dispatchEvent(new Event('input'));
        });
        toggleClearBtn();

        // ===== LAZY LOAD LOGIC =====
        const loadUsersTable = async () => {
            const url = new URL(tbody.dataset.fetchUrl, location.origin);
            try {
                const resp = await fetch(url, { headers: { 'Accept': 'text/html' } });
                if (resp.ok) {
                    tbody.innerHTML = await resp.text();
                    updatePagination(url); // Helper to reload pagination if needed
                }
            } catch (e) {
                console.error("Failed to load users:", e);
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
            }
        };

        const updatePagination = async (currentUrl) => {
            const pagEl = document.getElementById('users-pagination');
            if (pagEl) {
                const pagUrl = new URL(pagEl.dataset.src, location.origin);
                // Copy params from current table url (like q, page) to pagination url
                currentUrl.searchParams.forEach((v, k) => pagUrl.searchParams.set(k, v));
                try {
                    const resp = await fetch(pagUrl, { headers: { 'Accept': 'text/html' } });
                    if (resp.ok) pagEl.innerHTML = await resp.text();
                } catch (_) { }
            }
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É
        loadUsersTable();

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        if (tbody.dataset.fetchInterval) {
            setInterval(loadUsersTable, parseInt(tbody.dataset.fetchInterval));
        }

        const LS_KEY = 'users_open_keys_ids';
        function loadOpenSet() {
            try {
                const raw = localStorage.getItem(LS_KEY);
                return new Set(raw ? JSON.parse(raw) : []);
            } catch (_) { return new Set(); }
        }
        function saveOpenSet(set) {
            try { localStorage.setItem(LS_KEY, JSON.stringify(Array.from(set))); } catch (_) { }
        }
        const openSet = loadOpenSet();

        function getRows() {
            return Array.from(tbody.children).filter(tr => tr.tagName === 'TR' && !tr.classList.contains('keys-row'));
        }

        function getKeysRowByUid(uid) { return document.getElementById('keys-' + uid); }

        async function ensureKeysLoaded(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            const body = row.querySelector('[data-lazy="keys"]');
            if (!body || body.getAttribute('data-loaded') === '1') return;
            const src = row.getAttribute('data-src');
            if (!src) return;
            try {
                const resp = await fetch(src, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                if (resp.ok) {
                    body.innerHTML = await resp.text();
                    body.setAttribute('data-loaded', '1');
                }
            } catch (_) { }
        }

        function openKeysForUid(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            row.classList.remove('hidden');
            openSet.add(String(uid));
            saveOpenSet(openSet);
        }

        function closeKeysForUid(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            row.classList.add('hidden');
            openSet.delete(String(uid));
            saveOpenSet(openSet);
        }

        function restoreOpenedKeys() {
            openSet.forEach(uid => {
                const row = getKeysRowByUid(uid);
                if (row) row.classList.remove('hidden');
            });
        }

        function applyFilter() {
            const q = (input.value || '').toLowerCase().trim();
            getRows().forEach(tr => {
                const id = (tr.querySelector('.user-id')?.textContent || '').toLowerCase();
                const name = (tr.querySelector('.user-name')?.textContent || '').toLowerCase();
                tr.classList.toggle('hidden', q && !id.includes(q) && !name.includes(q));
            });
        }

        input.addEventListener('input', applyFilter);
        input.addEventListener('search', applyFilter);

        let searchTimeout = null;
        input.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const url = new URL(tbody.getAttribute('data-fetch-url'), location.origin);
                const qValue = input.value || '';
                url.searchParams.set('q', qValue);
                url.searchParams.set('page', '1');
                try {
                    const resp = await fetch(url, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                    if (resp.ok) {
                        tbody.innerHTML = await resp.text();
                        // –í–∞–∂–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º data-fetch-url –¥–ª—è –±—É–¥—É—â–∏—Ö AJAX —Ä–µ—Ñ—Ä–µ—à–µ–π
                        tbody.setAttribute('data-fetch-url', url.toString());

                        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º URL –≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                        const pagEl = document.getElementById('users-pagination');
                        if (pagEl) {
                            const pagUrl = new URL(pagEl.getAttribute('data-src'), location.origin);
                            pagUrl.searchParams.set('q', qValue);
                            pagUrl.searchParams.set('page', '1');
                            pagEl.setAttribute('data-src', pagUrl.toString());

                            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                            const pResp = await fetch(pagUrl, { headers: { 'Accept': 'text/html' } });
                            if (pResp.ok) pagEl.innerHTML = await pResp.text();
                        }

                        restoreOpenedKeys();
                        applyFilter();
                    }
                } catch (_) { }
            }, 400);
        });

        table.addEventListener('click', function (e) {
            const btn = e.target.closest('[data-toggle="keys"]');
            if (!btn) return;
            const uid = btn.getAttribute('data-user');
            const row = getKeysRowByUid(uid);
            if (!row) return;
            if (row.classList.contains('hidden')) {
                openKeysForUid(uid);
                ensureKeysLoaded(uid);
            } else {
                closeKeysForUid(uid);
            }
        });

        // Reusable function to open balance modal
        async function openBalanceModalForUser(uid, uname, balance, sign = '') {
            let refs = [];
            try {
                const resp = await fetch(`{{ url_for('user_referrals_json', user_id=0) }}`.replace('/0/', `/${uid}/`), { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
                const data = await resp.json();
                refs = (data && data.ok) ? (data.items || []) : [];
            } catch (_) { }

            document.getElementById('bm-user').textContent = `@${uname} (#${uid})`;
            document.getElementById('bm-balance').textContent = balance;
            document.getElementById('bm-form').action = `{{ url_for('adjust_balance_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
            document.getElementById('bm-refcount').textContent = refs.length;
            document.getElementById('bm-reflist').innerHTML = refs.map(r => `<li>#${r.telegram_id} ‚Äî @${r.username || 'N/A'} ¬∑ ${r.registration_date}</li>`).join('');

            const deltaInput = document.querySelector('#bm-form input[name="delta"]');
            if (deltaInput) {
                deltaInput.value = sign;
                setTimeout(() => { deltaInput.focus(); deltaInput.setSelectionRange(1, 1); }, 100);
            }
            openModal('balanceModal');
        }

        table.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-user-balance-sign');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');
            const uname = btn.getAttribute('data-username') || 'N/A';
            const balance = btn.getAttribute('data-balance') || '0.00';
            const sign = btn.getAttribute('data-sign') || '';

            openBalanceModalForUser(uid, uname, balance, sign);
        });

        // Reusable function to open message modal
        function openMessageModalForUser(uid, uname) {
            document.getElementById('mm-user').textContent = `@${uname} (#${uid})`;
            document.getElementById('mm-form').action = `{{ url_for('send_user_message_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
            document.querySelector('#mm-form textarea[name="message"]').value = '';
            openModal('messageModal');
        }

        // Reusable function to ban user
        async function banUser(uid, uname) {
            document.getElementById('banModalText').innerHTML = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è <span class="text-primary font-bold">@${uname}</span>?`;

            const confirmBtn = document.getElementById('banConfirmBtn');
            confirmBtn.onclick = async () => {
                const data = await apiRequest(
                    `{{ url_for('toggle_block_user_route', user_id=0) }}`.replace('/0/', `/${uid}/`),
                    'POST',
                    {},
                    '–°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω'
                );
                if (data) {
                    closeModal('banConfirmModal');
                    // Refresh details if modal is open
                    const udmContent = document.getElementById('udm-content');
                    if (!udmContent.classList.contains('hidden')) {
                        fetchUserDetails(uid);
                    }
                }
            };
            openModal('banConfirmModal');
        }

        // Reusable function to revoke all keys
        async function revokeAllKeys(uid, uname) {
            const confirmBtn = document.getElementById('revokeAllConfirmBtn');
            confirmBtn.onclick = async () => {
                const data = await apiRequest(
                    `{{ url_for('revoke_keys_route', user_id=0) }}`.replace('/0/', `/${uid}/`),
                    'POST',
                    {},
                    '–í—Å–µ –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–æ–∑–≤–∞–Ω—ã'
                );
                if (data) {
                    closeModal('revokeAllConfirmModal');
                    const udmContent = document.getElementById('udm-content');
                    if (!udmContent.classList.contains('hidden')) {
                        fetchUserDetails(uid);
                    }
                }
            };
            openModal('revokeAllConfirmModal');
        }

        // ===== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ó–ê–ü–†–û–° =====
        async function apiRequest(url, method, body, successMsg) {
            try {
                const fd = body instanceof FormData ? body : new FormData();
                if (!(body instanceof FormData) && typeof body === 'object') Object.entries(body).forEach(([k, v]) => fd.append(k, v));

                const csrfToken = getCsrfToken();
                fd.append('csrf_token', csrfToken);

                const resp = await fetch(url, {
                    method,
                    body: fd,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'same-origin'
                });
                const data = await resp.json().catch(() => ({ ok: resp.ok }));
                if (data.ok) {
                    if (successMsg) showToast('success', successMsg);
                    return data;
                }
                showToast('danger', (data && data.message) || data.error || '–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏');
                return null;
            } catch (e) {
                showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
                return null;
            }
        }

        // ===== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ó–ê–ü–†–û–° –ü–ï–†–ï–ù–ï–°–ï–ù –í BASE.HTML =====

        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –Ω–æ AJAX —Ñ–æ—Ä–º—ã —Ç–µ–ø–µ—Ä—å –≤ base.html

        document.addEventListener('submit', (e) => {
            const form = e.target.closest('#commentForm, #expiryForm, #revokeKeyInternalForm'); // –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ñ–æ—Ä–º –º–æ–¥–∞–ª–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (!form) return;
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –º–æ–¥–∞–ª–æ–∫ –∫–ª—é—á–µ–π
        });

        // ===== AJAX –ù–ê–í–ò–ì–ê–¶–ò–Ø =====
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('.ajax-nav');
            if (!link) return;

            e.preventDefault();
            const href = link.getAttribute('href');
            if (!href) return;

            history.pushState(null, '', href);
            const urlObj = new URL(href, location.origin);
            const params = new URLSearchParams(urlObj.search);
            await updateTableAndPagination(params);
        });

        window.addEventListener('popstate', () => {
            const params = new URLSearchParams(location.search);
            updateTableAndPagination(params);
        });

        async function updateTableAndPagination(params) {
            const tbody = document.getElementById('users-tbody');
            const pagEl = document.getElementById('users-pagination');
            if (!tbody) return;

            const tableBaseUrl = tbody.getAttribute('data-fetch-url').split('?')[0];
            const tableUrl = `${tableBaseUrl}?${params.toString()}`;

            let pagUrl = '';
            if (pagEl) {
                const pagBaseUrl = pagEl.getAttribute('data-src').split('?')[0];
                pagUrl = `${pagBaseUrl}?${params.toString()}`;
            }

            try {
                const [tableResp, pagResp] = await Promise.all([
                    fetch(tableUrl, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' }),
                    pagUrl ? fetch(pagUrl, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' }) : Promise.resolve(null)
                ]);

                if (tableResp.ok) {
                    const html = await tableResp.text();
                    if (isLoginPage(html)) { window.location.reload(); return; }
                    tbody.innerHTML = html;
                    tbody.setAttribute('data-fetch-url', tableUrl); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º URL –¥–ª—è —Ä–µ—Ñ—Ä–µ—à–∞
                    restoreOpenedKeys(); // Restore opened key rows state
                }

                if (pagResp && pagResp.ok && pagEl) {
                    const html = await pagResp.text();
                    if (isLoginPage(html)) { window.location.reload(); return; }
                    pagEl.innerHTML = html;
                    // Update data-src for next usage
                    pagEl.setAttribute('data-src', pagUrl);
                }
            } catch (err) {
                console.error('Navigation error:', err);
                showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        table.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-user-message');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');
            const uname = btn.getAttribute('data-username') || 'N/A';

            e.preventDefault();
            openMessageModalForUser(uid, uname);
        });

        async function fetchUserDetails(uid) {
            document.getElementById('udm-loading').classList.remove('hidden');
            document.getElementById('udm-content').classList.add('hidden');

            try {
                const resp = await fetch(`{{ url_for('user_details_json', user_id=0) }}`.replace('/0/', `/${uid}/`), {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'same-origin'
                });
                const data = await resp.json();
                if (typeof data === 'string' && isLoginPage(data)) { window.location.reload(); return; }

                if (data && data.ok) {
                    // Seller Settings Logic
                    const sellerInfo = data.seller_info || { active: false, settings: {} };
                    const sellerActive = sellerInfo.active;
                    const sellerSettings = sellerInfo.settings || { seller_sale: 0, seller_ref: 0, seller_uuid: "0" };

                    // Elements
                    const sellerToggle = document.getElementById('udm-seller-active');
                    const sellerContainer = document.getElementById('udm-seller-settings');
                    const sellerSaleInput = document.getElementById('udm-seller-sale');
                    const sellerRefInput = document.getElementById('udm-seller-ref');
                    const sellerUuidInput = document.getElementById('udm-seller-uuid');
                    const sellerSaveBtn = document.getElementById('udm-save-seller-btn');

                    // Init State
                    if (sellerToggle) {
                        sellerToggle.checked = sellerActive;
                        if (sellerActive) {
                            sellerContainer.classList.remove('hidden');
                        } else {
                            sellerContainer.classList.add('hidden');
                        }

                        sellerSaleInput.value = sellerSettings.seller_sale || 0;
                        sellerRefInput.value = sellerSettings.seller_ref || 0;
                        sellerUuidInput.value = sellerSettings.seller_uuid || "0";

                        // Handlers
                        const saveSellerSettings = async () => {
                            const payload = new FormData();
                            payload.append('seller_active', sellerToggle.checked ? 1 : 0);
                            payload.append('seller_sale', sellerSaleInput.value);
                            payload.append('seller_ref', sellerRefInput.value);
                            payload.append('seller_uuid', sellerUuidInput.value);

                            const csrfToken = getCsrfToken();
                            payload.append('csrf_token', csrfToken);

                            sellerSaveBtn.disabled = true;
                            const oldText = sellerSaveBtn.textContent;
                            sellerSaveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                            try {
                                const resp = await fetch(`/admin/users/${uid}/seller_settings`, {
                                    method: 'POST',
                                    body: payload,
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest',
                                        'X-CSRFToken': csrfToken
                                    }
                                });
                                const res = await resp.json();
                                if (res.ok) {
                                    showToast('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                                } else {
                                    showToast('danger', '–û—à–∏–±–∫–∞: ' + res.error);
                                }
                            } catch (e) {
                                showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e);
                            } finally {
                                sellerSaveBtn.disabled = false;
                                sellerSaveBtn.textContent = oldText;
                            }
                        };

                        sellerToggle.onchange = () => {
                            if (sellerToggle.checked) {
                                sellerContainer.classList.remove('hidden');
                            } else {
                                sellerContainer.classList.add('hidden');
                            }
                            saveSellerSettings();
                        };

                        sellerSaveBtn.onclick = saveSellerSettings;
                    }

                    document.getElementById('udm-telegram-id').textContent = data.user.telegram_id || 'N/A';
                    document.getElementById('udm-username').textContent = '@' + (data.user.username || 'N/A');
                    document.getElementById('udm-registration').textContent = data.user.registration_date || 'N/A';
                    document.getElementById('udm-total-spent').textContent = (data.user.total_spent || 0).toFixed(2) + ' ‚ÇΩ';
                    document.getElementById('udm-total-months').textContent = (data.user.total_months || 0) + ' –º–µ—Å.';

                    const trialToggle = document.getElementById('udm-trial-toggle');
                    const trialLabel = document.getElementById('udm-trial-label');
                    trialToggle.checked = data.user.trial_used || false;
                    trialToggle.setAttribute('data-user-id', uid);
                    trialLabel.textContent = data.user.trial_used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ' : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ';

                    document.getElementById('udm-ref-code').textContent = data.user.referral_code || 'N/A';
                    document.getElementById('udm-ref-count').textContent = data.user.referral_count || '0';
                    document.getElementById('udm-referred-by').textContent = data.user.referred_by?.username ?
                        `@${data.user.referred_by.username} (#${data.user.referred_by.telegram_id})` : '–ù–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω';
                    document.getElementById('udm-balance').textContent = (data.user.balance || 0).toFixed(2) + ' ‚ÇΩ';

                    const pinBadge = document.getElementById('udm-pinned-badge');
                    if (pinBadge) {
                        pinBadge.classList.toggle('hidden', !data.user.is_pinned);
                        pinBadge.style.color = '#22c55e'; // –Ø—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π (green-500)
                    }

                    const pinText = document.getElementById('udm-action-pin-text');
                    const pinIcon = document.getElementById('udm-action-pin-icon');
                    if (pinText) pinText.textContent = data.user.is_pinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
                    if (pinIcon) {
                        if (data.user.is_pinned) {
                            pinIcon.style.color = '#22c55e';
                            pinIcon.classList.add('rotate-45');
                        } else {
                            pinIcon.style.color = '';
                            pinIcon.classList.remove('rotate-45');
                        }
                    }

                    const subsStats = document.getElementById('udm-subs-stats');
                    const subsList = document.getElementById('udm-subs-list');
                    subsStats.textContent = data.subs_stats ?
                        `(–í—Å–µ–≥–æ: ${data.subs_stats.total}, –ê–∫—Ç–∏–≤–Ω–æ: ${data.subs_stats.active}, –ò—Å—Ç–µ–∫–ª–æ: ${data.subs_stats.expired})` : '';
                    subsList.innerHTML = data.subscriptions?.length ? data.subscriptions.map(sub => {
                        // Duration Helper
                        function formatDuration(dateStr) {
                            if (!dateStr || sub.is_expired) return '';
                            const d = new Date(dateStr);
                            const now = new Date();
                            const diffDays = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
                            if (diffDays <= 0) return '';
                            if (diffDays > 30) {
                                const months = Math.round(diffDays / 30);
                                return `(${months} –º–µ—Å.)`;
                            }
                            return '';
                        }
                        const durationText = formatDuration(sub.expire_date);
                        // Extract local part of email
                        const emailDisp = sub.email ? sub.email.split('@')[0] : 'N/A';

                        return `
                    <div class="p-4 relative bg-black/20 mb-4 border border-white/5 rounded-2xl last:mb-0 shadow-lg hover:bg-black/30 transition-colors">
                        <div class="flex items-center gap-2 mb-3 flex-wrap justify-between">
                            <div class="flex items-center gap-2">
                                <span class="${sub.is_expired ? 'text-red-400' : 'text-primary'} font-bold text-sm">${sub.status_text}</span>
                                ${durationText ? `<span class="text-white/50 text-sm font-medium bg-white/5 px-2 py-0.5 rounded-lg">${durationText}</span>` : ''}
                                <span class="text-white/30 text-[10px] uppercase font-bold tracking-wider ml-1">–ò—Å—Ç–µ–∫–∞–µ—Ç: ${sub.expire_date}</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-white/50 font-medium">
                                ${sub.admin_comment ? `<span class="px-2 py-0.5 rounded-lg bg-green-500/10 text-green-400 border border-green-500/20" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∞: ${sub.admin_comment.replace(/"/g, '&quot;')}">${sub.admin_comment}</span>` : ''}
                                ${sub.user_comment ? `<span class="px-2 py-0.5 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/20 italic max-w-[150px] truncate" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${sub.user_comment.replace(/"/g, '&quot;')}">${sub.user_comment}</span>` : ''}
                                <div class="bg-white/5 px-2 py-0.5 rounded-lg border border-white/10">${sub.host_name}</div>
                            </div>
                        </div>
                        <div class="bg-white/5 rounded-xl p-3 font-mono text-sm text-primary break-all mb-3 pr-2 relative flex items-center gap-3 border border-white/5 group-hover:border-white/10 transition-colors">
                            <span class="flex-1 select-all">${sub.key}</span>
                            <button onclick="copyToClipboard('${sub.key}', this)" 
                                    class="flex-shrink-0 w-8 h-8 rounded-lg bg-white/5 hover:bg-primary/20 hover:text-primary text-white/50 flex items-center justify-center transition-all shadow-lg shadow-black/20"
                                    title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
                                <span class="material-symbols-outlined text-sm">content_copy</span>
                            </button>
                            <button onclick="window.open('${sub.key}', '_blank')" 
                                    class="flex-shrink-0 w-8 h-8 rounded-lg bg-white/5 hover:bg-primary/20 hover:text-primary text-white/50 flex items-center justify-center transition-all shadow-lg shadow-black/20"
                                    title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É">
                                <span class="material-symbols-outlined text-sm">open_in_new</span>
                            </button>
                        </div>

                        <!-- Actions Row -->
                        <div class="flex items-center gap-2 justify-between flex-wrap mt-2">
                             <!-- Left: Email & UUID -->
                             <div class="flex items-center gap-2 flex-wrap">
                                <div class="bg-white/5 border border-white/5 rounded-lg px-2 py-1 text-[10px] font-bold text-white/70 cursor-pointer hover:bg-white/10 transition-colors flex items-center gap-1.5 uppercase tracking-wide group" 
                                     onclick="copyToClipboard('${sub.email}', this)" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π email">
                                    <span class="material-symbols-outlined text-[10px] opacity-40 group-hover:text-primary transition-colors">mail</span>
                                    <span class="text-white/40">Email:</span> <span class="text-white group-hover:text-primary transition-colors">${sub.email}</span>
                                </div>
                                <div class="bg-white/5 border border-white/5 rounded-lg px-2 py-1 text-[10px] font-bold text-white/70 cursor-pointer hover:bg-white/10 transition-colors flex items-center gap-1.5 uppercase tracking-wide group" 
                                     onclick="copyToClipboard('${emailDisp}', this)" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                                    <span class="material-symbols-outlined text-[10px] opacity-40 group-hover:text-primary transition-colors">person</span>
                                    <span class="text-white/40">User:</span> <span class="text-white group-hover:text-primary transition-colors">${emailDisp}</span>
                                </div>
                                <div class="bg-white/5 border border-white/5 rounded-lg px-2 py-1 text-[10px] font-bold text-white/70 cursor-pointer hover:bg-white/10 transition-colors flex items-center gap-1.5 uppercase tracking-wide group" 
                                     onclick="copyToClipboard('${sub.remnawave_user_uuid}', this)" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å UUID">
                                    <span class="material-symbols-outlined text-[10px] opacity-40 group-hover:text-primary transition-colors">fingerprint</span>
                                    <span class="text-white/40">UUID:</span> <span class="font-mono text-white group-hover:text-primary transition-colors">${sub.remnawave_user_uuid.substring(0, 8)}...</span>
                                </div>
                             </div>

                             <!-- Right: Buttons -->
                             <div class="flex items-center gap-2 flex-shrink-0">
                                  <button class="btn-user-edit-expiry w-8 h-8 flex items-center justify-center rounded-lg bg-yellow-500/10 text-yellow-400 hover:bg-yellow-500/20 border border-yellow-500/20 transition-all"
                                          data-key-id="${sub.key_id}" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫">
                                      <span class="material-symbols-outlined text-sm">schedule</span>
                                  </button>
                                  
                                  <button class="btn-user-edit-comment w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 text-white/70 hover:bg-white/10 hover:text-white border border-white/10 transition-all"
                                          data-key-id="${sub.key_id}" data-current-comment="${(sub.admin_comment || '').replace(/"/g, '&quot;')}" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                                      <span class="material-symbols-outlined text-sm">comment</span>
                                  </button>

                                  <button class="btn-user-revoke-key w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20 transition-all"
                                          data-key-id="${sub.key_id}" title="–û—Ç–æ–∑–≤–∞—Ç—å">
                                      <span class="material-symbols-outlined text-sm">delete</span>
                                  </button>
                             </div>
                        </div>
                    </div>
                `}).join('') : '<div class="p-8 text-center text-white/30 text-sm font-medium border-2 border-dashed border-white/5 rounded-2xl">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</div>';

                    function formatWithRelative(dateStr) {
                        if (!dateStr) return 'N/A';
                        try {
                            const d = new Date(dateStr);
                            const now = new Date();
                            const diffMs = now - d;
                            const diffMins = Math.floor(diffMs / 60000);
                            const diffHours = Math.floor(diffMs / 3600000);
                            const diffDays = Math.floor(diffMs / 86400000);

                            let rel = '';
                            if (diffMins < 60) rel = `(${diffMins}–º–∏–Ω)`;
                            else if (diffHours < 24) rel = `(${diffHours}—á)`;
                            else if (diffDays < 30) rel = `(${diffDays}–¥)`;
                            else if (diffDays < 365) rel = `(${Math.round(diffDays / 30)}–º–µ—Å)`;
                            else rel = `(${Math.round(diffDays / 365)}–≥)`;

                            // Format YYYY-MM-DD HH:MM:SS
                            const Y = d.getFullYear();
                            const M = String(d.getMonth() + 1).padStart(2, '0');
                            const D = String(d.getDate()).padStart(2, '0');
                            const h = String(d.getHours()).padStart(2, '0');
                            const m = String(d.getMinutes()).padStart(2, '0');
                            const s = String(d.getSeconds()).padStart(2, '0');

                            return `${Y}-${M}-${D} ${h}:${m}:${s} <span class="text-white/50 text-xs">${rel}</span>`;
                        } catch (e) {
                            return dateStr;
                        }
                    }

                    const paymentHistory = document.getElementById('udm-payment-history');
                    paymentHistory.innerHTML = data.payment_history?.length ? data.payment_history.map(p => `
                    <tr class="hover:bg-white/5 transition-colors group">
                        <td class="px-5 py-2.5 text-xs font-medium text-white/70 whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none font-mono">${formatWithRelative(p.date)}</td>
                        <td class="px-5 py-2.5 text-xs font-medium text-white whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none">${p.plan || 'N/A'}</td>
                        <td class="px-5 py-2.5 text-xs font-medium text-white whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none">${p.host || 'N/A'}</td>
                        <td class="px-5 py-2.5 text-xs font-bold text-white/60 uppercase tracking-wider whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none text-[10px]">${p.type || 'N/A'}</td>
                        <td class="px-5 py-2.5 text-xs font-bold text-white whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none font-mono">${(p.amount || 0).toFixed(2)} ‚ÇΩ</td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="px-5 py-8 text-center text-white/30 text-xs uppercase tracking-widest font-bold">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';

                    const balanceHistory = document.getElementById('udm-balance-history');
                    balanceHistory.innerHTML = data.balance_history?.length ? data.balance_history.map(t => `
                    <tr class="hover:bg-white/5 transition-colors group">
                        <td class="px-5 py-2.5 text-xs font-medium text-white/70 whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none font-mono">${formatWithRelative(t.date)}</td>
                        <td class="px-5 py-2.5 text-xs font-medium text-white whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none">${t.plan || '‚Äî'}</td>
                        <td class="px-5 py-2.5 text-xs font-medium text-white whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none">${t.host || '‚Äî'}</td>
                        <td class="px-5 py-2.5 text-xs font-bold text-white/60 uppercase tracking-wider whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none text-[10px]">${t.type || 'N/A'}</td>
                        <td class="px-5 py-2.5 text-xs font-bold text-white whitespace-nowrap border-b border-dashed border-white/5 group-last:border-none font-mono">${(t.amount || 0).toFixed(2)} ‚ÇΩ</td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="px-5 py-8 text-center text-white/30 text-xs uppercase tracking-widest font-bold">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';

                    document.getElementById('udm-loading').classList.add('hidden');
                    document.getElementById('udm-content').classList.remove('hidden');
                } else {
                    showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    closeModal('userDetailsModal');
                }

                // Fetch Referrals
                try {
                    const refResp = await fetch(`{{ url_for('user_referrals_json', user_id=0) }}`.replace('/0/', `/${uid}/`), {
                        headers: { 'Accept': 'application/json' }, credentials: 'same-origin'
                    });
                    const refData = await refResp.json();
                    let refs = (refData && refData.ok) ? (refData.items || []) : [];

                    document.getElementById('udm-refs-total').textContent = refs.length;

                    const refsContainer = document.getElementById('udm-referrals-list');
                    const loadMoreBtn = document.getElementById('udm-refs-load-more');
                    const filterSpent = document.getElementById('udm-ref-filter-spent');

                    let renderedCount = 0;
                    const BATCH_SIZE_INITIAL = 4;
                    const BATCH_SIZE_MORE = 10;

                    const getSortedRefs = () => {
                        if (!filterSpent?.checked) return [...refs];
                        return [...refs].sort((a, b) => {
                            const aSpent = (a.total_spent || 0) > 0;
                            const bSpent = (b.total_spent || 0) > 0;
                            if (aSpent !== bSpent) return bSpent ? 1 : -1;
                            return new Date(b.registration_date) - new Date(a.registration_date);
                        });
                    };

                    function renderRefs(count, reset = false) {
                        if (reset) {
                            refsContainer.innerHTML = '';
                            renderedCount = 0;
                        }
                        const sorted = getSortedRefs();
                        const next = sorted.slice(renderedCount, renderedCount + (count || 0));
                        next.forEach(r => {
                            const datePart = (r.registration_date || '').split(' ')[0];
                            // Calculate relative time
                            let relTime = '';
                            try {
                                const d = new Date(r.registration_date);
                                const now = new Date();
                                const diffDays = Math.ceil((now - d) / (1000 * 60 * 60 * 24));
                                if (diffDays < 30) relTime = `(${diffDays} –¥–Ω.)`;
                                else if (diffDays < 365) relTime = `(${Math.round(diffDays / 30)} –º–µ—Å.)`;
                                else relTime = `(${Math.round(diffDays / 365)} –≥.)`;
                            } catch (_) { }

                            const li = document.createElement('li');
                            li.className = 'bg-white/5 border border-white/5 rounded-xl px-3 py-2.5 flex justify-between items-center mb-2 hover:bg-white/10 transition-colors group';

                            li.innerHTML = `
                                <div class="truncate flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary font-bold text-[10px] border border-primary/20">
                                       RF
                                    </div>
                                    <div class="flex flex-col truncate">
                                        <span class="text-white font-bold text-xs tracking-tight group-hover:text-primary transition-colors">@${r.username || '–ë–µ–∑ —é–∑–µ—Ä–Ω–µ–π–º–∞'}</span>
                                        <span class="text-white/40 text-[10px] font-mono">#${r.telegram_id}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-0.5">
                                    <span class="text-white/30 text-[9px] uppercase tracking-wider font-bold">${datePart}</span>
                                    <div class="flex items-center gap-2">
                                         <span class="text-[10px] ${r.total_spent > 0 ? 'text-primary font-bold' : 'text-white/20'} bg-black/20 px-1.5 rounded">${(r.total_spent || 0).toFixed(0)}‚ÇΩ</span>
                                         <a href="{{ url_for('users_page') }}?q=${r.telegram_id}"
                                           class="w-5 h-5 rounded-md bg-white/5 hover:bg-white/20 text-white/30 hover:text-white flex items-center justify-center transition-all"
                                           title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é" target="_blank">
                                            <span class="material-symbols-outlined text-[10px]">arrow_outward</span>
                                        </a>
                                    </div>
                                </div>
                            `;
                            refsContainer.appendChild(li);
                        });
                        renderedCount += next.length;

                        // Toggle load more button
                        if (renderedCount < refs.length) {
                            loadMoreBtn.classList.remove('hidden');
                        } else {
                            loadMoreBtn.classList.add('hidden');
                        }

                        // Update counter
                        const countBadge = document.getElementById('udm-ref-count');
                        if (countBadge) countBadge.textContent = renderedCount;
                    }

                    if (refs.length > 0) {
                        renderRefs(BATCH_SIZE_INITIAL, true);
                    } else {
                        refsContainer.innerHTML = '<div class="py-10 text-center"><div class="text-white/20 text-[10px] font-bold uppercase tracking-widest">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div></div>';
                        loadMoreBtn.classList.add('hidden');
                    }

                    filterSpent?.addEventListener('change', () => {
                        const currentCount = renderedCount;
                        renderRefs(currentCount, true);
                    });

                    // Remove old listener to avoid duplicates if any (simple way: clone node or just reassign onclick)
                    // Better: define handler outside or use a property.
                    loadMoreBtn.onclick = (e) => {
                        e.preventDefault();
                        renderRefs(BATCH_SIZE_MORE);
                    };

                } catch (e) {
                    console.error(e);
                }

            } catch (_) {
                showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                closeModal('userDetailsModal');
            }
        }

        table.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-user-details');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');
            openModal('userDetailsModal');
            await fetchUserDetails(uid);
        });

        // Quick Action Handlers (Delegated)
        document.getElementById('userDetailsModal').addEventListener('click', function (e) {
            const btn = e.target.closest('button[id^="udm-action-"]');
            if (!btn) return;

            const uid = document.getElementById('udm-trial-toggle')?.getAttribute('data-user-id');
            const uname = document.getElementById('udm-username')?.textContent?.replace('@', '') || '';
            const balance = document.getElementById('udm-balance')?.textContent || '0.00';

            if (!uid) return;

            const action = btn.id.replace('udm-action-', '');

            // Re-use Logic from Table Buttons
            if (action === 'add-bal' || action === 'sub-bal') {
                const isAdd = action === 'add-bal';
                document.getElementById('bm-user').textContent = `@${uname} (#${uid})`;
                document.getElementById('bm-balance').textContent = balance;
                document.getElementById('bm-form').action = `{{ url_for('adjust_balance_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
                document.getElementById('bm-refcount').textContent = document.getElementById('udm-ref-count').textContent;
                document.getElementById('bm-reflist').innerHTML = ''; // Simplified, or fetch again

                const deltaInput = document.querySelector('#bm-form input[name="delta"]');
                if (deltaInput) {
                    deltaInput.value = isAdd ? '+' : '-';
                    setTimeout(() => { deltaInput.focus(); deltaInput.setSelectionRange(1, 1); }, 100);
                }
                openModal('balanceModal');
            } else if (action === 'issue') {
                window.location.href = `{{ url_for('admin_keys_page') }}?user_id=${uid}`;
            } else if (action === 'msg') {
                document.getElementById('mm-user').textContent = `@${uname} (#${uid})`;
                document.getElementById('mm-form').action = `{{ url_for('send_user_message_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
                document.querySelector('#mm-form textarea[name="message"]').value = '';
                openModal('messageModal');
            } else if (action === 'ban') {
                banUser(uid, uname);
            } else if (action === 'revoke-all') {
                revokeAllKeys(uid, uname);
            } else if (action === 'pin') {
                apiRequest(`{{ url_for('toggle_pin_user_route', user_id=0) }}`.replace('/0', `/${uid}`), 'POST', {}, '–°—Ç–∞—Ç—É—Å –∑–∞–∫—Ä–µ–ø–∞ –∏–∑–º–µ–Ω–µ–Ω')
                    .then(d => {
                        if (d) {
                            // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–ï–ó –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–π –º–æ–¥–∞–ª–∫–∏
                            const pinBadge = document.getElementById('udm-pinned-badge');
                            const pinText = document.getElementById('udm-action-pin-text');
                            const pinIcon = document.getElementById('udm-action-pin-icon');

                            const isPinnedNow = pinText.textContent === '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';

                            if (pinBadge) {
                                pinBadge.classList.toggle('hidden', !isPinnedNow);
                                pinBadge.style.color = '#22c55e';
                            }
                            if (pinText) pinText.textContent = isPinnedNow ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
                            if (pinIcon) {
                                if (isPinnedNow) {
                                    pinIcon.style.color = '#22c55e';
                                    pinIcon.classList.add('rotate-45');
                                } else {
                                    pinIcon.style.color = '';
                                    pinIcon.classList.remove('rotate-45');
                                }
                            }

                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ —Ñ–æ–Ω–µ
                            const tbody = document.getElementById('users-tbody');
                            if (tbody) {
                                const urlStr = tbody.getAttribute('data-fetch-url');
                                if (urlStr) {
                                    const params = new URLSearchParams(new URL(urlStr, location.origin).search);
                                    updateTableAndPagination(params);
                                }
                            }
                        }
                    });
            }
        });

        document.addEventListener('change', async function (e) {
            if (e.target?.id !== 'udm-trial-toggle') return;
            const toggle = e.target;
            const userId = toggle.getAttribute('data-user-id');
            const label = document.getElementById('udm-trial-label');

            try {
                const resp = await fetch(`{{ url_for('toggle_trial_used_route', user_id=0) }}`.replace('/0/', `/${userId}/`), {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCsrfToken() },
                    credentials: 'same-origin'
                });
                const data = await resp.json();
                if (data && data.ok) {
                    label.textContent = data.trial_used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ' : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ';
                    showToast('success', data.message);
                } else {
                    toggle.checked = !toggle.checked;
                    showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
                }
            } catch (_) {
                toggle.checked = !toggle.checked;
                showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        });

        // ========= Subscription Actions =========
        let currentUserDetailsId = null; // Store user ID to refresh modal after update

        // --- Expiry ---
        let expiryKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-user-edit-expiry');
            if (!btn) return;
            expiryKeyId = btn.getAttribute('data-key-id');
            // Assuming this button is inside the modal, we can get current user ID from somewhere or store it differently
            // But actually we have data-user-id on trial toggle or we can just look at modal content attributes if we added them.
            // For now, let's rely on refreshContainerById NOT working for modal content directly, 
            // instead we should re-fetch user details.
            // Let's store uid in a global var when modal opens.
            currentUserDetailsId = document.getElementById('udm-trial-toggle')?.getAttribute('data-user-id');

            document.getElementById('expiryDelta').value = '';
            openModal('expiryModal');
        });

        document.getElementById('expirySaveBtn')?.addEventListener('click', async () => {
            const delta = document.getElementById('expiryDelta').value;
            if (!expiryKeyId || !delta) { showToast('warning', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π'); return; }
            try {
                const fd = new FormData();
                fd.append('csrf_token', '{{ csrf_token() }}'); // Using template var since JS is in template
                fd.append('delta_days', delta);
                const url = `{{ url_for('adjust_key_expiry_route', key_id=0) }}`.replace('/0/', `/${expiryKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', '–°—Ä–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω');
                    closeModal('expiryModal');
                    // Refresh User Details Modal
                    if (currentUserDetailsId) refreshUserDetails(currentUserDetailsId);
                } else { showToast('danger', '–û—à–∏–±–∫–∞'); }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        // --- Comment ---
        let commentKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-user-edit-comment');
            if (!btn) return;
            commentKeyId = btn.getAttribute('data-key-id');
            currentUserDetailsId = document.getElementById('udm-trial-toggle')?.getAttribute('data-user-id');

            document.getElementById('commentInput').value = btn.getAttribute('data-current-comment') || '';
            openModal('commentModal');
        });

        document.getElementById('commentSaveBtn')?.addEventListener('click', async () => {
            const comment = document.getElementById('commentInput').value;
            if (!commentKeyId) return;
            try {
                const fd = new FormData();
                fd.append('csrf_token', '{{ csrf_token() }}');
                fd.append('comment', comment);
                const url = `{{ url_for('update_key_comment_route', key_id=0) }}`.replace('/0/', `/${commentKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                    closeModal('commentModal');
                    if (currentUserDetailsId) refreshUserDetails(currentUserDetailsId);
                } else { showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        // --- Revoke ---
        let revokeKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-user-revoke-key');
            if (!btn) return;

            revokeKeyId = btn.getAttribute('data-key-id');
            currentUserDetailsId = document.getElementById('udm-trial-toggle')?.getAttribute('data-user-id');
            openModal('revokeConfirmModal');
        });

        document.getElementById('revokeConfirmBtn')?.addEventListener('click', async () => {
            if (!revokeKeyId) return;

            try {
                const fd = new FormData();
                fd.append('csrf_token', '{{ csrf_token() }}');
                const url = `{{ url_for('delete_key_route', key_id=0) }}`.replace('/0/', `/${revokeKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', '–ö–ª—é—á –æ—Ç–æ–∑–≤–∞–Ω');
                    closeModal('revokeConfirmModal');
                    if (currentUserDetailsId) refreshUserDetails(currentUserDetailsId);
                } else { showToast('danger', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        // Helper to refresh modal content
        async function refreshUserDetails(uid) {
            const btn = document.querySelector(`.btn-user-details[data-uid="${uid}"]`);
            if (btn) btn.click();
        }

        restoreOpenedKeys();
    })();

    function copyToClipboard(text, element) {
        navigator.clipboard.writeText(text).then(() => {
            const originalBg = element.className;
            element.classList.add('bg-primary/20');
            showToast('success', '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
            setTimeout(() => {
                element.className = originalBg;
            }, 300);
        }).catch(() => {
            showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        });
    }
</script>
{% endblock %}