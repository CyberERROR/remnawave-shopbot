{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-bold text-white">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
            <p class="text-white/50 text-sm">–°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</p>
        </div>
        <div class="relative w-full md:w-80">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/50">search</span>
            <input id="users-search" type="text" value="{{ q or '' }}"
                class="w-full bg-white/5 border border-white/10 rounded-lg pl-10 pr-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-colors"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ Username..." />
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar for Modal and Lists */
    .custom-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scroll::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background: rgba(19, 236, 128, 0.3);
        border-radius: 3px;
    }

    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(19, 236, 128, 0.5);
    }

    /* Ensure modal content uses custom scroll */
    .modal-content {
        scrollbar-width: thin;
        scrollbar-color: rgba(19, 236, 128, 0.3) rgba(255, 255, 255, 0.05);
    }

    .modal-content::-webkit-scrollbar {
        width: 6px;
    }

    .modal-content::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }

    .modal-content::-webkit-scrollbar-thumb {
        background: rgba(19, 236, 128, 0.3);
        border-radius: 3px;
    }
</style>

<div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table id="users-table" class="w-full text-left">
            <thead class="bg-white/5">
                <tr>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Telegram ID</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Username</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–°—Ç–∞—Ç—É—Å</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70 text-center">
                        –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ë–∞–ª–∞–Ω—Å</th>
                    <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-white/70 text-right">–î–µ–π—Å—Ç–≤–∏—è
                    </th>
                </tr>
            </thead>
            <tbody id="users-tbody" class="divide-y divide-white/10"
                data-fetch-url="{{ url_for('users_table_partial', page=current_page, per_page=per_page, q=q) }}"
                data-fetch-interval="100000">
                {% include 'partials/users_table.html' %}
            </tbody>
        </table>
    </div>
</div>

{% if total_pages and total_pages > 1 %}
<div class="flex justify-center mt-4 gap-2" id="users-pagination"
    data-src="{{ url_for('users_pagination_partial', page=current_page, q=q, per_page=per_page) }}">
    {% include 'partials/users_pagination.html' %}
</div>
{% endif %}

<div id="balanceModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
            <button onclick="closeModal('balanceModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-3 text-white/70" id="bm-user"></div>
            <div class="mb-4 text-white">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <strong id="bm-balance">0.00</strong> RUB</div>
            <form id="bm-form" class="flex gap-3" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input
                    class="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                    type="text" inputmode="decimal" name="delta" placeholder="¬± —Å—É–º–º–∞" required />
                <button
                    class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors"
                    type="submit">
                    –ò–∑–º–µ–Ω–∏—Ç—å
                </button>
            </form>
            <hr class="border-white/10 my-4" />
            <div class="mb-2 text-white">–†–µ—Ñ–µ—Ä–∞–ª—ã: <strong id="bm-refcount">0</strong></div>
            <div class="text-sm text-white/50 max-h-36 overflow-auto">
                <ul id="bm-reflist" class="space-y-1"></ul>
            </div>
        </div>
    </div>
</div>

<div id="messageModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h5>
            <button onclick="closeModal('messageModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-3 text-white/70" id="mm-user"></div>
            <form id="mm-form" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="mb-4">
                    <label class="block text-white/70 text-sm mb-2">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                    <p class="text-white/50 text-sm mb-2">üì© –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</p>
                    <textarea
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        name="message" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..." required></textarea>
                </div>
                <button
                    class="w-full px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors"
                    type="submit">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Key Comment Modal -->
<div id="commentModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∫–ª—é—á—É</h5>
            <button onclick="closeModal('commentModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div id="commentModalLoading" class="hidden text-center py-4">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"></div>
            </div>
            <div id="commentModalContent">
                <input type="text" id="commentInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            </div>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('commentModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">–û—Ç–º–µ–Ω–∞</button>
            <button id="commentSaveBtn"
                class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Key Expiry Modal -->
<div id="expiryModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</h5>
            <button onclick="closeModal('expiryModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <label class="block text-white/70 text-sm mb-2">–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–∏–±–∞–≤–∏—Ç—å/—É–±–∞–≤–∏—Ç—å</label>
            <input type="number" id="expiryDelta" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 7 –∏–ª–∏ -7"
                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            <p class="text-white/50 text-sm mt-2">–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ ‚Äî –ø—Ä–æ–¥–ª–∏—Ç—å, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ ‚Äî —Å–æ–∫—Ä–∞—Ç–∏—Ç—å.</p>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('expiryModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">–û—Ç–º–µ–Ω–∞</button>
            <button id="expirySaveBtn"
                class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Revoke Key Confirmation Modal -->
<div id="revokeConfirmModal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content">
        <div class="p-4 border-b border-red-500/30 flex items-center justify-between bg-red-500/10">
            <h5 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-red-400">warning</span>
                –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
            </h5>
            <button onclick="closeModal('revokeConfirmModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <p class="text-white mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á?</p>
            <p class="text-red-400 text-sm">‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ–¥–ø–∏—Å–∫–µ (–ü–æ–ª–Ω–æ—Å—Ç—å—é)!</p>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('revokeConfirmModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">–û—Ç–º–µ–Ω–∞</button>
            <button id="revokeConfirmBtn"
                class="px-4 py-2 rounded-lg bg-red-500 text-white font-bold hover:bg-red-600">–û—Ç–æ–∑–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<div id="userDetailsModal" class="modal-overlay modal-xl">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
            <button onclick="closeModal('userDetailsModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div id="udm-loading" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
                <p class="text-white/50 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div id="udm-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white/5 border border-white/10 rounded-lg p-4">
                        <h4 class="text-white font-bold mb-4">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                        <table class="w-full text-sm">
                            <tbody class="divide-y divide-white/10">
                                <tr>
                                    <td class="py-2 text-white/70">Telegram ID:</td>
                                    <td class="py-2 text-white" id="udm-telegram-id"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">Username:</td>
                                    <td class="py-2 text-white" id="udm-username"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</td>
                                    <td class="py-2 text-white" id="udm-registration"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ë–∞–ª–∞–Ω—Å:</td>
                                    <td class="py-2 text-white" id="udm-balance"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ:</td>
                                    <td class="py-2 text-white" id="udm-total-spent"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ –º–µ—Å—è—Ü–µ–≤:</td>
                                    <td class="py-2 text-white" id="udm-total-months"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–ü—Ä–æ–±–Ω—ã–π:</td>
                                    <td class="py-2">
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="udm-trial-toggle" data-user-id=""
                                                class="sr-only peer">
                                            <div
                                                class="relative w-11 h-6 bg-white/10 peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                                            </div>
                                            <span class="ml-2 text-white/70 text-sm" id="udm-trial-label"></span>
                                        </label>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="bg-white/5 border border-white/10 rounded-lg p-4">
                        <h4 class="text-white font-bold mb-4">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h4>
                        <table class="w-full text-sm">
                            <tbody class="divide-y divide-white/10">
                                <tr>
                                    <td class="py-2 text-white/70">–†–µ—Ñ. –∫–æ–¥:</td>
                                    <td class="py-2 text-white" id="udm-ref-code"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white/70">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤:</td>
                                    <td class="py-2 text-white" id="udm-ref-count"></td>
                                </tr>
                                <td class="py-2 text-white/70">–ü—Ä–∏–≥–ª–∞—à—ë–Ω:</td>
                                <td class="py-2 text-white" id="udm-referred-by"></td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="pt-4 border-t border-white/10 mt-2">
                                        <div
                                            class="text-white/70 mb-2 text-xs uppercase font-bold flex justify-between items-center">
                                            <span>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ (<span id="udm-refs-total">0</span>)</span>
                                        </div>
                                        <div id="udm-referrals-container"
                                            class="custom-scroll max-h-[140px] overflow-y-auto pr-1">
                                            <ul id="udm-referrals-list" class="space-y-1 text-sm"></ul>
                                        </div>
                                        <button id="udm-refs-load-more"
                                            class="w-full mt-2 py-1 flex items-center justify-center text-primary hover:bg-white/5 rounded transition-colors hidden"
                                            title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ">
                                            <span class="material-symbols-outlined">expand_more</span>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="bg-white/5 border border-white/10 rounded-lg">
                        <div class="p-4 border-b border-white/10">
                            <h4 class="text-white font-bold">–ü–æ–¥–ø–∏—Å–∫–∏ <span id="udm-subs-stats"
                                    class="text-white/50 text-sm font-normal"></span></h4>
                        </div>
                        <div id="udm-subs-list" class="max-h-[450px] overflow-y-auto divide-y divide-white/10"></div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="bg-white/5 border border-white/10 rounded-lg">
                        <div class="p-4 border-b border-white/10">
                            <h4 class="text-white font-bold">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h4>
                        </div>
                        <div class="overflow-x-auto max-h-[300px] overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-[#102219] sticky top-0 z-10">
                                    <tr>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–î–∞—Ç–∞</td>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–¢–∞—Ä–∏—Ñ</td>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–•–æ—Å—Ç</td>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–¢–∏–ø</td>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–°—É–º–º–∞</td>
                                    </tr>
                                </thead>
                                <tbody id="udm-payment-history" class="divide-y divide-white/10"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="bg-white/5 border border-white/10 rounded-lg">
                        <div class="p-4 border-b border-white/10">
                            <h4 class="text-white font-bold">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–∞–ª–∞–Ω—Å–∞</h4>
                        </div>
                        <div class="overflow-x-auto max-h-[300px] overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-[#102219] sticky top-0 z-10">
                                    <tr>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–î–∞—Ç–∞</td>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–¢–∞—Ä–∏—Ñ</td>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–•–æ—Å—Ç</td>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–¢–∏–ø</td>
                                        <td class="px-4 py-2 text-left text-white/70 font-bold">–°—É–º–º–∞</td>
                                    </tr>
                                </thead>
                                <tbody id="udm-balance-history" class="divide-y divide-white/10"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const input = document.getElementById('users-search');
        const table = document.getElementById('users-table');
        const tbody = document.getElementById('users-tbody');
        if (!input || !table || !tbody) return;

        const LS_KEY = 'users_open_keys_ids';
        function loadOpenSet() {
            try {
                const raw = localStorage.getItem(LS_KEY);
                return new Set(raw ? JSON.parse(raw) : []);
            } catch (_) { return new Set(); }
        }
        function saveOpenSet(set) {
            try { localStorage.setItem(LS_KEY, JSON.stringify(Array.from(set))); } catch (_) { }
        }
        const openSet = loadOpenSet();

        function getRows() {
            return Array.from(tbody.children).filter(tr => tr.tagName === 'TR' && !tr.classList.contains('keys-row'));
        }

        function getKeysRowByUid(uid) { return document.getElementById('keys-' + uid); }

        async function ensureKeysLoaded(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            const body = row.querySelector('[data-lazy="keys"]');
            if (!body || body.getAttribute('data-loaded') === '1') return;
            const src = row.getAttribute('data-src');
            if (!src) return;
            try {
                const resp = await fetch(src, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                if (resp.ok) {
                    body.innerHTML = await resp.text();
                    body.setAttribute('data-loaded', '1');
                }
            } catch (_) { }
        }

        function openKeysForUid(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            row.classList.remove('hidden');
            openSet.add(String(uid));
            saveOpenSet(openSet);
        }

        function closeKeysForUid(uid) {
            const row = getKeysRowByUid(uid);
            if (!row) return;
            row.classList.add('hidden');
            openSet.delete(String(uid));
            saveOpenSet(openSet);
        }

        function restoreOpenedKeys() {
            openSet.forEach(uid => {
                const row = getKeysRowByUid(uid);
                if (row) row.classList.remove('hidden');
            });
        }

        function applyFilter() {
            const q = (input.value || '').toLowerCase().trim();
            getRows().forEach(tr => {
                const id = (tr.querySelector('.user-id')?.textContent || '').toLowerCase();
                const name = (tr.querySelector('.user-name')?.textContent || '').toLowerCase();
                tr.classList.toggle('hidden', q && !id.includes(q) && !name.includes(q));
            });
        }

        input.addEventListener('input', applyFilter);
        input.addEventListener('search', applyFilter);

        let searchTimeout = null;
        input.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const url = new URL(tbody.getAttribute('data-fetch-url'), location.origin);
                url.searchParams.set('q', input.value || '');
                url.searchParams.set('page', '1');
                try {
                    const resp = await fetch(url, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                    if (resp.ok) {
                        tbody.innerHTML = await resp.text();
                        restoreOpenedKeys();
                        applyFilter();
                    }
                } catch (_) { }
            }, 400);
        });

        table.addEventListener('click', function (e) {
            const btn = e.target.closest('[data-toggle="keys"]');
            if (!btn) return;
            const uid = btn.getAttribute('data-user');
            const row = getKeysRowByUid(uid);
            if (!row) return;
            if (row.classList.contains('hidden')) {
                openKeysForUid(uid);
                ensureKeysLoaded(uid);
            } else {
                closeKeysForUid(uid);
            }
        });

        table.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-user-balance-sign');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');
            const uname = btn.getAttribute('data-username') || 'N/A';
            const balance = btn.getAttribute('data-balance') || '0.00';
            const sign = btn.getAttribute('data-sign') || '';

            let refs = [];
            try {
                const resp = await fetch(`{{ url_for('user_referrals_json', user_id=0) }}`.replace('/0/', `/${uid}/`), { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
                const data = await resp.json();
                refs = (data && data.ok) ? (data.items || []) : [];
            } catch (_) { }

            document.getElementById('bm-user').textContent = `@${uname} (#${uid})`;
            document.getElementById('bm-balance').textContent = balance;
            document.getElementById('bm-form').action = `{{ url_for('adjust_balance_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
            document.getElementById('bm-refcount').textContent = refs.length;
            document.getElementById('bm-reflist').innerHTML = refs.map(r => `<li>#${r.telegram_id} ‚Äî @${r.username || 'N/A'} ¬∑ ${r.registration_date}</li>`).join('');

            const deltaInput = document.querySelector('#bm-form input[name="delta"]');
            if (deltaInput) {
                deltaInput.value = sign;
                setTimeout(() => { deltaInput.focus(); deltaInput.setSelectionRange(1, 1); }, 100);
            }
            openModal('balanceModal');
        });

        document.getElementById('bm-form')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = this;
            try {
                const fd = new FormData(form);
                const resp = await fetch(form.action, {
                    method: 'POST', body: fd,
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                });
                const data = await resp.json().catch(() => null);
                if (resp.ok && data && data.ok) {
                    showToast('success', data.message || '–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—ë–Ω');
                    closeModal('balanceModal');
                    refreshContainerById('users-tbody');
                } else {
                    showToast('danger', (data && data.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å');
                }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        table.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-user-message');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');
            const uname = btn.getAttribute('data-username') || 'N/A';
            document.getElementById('mm-user').textContent = `@${uname} (#${uid})`;
            document.getElementById('mm-form').action = `{{ url_for('send_user_message_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
            document.querySelector('#mm-form textarea[name="message"]').value = '';
            openModal('messageModal');
        });

        document.getElementById('mm-form')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = this;
            try {
                const fd = new FormData(form);
                const resp = await fetch(form.action, {
                    method: 'POST', body: fd,
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                });
                const data = await resp.json().catch(() => null);
                if (resp.ok && data && data.ok) {
                    showToast('success', data.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                    closeModal('messageModal');
                } else {
                    showToast('danger', (data && data.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        table.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-user-details');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');

            document.getElementById('udm-loading').classList.remove('hidden');
            document.getElementById('udm-content').classList.add('hidden');
            openModal('userDetailsModal');

            try {
                const resp = await fetch(`{{ url_for('user_details_json', user_id=0) }}`.replace('/0/', `/${uid}/`), {
                    headers: { 'Accept': 'application/json' }, credentials: 'same-origin'
                });
                const data = await resp.json();

                if (data && data.ok) {
                    document.getElementById('udm-telegram-id').textContent = data.user.telegram_id || 'N/A';
                    document.getElementById('udm-username').textContent = '@' + (data.user.username || 'N/A');
                    document.getElementById('udm-registration').textContent = data.user.registration_date || 'N/A';
                    document.getElementById('udm-total-spent').textContent = (data.user.total_spent || 0).toFixed(2) + ' RUB';
                    document.getElementById('udm-total-months').textContent = (data.user.total_months || 0) + ' –º–µ—Å.';

                    const trialToggle = document.getElementById('udm-trial-toggle');
                    const trialLabel = document.getElementById('udm-trial-label');
                    trialToggle.checked = data.user.trial_used || false;
                    trialToggle.setAttribute('data-user-id', uid);
                    trialLabel.textContent = data.user.trial_used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ' : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ';

                    document.getElementById('udm-ref-code').textContent = data.user.referral_code || 'N/A';
                    document.getElementById('udm-ref-count').textContent = data.user.referral_count || '0';
                    document.getElementById('udm-referred-by').textContent = data.user.referred_by?.username ?
                        `@${data.user.referred_by.username} (#${data.user.referred_by.telegram_id})` : '–ù–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω';
                    document.getElementById('udm-balance').textContent = (data.user.balance || 0).toFixed(2) + ' RUB';

                    const subsStats = document.getElementById('udm-subs-stats');
                    const subsList = document.getElementById('udm-subs-list');
                    subsStats.textContent = data.subs_stats ?
                        `(–í—Å–µ–≥–æ: ${data.subs_stats.total}, –ê–∫—Ç–∏–≤–Ω–æ: ${data.subs_stats.active}, –ò—Å—Ç–µ–∫–ª–æ: ${data.subs_stats.expired})` : '';
                    subsList.innerHTML = data.subscriptions?.length ? data.subscriptions.map(sub => {
                        // Duration Helper
                        function formatDuration(dateStr) {
                            if (!dateStr || sub.is_expired) return '';
                            const d = new Date(dateStr);
                            const now = new Date();
                            const diffDays = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
                            if (diffDays <= 0) return '';
                            if (diffDays > 30) {
                                const months = Math.round(diffDays / 30);
                                return `(${months} –º–µ—Å.)`;
                            }
                            return '';
                        }
                        const durationText = formatDuration(sub.expire_date);

                        return `
                    <div class="p-2 relative bg-white/3 mb-4 border border-white/5 last:mb-0 shadow-lg shadow-black/20">
                        <div class="flex items-center gap-2 mb-2 flex-wrap justify-between">
                            <div class="flex items-center gap-2">
                                <span class="${sub.is_expired ? 'text-red-400' : 'text-primary'} font-bold text-sm">${sub.status_text}</span>
                                ${durationText ? `<span class="text-white/50 text-sm">${durationText}</span>` : ''}
                                <span class="text-white/50 text-xs">–¥–æ: ${sub.expire_date}</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-white/50 font-medium">
                                ${sub.comment ? `<span class="italic max-w-[150px] truncate" title="${sub.comment.replace(/"/g, '&quot;')}">${sub.comment}</span>` : ''}
                                <div class="bg-white/5 px-2 py-0.5 rounded">${sub.host_name}</div>
                            </div>
                        </div>
                        <div class="bg-white/5 rounded p-2 font-mono text-sm text-primary break-all mb-2 pr-2 relative flex items-center gap-2">
                            <span class="flex-1">${sub.key}</span>
                            <button onclick="copyToClipboard('${sub.key}', this)" 
                                    class="flex-shrink-0 w-7 h-7 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-white flex items-center justify-center transition-colors"
                                    title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
                                <span class="material-symbols-outlined text-sm">content_copy</span>
                            </button>
                            <button onclick="window.open('${sub.key}', '_blank')" 
                                    class="flex-shrink-0 w-7 h-7 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-white flex items-center justify-center transition-colors"
                                    title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É">
                                <span class="material-symbols-outlined text-sm">open_in_new</span>
                            </button>
                        </div>

                        <!-- Actions Row -->
                        <div class="flex items-center gap-2 justify-between flex-wrap mt-2">
                             <!-- Left: Email & UUID -->
                             <div class="flex items-center gap-2 flex-wrap">
                                <div class="bg-white/5 rounded px-2 py-1 text-xs text-white/70 cursor-pointer hover:bg-white/10 transition-colors flex items-center gap-1" 
                                     onclick="copyToClipboard('${sub.email}', this)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è">
                                    <span class="material-symbols-outlined text-[10px] opacity-50">content_copy</span>
                                    <span class="text-white/50">Email:</span> ${sub.email}
                                </div>
                                <div class="bg-white/5 rounded px-2 py-1 text-xs text-white/70 cursor-pointer hover:bg-white/10 transition-colors flex items-center gap-1" 
                                     onclick="copyToClipboard('${sub.remnawave_user_uuid}', this)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è">
                                    <span class="material-symbols-outlined text-[10px] opacity-50">content_copy</span>
                                    <span class="text-white/50">UUID:</span> ${sub.remnawave_user_uuid}
                                </div>
                             </div>

                             <!-- Right: Buttons -->
                             <div class="flex items-center gap-2 flex-shrink-0">
                                  <button class="btn-user-edit-expiry w-8 h-8 flex items-center justify-center rounded-lg bg-yellow-500/10 text-yellow-400 hover:bg-yellow-500/20 transition-colors"
                                          data-key-id="${sub.key_id}" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫">
                                      <span class="material-symbols-outlined text-sm">schedule</span>
                                  </button>
                                  
                                  <button class="btn-user-edit-comment w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 text-white/70 hover:bg-white/10 hover:text-white transition-colors"
                                          data-key-id="${sub.key_id}" data-current-comment="${(sub.comment || '').replace(/"/g, '&quot;')}" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                                      <span class="material-symbols-outlined text-sm">comment</span>
                                  </button>

                                  <button class="btn-user-revoke-key w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-colors"
                                          data-key-id="${sub.key_id}" title="–û—Ç–æ–∑–≤–∞—Ç—å">
                                      <span class="material-symbols-outlined text-sm">delete</span>
                                  </button>
                             </div>
                        </div>
                    </div>
                `}).join('') : '<div class="p-4 text-center text-white/50">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</div>';

                    function formatWithRelative(dateStr) {
                        if (!dateStr) return 'N/A';
                        try {
                            const d = new Date(dateStr);
                            const now = new Date();
                            const diffMs = now - d;
                            const diffMins = Math.floor(diffMs / 60000);
                            const diffHours = Math.floor(diffMs / 3600000);
                            const diffDays = Math.floor(diffMs / 86400000);

                            let rel = '';
                            if (diffMins < 60) rel = `(${diffMins}–º–∏–Ω)`;
                            else if (diffHours < 24) rel = `(${diffHours}—á)`;
                            else if (diffDays < 30) rel = `(${diffDays}–¥)`;
                            else if (diffDays < 365) rel = `(${Math.round(diffDays / 30)}–º–µ—Å)`;
                            else rel = `(${Math.round(diffDays / 365)}–≥)`;

                            // Format YYYY-MM-DD HH:MM:SS
                            const Y = d.getFullYear();
                            const M = String(d.getMonth() + 1).padStart(2, '0');
                            const D = String(d.getDate()).padStart(2, '0');
                            const h = String(d.getHours()).padStart(2, '0');
                            const m = String(d.getMinutes()).padStart(2, '0');
                            const s = String(d.getSeconds()).padStart(2, '0');

                            return `${Y}-${M}-${D} ${h}:${m}:${s} <span class="text-white/50 text-xs">${rel}</span>`;
                        } catch (e) {
                            return dateStr;
                        }
                    }

                    const paymentHistory = document.getElementById('udm-payment-history');
                    paymentHistory.innerHTML = data.payment_history?.length ? data.payment_history.map(p => `
                    <tr>
                        <td class="px-4 py-2 text-white whitespace-nowrap">${formatWithRelative(p.date)}</td>
                        <td class="px-4 py-2 text-white">${p.plan || 'N/A'}</td>
                        <td class="px-4 py-2 text-white">${p.host || 'N/A'}</td>
                        <td class="px-4 py-2 text-white">${p.type || 'N/A'}</td>
                        <td class="px-4 py-2 text-white">${(p.amount || 0).toFixed(2)} RUB</td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="px-4 py-4 text-center text-white/50">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';

                    const balanceHistory = document.getElementById('udm-balance-history');
                    balanceHistory.innerHTML = data.balance_history?.length ? data.balance_history.map(t => `
                    <tr>
                        <td class="px-4 py-2 text-white whitespace-nowrap">${formatWithRelative(t.date)}</td>
                        <td class="px-4 py-2 text-white">${t.plan || '‚Äî'}</td>
                        <td class="px-4 py-2 text-white">${t.host || '‚Äî'}</td>
                        <td class="px-4 py-2 text-white">${t.type || 'N/A'}</td>
                        <td class="px-4 py-2 text-white">${(t.amount || 0).toFixed(2)} RUB</td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="px-4 py-4 text-center text-white/50">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';

                    document.getElementById('udm-loading').classList.add('hidden');
                    document.getElementById('udm-content').classList.remove('hidden');
                } else {
                    showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    closeModal('userDetailsModal');
                }

                // Fetch Referrals
                try {
                    const refResp = await fetch(`{{ url_for('user_referrals_json', user_id=0) }}`.replace('/0/', `/${uid}/`), {
                        headers: { 'Accept': 'application/json' }, credentials: 'same-origin'
                    });
                    const refData = await refResp.json();
                    const refs = (refData && refData.ok) ? (refData.items || []) : [];

                    document.getElementById('udm-refs-total').textContent = refs.length;

                    const refsContainer = document.getElementById('udm-referrals-list');
                    const loadMoreBtn = document.getElementById('udm-refs-load-more');
                    refsContainer.innerHTML = '';

                    let renderedCount = 0;
                    const BATCH_SIZE_INITIAL = 3;
                    const BATCH_SIZE_MORE = 10;

                    function renderRefs(count) {
                        const next = refs.slice(renderedCount, renderedCount + count);
                        next.forEach(r => {
                            const datePart = r.registration_date.split(' ')[0];
                            // Calculate relative time
                            let relTime = '';
                            try {
                                const d = new Date(r.registration_date);
                                const now = new Date();
                                const diffDays = Math.ceil((now - d) / (1000 * 60 * 60 * 24));
                                if (diffDays < 30) relTime = `(${diffDays} –¥–Ω.)`;
                                else if (diffDays < 365) relTime = `(${Math.round(diffDays / 30)} –º–µ—Å.)`;
                                else relTime = `(${Math.round(diffDays / 365)} –≥.)`;
                            } catch (_) { }

                            const li = document.createElement('li');
                            li.className = 'bg-white/5 rounded px-2 py-1.5 flex justify-between items-center';

                            li.innerHTML = `
                                <div class="truncate flex items-center gap-2">
                                    <div class="flex flex-col truncate">
                                        <span class="text-white font-mono text-xs">#${r.telegram_id}</span>
                                        <span class="text-white/70 truncate">@${r.username || 'N/A'}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-white/30 text-xs whitespace-nowrap text-right min-w-[80px]">
                                        ${datePart}<br>
                                        <span class="text-white/20">${relTime}</span>
                                    </span>
                                    <a href="{{ url_for('users_page') }}?q=${r.telegram_id}"
                                       class="flex-shrink-0 w-7 h-7 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-white flex items-center justify-center transition-colors"
                                       title="–ü—Ä–æ—Ñ–∏–ª—å" target="_blank">
                                        <span class="material-symbols-outlined text-sm">person</span>
                                    </a>
                                </div>
                            `;
                            refsContainer.appendChild(li);
                        });
                        renderedCount += next.length;

                        // Toggle load more button
                        if (renderedCount < refs.length) {
                            loadMoreBtn.classList.remove('hidden');
                        } else {
                            loadMoreBtn.classList.add('hidden');
                        }
                    }

                    renderRefs(BATCH_SIZE_INITIAL);

                    // Remove old listener to avoid duplicates if any (simple way: clone node or just reassign onclick)
                    // Better: define handler outside or use a property.
                    loadMoreBtn.onclick = (e) => {
                        e.preventDefault();
                        renderRefs(BATCH_SIZE_MORE);
                    };

                } catch (e) {
                    console.error(e);
                }

            } catch (_) {
                showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                closeModal('userDetailsModal');
            }
        });

        document.addEventListener('change', async function (e) {
            if (e.target?.id !== 'udm-trial-toggle') return;
            const toggle = e.target;
            const userId = toggle.getAttribute('data-user-id');
            const label = document.getElementById('udm-trial-label');

            try {
                const resp = await fetch(`{{ url_for('toggle_trial_used_route', user_id=0) }}`.replace('/0/', `/${userId}/`), {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCsrfToken() },
                    credentials: 'same-origin'
                });
                const data = await resp.json();
                if (data && data.ok) {
                    label.textContent = data.trial_used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ' : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ';
                    showToast('success', data.message);
                } else {
                    toggle.checked = !toggle.checked;
                    showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
                }
            } catch (_) {
                toggle.checked = !toggle.checked;
                showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        });

        // ========= Subscription Actions =========
        let currentUserDetailsId = null; // Store user ID to refresh modal after update

        // --- Expiry ---
        let expiryKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-user-edit-expiry');
            if (!btn) return;
            expiryKeyId = btn.getAttribute('data-key-id');
            // Assuming this button is inside the modal, we can get current user ID from somewhere or store it differently
            // But actually we have data-user-id on trial toggle or we can just look at modal content attributes if we added them.
            // For now, let's rely on refreshContainerById NOT working for modal content directly, 
            // instead we should re-fetch user details.
            // Let's store uid in a global var when modal opens.
            currentUserDetailsId = document.getElementById('udm-trial-toggle')?.getAttribute('data-user-id');

            document.getElementById('expiryDelta').value = '';
            openModal('expiryModal');
        });

        document.getElementById('expirySaveBtn')?.addEventListener('click', async () => {
            const delta = document.getElementById('expiryDelta').value;
            if (!expiryKeyId || !delta) { showToast('warning', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π'); return; }
            try {
                const fd = new FormData();
                fd.append('csrf_token', '{{ csrf_token() }}'); // Using template var since JS is in template
                fd.append('delta_days', delta);
                const url = `{{ url_for('adjust_key_expiry_route', key_id=0) }}`.replace('/0/', `/${expiryKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', '–°—Ä–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω');
                    closeModal('expiryModal');
                    // Refresh User Details Modal
                    if (currentUserDetailsId) refreshUserDetails(currentUserDetailsId);
                } else { showToast('danger', '–û—à–∏–±–∫–∞'); }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        // --- Comment ---
        let commentKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-user-edit-comment');
            if (!btn) return;
            commentKeyId = btn.getAttribute('data-key-id');
            currentUserDetailsId = document.getElementById('udm-trial-toggle')?.getAttribute('data-user-id');

            document.getElementById('commentInput').value = btn.getAttribute('data-current-comment') || '';
            openModal('commentModal');
        });

        document.getElementById('commentSaveBtn')?.addEventListener('click', async () => {
            const comment = document.getElementById('commentInput').value;
            if (!commentKeyId) return;
            try {
                const fd = new FormData();
                fd.append('csrf_token', '{{ csrf_token() }}');
                fd.append('comment', comment);
                const url = `{{ url_for('update_key_comment_route', key_id=0) }}`.replace('/0/', `/${commentKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                    closeModal('commentModal');
                    if (currentUserDetailsId) refreshUserDetails(currentUserDetailsId);
                } else { showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        // --- Revoke ---
        let revokeKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-user-revoke-key');
            if (!btn) return;

            revokeKeyId = btn.getAttribute('data-key-id');
            currentUserDetailsId = document.getElementById('udm-trial-toggle')?.getAttribute('data-user-id');
            openModal('revokeConfirmModal');
        });

        document.getElementById('revokeConfirmBtn')?.addEventListener('click', async () => {
            if (!revokeKeyId) return;

            try {
                const fd = new FormData();
                fd.append('csrf_token', '{{ csrf_token() }}');
                const url = `{{ url_for('delete_key_route', key_id=0) }}`.replace('/0/', `/${revokeKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', '–ö–ª—é—á –æ—Ç–æ–∑–≤–∞–Ω');
                    closeModal('revokeConfirmModal');
                    if (currentUserDetailsId) refreshUserDetails(currentUserDetailsId);
                } else { showToast('danger', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
            } catch (_) { showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        });

        // Helper to refresh modal content
        async function refreshUserDetails(uid) {
            const btn = document.querySelector(`.btn-user-details[data-uid="${uid}"]`);
            if (btn) btn.click();
        }

        restoreOpenedKeys();
    })();

    function copyToClipboard(text, element) {
        navigator.clipboard.writeText(text).then(() => {
            const originalBg = element.className;
            element.classList.add('bg-primary/20');
            showToast('success', '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
            setTimeout(() => {
                element.className = originalBg;
            }, 300);
        }).catch(() => {
            showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        });
    }
</script>
{% endblock %}