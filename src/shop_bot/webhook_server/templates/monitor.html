{% extends "base.html" %}
{% block title %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-2xl font-bold text-white">üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</h2>
        <p class="text-white/50 text-sm">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
    </div>
    <div class="flex items-center gap-2">
        <button type="button" id="clear-metrics"
            class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400 font-medium hover:bg-red-500/30 flex items-center gap-2 group"
            title="–ë–ï–ó–û–ü–ê–°–ù–û: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–º–µ—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤. –≠—Ç–æ –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü—Ä–æ—Å—Ç–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ –≤ –ë–î, —É–¥–∞–ª—è—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.">
            <span class="material-symbols-outlined text-base">delete_sweep</span>
            <span class="hidden sm:inline">–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏</span>
        </button>
        <button type="button" id="refresh-all"
            class="px-4 py-2 rounded-lg bg-primary/20 text-primary font-medium hover:bg-primary/30 flex items-center gap-2">
            <span class="material-symbols-outlined text-base">refresh</span>
            –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white/5 border border-white/10 rounded-lg p-4 text-center">
        <div class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center mx-auto mb-2">
            <span class="material-symbols-outlined text-2xl text-primary">memory</span>
        </div>
        <div class="text-2xl font-bold text-white" id="cpu-stat">‚Äî</div>
        <div class="text-white/50 text-sm">–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä</div>
        <div class="text-white/30 text-xs mt-1" id="cpu-trend"></div>
    </div>
    <div class="bg-white/5 border border-white/10 rounded-lg p-4 text-center">
        <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center mx-auto mb-2">
            <span class="material-symbols-outlined text-2xl text-green-400">storage</span>
        </div>
        <div class="text-2xl font-bold text-white" id="memory-stat">‚Äî</div>
        <div class="text-white/50 text-sm">–ü–∞–º—è—Ç—å</div>
        <div class="text-white/30 text-xs mt-1" id="memory-trend"></div>
    </div>
    <div class="bg-white/5 border border-white/10 rounded-lg p-4 text-center">
        <div class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center mx-auto mb-2">
            <span class="material-symbols-outlined text-2xl text-yellow-400">hard_drive</span>
        </div>
        <div class="text-2xl font-bold text-white" id="disk-stat">‚Äî</div>
        <div class="text-white/50 text-sm">–î–∏—Å–∫</div>
        <div class="text-white/30 text-xs mt-1" id="disk-trend"></div>
    </div>
    <div class="bg-white/5 border border-white/10 rounded-lg p-4 text-center">
        <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center mx-auto mb-2">
            <span class="material-symbols-outlined text-2xl text-blue-400">lan</span>
        </div>
        <div class="text-2xl font-bold text-white" id="network-stat">‚Äî</div>
        <div class="text-white/50 text-sm">–°–µ—Ç—å</div>
        <div class="text-white/30 text-xs mt-1" id="network-trend"></div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Main Chart -->
    <div class="lg:col-span-2 bg-white/5 border border-white/10 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-bold">–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
            <div class="flex gap-2">
                <button class="period-btn px-3 py-1 rounded bg-primary/20 text-primary text-sm"
                    data-period="1">1—á</button>
                <button class="period-btn px-3 py-1 rounded bg-white/10 text-white/70 text-sm"
                    data-period="6">6—á</button>
                <button class="period-btn px-3 py-1 rounded bg-white/10 text-white/70 text-sm"
                    data-period="24">24—á</button>
            </div>
        </div>
        <div class="h-72"><canvas id="main-chart"></canvas></div>
    </div>
    <!-- Local Server Info -->
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h3 class="text-white font-bold mb-4">–¢–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä</h3>
        <div id="local-metrics" class="space-y-3 text-sm text-white/70">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        <div class="h-32 mt-4"><canvas id="local-mini-chart"></canvas></div>
    </div>
</div>

<!-- Servers & SSH Targets Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- –°–µ—Ä–≤–µ—Ä—ã (xui_hosts) -->
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-400">dns</span>
                –°–µ—Ä–≤–µ—Ä—ã (Remna_hosts)
            </h3>
            <span class="px-2 py-1 rounded-full bg-primary/20 text-primary text-xs font-medium" id="hosts-count">{{
                hosts|length }}</span>
        </div>
        <div class="space-y-3">
            {% if hosts %}
            {% for h in hosts %}
            <div class="bg-white/5 rounded-lg p-3 border border-white/10" data-host="{{ h.host_name }}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-white/30" id="host-status-{{ loop.index }}"></div>
                        <div>
                            <div class="text-white font-medium text-sm">{{ h.host_name }}</div>
                            <div class="text-white/40 text-xs">{{ h.host_url or 'URL –Ω–µ —É–∫–∞–∑–∞–Ω' }}</div>
                        </div>
                    </div>
                    <button class="host-refresh-btn p-2 rounded bg-white/10 hover:bg-white/20 text-white/70"
                        data-host="{{ h.host_name }}" data-target="#host-metrics-{{ loop.index }}">
                        <span class="material-symbols-outlined text-sm">refresh</span>
                    </button>
                </div>
                <div class="server-metrics text-sm text-white/60" id="host-metrics-{{ loop.index }}">
                    <div class="flex items-center gap-2 text-white/40">
                        <span class="material-symbols-outlined text-sm animate-spin">progress_activity</span>
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-8 text-white/40">
                <span class="material-symbols-outlined text-4xl mb-2">dns</span>
                <p>–•–æ—Å—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- SSH-—Ü–µ–ª–∏ -->
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-yellow-400">terminal</span>
                SSH-—Ü–µ–ª–∏
            </h3>
            <span class="px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400 text-xs font-medium"
                id="targets-count">{{ ssh_targets|length }}</span>
        </div>
        <div class="space-y-3">
            {% if ssh_targets %}
            {% for t in ssh_targets %}
            <div class="bg-white/5 rounded-lg p-3 border border-white/10" data-target="{{ t.target_name }}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-white/30" id="target-status-{{ loop.index }}"></div>
                        <div>
                            <div class="text-white font-medium text-sm">{{ t.target_name }}</div>
                            <div class="text-white/40 text-xs">{{ t.ssh_host }}:{{ t.ssh_port or 22 }}</div>
                        </div>
                    </div>
                    <button class="target-refresh-btn p-2 rounded bg-white/10 hover:bg-white/20 text-white/70"
                        data-target-name="{{ t.target_name }}" data-target="#target-metrics-{{ loop.index }}">
                        <span class="material-symbols-outlined text-sm">refresh</span>
                    </button>
                </div>
                <div class="server-metrics text-sm text-white/60" id="target-metrics-{{ loop.index }}">
                    <div class="flex items-center gap-2 text-white/40">
                        <span class="material-symbols-outlined text-sm animate-spin">progress_activity</span>
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-8 text-white/40">
                <span class="material-symbols-outlined text-4xl mb-2">terminal</span>
                <p>SSH-—Ü–µ–ª–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
    (function () {
        let mainChart = null;
        let localMiniChart = null;
        let autoRefreshInterval = null;
        let currentPeriod = 1;
        let lastNetworkData = null;
        let lastNetworkTime = null;
        const NETWORK_DATA_KEY = 'monitor_network_data';
        const NETWORK_TIME_KEY = 'monitor_network_time';

        async function fetchJSON(url) {
            try {
                const resp = await fetch(url, { credentials: 'same-origin' });
                return await resp.json();
            } catch (e) { return { ok: false, error: String(e) }; }
        }

        function fmtBytes(n) {
            if (n == null) return '‚Äî';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0, x = Number(n);
            while (x >= 1024 && i < units.length - 1) { x /= 1024; i++; }
            return x.toFixed(1) + ' ' + units[i];
        }

        function fmtPct(x) { return (x == null) ? '‚Äî' : (Number(x).toFixed(1) + '%'); }

        function secsToDHMS(s) {
            if (!s && s !== 0) return '‚Äî';
            s = Number(s);
            const d = Math.floor(s / 86400); s %= 86400;
            const h = Math.floor(s / 3600); s %= 3600;
            const m = Math.floor(s / 60);
            const sec = s % 60;
            const parts = [];
            if (d) parts.push(d + '–¥');
            if (h) parts.push(h + '—á');
            if (m) parts.push(m + '–º');
            if (sec && parts.length === 0) parts.push(sec + '—Å');
            return parts.join(' ') || '< 1–º';
        }

        function getStatusColor(value, thresholds = { warning: 70, critical: 90 }) {
            if (value == null) return 'text-white/50';
            if (value >= thresholds.critical) return 'text-red-400';
            if (value >= thresholds.warning) return 'text-yellow-400';
            return 'text-primary';
        }

        function calculateNetworkSpeed(currentData, sourceId = 'default') {
            const now = Date.now();
            const dataKey = `${NETWORK_DATA_KEY}_${sourceId}`;
            const timeKey = `${NETWORK_TIME_KEY}_${sourceId}`;
            try {
                const savedData = localStorage.getItem(dataKey);
                const savedTime = localStorage.getItem(timeKey);
                if (savedData && savedTime) {
                    lastNetworkData = JSON.parse(savedData);
                    lastNetworkTime = parseInt(savedTime);
                }
            } catch (e) { }
            if (!lastNetworkData || !lastNetworkTime) {
                lastNetworkData = currentData;
                lastNetworkTime = now;
                try {
                    localStorage.setItem(dataKey, JSON.stringify(currentData));
                    localStorage.setItem(timeKey, now.toString());
                } catch (e) { }
                return { upSpeed: 0, downSpeed: 0, totalSpeed: 0 };
            }
            const timeDiff = (now - lastNetworkTime) / 1000;
            if (timeDiff < 1) return { upSpeed: 0, downSpeed: 0, totalSpeed: 0 };
            const bytesUpDiff = (currentData.bytes_sent || 0) - (lastNetworkData.bytes_sent || 0);
            const bytesDownDiff = (currentData.bytes_recv || 0) - (lastNetworkData.bytes_recv || 0);
            const upSpeed = Math.max(0, bytesUpDiff / timeDiff);
            const downSpeed = Math.max(0, bytesDownDiff / timeDiff);
            lastNetworkData = currentData;
            lastNetworkTime = now;
            try {
                localStorage.setItem(dataKey, JSON.stringify(currentData));
                localStorage.setItem(timeKey, now.toString());
            } catch (e) { }
            return { upSpeed, downSpeed, totalSpeed: upSpeed + downSpeed };
        }

        function updateStatsCards(data) {
            if (!data || !data.ok) return;
            const isRemote = data.uname !== undefined;
            let cpu, mem, disk, net;
            if (isRemote) {
                cpu = { percent: data.cpu_percent || 0, count_logical: data.cpu_count || '‚Äî' };
                mem = { percent: data.memory_percent || 0, used: (data.memory_used_mb || 0) * 1024 * 1024, total: (data.memory_total_mb || 0) * 1024 * 1024 };
                disk = { percent: data.disk_percent || 0, mountpoint: data.disk_mountpoint || '/' };
                net = { bytes_sent: data.network_sent || 0, bytes_recv: data.network_recv || 0 };
            } else {
                cpu = data.cpu || {};
                mem = data.memory || {};
                const diskPercent = data.disk_percent !== undefined ? data.disk_percent : (data.disks?.[0]?.percent || 0);
                disk = { percent: diskPercent, mountpoint: data.disks?.[0]?.mountpoint || '/' };
                net = data.net || {};
            }
            const networkSpeed = calculateNetworkSpeed(net, 'stats_cards');
            document.getElementById('cpu-stat').innerHTML = `<span class="${getStatusColor(cpu.percent)}">${fmtPct(cpu.percent)}</span>`;
            document.getElementById('cpu-trend').textContent = `${cpu.count_logical || '‚Äî'} —è–¥–µ—Ä`;
            document.getElementById('memory-stat').innerHTML = `<span class="${getStatusColor(mem.percent)}">${fmtPct(mem.percent)}</span>`;
            document.getElementById('memory-trend').textContent = `${fmtBytes(mem.used || 0)} / ${fmtBytes(mem.total || 0)}`;
            document.getElementById('disk-stat').innerHTML = `<span class="${getStatusColor(disk.percent)}">${fmtPct(disk.percent)}</span>`;
            document.getElementById('disk-trend').textContent = disk.mountpoint || '/';
            const speedTotal = fmtBytes(networkSpeed.totalSpeed) + '/—Å';
            const speedUp = fmtBytes(networkSpeed.upSpeed) + '/—Å';
            const speedDown = fmtBytes(networkSpeed.downSpeed) + '/—Å';
            document.getElementById('network-stat').innerHTML = `<span class="text-blue-400">${speedTotal}</span>`;
            document.getElementById('network-trend').innerHTML = `‚Üë${speedUp} ‚Üì${speedDown}`;
        }

        function renderLocal(el, data) {
            if (!data || !data.ok) {
                el.innerHTML = `<div class="text-red-400">–û—à–∏–±–∫–∞: ${data?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'}</div>`;
                return;
            }
            const cpu = data.cpu || {};
            const mem = data.memory || {};
            const sw = data.swap || {};
            const net = data.net || {};
            const networkSpeed = calculateNetworkSpeed(net, 'local_details');
            const disks = (data.disks || []).map(d => `
            <div class="flex items-center justify-between py-1">
                <span class="text-white/50 text-xs">${d.mountpoint || d.device}</span>
                <div class="flex items-center gap-2">
                    <div class="w-16 h-1.5 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full ${d.percent >= 90 ? 'bg-red-500' : d.percent >= 70 ? 'bg-yellow-500' : 'bg-primary'}" style="width: ${d.percent || 0}%"></div>
                    </div>
                    <span class="text-xs ${getStatusColor(d.percent)}">${fmtPct(d.percent)}</span>
                </div>
            </div>
        `).join('');
            el.innerHTML = `
        <div class="space-y-2">
            <div class="flex items-center gap-2"><span class="material-symbols-outlined text-base text-primary">dns</span> <strong class="text-white">${data.hostname || '‚Äî'}</strong> <span class="text-white/50">(${data.platform || ''})</span></div>
            <div class="flex items-center gap-2"><span class="material-symbols-outlined text-base text-blue-400">schedule</span> Uptime: ${secsToDHMS(data.uptime_sec)}</div>
            <div class="flex items-center gap-2"><span class="material-symbols-outlined text-base text-primary">memory</span> CPU: <span class="${getStatusColor(cpu.percent)}">${fmtPct(cpu.percent)}</span> <span class="text-white/50">(${cpu.count_logical || '‚Äî'} –ª–æ–≥, ${cpu.count_physical || '‚Äî'} —Ñ–∏–∑)</span></div>
            <div class="flex items-center gap-2"><span class="material-symbols-outlined text-base text-green-400">storage</span> RAM: <span class="${getStatusColor(mem.percent)}">${fmtPct(mem.percent)}</span> <span class="text-white/50">(${fmtBytes(mem.used || 0)} / ${fmtBytes(mem.total || 0)})</span></div>
            ${sw.total ? `<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base text-purple-400">swap_horiz</span> Swap: <span class="${getStatusColor(sw.percent)}">${fmtPct(sw.percent)}</span></div>` : ''}
            <div class="flex items-center gap-2"><span class="material-symbols-outlined text-base text-yellow-400">lan</span> –°–µ—Ç—å: ‚Üë${fmtBytes(net.bytes_sent || 0)} ‚Üì${fmtBytes(net.bytes_recv || 0)}</div>
            <div class="text-blue-400 text-xs ml-6">–°–∫–æ—Ä–æ—Å—Ç—å: ‚Üë${fmtBytes(networkSpeed.upSpeed)}/—Å ‚Üì${fmtBytes(networkSpeed.downSpeed)}/—Å</div>
        </div>
        ${disks ? `<div class="mt-3 pt-3 border-t border-white/10"><div class="text-white/50 text-xs mb-2">–î–∏—Å–∫–∏:</div>${disks}</div>` : ''}`;
        }

        function renderRemote(el, data) {
            if (!data || !data.ok) {
                el.innerHTML = `<div class="text-red-400">–û—à–∏–±–∫–∞: ${data?.error || '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}</div>`;
                return;
            }
            const cpu = { percent: data.cpu_percent || 0, count: data.cpu_count || '‚Äî' };
            const mem = { percent: data.memory_percent || 0, used_mb: data.memory_used_mb || 0, total_mb: data.memory_total_mb || 0 };
            const disk = { percent: data.disk_percent || 0, mountpoint: data.disk_mountpoint || '/' };
            const net = { bytes_sent: data.network_sent || 0, bytes_recv: data.network_recv || 0 };
            const networkSpeed = calculateNetworkSpeed(net, 'remote_' + (data.uname || 'unknown'));
            el.innerHTML = `
            <div class="space-y-1 text-sm">
                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-sm text-yellow-400">terminal</span> <span class="text-white">${data.uname || '‚Äî'}</span></div>
                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-sm text-blue-400">schedule</span> Uptime: ${secsToDHMS(data.uptime_sec)}</div>
                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-sm text-primary">memory</span> CPU: <span class="${getStatusColor(cpu.percent)}">${fmtPct(cpu.percent)}</span> (${cpu.count} —è–¥–µ—Ä)</div>
                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-sm text-orange-400">speed</span> Load: ${(data.loadavg || []).join(', ') || '‚Äî'}</div>
                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-sm text-green-400">storage</span> RAM: <span class="${getStatusColor(mem.percent)}">${fmtPct(mem.percent)}</span> (${mem.used_mb} / ${mem.total_mb} –ú–ë)</div>
                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-sm text-amber-400">hard_drive</span> –î–∏—Å–∫: <span class="${getStatusColor(disk.percent)}">${fmtPct(disk.percent)}</span> (${disk.mountpoint})</div>
                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-sm text-cyan-400">lan</span> –°–µ—Ç—å: ‚Üë${fmtBytes(net.bytes_sent)} ‚Üì${fmtBytes(net.bytes_recv)}</div>
                <div class="flex items-center gap-2 text-blue-400 text-xs"><span class="material-symbols-outlined text-sm">network_check</span> –°–∫–æ—Ä–æ—Å—Ç—å: ‚Üë${fmtBytes(networkSpeed.upSpeed)}/—Å ‚Üì${fmtBytes(networkSpeed.downSpeed)}/—Å</div>
            </div>`;
        }

        function createMainChart() {
            const ctx = document.getElementById('main-chart');
            if (!ctx) return null;
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'CPU %', data: [], borderColor: '#a855f7', backgroundColor: 'rgba(168,85,247,0.1)', fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 },
                        { label: 'RAM %', data: [], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 },
                        { label: '–î–∏—Å–∫ %', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0', usePointStyle: true, padding: 20 } },
                        tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, cornerRadius: 8 }
                    },
                    scales: {
                        x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { min: 0, max: 100, ticks: { color: 'rgba(255,255,255,0.5)', callback: v => v + '%' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    },
                    animation: { duration: 1000, easing: 'easeInOutQuart' }
                }
            });
            return mainChart;
        }

        function createLocalMiniChart() {
            const ctx = document.getElementById('local-mini-chart');
            if (!ctx) return null;
            localMiniChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['CPU', 'RAM', '–î–∏—Å–∫'],
                    datasets: [{ data: [0, 0, 0], backgroundColor: ['rgba(168,85,247,0.8)', 'rgba(34,197,94,0.8)', 'rgba(245,158,11,0.8)'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: '#e0e0e0', boxWidth: 10, usePointStyle: true } } } }
            });
            return localMiniChart;
        }

        async function refreshCharts() {
            const url = `{{ url_for('monitor_series_json', scope='local', name='panel') }}?hours=${currentPeriod}`;
            const res = await fetchJSON(url);
            if (!res || !res.ok || !mainChart) return;
            const items = res.items || [];
            if (items.length === 0) {
                mainChart.data.labels = ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'];
                mainChart.data.datasets[0].data = [0];
                mainChart.data.datasets[1].data = [0];
                mainChart.data.datasets[2].data = [0];
                mainChart.update('none');
                return;
            }
            const labels = items.map(i => {
                const date = new Date(i.created_at);
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            });
            mainChart.data.labels = labels;
            mainChart.data.datasets[0].data = items.map(i => i.cpu_percent ?? null);
            mainChart.data.datasets[1].data = items.map(i => i.mem_percent ?? null);
            mainChart.data.datasets[2].data = items.map(i => i.disk_percent ?? null);
            mainChart.update('none');
            if (localMiniChart && items.length > 0) {
                const last = items[items.length - 1];
                localMiniChart.data.datasets[0].data = [last.cpu_percent || 0, last.mem_percent || 0, last.disk_percent || 0];
                localMiniChart.update('none');
            }
        }

        async function refreshLocalPanel() {
            const el = document.getElementById('local-metrics');
            const headerEl = document.querySelector('h3.text-white.font-bold.mb-4');
            try {
                const hostsList = JSON.parse('{{ hosts|tojson|safe }}');
                if (hostsList && hostsList.length > 0) {
                    const currentHost = hostsList[0];
                    const data = await fetchJSON(`{{ url_for('monitor_host_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(currentHost.host_name)));
                    if (headerEl) headerEl.innerHTML = `–¢–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä: ${currentHost.host_name}`;
                    renderRemote(el, data);
                    updateStatsCards(data);
                    return;
                }
            } catch (e) { }
            const data = await fetchJSON("{{ url_for('monitor_local_json') }}");
            if (headerEl) headerEl.textContent = '–õ–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å';
            renderLocal(el, data);
            updateStatsCards(data);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–æ—Å—Ç–∞ –ø–æ –∏–º–µ–Ω–∏
        async function refreshHost(hostName, metricsEl, statusEl) {
            if (metricsEl) {
                metricsEl.innerHTML = `<div class="flex items-center gap-2 text-white/40"><span class="material-symbols-outlined text-sm animate-spin">progress_activity</span> –ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
            }
            if (statusEl) statusEl.className = 'w-2 h-2 rounded-full bg-yellow-500';
            const data = await fetchJSON(`{{ url_for('monitor_host_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(hostName)));
            if (metricsEl) renderRemote(metricsEl, data);
            if (statusEl) {
                statusEl.className = `w-2 h-2 rounded-full ${data.ok ? 'bg-green-500' : 'bg-red-500'}`;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSH-—Ü–µ–ª–∏ –ø–æ –∏–º–µ–Ω–∏
        async function refreshTarget(targetName, metricsEl, statusEl) {
            if (metricsEl) {
                metricsEl.innerHTML = `<div class="flex items-center gap-2 text-white/40"><span class="material-symbols-outlined text-sm animate-spin">progress_activity</span> –ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
            }
            if (statusEl) statusEl.className = 'w-2 h-2 rounded-full bg-yellow-500';
            const data = await fetchJSON(`{{ url_for('monitor_target_json', target_name='__T__') }}`.replace('__T__', encodeURIComponent(targetName)));
            if (metricsEl) renderRemote(metricsEl, data);
            if (statusEl) {
                statusEl.className = `w-2 h-2 rounded-full ${data.ok ? 'bg-green-500' : 'bg-red-500'}`;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤
        function refreshAllHosts() {
            document.querySelectorAll('.host-refresh-btn').forEach(btn => {
                const hostName = btn.getAttribute('data-host');
                const targetSel = btn.getAttribute('data-target');
                const metricsEl = document.querySelector(targetSel);
                const idx = Array.from(document.querySelectorAll('.host-refresh-btn')).indexOf(btn) + 1;
                const statusEl = document.getElementById(`host-status-${idx}`);
                refreshHost(hostName, metricsEl, statusEl);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö SSH-—Ü–µ–ª–µ–π
        function refreshAllTargets() {
            document.querySelectorAll('.target-refresh-btn').forEach(btn => {
                const targetName = btn.getAttribute('data-target-name');
                const targetSel = btn.getAttribute('data-target');
                const metricsEl = document.querySelector(targetSel);
                const idx = Array.from(document.querySelectorAll('.target-refresh-btn')).indexOf(btn) + 1;
                const statusEl = document.getElementById(`target-status-${idx}`);
                refreshTarget(targetName, metricsEl, statusEl);
            });
        }

        async function refreshAll() {
            await refreshLocalPanel();
            await refreshCharts();
            refreshAllHosts();
            refreshAllTargets();
        }

        document.addEventListener('DOMContentLoaded', () => {
            createMainChart();
            createLocalMiniChart();
            refreshAll();

            document.getElementById('refresh-all')?.addEventListener('click', refreshAll);

            // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –º–µ—Ç—Ä–∏–∫
            document.getElementById('clear-metrics')?.addEventListener('click', async () => {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–º–µ—Ä—ã –∏–∑ –ë–î?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç –ø–∞–º—è—Ç—å, –Ω–æ –Ω–µ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.')) {
                    return;
                }

                const btn = document.getElementById('clear-metrics');
                const originalHTML = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="material-symbols-outlined text-base animate-spin">progress_activity</span> –û—á–∏—Å—Ç–∫–∞...';

                try {
                    const resp = await fetch('/monitor/clear-metrics', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.getCsrfToken ? window.getCsrfToken() : ''
                        }
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        window.showToast('success', data.message || '–ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã');
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                        await refreshCharts();
                    } else {
                        window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –º–µ—Ç—Ä–∏–∫');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –º–µ—Ç—Ä–∏–∫');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            });

            // –ö–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ö–æ—Å—Ç–æ–≤
            document.querySelectorAll('.host-refresh-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const hostName = btn.getAttribute('data-host');
                    const targetSel = btn.getAttribute('data-target');
                    const metricsEl = document.querySelector(targetSel);
                    const idx = Array.from(document.querySelectorAll('.host-refresh-btn')).indexOf(btn) + 1;
                    const statusEl = document.getElementById(`host-status-${idx}`);
                    refreshHost(hostName, metricsEl, statusEl);
                });
            });

            // –ö–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSH-—Ü–µ–ª–µ–π
            document.querySelectorAll('.target-refresh-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetName = btn.getAttribute('data-target-name');
                    const targetSel = btn.getAttribute('data-target');
                    const metricsEl = document.querySelector(targetSel);
                    const idx = Array.from(document.querySelectorAll('.target-refresh-btn')).indexOf(btn) + 1;
                    const statusEl = document.getElementById(`target-status-${idx}`);
                    refreshTarget(targetName, metricsEl, statusEl);
                });
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –ø–µ—Ä–∏–æ–¥–∞
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('bg-primary/20', 'text-primary');
                        b.classList.add('bg-white/10', 'text-white/70');
                    });
                    btn.classList.remove('bg-white/10', 'text-white/70');
                    btn.classList.add('bg-primary/20', 'text-primary');
                    currentPeriod = parseInt(btn.getAttribute('data-period') || '1', 10);
                    refreshCharts();
                });
            });

            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            autoRefreshInterval = setInterval(refreshAll, 60000);
        });
    })();
</script>
{% endblock %}