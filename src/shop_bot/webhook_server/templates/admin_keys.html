{% extends "base.html" %}
{% block title %}Управление Ключами{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white">Ключи</h2>
    <p class="text-white/50 text-sm">Просмотр, создание и удаление ключей</p>
</div>

<!-- Create Key Form -->
<div class="bg-white/5 border border-white/10 rounded-lg p-6 mb-6">
    <form action="{{ url_for('create_key_ajax_route') }}" method="post" id="create-key-form" autocomplete="off">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="mode" id="create_mode" value="personal" />

        <!-- Mode Switch -->
        <div class="mb-6">
            <div class="flex gap-2" id="mode_switch">
                <button type="button" data-mode="personal"
                    class="px-4 py-2 rounded-lg bg-primary text-background-dark font-medium text-sm transition-colors">
                    Персональный ключ
                </button>
                <button type="button" data-mode="gift"
                    class="px-4 py-2 rounded-lg bg-white/10 text-white font-medium text-sm transition-colors hover:bg-white/20">
                    Подарочный ключ
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- User ID (personal mode) -->
            <div class="mode-section mode-personal">
                <label class="block text-white/70 text-sm font-medium mb-2">Пользователь</label>
                <input id="user_id" name="user_id" placeholder="ID или @username"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            </div>

            <!-- Host -->
            <div>
                <label class="block text-white/70 text-sm font-medium mb-2">Хост</label>
                <div class="soft-select" data-target="host_name">
                    <button type="button" class="soft-select-toggle" id="host_name_toggle">Выберите хост...</button>
                    <div class="soft-select-menu" id="host_name_menu"></div>
                    <select id="host_name" name="host_name" required>
                        <option value="" disabled selected>Выберите хост...</option>
                        {% for h in hosts %}
                        <option value="{{ h.host_name }}" data-inbound="{{ h.host_inbound_id }}">{{ h.host_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Inbound ID -->
            <div>
                <label class="block text-white/70 text-sm font-medium mb-2">Inbound ID</label>
                <input id="inbound_id" type="text" placeholder="—" readonly
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white/50 cursor-not-allowed" />
            </div>

            <!-- Plan with Price Badge -->
            <div>
                <label class="block text-white/70 text-sm font-medium mb-2">Тариф</label>
                <div class="flex gap-2">
                    <div class="soft-select flex-1" data-target="plan_select">
                        <button type="button" class="soft-select-toggle" id="plan_select_toggle">— Не выбран —</button>
                        <div class="soft-select-menu" id="plan_select_menu"></div>
                        <select id="plan_select">
                            <option value="">— Не выбран —</option>
                        </select>
                    </div>
                    <span id="plan_price"
                        class="px-3 py-2.5 rounded-lg bg-purple-500/20 text-purple-300 font-semibold text-sm whitespace-nowrap">—
                        RUB</span>
                </div>
            </div>

            <!-- Custom Days -->
            <div>
                <label class="block text-white/70 text-sm font-medium mb-2">Дней</label>
                <input id="custom_days" type="number" min="1" placeholder="например, 30"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            </div>

            <!-- Email (personal mode) -->
            <div class="mode-section mode-personal">
                <label class="block text-white/70 text-sm font-medium mb-2">Email ключа</label>
                <input id="key_email" name="key_email" type="email" placeholder="user@bot.local" readonly
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white/70 cursor-not-allowed" />
            </div>

            <!-- Expiry Date (personal mode) -->
            <div class="mode-section mode-personal md:col-span-2">
                <label class="block text-white/70 text-sm font-medium mb-2">Истекает</label>
                <div class="flex flex-wrap items-center gap-2">
                    <input id="expiry_date" name="expiry_date" type="text" placeholder="Выберите дату"
                        class="flex-1 min-w-[200px] bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    <button type="button" data-preset="30"
                        class="px-3 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20">+30</button>
                    <button type="button" data-preset="90"
                        class="px-3 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20">+90</button>
                    <button type="button" data-preset="180"
                        class="px-3 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20">+180</button>
                    <button type="button" data-preset="365"
                        class="px-3 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20">+365</button>
                </div>
            </div>
        </div>

        <!-- Gift mode info -->
        <div class="mode-section mode-gift hidden mt-4">
            <div class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/20 text-blue-300">
                Будет создан <strong>подарочный ключ</strong> на выбранном хосте. Email сгенерируется автоматически.
            </div>
        </div>

        <!-- Comment -->
        <div class="mt-4">
            <label class="block text-white/70 text-sm font-medium mb-2">Комментарий</label>
            <textarea id="comment" name="comment" rows="2" placeholder="Необязательный комментарий"
                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea>
        </div>

        <!-- Submit -->
        <div class="mt-4">
            <button type="button" id="btn-submit-create"
                class="px-6 py-2.5 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">
                Создать
            </button>
        </div>
    </form>
</div>

<!-- Filter & Sweep -->
<div class="flex flex-wrap items-center justify-between gap-4 mb-4">
    <div class="flex gap-2">
        <a href="{{ url_for('admin_keys_page', filter='general') }}"
            class="px-4 py-2 rounded-lg text-sm font-medium {% if current_filter == 'general' %}bg-primary text-background-dark{% else %}bg-white/10 text-white hover:bg-white/20{% endif %}">
            Общие
        </a>
        <a href="{{ url_for('admin_keys_page', filter='gift') }}"
            class="px-4 py-2 rounded-lg text-sm font-medium {% if current_filter == 'gift' %}bg-primary text-background-dark{% else %}bg-white/10 text-white hover:bg-white/20{% endif %}">
            Gift
        </a>
    </div>
    <form action="{{ url_for('sweep_expired_keys_route') }}" method="post"
        data-confirm="Удалить все истёкшие ключи? Это действие необратимо.">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit"
            class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400 text-sm font-medium hover:bg-red-500/30 flex items-center gap-2">
            <span class="material-symbols-outlined text-base">delete_sweep</span>
            Удалить истёкшие
        </button>
    </form>
</div>

<!-- Keys Table -->
<div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="bg-white/5">
                <tr>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">ID</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">User</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Хост</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Email</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">UUID</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Истекает</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Создан</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Действия</th>
                </tr>
            </thead>
            <tbody id="keys-tbody" class="divide-y divide-white/10"
                data-fetch-url="{{ url_for('admin_keys_table_partial', filter=current_filter) }}"
                data-fetch-interval="100000">
                {% include 'partials/admin_keys_table.html' %}
            </tbody>
        </table>
    </div>
</div>

<!-- Comment Modal -->
<div id="commentModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">Комментарий к ключу</h5>
            <button onclick="closeModal('commentModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <input type="text" id="commentInput" placeholder="Введите комментарий"
                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('commentModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">Отмена</button>
            <button id="commentSaveBtn"
                class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">Сохранить</button>
        </div>
    </div>
</div>

<!-- Expiry Modal -->
<div id="expiryModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">Изменить срок действия</h5>
            <button onclick="closeModal('expiryModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <label class="block text-white/70 text-sm mb-2">Сколько дней прибавить/убавить</label>
            <input type="number" id="expiryDelta" placeholder="Например, 7 или -7"
                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            <p class="text-white/50 text-sm mt-2">Введите положительное число для продления, отрицательное — для
                уменьшения срока.</p>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('expiryModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">Отмена</button>
            <button id="expirySaveBtn"
                class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">Сохранить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

<script>
    (function () {
        const USERS = JSON.parse(String.raw`{{ users | tojson | safe }}`);
        const USER_MAP = {};
        try {
            (USERS || []).forEach(u => {
                if (u && u.username) USER_MAP['@' + String(u.username).toLowerCase()] = u.telegram_id;
            });
        } catch (_) { }

        const STORAGE_KEY = 'admin_keys_form';
        const form = document.getElementById('create-key-form');
        const submitBtn = document.getElementById('btn-submit-create');
        const hostSel = document.getElementById('host_name');
        const planSel = document.getElementById('plan_select');
        const expiryInput = document.getElementById('expiry_date');
        const daysInput = document.getElementById('custom_days');
        const emailInput = document.getElementById('key_email');
        const userInput = document.getElementById('user_id');
        const modeInput = document.getElementById('create_mode');
        const inboundEl = document.getElementById('inbound_id');
        const priceEl = document.getElementById('plan_price');

        // Init soft selects
        initSoftSelect('host_name', 'Выберите хост...');
        initSoftSelect('plan_select', '— Не выбран —');

        // Init Flatpickr
        if (expiryInput && window.flatpickr) {
            flatpickr(expiryInput, {
                enableTime: true,
                time_24hr: true,
                dateFormat: 'Y-m-d H:i',
                minuteIncrement: 5,
                locale: flatpickr.l10ns.ru || 'ru',
            });
        }

        // ========= State Persistence =========
        const stateFields = ['mode', 'user_id', 'host_name', 'plan_select', 'custom_days', 'expiry_date', 'comment'];
        function saveState() {
            const state = {};
            stateFields.forEach(name => {
                const el = document.getElementById(name === 'mode' ? 'create_mode' : name);
                if (el) state[name] = el.value;
            });
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (_) { }
        }
        function restoreState() {
            let state = {};
            try { state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') || {}; } catch (_) { state = {}; }
            stateFields.forEach(name => {
                const el = document.getElementById(name === 'mode' ? 'create_mode' : name);
                if (el && state[name] != null) el.value = state[name];
            });
            return state;
        }
        const restoredState = restoreState();
        form?.addEventListener('input', saveState);
        form?.addEventListener('change', saveState);

        // Prefill from query ?user_id=
        try {
            const params = new URLSearchParams(location.search);
            const uid = params.get('user_id');
            if (uid && userInput) userInput.value = uid;
        } catch (_) { }

        // ========= Inbound ID Update =========
        function updateInbound() {
            if (!hostSel || !inboundEl) return;
            let opt = hostSel.options[hostSel.selectedIndex];
            if ((!opt || !opt.getAttribute) && hostSel.value) {
                opt = Array.from(hostSel.options || []).find(o => String(o.value) === String(hostSel.value));
            }
            inboundEl.value = (opt && opt.getAttribute('data-inbound')) ? opt.getAttribute('data-inbound') : '—';
        }

        // ========= Set Expiry Days =========
        function setExpiryDays(days) {
            if (!expiryInput) return;
            const d = new Date();
            d.setDate(d.getDate() + Number(days || 0));
            const pad = n => String(n).padStart(2, '0');
            const val = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            expiryInput.value = val;
            if (window.flatpickr && expiryInput._flatpickr) {
                expiryInput._flatpickr.setDate(val, true, 'Y-m-d H:i');
            }
        }

        // ========= Load Plans =========
        async function loadPlansAndRestore() {
            if (!hostSel || !planSel) return;
            updateInbound();
            const host = hostSel.value;
            if (!host) {
                planSel.innerHTML = '<option value="">— Не выбран —</option>';
                if (priceEl) priceEl.textContent = '— RUB';
                return;
            }
            planSel.innerHTML = '<option value="">Загрузка...</option>';
            try {
                const res = await fetch(`{{ url_for('admin_get_plans_for_host_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(host)));
                const d = await res.json();
                const items = (d && d.ok && d.items) ? d.items : [];
                const saved = (JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') || {}).plan_select;
                planSel.innerHTML = '<option value="">— Не выбран —</option>' + items.map(p =>
                    `<option value="${p.plan_id}" data-months="${p.months}" data-price="${p.price || 0}">${p.plan_name} (${p.months} мес.) — ${Number(p.price || 0).toFixed(0)} RUB</option>`
                ).join('');
                // Restore selected plan
                if (saved) {
                    planSel.value = saved;
                    const opt = planSel.options[planSel.selectedIndex];
                    const price = opt ? Number(opt.getAttribute('data-price') || 0) : 0;
                    if (priceEl) priceEl.textContent = saved ? `${price.toFixed(0)} RUB` : '— RUB';
                    const months = opt ? Number(opt.getAttribute('data-months') || 0) : 0;
                    if (months > 0) setExpiryDays(months * 30);
                } else {
                    if (priceEl) priceEl.textContent = '— RUB';
                }
                initSoftSelect('plan_select', '— Не выбран —');
            } catch (_) {
                planSel.innerHTML = '<option value="">— Не выбран —</option>';
                if (priceEl) priceEl.textContent = '— RUB';
            }
        }

        // Init if host was restored
        if (hostSel && hostSel.value) {
            updateInbound();
            loadPlansAndRestore();
        }

        if (hostSel) hostSel.addEventListener('change', () => {
            updateInbound();
            loadPlansAndRestore();
        });

        // Plan change -> set expiry and update price
        if (planSel) planSel.addEventListener('change', () => {
            const opt = planSel.options[planSel.selectedIndex];
            const months = opt ? Number(opt.getAttribute('data-months') || 0) : 0;
            const price = opt ? Number(opt.getAttribute('data-price') || 0) : 0;
            if (months > 0) setExpiryDays(months * 30);
            if (priceEl) priceEl.textContent = planSel.value ? `${price.toFixed(0)} RUB` : '— RUB';
            saveState();
        });

        // Days input
        if (daysInput) daysInput.addEventListener('input', () => {
            const days = Number(daysInput.value || 0);
            if (days > 0) setExpiryDays(days);
        });

        // Preset buttons
        document.querySelectorAll('[data-preset]').forEach(btn => {
            btn.addEventListener('click', () => setExpiryDays(Number(btn.getAttribute('data-preset') || 0)));
        });

        // ========= User Autocomplete Suggestions =========
        function initUserSuggest() {
            if (!userInput) return;
            let menu = document.createElement('div');
            menu.className = 'soft-select-menu';
            menu.style.position = 'fixed';
            menu.style.display = 'none';
            document.body.appendChild(menu);

            function place() {
                const r = userInput.getBoundingClientRect();
                menu.style.left = `${Math.round(r.left)}px`;
                menu.style.top = `${Math.round(r.bottom + 6)}px`;
                menu.style.width = `${Math.round(r.width)}px`;
                menu.style.zIndex = '1065';
            }
            function close() { menu.style.display = 'none'; }
            function open() { place(); menu.style.display = 'block'; }

            function render(list) {
                menu.innerHTML = '';
                list.slice(0, 8).forEach(u => {
                    const item = document.createElement('div');
                    item.className = 'soft-select-item';
                    const username = u.username ? '@' + String(u.username) : '—';
                    item.innerHTML = `<div style="font-weight:600">${u.telegram_id}</div><div style="opacity:.75">${username}</div>`;
                    item.onclick = async () => {
                        userInput.value = String(u.telegram_id);
                        close();
                        try { await normalizeUserId(); await maybeGenEmail(); } catch (_) { }
                    };
                    menu.appendChild(item);
                });
                if (list.length === 0) {
                    const none = document.createElement('div');
                    none.className = 'soft-select-item';
                    none.style.opacity = '.7';
                    none.textContent = 'Ничего не найдено';
                    menu.appendChild(none);
                }
            }

            function applyFilter() {
                const q = String(userInput.value || '').trim().toLowerCase();
                if (!q) { close(); return; }
                const arr = (USERS || []).filter(u => {
                    const idm = String(u.telegram_id || '').includes(q);
                    const unm = (u.username ? ('@' + String(u.username).toLowerCase()) : '').includes(q);
                    return idm || unm;
                });
                render(arr);
                open();
            }

            userInput.addEventListener('focus', applyFilter);
            userInput.addEventListener('input', applyFilter);
            window.addEventListener('scroll', place, true);
            window.addEventListener('resize', place, true);
            document.addEventListener('click', e => { if (!menu.contains(e.target) && e.target !== userInput) close(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });
        }
        initUserSuggest();

        // ========= Normalize User ID =========
        async function normalizeUserId() {
            if (!userInput) return;
            const raw = String(userInput.value || '').trim();
            if (!raw) return;
            if (!/^[0-9]+$/.test(raw)) {
                const key = raw.startsWith('@') ? raw.toLowerCase() : ('@' + raw.toLowerCase());
                if (USER_MAP[key]) {
                    userInput.value = String(USER_MAP[key]);
                    try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'), user_id: userInput.value })); } catch (_) { }
                }
            }
        }

        // ========= Generate Email =========
        async function maybeGenEmail() {
            if (!emailInput || !userInput) return;
            const userId = String(userInput.value || '').trim();
            if (!userId || !/^\d+$/.test(userId)) return; // Only call API for numeric IDs
            try {
                const res = await fetch(`{{ url_for('generate_key_email_route') }}?user_id=${encodeURIComponent(userId)}`);
                const data = await res.json();
                if (data && data.ok && data.email) emailInput.value = data.email;
            } catch (_) { }
        }

        if (userInput) {
            userInput.addEventListener('blur', async () => { await normalizeUserId(); await maybeGenEmail(); });
            userInput.addEventListener('change', async () => { await normalizeUserId(); await maybeGenEmail(); });
            // Generate on load
            (async () => { await normalizeUserId(); await maybeGenEmail(); })();
        }

        // ========= Mode Switch =========
        const modeSwitch = document.getElementById('mode_switch');
        const modeSections = document.querySelectorAll('.mode-section');
        function applyMode(mode) {
            if (modeInput) modeInput.value = mode;
            modeSections.forEach(section => {
                const isCurrent = section.classList.contains(`mode-${mode}`);
                section.classList.toggle('hidden', !isCurrent);
            });
            if (modeSwitch) {
                modeSwitch.querySelectorAll('[data-mode]').forEach(btn => {
                    const active = btn.getAttribute('data-mode') === mode;
                    btn.classList.toggle('bg-primary', active);
                    btn.classList.toggle('text-background-dark', active);
                    btn.classList.toggle('bg-white/10', !active);
                    btn.classList.toggle('text-white', !active);
                });
            }
            if (userInput) userInput.required = (mode === 'personal');
            if (emailInput) emailInput.required = false;
            saveState();
        }
        if (modeSwitch) {
            modeSwitch.querySelectorAll('[data-mode]').forEach(btn => {
                btn.addEventListener('click', () => applyMode(btn.getAttribute('data-mode') || 'personal'));
            });
        }
        applyMode(restoredState.mode || (modeInput?.value || 'personal'));

        // ========= Submit =========
        async function doSubmit() {
            await maybeGenEmail();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Создаю...';
            try {
                const fd = new FormData(form);
                if (modeInput) fd.set('mode', modeInput.value || 'personal');
                const res = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
                const data = await res.json().catch(() => ({ ok: false }));
                if (data && data.ok) {
                    showToast('success', 'Ключ создан');
                    refreshContainerById('keys-tbody');
                } else {
                    showToast('danger', 'Не удалось создать ключ');
                }
            } catch (_) { showToast('danger', 'Ошибка при создании ключа'); }
            finally { submitBtn.disabled = false; submitBtn.textContent = 'Создать'; }
        }

        submitBtn?.addEventListener('click', doSubmit);
        form?.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });

        // ========= Comment Modal =========
        let currentKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-edit-comment');
            if (!btn) return;
            currentKeyId = btn.getAttribute('data-key-id');
            document.getElementById('commentInput').value = btn.getAttribute('data-current-comment') || '';
            openModal('commentModal');
        });

        document.getElementById('commentSaveBtn')?.addEventListener('click', async () => {
            const comment = document.getElementById('commentInput').value;
            if (!currentKeyId) return;
            try {
                const fd = new FormData();
                fd.append('csrf_token', getCsrfToken());
                fd.append('comment', comment);
                const url = `{{ url_for('update_key_comment_route', key_id=0) }}`.replace('/0/', `/${currentKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', 'Комментарий сохранён');
                    closeModal('commentModal');
                    refreshContainerById('keys-tbody');
                } else { showToast('danger', 'Ошибка сохранения'); }
            } catch (_) { showToast('danger', 'Ошибка сети'); }
        });

        // ========= Expiry Modal =========
        let expiryKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-open-expiry');
            if (!btn) return;
            expiryKeyId = btn.getAttribute('data-key-id');
            document.getElementById('expiryDelta').value = '';
            openModal('expiryModal');
        });

        document.getElementById('expirySaveBtn')?.addEventListener('click', async () => {
            const delta = document.getElementById('expiryDelta').value;
            if (!expiryKeyId || !delta) { showToast('warning', 'Введите количество дней'); return; }
            try {
                const fd = new FormData();
                fd.append('csrf_token', getCsrfToken());
                fd.append('delta_days', delta);
                const url = `{{ url_for('adjust_key_expiry_route', key_id=0) }}`.replace('/0/', `/${expiryKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', 'Срок обновлён');
                    closeModal('expiryModal');
                    refreshContainerById('keys-tbody');
                } else { showToast('danger', 'Ошибка'); }
            } catch (_) { showToast('danger', 'Ошибка сети'); }
        });
    })();
</script>
{% endblock %}