{% extends "base.html" %}
{% block title %}Управление Ключами{% endblock %}

{% block content %}
<!-- ===== ЗАГОЛОВОК СТРАНИЦЫ ===== -->
<!-- Верхняя панель управления с названием раздела и кратким описанием -->
<div class="mb-8 flex items-center justify-between">
    <div class="space-y-1">
        <h2 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
            Ключи
            <span
                class="px-2 py-0.5 rounded-md bg-primary/10 text-primary text-[10px] font-semibold uppercase tracking-widest border border-primary/20">Доступ</span>
        </h2>
        <p class="text-white/40 text-xs font-medium uppercase tracking-[0.2em] ml-1">Управление VPN ключами и
            пользователями</p>
    </div>
</div>
<!-- ===== окончание заголовка ===== -->

<!-- ===== ФОРМА СОЗДАНИЯ КЛЮЧА ===== -->
<!-- Основной контейнер для создания новых VPN-доступов с переключателем режимов -->
<div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md mb-8 relative">
    <div class="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none">
        <div
            class="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2">
        </div>
    </div>

    <form action="{{ url_for('create_key_ajax_route') }}" method="post" id="create-key-form" autocomplete="off"
        class="relative z-10 ajax-form" data-success-msg="Ключ создан">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="mode" id="create_mode" value="personal" />

        <!-- ШАПКА ФОРМЫ И ПЕРЕКЛЮЧАТЕЛЬ -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                    <span class="material-symbols-outlined text-2xl">add_circle</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white tracking-tight">Создать ключ</h3>
                    <p class="text-white/60 text-xs font-medium">Новый доступ VPN</p>
                </div>
            </div>

            <div class="bg-black/30 p-1 rounded-xl flex w-full sm:w-auto border border-white/5" id="mode_switch">
                <div class="absolute inset-y-1 w-[calc(50%-4px)] bg-primary rounded-lg shadow-lg shadow-primary/20 transition-all duration-300 ease-out hidden"
                    id="mode_indicator"></div>
                <!-- Note: The indicator implementation in original code relied on absolute positioning which might need adjustment with new structure, 
                     but for simplicity we use class toggling logic in JS. 
                     Here we will use the same structure but updated classes for buttons. -->
                <button type="button" data-mode="personal"
                    class="relative z-10 flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-300 text-background-dark bg-primary w-full sm:w-36 text-center shadow-lg shadow-primary/20">Персональный</button>
                <button type="button" data-mode="gift"
                    class="relative z-10 flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-300 text-white/40 hover:text-white hover:bg-white/5 w-full sm:w-36 text-center">Подарочный</button>
            </div>
        </div>

        <!-- СЕТКА ПОЛЕЙ ВВОДА -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="mode-section mode-personal mode-gift relative group/input" id="user_id_container">
                <label
                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Пользователь</label>
                <div class="relative group">
                    <span
                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">person</span>
                    <input id="user_id" name="user_id" placeholder="ID или @username"
                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all placeholder:text-white/20" />
                </div>
            </div>

            <div class="relative min-w-0 group/input transition-all duration-300" id="host_container">
                <label
                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Хост</label>
                <div class="soft-select min-w-0 max-w-full" data-target="host_name">
                    <button type="button"
                        class="soft-select-toggle w-full truncate text-left rounded-xl pl-10 pr-3 py-2.5 bg-black/30 border border-white/10 text-sm text-white focus:ring-1 focus:ring-primary/40 outline-none transition-all relative"
                        id="host_name_toggle">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-hover/input:text-primary transition-colors">dns</span>
                        <span class="ml-1 text-white/70">Выберите хост...</span>
                    </button>
                    <div class="soft-select-menu rounded-xl border-white/10 bg-[#15261d] backdrop-blur-xl shadow-2xl"
                        id="host_name_menu"></div>
                    <select id="host_name" name="host_name" required
                        style="width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;position:absolute;left:0;bottom:0;">
                        <option value="" disabled selected>Выберите хост...</option>
                        {% for h in hosts %}<option value="{{ h.host_name }}" data-inbound="{{ h.host_inbound_id }}"
                            data-traffic-strategy="{{ h.default_traffic_strategy or 'NO_RESET' }}"
                            data-traffic-limit-gb="{% if h.default_traffic_limit_bytes is not none %}{{ (h.default_traffic_limit_bytes / 1024 / 1024 / 1024)|round(2) }}{% else %}0{% endif %}">
                            {{ h.host_name }}</option>{% endfor %}
                    </select>
                </div>
            </div>

            <div class="relative min-w-0 group/input">
                <label
                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Тариф</label>
                <div class="flex gap-2">
                    <div class="soft-select flex-1 min-w-0 max-w-full" data-target="plan_select">
                        <button type="button"
                            class="soft-select-toggle w-full truncate text-left rounded-xl pl-10 pr-3 py-2.5 bg-black/30 border border-white/10 text-sm text-white focus:ring-1 focus:ring-primary/40 outline-none transition-all relative"
                            id="plan_select_toggle">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm">payments</span>
                            <span class="ml-1">—</span>
                        </button>
                        <div class="soft-select-menu rounded-xl border-white/10 bg-[#15261d] backdrop-blur-xl shadow-2xl"
                            id="plan_select_menu"></div>
                        <select id="plan_select" name="plan_id" class="hidden">
                            <option value="">— Не выбран —</option>
                        </select>
                    </div>
                    <div class="hidden flex-shrink-0" id="plan_price_wrapper">
                        <span id="plan_price"
                            class="h-full flex items-center px-4 rounded-xl bg-primary/10 text-primary font-bold text-sm whitespace-nowrap border border-primary/20">0₽</span>
                    </div>
                </div>
            </div>

            <div class="relative group/input">
                <label
                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Дней</label>
                <div class="relative">
                    <input id="custom_days" name="custom_days" type="number" min="1" value="30" placeholder="30"
                        class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-center font-mono text-white placeholder:text-white/20 focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all" />
                </div>
            </div>

            <div class="mode-section mode-personal col-span-1 md:col-span-2">
                <label class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Дата
                    истечения <span id="expiry_days_label"
                        class="text-white/50 text-[10px] ml-1 lowercase font-normal"></span></label>
                <div
                    class="bg-black/30 border border-white/10 rounded-xl p-1.5 flex flex-wrap sm:flex-nowrap items-center gap-2">
                    <div class="relative flex-1 min-w-[140px]">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm">calendar_today</span>
                        <input id="expiry_date" name="expiry_date" type="text" placeholder="Укажите дату"
                            class="w-full bg-transparent border-none py-1.5 pl-9 pr-2 text-sm text-white focus:ring-0 placeholder:text-white/20" />
                    </div>
                    <div class="flex items-center gap-1 overflow-x-auto no-scrollbar py-1 px-1">
                        <button type="button" data-preset="30"
                            class="px-2.5 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 hover:text-white text-[10px] font-bold uppercase transition-colors border border-transparent hover:border-white/10 whitespace-nowrap">+30</button>
                        <button type="button" data-preset="90"
                            class="px-2.5 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 hover:text-white text-[10px] font-bold uppercase transition-colors border border-transparent hover:border-white/10 whitespace-nowrap">+90</button>
                        <button type="button" data-preset="180"
                            class="px-2.5 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 hover:text-white text-[10px] font-bold uppercase transition-colors border border-transparent hover:border-white/10 whitespace-nowrap">+180</button>
                        <button type="button" data-preset="365"
                            class="px-2.5 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 hover:text-white text-[10px] font-bold uppercase transition-colors border border-transparent hover:border-white/10 whitespace-nowrap">+365</button>
                    </div>
                </div>
            </div>

            <div class="col-span-1 md:col-span-2" id="comment_container">
                <label
                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Комментарий</label>
                <textarea id="comment" name="comment" rows="1" placeholder="Заметка..."
                    class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white placeholder:text-white/20 focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all resize-y min-h-[46px]"></textarea>
            </div>
        </div>

        <!-- ТЕХНИЧЕСКИЕ ДЕТАЛИ -->
        <details class="mt-4 group/details">
            <summary
                class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-white/30 cursor-pointer hover:text-white/60 transition-colors select-none w-max">
                <span
                    class="material-symbols-outlined text-sm transition-transform group-open/details:rotate-90">chevron_right</span>
                Технические детали
            </summary>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-3 pl-6 border-l border-white/5 ml-1.5">
                <div><label class="block text-[9px] font-bold uppercase text-white/20 mb-1">User Login</label><input
                        id="inbound_id" type="text" placeholder="—" readonly
                        class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white/50 font-mono" />
                </div>
                <div class="mode-section mode-personal mode-gift"><label
                        class="block text-[9px] font-bold uppercase text-white/20 mb-1">Email</label><input
                        id="key_email" name="key_email" type="email" placeholder="—" readonly
                        class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white/50 font-mono" />
                </div>
                <div><label class="block text-[9px] font-bold uppercase text-white/20 mb-1">GB Limit</label><input
                        id="host_traffic_gb" type="text" placeholder="—" readonly
                        class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white/50 font-mono" />
                </div>
                <div><label class="block text-[9px] font-bold uppercase text-white/20 mb-1">Reset</label><input
                        id="host_traffic_strategy" type="text" placeholder="—" readonly
                        class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white/50 font-mono" />
                </div>
                <div><label class="block text-[9px] font-bold uppercase text-white/20 mb-1">HWID</label><input
                        id="host_hwid_limit" type="text" placeholder="—" readonly
                        class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white/50 font-mono" />
                </div>
                <div><label class="block text-[9px] font-bold uppercase text-white/20 mb-1">Period</label><input
                        id="key_period_days" type="text" placeholder="0" readonly
                        class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white/50 font-mono" />
                </div>
                <div id="email_correction_warning"
                    class="col-span-1 sm:col-span-2 lg:col-span-3 text-[10px] text-yellow-500 font-bold hidden animate-pulse mt-2">
                </div>
            </div>
        </details>

        <div class="mode-section mode-gift hidden mt-6 animate-fade-in">
            <div class="p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 flex gap-4 items-center">
                <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                    <span class="material-symbols-outlined">card_giftcard</span>
                </div>
                <div class="flex-1">
                    <h5 class="text-sm font-bold text-blue-300">Подарочный ключ</h5>
                    <p class="text-xs text-blue-300/60 mt-0.5">Ключ будет создан с привязкой к пользователю (если
                        указан) или без неё. Ссылка будет сгенерирована автоматически.</p>
                </div>
            </div>
        </div>

        <button type="submit" id="btn-submit-create"
            class="mt-6 w-full py-3 rounded-xl bg-primary/10 border border-primary/20 text-primary font-bold text-xs uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all flex items-center justify-center gap-2 group overflow-hidden relative">
            <div
                class="absolute inset-0 bg-primary/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
            </div>
            <span
                class="material-symbols-outlined text-lg relative z-10 transition-transform group-hover:rotate-12">vpn_key</span>
            <span class="relative z-10">Создать ключ</span>
        </button>
    </form>
</div>
<!-- ===== окончание формы создания ===== -->

<!-- ===== ФИЛЬТРЫ И ПОИСК ===== -->
<!-- Инструменты фильтрации списка ключей и массового удаления истёкших -->
<!-- ===== ФИЛЬТРЫ И ПОИСК ===== -->
<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
    <div class="flex gap-1 bg-white/5 p-1 rounded-xl border border-white/10">
        <a href="{{ url_for('admin_keys_page', filter='general') }}"
            class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all {% if current_filter == 'general' %}bg-primary text-background-dark{% else %}text-white/60 hover:text-white hover:bg-white/5{% endif %} ajax-nav">Общие</a>
        <a href="{{ url_for('admin_keys_page', filter='gift') }}"
            class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all {% if current_filter == 'gift' %}bg-primary text-background-dark{% else %}text-white/60 hover:text-white hover:bg-white/5{% endif %} ajax-nav">Gift</a>
    </div>

    <div class="relative flex-1 w-full md:w-auto max-w-md">
        <span
            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg">search</span>
        <input id="keys-search" type="text" value="{{ q or '' }}"
            class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-2.5 text-white text-sm placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all"
            placeholder="Поиск по ID, имени, email..." />
    </div>

    <form action="{{ url_for('sweep_expired_keys_route') }}" method="post" class="ajax-form"
        data-confirm="Удалить все истёкшие ключи? Это действие необратимо." data-success-msg="Истёкшие ключи удалены">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit"
            class="px-5 py-2.5 rounded-xl bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] font-bold uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all flex items-center gap-2 whitespace-nowrap group">
            <span
                class="material-symbols-outlined text-base group-hover:rotate-12 transition-transform">delete_sweep</span>
            Удалить истёкшие
            {% if expired_count and expired_count > 0 %}
            <span
                class="ml-1 bg-red-500/20 text-white group-hover:bg-white/20 px-1.5 py-0.5 rounded text-[9px] min-w-[16px] text-center transition-colors">{{
                expired_count }}</span>
            {% endif %}
        </button>
    </form>
</div>
<!-- ===== окончание фильтров ===== -->

<!-- ===== ТАБЛИЦА КЛЮЧЕЙ ===== -->
<!-- Основной реестр ключей с пагинацией и действиями -->
<!-- ===== ТАБЛИЦА КЛЮЧЕЙ ===== -->
<div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-xl backdrop-blur-md">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="border-b border-white/5 bg-white/[0.02]">
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">ID</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">User</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">Хост</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">Email</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">UUID</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">Истекает</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40">Создан</th>
                    <th class="px-5 py-4 text-[10px] font-bold uppercase tracking-widest text-white/40 text-right">
                        Действия</th>
                </tr>
            </thead>
            <tbody id="keys-tbody" class="divide-y divide-white/5"
                data-fetch-url="{{ url_for('admin_keys_table_partial', filter=current_filter, q=q, page=current_page) }}"
                data-fetch-interval="120000">
                <tr>
                    <td colspan="8" class="p-8 text-center">
                        <div class="flex flex-col items-center justify-center text-white/30">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-2"></div>
                            <span class="text-xs">Загрузка ключей...</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<!-- ===== окончание таблицы ===== -->

<!-- ===== ПАГИНАЦИЯ ===== -->
<!-- Блок навигации по страницам -->
<!-- ===== ПАГИНАЦИЯ ===== -->
<div class="flex justify-center mt-6 gap-2" id="keys-pagination"
    data-src="{{ url_for('admin_keys_pagination_partial', page=current_page, q=q, filter=current_filter) }}">{% include
    'partials/admin_keys_pagination.html' %}</div>
<!-- ===== окончание пагинации ===== -->

<!-- ===== МОДАЛЬНОЕ ОКНО КОММЕНТАРИЯ ===== -->
<!-- Окно быстрого редактирования заметки к выбранному ключу -->
<div id="commentModal" class="modal-overlay">
    <div class="modal-content bg-[#101815] border border-white/10 rounded-2xl shadow-2xl backdrop-blur-xl">
        <div class="p-6 border-b border-white/5 flex items-center justify-between">
            <h5 class="text-white font-bold text-lg">Комментарий к ключу</h5>
            <button onclick="closeModal('commentModal')" class="text-white/40 hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <input type="text" id="commentInput" placeholder="Введите комментарий"
                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white text-sm placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/40" />
        </div>
        <div class="p-6 border-t border-white/5 flex justify-end gap-3">
            <button onclick="closeModal('commentModal')"
                class="px-5 py-2.5 rounded-xl bg-white/5 text-white/70 hover:bg-white/10 hover:text-white text-xs font-bold uppercase tracking-widest transition-all">Отмена</button>
            <button id="commentSaveBtn"
                class="px-5 py-2.5 rounded-xl bg-primary/10 border border-primary/20 text-primary hover:bg-primary hover:text-background-dark text-xs font-bold uppercase tracking-widest transition-all">Сохранить</button>
        </div>
    </div>
</div>
<!-- ===== окончание окна комментария ===== -->

<!-- ===== МОДАЛЬНОЕ ОКНО СРОКА ===== -->
<div id="expiryModal" class="modal-overlay">
    <div class="modal-content bg-[#101815] border border-white/10 rounded-2xl shadow-2xl backdrop-blur-xl">
        <div class="p-6 border-b border-white/5 flex items-center justify-between">
            <h5 class="text-white font-bold text-lg">Изменить срок действия</h5>
            <button onclick="closeModal('expiryModal')" class="text-white/40 hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-white/40 text-[10px] uppercase font-bold tracking-wider mb-2">Прибавить /
                    Убавить дней</label>
                <input type="number" id="expiryDelta" placeholder="Например: 7 или -7"
                    class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white text-sm placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/40" />
            </div>
            <p class="text-white/40 text-xs bg-white/5 p-3 rounded-lg border border-white/5">
                <span class="text-primary font-bold">Совет:</span> Введите положительное число для продления,
                отрицательное — для сокращения срока.
            </p>
        </div>
        <div class="p-6 border-t border-white/5 flex justify-end gap-3">
            <button onclick="closeModal('expiryModal')"
                class="px-5 py-2.5 rounded-xl bg-white/5 text-white/70 hover:bg-white/10 hover:text-white text-xs font-bold uppercase tracking-widest transition-all">Отмена</button>
            <button id="expirySaveBtn"
                class="px-5 py-2.5 rounded-xl bg-primary/10 border border-primary/20 text-primary hover:bg-primary hover:text-background-dark text-xs font-bold uppercase tracking-widest transition-all">Сохранить</button>
        </div>
    </div>
</div>
<!-- ===== окончание окна срока ===== -->
{% endblock %}

{% block scripts %}
<!-- ===== СТИЛИ И СКРИПТЫ FLATPICKR ===== -->
<!-- Подключение необходимых библиотек для работы календаря -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<!-- ===== окончание внешних библиотек ===== -->

<script>
    (function () {
        // ===== ДАННЫЕ ПОЛЬЗОВАТЕЛЕЙ =====
        // Загрузка и маппинг пользователей для автодополнения
        const USERS = JSON.parse(String.raw`{{ users | tojson | safe }}`);
        const USER_MAP = {};
        try { (USERS || []).forEach(u => { if (u && u.username) USER_MAP['@' + String(u.username).toLowerCase()] = u.telegram_id; }); } catch (_) { }
        // ===== окончание функции пользователей =====

        // ===== УПРАВЛЕНИЕ СОСТОЯНИЕМ =====
        const STORAGE_KEY = 'admin_keys_form';
        const form = document.getElementById('create-key-form');

        // Элементы формы
        const els = {
            mode: document.getElementById('create_mode'),
            user: document.getElementById('user_id'),
            host: document.getElementById('host_name'),
            plan: document.getElementById('plan_select'),
            days: document.getElementById('custom_days'),
            expiry: document.getElementById('expiry_date'),
            comment: document.getElementById('comment'),
            email: document.getElementById('key_email')
        };

        function saveState() {
            const state = {};
            if (els.mode) state.mode = els.mode.value;
            if (els.user) state.user_id = els.user.value;
            if (els.host) state.host_name = els.host.value;
            if (els.plan) state.plan_select = els.plan.value;
            if (els.days) state.custom_days = els.days.value;
            if (els.expiry) state.expiry_date = els.expiry.value;
            if (els.comment) state.comment = els.comment.value;
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (_) { }
        }

        function restoreState() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') || {}; } catch (_) { return {}; }
        }

        // ===== ИНИЦИАЛИЗАЦИЯ =====
        const restored = restoreState();

        // Переменные для режима (нужны для applyMode)
        const modeSwitch = document.getElementById('mode_switch'), modeSections = document.querySelectorAll('.mode-section');

        function applyMode(mode) {
            if (els.mode) els.mode.value = mode;
            modeSections.forEach(s => s.classList.toggle('hidden', !s.classList.contains(`mode-${mode}`)));
            if (modeSwitch) {
                const indicator = document.getElementById('mode_indicator'), commentContainer = document.getElementById('comment_container'), userIdContainer = document.getElementById('user_id_container');

                const btns = modeSwitch.querySelectorAll('button');
                btns.forEach(b => {
                    if (b.dataset.mode === mode) {
                        b.classList.remove('text-white/40', 'hover:text-white', 'hover:bg-white/5');
                        b.classList.add('text-background-dark', 'bg-primary', 'shadow-lg', 'shadow-primary/20');
                    } else {
                        b.classList.add('text-white/40', 'hover:text-white', 'hover:bg-white/5');
                        b.classList.remove('text-background-dark', 'bg-primary', 'shadow-lg', 'shadow-primary/20');
                    }
                });

                if (mode === 'personal') {
                    if (indicator) indicator.style.transform = 'translateX(0)';
                    if (commentContainer) commentContainer.classList.add('md:col-span-2');
                    if (userIdContainer) userIdContainer.classList.remove('md:col-span-4');
                } else {
                    if (indicator) indicator.style.transform = 'translateX(100%)';
                    if (commentContainer) commentContainer.classList.remove('md:col-span-2');
                    if (userIdContainer) userIdContainer.classList.add('md:col-span-4');
                }
            }
            if (els.user) els.user.required = (mode === 'personal');
            saveState();
            if (typeof maybeGenEmail === 'function') maybeGenEmail();
        }
        if (modeSwitch) modeSwitch.querySelectorAll('[data-mode]').forEach(btn => btn.addEventListener('click', () => applyMode(btn.getAttribute('data-mode') || 'personal')));

        // 1. Настройка Flatpickr
        if (els.expiry && window.flatpickr) {
            flatpickr(els.expiry, {
                enableTime: true,
                time_24hr: true,
                dateFormat: 'Y-m-d H:i',
                minuteIncrement: 5,
                locale: flatpickr.l10ns.ru || 'ru',
                onChange: function (selectedDates, dateStr) {
                    updateExpiryLabel(dateStr);
                    saveState();
                }
            });
        }

        // 2. Восстановление базовых полей
        if (els.comment && restored.comment !== undefined) els.comment.value = restored.comment;

        // Пользователь: приоритет URL -> сохраненное -> пусто
        const urlParams = new URLSearchParams(location.search);
        if (urlParams.get('user_id')) {
            if (els.user) els.user.value = urlParams.get('user_id');
        } else if (restored.user_id && els.user) {
            els.user.value = restored.user_id;
        }

        // 3. Хост и планы
        // Функция загрузки планов с учетом восстановленного состояния
        async function loadPlansAndRestore() {
            if (!els.host || !els.plan) return;

            const host = els.host.value;
            // Обновляем связанные поля хоста
            updateInbound();
            updateHostSettings();

            if (!host) {
                els.plan.innerHTML = '<option value="">— Не выбран —</option>';
                updatePlanDetails();
                return;
            }

            els.plan.innerHTML = '<option value="">Загрузка...</option>';
            try {
                const res = await fetch(`{{ url_for('admin_get_plans_for_host_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(host)));
                const d = await res.json();
                const items = (d && d.ok && d.items) ? d.items : [];

                // Рендерим опции
                els.plan.innerHTML = '<option value="">— Не выбран —</option>' + items.map(p =>
                    `<option value="${p.plan_id}" data-months="${p.months}" data-price="${p.price || 0}" data-hwid="${p.hwid_limit || 0}" data-traffic-gb="${p.traffic_limit_gb || 0}">${p.plan_name} (${p.months} мес.) — ${Number(p.price || 0).toFixed(0)} ₽</option>`
                ).join('');

                // Восстанавливаем план
                const savedPlan = restored.plan_select;
                if (savedPlan && Array.from(els.plan.options).some(o => o.value == savedPlan)) {
                    els.plan.value = savedPlan;
                } else if (els.plan.options.length > 1 && !savedPlan) {
                    // Если нет сохраненного, но есть опции - можно выбрать первый, но лучше оставить "Не выбран" или логику по умолчанию
                    // Для удобства выберем первый, если это новая форма
                    els.plan.selectedIndex = 1;
                }

                // Применяем детали плана (цену, лимиты)
                updatePlanDetails();

                // ВАЖНО: Восстановление даты/дней
                // Логика: Если у нас есть сохраненные custom_days/expiry_date, они имеют приоритет над дефолтом плана
                if (restored.custom_days && restored.expiry_date) {
                    if (els.days) els.days.value = restored.custom_days;
                    if (els.expiry) {
                        els.expiry.value = restored.expiry_date;
                        if (els.expiry._flatpickr) els.expiry._flatpickr.setDate(restored.expiry_date, false); // false = no event fire
                        updateExpiryLabel(restored.expiry_date);
                    }
                    if (document.getElementById('key_period_days')) document.getElementById('key_period_days').value = restored.custom_days;
                } else {
                    // Если сохраненных нет, применяем дефолт плана (если выбран)
                    applyPlanDefaults();
                }

            } catch (_) {
                els.plan.innerHTML = '<option value="">Ошибка</option>';
            }
            initSoftSelect('plan_select', '— Не выбран —');
        }

        function updatePlanDetails() {
            const opt = els.plan.options[els.plan.selectedIndex];
            const priceEl = document.getElementById('plan_price');
            const hwidInput = document.getElementById('host_hwid_limit');
            const gbInput = document.getElementById('host_traffic_gb');

            if (priceEl) priceEl.textContent = (opt && opt.value) ? `${Number(opt.getAttribute('data-price') || 0).toFixed(0)} ₽` : '— ₽';
            if (hwidInput) hwidInput.value = (opt && opt.getAttribute('data-hwid') && opt.getAttribute('data-hwid') !== '0') ? opt.getAttribute('data-hwid') : '—';
            if (gbInput) gbInput.value = (opt && opt.getAttribute('data-traffic-gb') && opt.getAttribute('data-traffic-gb') !== '0') ? Number(opt.getAttribute('data-traffic-gb')).toFixed(2) : '—';
        }

        function applyPlanDefaults() {
            const opt = els.plan.options[els.plan.selectedIndex];
            if (!opt || !opt.value) return;
            const months = Number(opt.getAttribute('data-months') || 0);
            if (months > 0) setExpiryDays(months * 30);
        }

        // Инициализация Хоста
        if (els.host) {
            if (restored.host_name) {
                els.host.value = restored.host_name;
            } else if (els.host.options.length > 1) {
                els.host.selectedIndex = 1;
            }
            // Загружаем планы (и внутри восстановим план и дату)
            loadPlansAndRestore();

            // Слушатель
            els.host.addEventListener('change', () => {
                updateInbound();
                updateHostSettings();
                // При смене хоста сбрасываем план и загружаем новые
                // Тут мы НЕ хотим восстанавливать старый план (так как хост другой), но можем сохранить дату?
                // Проще перезагрузить список.
                restored.plan_select = null; // Сбрасываем сохраненный план для нового хоста
                loadPlansAndRestore();
                saveState();
            });
        }

        // Слушатель Плана
        if (els.plan) {
            els.plan.addEventListener('change', () => {
                updatePlanDetails();
                applyPlanDefaults(); // При явном выборе плана пользователем - применяем его дефолты
                saveState();
            });
        }

        initSoftSelect('host_name', 'Выберите хост...');
        initSoftSelect('plan_select', '— Не выбран —');

        // 4. Режим (Personal/Gift)
        applyMode(restored.mode || (els.mode ? els.mode.value : 'personal') || 'personal');

        // 5. Обработчики сохранения
        form?.addEventListener('input', saveState);
        form?.addEventListener('change', saveState);

        // 6. Генерация email (если пользователь восстановлен)
        if (els.user && els.user.value) {
            (async () => {
                // Если есть сохраненный email, можно восстановить его?
                // Логика maybeGenEmail сама проверит и сгенерирует/исправит.
                if (typeof normalizeUserId === 'function') await normalizeUserId();
                if (typeof maybeGenEmail === 'function') await maybeGenEmail();
            })();
        }

        // ===== Вспомогательные функции =====

        // Обновление ID входящего подключения
        function updateInbound() {
            if (!els.host || !document.getElementById('inbound_id')) return;
            const inboundEl = document.getElementById('inbound_id');
            let opt = els.host.options[els.host.selectedIndex];
            if ((!opt || !opt.getAttribute) && els.host.value) opt = Array.from(els.host.options || []).find(o => String(o.value) === String(els.host.value));
            inboundEl.value = (opt && opt.getAttribute('data-inbound')) ? opt.getAttribute('data-inbound') : '—';
        }

        // Обновление настроек хоста
        function updateHostSettings() {
            if (!els.host) return;
            let opt = els.host.options[els.host.selectedIndex];
            if ((!opt || !opt.getAttribute) && els.host.value) opt = Array.from(els.host.options || []).find(o => String(o.value) === String(els.host.value));
            if (opt) {
                const trafficStrategy = opt.getAttribute('data-traffic-strategy') || 'NO_RESET';
                const strategyInput = document.getElementById('host_traffic_strategy');
                if (strategyInput) {
                    const labels = { 'NO_RESET': 'Никогда', 'DAY': 'Ежедневно', 'WEEK': 'Еженедельно', 'MONTH': 'Ежемесячно' };
                    strategyInput.value = labels[trafficStrategy] || trafficStrategy;
                }
            }
        }

        // Метка истечения
        function updateExpiryLabel(dateStr) {
            const lbl = document.getElementById('expiry_days_label');
            if (!lbl || !dateStr) { if (lbl) lbl.textContent = ''; return; }
            const diffDays = Math.ceil((new Date(dateStr).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
            lbl.textContent = diffDays > 0 ? `(на ${diffDays} дн.)` : '';
        }

        // Установка срока (базовая функция)
        function setExpiryDays(days) {
            if (!els.expiry) return;
            const d = new Date(); d.setDate(d.getDate() + Number(days || 0));
            const pad = n => String(n).padStart(2, '0');
            const val = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            els.expiry.value = val;
            if (els.days && els.days.value != days) els.days.value = days;
            const periodInput = document.getElementById('key_period_days'); if (periodInput) periodInput.value = days;
            if (window.flatpickr && els.expiry._flatpickr) els.expiry._flatpickr.setDate(val, true, 'Y-m-d H:i');
            updateExpiryLabel(val);
        }

        // updateInbound, updateHostSettings, updateExpiryLabel, setExpiryDays - должны быть определены глобально или выше

        // Переопределяем setExpiryDays чтобы сохранял состояние
        const originalSetExpiry = setExpiryDays;
        setExpiryDays = function (days) {
            originalSetExpiry(days);
            saveState(); // Сохраняем при изменении
        };

        // Слушатели дней и пресетов
        if (els.days) els.days.addEventListener('input', () => {
            const days = Number(els.days.value || 0);
            if (days > 0) originalSetExpiry(days); // Используем original чтобы не зациклить, хотя saveState безопасно
            saveState();
        });
        document.querySelectorAll('[data-preset]').forEach(btn => btn.addEventListener('click', () => {
            setExpiryDays(Number(btn.getAttribute('data-preset') || 0));
        }));

        // ===== окончание управления состоянием =====
        // ===== окончание выбора тарифа =====

        // ===== ПРЕДЛОЖЕНИЯ ПОЛЬЗОВАТЕЛЕЙ =====
        // Автодополнение при вводе ID или username
        function initUserSuggest() {
            if (!els.user) return;
            let menu = document.createElement('div'); menu.className = 'soft-select-menu'; menu.style.position = 'fixed'; menu.style.display = 'none'; document.body.appendChild(menu);
            const place = () => { const r = els.user.getBoundingClientRect(); menu.style.left = `${Math.round(r.left)}px`; menu.style.top = `${Math.round(r.bottom + 6)}px`; menu.style.width = `${Math.round(r.width)}px`; menu.style.zIndex = '1065'; };
            const close = () => menu.style.display = 'none';
            const open = () => { place(); menu.style.display = 'block'; };
            const render = (list) => {
                menu.innerHTML = '';
                list.slice(0, 8).forEach(u => {
                    const item = document.createElement('div'); item.className = 'soft-select-item';
                    item.innerHTML = `<div style="font-weight:600">${u.telegram_id}</div><div style="opacity:.75">${u.username ? '@' + u.username : '—'}</div>`;
                    item.onclick = async () => { els.user.value = String(u.telegram_id); close(); await normalizeUserId(); await maybeGenEmail(); };
                    menu.appendChild(item);
                });
                if (list.length === 0) { const none = document.createElement('div'); none.className = 'soft-select-item'; none.style.opacity = '.7'; none.textContent = 'Ничего не найдено'; menu.appendChild(none); }
            };
            const applyFilter = () => {
                const q = String(els.user.value || '').trim().toLowerCase();
                if (!q) { close(); return; }
                render((USERS || []).filter(u => String(u.telegram_id || '').includes(q) || (u.username ? ('@' + u.username.toLowerCase()) : '').includes(q)));
                open();
            };
            els.user.addEventListener('focus', applyFilter); els.user.addEventListener('input', applyFilter);
            window.addEventListener('scroll', place, true); window.addEventListener('resize', place, true);
            document.addEventListener('click', e => { if (!menu.contains(e.target) && e.target !== els.user) close(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });
        }
        initUserSuggest();
        // ===== окончание предложений =====

        // ===== НОРМАЛИЗАЦИЯ ID =====
        // Преобразование @username в цифровой ID
        async function normalizeUserId() {
            if (!els.user) return;
            const raw = String(els.user.value || '').trim(); if (!raw || /^[0-9]+$/.test(raw)) return;
            const key = raw.startsWith('@') ? raw.toLowerCase() : ('@' + raw.toLowerCase());
            if (USER_MAP[key]) { els.user.value = String(USER_MAP[key]); try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'), user_id: els.user.value })); } catch (_) { } }
        }
        // ===== окончание нормализации id =====

        // ===== ГЕНЕРАЦИЯ EMAIL =====
        // Создание почтового адреса для ключа
        async function maybeGenEmail() {
            if (!els.email) return;
            const mode = els.mode?.value || 'personal', userId = String(els.user?.value || '').trim();
            const warningEl = document.getElementById('email_correction_warning');

            // Сбрасываем предупреждение при каждом новом вводе
            if (warningEl) {
                warningEl.textContent = '';
                warningEl.classList.add('hidden');
                els.email.classList.remove('text-yellow-400');
            }

            // Логика:
            // 1. Personal: ID обязателен (число).
            // 2. Gift: ID опционален. Если есть ID (число) -> генерируем gift_{user}. Если нет ID -> генерируем рандом

            if (mode === 'personal' && (!userId || !/^\d+$/.test(userId))) return;

            try {
                let url = `{{ url_for('generate_key_email_route') }}?mode=${mode}`;
                if (userId && /^\d+$/.test(userId)) {
                    url += `&user_id=${encodeURIComponent(userId)}`;
                }
                const data = await (await fetch(url)).json();
                if (data?.ok && data.email) {
                    els.email.value = data.email;

                    // Обновляем поле "User Login" (бывший Inbound ID) именем пользователя из email
                    const inboundEl = document.getElementById('inbound_id');
                    if (inboundEl) {
                        const login = data.email.split('@')[0];
                        inboundEl.value = login;
                    }

                    if (data.was_corrected && warningEl) {
                        const original = data.original_username ? `@${data.original_username}` : 'оригинального имени';
                        warningEl.textContent = `Email скорректирован: ${original} содержит недопустимые символы. Используется безопасный формат.`;
                        warningEl.classList.remove('hidden');
                        els.email.classList.add('text-yellow-400');
                    }
                }
            } catch (_) { }
        }
        if (els.user) {
            els.user.addEventListener('blur', async () => { await normalizeUserId(); await maybeGenEmail(); });
            els.user.addEventListener('change', async () => { await normalizeUserId(); await maybeGenEmail(); });
            // Initial load
            (async () => {
                if (els.user.value) {
                    await normalizeUserId();
                    await maybeGenEmail();
                }
            })();
        }
        // ===== окончание генерации email =====

        // ===== УНИВЕРСАЛЬНЫЙ ЗАПРОС =====
        // Вспомогательная функция для API запросов
        async function apiRequest(url, method, body, successMsg) {
            try {
                const fd = body instanceof FormData ? body : new FormData();
                if (!(body instanceof FormData) && typeof body === 'object') Object.entries(body).forEach(([k, v]) => fd.append(k, v));
                fd.append('csrf_token', getCsrfToken());
                const resp = await fetch(url, { method, body: fd, credentials: 'same-origin' });
                const data = await resp.json().catch(() => ({ ok: resp.ok }));
                if (data.ok) { if (successMsg) showToast('success', successMsg); return data; }
                showToast('danger', 'Ошибка операции'); return null;
            } catch (_) { showToast('danger', 'Ошибка сети'); return null; }
        }
        // ===== окончание универсального запроса =====

        // ===== СОЗДАНИЕ КЛЮЧА =====
        // Отправка формы создания нового ключа
        // ===== УНИВЕРСАЛЬНЫЙ ОБРАБОТЧИК ФОРМ =====
        // Обработка AJAX форм (создание, удаление, очистка)
        const handleAjaxSubmit = async (e) => {
            const form = e.target.closest('.ajax-form');
            if (!form) return;

            e.preventDefault();
            e.stopPropagation();

            const performSubmit = async () => {
                const btn = form.querySelector('button[type="submit"]') || form.querySelector('button:not([type="button"])');
                let originalContent = '';

                if (btn) {
                    btn.disabled = true;
                    originalContent = btn.innerHTML;
                    btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-base">sync</span>';
                }

                try {
                    const fd = new FormData(form);
                    // Специальная логика для формы создания ключа
                    if (form.id === 'create-key-form' && modeInput) {
                        fd.set('mode', modeInput.value || 'personal');
                        await maybeGenEmail(); // Обновляем email перед отправкой если нужно
                    }

                    const successMsg = form.getAttribute('data-success-msg') || 'Успешно';
                    const data = await apiRequest(form.action, form.method || 'POST', fd, successMsg);

                    if (data) {
                        const refreshTarget = form.getAttribute('data-refresh-target') || 'keys-tbody';
                        await refreshContainerById(refreshTarget);

                        // Дополнительные действия после успеха
                        if (form.id === 'create-key-form') {
                            // Можно очистить форму или обновить email
                            await maybeGenEmail();
                        }
                    }
                } finally {
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                }
            };

            const confirmMsg = form.getAttribute('data-confirm');
            if (confirmMsg) {
                showConfirmModal(confirmMsg, performSubmit);
            } else {
                await performSubmit();
            }
        };

        // Делегирование событий submit для всех ajax-форм
        document.addEventListener('submit', (e) => {
            if (e.target.matches('.ajax-form')) {
                handleAjaxSubmit(e);
            }
        });

        // Удаляем старый обработчик кнопки создания, так как теперь используем событийную модель формы
        // submitBtn?.addEventListener('click', doSubmit);
        form?.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });
        // ===== окончание универсального обработчика =====

        // ===== МОДАЛЬНЫЕ ОКНА =====
        // Обработка сохранения комментария и срока действия
        let currentKeyId = null;
        document.addEventListener('click', e => {
            const commentBtn = e.target.closest('.btn-edit-comment'), expiryBtn = e.target.closest('.btn-open-expiry');
            if (commentBtn) { currentKeyId = commentBtn.getAttribute('data-key-id'); document.getElementById('commentInput').value = commentBtn.getAttribute('data-current-comment') || ''; openModal('commentModal'); }
            if (expiryBtn) { currentKeyId = expiryBtn.getAttribute('data-key-id'); document.getElementById('expiryDelta').value = ''; openModal('expiryModal'); }
        });
        document.getElementById('commentSaveBtn')?.addEventListener('click', async () => {
            const url = `{{ url_for('update_key_comment_route', key_id=0) }}`.replace('/0/', `/${currentKeyId}/`);
            if (await apiRequest(url, 'POST', { comment: document.getElementById('commentInput').value }, 'Комментарий сохранён')) { closeModal('commentModal'); refreshContainerById('keys-tbody'); }
        });
        document.getElementById('expirySaveBtn')?.addEventListener('click', async () => {
            const delta = document.getElementById('expiryDelta').value; if (!delta) return showToast('warning', 'Введите количество дней');
            const url = `{{ url_for('adjust_key_expiry_route', key_id=0) }}`.replace('/0/', `/${currentKeyId}/`);
            if (await apiRequest(url, 'POST', { delta_days: delta }, 'Срок обновлён')) { closeModal('expiryModal'); refreshContainerById('keys-tbody'); }
        });
        // ===== окончание модальных окон =====

        // ===== УПРАВЛЕНИЕ АКТИВАЦИЕЙ ФИЛЬТРОВ =====
        // Обновление стилей кнопок фильтров
        function updateFilterActiveState(urlStr) {
            const url = new URL(urlStr, location.origin);
            const currentFilter = url.searchParams.get('filter') || 'general';
            document.querySelectorAll('.ajax-nav').forEach(link => {
                const href = link.getAttribute('href');
                if (!href) return;
                const linkUrl = new URL(href, location.origin);
                const filterVal = linkUrl.searchParams.get('filter') || 'general';
                // Простая проверка для фильтров (не пагинации)
                if (link.textContent.trim().match(/^(Общие|Gift)$/i)) {
                    if (filterVal === currentFilter) {
                        link.classList.remove('text-white/60', 'hover:text-white', 'hover:bg-white/5');
                        link.classList.add('bg-primary', 'text-background-dark');
                    } else {
                        link.classList.add('text-white/60', 'hover:text-white', 'hover:bg-white/5');
                        link.classList.remove('bg-primary', 'text-background-dark');
                    }
                }
            });
        }

        // ===== AJAX НАВИГАЦИЯ =====
        // Обработка кликов по фильтрам и пагинации
        // ===== AJAX НАВИГАЦИЯ И LAZY LOAD =====

        // Основная функция загрузки таблицы
        const loadKeysTable = async () => {
            const tbody = document.getElementById('keys-tbody');
            if (!tbody) return;

            const url = new URL(tbody.dataset.fetchUrl, location.origin);
            try {
                const resp = await fetch(url, { headers: { 'Accept': 'text/html' } });
                if (resp.ok) {
                    tbody.innerHTML = await resp.text();
                    updatePagination(url);
                }
            } catch (e) {
                console.error("Failed to load keys:", e);
                tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-red-500">Ошибка загрузки</td></tr>';
            }
        };

        // Обновление пагинации
        const updatePagination = async (currentUrl) => {
            const pagEl = document.getElementById('keys-pagination');
            if (pagEl) {
                const pagUrl = new URL(pagEl.dataset.src, location.origin);
                // Копируем параметры (q, filter, page) из URL таблицы в URL пагинации
                currentUrl.searchParams.forEach((v, k) => pagUrl.searchParams.set(k, v));
                try {
                    const resp = await fetch(pagUrl, { headers: { 'Accept': 'text/html' } });
                    if (resp.ok) {
                        pagEl.innerHTML = await resp.text();
                        // Обновляем data-src чтобы он был актуальным (хотя мы все равно перезаписываем params)
                        pagEl.dataset.src = pagUrl.pathname + pagUrl.search;
                    }
                } catch (_) { }
            }
        };

        // Обработка кликов (Пагинация и Фильтры)
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('.ajax-nav');
            if (!link) return;

            e.preventDefault();
            const href = link.getAttribute('href');
            if (!href) return;

            // Обновляем URL в браузере
            history.pushState(null, '', href);
            updateFilterActiveState(href);

            const tbody = document.getElementById('keys-tbody');
            if (tbody) {
                // Вычисляем новый URL для fetch based on link href
                const newPageUrl = new URL(href, location.origin);
                const fetchUrl = new URL(tbody.dataset.fetchUrl, location.origin);

                // Переносим параметры
                newPageUrl.searchParams.forEach((v, k) => fetchUrl.searchParams.set(k, v));

                // Если клик по фильтру (не пагинация), сбрасываем page=1
                // (Обычно фильтры имеют href="...?filter=gift", без page, или page=1)
                // Логика users.html: просто копируем все params.
                // Если в href нет page, значит ли это page=1?
                if (!newPageUrl.searchParams.has('page')) {
                    fetchUrl.searchParams.set('page', '1');
                }

                tbody.dataset.fetchUrl = fetchUrl.toString();

                // Спиннер
                tbody.innerHTML = `<tr><td colspan="8" class="p-8 text-center"><div class="flex flex-col items-center justify-center text-white/30"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-2"></div><span class="text-xs">Загрузка...</span></div></td></tr>`;

                await loadKeysTable();
            }
        });

        // Обработка Popstate (Назад/Вперед)
        window.addEventListener('popstate', async () => {
            updateFilterActiveState(location.href);
            const tbody = document.getElementById('keys-tbody');
            if (tbody) {
                const currentUrl = new URL(location.href);
                const fetchUrl = new URL(tbody.dataset.fetchUrl, location.origin);
                currentUrl.searchParams.forEach((v, k) => fetchUrl.searchParams.set(k, v));
                tbody.dataset.fetchUrl = fetchUrl.toString();
                await loadKeysTable();
            }
        });

        // Поиск
        const searchInput = document.getElementById('keys-search');
        if (searchInput) {
            let searchTimeout = null;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    const q = searchInput.value || '';
                    const params = new URLSearchParams(location.search);
                    params.set('q', q);
                    params.set('page', '1'); // Сброс страницы при поиске

                    const newUrl = `${location.pathname}?${params.toString()}`;
                    history.replaceState(null, '', newUrl);

                    const tbody = document.getElementById('keys-tbody');
                    if (tbody) {
                        const fetchUrl = new URL(tbody.dataset.fetchUrl, location.origin);
                        fetchUrl.searchParams.set('q', q);
                        fetchUrl.searchParams.set('page', '1');
                        tbody.dataset.fetchUrl = fetchUrl.toString();
                        await loadKeysTable();
                    }
                }, 400);
            });
        }

        // Загрузка при открытии страницы
        loadKeysTable();

        // Автообновление
        const tbodyAutoload = document.getElementById('keys-tbody');
        if (tbodyAutoload && tbodyAutoload.dataset.fetchInterval) {
            setInterval(loadKeysTable, parseInt(tbodyAutoload.dataset.fetchInterval));
        }
        // ===== окончание поиска ключей =====
    })();

    // Функция копирования ключа
    window.copyKey = function (btn) {
        const key = btn.getAttribute('data-key');
        if (!key) {
            if (window.showToast) showToast('warning', 'Нет ключа');
            return;
        }

        const success = () => {
            if (window.showToast) showToast('success', 'Ключ скопирован');
            const icon = btn.querySelector('.material-symbols-outlined');
            if (icon) {
                const original = icon.textContent;
                icon.textContent = 'check';
                setTimeout(() => icon.textContent = original, 2000);
            }
        };

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(key).then(success).catch(err => {
                console.error(err);
                if (window.showToast) showToast('danger', 'Ошибка копирования');
            });
        } else {
            // Fallback
            let textArea = document.createElement("textarea");
            textArea.value = key;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                success();
            } catch (err) {
                if (window.showToast) showToast('danger', 'Ошибка копирования');
            }
            document.body.removeChild(textArea);
        }
    };
</script>
{% endblock %}