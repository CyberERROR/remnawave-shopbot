{% extends "base.html" %}
{% block title %}Управление Ключами{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white">Ключи</h2>
    <p class="text-white/50 text-sm">Просмотр, создание и удаление ключей</p>
</div>

<!-- Create Key Form -->
<!-- Create Key Form -->
<div
    class="relative overflow-hidden rounded-2xl bg-[#102219]/60 backdrop-blur-xl border border-white/10 shadow-2xl transition-all duration-300 hover:border-primary/20 hover:shadow-primary/5 mb-8 group">
    <!-- Decorative glow -->
    <div
        class="absolute -top-24 -right-24 w-48 h-48 bg-primary/20 blur-[80px] rounded-full pointer-events-none group-hover:bg-primary/30 transition-all duration-500">
    </div>

    <div class="p-5 sm:p-6 relative z-10">
        <form action="{{ url_for('create_key_ajax_route') }}" method="post" id="create-key-form" autocomplete="off">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="mode" id="create_mode" value="personal" />

            <!-- Header & Mode Switcher -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-primary/10 text-primary">
                        <span class="material-symbols-outlined text-2xl">add_circle</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white leading-tight">Создать ключ</h2>
                        <p class="text-xs text-white/50 font-medium">Новый доступ VPN</p>
                    </div>
                </div>

                <!-- Segmented Control -->
                <div class="bg-black/40 p-1 rounded-xl flex w-full sm:w-auto overflow-hidden relative shadow-inner border border-white/5"
                    id="mode_switch">
                    <div class="absolute inset-y-1 w-[calc(50%-4px)] bg-primary rounded-lg shadow-lg shadow-primary/20 transition-all duration-300 ease-out"
                        id="mode_indicator"></div>

                    <button type="button" data-mode="personal"
                        class="relative z-10 flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-colors duration-200 text-[#102219] w-full sm:w-36 text-center"
                        onclick="updateModeIndicator(this)">
                        Персональный
                    </button>
                    <button type="button" data-mode="gift"
                        class="relative z-10 flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-colors duration-200 text-white/60 w-full sm:w-36 text-center hover:text-white"
                        onclick="updateModeIndicator(this)">
                        Подарочный
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- User ID (Personal Only) -->
                <div class="mode-section mode-personal relative group/input">
                    <label
                        class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Пользователь</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within/input:text-primary transition-colors">person</span>
                        <input id="user_id" name="user_id" placeholder="ID или @username"
                            class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all shadow-inner" />
                    </div>
                </div>

                <!-- Host -->
                <div class="relative min-w-0 group/input transition-all duration-300" id="host_container">
                    <label
                        class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Хост</label>
                    <div class="soft-select min-w-0 max-w-full" data-target="host_name">
                        <button type="button"
                            class="soft-select-toggle w-full truncate text-left rounded-xl pl-10 py-3 bg-black/20 border-white/10 text-sm focus:ring-1 focus:ring-primary/50 shadow-inner text-white"
                            id="host_name_toggle">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-hover/input:text-primary transition-colors">dns</span>
                            <span class="ml-6">Выберите хост...</span>
                        </button>
                        <div class="soft-select-menu rounded-xl border-white/10 bg-[#15261d] backdrop-blur-xl shadow-2xl"
                            id="host_name_menu"></div>
                        <select id="host_name" name="host_name" required
                            style="width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;position:absolute;left:0;bottom:0;">
                            <option value="" disabled selected>Выберите хост...</option>
                            {% for h in hosts %}
                            <option value="{{ h.host_name }}" data-inbound="{{ h.host_inbound_id }}">{{ h.host_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Plan -->
                <div class="relative min-w-0 group/input">
                    <label
                        class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Тариф</label>
                    <div class="flex gap-2">
                        <div class="soft-select flex-1 min-w-0 max-w-full" data-target="plan_select">
                            <button type="button"
                                class="soft-select-toggle w-full truncate text-left rounded-xl pl-10 py-3 bg-black/20 border-white/10 text-sm text-white focus:ring-1 focus:ring-primary/50 shadow-inner"
                                id="plan_select_toggle">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg">payments</span>
                                <span class="ml-6">—</span>
                            </button>
                            <div class="soft-select-menu rounded-xl border-white/10 bg-[#15261d] backdrop-blur-xl shadow-2xl"
                                id="plan_select_menu"></div>
                            <select id="plan_select"
                                style="width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;position:absolute;left:0;bottom:0;">
                                <option value="">— Не выбран —</option>
                            </select>
                        </div>
                        <!-- Price Badge -->
                        <div class="hidden flex-shrink-0" id="plan_price_wrapper">
                            <span id="plan_price"
                                class="h-full flex items-center px-4 rounded-xl bg-primary/10 text-primary font-bold text-sm whitespace-nowrap border border-primary/20 shadow-inner">0₽</span>
                        </div>
                    </div>
                </div>

                <!-- Days -->
                <div class="relative group/input">
                    <label
                        class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Дней</label>
                    <div class="relative">
                        <input id="custom_days" type="number" min="1" placeholder="30"
                            class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-sm text-center font-mono text-white placeholder:text-white/20 focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all shadow-inner" />
                    </div>
                </div>

                <!-- Expiry Date (Personal Mode) -->
                <div class="mode-section mode-personal col-span-1 md:col-span-2">
                    <label class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Дата
                        истечения <span id="expiry_days_label"
                            class="text-white/50 text-[10px] ml-1 lowercase font-normal"></span></label>
                    <div
                        class="bg-black/20 border border-white/10 rounded-xl p-1.5 flex flex-wrap sm:flex-nowrap items-center gap-2 shadow-inner">
                        <div class="relative flex-1 min-w-[140px]">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg">calendar_today</span>
                            <input id="expiry_date" name="expiry_date" type="text" placeholder="Укажите дату"
                                class="w-full bg-transparent border-none py-2 pl-10 pr-2 text-sm text-white focus:ring-0 placeholder:text-white/30" />
                        </div>

                        <div class="flex items-center gap-1 overflow-x-auto no-scrollbar py-1 px-1">
                            <button type="button" data-preset="30"
                                class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 hover:text-white text-xs font-medium transition-colors border border-transparent hover:border-white/10 whitespace-nowrap">+30</button>
                            <button type="button" data-preset="90"
                                class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 hover:text-white text-xs font-medium transition-colors border border-transparent hover:border-white/10 whitespace-nowrap">+90</button>
                            <button type="button" data-preset="180"
                                class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 hover:text-white text-xs font-medium transition-colors border border-transparent hover:border-white/10 whitespace-nowrap">+180</button>
                            <button type="button" data-preset="365"
                                class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 hover:text-white text-xs font-medium transition-colors border border-transparent hover:border-white/10 whitespace-nowrap">+1г</button>
                        </div>
                    </div>
                </div>

                <!-- Comment -->
                <div class="col-span-1 md:col-span-2" id="comment_container">
                    <label
                        class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Комментарий</label>
                    <textarea id="comment" name="comment" rows="1" placeholder="Заметка..."
                        class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all resize-none shadow-inner min-h-[48px]"></textarea>
                </div>
            </div>

            <!-- Details Expander -->
            <details class="mt-4 group/details">
                <summary
                    class="flex items-center gap-2 text-xs font-medium text-white/40 cursor-pointer hover:text-white/70 transition-colors select-none w-max">
                    <span
                        class="material-symbols-outlined text-base transition-transform group-open/details:rotate-90">chevron_right</span>
                    Технические детали (Inbound, Email)
                </summary>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3 pl-6 border-l border-white/5 ml-1.5">
                    <div>
                        <label class="block text-[10px] text-white/30 mb-1">Inbound ID</label>
                        <input id="inbound_id" type="text" placeholder="—" readonly
                            class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white/50 font-mono" />
                    </div>
                    <div class="mode-section mode-personal">
                        <label class="block text-[10px] text-white/30 mb-1">Email</label>
                        <input id="key_email" name="key_email" type="email" placeholder="—" readonly
                            class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white/50 font-mono" />
                    </div>
                </div>
            </details>

            <!-- Gift Info -->
            <div class="mode-section mode-gift hidden mt-4 animate-fade-in">
                <div class="p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 flex gap-3 items-start">
                    <span class="material-symbols-outlined text-blue-400 mt-0.5">card_giftcard</span>
                    <div class="text-xs text-blue-200">
                        <strong class="block text-blue-100 text-sm mb-1">Подарочный ключ</strong>
                        Ключ будет создан без привязки к пользователю. Ссылка будет сгенерирована автоматически.
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <button type="button" id="btn-submit-create"
                class="mt-6 w-full py-3.5 rounded-xl bg-gradient-to-r from-primary/90 to-primary text-background-dark font-bold text-sm uppercase tracking-wide shadow-lg shadow-primary/20 hover:shadow-primary/30 hover:scale-[1.01] active:scale-[0.99] transition-all flex items-center justify-center gap-2 group">
                <span
                    class="material-symbols-outlined text-lg group-hover:rotate-12 transition-transform">vpn_key</span>
                Создать ключ
            </button>
        </form>
    </div>
</div>



<!-- Filter & Sweep -->
<!-- Filter & Sweep -->
<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
    <div class="flex gap-2">
        <a href="{{ url_for('admin_keys_page', filter='general') }}"
            class="px-4 py-2 rounded-lg text-sm font-medium {% if current_filter == 'general' %}bg-primary text-background-dark{% else %}bg-white/10 text-white hover:bg-white/20{% endif %}">
            Общие
        </a>
        <a href="{{ url_for('admin_keys_page', filter='gift') }}"
            class="px-4 py-2 rounded-lg text-sm font-medium {% if current_filter == 'gift' %}bg-primary text-background-dark{% else %}bg-white/10 text-white hover:bg-white/20{% endif %}">
            Gift
        </a>
    </div>

    <!-- Search Bar -->
    <div class="relative flex-1 w-full md:w-auto">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/50">search</span>
        <input id="keys-search" type="text" value="{{ q or '' }}"
            class="w-full bg-white/5 border border-white/10 rounded-lg pl-10 pr-4 py-2 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-colors"
            placeholder="Поиск..." />
    </div>

    <form action="{{ url_for('sweep_expired_keys_route') }}" method="post"
        data-confirm="Удалить все истёкшие ключи? Это действие необратимо.">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit"
            class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400 text-sm font-medium hover:bg-red-500/30 flex items-center gap-2 whitespace-nowrap">
            <span class="material-symbols-outlined text-base">delete_sweep</span>
            Удалить истёкшие
        </button>
    </form>
</div>

<!-- Keys Table -->
<div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="bg-white/5">
                <tr>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">ID</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">User</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Хост</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Email</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">UUID</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Истекает</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Создан</th>
                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Действия</th>
                </tr>
            </thead>
            <tbody id="keys-tbody" class="divide-y divide-white/10"
                data-fetch-url="{{ url_for('admin_keys_table_partial', filter=current_filter, q=q, page=current_page) }}"
                data-fetch-interval="100000">
                {% include 'partials/admin_keys_table.html' %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="flex justify-center mt-4 gap-2" id="keys-pagination"
    data-src="{{ url_for('admin_keys_pagination_partial', page=current_page, q=q, filter=current_filter) }}">
    {% include 'partials/admin_keys_pagination.html' %}
</div>

<!-- Comment Modal -->
<div id="commentModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">Комментарий к ключу</h5>
            <button onclick="closeModal('commentModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <input type="text" id="commentInput" placeholder="Введите комментарий"
                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('commentModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">Отмена</button>
            <button id="commentSaveBtn"
                class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">Сохранить</button>
        </div>
    </div>
</div>

<!-- Expiry Modal -->
<div id="expiryModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">Изменить срок действия</h5>
            <button onclick="closeModal('expiryModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <label class="block text-white/70 text-sm mb-2">Сколько дней прибавить/убавить</label>
            <input type="number" id="expiryDelta" placeholder="Например, 7 или -7"
                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            <p class="text-white/50 text-sm mt-2">Введите положительное число для продления, отрицательное — для
                уменьшения срока.</p>
        </div>
        <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeModal('expiryModal')"
                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20">Отмена</button>
            <button id="expirySaveBtn"
                class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">Сохранить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

<script>
    (function () {
        const USERS = JSON.parse(String.raw`{{ users | tojson | safe }}`);
        const USER_MAP = {};
        try {
            (USERS || []).forEach(u => {
                if (u && u.username) USER_MAP['@' + String(u.username).toLowerCase()] = u.telegram_id;
            });
        } catch (_) { }

        const STORAGE_KEY = 'admin_keys_form';
        const form = document.getElementById('create-key-form');
        const submitBtn = document.getElementById('btn-submit-create');
        const hostSel = document.getElementById('host_name');
        const planSel = document.getElementById('plan_select');
        const expiryInput = document.getElementById('expiry_date');
        const daysInput = document.getElementById('custom_days');
        const emailInput = document.getElementById('key_email');
        const userInput = document.getElementById('user_id');
        const modeInput = document.getElementById('create_mode');
        const inboundEl = document.getElementById('inbound_id');
        const priceEl = document.getElementById('plan_price');

        // Init soft selects
        initSoftSelect('host_name', 'Выберите хост...');
        initSoftSelect('plan_select', '— Не выбран —');

        // Init Flatpickr
        if (expiryInput && window.flatpickr) {
            flatpickr(expiryInput, {
                enableTime: true,
                time_24hr: true,
                dateFormat: 'Y-m-d H:i',
                minuteIncrement: 5,
                locale: flatpickr.l10ns.ru || 'ru',
            });
        }

        // ========= State Persistence =========
        const stateFields = ['mode', 'user_id', 'host_name', 'plan_select', 'custom_days', 'expiry_date', 'comment'];
        function saveState() {
            const state = {};
            stateFields.forEach(name => {
                const el = document.getElementById(name === 'mode' ? 'create_mode' : name);
                if (el) state[name] = el.value;
            });
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (_) { }
        }
        function restoreState() {
            let state = {};
            try { state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') || {}; } catch (_) { state = {}; }
            stateFields.forEach(name => {
                const el = document.getElementById(name === 'mode' ? 'create_mode' : name);
                if (el && state[name] != null) el.value = state[name];
            });
            return state;
        }
        const restoredState = restoreState();
        form?.addEventListener('input', saveState);
        form?.addEventListener('change', saveState);

        // Prefill from query ?user_id=
        try {
            const params = new URLSearchParams(location.search);
            const uid = params.get('user_id');
            if (uid && userInput) userInput.value = uid;
        } catch (_) { }

        // ========= Inbound ID Update =========
        function updateInbound() {
            if (!hostSel || !inboundEl) return;
            let opt = hostSel.options[hostSel.selectedIndex];
            if ((!opt || !opt.getAttribute) && hostSel.value) {
                opt = Array.from(hostSel.options || []).find(o => String(o.value) === String(hostSel.value));
            }
            inboundEl.value = (opt && opt.getAttribute('data-inbound')) ? opt.getAttribute('data-inbound') : '—';
        }

        // ========= Set Expiry Days =========
        function updateExpiryLabel(dateStr) {
            const lbl = document.getElementById('expiry_days_label');
            if (!lbl) return;
            if (!dateStr) { lbl.textContent = ''; return; }

            const d = new Date(dateStr);
            const now = new Date();
            const diffTime = d.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays > 0) {
                lbl.textContent = `(на ${diffDays} дн.)`;
            } else {
                lbl.textContent = '';
            }
        }

        function setExpiryDays(days) {
            if (!expiryInput) return;
            const d = new Date();
            d.setDate(d.getDate() + Number(days || 0));
            const pad = n => String(n).padStart(2, '0');
            const val = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            expiryInput.value = val;
            if (window.flatpickr && expiryInput._flatpickr) {
                expiryInput._flatpickr.setDate(val, true, 'Y-m-d H:i');
            }
            updateExpiryLabel(val);
        }

        if (expiryInput) {
            expiryInput.addEventListener('change', () => updateExpiryLabel(expiryInput.value));
            // Flatpickr might trigger change, or we verify with hooks if needed, but 'change' is standard.
        }

        // ========= Load Plans =========
        async function loadPlansAndRestore() {
            if (!hostSel || !planSel) return;
            updateInbound();
            const host = hostSel.value;
            if (!host) {
                planSel.innerHTML = '<option value="">— Не выбран —</option>';
                if (priceEl) priceEl.textContent = '— RUB';
                return;
            }
            planSel.innerHTML = '<option value="">Загрузка...</option>';
            try {
                const res = await fetch(`{{ url_for('admin_get_plans_for_host_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(host)));
                const d = await res.json();
                const items = (d && d.ok && d.items) ? d.items : [];
                const saved = (JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') || {}).plan_select;
                planSel.innerHTML = '<option value="">— Не выбран —</option>' + items.map(p =>
                    `<option value="${p.plan_id}" data-months="${p.months}" data-price="${p.price || 0}">${p.plan_name} (${p.months} мес.) — ${Number(p.price || 0).toFixed(0)} RUB</option>`
                ).join('');
                // Restore selected plan
                if (saved) {
                    planSel.value = saved;
                    const opt = planSel.options[planSel.selectedIndex];
                    const price = opt ? Number(opt.getAttribute('data-price') || 0) : 0;
                    if (priceEl) priceEl.textContent = saved ? `${price.toFixed(0)} RUB` : '— RUB';
                    const months = opt ? Number(opt.getAttribute('data-months') || 0) : 0;
                    if (months > 0) setExpiryDays(months * 30);
                } else {
                    if (priceEl) priceEl.textContent = '— RUB';
                }
                initSoftSelect('plan_select', '— Не выбран —');
            } catch (_) {
                planSel.innerHTML = '<option value="">— Не выбран —</option>';
                if (priceEl) priceEl.textContent = '— RUB';
            }
        }

        // Init if host was restored
        if (hostSel && hostSel.value) {
            updateInbound();
            loadPlansAndRestore();
        }

        if (hostSel) hostSel.addEventListener('change', () => {
            updateInbound();
            loadPlansAndRestore();
        });

        // Plan change -> set expiry and update price
        if (planSel) planSel.addEventListener('change', () => {
            const opt = planSel.options[planSel.selectedIndex];
            const months = opt ? Number(opt.getAttribute('data-months') || 0) : 0;
            const price = opt ? Number(opt.getAttribute('data-price') || 0) : 0;
            if (months > 0) setExpiryDays(months * 30);
            if (priceEl) priceEl.textContent = planSel.value ? `${price.toFixed(0)} RUB` : '— RUB';
            saveState();
        });

        // Days input
        if (daysInput) daysInput.addEventListener('input', () => {
            const days = Number(daysInput.value || 0);
            if (days > 0) setExpiryDays(days);
        });

        // Preset buttons
        document.querySelectorAll('[data-preset]').forEach(btn => {
            btn.addEventListener('click', () => setExpiryDays(Number(btn.getAttribute('data-preset') || 0)));
        });

        // ========= User Autocomplete Suggestions =========
        function initUserSuggest() {
            if (!userInput) return;
            let menu = document.createElement('div');
            menu.className = 'soft-select-menu';
            menu.style.position = 'fixed';
            menu.style.display = 'none';
            document.body.appendChild(menu);

            function place() {
                const r = userInput.getBoundingClientRect();
                menu.style.left = `${Math.round(r.left)}px`;
                menu.style.top = `${Math.round(r.bottom + 6)}px`;
                menu.style.width = `${Math.round(r.width)}px`;
                menu.style.zIndex = '1065';
            }
            function close() { menu.style.display = 'none'; }
            function open() { place(); menu.style.display = 'block'; }

            function render(list) {
                menu.innerHTML = '';
                list.slice(0, 8).forEach(u => {
                    const item = document.createElement('div');
                    item.className = 'soft-select-item';
                    const username = u.username ? '@' + String(u.username) : '—';
                    item.innerHTML = `<div style="font-weight:600">${u.telegram_id}</div><div style="opacity:.75">${username}</div>`;
                    item.onclick = async () => {
                        userInput.value = String(u.telegram_id);
                        close();
                        try { await normalizeUserId(); await maybeGenEmail(); } catch (_) { }
                    };
                    menu.appendChild(item);
                });
                if (list.length === 0) {
                    const none = document.createElement('div');
                    none.className = 'soft-select-item';
                    none.style.opacity = '.7';
                    none.textContent = 'Ничего не найдено';
                    menu.appendChild(none);
                }
            }

            function applyFilter() {
                const q = String(userInput.value || '').trim().toLowerCase();
                if (!q) { close(); return; }
                const arr = (USERS || []).filter(u => {
                    const idm = String(u.telegram_id || '').includes(q);
                    const unm = (u.username ? ('@' + String(u.username).toLowerCase()) : '').includes(q);
                    return idm || unm;
                });
                render(arr);
                open();
            }

            userInput.addEventListener('focus', applyFilter);
            userInput.addEventListener('input', applyFilter);
            window.addEventListener('scroll', place, true);
            window.addEventListener('resize', place, true);
            document.addEventListener('click', e => { if (!menu.contains(e.target) && e.target !== userInput) close(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });
        }
        initUserSuggest();

        // ========= Normalize User ID =========
        async function normalizeUserId() {
            if (!userInput) return;
            const raw = String(userInput.value || '').trim();
            if (!raw) return;
            if (!/^[0-9]+$/.test(raw)) {
                const key = raw.startsWith('@') ? raw.toLowerCase() : ('@' + raw.toLowerCase());
                if (USER_MAP[key]) {
                    userInput.value = String(USER_MAP[key]);
                    try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'), user_id: userInput.value })); } catch (_) { }
                }
            }
        }

        // ========= Generate Email =========
        async function maybeGenEmail() {
            if (!emailInput || !userInput) return;
            const userId = String(userInput.value || '').trim();
            if (!userId || !/^\d+$/.test(userId)) return; // Only call API for numeric IDs
            try {
                const res = await fetch(`{{ url_for('generate_key_email_route') }}?user_id=${encodeURIComponent(userId)}`);
                const data = await res.json();
                if (data && data.ok && data.email) emailInput.value = data.email;
            } catch (_) { }
        }

        if (userInput) {
            userInput.addEventListener('blur', async () => { await normalizeUserId(); await maybeGenEmail(); });
            userInput.addEventListener('change', async () => { await normalizeUserId(); await maybeGenEmail(); });
            // Generate on load
            (async () => { await normalizeUserId(); await maybeGenEmail(); })();
        }

        // ========= Mode Switch =========
        const modeSwitch = document.getElementById('mode_switch');
        const modeSections = document.querySelectorAll('.mode-section');
        function applyMode(mode) {
            if (modeInput) modeInput.value = mode;

            // Toggle visibility of sections
            modeSections.forEach(section => {
                const isCurrent = section.classList.contains(`mode-${mode}`);
                section.classList.toggle('hidden', !isCurrent);
            });

            // Update visual state of buttons (Segmented Control)
            if (modeSwitch && typeof window.updateModeIndicator === 'function') {
                const btn = modeSwitch.querySelector(`[data-mode="${mode}"]`);
                if (btn) window.updateModeIndicator(btn);
            } else if (modeSwitch) {
                // Fallback logic
                const indicator = document.getElementById('mode_indicator');
                const commentContainer = document.getElementById('comment_container');
                const btn = modeSwitch.querySelector(`[data-mode="${mode}"]`);

                modeSwitch.querySelectorAll('button').forEach(b => {
                    b.classList.remove('text-[#102219]');
                    b.classList.add('text-white/60');
                });
                if (btn) {
                    btn.classList.add('text-[#102219]');
                    btn.classList.remove('text-white/60');
                }

                if (mode === 'personal') {
                    if (indicator) indicator.style.transform = 'translateX(0)';
                    // Personal: Comment fills 2 cols in row 2 (leaving Expiry 2 cols)
                    if (commentContainer) commentContainer.classList.add('md:col-span-2');
                } else {
                    if (indicator) indicator.style.transform = 'translateX(100%)';
                    // Gift: Comment fits in 1 col (4th in row 1)
                    if (commentContainer) commentContainer.classList.remove('md:col-span-2');
                }
            }

            if (userInput) userInput.required = (mode === 'personal');
            if (emailInput) emailInput.required = false;
            saveState();
        }

        // Attach listeners
        if (modeSwitch) {
            modeSwitch.querySelectorAll('[data-mode]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Prevent default to avoid double firing if onclick is also set (though onclick handles visual, we want logic here)
                    // Actually, onclick in HTML calls updateModeIndicator. 
                    // We should let this listener handle the LOGIC (applyMode).
                    applyMode(btn.getAttribute('data-mode') || 'personal');
                });
            });
        }

        // Initial apply
        applyMode(restoredState.mode || (modeInput?.value || 'personal'));

        // ========= Submit =========
        async function doSubmit() {
            await maybeGenEmail();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Создаю...';
            try {
                const fd = new FormData(form);
                if (modeInput) fd.set('mode', modeInput.value || 'personal');
                const res = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
                const data = await res.json().catch(() => ({ ok: false }));
                if (data && data.ok) {
                    showToast('success', 'Ключ создан');
                    refreshContainerById('keys-tbody');
                } else {
                    showToast('danger', 'Не удалось создать ключ');
                }
            } catch (_) { showToast('danger', 'Ошибка при создании ключа'); }
            finally { submitBtn.disabled = false; submitBtn.textContent = 'Создать'; }
        }

        submitBtn?.addEventListener('click', doSubmit);
        form?.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });

        // ========= Comment Modal =========
        let currentKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-edit-comment');
            if (!btn) return;
            currentKeyId = btn.getAttribute('data-key-id');
            document.getElementById('commentInput').value = btn.getAttribute('data-current-comment') || '';
            openModal('commentModal');
        });

        document.getElementById('commentSaveBtn')?.addEventListener('click', async () => {
            const comment = document.getElementById('commentInput').value;
            if (!currentKeyId) return;
            try {
                const fd = new FormData();
                fd.append('csrf_token', getCsrfToken());
                fd.append('comment', comment);
                const url = `{{ url_for('update_key_comment_route', key_id=0) }}`.replace('/0/', `/${currentKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', 'Комментарий сохранён');
                    closeModal('commentModal');
                    refreshContainerById('keys-tbody');
                } else { showToast('danger', 'Ошибка сохранения'); }
            } catch (_) { showToast('danger', 'Ошибка сети'); }
        });

        // ========= Expiry Modal =========
        let expiryKeyId = null;
        document.addEventListener('click', e => {
            const btn = e.target.closest('.btn-open-expiry');
            if (!btn) return;
            expiryKeyId = btn.getAttribute('data-key-id');
            document.getElementById('expiryDelta').value = '';
            openModal('expiryModal');
        });

        document.getElementById('expirySaveBtn')?.addEventListener('click', async () => {
            const delta = document.getElementById('expiryDelta').value;
            if (!expiryKeyId || !delta) { showToast('warning', 'Введите количество дней'); return; }
            try {
                const fd = new FormData();
                fd.append('csrf_token', getCsrfToken());
                fd.append('delta_days', delta);
                const url = `{{ url_for('adjust_key_expiry_route', key_id=0) }}`.replace('/0/', `/${expiryKeyId}/`);
                const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (resp.ok) {
                    showToast('success', 'Срок обновлён');
                    closeModal('expiryModal');
                    refreshContainerById('keys-tbody');
                } else { showToast('danger', 'Ошибка'); }
            } catch (_) { showToast('danger', 'Ошибка сети'); }
        });
        const searchInput = document.getElementById('keys-search');
        if (searchInput) {
            let searchTimeout = null;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    const tbody = document.getElementById('keys-tbody');
                    if (!tbody) return;

                    const url = new URL(tbody.getAttribute('data-fetch-url'), location.origin);
                    url.searchParams.set('q', searchInput.value || '');
                    url.searchParams.set('page', '1');

                    try {
                        const resp = await fetch(url, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                        if (resp.ok) {
                            tbody.innerHTML = await resp.text();

                            const pagEl = document.getElementById('keys-pagination');
                            if (pagEl) {
                                const pagUrl = new URL(pagEl.getAttribute('data-src'), location.origin);
                                pagUrl.searchParams.set('q', searchInput.value || '');
                                pagUrl.searchParams.set('page', '1');
                                const r2 = await fetch(pagUrl, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                                if (r2.ok) {
                                    pagEl.innerHTML = await r2.text();
                                    pagEl.setAttribute('data-src', pagUrl.toString());
                                }
                            }
                        }
                    } catch (e) { console.error(e); }
                }, 400);
            });
        }

    })();
</script>
{% endblock %}