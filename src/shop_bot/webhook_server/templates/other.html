{% extends "base.html" %}

{% block title %}Прочее - Панель управления{% endblock %}

{% block content %}

<div class="mb-8 flex items-center justify-between">
    <div class="space-y-1">
        <h2 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
            Прочее
            <span
                class="px-2 py-0.5 rounded-md bg-primary/10 text-primary text-[10px] font-semibold uppercase tracking-widest border border-primary/20">Advanced</span>
        </h2>
        <p class="text-white/40 text-xs font-medium uppercase tracking-[0.2em] ml-1">Дополнительные функции и системные
            настройки</p>
    </div>
</div>

<div class="relative mb-10">
    <div
        class="bg-white/5 border border-white/10 rounded-2xl p-1.5 shadow-2xl backdrop-blur-xl overflow-x-auto no-scrollbar">
        <nav class="flex items-center gap-1 min-w-max" id="other-nav">
            {% for item in [
            {'id': 'broadcast', 'label': 'Рассылка', 'icon': 'send'},
            {'id': 'promo', 'label': 'Промо коды', 'icon': 'confirmation_number'},
            {'id': 'servers', 'label': 'Сервера', 'icon': 'dns'},
            {'id': 'logs', 'label': 'Логи Бота', 'icon': 'article'},
            {'id': 'remnawave', 'label': 'Remnawave', 'icon': 'graphic_eq'}
            ] %}
            <button type="button" data-tab="{{ item.id }}"
                class="tab-btn px-6 py-3 rounded-xl text-[11px] font-bold uppercase tracking-widest transition-all duration-300 flex items-center gap-2.5 hover:border-white/20 border border-transparent">
                <span class="material-symbols-outlined text-lg">{{ item.icon }}</span>
                {{ item.label }}
            </button>
            {% endfor %}
        </nav>
    </div>
</div>

<section id="tab-broadcast" class="tab-content">
    <div class="space-y-6">
        <!-- Header Card -->
        <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                    <span class="material-symbols-outlined text-3xl">campaign</span>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-white tracking-tight">Создать рассылку</h3>
                    <p class="text-white/60 text-xs font-medium">Массовая отправка сообщений и управление аудиторией</p>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {% for card in [
            {'label': 'Всего пользователей', 'val_id': 'stat-total', 'icon': 'groups', 'color': 'primary'},
            {'label': 'С активными ключами', 'val_id': 'stat-with-keys', 'icon': 'vpn_key', 'color': 'primary'},
            {'label': 'С истекшими ключами', 'val_id': 'stat-expired-keys', 'icon': 'timer_off', 'alpha': 'red-400'},
            {'label': 'Не использовали пробный', 'val_id': 'stat-no-trial', 'icon': 'new_releases', 'color': 'primary'}
            ] %}
            <div
                class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md group hover:border-primary/40 transition-all duration-300">
                <div class="flex items-center gap-3 mb-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-{{ card.alpha or card.color }}/10 flex items-center justify-center text-{{ card.alpha or card.color }}">
                        <span class="material-symbols-outlined text-xl">{{ card.icon }}</span>
                    </div>
                    <p class="text-white/40 text-[10px] uppercase font-bold tracking-widest leading-tight">{{ card.label
                        }}</p>
                </div>
                <p class="text-2xl font-bold text-white tracking-tight" id="{{ card.val_id }}">-</p>
            </div>
            {% endfor %}
        </div>

        <!-- Results Card -->
        <div class="bg-white/5 border border-white/10 rounded-2xl p-1.5 shadow-2xl backdrop-blur-xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-xl">insights</span>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-white">Последние результаты</h3>
                        <p class="text-white/40 text-[10px] font-medium uppercase tracking-[0.1em] mt-0.5"
                            id="result-time">Время не определено</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    {% for res in [
                    {'l': 'Отправлено', 'id': 'result-sent', 'icon': 'check_circle', 'color': 'primary'},
                    {'l': 'Заблокировали', 'id': 'result-failed', 'icon': 'block', 'color': 'red-400'},
                    {'l': 'В ЧС (забанены)', 'id': 'result-skipped', 'icon': 'person_off', 'color': 'yellow-500'},
                    {'l': 'Всего в ЧС (У нас)', 'id': 'stat-banned-count', 'icon': 'playlist_remove', 'color':
                    'white/20'}
                    ] %}
                    <div class="bg-black/20 border border-white/5 rounded-2xl p-4 flex flex-col gap-2">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-{{ res.color }} text-sm">{{ res.icon }}</span>
                            <p class="text-white/40 text-[9px] uppercase font-bold tracking-wider">{{ res.l }}</p>
                        </div>
                        <p class="text-xl font-bold text-white" id="{{ res.id }}">0</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Form Card -->
        <div
            class="bg-white/5 border border-white/10 rounded-3xl p-1.5 shadow-2xl backdrop-blur-xl overflow-hidden relative group hover:border-primary/30 transition-all duration-500">
            <div
                class="absolute -top-24 -right-24 w-64 h-64 bg-primary/5 blur-[100px] rounded-full pointer-events-none transition-all duration-700">
            </div>

            <div class="p-6 relative z-10">
                <form id="broadcast-form">
                    <div class="mb-8 group/textarea">
                        <div class="flex items-center justify-between mb-2 px-1">
                            <label class="block text-[10px] uppercase tracking-[0.2em] text-white/40 font-bold">Текст
                                сообщения</label>
                            <div class="flex items-center gap-2">
                                <div id="broadcast-themes-container" class="flex items-center gap-1.5 mr-1">
                                    <!-- Templates will be loaded here -->
                                </div>
                                <button type="button" onclick="openModal('newMessageModal')"
                                    class="text-primary hover:text-white px-2 py-1 rounded-lg border border-primary/30 font-bold transition-all flex items-center justify-center"
                                    title="Сохранить как шаблон">
                                    <span class="material-symbols-outlined text-sm">add</span>
                                </button>
                                <button type="button" id="btn-preview"
                                    class="text-[10px] text-primary hover:text-white px-3 py-1 rounded-lg border border-primary/30 font-bold uppercase tracking-widest transition-all flex items-center gap-1.5">
                                    <span class="material-symbols-outlined text-sm">visibility</span>
                                    Предпросмотр
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <textarea id="broadcast-text" rows="6"
                                class="w-full bg-black/30 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white placeholder:text-white/20 focus:outline-none focus:ring-1 focus:ring-primary/40 focus:border-primary/40 transition-all shadow-inner resize-y min-h-[160px]"
                                placeholder="Введите ваше сообщение здесь..."></textarea>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 mt-3 px-2">
                            <span
                                class="text-[9px] text-white/30 font-bold uppercase tracking-widest mr-2">Форматирование:</span>
                            <button type="button" onclick="insertTag('b')"
                                class="px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 hover:text-white text-white/60 text-xs font-bold transition-all"
                                title="Жирный">B</button>
                            <button type="button" onclick="insertTag('i')"
                                class="px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 hover:text-white text-white/60 text-xs italic font-bold transition-all"
                                title="Курсив">I</button>
                            <button type="button" onclick="insertTag('u')"
                                class="px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 hover:text-white text-white/60 text-xs underline font-bold transition-all"
                                title="Подчеркнутый">U</button>
                            <button type="button" onclick="insertTag('s')"
                                class="px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 hover:text-white text-white/60 text-xs line-through font-bold transition-all"
                                title="Зачеркнутый">S</button>
                            <button type="button" onclick="insertTag('tg-spoiler')"
                                class="px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 hover:text-white text-white/60 text-xs font-bold transition-all"
                                title="Спойлер">Spoiler</button>
                            <button type="button" onclick="insertTag('a')"
                                class="px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 hover:text-white text-white/60 text-xs font-bold transition-all flex items-center gap-1"
                                title="Ссылка"><span class="material-symbols-outlined text-[14px]">link</span></button>
                            <button type="button" onclick="insertTag('code')"
                                class="px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 hover:text-white text-white/60 text-xs font-mono font-bold transition-all"
                                title="Моноширинный">Code</button>
                            <button type="button" onclick="insertTag('pre')"
                                class="px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 hover:text-white text-white/60 text-xs font-mono font-bold transition-all"
                                title="Блок кода">Pre</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Media Upload -->
                        <div class="bg-black/20 rounded-2xl p-5 border border-white/5 flex flex-col">
                            <label
                                class="block text-[10px] uppercase tracking-[0.2em] text-white/40 font-bold mb-4 ml-1">Медиа
                                контент</label>
                            <div class="flex flex-col gap-4 h-full">
                                <input type="file" id="media-input" accept="image/*,video/*,.gif" class="hidden" />
                                <button type="button" id="btn-upload-media"
                                    class="w-full h-full min-h-[120px] border-2 border-dashed border-white/10 rounded-2xl p-6 hover:border-primary/40 transition-all group/upload text-center flex flex-col items-center justify-center">
                                    <div
                                        class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mb-3 transition-all">
                                        <span
                                            class="material-symbols-outlined text-2xl text-white/30 transition-colors">cloud_upload</span>
                                    </div>
                                    <p class="text-xs font-semibold text-white/50 transition-colors">Перетащите или
                                        выберите файл</p>
                                    <p class="text-[9px] text-white/20 mt-1 uppercase tracking-widest">IMG, VIDEO, GIF
                                    </p>
                                </button>
                                <div id="media-preview"
                                    class="hidden relative rounded-2xl overflow-hidden border border-white/10 bg-black/40">
                                    <img id="media-preview-img" src="" class="w-full h-48 object-cover hidden" />
                                    <video id="media-preview-video" controls
                                        class="w-full h-48 bg-black hidden"></video>
                                    <button type="button" id="btn-remove-media"
                                        class="absolute top-3 right-3 w-8 h-8 rounded-xl bg-black/60 text-white hover:text-red-500 flex items-center justify-center transition-all backdrop-blur-md border border-white/10">
                                        <span class="material-symbols-outlined text-base">close</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Keyboard -->
                        <div class="bg-black/20 rounded-2xl p-5 border border-white/5 flex flex-col">
                            <label
                                class="block text-[10px] uppercase tracking-[0.2em] text-white/40 font-bold mb-4 ml-1">Клавиатура</label>
                            <div id="buttons-list"
                                class="space-y-2 mb-3 flex-1 overflow-y-auto max-h-[200px] pr-1 custom-scrollbar"></div>
                            <button type="button" id="btn-add-button"
                                class="w-full py-3.5 rounded-xl bg-white/5 hover:border-white/30 border border-white/10 text-white text-[11px] font-bold uppercase tracking-widest transition-all flex items-center justify-center gap-2 mt-auto">
                                <span class="material-symbols-outlined text-lg">add_circle</span>
                                Добавить кнопку
                            </button>
                        </div>
                    </div>

                    <!-- Additional Options -->
                    <div
                        class="mb-8 bg-black/40 rounded-2xl p-4 border border-white/5 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                        <label class="flex items-center gap-4 cursor-pointer group select-none">
                            <div class="relative">
                                <input type="checkbox" id="skip-banned-toggle" class="peer sr-only">
                                <div
                                    class="w-12 h-7 bg-white/10 rounded-full peer peer-focus:ring-2 peer-focus:ring-primary/20 peer-checked:after:translate-x-[20px] peer-checked:after:border-white after:content-[''] after:absolute after:top-1 after:left-[4px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary transition-all">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-white transition-colors">Пропускать
                                    черный список</span>
                                <span class="text-[10px] text-white/40 uppercase tracking-tighter">Не отправлять
                                    заблокированным пользователям</span>
                            </div>
                        </label>
                        <button type="button" id="btn-clear-banned"
                            class="px-4 py-2 rounded-xl bg-red-500/10 hover:border-red-500 text-red-400 text-[10px] font-bold uppercase tracking-widest border border-red-500/20 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">delete_sweep</span>
                            Очистить список ЧС
                        </button>
                    </div>

                    <!-- Audience Selection -->
                    <div class="mb-10">
                        <label
                            class="block text-[10px] uppercase tracking-[0.2em] text-white/40 font-bold mb-5 ml-1">Аудитория
                            рассылки</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {% for mode in [
                            {'v': 'all', 'l': 'Все пользователи', 's': 'Массовая рассылка', 'i': 'groups', 'checked':
                            true},
                            {'v': 'with_keys', 'l': 'Активные ключи', 's': 'С действующей подпиской', 'i': 'vpn_key'},
                            {'v': 'expired_keys', 'l': 'Истекшие ключи', 's': 'Напоминание о продлении', 'i':
                            'timer_off'},
                            {'v': 'without_trial', 'l': 'Использовали триал', 's': 'Уже знакомы с сервисом', 'i':
                            'new_releases'},
                            {'v': 'not_used_trial', 'l': 'Не использовали триал', 's': 'Новые потенциальные клиенты',
                            'i': 'history_toggle_off'},
                            {'v': 'test', 'l': 'Тестовый режим', 's': 'Только себе (админам)', 'i': 'bug_report'}
                            ] %}
                            <label class="relative cursor-pointer group">
                                <input type="radio" name="mode" value="{{ mode.v }}" {{ 'checked' if mode.checked
                                    else '' }} class="peer sr-only" />
                                <div
                                    class="h-full flex items-center gap-4 p-4 rounded-2xl border border-white/10 bg-black/20 transition-all duration-300 peer-checked:bg-primary/10 peer-checked:border-primary/50 hover:border-primary/30">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-white/30 peer-checked:group-[]:bg-primary/20 peer-checked:group-[]:text-primary transition-all">
                                        <span class="material-symbols-outlined text-xl">{{ mode.i }}</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm font-bold text-white tracking-tight">{{ mode.l }}</div>
                                        <div class="text-[10px] text-white/40 uppercase tracking-widest mt-0.5">{{
                                            mode.s
                                            }}</div>
                                    </div>
                                    <div
                                        class="w-4 h-4 rounded-full border border-white/20 peer-checked:group-[]:border-primary flex items-center justify-center transition-all">
                                        <div
                                            class="w-1.5 h-1.5 rounded-full bg-primary opacity-0 peer-checked:group-[]:opacity-100 transition-opacity shadow-[0_0_8px_rgba(var(--primary-rgb),0.6)]">
                                        </div>
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>

                        <!-- Special Mode: Expiring Keys -->
                        <div class="mt-4">
                            <label class="relative cursor-pointer group">
                                <input type="radio" name="mode" value="expiring_keys" class="peer sr-only" />
                                <div
                                    class="flex items-center gap-4 p-4 rounded-2xl border border-white/10 bg-black/20 transition-all duration-300 peer-checked:bg-primary/10 peer-checked:border-primary/50 hover:border-primary/30">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-white/30 peer-checked:group-[]:bg-primary/20 peer-checked:group-[]:text-primary transition-all">
                                        <span class="material-symbols-outlined text-xl">schedule</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm font-bold text-white tracking-tight">Срок скоро истекает
                                        </div>
                                        <div class="text-[10px] text-white/40 uppercase tracking-widest mt-0.5">
                                            Уведомление о скором завершении действия ключа</div>
                                    </div>
                                    <div
                                        class="w-4 h-4 rounded-full border border-white/20 peer-checked:group-[]:border-primary flex items-center justify-center transition-all">
                                        <div
                                            class="w-1.5 h-1.5 rounded-full bg-primary opacity-0 peer-checked:group-[]:opacity-100 transition-opacity shadow-[0_0_8px_rgba(var(--primary-rgb),0.6)]">
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div id="expiring-days-selector"
                            class="mt-6 hidden animate-in fade-in slide-in-from-top-4 duration-300">
                            <label
                                class="block text-[10px] uppercase tracking-[0.2em] text-white/40 font-bold mb-4 ml-1">Выберите
                                количество дней</label>
                            <div class="grid grid-cols-4 gap-4">
                                {% for day in [1, 3, 5, 10] %}
                                <label class="relative cursor-pointer group">
                                    <input type="radio" name="expiring_days" value="{{ day }}" {{ 'checked' if day==3
                                        else '' }} class="peer sr-only" />
                                    <div
                                        class="h-14 flex items-center justify-center rounded-xl border border-white/10 bg-black/20 transition-all peer-checked:bg-primary/20 peer-checked:border-primary/40 hover:border-primary/40">
                                        <span id="expiring-label-{{ day }}"
                                            class="text-xs font-bold text-white group-hover:text-primary transition-colors">{{
                                            day }} {{ 'день' if day == 1 else 'дня' if day < 5 else 'дней' }} <span
                                                class="text-white/50">(0)</span></span>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="btn-send"
                        class="w-full flex items-center justify-center gap-3 px-8 py-4 rounded-2xl bg-primary text-background-dark font-bold uppercase tracking-widest shadow-[0_0_30px_rgba(19,236,128,0.2)] hover:shadow-[0_0_40px_rgba(19,236,128,0.4)] active:scale-95 transition-all duration-300 group">
                        <span
                            class="material-symbols-outlined text-2xl group-hover:rotate-12 transition-transform">send</span>
                        <span>Запустить рассылку</span>
                    </button>
                </form>

                <!-- Progress Container -->
                <div id="broadcast-progress-container" class="mt-8 hidden animate-in fade-in zoom-in duration-500">
                    <div class="bg-black/40 border border-white/10 rounded-2xl p-6 backdrop-blur-md">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full bg-primary animate-pulse"></div>
                                <h4 class="text-white font-bold text-sm tracking-tight">Выполняется рассылка...</h4>
                            </div>
                            <span id="broadcast-progress-percent"
                                class="text-primary font-mono font-bold text-lg">0%</span>
                        </div>

                        <div class="w-full bg-white/5 rounded-full h-2 overflow-hidden mb-6">
                            <div id="broadcast-progress-bar"
                                class="h-full bg-gradient-to-r from-primary via-emerald-400 to-primary background-animate rounded-full transition-all duration-500 ease-out shadow-[0_0_15px_rgba(var(--primary-rgb),0.4)]"
                                style="width: 0%"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                            {% for stat in [
                            {'l': 'Отправлено', 'id': 'broadcast-progress-sent', 'color': 'emerald-400'},
                            {'l': 'Ошибок', 'id': 'broadcast-progress-failed', 'color': 'red-400'},
                            {'l': 'Пропущено', 'id': 'broadcast-progress-skipped', 'color': 'yellow-500'}
                            ] %}
                            <div class="bg-white/5 rounded-xl py-3 px-1 text-center border border-white/5">
                                <p class="text-[8px] text-white/30 uppercase font-black tracking-widest mb-1">{{ stat.l
                                    }}</p>
                                <p class="text-{{ stat.color }} font-mono font-bold text-base" id="{{ stat.id }}">0</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="tab-promo" class="tab-content hidden">

    <div
        class="relative overflow-hidden rounded-2xl bg-white/5 border border-white/10 shadow-2xl backdrop-blur-xl mb-8 group hover:border-primary/30 transition-all duration-500">
        <div
            class="absolute -top-24 -right-24 w-48 h-48 bg-primary/5 blur-[80px] rounded-full pointer-events-none transition-all duration-500">
        </div>

        <div class="p-5 sm:p-6 relative z-10">
            <form id="promo-create-form" autocomplete="off">

                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <div class="p-2 rounded-lg bg-primary/10 text-primary">
                            <span class="material-symbols-outlined text-2xl">local_activity</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-white leading-tight">Создать промокод</h2>
                            <p class="text-xs text-white/50 font-medium">Скидки и специальные предложения</p>
                        </div>
                    </div>

                    <div class="bg-black/40 p-1 rounded-xl flex w-full sm:w-auto overflow-hidden relative shadow-inner border border-white/5"
                        id="promo_mode_switch">
                        <div class="absolute inset-y-1 w-[calc(50%-4px)] bg-primary rounded-lg shadow-lg shadow-primary/20 transition-all duration-300 ease-out"
                            id="promo_mode_indicator"></div>

                        <label class="relative z-10 flex-1 sm:flex-none cursor-pointer">
                            <input type="radio" name="code_mode" value="auto" checked class="peer sr-only">
                            <div class="px-6 py-2 rounded-lg text-sm font-bold transition-colors duration-200 text-[#102219] w-full sm:w-36 text-center peer-checked:text-[#102219] text-white/60 hover:text-white peer-checked:hover:text-[#102219]"
                                onclick="movePromoIndicator(0)">
                                Случайный
                            </div>
                        </label>
                        <label class="relative z-10 flex-1 sm:flex-none cursor-pointer">
                            <input type="radio" name="code_mode" value="manual" class="peer sr-only">
                            <div class="px-6 py-2 rounded-lg text-sm font-bold transition-colors duration-200 text-white/60 w-full sm:w-36 text-center hover:text-white peer-checked:text-[#102219]"
                                onclick="movePromoIndicator(1)">
                                Свой код
                            </div>
                        </label>
                    </div>
                </div>

                <div id="manual-code-field" class="mode-section hidden mb-4">
                    <label
                        class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Код</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within/input:text-primary transition-colors">tag</span>
                        <input type="text" name="code"
                            class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all shadow-inner uppercase font-mono"
                            placeholder="PROMO2025" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

                    <div class="relative group/input lg:col-span-1">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Скидка</label>
                        <div class="flex">
                            <input type="number" name="discount_value" step="0.01" min="0" required
                                class="w-full bg-black/20 border border-white/10 rounded-l-xl border-r-0 px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all shadow-inner"
                                placeholder="10" />
                            <div class="soft-select relative min-w-[90px]" data-target="discount_type_select">
                                <button type="button"
                                    class="soft-select-toggle h-full w-full bg-black/30 border border-white/10 rounded-r-xl border-l-[0px] px-3 py-3 text-sm text-white font-bold hover:bg-black/40 transition-colors flex items-center justify-between">
                                    %
                                </button>
                                <div class="soft-select-menu"></div>
                                <select name="discount_type" id="discount_type_select" class="hidden">
                                    <option value="percent">%</option>
                                    <option value="fixed">RUB</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="relative group/input lg:col-span-1">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Всего
                            активаций</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg">groups</span>
                            <input type="number" name="usage_limit_total" min="1"
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all shadow-inner"
                                placeholder="∞" />
                        </div>
                    </div>

                    <div class="relative group/input lg:col-span-1">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Лимит
                            на юзера</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg">person</span>
                            <input type="number" name="usage_limit_per_user" min="1"
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all shadow-inner"
                                placeholder="1" />
                        </div>
                    </div>

                    <div class="relative group/input lg:col-span-1">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Период
                            действия с</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg">event_available</span>
                            <input type="datetime-local" name="valid_from" id="promo_valid_from"
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-2 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all shadow-inner"
                                placeholder="Начало" />
                        </div>
                    </div>

                    <div class="relative group/input lg:col-span-1">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">до</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg">event_busy</span>
                            <input type="datetime-local" name="valid_until" id="promo_valid_until"
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-2 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all shadow-inner"
                                placeholder="Конец" />
                        </div>
                    </div>

                    <div class="col-span-1 md:col-span-2 lg:col-span-1">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1.5 ml-1">Описание</label>
                        <input type="text" name="description" placeholder="Заметка для администратора..."
                            class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all shadow-inner" />
                    </div>
                </div>

                <button type="submit"
                    class="mt-6 w-full flex items-center justify-center gap-3 px-8 py-4 rounded-2xl bg-primary text-background-dark font-bold uppercase tracking-widest shadow-[0_0_30px_rgba(19,236,128,0.2)] hover:shadow-[0_0_40px_rgba(19,236,128,0.4)] active:scale-95 transition-all duration-300 group">
                    <span
                        class="material-symbols-outlined text-2xl group-hover:rotate-12 transition-transform">add_circle</span>
                    <span>Создать промокод</span>
                </button>
            </form>
        </div>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-2xl p-1.5 shadow-2xl backdrop-blur-xl">
        <div class="p-6">
            <h3 class="text-base font-bold text-white mb-6 flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-lg">list_alt</span>
                </div>
                Существующие промокоды
            </h3>

            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-white/5">
                        <tr>
                            <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Код</th>
                            <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Скидка</th>
                            <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">
                                Использовано
                            </th>
                            <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Лимиты</th>
                            <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Срок
                                действия
                            </th>
                            <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">Статус</th>
                            <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70 text-right">
                                Действия</th>
                        </tr>
                    </thead>
                    <tbody id="promo-table-body" class="divide-y divide-white/10">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-white/50">Загрузка...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
</section>

<div id="editPromoModal" class="modal-overlay">
    <div class="modal-content !max-w-3xl">
        <div class="p-6 border-b border-white/10 flex items-center justify-between bg-white/[0.02]">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                    <span class="material-symbols-outlined text-2xl">edit_document</span>
                </div>
                <div>
                    <h5 class="text-white font-bold tracking-tight">Редактировать промокод</h5>
                    <p class="text-[10px] text-white/40 uppercase tracking-widest font-medium">Обновление условий акции
                    </p>
                </div>
            </div>
            <button onclick="closeModal('editPromoModal')"
                class="w-10 h-10 rounded-xl bg-white/5 text-white/50 hover:text-white hover:bg-white/10 flex items-center justify-center transition-all">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <form id="promo-edit-form" autocomplete="off">
                <input type="hidden" id="edit-promo-code" name="code" />

                <div class="mb-6 group/input">
                    <label class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2 ml-1">Код
                        (только для чтения)</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-lg">tag</span>
                        <input type="text" id="edit-code-display" readonly
                            class="w-full bg-black/40 border border-white/5 rounded-xl pl-10 pr-4 py-3 text-sm text-white/40 font-mono uppercase cursor-not-allowed italic" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="group/input">
                        <label class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2 ml-1">Тип
                            скидки</label>
                        <div class="grid grid-cols-2 gap-2 p-1 bg-black/40 rounded-xl border border-white/5">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="edit_discount_type" value="percent" class="peer sr-only" />
                                <div
                                    class="py-2.5 text-center text-xs font-bold rounded-lg transition-all peer-checked:bg-primary peer-checked:text-background-dark text-white/40 hover:text-white">
                                    % Процент</div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="edit_discount_type" value="fixed" class="peer sr-only" />
                                <div
                                    class="py-2.5 text-center text-xs font-bold rounded-lg transition-all peer-checked:bg-primary peer-checked:text-background-dark text-white/40 hover:text-white">
                                    RUB Фикс.</div>
                            </label>
                        </div>
                    </div>

                    <div class="group/input">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2 ml-1">Значение
                            скидки</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within/input:text-primary transition-all">payments</span>
                            <input type="number" name="edit_discount_value" step="0.01" min="0" required
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all shadow-inner" />
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="group/input">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2 ml-1">Всего
                            активаций</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within/input:text-primary transition-all">groups</span>
                            <input type="number" name="edit_usage_limit_total" min="1"
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all shadow-inner" />
                        </div>
                    </div>

                    <div class="group/input">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2 ml-1">Лимит
                            на юзера</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within/input:text-primary transition-all">person</span>
                            <input type="number" name="edit_usage_limit_per_user" min="1"
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all shadow-inner" />
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="group/input">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2 ml-1">Действует
                            с</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within/input:text-primary transition-all">event_available</span>
                            <input type="datetime-local" name="edit_valid_from"
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-2 py-3 text-sm text-white focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all shadow-inner" />
                        </div>
                    </div>

                    <div class="group/input">
                        <label
                            class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2 ml-1">Действует
                            до</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within/input:text-primary transition-all">event_busy</span>
                            <input type="datetime-local" name="edit_valid_until"
                                class="w-full bg-black/20 border border-white/10 rounded-xl pl-10 pr-2 py-3 text-sm text-white focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all shadow-inner" />
                        </div>
                    </div>
                </div>

                <div class="mb-8 group/input">
                    <label class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2 ml-1">Описание
                        (заметка)</label>
                    <textarea name="edit_description" rows="2"
                        class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder:text-white/20 focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all shadow-inner resize-none"
                        placeholder="Краткое описание для истории..."></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('editPromoModal')"
                        class="flex-1 px-8 py-4 rounded-2xl bg-white/5 border border-white/10 text-white font-bold uppercase tracking-widest text-xs hover:bg-white/10 transition-all">
                        Отмена
                    </button>
                    <button type="submit"
                        class="flex-[2] flex items-center justify-center gap-3 px-8 py-4 rounded-2xl bg-primary text-background-dark font-bold uppercase tracking-widest shadow-[0_0_30px_rgba(19,236,128,0.2)] hover:shadow-[0_0_40px_rgba(19,236,128,0.4)] active:scale-95 transition-all duration-300">
                        <span class="material-symbols-outlined text-xl">save</span>
                        <span>Сохранить изменения</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="deployNodeModal" class="modal-overlay">
    <div class="modal-content max-w-4xl rounded-xl bg-[#0a1812] border border-white/10 shadow-2xl overflow-hidden">
        <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-white/[0.02]">
            <div class="flex items-center gap-3">
                <div
                    class="w-9 h-9 rounded-lg bg-gradient-to-br from-primary/30 to-emerald-500/10 flex items-center justify-center border border-primary/30">
                    <span class="material-symbols-outlined text-primary text-lg">rocket_launch</span>
                </div>
                <div>
                    <h5 class="text-white font-semibold text-sm">Развертывание Ноды</h5>
                    <p class="text-white/40 text-[10px] font-mono" id="deploy-target-name">—</p>
                </div>
            </div>
            <button onclick="closeModal('deployNodeModal')"
                class="w-8 h-8 rounded-lg bg-white/5 hover:border-white/20 flex items-center justify-center text-white/50 hover:text-white transition-all">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
        </div>
        <div class="p-5 max-h-[70vh] overflow-y-auto">

            <div class="mb-5 bg-white/[0.02] rounded-xl p-4 border border-white/[0.06]">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] uppercase tracking-wider text-white/40 font-bold">Шаг</span>
                        <span class="text-white font-bold text-sm" id="deploy-current-step">1</span>
                        <span class="text-white/30 text-sm">/</span>
                        <span class="text-white/50 text-sm">5</span>
                    </div>
                    <span class="text-primary text-xs font-medium px-2.5 py-1 bg-primary/10 rounded-full"
                        id="deploy-step-name">Установка Docker</span>
                </div>
                <div class="w-full bg-white/5 rounded-full h-1.5 overflow-hidden">
                    <div id="deploy-progress-bar"
                        class="h-full bg-gradient-to-r from-primary to-emerald-400 transition-all duration-500"
                        style="width: 20%"></div>
                </div>
            </div>

            <div id="deploy-step-1" class="deploy-step">
                <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-4 mb-4">
                    <h6 class="text-white font-medium text-sm mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-400 text-lg">package_2</span>
                        Установка Docker
                    </h6>
                    <p class="text-white/50 text-xs mb-4">
                        Выберите вашу операционную систему для установки Docker:
                    </p>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-black/20 border border-white/[0.06] rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-white font-medium text-xs">Ubuntu</span>
                            </div>
                            <button id="btn-install-docker-ubuntu" data-os="ubuntu" disabled
                                class="install-docker-btn w-full px-3 py-2 rounded-lg bg-white/5 hover:border-primary/40 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="animate-spin h-3.5 w-3.5 btn-icon" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4" fill="none"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span class="btn-text">Проверка...</span>
                            </button>
                        </div>

                        <div class="bg-black/20 border border-white/[0.06] rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-white font-medium text-xs">Debian</span>
                            </div>
                            <button id="btn-install-docker-debian" data-os="debian" disabled
                                class="install-docker-btn w-full px-3 py-2 rounded-lg bg-white/5 hover:border-primary/40 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="animate-spin h-3.5 w-3.5 btn-icon" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4" fill="none"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span class="btn-text">Проверка...</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-amber-500/5 border border-amber-500/20 rounded-lg p-3">
                        <p class="text-amber-300/80 text-[11px] flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">schedule</span>
                            <span>Установка Docker занимает <strong>2-5 минут</strong></span>
                        </p>
                    </div>
                </div>
            </div>

            <div id="deploy-step-2" class="deploy-step hidden">
                <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-4 mb-4">
                    <h6 class="text-white font-medium text-sm mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-purple-400 text-lg">folder</span>
                        Создание директории
                    </h6>
                    <p class="text-white/50 text-xs mb-4">
                        Директория: <code
                            class="bg-black/30 px-2 py-0.5 rounded text-primary text-[11px]">/opt/remnanode</code>
                    </p>
                    <button id="btn-create-directory"
                        class="px-4 py-2 rounded-lg bg-white/5 hover:border-primary/40 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all">
                        Создать директорию
                    </button>
                </div>
            </div>

            <div id="deploy-step-3" class="deploy-step hidden">
                <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-4 mb-4">
                    <h6 class="text-white font-medium text-sm mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-yellow-400 text-lg">edit_document</span>
                        Файл docker-compose.yml
                    </h6>
                    <textarea id="docker-compose-content" rows="10"
                        class="w-full bg-black/30 border border-white/[0.06] rounded-lg px-4 py-3 text-white font-mono text-xs placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all"
                        placeholder="version: '3.8'&#10;services:&#10;  remnanode:&#10;    image: remnawave/node:latest&#10;    container_name: remnanode&#10;    restart: always&#10;    network_mode: host&#10;    environment:&#10;      - PANEL_URL=https://your-panel.com&#10;      - PANEL_KEY=your-key"></textarea>
                    <div class="flex gap-2 mt-3">
                        <button id="btn-cancel-compose"
                            class="flex-1 px-4 py-2 rounded-lg bg-white/5 hover:border-white/20 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all">
                            Назад
                        </button>
                        <button id="btn-save-compose"
                            class="flex-1 px-4 py-2 rounded-lg bg-white/5 hover:border-primary/40 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all">
                            Сохранить
                        </button>
                    </div>
                </div>
            </div>

            <div id="deploy-step-4" class="deploy-step hidden">
                <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-4 mb-4">
                    <h6 class="text-white font-medium text-sm mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-emerald-400 text-lg">play_circle</span>
                        Запуск контейнеров
                    </h6>
                    <p class="text-white/50 text-xs mb-4">
                        Команда: <code
                            class="bg-black/30 px-2 py-0.5 rounded text-primary text-[11px]">docker compose up -d</code>
                    </p>
                    <button id="btn-start-containers"
                        class="px-4 py-2 rounded-lg bg-white/5 hover:border-primary/40 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all">
                        Запустить
                    </button>
                </div>
            </div>

            <div id="deploy-step-5" class="deploy-step hidden">
                <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-4 mb-4">
                    <h6 class="text-white font-medium text-sm mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-orange-400 text-lg">settings</span>
                        Управление нодой
                    </h6>
                    <p class="text-white/50 text-xs mb-4">
                        Нода развернута! Доступные действия:
                    </p>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button id="btn-view-compose"
                            class="px-3 py-2 rounded-lg bg-white/5 hover:border-white/20 border border-white/10 text-white/70 hover:text-white text-[11px] font-medium flex items-center justify-center gap-1.5 transition-all">
                            <span class="material-symbols-outlined text-sm">visibility</span>
                            Compose
                        </button>
                        <button id="btn-restart-node"
                            class="px-3 py-2 rounded-lg bg-amber-500/10 hover:border-amber-500/40 border border-amber-500/20 text-amber-400 text-[11px] font-medium flex items-center justify-center gap-1.5 transition-all">
                            <span class="material-symbols-outlined text-sm">restart_alt</span>
                            Рестарт
                        </button>
                        <button id="btn-view-logs"
                            class="px-3 py-2 rounded-lg bg-blue-500/10 hover:border-blue-500/40 border border-blue-500/20 text-blue-400 text-[11px] font-medium flex items-center justify-center gap-1.5 transition-all">
                            <span class="material-symbols-outlined text-sm">description</span>
                            Логи
                        </button>
                    </div>
                    <button id="btn-remove-all"
                        class="w-full px-3 py-2 rounded-lg bg-red-500/10 hover:border-red-500/40 border border-red-500/20 text-red-400 text-[11px] font-medium flex items-center justify-center gap-1.5 transition-all mb-2">
                        <span class="material-symbols-outlined text-sm">delete_forever</span>
                        Полное удаление ноды и Docker
                    </button>
                    <p class="text-red-400/50 text-[10px] text-center mb-4">⚠️ Это действие необратимо</p>
                    <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3">
                        <p class="text-emerald-400 text-xs font-medium flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">check_circle</span>
                            Развертывание завершено!
                        </p>
                    </div>
                </div>
            </div>

            <div class="rounded-xl bg-black/40 border border-white/[0.06] overflow-hidden">
                <div class="px-4 py-2.5 bg-white/[0.03] border-b border-white/[0.06] flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1.5">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500/60"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/60"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-green-500/60"></div>
                        </div>
                        <span class="text-[10px] text-white/30 font-medium ml-2">Вывод</span>
                    </div>
                    <button id="btn-clear-deploy-logs"
                        class="px-2.5 py-1 rounded-md bg-white/5 hover:border-white/20 text-white/50 hover:text-white text-[10px] font-medium flex items-center gap-1 transition-all">
                        <span class="material-symbols-outlined text-xs">delete</span>
                        Очистить
                    </button>
                </div>
                <div id="deploy-output"
                    class="p-4 font-mono text-xs text-emerald-400/90 max-h-52 overflow-y-auto whitespace-pre-wrap leading-relaxed selection:bg-emerald-500/30">
                    <span class="text-white/30">Ожидание действий...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="swapModal" class="modal-overlay">
    <div class="modal-content max-w-md rounded-xl bg-[#0a1812] border border-white/10 shadow-2xl overflow-hidden">
        <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-white/[0.02]">
            <div class="flex items-center gap-3">
                <div
                    class="w-9 h-9 rounded-lg bg-gradient-to-br from-purple-500/20 to-violet-500/10 flex items-center justify-center border border-purple-500/20">
                    <span class="material-symbols-outlined text-purple-400 text-lg">memory</span>
                </div>
                <div>
                    <h5 class="text-white font-semibold text-sm">Управление SWAP</h5>
                    <p class="text-white/40 text-[10px] font-mono" id="swap-target-name">—</p>
                </div>
            </div>
            <button onclick="closeModal('swapModal')"
                class="w-8 h-8 rounded-lg bg-white/5 hover:border-white/20 flex items-center justify-center text-white/50 hover:text-white transition-all">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
        </div>
        <div class="p-5">
            <div id="swap-loading" class="text-center py-6">
                <span
                    class="material-symbols-outlined animate-spin text-3xl text-purple-400 mb-2">progress_activity</span>
                <p class="text-white/40 text-xs">Получение информации о SWAP...</p>
            </div>

            <div id="swap-install-state" class="hidden">
                <div class="bg-amber-500/5 border border-amber-500/20 rounded-lg p-3 mb-4">
                    <p class="text-amber-300/80 text-[11px] flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">warning</span>
                        SWAP файл не обнаружен
                    </p>
                </div>
                <form id="swap-install-form">
                    <label class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2">Размер SWAP
                        (MB)</label>
                    <input type="number" name="size_mb" value="2048" min="512" step="512"
                        class="w-full bg-black/30 border border-white/[0.06] rounded-lg px-3 py-2.5 text-white text-sm placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-purple-500/50 focus:border-purple-500/50 transition-all mb-4" />
                    <button type="submit" id="btn-swap-install"
                        class="w-full px-4 py-2.5 rounded-lg bg-white/5 hover:border-primary/40 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">add_circle</span>
                        Установить SWAP
                    </button>
                </form>
            </div>

            <div id="swap-manage-state" class="hidden">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-white/[0.03] rounded-lg p-3 border border-white/[0.06]">
                        <p class="text-white/40 text-[10px] mb-1">Размер</p>
                        <p class="text-sm font-bold text-white flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-purple-400 text-sm">storage</span>
                            <span id="swap-display-size">—</span>
                        </p>
                    </div>
                    <div class="bg-white/[0.03] rounded-lg p-3 border border-white/[0.06]">
                        <p class="text-white/40 text-[10px] mb-1">Swappiness</p>
                        <p class="text-sm font-bold text-white flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-purple-400 text-sm">tune</span>
                            <span id="swap-display-swappiness">—</span> %
                        </p>
                    </div>
                    <div class="bg-white/[0.03] rounded-lg p-3 border border-white/[0.06]">
                        <p class="text-white/40 text-[10px] mb-1">Использовано (SWAP)</p>
                        <p class="text-sm font-bold text-white flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-amber-400 text-sm">data_usage</span>
                            <span id="swap-display-used">—</span>
                        </p>
                    </div>
                    <div class="bg-white/[0.03] rounded-lg p-3 border border-white/[0.06]">
                        <p class="text-white/40 text-[10px] mb-1">Использовано (RAM)</p>
                        <p class="text-sm font-bold text-white flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-blue-400 text-sm">memory</span>
                            <span id="swap-display-ram">—</span>
                        </p>
                    </div>
                </div>

                <div class="space-y-3">
                    <form id="swap-resize-form" class="bg-white/[0.03] rounded-lg p-3 border border-white/[0.06]">
                        <div class="flex items-center gap-2 mb-2">
                            <label class="text-white/50 text-[10px] font-medium">Изменить размер (MB)</label>
                            <div class="group relative flex items-center">
                                <span
                                    class="material-symbols-outlined text-white/30 text-xs cursor-help hover:text-white/70 transition-colors">info</span>
                                <div
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-52 p-2 bg-[#0a1812] border border-white/10 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 text-[10px] text-white/70">
                                    Система удалит старый файл и создаст новый указанного размера.
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" name="size_mb" id="swap-resize-input" min="512" step="512"
                                class="flex-1 bg-black/30 border border-white/[0.06] rounded-lg px-3 py-2 text-white text-xs focus:outline-none focus:ring-1 focus:ring-purple-500/50 transition-all" />
                            <button type="submit" id="btn-swap-resize"
                                class="px-3 py-2 rounded-lg bg-white/5 hover:border-white/30 border border-white/10 text-white/70 hover:text-white text-[10px] font-medium transition-all">
                                Изменить
                            </button>
                        </div>
                    </form>

                    <form id="swap-swappiness-form" class="bg-white/[0.03] rounded-lg p-3 border border-white/[0.06]">
                        <div class="flex items-center gap-2 mb-2">
                            <label class="text-white/50 text-[10px] font-medium">Swappiness (0-100%)</label>
                            <div class="group relative flex items-center">
                                <span
                                    class="material-symbols-outlined text-white/30 text-xs cursor-help hover:text-white/70 transition-colors">info</span>
                                <div
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-56 p-2 bg-[#0a1812] border border-white/10 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 text-[10px] text-white/70">
                                    <span class="text-emerald-400 font-bold">0-10%:</span> Мало используется, для
                                    БД.<br>
                                    <span class="text-purple-400 font-bold">60-100%:</span> Часто используется.
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" name="swappiness" id="swap-swappiness-input" min="0" max="100"
                                class="flex-1 bg-black/30 border border-white/[0.06] rounded-lg px-3 py-2 text-white text-xs focus:outline-none focus:ring-1 focus:ring-purple-500/50 transition-all" />
                            <button type="submit" id="btn-swap-swappiness"
                                class="px-3 py-2 rounded-lg bg-white/5 hover:border-white/30 border border-white/10 text-white/70 hover:text-white text-[10px] font-medium transition-all">
                                Применить
                            </button>
                        </div>
                    </form>

                    <button type="button" id="btn-swap-delete"
                        class="w-full px-3 py-2 rounded-lg bg-red-500/10 hover:border-red-500/40 border border-red-500/20 text-red-400 text-[11px] font-medium flex items-center justify-center gap-1.5 transition-all">
                        <span class="material-symbols-outlined text-sm">delete_forever</span>
                        Удалить SWAP
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="confirmDeleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content max-w-lg">
        <div class="p-6">
            <div class="flex items-center justify-center mb-4">
                <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-4xl text-red-400">warning</span>
                </div>
            </div>

            <h3 class="text-2xl font-bold text-white text-center mb-2">⚠️ ВНИМАНИЕ!</h3>
            <p class="text-white/70 text-center mb-6">Вы собираетесь выполнить необратимую операцию</p>

            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
                <p class="text-red-300 font-medium mb-3">Будет полностью удалено:</p>
                <ul class="space-y-2 text-red-200 text-sm">
                    <li class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">close</span>
                        Нода Remnawave и все её данные
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">close</span>
                        Docker полностью (все пакеты)
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">close</span>
                        Все контейнеры, образы и тома
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">close</span>
                        Конфигурационные файлы Docker
                    </li>
                </ul>
            </div>

            <div class="mb-6">
                <label class="text-white text-sm font-medium mb-2 block">
                    Для подтверждения введите название сервера: <span class="text-primary font-bold"
                        id="confirm-server-name"></span>
                </label>
                <input type="text" id="confirm-delete-input"
                    class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-red-500/50"
                    placeholder="Введите название сервера">
                <p class="text-white/50 text-xs mt-2">Регистр важен. Введите точное название без кавычек.</p>
            </div>

            <div class="flex gap-3">
                <button id="btn-cancel-delete"
                    class="flex-1 px-6 py-3 rounded-lg bg-white/10 text-white hover:bg-white/20 font-medium transition-colors">
                    Отмена
                </button>
                <button id="btn-confirm-delete"
                    class="flex-1 px-6 py-3 rounded-lg bg-red-500 text-white hover:bg-red-600 font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Удалить всё
                </button>
            </div>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content max-w-md">
        <div class="p-6">
            <div class="flex items-center justify-center mb-4">
                <div id="confirm-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center">
                    <span id="confirm-icon" class="material-symbols-outlined text-4xl"></span>
                </div>
            </div>

            <h3 id="confirm-title" class="text-xl font-bold text-white text-center mb-2"></h3>
            <p id="confirm-message" class="text-white/70 text-center mb-6 whitespace-pre-line"></p>

            <div class="flex gap-3">
                <button id="btn-confirm-cancel"
                    class="flex-1 px-6 py-3 rounded-lg bg-white/10 text-white hover:bg-white/20 font-medium transition-colors">
                    Отмена
                </button>
                <button id="btn-confirm-ok" class="flex-1 px-6 py-3 rounded-lg font-bold transition-colors">
                    Подтвердить
                </button>
            </div>
        </div>
    </div>
</div>

<section id="tab-remnawave" class="tab-content hidden">
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h3 class="text-xl font-bold text-white mb-4">Remnawave</h3>
        <p class="text-white/70 text-sm mb-6">Настройки панели Remnawave</p>
        <div class="bg-white/[0.02] border border-white/10 rounded-lg p-8 text-center">
            <span class="material-symbols-outlined text-4xl text-white/30 mb-2">settings_applications</span>
            <p class="text-white/50">Настройки Remnawave будут добавлены позже</p>
        </div>
    </div>
</section>

<section id="tab-servers" class="tab-content hidden">
    <div class="space-y-6">
        <!-- Header Card -->
        <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                    <span class="material-symbols-outlined text-3xl">dns</span>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-white tracking-tight">Управление серверами</h3>
                    <p class="text-white/60 text-xs font-medium">Контроль ресурсов, развертывание нод и сетевые
                        настройки</p>
                </div>
            </div>
        </div>

        <!-- Remnawave Section -->
        <div class="bg-white/5 border border-white/10 rounded-2xl p-1 shadow-2xl backdrop-blur-xl">
            <div class="p-4">
                <div id="remna-hosts-header"
                    class="flex items-center justify-between cursor-pointer select-none rounded-xl px-2.5 py-1.5 hover:bg-white/5 transition-all group">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20">
                            <span class="material-symbols-outlined text-lg">hub</span>
                        </div>
                        <div>
                            <h3 class="text-sm font-bold text-white tracking-tight">Серверы Remnawave</h3>
                            <p class="text-[9px] text-white/30 uppercase tracking-wider font-semibold">Хосты панели</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span
                            class="px-2 py-0.5 rounded-full bg-blue-500/10 text-blue-400 text-[10px] font-bold border border-blue-500/20"
                            id="remna-hosts-count">0</span>
                        <div id="btn-toggle-remna-hosts"
                            class="w-7 h-7 rounded-lg bg-white/5 flex items-center justify-center text-white/40 group-hover:text-white transition-all">
                            <span class="material-symbols-outlined text-lg">expand_more</span>
                        </div>
                    </div>
                </div>

                <div id="remna-hosts-list" class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                    <div class="text-center py-10 text-white/20">
                        <span class="material-symbols-outlined text-4xl mb-2 animate-pulse">dns</span>
                        <p class="text-xs uppercase tracking-widest font-bold">Загрузка данных...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SSH Section -->
        <div class="bg-white/5 border border-white/10 rounded-2xl p-1.5 shadow-2xl backdrop-blur-xl">
            <div class="p-5">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary border border-primary/20">
                            <span class="material-symbols-outlined text-xl">terminal</span>
                        </div>
                        <div>
                            <h3 class="text-base font-bold text-white tracking-tight">SSH-цели</h3>
                            <p class="text-[10px] text-white/40 uppercase tracking-widest font-medium mt-0.5">Удаленное
                                управление нодами</p>
                        </div>
                    </div>
                    <span
                        class="px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold border border-primary/20"
                        id="ssh-targets-count">0</span>
                </div>

                <div id="ssh-targets-list" class="animate-in fade-in duration-500">
                    <div class="text-center py-12 text-white/20">
                        <span class="material-symbols-outlined text-4xl mb-2 animate-pulse">terminal</span>
                        <p class="text-xs uppercase tracking-widest font-bold">Синхронизация...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="tab-logs" class="tab-content hidden">
    <div class="space-y-6">


        <div id="logs-wrapper"
            class="bg-white/5 border border-white/10 rounded-2xl p-1.5 shadow-2xl backdrop-blur-xl transition-all duration-500">
            <div class="p-5">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]"
                            id="logs-status-dot"></div>
                        <span class="text-[10px] uppercase tracking-widest font-bold text-white/40"
                            id="logs-status-text">Disconnected</span>
                    </div>

                    <div class="flex flex-wrap items-center gap-3">
                        <div class="flex items-center gap-1.5 bg-black/40 p-1 rounded-xl border border-white/5">
                            {% for level in [
                            {'l': 'WARNING', 'id': 'WARNING', 'color': 'yellow-400', 'icon': 'warning'},
                            {'l': 'ERROR', 'id': 'ERROR', 'color': 'red-400', 'icon': 'error'},
                            {'l': 'ВСЁ', 'id': 'ALL', 'color': 'white/70', 'icon': 'content_copy'}
                            ] %}
                            <button type="button" onclick="copyLogsByLevel('{{ level.id }}')"
                                class="px-3 py-1.5 rounded-lg hover:bg-white/5 text-{{ level.color }} border border-transparent hover:border-white/10 transition-all flex items-center gap-2 text-[10px] font-bold uppercase tracking-wider"
                                title="Копировать {{ level.l }}">
                                <span class="material-symbols-outlined text-sm">{{ level.icon }}</span>
                                {{ level.l }}
                            </button>
                            {% endfor %}
                        </div>

                        <button type="button" id="btn-clear-logs"
                            class="px-4 py-2 rounded-xl bg-red-500/10 text-red-400 hover:border-red-500/40 border border-red-500/20 text-[10px] font-bold uppercase tracking-widest flex items-center gap-2 transition-all">
                            <span class="material-symbols-outlined text-sm">delete_sweep</span>
                            Очистить
                        </button>

                        <button type="button" id="btn-fullscreen-logs" onclick="toggleLogsFullscreen()"
                            class="px-3 py-2 rounded-xl bg-white/5 text-white/50 hover:text-white hover:bg-white/10 border border-white/5 transition-all text-[10px] font-bold uppercase tracking-widest flex items-center justify-center gap-2"
                            title="На весь экран (F11)">
                            <span class="material-symbols-outlined text-sm">open_in_full</span>
                        </button>
                    </div>
                </div>

                <div class="relative group/terminal">
                    <div
                        class="absolute inset-0 bg-primary/5 blur-3xl rounded-full opacity-0 group-hover/terminal:opacity-20 transition-opacity duration-1000 pointer-events-none">
                    </div>
                    <div class="relative bg-black/60 rounded-xl p-5 font-mono text-[13px] leading-relaxed text-white/80 h-[55vh] overflow-y-auto custom-scrollbar border border-white/5 shadow-inner"
                        id="logs-container">
                        <div class="h-full flex flex-col items-center justify-center text-white/20">
                            <span class="material-symbols-outlined text-5xl mb-3 animate-pulse">sync</span>
                            <p class="text-xs uppercase tracking-[0.2em] font-bold">Ожидание потока логов...</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex items-center gap-3 px-1 text-white/30">
                    <span class="material-symbols-outlined text-sm">info</span>
                    <p class="text-[10px] uppercase tracking-widest font-medium">Трансляция в реальном времени (tail
                        -f). Новые записи появляются автоматически.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<div id="warpModal" class="modal-overlay" style="z-index: 50;">
    <div class="modal-content max-w-2xl rounded-xl bg-[#0a1812] border border-white/10 shadow-2xl overflow-hidden">
        <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-white/[0.02]">
            <div class="flex items-center gap-3">
                <div
                    class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500/20 to-cyan-500/10 flex items-center justify-center border border-blue-500/20">
                    <span class="material-symbols-outlined text-blue-400 text-lg">vpn_lock</span>
                </div>
                <div>
                    <h5 class="text-white font-semibold text-sm">WARP (wireproxy)</h5>
                    <p class="text-white/40 text-[10px] font-mono" id="warp-target-name">—</p>
                </div>
            </div>
            <button onclick="closeModal('warpModal')"
                class="w-8 h-8 rounded-lg bg-white/5 hover:border-white/20 flex items-center justify-center text-white/50 hover:text-white transition-all">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
        </div>
        <div class="p-5">

            <div id="warp-loading" class="text-center py-6">
                <span
                    class="material-symbols-outlined animate-spin text-3xl text-blue-400 mb-2">progress_activity</span>
                <p class="text-white/40 text-xs">Проверка статуса...</p>
            </div>

            <div id="warp-install-state" class="hidden">
                <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-5 text-center mb-4">
                    <span class="material-symbols-outlined text-5xl text-white/15 mb-3">download</span>
                    <h3 class="text-sm font-bold text-white mb-1">WARP не установлен</h3>
                    <p class="text-white/40 text-[11px] mb-4">SOCKS5 прокси на порту 40000</p>
                    <button id="btn-warp-install"
                        class="px-4 py-2 rounded-lg bg-white/5 hover:border-white/30 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all inline-flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">download</span>
                        Установить WARP
                    </button>
                    <p class="text-white/20 text-[10px] mt-3">fscarmen/warp (1, 1, 40000)</p>
                </div>
            </div>

            <div id="warp-manage-state" class="hidden">

                <div class="flex items-center justify-between bg-white/5 border border-white/10 rounded-lg p-4 mb-6">
                    <div class="flex items-center gap-4">
                        <div id="warp-status-indicator" class="w-4 h-4 rounded-full bg-gray-500"></div>
                        <div>
                            <p class="text-white font-bold" id="warp-status-text">Статус неизвестен</p>
                            <p class="text-white/50 text-xs">Service: wireproxy</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-warp-toggle"
                            class="p-2 rounded-lg bg-white/10 hover:border-white/30 border border-transparent text-white transition-all"
                            title="Загрузка...">
                            <span class="material-symbols-outlined">pending</span>
                        </button>
                        <button id="btn-warp-restart"
                            class="p-2 rounded-lg bg-white/10 hover:border-white/30 border border-transparent text-white transition-all"
                            title="Перезапуск сервиса">
                            <span class="material-symbols-outlined">restart_alt</span>
                        </button>
                        <button id="btn-warp-uninstall"
                            class="p-2 rounded-lg bg-red-500/20 hover:border-red-500/30 border border-transparent text-red-400 transition-all"
                            title="Удалить WARP">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </div>

                <div class="flex gap-1 mb-4 border-b border-white/10">
                    <button
                        class="px-4 py-2 text-primary border-b-2 border-primary font-medium text-sm transition-colors"
                        id="btn-tab-warp-config" onclick="switchWarpTab('config')">Настройки</button>
                    <button class="px-4 py-2 text-white/50 hover:text-white font-medium text-sm transition-colors"
                        id="btn-tab-warp-json" onclick="switchWarpTab('json')">Remnawave Config</button>
                    <button class="px-4 py-2 text-white/50 hover:text-white font-medium text-sm transition-colors"
                        id="btn-tab-warp-systemd" onclick="switchWarpTab('systemd')">Systemd Config</button>
                </div>

                <div id="warp-content-config">
                    <form id="warp-config-form">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-white/70 text-sm font-medium mb-2">MemoryMax</label>
                                <div class="relative">
                                    <input type="text" name="memory_max" id="warp-memory-max"
                                        class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-1 focus:ring-primary"
                                        placeholder="800M">
                                </div>
                            </div>
                            <div>
                                <label class="block text-white/70 text-sm font-medium mb-2">MemoryHigh</label>
                                <div class="relative">
                                    <input type="text" name="memory_high" id="warp-memory-high"
                                        class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-1 focus:ring-primary"
                                        placeholder="1G">
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 mb-4">
                            <h6 class="text-blue-300 text-xs font-bold mb-2 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">info</span> Рекомендации ОЗУ
                            </h6>
                            <p class="text-xs text-blue-200/70 mb-3">
                                Для 1GB RAM серверов: <span class="text-blue-100">512M / 400M</span>.<br>
                                Для 2+GB RAM серверов: <span class="text-blue-100">800M / 1G</span> (50-150 клиентов).
                            </p>

                            <div class="overflow-x-auto">
                                <table class="w-full text-xs text-left text-blue-200/70">
                                    <thead class="text-blue-300 font-bold border-b border-blue-500/20">
                                        <tr>
                                            <th class="py-1 pr-2">Клиентов</th>
                                            <th class="py-1 px-2">Потребление</th>
                                            <th class="py-1 px-2 whitespace-nowrap">MemoryHigh</th>
                                            <th class="py-1 pl-2 whitespace-nowrap">MemoryMax</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-blue-500/10">
                                        <tr>
                                            <td class="py-1 pr-2">До 20</td>
                                            <td class="py-1 px-2">~13 MB</td>
                                            <td class="py-1 px-2 text-blue-100">300M</td>
                                            <td class="py-1 pl-2 text-blue-100">380M</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">20-50</td>
                                            <td class="py-1 px-2">~18 MB</td>
                                            <td class="py-1 px-2 text-blue-100">450M</td>
                                            <td class="py-1 pl-2 text-blue-100">560M</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">50-150</td>
                                            <td class="py-1 px-2">~33 MB</td>
                                            <td class="py-1 px-2 text-blue-100">800M</td>
                                            <td class="py-1 pl-2 text-blue-100">1G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">150-350</td>
                                            <td class="py-1 px-2">~65 MB</td>
                                            <td class="py-1 px-2 text-blue-100">1.2G</td>
                                            <td class="py-1 pl-2 text-blue-100">1.5G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">350-850</td>
                                            <td class="py-1 px-2">~138 MB</td>
                                            <td class="py-1 px-2 text-blue-100">2G</td>
                                            <td class="py-1 pl-2 text-blue-100">2.5G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">850-3k</td>
                                            <td class="py-1 px-2">~460 MB</td>
                                            <td class="py-1 px-2 text-blue-100">3.5G</td>
                                            <td class="py-1 pl-2 text-blue-100">4.3G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">3k-10k</td>
                                            <td class="py-1 px-2">~1.5 GB</td>
                                            <td class="py-1 px-2 text-blue-100">5.5G</td>
                                            <td class="py-1 pl-2 text-blue-100">6.9G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">10k-50k</td>
                                            <td class="py-1 px-2">~7.5 GB</td>
                                            <td class="py-1 px-2 text-blue-100">10G</td>
                                            <td class="py-1 pl-2 text-blue-100">12.5G</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <button type="submit" id="btn-warp-save"
                            class="w-full px-4 py-2 rounded-lg bg-white/10 hover:border-primary/40 text-white font-medium transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">save</span>
                            Сохранить и перезапустить
                        </button>
                    </form>
                </div>

                <div id="warp-content-json" class="hidden">
                    <p class="text-white/50 text-sm mb-2">Для Remnawave Профилей (Outbound):</p>
                    <textarea readonly
                        class="w-full h-40 bg-black/30 border border-white/10 rounded-lg p-3 text-xs font-mono text-green-400 focus:outline-none selection:bg-green-500/30"
                        id="warp-json-output">
{
  "tag": "warp",
  "protocol": "socks",
  "settings": {
    "servers": [
      {
        "address": "127.0.0.1",
        "port": 40000
      }
    ]
  }
}
                    </textarea>
                    <button type="button"
                        onclick="navigator.clipboard.writeText(document.getElementById('warp-json-output').value); window.showToast('success', 'Скопировано')"
                        class="mt-2 w-full px-4 py-2 rounded-lg bg-white/10 hover:border-white/30 border border-transparent text-white text-sm transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">content_copy</span>
                        Копировать в буфер
                    </button>
                </div>

                <div id="warp-content-systemd" class="hidden">
                    <p class="text-white/50 text-sm mb-2">Редактирование systemd override конфига wireproxy:</p>
                    <textarea
                        class="w-full h-64 bg-black/30 border border-white/10 rounded-lg p-3 text-xs font-mono text-white focus:outline-none focus:ring-2 focus:ring-primary/50"
                        id="warp-systemd-textarea"
                        placeholder="[Service]&#10;Environment=&quot;WG_LOG_LEVEL=error&quot;&#10;StandardOutput=null&#10;StandardError=journal&#10;MemoryMax=800M&#10;MemoryHigh=1G"></textarea>
                    <button type="button" id="btn-warp-systemd-save"
                        class="mt-2 w-full px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:border-white border border-transparent transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">save</span>
                        Сохранить
                    </button>

                    <div class="mt-6 border-t border-white/10 pt-4">
                        <h6 class="text-white font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-yellow-400">description</span>
                            Настройки логов Wireproxy
                        </h6>
                        <p class="text-white/50 text-xs mb-3">Управление journalctl логами для wireproxy.service</p>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-white/70 text-xs font-medium mb-1 flex items-center gap-1">
                                    Max Size (MB)
                                    <span class="group relative inline-block">
                                        <span
                                            class="material-symbols-outlined text-xs text-white/40 hover:text-white/70 cursor-help">info</span>
                                        <span
                                            class="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-black/90 text-white text-xs rounded-lg whitespace-nowrap z-50 border border-white/10">
                                            Ограничить размер журнала
                                        </span>
                                    </span>
                                </label>
                                <input type="number" id="warp-log-max-size" min="0" placeholder="0"
                                    class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500/50">
                            </div>
                            <div>
                                <label class="block text-white/70 text-xs font-medium mb-1 flex items-center gap-1">
                                    Max Age (Days)
                                    <span class="group relative inline-block">
                                        <span
                                            class="material-symbols-outlined text-xs text-white/40 hover:text-white/70 cursor-help">info</span>
                                        <span
                                            class="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-black/90 text-white text-xs rounded-lg whitespace-nowrap z-50 border border-white/10">
                                            Удалить логи старше N дней
                                        </span>
                                    </span>
                                </label>
                                <input type="number" id="warp-log-max-age" min="0" placeholder="0"
                                    class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500/50">
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button type="button" id="btn-warp-check-log-usage"
                                class="flex-1 px-4 py-2 rounded-lg bg-white/10 hover:border-white/30 border border-transparent text-white text-sm font-medium transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">hard_drive</span>
                                Проверить размер логов
                            </button>
                            <button type="button" id="btn-warp-clean-logs"
                                class="flex-1 px-4 py-2 rounded-lg bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 text-sm font-bold transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">delete_sweep</span>
                                Очистить логи Wireproxy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="warp-logs-container"
                class="mt-4 hidden bg-black/80 border border-white/10 rounded-lg overflow-hidden">
                <div class="px-3 py-1 bg-white/5 text-xs text-white/50 border-b border-white/5">Лог операций</div>
                <div class="p-3 font-mono text-xs text-green-400 max-h-48 overflow-y-auto whitespace-pre-wrap"
                    id="warp-logs"></div>
            </div>
        </div>
    </div>
</div>

<div id="executeCommandModal" class="modal-overlay" style="z-index: 60;">
    <div class="modal-content max-w-6xl rounded-xl bg-[#0a1812] border border-white/10 shadow-2xl overflow-hidden">
        <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-white/[0.02]">
            <div class="flex items-center gap-3">
                <div
                    class="w-9 h-9 rounded-lg bg-gradient-to-br from-emerald-500/20 to-green-500/10 flex items-center justify-center border border-emerald-500/20">
                    <span class="material-symbols-outlined text-emerald-400 text-lg">terminal</span>
                </div>
                <div>
                    <h5 class="text-white font-semibold text-sm">Терминал</h5>
                    <p class="text-white/40 text-[10px] font-mono" id="exec-server-name">—</p>
                </div>
            </div>
            <button id="btn-close-exec-modal"
                class="w-8 h-8 rounded-lg bg-white/5 hover:border-white/20 flex items-center justify-center text-white/50 hover:text-white transition-all">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
        </div>
        <div class="p-5 flex flex-col" style="height: calc(100vh - 120px); max-height: 700px;">

            <div class="rounded-xl bg-black/40 border border-white/[0.06] overflow-hidden flex-1 flex flex-col">
                <div
                    class="px-4 py-2.5 bg-white/[0.03] border-b border-white/[0.06] flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1.5">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500/60"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/60"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-green-500/60"></div>
                        </div>
                        <span class="text-[10px] text-white/30 font-medium ml-2">Вывод</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button id="btn-stop-exec-command"
                            class="hidden px-2.5 py-1 rounded-md bg-red-500/10 hover:border-red-500/30 border border-transparent text-red-400 text-[10px] font-medium flex items-center gap-1 transition-all">
                            <span class="material-symbols-outlined text-xs">stop_circle</span>
                            Стоп
                        </button>
                        <button id="btn-copy-exec-output"
                            class="px-2.5 py-1 rounded-md bg-white/5 hover:border-white/20 border border-transparent text-white/50 hover:text-white text-[10px] font-medium flex items-center gap-1 transition-all">
                            <span class="material-symbols-outlined text-xs">content_copy</span>
                            Копировать
                        </button>
                        <button id="btn-clear-exec-output"
                            class="px-2.5 py-1 rounded-md bg-white/5 hover:border-white/20 border border-transparent text-white/50 hover:text-white text-[10px] font-medium flex items-center gap-1 transition-all">
                            <span class="material-symbols-outlined text-xs">delete</span>
                            Очистить
                        </button>
                    </div>
                </div>
                <div id="exec-output"
                    class="terminal-output p-4 font-mono text-xs flex-1 overflow-y-auto whitespace-pre-wrap leading-relaxed selection:bg-emerald-500/30">
                    <span class="text-white/30">Ожидание команды...</span>
                </div>
            </div>

            <form id="exec-command-form" class="mt-3 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <div class="flex-1 relative">
                        <span
                            class="absolute left-3 top-1/2 -translate-y-1/2 text-emerald-400/60 text-sm font-bold">$</span>
                        <input type="text" id="exec-command-input" placeholder="Введите команду..."
                            class="w-full bg-black/30 border border-white/[0.06] rounded-lg pl-7 pr-4 py-2.5 text-white placeholder:text-white/30 focus:outline-none focus:ring-1 focus:ring-emerald-500/50 focus:border-emerald-500/50 font-mono text-sm transition-all" />
                    </div>
                    <button type="button" id="btn-stop-command"
                        class="w-[42px] h-[42px] rounded-lg bg-red-500/10 hover:border-red-500/30 border border-red-500/30 flex items-center justify-center transition-all group"
                        title="Остановить (Ctrl+C)">
                        <span class="material-symbols-outlined text-red-400 text-xl transition-transform">close</span>
                    </button>
                    <button type="submit" id="btn-exec-command"
                        class="w-[42px] h-[42px] rounded-lg bg-emerald-500/10 hover:border-emerald-500/30 border border-emerald-500/30 flex items-center justify-center transition-all group">
                        <span
                            class="material-symbols-outlined text-emerald-400 text-xl transition-transform">send</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<style>
    .terminal-output::-webkit-scrollbar {
        width: 8px;
    }

    .terminal-output::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
    }

    .terminal-output::-webkit-scrollbar-thumb {
        background: rgba(16, 185, 129, 0.3);
        border-radius: 4px;
    }

    .terminal-output::-webkit-scrollbar-thumb:hover {
        background: rgba(16, 185, 129, 0.5);
    }

    .terminal-output {
        scrollbar-width: thin;
        scrollbar-color: rgba(16, 185, 129, 0.3) rgba(0, 0, 0, 0.2);
    }

    .term-line {
        min-height: 1.5em;
        /* Ensure empty lines have height */
        word-break: break-all;
        /* Prevent horizontal overflow */
    }
</style>
<div id="schedulerModal" class="modal-overlay" style="z-index: 50;">
    <div class="modal-content max-w-md rounded-xl bg-[#0a1812] border border-white/10 shadow-2xl overflow-hidden">
        <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-white/[0.02]">
            <div class="flex items-center gap-3">
                <div
                    class="w-9 h-9 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-500/10 flex items-center justify-center border border-cyan-500/20">
                    <span class="material-symbols-outlined text-cyan-400 text-lg">schedule</span>
                </div>
                <div>
                    <h5 class="text-white font-semibold text-sm">Планировщик перезагрузки</h5>
                    <p class="text-white/40 text-[10px] font-mono" id="schedulerTargetName">—</p>
                </div>
            </div>
            <button onclick="closeModal('schedulerModal')"
                class="w-8 h-8 rounded-lg bg-white/5 hover:border-white/20 flex items-center justify-center text-white/50 hover:text-white transition-all">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
        </div>
        <div class="p-5">
            <div id="scheduler-current-status" class="mb-4 rounded-lg bg-white/[0.03] border border-white/[0.06] p-3">
                <div class="flex items-center justify-between">
                    <span class="text-[10px] uppercase tracking-wider text-white/40 font-bold">Текущие настройки</span>
                    <span id="scheduler-status-badge"
                        class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-white/5 text-white/50">Загрузка...</span>
                </div>
                <div id="scheduler-current-value" class="mt-2 text-white/70 text-xs">
                    <span class="text-white/30">Проверка...</span>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] uppercase tracking-wider text-white/40 font-bold mb-2">Интервал
                        перезагрузки</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="schedulerValue"
                            class="flex-1 bg-black/30 border border-white/[0.06] rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500/50 focus:border-cyan-500/50 placeholder:text-white/30 transition-all"
                            placeholder="1" min="1">
                        <div class="soft-select flex-1" data-target="schedulerUnit">
                            <div
                                class="soft-select-toggle bg-black/30 border border-white/[0.06] rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none cursor-pointer flex items-center justify-between">
                                <span class="soft-select-text">Часов</span>
                                <span class="material-symbols-outlined text-white/50 text-lg">expand_more</span>
                            </div>
                            <div
                                class="soft-select-menu hidden absolute z-50 w-full bg-[#0a1812] border border-white/10 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto">
                            </div>
                            <select id="schedulerUnit" class="absolute opacity-0 pointer-events-none">
                                <option value="minutes">Минут</option>
                                <option value="hours" selected>Часов</option>
                                <option value="days">Дней</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3 bg-white/[0.03] rounded-lg border border-white/[0.06] cursor-pointer hover:border-cyan-500/30 transition-all"
                    onclick="toggleSchedulerCheckbox()">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="schedulerEnabled"
                            class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-white/20 transition-all checked:border-cyan-400 checked:bg-cyan-500 hover:border-cyan-500/40" />
                        <span
                            class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-background-dark opacity-0 peer-checked:opacity-100">
                            <span class="material-symbols-outlined text-sm font-bold">check</span>
                        </span>
                    </div>
                    <div>
                        <div class="font-medium text-white text-xs">Включить авто-перезагрузку</div>
                        <div class="text-[10px] text-white/40">Сервер будет перезагружаться по расписанию</div>
                    </div>
                </div>

                <button onclick="saveSchedulerConfig()"
                    class="w-full px-4 py-2.5 rounded-lg bg-white/5 hover:border-cyan-500/40 border border-white/10 text-white/80 hover:text-white text-xs font-medium transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-sm">save</span>
                    Сохранить настройки
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleSchedulerCheckbox() {
        const checkbox = document.getElementById('schedulerEnabled');
        checkbox.checked = !checkbox.checked;
    }
</script>
{% endblock %}
<div
    class="p-6 border-b border-white/5 flex justify-between items-center bg-gradient-to-r from-blue-900/20 to-transparent">
    <h3 class="text-xl font-bold text-white flex items-center gap-2">
        <span class="material-symbols-outlined text-blue-400">schedule</span>
        Планировщик перезагрузки
    </h3>
    <button onclick="closeModal('schedulerModal')" class="text-gray-400 hover:text-white transition-all">
        <span class="material-symbols-outlined">close</span>
    </button>
</div>
<div class="p-6 space-y-4">
    <p class="text-sm text-gray-400 mb-4">Настройте автоматическую перезагрузку сервера <span id="schedulerTargetName"
            class="text-white font-mono"></span>.</p>

    <div class="space-y-2">
        <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider">Интервал</label>
        <div class="flex gap-2">
            <input type="number" id="schedulerValue"
                class="flex-1 bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
                placeholder="1" min="1">
            <select id="schedulerUnit"
                class="bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all appearance-none cursor-pointer">
                <option value="minutes">Минут</option>
                <option value="hours">Часов</option>
                <option value="days">Дней</option>
            </select>
        </div>
    </div>

    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg border border-white/5 cursor-pointer hover:border-white/20 transition-all"
        onclick="document.getElementById('schedulerEnabled').click()">
        <input type="checkbox" id="schedulerEnabled"
            class="w-5 h-5 rounded border-gray-600 text-blue-500 focus:ring-blue-500 bg-gray-700">
        <div>
            <div class="font-medium text-white text-sm">Включить автоматическую перезагрузку</div>
            <div class="text-xs text-gray-400">Сервер будет перезагружаться по указанному расписанию</div>
        </div>
    </div>
</div>
<div class="p-6 pt-0 flex gap-3">
    <button onclick="closeModal('schedulerModal')"
        class="flex-1 px-4 py-2.5 rounded-lg bg-white/5 hover:border-white/20 border border-transparent text-gray-300 font-medium transition-all">Отмена</button>
    <button onclick="saveSchedulerConfig()"
        class="flex-1 px-4 py-2.5 rounded-lg bg-blue-500 hover:border-white border border-transparent text-white font-bold transition-all flex items-center justify-center gap-2">
        <span class="material-symbols-outlined" style="font-size: 18px">save</span> Сохранить
    </button>
</div>
</div>
</div>

{% block scripts %}
<style>
    /* Custom Scrollbar for Logs */
    #logs-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    #logs-container::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
    }

    #logs-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        transition: background 0.2s;
    }

    #logs-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    #logs-container::-webkit-scrollbar-corner {
        background: transparent;
    }
</style>

<script>
    // Globals for scheduler
    let sshTargetsData = [];
    let currentSchedulerTarget = null;
    let serversAutoRefresh = null;

    document.addEventListener('DOMContentLoaded', function () {

        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');
        const logsContainer = document.getElementById('logs-container');
        const logsStatusDot = document.getElementById('logs-status-dot');
        const logsStatusText = document.getElementById('logs-status-text');
        const btnClearLogs = document.getElementById('btn-clear-logs');

        async function copyLogsByLevel(level) {
            if (!logsContainer) return;
            const lines = Array.from(logsContainer.children);
            let filteredText = "";

            lines.forEach(line => {
                const text = line.textContent;
                if (level === 'ALL') {
                    filteredText += text + "\n";
                } else if (text.includes(level)) {
                    filteredText += text + "\n";
                }
            });

            if (!filteredText.trim()) {
                window.showToast('warning', 'Нет логов с уровнем ' + level);
                return;
            }

            try {
                await navigator.clipboard.writeText(filteredText);
                window.showToast('success', 'Логи (' + level + ') скопированы (' + filteredText.split('\n').length + ' стр.)');
            } catch (err) {
                console.error('Failed to copy logs:', err);
                window.showToast('danger', 'Ошибка копирования');
            }
        }
        window.copyLogsByLevel = copyLogsByLevel;

        let logEventSource = null;
        let logsOffset = 0;
        let isLoadingHistory = false;
        let isAutoScrolling = true;

        window.showConfirm = function ({
            title = 'Подтверждение',
            message = 'Вы уверены?',
            type = 'warning',
            confirmText = 'Подтвердить',
            cancelText = 'Отмена',
            onConfirm = null
        }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const iconContainer = document.getElementById('confirm-icon-container');
                const icon = document.getElementById('confirm-icon');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('btn-confirm-ok');
                const cancelBtn = document.getElementById('btn-confirm-cancel');

                const styles = {
                    info: {
                        iconBg: 'bg-blue-500/20',
                        iconColor: 'text-blue-400',
                        iconName: 'info',
                        btnBg: 'bg-blue-500 hover:bg-blue-600 text-white'
                    },
                    warning: {
                        iconBg: 'bg-yellow-500/20',
                        iconColor: 'text-yellow-400',
                        iconName: 'warning',
                        btnBg: 'bg-yellow-500 hover:bg-yellow-600 text-white'
                    },
                    danger: {
                        iconBg: 'bg-red-500/20',
                        iconColor: 'text-red-400',
                        iconName: 'dangerous',
                        btnBg: 'bg-red-500 hover:bg-red-600 text-white'
                    }
                };

                const style = styles[type] || styles.warning;

                iconContainer.className = `w-16 h-16 rounded-full flex items-center justify-center ${style.iconBg}`;
                icon.className = `material-symbols-outlined text-4xl ${style.iconColor}`;
                icon.textContent = style.iconName;
                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;

                if (!cancelText) {
                    cancelBtn.style.display = 'none';
                } else {
                    cancelBtn.style.display = '';
                }

                confirmBtn.className = `flex-1 px-6 py-3 rounded-lg font-bold transition-colors ${style.btnBg}`;

                modal.style.display = 'flex';
                setTimeout(() => confirmBtn.focus(), 100);

                const handleConfirm = async () => {
                    modal.style.display = 'none';
                    cleanup();
                    if (onConfirm) await onConfirm();
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(false);
                };

                const handleKeyPress = (e) => {
                    if (e.key === 'Escape') handleCancel();
                    if (e.key === 'Enter') handleConfirm();
                };

                const cleanup = () => {
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    document.removeEventListener('keydown', handleKeyPress);
                };

                confirmBtn.onclick = handleConfirm;
                cancelBtn.onclick = handleCancel;
                document.addEventListener('keydown', handleKeyPress);
            });
        };

        function updateLogStatus(connected) {
            if (!logsStatusDot || !logsStatusText) return;
            if (connected) {
                logsStatusDot.className = 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)] animate-pulse';
                logsStatusText.textContent = 'Live';
                logsStatusText.className = 'text-[10px] uppercase tracking-widest font-bold text-green-400';
            } else {
                logsStatusDot.className = 'w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]';
                logsStatusText.textContent = 'Disconnected';
                logsStatusText.className = 'text-[10px] uppercase tracking-widest font-bold text-white/40';
            }
        }

        function createLogLine(text) {
            const line = document.createElement('div');
            if (text.includes('[ERROR]') || text.includes('ERROR')) {
                line.className = 'whitespace-pre-wrap border-b border-white/5 pb-1 mb-1 hover:bg-red-500/20 bg-red-500/10 transition-colors px-1 text-red-300';
            } else if (text.includes('[WARNING]') || text.includes('WARNING')) {
                line.className = 'whitespace-pre-wrap border-b border-white/5 pb-1 mb-1 hover:bg-white/5 transition-colors px-1 text-yellow-300';
            } else {
                line.className = 'whitespace-pre-wrap border-b border-white/5 pb-1 mb-1 hover:bg-white/5 transition-colors px-1 text-white/80';
            }
            line.textContent = text;
            return line;
        }

        function appendLog(text) {
            if (!logsContainer) return;
            const line = createLogLine(text);
            logsContainer.appendChild(line);

            if (isAutoScrolling) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }

            if (logsContainer.children.length > 50) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        function prependLog(text) {
            if (!logsContainer) return;
            const line = createLogLine(text);
            logsContainer.insertBefore(line, logsContainer.firstChild);
        }

        async function loadHistory() {
            if (isLoadingHistory) return;
            isLoadingHistory = true;

            const currentLines = logsContainer.children.length;

            const loading = document.createElement('div');
            loading.className = 'text-center text-xs text-white/30 py-1';
            loading.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>';
            logsContainer.insertBefore(loading, logsContainer.firstChild);

            try {
                const resp = await fetch(`/other/logs/history?lines=50&offset=${currentLines}`);
                const data = await resp.json();

                logsContainer.removeChild(loading);

                if (data.ok && data.lines && data.lines.length > 0) {
                    const oldHeight = logsContainer.scrollHeight;
                    const oldScroll = logsContainer.scrollTop;

                    const fragment = document.createDocumentFragment();
                    data.lines.forEach(lineText => {
                        fragment.appendChild(createLogLine(lineText));
                    });

                    logsContainer.insertBefore(fragment, logsContainer.firstChild);

                    const newHeight = logsContainer.scrollHeight;
                    logsContainer.scrollTop = oldScroll + (newHeight - oldHeight);
                }
            } catch (e) {
                console.error("History error:", e);
                if (logsContainer.contains(loading)) logsContainer.removeChild(loading);
            } finally {
                isLoadingHistory = false;
            }
        }

        logsContainer.addEventListener('scroll', () => {
            if (logsContainer.scrollTop + logsContainer.clientHeight < logsContainer.scrollHeight - 50) {
                isAutoScrolling = false;
            } else {
                isAutoScrolling = true;
            }

            if (logsContainer.scrollTop < 50) {
                loadHistory();
            }
        });

        function startLogStream() {
            if (logEventSource) logEventSource.close();

            if (logsContainer) logsContainer.innerHTML = '';
            updateLogStatus(true);

            logEventSource = new EventSource('/other/logs/stream');

            logEventSource.onmessage = function (event) {
                appendLog(event.data);
            };

            logEventSource.onerror = function (err) {
                console.error("EventSource failed:", err);
                logEventSource.close();
                logEventSource = null;
                updateLogStatus(false);
                appendLog("[System] Connection lost. Reconnecting in 5s...");
                setTimeout(() => {
                    if (location.hash === '#logs') startLogStream();
                }, 5000);
            };
        }

        // Fullscreen Logic
        let isLogsFullscreen = false;

        window.toggleLogsFullscreen = function () {
            const container = document.getElementById('logs-wrapper');
            if (!container) return;

            if (!isLogsFullscreen) {
                if (container.requestFullscreen) {
                    container.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                } else {
                    enterCssFullscreen(container);
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else {
                    exitCssFullscreen(container);
                }
            }
        };

        function enterCssFullscreen(el) {
            el.classList.add('fixed', 'inset-0', 'z-[100]', 'h-screen', 'w-screen', 'rounded-none', 'flex', 'flex-col', 'bg-[#0a1812]', 'overflow-hidden', 'p-6');
            el.classList.remove('p-1.5', 'rounded-2xl', 'backdrop-blur-xl', 'bg-white/5');

            // Style the direct child (div.p-5) to be a flex column
            const mainContainer = el.firstElementChild;
            if (mainContainer) {
                mainContainer.classList.remove('p-5');
                mainContainer.classList.add('flex', 'flex-col', 'h-full', 'w-full');
            }

            // Style the terminal wrapper
            const terminalWrapper = el.querySelector('.group\\/terminal');
            if (terminalWrapper) {
                terminalWrapper.classList.add('flex-1', 'flex', 'flex-col', 'min-h-0');
            }

            const inner = el.querySelector('#logs-container');
            if (inner) {
                inner.classList.add('flex-1', 'min-h-0', 'rounded-xl', 'border', 'border-white/5', 'overflow-y-auto');
                inner.classList.remove('h-[55vh]');
            }

            const header = el.querySelector('.flex.flex-col');
            if (header) {
                header.classList.add('mb-4', 'flex-none'); // Prevent header from shrinking
            }

            const footer = el.querySelector('.mt-4.flex');
            if (footer) {
                footer.classList.add('hidden');
            }

            document.body.style.overflow = 'hidden';
            isLogsFullscreen = true;
            updateFullscreenIcon(true);
        }

        function exitCssFullscreen(el) {
            el.classList.remove('fixed', 'inset-0', 'z-[100]', 'h-screen', 'w-screen', 'rounded-none', 'flex', 'flex-col', 'bg-[#0a1812]', 'overflow-hidden', 'p-6');
            el.classList.add('p-1.5', 'rounded-2xl', 'backdrop-blur-xl', 'bg-white/5');

            // Restore direct child styles
            const mainContainer = el.firstElementChild;
            if (mainContainer) {
                mainContainer.classList.add('p-5');
                mainContainer.classList.remove('flex', 'flex-col', 'h-full', 'w-full');
            }

            // Restore terminal wrapper styles
            const terminalWrapper = el.querySelector('.group\\/terminal');
            if (terminalWrapper) {
                terminalWrapper.classList.remove('flex-1', 'flex', 'flex-col', 'min-h-0');
            }

            const inner = el.querySelector('#logs-container');
            if (inner) {
                inner.classList.remove('flex-1', 'min-h-0');
                // Restore original classes
                inner.classList.add('h-[55vh]', 'rounded-xl', 'border', 'border-white/5', 'overflow-y-auto');
            }

            const header = el.querySelector('.flex.flex-col');
            if (header) {
                header.classList.remove('mb-4', 'flex-none');
            }

            const footer = el.querySelector('.mt-4.flex');
            if (footer) {
                footer.classList.remove('hidden');
            }

            document.body.style.overflow = '';
            isLogsFullscreen = false;
            updateFullscreenIcon(false);
        }

        // Handle native fullscreen change events to sync state
        // Handle native fullscreen change events to sync state
        document.addEventListener('fullscreenchange', () => {
            const container = document.getElementById('logs-wrapper');
            if (!container) return;

            if (document.fullscreenElement) {
                enterCssFullscreen(container);
            } else {
                exitCssFullscreen(container);
            }
        });

        function updateFullscreenIcon(isFullscreen) {
            const btn = document.getElementById('btn-fullscreen-logs');
            if (!btn) return;
            const icon = btn.querySelector('.material-symbols-outlined');
            if (isFullscreen) {
                icon.textContent = 'close_fullscreen';
                btn.title = 'Выйти из полноэкранного режима (F11 / Esc)';
            } else {
                icon.textContent = 'open_in_full';
                btn.title = 'На весь экран (F11)';
            }
        }

        // F11 Handler
        document.addEventListener('keydown', function (e) {
            if (e.key === 'F11') {
                // Check if we are on logs tab
                const activeTab = document.querySelector('.tab-btn.bg-primary');
                if (activeTab && activeTab.getAttribute('data-tab') === 'logs') {
                    e.preventDefault();
                    toggleLogsFullscreen();
                }
            }
        });

        function handleTabSwitch(tabId) {
            if (tabId === 'broadcast') {
                if (typeof loadStats === 'function') loadStats();
            } else if (tabId === 'promo') {
                if (typeof loadPromos === 'function') loadPromos();
            } else if (tabId === 'servers') {
                if (typeof loadServers === 'function') loadServers();
            }

            if (tabId !== 'logs' && logEventSource) {
                logEventSource.close();
                logEventSource = null;
                updateLogStatus(false);
            } else if (tabId === 'logs' && !logEventSource) {
                startLogStream();
            }
        }

        window.switchTab = function (tabId) {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(btn => {
                const isActive = btn.getAttribute('data-tab') === tabId;
                btn.classList.toggle('bg-primary', isActive);
                btn.classList.toggle('text-background-dark', isActive);
                btn.classList.toggle('text-white/70', !isActive);
                btn.classList.toggle('hover:bg-white/5', !isActive);
            });
            contents.forEach(content => {
                const isActive = content.id === 'tab-' + tabId;
                content.classList.toggle('hidden', !isActive);
            });

            // Обновляем URL (и хеш для совместимости, и параметр tab)
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('tab', tabId);
            window.history.replaceState(null, '', newUrl);

            localStorage.setItem('remnawave_other_active_tab', tabId);

            handleTabSwitch(tabId);
        };

        tabs.forEach(btn => {
            btn.addEventListener('click', () => window.switchTab(btn.getAttribute('data-tab')));
        });

        if (btnClearLogs) {
            btnClearLogs.addEventListener('click', async () => {
                const confirmed = await window.showConfirm({
                    title: 'Очистка логов Docker',
                    message: 'Вы уверены, что хотите очистить все логи Docker?\n\nЭто действие необратимо.',
                    type: 'danger',
                    confirmText: 'Очистить',
                    cancelText: 'Отмена'
                });
                if (!confirmed) return;

                try {
                    const resp = await fetch('/other/logs/clear', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': window.getCsrfToken()
                        }
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        window.showToast('success', 'Логи успешно очищены');
                        if (logsContainer) logsContainer.innerHTML = '<div class="text-green-400 text-center my-4">--- Логи были очищены ---</div>';
                    } else {
                        window.showToast('danger', data.error || 'Ошибка очистки логов');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', 'Ошибка соединения');
                }
            });
        }

        const btnToggleRemnaHosts = document.getElementById('btn-toggle-remna-hosts');
        const remnaHostsHeader = document.getElementById('remna-hosts-header');
        const remnaHostsList = document.getElementById('remna-hosts-list');

        function toggleRemnaHosts() {
            if (!remnaHostsList) return;

            remnaHostsList.classList.toggle('hidden');
            const icon = btnToggleRemnaHosts?.querySelector('.material-symbols-outlined');
            if (icon) {
                if (remnaHostsList.classList.contains('hidden')) {
                    icon.textContent = 'expand_more';
                } else {
                    icon.textContent = 'expand_less';
                }
            }
        }

        if (btnToggleRemnaHosts) {
            btnToggleRemnaHosts.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleRemnaHosts();
            });
        }

        // Инициализация активной вкладки
        const urlParams = new URLSearchParams(window.location.search);
        const queryTab = urlParams.get('tab');
        const hashTab = window.location.hash.substring(1);
        const savedTab = localStorage.getItem('remnawave_other_active_tab');

        const activeTab = queryTab || hashTab || savedTab || 'broadcast';
        window.switchTab(activeTab);

        if (remnaHostsHeader) {
            remnaHostsHeader.addEventListener('click', toggleRemnaHosts);
        }

        let initialTab = location.hash.slice(1);
        if (!initialTab) {
            initialTab = localStorage.getItem('remnawave_other_active_tab');
        }

        const validTabs = ['broadcast', 'promo', 'servers', 'logs', 'remnawave'];
        if (!validTabs.includes(initialTab)) {
            initialTab = 'broadcast';
        }

        window.switchTab(initialTab);

        let uploadedMediaFilename = null;
        let buttons = [];

        async function loadStats() {
            try {
                const resp = await fetch('/other/broadcast/stats');
                const data = await resp.json();
                if (data.ok) {
                    if (document.getElementById('stat-total')) document.getElementById('stat-total').textContent = data.total_users;
                    if (document.getElementById('stat-with-keys')) document.getElementById('stat-with-keys').textContent = data.users_with_keys;
                    if (document.getElementById('stat-expired-keys')) document.getElementById('stat-expired-keys').textContent = data.users_with_expired_keys || 0;
                    if (document.getElementById('stat-no-trial')) document.getElementById('stat-no-trial').textContent = data.users_without_trial;
                    if (document.getElementById('stat-banned-count')) document.getElementById('stat-banned-count').textContent = data.banned_count || 0;

                    if (data.last_results) {
                        if (document.getElementById('result-sent')) document.getElementById('result-sent').textContent = data.last_results.sent || 0;
                        if (document.getElementById('result-failed')) document.getElementById('result-failed').textContent = data.last_results.failed || 0;
                        if (document.getElementById('result-skipped')) document.getElementById('result-skipped').textContent = data.last_results.skipped || 0;
                        if (data.last_results.timestamp) {
                            const date = new Date(data.last_results.timestamp);
                            if (document.getElementById('result-time')) document.getElementById('result-time').textContent = `Последняя рассылка: ${date.toLocaleString('ru-RU')} `;
                        }
                    }

                    if (data.expiring_counts) {
                        const daySuffix = { 1: 'день', 3: 'дня', 5: 'дней', 10: 'дней' };
                        for (const [day, count] of Object.entries(data.expiring_counts)) {
                            const el = document.getElementById(`expiring-label-${day}`);
                            if (el) {
                                const suffix = daySuffix[day] || 'дней';
                                el.innerHTML = `${day} ${suffix} <span class="text-white/50">(${count})</span>`;
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        loadStats();

        document.getElementById('btn-upload-media').addEventListener('click', () => {
            document.getElementById('media-input').click();
        });

        document.getElementById('media-input').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const maxSize = 500 * 1024 * 1024;
            if (file.size > maxSize) {
                window.showToast('danger', `Файл слишком большой. Максимальный размер: 500 МБ. Размер вашего файла: ${(file.size / 1024 / 1024).toFixed(2)} МБ`);
                e.target.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const loading = document.createElement('p');
                loading.textContent = 'Загрузка...';
                loading.className = 'text-white/50 text-sm mt-2';
                e.target.parentElement.appendChild(loading);

                const resp = await fetch('/other/broadcast/upload', {
                    method: 'POST',
                    body: formData
                });

                loading.remove();

                if (!resp.ok) {
                    if (resp.status === 413) {
                        window.showToast('danger', 'Файл слишком большой для загрузки. Максимальный размер: 500 МБ');
                    } else {
                        window.showToast('danger', `Ошибка сервера: ${resp.status} ${resp.statusText}`);
                    }
                    e.target.value = '';
                    return;
                }

                const data = await resp.json();

                if (data.ok) {
                    uploadedMediaFilename = data.filename;
                    const preview = document.getElementById('media-preview');
                    const img = document.getElementById('media-preview-img');
                    const video = document.getElementById('media-preview-video');

                    preview.classList.remove('hidden');

                    if (data.media_type === 'photo' || data.media_type === 'animation') {
                        img.src = URL.createObjectURL(file);
                        img.classList.remove('hidden');
                        video.classList.add('hidden');
                    } else if (data.media_type === 'video') {
                        video.src = URL.createObjectURL(file);
                        video.classList.remove('hidden');
                        img.classList.add('hidden');
                    }

                    window.showToast('success', 'Медиа загружено');
                } else {
                    window.showToast('danger', data.error || 'Ошибка загрузки');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', 'Ошибка загрузки медиа');
            }
        });

        document.getElementById('btn-remove-media').addEventListener('click', async () => {
            if (uploadedMediaFilename) {
                try {
                    await fetch(`/other/broadcast/delete-media/${uploadedMediaFilename}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': window.getCsrfToken()
                        }
                    });
                } catch (e) {
                    console.error('Failed to delete media:', e);
                }
                uploadedMediaFilename = null;
            }
            document.getElementById('media-preview').classList.add('hidden');
            document.getElementById('media-input').value = '';
        });

        function renderButtons() {
            const list = document.getElementById('buttons-list');
            list.innerHTML = '';
            buttons.forEach((btn, idx) => {
                const item = document.createElement('div');
                item.className = 'flex gap-2';
                item.innerHTML = `
                    <input type="text" value="${btn.text}" placeholder="Текст кнопки" class="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-xs font-medium focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all placeholder:text-white/30" data-idx="${idx}" data-field="text" />
                    <input type="url" value="${btn.url}" placeholder="https://..." class="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-xs font-medium focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all placeholder:text-white/30" data-idx="${idx}" data-field="url" />
                    <button type="button" class="px-2.5 py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20 transition-colors" data-remove="${idx}">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                `;
                list.appendChild(item);
            });

            list.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    const field = e.target.dataset.field;
                    buttons[idx][field] = e.target.value;
                });
            });

            list.querySelectorAll('[data-remove]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.closest('[data-remove]').dataset.remove);
                    buttons.splice(idx, 1);
                    renderButtons();
                });
            });
        }

        document.getElementById('btn-add-button').addEventListener('click', () => {
            if (buttons.length >= 6) {
                window.showToast('warning', 'Максимум 6 кнопок');
                return;
            }
            buttons.push({ text: '', url: '' });
            renderButtons();
        });

        document.getElementById('btn-preview').addEventListener('click', async () => {
            const text = document.getElementById('broadcast-text').value.trim();
            if (!text) {
                window.showToast('warning', 'Введите текст сообщения');
                return;
            }

            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('text', text);
            formData.append('buttons', JSON.stringify(buttons));
            if (uploadedMediaFilename) {
                formData.append('media_filename', uploadedMediaFilename);
            }

            try {
                const resp = await fetch('/other/broadcast/preview', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'Предпросмотр отправлен вам в бот');
                } else {
                    window.showToast('danger', data.error || 'Ошибка отправки');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка отправки предпросмотра');
            }
        });

        document.getElementById('btn-clear-banned').addEventListener('click', async function () {
            if (!await window.showConfirm({
                title: 'Очистка списка',
                message: 'Вы уверены, что хотите очистить список забаненных пользователей?',
                type: 'warning',
                confirmText: 'Очистить'
            })) return;

            const btn = this;
            btn.disabled = true;
            try {
                const resp = await fetch('/other/broadcast/clear-banned', { method: 'POST', headers: { 'X-CSRFToken': window.getCsrfToken() } });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'Список очищен');
                    loadStats();
                } else {
                    window.showToast('danger', data.error || 'Ошибка');
                }
            } catch (e) { window.showToast('danger', 'Ошибка сети'); }
            finally { btn.disabled = false; }
        });

        document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const text = document.getElementById('broadcast-text').value.trim();
            if (!text) {
                window.showToast('warning', 'Введите текст сообщения');
                return;
            }

            const mode = document.querySelector('input[name="mode"]:checked').value;

            const confirmed = await window.showConfirm({
                title: 'Отправка рассылки',
                message: 'Вы уверены, что хотите отправить рассылку всем пользователям?',
                type: 'warning',
                confirmText: 'Отправить',
                cancelText: 'Отмена'
            });
            if (!confirmed) return;

            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('text', text);
            formData.append('mode', mode);
            const skipBanned = document.getElementById('skip-banned-toggle').checked;
            formData.append('skip_banned', skipBanned);
            formData.append('buttons', JSON.stringify(buttons));
            if (uploadedMediaFilename) {
                formData.append('media_filename', uploadedMediaFilename);
            }

            const btn = document.getElementById('btn-send');
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Отправка...`;

            try {
                const resp = await fetch('/other/broadcast/send', {
                    method: 'POST',
                    body: formData
                });

                if (!resp.ok) {
                    if (resp.status === 504) {
                        window.showToast('warning', 'Рассылка запущена, но сервер не успел ответить вовремя. Проверьте результаты через несколько минут.');
                    } else {
                        window.showToast('danger', `Ошибка сервера: ${resp.status}`);
                    }
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> Отправить рассылку';
                    return;
                }

                const contentType = resp.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    window.showToast('danger', 'Сервер вернул некорректный ответ');
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> Отправить рассылку';
                    return;
                }

                const data = await resp.json();

                if (data.ok && data.task_id) {

                    document.getElementById('broadcast-progress-container').classList.remove('hidden');

                    const pollStatus = async (taskId) => {
                        try {
                            const statusResp = await fetch(`/other/broadcast/status/${taskId}`);
                            if (!statusResp.ok) return;

                            const statusData = await statusResp.json();
                            if (!statusData.ok) return;

                            const progress = statusData.progress;

                            document.getElementById('broadcast-progress-bar').style.width = `${progress.progress}%`;
                            document.getElementById('broadcast-progress-percent').textContent = `${progress.progress}%`;
                            document.getElementById('broadcast-progress-sent').textContent = progress.sent || 0;
                            document.getElementById('broadcast-progress-failed').textContent = progress.failed || 0;
                            document.getElementById('broadcast-progress-skipped').textContent = progress.skipped || 0;

                            if (progress.status === 'completed') {
                                setTimeout(() => {
                                    document.getElementById('broadcast-progress-container').classList.add('hidden');
                                    btn.disabled = false;
                                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> Отправить рассылку';

                                    window.showToast('success',
                                        `Рассылка завершена! Отправлено: ${progress.sent}, Ошибок: ${progress.failed}, Пропущено: ${progress.skipped}`);

                                    loadStats();
                                    document.getElementById('broadcast-text').value = '';
                                    buttons = [];
                                    renderButtons();
                                    if (uploadedMediaFilename) {
                                        document.getElementById('media-preview').classList.add('hidden');
                                        uploadedMediaFilename = null;
                                    }
                                }, 2000);
                            } else {

                                setTimeout(() => pollStatus(taskId), 2000);
                            }
                        } catch (e) {
                            console.error('Error polling broadcast status:', e);
                        }
                    };

                    btn.innerHTML = '<span class="material-symbols-outlined text-base">schedule</span> Рассылка выполняется...';

                    pollStatus(data.task_id);

                    window.showToast('info', `Запущена рассылка для ${data.total_users} пользователей`);
                } else if (data.ok && data.results) {

                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> Отправить рассылку';
                    window.showToast('success', `Рассылка завершена! Отправлено: ${data.results.sent}, Ошибок: ${data.results.failed}, Пропущено: ${data.results.skipped}`);
                    loadStats();
                    document.getElementById('broadcast-text').value = '';
                    buttons = [];
                    renderButtons();
                    if (uploadedMediaFilename) {
                        document.getElementById('media-preview').classList.add('hidden');
                        uploadedMediaFilename = null;
                    }
                } else {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> Отправить рассылку';
                    window.showToast('danger', data.error || 'Ошибка отправки рассылки');
                }
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> Отправить рассылку';
                window.showToast('danger', 'Ошибка отправки рассылки');
            }
        });

        window.movePromoIndicator = function (index) {
            const indicator = document.getElementById('promo_mode_indicator');
            const wrapper = document.getElementById('promo_mode_switch');
            const manualField = document.getElementById('manual-code-field');

            if (indicator) {
                indicator.style.transform = `translateX(${index * 100}%)`;
            }

            if (wrapper) {
                const modeDivs = wrapper.querySelectorAll('label > div');
                modeDivs.forEach((div, i) => {

                    if (i === index) {
                        div.classList.remove('text-white/60', 'hover:text-white');
                        div.classList.add('text-[#102219]');
                    } else {
                        div.classList.add('text-white/60', 'hover:text-white');
                        div.classList.remove('text-[#102219]');
                    }
                });
            }

            if (manualField) {
                if (index === 1) {
                    manualField.classList.remove('hidden');
                } else {
                    manualField.classList.add('hidden');
                }
            }

            const radios = document.getElementsByName('code_mode');
            if (radios[index]) {
                radios[index].checked = true;
            }
        };

        if (window.flatpickr) {
            const commonConfig = {
                enableTime: true,
                time_24hr: true,
                dateFormat: 'Y-m-d H:i',
                minuteIncrement: 5,
                locale: flatpickr.l10ns.ru || 'ru',
                disableMobile: "true"
            };

            flatpickr("#promo_valid_from", commonConfig);
            flatpickr("#promo_valid_until", commonConfig);
        }

        async function loadPromos() {
            try {
                const resp = await fetch('/other/promo/list');
                const data = await resp.json();

                if (data.ok && data.promos) {
                    renderPromos(data.promos);
                }
            } catch (e) {
                console.error('Failed to load promos:', e);
            }
        }

        function renderPromos(promos) {
            const tbody = document.getElementById('promo-table-body');

            if (promos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-white/50">Промокодов нет</td></tr>';
                return;
            }

            tbody.innerHTML = promos.map(promo => {
                const discount = promo.discount_percent
                    ? `${promo.discount_percent}%`
                    : `${promo.discount_amount} ₽`;

                const used = promo.used_total || 0;
                const totalLimit = promo.usage_limit_total || '∞';
                const perUserLimit = promo.usage_limit_per_user || '∞';

                const validFrom = promo.valid_from ? new Date(promo.valid_from).toLocaleDateString('ru-RU') : '—';
                const validUntil = promo.valid_until ? new Date(promo.valid_until).toLocaleDateString('ru-RU') : '—';

                const isActive = promo.is_active;
                const statusColor = isActive ? 'text-green-400' : 'text-red-400';
                const statusText = isActive ? 'Активен' : 'Неактивен';
                const toggleIcon = isActive ? 'toggle_on' : 'toggle_off';

                return `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-4 py-3 text-white font-mono font-bold">${promo.code}</td>
                        <td class="px-4 py-3 text-white">${discount}</td>
                        <td class="px-4 py-3 text-white">${used} / ${totalLimit}</td>
                        <td class="px-4 py-3 text-white">${perUserLimit}</td>
                        <td class="px-4 py-3 text-white/70 text-sm">${validFrom} — ${validUntil}</td>
                        <td class="px-4 py-3 ${statusColor}">${statusText}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="togglePromo('${promo.code}')" class="p-2 rounded hover:border-white/20 border border-transparent transition-all" title="Вкл/Выкл">
                                    <span class="material-symbols-outlined ${statusColor}">${toggleIcon}</span>
                                </button>
                                <button onclick="editPromo('${promo.code}')" class="p-2 rounded hover:border-primary/20 border border-transparent text-primary transition-all" title="Изменить условия">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button onclick="deletePromo('${promo.code}')" class="p-2 rounded hover:border-red-500/20 border border-transparent text-red-400 transition-all" title="Удалить">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('promo-create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            const codeMode = formData.get('code_mode');
            if (codeMode === 'auto') {
                formData.delete('code');
            }
            formData.delete('code_mode');

            try {
                const resp = await fetch('/other/promo/create', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `Промокод ${data.code} создан!`);
                    e.target.reset();
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || 'Ошибка создания промокода');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', 'Ошибка создания промокода');
            }
        });

        window.togglePromo = async function (code) {
            try {
                const resp = await fetch(`/other/promo/toggle/${code}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `Промокод ${data.is_active ? 'активирован' : 'деактивирован'}`);
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || 'Ошибка изменения статуса');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка изменения статуса');
            }
        };

        window.editPromo = async function (code) {
            try {
                const resp = await fetch('/other/promo/list');
                const data = await resp.json();

                if (data.ok) {
                    const promo = data.promos.find(p => p.code === code);
                    if (!promo) return;

                    document.getElementById('edit-promo-code').value = promo.code;
                    document.getElementById('edit-code-display').value = promo.code;

                    const discountType = promo.discount_percent ? 'percent' : 'fixed';
                    document.querySelector(`input[name="edit_discount_type"][value="${discountType}"]`).checked = true;
                    document.querySelector('input[name="edit_discount_value"]').value = promo.discount_percent || promo.discount_amount;

                    document.querySelector('input[name="edit_usage_limit_total"]').value = promo.usage_limit_total || '';
                    document.querySelector('input[name="edit_usage_limit_per_user"]').value = promo.usage_limit_per_user || '';

                    if (promo.valid_from) {
                        const dt = new Date(promo.valid_from);
                        document.querySelector('input[name="edit_valid_from"]').value = dt.toISOString().slice(0, 16);
                    }
                    if (promo.valid_until) {
                        const dt = new Date(promo.valid_until);
                        document.querySelector('input[name="edit_valid_until"]').value = dt.toISOString().slice(0, 16);
                    }

                    document.querySelector('textarea[name="edit_description"]').value = promo.description || '';

                    openModal('editPromoModal');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка загрузки данных промокода');
            }
        };

        document.getElementById('promo-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const code = document.getElementById('edit-promo-code').value;
            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('discount_type', document.querySelector('input[name="edit_discount_type"]:checked').value);
            formData.append('discount_value', document.querySelector('input[name="edit_discount_value"]').value);
            formData.append('usage_limit_total', document.querySelector('input[name="edit_usage_limit_total"]').value);
            formData.append('usage_limit_per_user', document.querySelector('input[name="edit_usage_limit_per_user"]').value);
            formData.append('valid_from', document.querySelector('input[name="edit_valid_from"]').value);
            formData.append('valid_until', document.querySelector('input[name="edit_valid_until"]').value);
            formData.append('description', document.querySelector('textarea[name="edit_description"]').value);

            try {
                const resp = await fetch(`/other/promo/update/${code}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', 'Промокод обновлён');
                    closeModal('editPromoModal');
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || 'Ошибка обновления');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', 'Ошибка обновления промокода');
            }
        });

        window.deletePromo = async function (code) {
            const confirmed = await window.showConfirm({
                title: 'Удаление промокода',
                message: `Вы уверены, что хотите удалить промокод "${code}"?`,
                type: 'danger',
                confirmText: 'Удалить',
                cancelText: 'Отмена'
            });
            if (!confirmed) return;

            try {
                const resp = await fetch(`/other/promo/delete/${code}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', 'Промокод удалён');
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || 'Ошибка удаления');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка удаления промокода');
            }
        };

        const promoTab = document.querySelector('[data-tab="promo"]');
        if (promoTab) {
            promoTab.addEventListener('click', () => {
                loadPromos();
            });
        }



        async function loadServers() {
            try {
                const resp = await fetch('/other/servers/list');
                const data = await resp.json();

                if (data.ok) {
                    sshTargetsData = data.ssh_targets || [];
                    renderHosts(data.hosts || []);
                    renderSshTargets(data.ssh_targets || []);
                }
            } catch (e) {
                console.error('Failed to load servers:', e);
            }
        }

        function renderHosts(hosts) {
            const listEl = document.getElementById('remna-hosts-list');
            const countEl = document.getElementById('remna-hosts-count');

            countEl.textContent = hosts.length;

            if (hosts.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-6 text-blue-300/40">
                        <span class="material-symbols-outlined text-3xl mb-2">dns</span>
                        <p class="text-sm">Хосты не добавлены</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    ${hosts.map((host, idx) => `
                        <div class="rounded-xl bg-white/5 border border-white/10 overflow-hidden host-card transition-transform duration-200" draggable="true" data-host-name="${host.host_name}">
                            <div class="p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2.5">
                                        <div class="cursor-grab active:cursor-grabbing text-white/20 hover:text-white transition-colors drag-handle -ml-1">
                                            <span class="material-symbols-outlined">drag_indicator</span>
                                        </div>
                                        <div class="relative">
                                            <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500/20 to-cyan-500/10 flex items-center justify-center border border-blue-500/20">
                                                <span class="material-symbols-outlined text-blue-400 text-lg">dns</span>
                                            </div>
                                            <div class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full border-2 border-[#0d1f17] bg-blue-400 shadow-lg shadow-blue-500/50" id="host-status-${idx}"></div>
                                        </div>
                                        <div class="min-w-0">
                                            <div class="text-white font-semibold text-sm truncate max-w-[140px]">${host.host_name}</div>
                                            <div class="text-white/40 text-[10px] font-mono truncate">${host.ssh_host || 'N/A'}:${host.ssh_port || 22}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="refreshHostUptime('${host.host_name}', ${idx})" 
                                            class="w-7 h-7 rounded-lg bg-white/5 hover:border-white/30 border border-transparent flex items-center justify-center text-white/50 hover:text-white transition-all" title="Обновить">
                                            <span class="material-symbols-outlined text-sm">refresh</span>
                                        </button>
                                        <div class="relative" id="host-menu-${idx}">
                                            <button onclick="toggleHostMenu(${idx})" 
                                                class="w-7 h-7 rounded-lg bg-white/5 hover:border-white/30 border border-transparent flex items-center justify-center text-white/50 hover:text-white transition-all">
                                                <span class="material-symbols-outlined text-sm">more_vert</span>
                                            </button>
                                            <div id="host-dropdown-${idx}" class="hidden absolute right-0 top-full mt-1 w-44 bg-[#0d1f17] border border-white/10 rounded-lg shadow-xl z-50 overflow-hidden">
                                                <button onclick="rebootServer('host', '${host.host_name}'); toggleHostMenu(${idx})" 
                                                    class="w-full px-3 py-2 text-left text-xs text-red-400 hover:bg-red-500/10 flex items-center gap-2 transition-all">
                                                    <span class="material-symbols-outlined text-sm">restart_alt</span>
                                                    Перезагрузить
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="rounded-lg bg-black/20 border border-white/[0.04] p-3 mb-3" id="host-uptime-${idx}">
                                    <div class="flex items-center justify-center gap-2 text-white/40 py-2">
                                        <span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>
                                        <span class="text-xs">Загрузка...</span>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="window.openExecuteCommandModal('host', '${host.host_name}')" 
                                        class="flex-1 px-3 py-2 rounded-lg bg-white/5 hover:border-white/30 border border-white/10 text-white/80 hover:text-white text-xs font-medium flex items-center justify-center gap-1.5 transition-all">
                                        <span class="material-symbols-outlined text-sm">terminal</span>
                                        Терминал
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            hosts.forEach((host, idx) => {
                loadUptime('host', host.host_name, idx);
            });

            initHostsDragAndDrop();
        }

        function initHostsDragAndDrop() {
            const listEl = document.getElementById('remna-hosts-list');
            const container = listEl.querySelector('.grid');
            if (!container) return;

            let draggedItem = null;

            container.addEventListener('dragstart', (e) => {
                const card = e.target.closest('.host-card');
                if (!card) return;

                draggedItem = card;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', card.dataset.hostName);

                setTimeout(() => {
                    card.classList.add('opacity-50', 'scale-95');
                }, 0);
            });

            container.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('opacity-50', 'scale-95');
                    draggedItem = null;
                    saveHostsSortOrder();
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedItem) return;

                const targetCard = e.target.closest('.host-card');
                if (targetCard && targetCard !== draggedItem) {
                    const siblings = Array.from(container.children);
                    const draggedIndex = siblings.indexOf(draggedItem);
                    const targetIndex = siblings.indexOf(targetCard);

                    if (draggedIndex < targetIndex) {
                        container.insertBefore(draggedItem, targetCard.nextSibling);
                    } else {
                        container.insertBefore(draggedItem, targetCard);
                    }
                }
            });
        }

        async function saveHostsSortOrder() {
            const cards = document.querySelectorAll('.host-card');
            const order = Array.from(cards).map(card => card.dataset.hostName);

            try {
                await fetch('/other/servers/hosts/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.getCsrfToken()
                    },
                    body: JSON.stringify({ order: order })
                });
            } catch (e) {
                console.error('Failed to save sort order:', e);
                window.showToast('danger', 'Ошибка сохранения порядка');
            }
        }

        window.toggleHostMenu = function (idx) {
            const dropdown = document.getElementById(`host-dropdown-${idx}`);
            const allDropdowns = document.querySelectorAll('[id^="host-dropdown-"]');
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.add('hidden');
            });
            dropdown.classList.toggle('hidden');
        };

        document.addEventListener('click', function (e) {
            if (!e.target.closest('[id^="host-menu-"]')) {
                document.querySelectorAll('[id^="host-dropdown-"]').forEach(d => d.classList.add('hidden'));
            }
        });

        function renderSshTargets(targets) {
            const listEl = document.getElementById('ssh-targets-list');
            const countEl = document.getElementById('ssh-targets-count');

            countEl.textContent = targets.length;

            if (targets.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-8 text-yellow-300/40">
                        <span class="material-symbols-outlined text-4xl mb-2">terminal</span>
                        <p class="text-sm">SSH-цели не добавлены</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    ${targets.map((target, idx) => `
                        <div class="rounded-xl bg-white/5 border border-white/10 overflow-hidden ssh-target-card transition-transform duration-200" draggable="true" data-target-name="${target.target_name}">
                            
                            <div class="relative p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2.5">
                                        <div class="cursor-grab active:cursor-grabbing text-white/20 hover:text-white transition-colors drag-handle -ml-1">
                                            <span class="material-symbols-outlined">drag_indicator</span>
                                        </div>
                                        <div class="relative">
                                            <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-yellow-500/20 to-orange-500/10 flex items-center justify-center border border-yellow-500/20">
                                                <span class="material-symbols-outlined text-yellow-400 text-lg">dns</span>
                                            </div>
                                            <div class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full border-2 border-[#0d1f17] bg-yellow-400 shadow-lg shadow-yellow-500/50" id="target-status-${idx}"></div>
                                        </div>
                                        <div class="min-w-0">
                                            <div class="text-white font-semibold text-sm truncate max-w-[140px]">${target.target_name}</div>
                                            <div class="text-white/40 text-[10px] font-mono truncate">${target.ssh_host}:${target.ssh_port || 22}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="refreshTargetUptime('${target.target_name}', ${idx})" 
                                            class="w-7 h-7 rounded-lg bg-white/5 hover:border-white/30 border border-transparent flex items-center justify-center text-white/50 hover:text-white transition-all" title="Обновить">
                                            <span class="material-symbols-outlined text-sm">refresh</span>
                                        </button>
                                        <div class="relative" id="target-menu-${idx}">
                                            <button onclick="toggleTargetMenu(${idx})" 
                                                class="w-7 h-7 rounded-lg bg-white/5 hover:border-white/30 border border-transparent flex items-center justify-center text-white/50 hover:text-white transition-all">
                                                <span class="material-symbols-outlined text-sm">more_vert</span>
                                            </button>
                                            <div id="target-dropdown-${idx}" class="hidden absolute right-0 top-full mt-1 w-44 bg-[#0d1f17] border border-white/10 rounded-lg shadow-xl z-50 overflow-hidden">
                                                <button onclick="rebootServer('ssh', '${target.target_name}'); toggleTargetMenu(${idx})" 
                                                    class="w-full px-3 py-2 text-left text-xs text-red-400 hover:bg-red-500/10 flex items-center gap-2 transition-all">
                                                    <span class="material-symbols-outlined text-sm">restart_alt</span>
                                                    Перезагрузить
                                                </button>
                                                <button onclick="openSchedulerModal('${target.target_name}'); toggleTargetMenu(${idx})" 
                                                    class="w-full px-3 py-2 text-left text-xs text-cyan-400 hover:bg-cyan-500/10 flex items-center gap-2 transition-all">
                                                    <span class="material-symbols-outlined text-sm">schedule</span>
                                                    Планировщик
                                                </button>
                                                <div class="border-t border-white/5"></div>
                                                <button onclick="openWarpWizard('${target.target_name}'); toggleTargetMenu(${idx})" 
                                                    class="w-full px-3 py-2 text-left text-xs text-blue-400 hover:bg-blue-500/10 flex items-center gap-2 transition-all">
                                                    <span class="material-symbols-outlined text-sm">vpn_lock</span>
                                                    WARP
                                                </button>
                                                <button onclick="openSwapModal('${target.target_name}'); toggleTargetMenu(${idx})" 
                                                    class="w-full px-3 py-2 text-left text-xs text-purple-400 hover:bg-purple-500/10 flex items-center gap-2 transition-all">
                                                    <span class="material-symbols-outlined text-sm">memory</span>
                                                    SWAP
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="rounded-lg bg-black/20 border border-white/[0.04] p-3 mb-3" id="target-uptime-${idx}">
                                    <div class="flex items-center justify-center gap-2 text-white/40 py-2">
                                        <span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>
                                        <span class="text-xs">Загрузка...</span>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="deployNodeWizard('${target.target_name}')" 
                                        class="flex-1 px-3 py-2 rounded-lg bg-white/5 hover:border-white/30 border border-white/10 text-white/80 hover:text-white text-xs font-medium flex items-center justify-center gap-1.5 transition-all">
                                        <span class="material-symbols-outlined text-sm">rocket_launch</span>
                                        Развернуть
                                    </button>
                                    <button onclick="window.openExecuteCommandModal('ssh', '${target.target_name}')" 
                                        class="flex-1 px-3 py-2 rounded-lg bg-white/5 hover:border-white/30 border border-white/10 text-white/80 hover:text-white text-xs font-medium flex items-center justify-center gap-1.5 transition-all">
                                        <span class="material-symbols-outlined text-sm">terminal</span>
                                        Терминал
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            targets.forEach((target, idx) => {
                loadUptime('ssh', target.target_name, idx);
            });

            initSshDragAndDrop();
        }

        window.toggleTargetMenu = function (idx) {
            const dropdown = document.getElementById(`target-dropdown-${idx}`);
            const allDropdowns = document.querySelectorAll('[id^="target-dropdown-"]');
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.add('hidden');
            });
            dropdown.classList.toggle('hidden');
        };

        document.addEventListener('click', function (e) {
            if (!e.target.closest('[id^="target-menu-"]')) {
                document.querySelectorAll('[id^="target-dropdown-"]').forEach(d => d.classList.add('hidden'));
            }
        });

        async function loadUptime(type, name, idx) {
            const uptimeEl = type === 'host' ? document.getElementById(`host-uptime-${idx}`) : document.getElementById(`target-uptime-${idx}`);
            const statusEl = type === 'host' ? document.getElementById(`host-status-${idx}`) : document.getElementById(`target-status-${idx}`);

            try {
                const resp = await fetch(`/other/servers/uptime/${type}/${encodeURIComponent(name)}`);
                const data = await resp.json();

                if (data.ok) {
                    if (uptimeEl) {
                        const uptimeSeconds = data.uptime_seconds || 0;
                        const isUptimeLong = uptimeSeconds >= 864000;

                        const cpuPercent = data.cpu_percent || 0;
                        const ramPercent = data.ram_percent || 0;
                        const swapPercent = data.swap_percent || 0;

                        let cpuBarColor = 'from-emerald-500 to-emerald-400';
                        let cpuTextColor = 'text-emerald-400';
                        if (cpuPercent > 70) { cpuBarColor = 'from-red-500 to-red-400'; cpuTextColor = 'text-red-400'; }
                        else if (cpuPercent > 40) { cpuBarColor = 'from-amber-500 to-yellow-400'; cpuTextColor = 'text-amber-400'; }

                        let ramBarColor = 'from-emerald-500 to-emerald-400';
                        let ramTextColor = 'text-emerald-400';
                        if (ramPercent > 85) { ramBarColor = 'from-red-500 to-red-400'; ramTextColor = 'text-red-400'; }
                        else if (ramPercent > 55) { ramBarColor = 'from-amber-500 to-yellow-400'; ramTextColor = 'text-amber-400'; }

                        let swapBarColor = 'from-emerald-500 to-emerald-400';
                        let swapTextColor = 'text-emerald-400';
                        if (swapPercent > 85) { swapBarColor = 'from-red-500 to-red-400'; swapTextColor = 'text-red-400'; }
                        else if (swapPercent > 65) { swapBarColor = 'from-amber-500 to-yellow-400'; swapTextColor = 'text-amber-400'; }

                        uptimeEl.innerHTML = `
                            <div class="space-y-2.5">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-1.5">
                                        <span class="material-symbols-outlined ${isUptimeLong ? 'text-emerald-400' : 'text-white/50'}" style="font-size: 13px">schedule</span>
                                        <span class="text-[11px] text-white/70 font-medium">Uptime</span>
                                    </div>
                                    <span class="text-[11px] ${isUptimeLong ? 'text-emerald-400' : 'text-white'} font-semibold">${data.uptime_formatted}</span>
                                </div>
                                
                                <div class="space-y-1.5">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined ${cpuTextColor}" style="font-size: 13px">memory</span>
                                            <span class="text-[11px] text-white/70">CPU</span>
                                        </div>
                                        <span class="text-[11px] ${cpuTextColor} font-semibold">${cpuPercent}% <span class="text-white/40 font-normal">(${data.cpu_cores} ядер${data.cpu_cores > 1 && data.cpu_cores < 5 ? 'а' : ''})</span></span>
                                    </div>
                                    <div class="h-1.5 bg-white/5 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r ${cpuBarColor} rounded-full transition-all duration-500 shadow-sm" style="width: ${cpuPercent}%"></div>
                                    </div>
                                </div>
                                
                                <div class="space-y-1.5">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined ${ramTextColor}" style="font-size: 13px">developer_board</span>
                                            <span class="text-[11px] text-white/70">RAM</span>
                                        </div>
                                        <span class="text-[11px] ${ramTextColor} font-semibold">${ramPercent}% <span class="text-white/40 font-normal">(${data.ram_used} / ${data.ram_total} МБ)</span></span>
                                    </div>
                                    <div class="h-1.5 bg-white/5 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r ${ramBarColor} rounded-full transition-all duration-500 shadow-sm" style="width: ${ramPercent}%"></div>
                                    </div>
                                </div>
                                
                                <div class="space-y-1.5">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined ${data.swap_total > 0 ? swapTextColor : 'text-white/30'}" style="font-size: 13px">swap_horiz</span>
                                            <span class="text-[11px] text-white/70">SWAP</span>
                                        </div>
                                        ${data.swap_total > 0
                                ? `<span class="text-[11px] ${swapTextColor} font-semibold">${swapPercent}% <span class="text-white/40 font-normal">(${data.swap_used} / ${data.swap_total} МБ) от ${data.swappiness}%</span></span>`
                                : `<span class="text-[11px] text-white/30 font-medium">НЕТ</span>`
                            }
                                    </div>
                                    ${data.swap_total > 0
                                ? `<div class="h-1.5 bg-white/5 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r ${swapBarColor} rounded-full transition-all duration-500 shadow-sm" style="width: ${swapPercent}%"></div>
                                           </div>`
                                : `<div class="h-1.5 bg-white/5 rounded-full overflow-hidden"></div>`
                            }
                                </div>
                                
                                <div class="flex items-center justify-around pt-2 border-t border-white/[0.04]">
                                    <div class="flex items-center gap-1.5" title="${data.net_rx_mbps} Mbps">
                                        <span class="material-symbols-outlined text-blue-400" style="font-size: 14px">download</span>
                                        <span class="text-[10px] text-white/90 font-mono">${data.net_rx_mbs} MB/s</span>
                                    </div>
                                    <div class="flex items-center gap-1.5" title="${data.net_tx_mbps} Mbps">
                                        <span class="material-symbols-outlined text-orange-400" style="font-size: 14px">upload</span>
                                        <span class="text-[10px] text-white/90 font-mono">${data.net_tx_mbs} MB/s</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    if (statusEl) {
                        statusEl.className = 'absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full border-2 border-[#0d1f17] bg-emerald-500 shadow-lg shadow-emerald-500/50';
                    }
                } else {
                    if (uptimeEl) {
                        uptimeEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-red-400 py-2"><span class="material-symbols-outlined text-sm">error</span><span class="text-xs">${data.error || 'Недоступен'}</span></div>`;
                    }
                    if (statusEl) {
                        statusEl.className = 'absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full border-2 border-[#0d1f17] bg-red-500 shadow-lg shadow-red-500/50';
                    }
                }
            } catch (e) {
                console.error('Failed to load uptime:', e);
                if (uptimeEl) {
                    uptimeEl.innerHTML = '<div class="flex items-center justify-center gap-2 text-red-400 py-2"><span class="material-symbols-outlined text-sm">error</span><span class="text-xs">Ошибка загрузки</span></div>';
                }
                if (statusEl) {
                    statusEl.className = 'absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full border-2 border-[#0d1f17] bg-red-500 shadow-lg shadow-red-500/50';
                }
            }
        }

        window.refreshHostUptime = function (name, idx) {
            loadUptime('host', name, idx);
        };

        window.refreshTargetUptime = function (name, idx) {
            loadUptime('ssh', name, idx);
        };

        window.rebootServer = async function (type, name) {
            const typeName = type === 'host' ? 'сервер' : 'SSH-цель';

            const confirmed = await window.showConfirm({
                title: 'Перезагрузка сервера',
                message: `Вы уверены, что хотите перезагрузить ${typeName} "${name}"?\n\nЭто действие приведет к перезапуску системы.`,
                type: 'warning',
                confirmText: 'Перезагрузить',
                cancelText: 'Отмена'
            });
            if (!confirmed) return;

            try {
                const resp = await fetch(`/other/servers/reboot/${type}/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `Команда перезагрузки отправлена на ${name}`);

                    setTimeout(() => {
                        loadServers();
                    }, 5000);
                } else {
                    window.showToast('danger', data.error || 'Ошибка перезагрузки');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка перезагрузки сервера');
            }
        };

        const serversTab = document.querySelector('[data-tab="servers"]');
        if (serversTab) {
            serversTab.addEventListener('click', () => {
                loadServers();

                if (serversAutoRefresh) {
                    clearInterval(serversAutoRefresh);
                }
                serversAutoRefresh = setInterval(() => {
                    loadServers();
                }, 300000);
            });
        }

        let currentDeployTarget = null;
        let currentDeployStep = 1;

        window.deployNodeWizard = async function (targetName) {
            currentDeployTarget = targetName;
            currentDeployStep = 1;

            document.getElementById('deploy-target-name').textContent = targetName;
            document.getElementById('deploy-output').textContent = 'Проверка состояния...';
            document.getElementById('docker-compose-content').value = '';

            for (let i = 1; i <= 5; i++) {
                document.getElementById(`deploy-step-${i}`).classList.add('hidden');
            }

            updateDeployStep(1);
            openModal('deployNodeModal');

            setupDeployHandlers();

            // Показываем кнопки в состоянии проверки
            setDockerButtonsCheckingState(true);

            try {
                appendDeployOutput('[INFO] Проверка текущего состояния развертывания...');

                const resp = await fetch(`/other/servers/deploy/check-status/${encodeURIComponent(targetName)}`);
                if (!resp.ok) {
                    appendDeployOutput('[WARNING] Не удалось проверить состояние. Начинаем с шага 1.');
                    setDockerButtonsCheckingState(false, false); // Docker не установлен
                    return;
                }

                const data = await resp.json();
                if (data.ok && data.status) {
                    const status = data.status;

                    if (status.docker_installed) {
                        appendDeployOutput('[✓] Docker установлен');
                        setDockerButtonsCheckingState(false, true); // Docker установлен
                    } else {
                        appendDeployOutput('[✗] Docker не установлен');
                        setDockerButtonsCheckingState(false, false); // Docker не установлен
                    }

                    if (status.directory_exists) {
                        appendDeployOutput('[✓] Директория /opt/remnanode существует');
                    } else if (status.docker_installed) {
                        appendDeployOutput('[✗] Директория /opt/remnanode не найдена');
                    }

                    if (status.compose_file_exists) {
                        appendDeployOutput('[✓] Файл docker-compose.yml существует');
                    } else if (status.directory_exists) {
                        appendDeployOutput('[✗] Файл docker-compose.yml не найден');
                    }

                    const suggestedStep = status.suggested_step || 1;
                    appendDeployOutput(`[INFO] Переход к шагу ${suggestedStep}...`);

                    if (suggestedStep === 5) {
                        appendDeployOutput('[SUCCESS] Нода уже развернута! Можете управлять ею.');
                        try {
                            const composeResp = await fetch(`/other/servers/deploy/view-compose/${encodeURIComponent(targetName)}`);
                            if (composeResp.ok) {
                                const composeData = await composeResp.json();
                                if (composeData.ok) {
                                    document.getElementById('docker-compose-content').value = composeData.content;
                                }
                            }
                        } catch (e) {
                            console.error('Failed to load docker-compose.yml:', e);
                        }
                    }

                    updateDeployStep(suggestedStep);
                } else {
                    appendDeployOutput('[WARNING] Не удалось проверить состояние. Начинаем с шага 1.');
                    setDockerButtonsCheckingState(false, false); // Docker не установлен
                }
            } catch (e) {
                console.error('Status check error:', e);
                appendDeployOutput('[WARNING] Ошибка проверки состояния. Начинаем с шага 1.');
                setDockerButtonsCheckingState(false, false); // Docker не установлен
            }
        };

        // Функция для установки состояния кнопок Docker
        function setDockerButtonsCheckingState(isChecking, dockerInstalled = false) {
            const installButtons = document.querySelectorAll('.install-docker-btn');

            installButtons.forEach(btn => {
                const iconEl = btn.querySelector('.btn-icon');
                const textSpan = btn.querySelector('.btn-text');

                if (isChecking) {
                    // Состояние проверки
                    btn.disabled = true;
                    if (textSpan) textSpan.textContent = 'Идет проверка...';
                } else {
                    // Проверка завершена
                    if (dockerInstalled) {
                        // Docker установлен - показываем что установлен
                        btn.disabled = true;
                        if (iconEl && iconEl.tagName === 'svg') {
                            iconEl.outerHTML = '<span class="material-symbols-outlined text-sm btn-icon">check_circle</span>';
                        }
                        if (textSpan) textSpan.textContent = 'Установлен';
                    } else {
                        // Docker не установлен - включаем кнопку установки
                        btn.disabled = false;
                        if (iconEl && iconEl.tagName === 'svg') {
                            iconEl.outerHTML = '<span class="material-symbols-outlined text-sm btn-icon">download</span>';
                        }
                        if (textSpan) textSpan.textContent = 'Установить';
                    }
                }
            });
        }

        function setupDeployHandlers() {

            // Обработчик для установки Docker на Ubuntu
            document.getElementById('btn-install-docker-ubuntu').onclick = async function () {
                await executeDeployStep('install-docker', this, async () => {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('os_type', 'ubuntu');

                    const resp = await fetch(`/other/servers/deploy/install-docker/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!resp.ok) {
                        if (resp.status === 504) {
                            throw new Error('TIMEOUT_504: Установка Docker занимает 2-5 минут. Операция может продолжаться на сервере.');
                        }
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 2);
            };

            // Обработчик для установки Docker на Debian
            document.getElementById('btn-install-docker-debian').onclick = async function () {
                await executeDeployStep('install-docker', this, async () => {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('os_type', 'debian');

                    const resp = await fetch(`/other/servers/deploy/install-docker/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!resp.ok) {
                        if (resp.status === 504) {
                            throw new Error('TIMEOUT_504: Установка Docker занимает 2-5 минут. Операция может продолжаться на сервере.');
                        }
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 2);
            };

            document.getElementById('btn-create-directory').onclick = async function () {
                await executeDeployStep('create-directory', this, async () => {
                    const resp = await fetch(`/other/servers/deploy/create-directory/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': window.getCsrfToken() }
                    });

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 3);
            };

            document.getElementById('btn-save-compose').onclick = async function () {
                const content = document.getElementById('docker-compose-content').value.trim();
                if (!content) {
                    window.showToast('warning', 'Введите содержимое файла docker-compose.yml');
                    return;
                }

                await executeDeployStep('save-compose', this, async () => {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('content', content);

                    const resp = await fetch(`/other/servers/deploy/save-compose/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 4);
            };

            document.getElementById('btn-start-containers').onclick = async function () {
                await executeDeployStep('start-containers', this, async () => {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('action', 'start');

                    const resp = await fetch(`/other/servers/deploy/manage-containers/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 5);
            };

            document.getElementById('btn-view-compose').onclick = async function () {
                try {
                    const resp = await fetch(`/other/servers/deploy/view-compose/${encodeURIComponent(currentDeployTarget)}`);
                    const data = await resp.json();

                    if (data.ok) {
                        document.getElementById('docker-compose-content').value = data.content;
                        updateDeployStep(3);
                        window.showToast('success', 'Содержимое файла загружено');
                    } else {
                        window.showToast('danger', data.error || 'Ошибка чтения файла');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', 'Ошибка загрузки файла');
                }
            };

            document.getElementById('btn-cancel-compose').onclick = function () {
                updateDeployStep(5);
                window.showToast('info', 'Изменения не сохранены');
            };

            document.getElementById('btn-restart-node').onclick = async function () {
                const confirmed = await window.showConfirm({
                    title: 'Перезапуск ноды',
                    message: 'Вы уверены, что хотите перезапустить ноду Remnawave?',
                    type: 'warning',
                    confirmText: 'Перезапустить',
                    cancelText: 'Отмена'
                });
                if (!confirmed) return;

                const btn = this;
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Перезапуск...';

                try {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('action', 'restart');

                    const resp = await fetch(`/other/servers/deploy/manage-containers/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        appendDeployOutput('[SUCCESS] ' + data.message);
                        if (data.output) appendDeployOutput(data.output);
                        window.showToast('success', 'Нода перезапущена');
                    } else {
                        appendDeployOutput('[ERROR] ' + (data.error || 'Ошибка перезапуска'));
                        if (data.output) appendDeployOutput(data.output);
                        window.showToast('danger', data.error || 'Ошибка перезапуска');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', 'Ошибка перезапуска ноды');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            };

            document.getElementById('btn-view-logs').onclick = async function () {
                const btn = this;
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Загрузка...';

                try {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('action', 'logs');

                    const resp = await fetch(`/other/servers/deploy/manage-containers/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        appendDeployOutput('[LOGS]\n' + data.output);
                        window.showToast('success', 'Логи загружены');
                    } else {
                        appendDeployOutput('[ERROR] ' + (data.error || 'Ошибка получения логов'));
                        window.showToast('danger', data.error || 'Ошибка получения логов');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', 'Ошибка получения логов');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            };

            document.getElementById('btn-clear-deploy-logs').onclick = function () {
                document.getElementById('deploy-output').textContent = 'Ожидание действий...';
            };

            document.getElementById('btn-remove-all').onclick = function () {

                showDeleteConfirmation(currentDeployTarget);
            };
        }

        function showDeleteConfirmation(serverName) {
            const modal = document.getElementById('confirmDeleteModal');
            const input = document.getElementById('confirm-delete-input');
            const confirmBtn = document.getElementById('btn-confirm-delete');
            const cancelBtn = document.getElementById('btn-cancel-delete');
            const serverNameSpan = document.getElementById('confirm-server-name');

            serverNameSpan.textContent = serverName;
            input.value = '';
            confirmBtn.disabled = true;

            modal.style.display = 'flex';
            setTimeout(() => input.focus(), 100);

            const validateInput = () => {
                confirmBtn.disabled = input.value !== serverName;
            };

            input.oninput = validateInput;

            input.onkeypress = (e) => {
                if (e.key === 'Enter' && !confirmBtn.disabled) {
                    confirmBtn.click();
                }
            };

            const closeConfirmModal = () => {
                modal.style.display = 'none';
                input.value = '';
                input.oninput = null;
                input.onkeypress = null;
            };

            cancelBtn.onclick = closeConfirmModal;

            confirmBtn.onclick = async () => {
                if (input.value !== serverName) {
                    window.showToast('warning', 'Название сервера не совпадает');
                    return;
                }

                closeConfirmModal();

                const btn = document.getElementById('btn-remove-all');
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Удаление...';

                try {
                    appendDeployOutput('[WARNING] Начинается полное удаление ноды и Docker...');

                    const resp = await fetch(`/other/servers/deploy/remove-all/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': window.getCsrfToken() }
                    });

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    const data = await resp.json();

                    if (data.ok) {
                        appendDeployOutput('[SUCCESS] ' + data.message);
                        if (data.output) appendDeployOutput(data.output);
                        window.showToast('success', 'Нода и Docker успешно удалены');

                        setTimeout(() => {
                            closeModal('deployNodeModal');
                        }, 2000);
                    } else {
                        appendDeployOutput('[ERROR] ' + (data.error || 'Ошибка удаления'));
                        if (data.output) appendDeployOutput(data.output);
                        window.showToast('danger', data.error || 'Ошибка удаления');
                    }
                } catch (e) {
                    console.error('Remove all error:', e);
                    appendDeployOutput('[ERROR] ' + e.message);
                    window.showToast('danger', 'Ошибка удаления: ' + e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            };
        }

        async function executeDeployStep(stepName, button, apiCall, nextStep) {
            button.disabled = true;
            const originalHtml = button.innerHTML;
            button.innerHTML = '<svg class="animate-spin h-5 w-5 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Выполнение...';

            try {
                appendDeployOutput(`[INFO] Выполняется: ${stepName}...`);
                const data = await apiCall();

                if (data.ok) {
                    appendDeployOutput('[SUCCESS] ' + data.message);
                    if (data.output) {
                        appendDeployOutput(data.output);
                    }

                    window.showToast('success', data.message || 'Шаг выполнен успешно');
                    updateDeployStep(nextStep);
                } else {
                    appendDeployOutput('[ERROR] ' + (data.error || 'Произошла ошибка'));
                    if (data.output) {
                        appendDeployOutput(data.output);
                    }
                    window.showToast('danger', data.error || 'Ошибка выполнения шага');
                }
            } catch (e) {
                console.error('Deploy step error:', e);

                if (e.message && e.message.includes('TIMEOUT_504')) {
                    const cleanMessage = e.message.replace('TIMEOUT_504: ', '');
                    appendDeployOutput('[WARNING] ' + cleanMessage);
                    appendDeployOutput('[INFO] Вы можете продолжить вручную или попробовать следующий шаг.');
                    window.showToast('warning', 'Таймаут: ' + cleanMessage);
                } else if (e.message && e.message.includes('HTTP')) {
                    appendDeployOutput('[ERROR] ' + e.message);
                    window.showToast('danger', 'Ошибка сервера: ' + e.message);
                } else {
                    appendDeployOutput('[ERROR] Ошибка: ' + e.message);
                    window.showToast('danger', 'Ошибка: ' + e.message);
                }
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }

        // Функция для показа/скрытия индикатора проверки Docker
        function showDockerCheckStatus(show) {
            const checkStatusEl = document.getElementById('docker-check-status');
            const installButtons = document.querySelectorAll('.install-docker-btn');

            if (show) {
                checkStatusEl.classList.remove('hidden');
                installButtons.forEach(btn => {
                    btn.disabled = true;
                });
            } else {
                checkStatusEl.classList.add('hidden');
                installButtons.forEach(btn => {
                    btn.disabled = false;
                });
            }
        }

        function updateDeployStep(step) {
            currentDeployStep = step;

            for (let i = 1; i <= 5; i++) {
                document.getElementById(`deploy-step-${i}`).classList.add('hidden');
            }

            document.getElementById(`deploy-step-${step}`).classList.remove('hidden');

            document.getElementById('deploy-current-step').textContent = step;
            document.getElementById('deploy-progress-bar').style.width = `${step * 20}%`;

            const stepNames = [
                '',
                'Установка Docker',
                'Создание директории',
                'Создание docker-compose.yml',
                'Запуск контейнеров',
                'Управление нодой'
            ];

            document.getElementById('deploy-step-name').textContent = stepNames[step] || 'Завершено';
        }

        function appendDeployOutput(text) {
            const output = document.getElementById('deploy-output');
            const timestamp = new Date().toLocaleTimeString('ru-RU');

            if (output.textContent === 'Ожидание действий...') {
                output.textContent = '';
            }

            output.textContent += `[${timestamp}] ${text}\n`;
            output.scrollTop = output.scrollHeight;
        }

        let currentWarpTarget = null;

        window.openWarpWizard = function (targetName) {
            currentWarpTarget = targetName;
            document.getElementById('warp-target-name').textContent = targetName;

            openModal('warpModal');
            checkWarpStatus(targetName);

            document.getElementById('warp-logs').textContent = '';
            document.getElementById('warp-logs-container').classList.add('hidden');
            switchWarpTab('config');
        }

        window.switchWarpTab = function (tab) {
            const btnConfig = document.getElementById('btn-tab-warp-config');
            const btnJson = document.getElementById('btn-tab-warp-json');
            const btnSystemd = document.getElementById('btn-tab-warp-systemd');

            const contentConfig = document.getElementById('warp-content-config');
            const contentJson = document.getElementById('warp-content-json');
            const contentSystemd = document.getElementById('warp-content-systemd');

            const activeClass = 'px-4 py-2 text-primary border-b-2 border-primary font-medium text-sm transition-colors';
            const inactiveClass = 'px-4 py-2 text-white/50 hover:text-white font-medium text-sm transition-colors';

            btnConfig.className = inactiveClass;
            btnJson.className = inactiveClass;
            btnSystemd.className = inactiveClass;
            contentConfig.classList.add('hidden');
            contentJson.classList.add('hidden');
            contentSystemd.classList.add('hidden');

            if (tab === 'config') {
                btnConfig.className = activeClass;
                contentConfig.classList.remove('hidden');
            } else if (tab === 'json') {
                btnJson.className = activeClass;
                contentJson.classList.remove('hidden');
            } else if (tab === 'systemd') {
                btnSystemd.className = activeClass;
                contentSystemd.classList.remove('hidden');
                loadWarpSystemdConfig();
            }
        }

        async function checkWarpStatus(targetName) {
            document.getElementById('warp-loading').classList.remove('hidden');
            document.getElementById('warp-install-state').classList.add('hidden');
            document.getElementById('warp-manage-state').classList.add('hidden');

            try {
                const resp = await fetch(`/other/servers/warp/status/${encodeURIComponent(targetName)}`);
                const data = await resp.json();

                document.getElementById('warp-loading').classList.add('hidden');

                if (data.ok && data.status) {
                    if (data.status.installed) {
                        document.getElementById('warp-manage-state').classList.remove('hidden');

                        const indicator = document.getElementById('warp-status-indicator');
                        const text = document.getElementById('warp-status-text');

                        if (data.status.active) {
                            indicator.className = 'w-4 h-4 rounded-full bg-green-500 shadow-lg shadow-green-500/50';
                            text.textContent = 'Активен (Running)';
                            text.className = 'text-green-400 font-bold';

                            const btnToggle = document.getElementById('btn-warp-toggle');
                            if (btnToggle) {
                                btnToggle.title = 'Остановить сервис';
                                btnToggle.className = 'p-2 rounded-lg bg-red-500/20 hover:border-red-500/30 border border-transparent text-red-400 transition-all';
                                btnToggle.innerHTML = '<span class="material-symbols-outlined">stop_circle</span>';
                                btnToggle.dataset.action = 'stop';
                            }
                        } else {
                            indicator.className = 'w-4 h-4 rounded-full bg-red-500';
                            text.textContent = 'Остановлен (Inactive)';
                            text.className = 'text-red-400 font-bold';

                            const btnToggle = document.getElementById('btn-warp-toggle');
                            if (btnToggle) {
                                btnToggle.title = 'Запустить сервис';
                                btnToggle.className = 'p-2 rounded-lg bg-green-500/20 hover:border-green-500/30 border border-transparent text-green-400 transition-all';
                                btnToggle.innerHTML = '<span class="material-symbols-outlined">play_circle</span>';
                                btnToggle.dataset.action = 'start';
                            }
                        }

                        document.getElementById('warp-memory-max').value = data.status.memory_max || '800M';
                        document.getElementById('warp-memory-high').value = data.status.memory_high || '1G';
                    } else {
                        document.getElementById('warp-install-state').classList.remove('hidden');
                    }
                } else {
                    window.showToast('danger', 'Ошибка получения статуса');
                    closeModal('warpModal');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка сети');
                closeModal('warpModal');
            }
        }

        async function loadWarpSystemdConfig() {
            if (!currentWarpTarget) return;

            const textarea = document.getElementById('warp-systemd-textarea');
            textarea.value = 'Загрузка...';

            try {
                const resp = await fetch(`/other/servers/warp/systemd/get/${encodeURIComponent(currentWarpTarget)}`);
                const data = await resp.json();

                if (data.ok) {
                    textarea.value = data.content || '';
                } else {
                    textarea.value = '';
                    window.showToast('warning', 'Не удалось загрузить конфиг: ' + (data.error || 'Unknown'));
                }
            } catch (e) {
                console.error(e);
                textarea.value = '';
                window.showToast('danger', 'Ошибка загрузки конфига');
            }
        }

        document.getElementById('btn-warp-systemd-save').onclick = async function () {
            if (!currentWarpTarget) return;

            const btn = this;
            const textarea = document.getElementById('warp-systemd-textarea');
            const content = textarea.value;

            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Сохранение...';

            try {
                const formData = new FormData();
                formData.append('content', content);
                formData.append('csrf_token', window.getCsrfToken());

                const resp = await fetch(`/other/servers/warp/systemd/save/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', 'Конфигурация сохранена и сервис перезапущен');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    window.showToast('danger', data.error || 'Ошибка сохранения');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка сохранения конфига');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        };

        document.getElementById('btn-warp-check-log-usage').onclick = async function () {
            if (!currentWarpTarget) return;

            const btn = this;
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Проверка...';

            try {
                const resp = await fetch(`/other/servers/warp/logs/usage/${encodeURIComponent(currentWarpTarget)}`);
                const data = await resp.json();

                if (data.ok) {
                    await window.showConfirm({
                        title: 'Размер журнала (journalctl)',
                        message: data.usage || 'Нет данных',
                        type: 'info',
                        confirmText: 'OK',
                        cancelText: ''
                    });
                } else {
                    window.showToast('danger', data.error || 'Ошибка получения данных');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка запроса');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        };

        document.getElementById('btn-warp-clean-logs').onclick = async function () {
            if (!currentWarpTarget) return;

            const maxSize = document.getElementById('warp-log-max-size').value || '0';
            const maxAge = document.getElementById('warp-log-max-age').value || '0';

            if (maxSize === '0' && maxAge === '0') {
                window.showToast('warning', 'Укажите хотя бы один параметр (размер или возраст)');
                return;
            }

            const confirmed = await window.showConfirm({
                title: 'Очистка логов Wireproxy',
                message: `Это удалит старые логи wireproxy.service.\n\nПараметры:\nMax Size: ${maxSize || 'не указан'} MB\nMax Age: ${maxAge || 'не указан'} дней`,
                type: 'warning',
                confirmText: 'Очистить',
                cancelText: 'Отмена'
            });
            if (!confirmed) return;

            const btn = this;
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Очистка...';

            try {
                const formData = new FormData();
                formData.append('max_size', maxSize);
                formData.append('max_age', maxAge);
                formData.append('csrf_token', window.getCsrfToken());

                const resp = await fetch(`/other/servers/warp/logs/clean/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', data.message || 'Логи очищены');
                    if (data.output) {
                        console.log('Clean logs output:', data.output);
                    }
                } else {
                    window.showToast('danger', data.error || 'Ошибка очистки');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка очистки логов');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        };

        document.getElementById('btn-warp-install').onclick = async function () {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Ждите...';

            document.getElementById('warp-logs-container').classList.remove('hidden');
            appendWarpLog('Начало установки... Это может занять несколько минут.');

            try {
                const resp = await fetch(`/other/servers/warp/install/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.getCsrfToken() }
                });
                const data = await resp.json();

                if (data.ok) {
                    appendWarpLog('Успешно: ' + data.message);
                    if (data.output) appendWarpLog(data.output);
                    window.showToast('success', 'WARP установлен');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    appendWarpLog('Ошибка: ' + (data.error || 'Unknown'));
                    if (data.output) appendWarpLog(data.output);
                    window.showToast('danger', 'Ошибка установки');
                }
            } catch (e) {
                appendWarpLog('Fatal error: ' + e.message);
                window.showToast('danger', 'Ошибка запроса');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">download</span> Установить WARP';
            }
        };

        document.getElementById('btn-warp-uninstall').onclick = async function () {
            if (!await window.showConfirm({
                title: 'Удаление WARP',
                message: 'Вы уверены? Будет выполнен скрипт удаления.',
                type: 'danger',
                confirmText: 'Удалить'
            })) return;

            const btn = this;
            btn.disabled = true;
            document.getElementById('warp-logs-container').classList.remove('hidden');
            appendWarpLog('Удаление WARP...');

            try {
                const resp = await fetch(`/other/servers/warp/uninstall/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.getCsrfToken() }
                });
                const data = await resp.json();

                if (data.ok) {
                    appendWarpLog('Успешно удалено');
                    window.showToast('success', 'WARP удален');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    appendWarpLog('Ошибка: ' + (data.error || 'Unknown'));
                    window.showToast('danger', 'Ошибка удаления');
                }
            } catch (e) {
                appendWarpLog('Error: ' + e.message);
            } finally {
                btn.disabled = false;
            }
        };

        const btnToggle = document.getElementById('btn-warp-toggle');
        if (btnToggle) {
            btnToggle.onclick = async function () {
                const btn = this;
                const action = btn.dataset.action;
                const icon = btn.querySelector('.material-symbols-outlined');

                if (!action) return;

                btn.disabled = true;
                if (icon) icon.classList.add('animate-spin');

                try {
                    const resp = await fetch(`/other/servers/warp/${action}/${encodeURIComponent(currentWarpTarget)}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': window.getCsrfToken() }
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        window.showToast('success', action === 'start' ? 'Сервис запущен' : 'Сервис остановлен');
                        checkWarpStatus(currentWarpTarget);
                    } else {
                        window.showToast('danger', data.error || 'Ошибка');
                    }
                } catch (e) {
                    window.showToast('danger', 'Ошибка запроса');
                } finally {
                    btn.disabled = false;
                    if (icon) icon.classList.remove('animate-spin');
                }
            };
        }

        document.getElementById('btn-warp-restart').onclick = async function () {
            const btn = this;
            const icon = btn.querySelector('.material-symbols-outlined');
            btn.disabled = true;
            if (icon) icon.classList.add('animate-spin');

            try {
                const resp = await fetch(`/other/servers/warp/restart/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.getCsrfToken() }
                });

                if (resp.ok) {
                    window.showToast('success', 'Сервис перезапущен');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    window.showToast('danger', 'Ошибка перезапуска');
                }
            } catch (e) {
                window.showToast('danger', 'Ошибка сети');
            } finally {
                btn.disabled = false;
                if (icon) icon.classList.remove('animate-spin');
            }
        };

        document.getElementById('warp-config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-warp-save');
            btn.disabled = true;
            btn.innerHTML = 'Сохранение...';

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const resp = await fetch(`/other/servers/warp/config/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', 'Конфигурация сохранена');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    window.showToast('danger', data.error || 'Ошибка сохранения');
                }
            } catch (e) {
                window.showToast('danger', 'Ошибка сети');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">save</span> Сохранить и перезапустить';
            }
        });

        function appendWarpLog(text) {
            const logs = document.getElementById('warp-logs');
            logs.textContent += `[${new Date().toLocaleTimeString()}] ${text}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        let currentSwapTarget = null;

        window.openSwapModal = function (targetName) {
            currentSwapTarget = targetName;
            document.getElementById('swap-target-name').textContent = targetName;
            openModal('swapModal');
            checkSwapStatus(targetName);
        };

        async function checkSwapStatus(targetName) {
            document.getElementById('swap-loading').classList.remove('hidden');
            document.getElementById('swap-install-state').classList.add('hidden');
            document.getElementById('swap-manage-state').classList.add('hidden');

            try {

                const resp = await fetch(`/other/servers/uptime/ssh/${encodeURIComponent(targetName)}`);
                const data = await resp.json();

                document.getElementById('swap-loading').classList.add('hidden');

                if (data.ok) {
                    if (data.swap_total > 0) {

                        document.getElementById('swap-manage-state').classList.remove('hidden');
                        document.getElementById('swap-display-size').textContent = `${data.swap_total} MB`;
                        document.getElementById('swap-display-swappiness').textContent = data.swappiness;
                        document.getElementById('swap-display-used').textContent = `${data.swap_used} MB (${data.swap_percent}%)`;
                        document.getElementById('swap-display-ram').textContent = `${data.ram_used} MB (${data.ram_percent}%)`;

                        document.getElementById('swap-resize-input').value = data.swap_total;
                        document.getElementById('swap-swappiness-input').value = data.swappiness;
                    } else {

                        document.getElementById('swap-install-state').classList.remove('hidden');
                    }
                } else {
                    window.showToast('danger', data.error || 'Ошибка получения статуса');
                    closeModal('swapModal');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка сети');
                closeModal('swapModal');
            }
        }

        document.getElementById('swap-install-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-swap-install');
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Установка...';

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const resp = await fetch(`/other/servers/swap/install/${encodeURIComponent(currentSwapTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'SWAP успешно установлен');
                    checkSwapStatus(currentSwapTarget);

                    loadServers();
                } else {
                    window.showToast('danger', data.error || 'Ошибка установки');
                }
            } catch (e) {
                window.showToast('danger', 'Ошибка запроса');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">add_circle</span> Установить SWAP';
            }
        });

        document.getElementById('swap-resize-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-swap-resize');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Wait...';

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                if (!await window.showConfirm({ title: 'Изменение размера', message: 'Это действие пересоздаст SWAP файл. Продолжить?', type: 'warning' })) return;

                const resp = await fetch(`/other/servers/swap/resize/${encodeURIComponent(currentSwapTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'Размер SWAP изменен');
                    checkSwapStatus(currentSwapTarget);
                } else {
                    window.showToast('danger', data.error || 'Ошибка');
                }
            } catch (e) {
                window.showToast('danger', 'Ошибка запроса');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        document.getElementById('swap-swappiness-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-swap-swappiness');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '...';

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const resp = await fetch(`/other/servers/swap/swappiness/${encodeURIComponent(currentSwapTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'Swappiness обновлен');
                    checkSwapStatus(currentSwapTarget);
                } else {
                    window.showToast('danger', data.error || 'Ошибка');
                }
            } catch (e) {
                window.showToast('danger', 'Ошибка запроса');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        document.getElementById('btn-swap-delete').onclick = async function () {
            if (!await window.showConfirm({ title: 'Удаление SWAP', message: 'Вы уверены? Это может повлиять на стабильность системы.', type: 'danger', confirmText: 'Удалить' })) return;

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = 'Удаление...';

            try {
                const resp = await fetch(`/other/servers/swap/delete/${encodeURIComponent(currentSwapTarget)}`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': window.getCsrfToken() }
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'SWAP удален');
                    checkSwapStatus(currentSwapTarget);
                    loadServers();
                } else {
                    window.showToast('danger', data.error || 'Ошибка');
                }
            } catch (e) {
                window.showToast('danger', 'Ошибка запроса');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">delete_forever</span> Удалить SWAP';
            }
        };

        let currentExecServer = null;
        let currentExecServerType = null;
        let currentExecEventSource = null;
        let currentExecAbortController = null;
        let currentExecReader = null;

        // --- Terminal Optimization Globals ---
        let terminalBuffer = [];
        let isTerminalFlushing = false;
        const MAX_TERMINAL_LINES = 300;

        function flushTerminalBuffer() {
            if (terminalBuffer.length === 0) {
                isTerminalFlushing = false;
                return;
            }

            const outputEl = document.getElementById('exec-output');
            if (!outputEl) {
                terminalBuffer = [];
                isTerminalFlushing = false;
                return;
            }

            // Create a fragment for batch insertion
            const fragment = document.createDocumentFragment();

            // Process all currently buffered lines
            // We take a snapshot of length to avoid infinite loops if something weird happens,
            // though shift() naturally reduces length.
            const count = terminalBuffer.length;
            for (let i = 0; i < count; i++) {
                const lineHTML = terminalBuffer.shift();
                const div = document.createElement('div');
                div.className = 'term-line';
                div.innerHTML = lineHTML;
                fragment.appendChild(div);
            }

            outputEl.appendChild(fragment);

            // Prune old lines to keep DOM light
            // Using childElementCount is much faster than splitting innerText
            while (outputEl.childElementCount > MAX_TERMINAL_LINES) {
                outputEl.removeChild(outputEl.firstChild);
            }

            outputEl.scrollTop = outputEl.scrollHeight;

            // Continue flushing if more data arrived during execution
            if (terminalBuffer.length > 0) {
                requestAnimationFrame(flushTerminalBuffer);
            } else {
                isTerminalFlushing = false;
            }
        }

        function appendTerminalLine(html) {
            terminalBuffer.push(html);
            if (!isTerminalFlushing) {
                isTerminalFlushing = true;
                requestAnimationFrame(flushTerminalBuffer);
            }
        }

        window.openExecuteCommandModal = function (serverType, serverName) {
            currentExecServer = serverName;
            currentExecServerType = serverType;
            document.getElementById('exec-server-name').textContent = serverName;
            document.getElementById('exec-command-input').value = '';

            const outputEl = document.getElementById('exec-output');
            outputEl.innerHTML = '<div class="term-line"><span class="text-white/30">Ожидание команды...</span></div>';

            document.getElementById('btn-stop-exec-command').classList.add('hidden');

            const modal = document.getElementById('executeCommandModal');
            modal.style.display = 'flex';
            setTimeout(() => document.getElementById('exec-command-input').focus(), 100);
        };

        function closeExecuteCommandModal() {
            const modal = document.getElementById('executeCommandModal');
            modal.style.display = 'none';

            if (currentExecAbortController) {
                currentExecAbortController.abort();
                currentExecAbortController = null;
            }

            if (currentExecReader) {
                try {
                    currentExecReader.cancel();
                } catch (e) { }
                currentExecReader = null;
            }

            if (currentExecEventSource) {
                currentExecEventSource.close();
                currentExecEventSource = null;
            }

            // Clear buffer
            terminalBuffer = [];
            isTerminalFlushing = false;

            // Закрываем SSH сессию на сервере
            if (currentExecServer && currentExecServerType) {
                const formData = new FormData();
                formData.append('csrf_token', window.getCsrfToken());
                fetch(`/other/servers/execute/close/${encodeURIComponent(currentExecServerType)}/${encodeURIComponent(currentExecServer)}`, {
                    method: 'POST',
                    body: formData
                }).catch(() => { });
            }

            currentExecServer = null;
            currentExecServerType = null;
        }

        document.getElementById('btn-close-exec-modal').addEventListener('click', closeExecuteCommandModal);

        // Кнопка остановки команды (Ctrl+C)
        document.getElementById('btn-stop-command').addEventListener('click', async function () {
            if (!currentExecServer || !currentExecServerType) {
                return;
            }

            // const outputEl = document.getElementById('exec-output'); // Not needed for appendTerminalLine
            const formatMsg = (text) => {
                text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                text = text.replace(/(\[INFO\][^\n]*)/g, '<span class="text-blue-400">$1</span>');
                return '<span class="text-white/90">' + text + '</span>';
            };

            try {
                const formData = new FormData();
                formData.append('command', '\x03'); // Ctrl+C
                formData.append('csrf_token', window.getCsrfToken());

                const url = `/other/servers/execute/${encodeURIComponent(currentExecServerType)}/${encodeURIComponent(currentExecServer)}`;

                fetch(url, {
                    method: 'POST',
                    body: formData
                }).catch(() => { }); // Игнорируем ошибки

                appendTerminalLine(formatMsg('\n[INFO] Отправлен сигнал прерывания (Ctrl+C)\n'));
            } catch (e) {
                console.error('Error sending Ctrl+C:', e);
            }
        });

        document.getElementById('btn-stop-exec-command').addEventListener('click', function () {
            if (currentExecAbortController) {
                currentExecAbortController.abort();
                currentExecAbortController = null;
            }

            if (currentExecReader) {
                try {
                    currentExecReader.cancel();
                } catch (e) { }
                currentExecReader = null;
            }

            const formatMsg = (text) => {
                text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                text = text.replace(/(\[INFO\][^\n]*)/g, '<span class="text-blue-400">$1</span>');
                return '<span class="text-white/90">' + text + '</span>';
            };

            appendTerminalLine(formatMsg('\n[INFO] Команда остановлена пользователем\n'));

            this.classList.add('hidden');
        });

        document.getElementById('btn-copy-exec-output').addEventListener('click', async function () {
            const outputEl = document.getElementById('exec-output');
            const text = outputEl.innerText; // innerText handles newlines better than textContent for divs

            try {
                await navigator.clipboard.writeText(text);
                window.showToast('success', 'Логи скопированы в буфер обмена');
            } catch (err) {
                window.showToast('danger', 'Ошибка копирования: ' + err.message);
            }
        });

        document.getElementById('btn-clear-exec-output').addEventListener('click', function () {
            terminalBuffer = []; // Clear pending
            document.getElementById('exec-output').innerHTML = '<div class="term-line"><span class="text-white/30">Ожидание команды...</span></div>';
        });

        document.getElementById('exec-command-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!currentExecServer || !currentExecServerType) {
                window.showToast('danger', 'Ошибка: сервер не выбран');
                return;
            }

            // Получаем команду как есть
            const command = document.getElementById('exec-command-input').value;
            // Omitted check for empty command to allow Enter key

            const outputEl = document.getElementById('exec-output');
            if (outputEl.childElementCount === 1 && outputEl.firstElementChild.textContent.includes('Ожидание команды...')) {
                outputEl.innerHTML = '';
            }

            if (currentExecEventSource) {
                currentExecEventSource.close();
                currentExecEventSource = null;
            }

            // Функция для форматирования вывода с цветами
            function formatTerminalOutput(text) {
                // Заменяем специальные символы HTML
                text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // Подсвечиваем [ERROR] красным
                text = text.replace(/(\[ERROR\][^\n]*)/g, '<span class="text-red-400">$1</span>');

                // Подсвечиваем [WARNING] желтым
                text = text.replace(/(\[WARNING\][^\n]*)/g, '<span class="text-yellow-400">$1</span>');

                // Подсвечиваем [INFO] синим
                text = text.replace(/(\[INFO\][^\n]*)/g, '<span class="text-blue-400">$1</span>');

                // Остальной текст белым
                return '<span class="text-white/90">' + text + '</span>';
            }

            // Показываем отправленную команду
            appendTerminalLine('<span class="text-emerald-400/60">$ </span><span class="text-white">' + command.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>');

            // Очищаем поле ввода для следующей команды
            document.getElementById('exec-command-input').value = '';

            try {
                const formData = new FormData();
                formData.append('command', command);
                formData.append('csrf_token', window.getCsrfToken());

                const url = `/other/servers/execute/${encodeURIComponent(currentExecServerType)}/${encodeURIComponent(currentExecServer)}`;

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value, { stream: true });
                    const lines = text.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') {
                                continue;
                            }

                            // Буферизированный вывод
                            appendTerminalLine(formatTerminalOutput(data));
                        }
                    }
                }

            } catch (error) {
                console.error('Error executing command:', error);
                appendTerminalLine(formatTerminalOutput(`\n[ERROR] ${error.message}\n`));
                window.showToast('danger', 'Ошибка выполнения команды: ' + error.message);
            }
        });

        // Обработчик для показа селектора дней при выборе режима "Срок истекает"
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const expiringDaysSelector = document.getElementById('expiring-days-selector');
                if (this.value === 'expiring_keys') {
                    expiringDaysSelector.classList.remove('hidden');
                } else {
                    expiringDaysSelector.classList.add('hidden');
                }
            });
        });

        // Initialize soft select for discount type
        if (window.initSoftSelect) {
            window.initSoftSelect('discount_type_select', '%');
            window.initSoftSelect('schedulerUnit', 'Часов');
        }



        window.openSchedulerModal = function (targetName) {
            currentSchedulerTarget = targetName;
            document.getElementById('schedulerTargetName').textContent = targetName;

            const target = sshTargetsData.find(t => t.target_name === targetName);
            let config = null;
            if (target && target.time_auto) {
                try {
                    config = JSON.parse(target.time_auto);
                } catch (e) { }
            }

            // Обновляем блок "Текущие настройки"
            const statusBadge = document.getElementById('scheduler-status-badge');
            const currentValue = document.getElementById('scheduler-current-value');

            if (config && config.enabled) {
                statusBadge.textContent = 'Включено';
                statusBadge.className = 'text-[10px] font-medium px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-400';

                const unitNames = {
                    'minutes': 'минут',
                    'hours': 'часов',
                    'days': 'дней'
                };
                const unitName = unitNames[config.unit] || config.unit;
                currentValue.innerHTML = `<span class="text-white">Каждые <span class="text-primary font-bold">${config.value}</span> ${unitName}</span>`;
            } else if (config && !config.enabled) {
                statusBadge.textContent = 'Выключено';
                statusBadge.className = 'text-[10px] font-medium px-2 py-0.5 rounded-full bg-white/5 text-white/50';
                currentValue.innerHTML = '<span class="text-white/50">Планировщик отключен</span>';
            } else {
                statusBadge.textContent = 'Не настроено';
                statusBadge.className = 'text-[10px] font-medium px-2 py-0.5 rounded-full bg-white/5 text-white/40';
                currentValue.innerHTML = '<span class="text-white/40">Планировщик не настроен</span>';
            }

            if (config) {
                document.getElementById('schedulerValue').value = config.value || 1;
                document.getElementById('schedulerUnit').value = config.unit || 'hours';
                document.getElementById('schedulerEnabled').checked = !!config.enabled;
            } else {
                document.getElementById('schedulerValue').value = 1;
                document.getElementById('schedulerUnit').value = 'hours';
                document.getElementById('schedulerEnabled').checked = false;
            }

            openModal('schedulerModal');
        };

        window.saveSchedulerConfig = async function () {
            if (!currentSchedulerTarget) return;

            const value = document.getElementById('schedulerValue').value;
            const unit = document.getElementById('schedulerUnit').value;
            const enabled = document.getElementById('schedulerEnabled').checked;

            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('value', value);
            formData.append('unit', unit);
            formData.append('enabled', enabled);

            try {
                const resp = await fetch(`/other/servers/scheduler/save/${currentSchedulerTarget}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', 'Расписание сохранено');
                    closeModal('schedulerModal');
                    loadServers();
                } else {
                    window.showToast('danger', data.error || 'Ошибка сохранения');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', 'Ошибка сохранения');
            }
        };

        function initSshDragAndDrop() {
            const listEl = document.getElementById('ssh-targets-list');
            const container = listEl.querySelector('.grid');
            if (!container) return;

            let draggedItem = null;

            container.addEventListener('dragstart', (e) => {
                const card = e.target.closest('.ssh-target-card');
                if (!card) return;

                draggedItem = card;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', card.dataset.targetName);

                setTimeout(() => {
                    card.classList.add('opacity-50', 'scale-95');
                }, 0);
            });

            container.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('opacity-50', 'scale-95');
                    draggedItem = null;
                    saveSshSortOrder();
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedItem) return;

                const targetCard = e.target.closest('.ssh-target-card');
                if (targetCard && targetCard !== draggedItem) {
                    const siblings = Array.from(container.children);
                    const draggedIndex = siblings.indexOf(draggedItem);
                    const targetIndex = siblings.indexOf(targetCard);

                    if (draggedIndex < targetIndex) {
                        container.insertBefore(draggedItem, targetCard.nextSibling);
                    } else {
                        container.insertBefore(draggedItem, targetCard);
                    }
                }
            });
        }

        async function saveSshSortOrder() {
            const cards = document.querySelectorAll('.ssh-target-card');
            const order = Array.from(cards).map(card => card.dataset.targetName);

            try {
                await fetch('/other/servers/ssh/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.getCsrfToken()
                    },
                    body: JSON.stringify({ order: order })
                });
            } catch (e) {
                console.error('Failed to save sort order:', e);
                window.showToast('danger', 'Ошибка сохранения порядка');
            }
        }
    });

    // Функция вставки HTML тегов
    window.insertTag = function (tag) {
        const textarea = document.getElementById('broadcast-text');
        if (!textarea) return;

        // Custom modal for links
        if (tag === 'a') {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            window._broadcastSelection = { start, end };

            const linkInput = document.getElementById('link-url-input');
            if (linkInput) {
                linkInput.value = 'https://';
                openModal('linkModal');
                setTimeout(() => linkInput.focus(), 100);
            }
            return;
        }

        let startTag = `<${tag}>`;
        let endTag = `</${tag}>`;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const selected = text.substring(start, end);

        const replacement = startTag + selected + endTag;

        textarea.setRangeText(replacement, start, end, 'select');
        textarea.focus();
    };

    // Handler for the custom link modal
    document.addEventListener('DOMContentLoaded', () => {
        const insertLinkBtn = document.getElementById('btn-insert-link');
        if (insertLinkBtn) {
            insertLinkBtn.addEventListener('click', () => {
                const urlInput = document.getElementById('link-url-input');
                const url = urlInput.value;
                if (url) {
                    const textarea = document.getElementById('broadcast-text');
                    if (textarea && window._broadcastSelection) {
                        const start = window._broadcastSelection.start;
                        const end = window._broadcastSelection.end;
                        const text = textarea.value;
                        const selected = text.substring(start, end);

                        const replacement = `<a href="${url}">` + selected + `</a>`;
                        textarea.setRangeText(replacement, start, end, 'select');
                        textarea.focus();
                    }
                }
                closeModal('linkModal');
            });
        }

        const btnSaveTheme = document.getElementById('btn-save-theme');
        if (btnSaveTheme) {
            btnSaveTheme.onclick = async function () {
                const title = document.getElementById('modal-msg-title').value;
                const content = document.getElementById('modal-msg-content').value;
                if (!title || !content) {
                    window.showToast('warning', 'Заполните все поля');
                    return;
                }

                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                formData.append('csrf_token', window.getCsrfToken());

                try {
                    const resp = await fetch('/other/themes/save', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();
                    if (data.ok) {
                        window.showToast('success', 'Шаблон сохранен');
                        closeModal('newMessageModal');
                        document.getElementById('modal-msg-title').value = '';
                        document.getElementById('modal-msg-content').value = '';
                        loadBroadcastThemes();
                    } else {
                        window.showToast('danger', data.error || 'Ошибка сохранения');
                    }
                } catch (e) {
                    window.showToast('danger', 'Ошибка сети');
                }
            };
        }

        window.loadBroadcastThemes = async function () {
            const container = document.getElementById('broadcast-themes-container');
            if (!container) return;

            try {
                const resp = await fetch('/other/themes/list');
                const data = await resp.json();
                if (data.ok && data.themes) {
                    container.innerHTML = '';
                    Object.entries(data.themes).forEach(([title, content]) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'flex items-center bg-white/5 border border-white/10 rounded-lg overflow-hidden transition-all hover:border-primary/30 group/theme';

                        const mainBtn = document.createElement('button');
                        mainBtn.type = 'button';
                        mainBtn.className = 'text-[9px] text-white/60 hover:text-white px-2.5 py-1.5 font-bold uppercase tracking-widest border-r border-white/5 hover:bg-white/5 transition-all';
                        mainBtn.textContent = title;
                        mainBtn.onclick = () => {
                            const textarea = document.getElementById('broadcast-text');
                            if (textarea) {
                                textarea.value = content;
                                textarea.dispatchEvent(new Event('input'));
                                window.showToast('success', `Шаблон "${title}" применен`);
                            }
                        };

                        const editBtn = document.createElement('button');
                        editBtn.type = 'button';
                        editBtn.className = 'px-1.5 py-1.5 text-white/20 hover:text-primary hover:bg-primary/10 transition-all flex items-center justify-center border-r border-white/5';
                        editBtn.innerHTML = '<span class="material-symbols-outlined text-xs">edit</span>';
                        editBtn.onclick = (e) => {
                            e.stopPropagation();
                            document.getElementById('modal-msg-title').value = title;
                            document.getElementById('modal-msg-content').value = content;
                            openModal('newMessageModal');
                        };

                        const delBtn = document.createElement('button');
                        delBtn.type = 'button';
                        delBtn.className = 'px-1.5 py-1.5 text-white/20 hover:text-red-500 hover:bg-red-500/10 transition-all flex items-center justify-center';
                        delBtn.innerHTML = '<span class="material-symbols-outlined text-xs">delete</span>';
                        delBtn.onclick = async (e) => {
                            e.stopPropagation();
                            const confirmed = await window.showCustomConfirm(`Удалить шаблон "${title}"?`, 'Удаление шаблона');
                            if (!confirmed) return;

                            const formData = new FormData();
                            formData.append('title', title);
                            formData.append('csrf_token', window.getCsrfToken());

                            try {
                                const dResp = await fetch('/other/themes/delete', { method: 'POST', body: formData });
                                const dData = await dResp.json();
                                if (dData.ok) {
                                    window.showToast('success', 'Шаблон удален');
                                    loadBroadcastThemes();
                                }
                            } catch (err) { window.showToast('danger', 'Ошибка удаления'); }
                        };

                        wrapper.appendChild(mainBtn);
                        wrapper.appendChild(editBtn);
                        wrapper.appendChild(delBtn);
                        container.appendChild(wrapper);
                    });
                }
            } catch (e) { console.error('Failed to load themes', e); }
        };

        loadBroadcastThemes();
    });
</script>

<div id="linkModal" class="modal-overlay">
    <div class="modal-content p-6 max-w-lg">
        <h3 class="text-xl font-bold text-white mb-4">Вставить ссылку</h3>
        <div class="mb-6">
            <label class="block text-xs font-bold text-white/50 uppercase tracking-widest mb-2">URL адрес</label>
            <input type="text" id="link-url-input" placeholder="https://example.com"
                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder:text-white/20 focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all outline-none" />
        </div>
        <div class="flex gap-3 justify-end">
            <button type="button" onclick="closeModal('linkModal')"
                class="px-5 py-2.5 rounded-xl text-sm font-bold text-white/60 hover:text-white hover:bg-white/5 transition-all">Отмена</button>
            <button type="button" id="btn-insert-link"
                class="px-5 py-2.5 rounded-xl bg-primary text-background-dark text-sm font-bold hover:bg-primary/90 transition-all">Вставить</button>
        </div>
    </div>
</div>

<div id="newMessageModal" class="modal-overlay">
    <div class="modal-content p-6 max-w-lg">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Новый шаблон</h3>
            <button onclick="closeModal('newMessageModal')" class="text-white/50 hover:text-white transition-all">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-white/50 uppercase tracking-widest mb-2">Название</label>
                <input type="text" id="modal-msg-title" placeholder="Введите название..." maxlength="20"
                    class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder:text-white/20 focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all outline-none" />
            </div>
            <div>
                <label class="block text-xs font-bold text-white/50 uppercase tracking-widest mb-2">Сообщение</label>
                <textarea id="modal-msg-content" rows="4" placeholder="Введите текст сообщения..."
                    class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder:text-white/20 focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all outline-none resize-none"></textarea>
            </div>
        </div>
        <div class="flex gap-3 justify-end mt-6">
            <button type="button" onclick="closeModal('newMessageModal')"
                class="px-5 py-2.5 rounded-xl text-sm font-bold text-white/60 hover:text-white hover:bg-white/5 transition-all">Отмена</button>
            <button type="button" id="btn-save-theme"
                class="px-5 py-2.5 rounded-xl bg-primary text-background-dark text-sm font-bold hover:bg-primary/90 transition-all">Сохранить</button>
        </div>
    </div>
</div>

{% endblock %}