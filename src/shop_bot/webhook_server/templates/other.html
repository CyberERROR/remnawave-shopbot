{% extends "base.html" %}

{% block title %}–ü—Ä–æ—á–µ–µ - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white">–ü—Ä–æ—á–µ–µ</h2>
    <p class="text-white/50 text-sm">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
</div>

<div class="bg-white/5 border border-white/10 rounded-lg p-2 mb-6 overflow-x-auto">
    <nav class="flex gap-1 min-w-max" id="other-nav">
        <button type="button" data-tab="broadcast"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-primary text-background-dark transition-colors">–†–∞—Å—Å—ã–ª–∫–∞</button>
        <button type="button" data-tab="promo"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">–ü—Ä–æ–º–æ
            –∫–æ–¥—ã</button>
        <button type="button" data-tab="servers"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">–°–µ—Ä–≤–µ—Ä–∞</button>
        <button type="button" data-tab="logs"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">–õ–æ–≥–∏
            –ë–æ—Ç–∞</button>
        <button type="button" data-tab="remnawave"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Remnawave</button>
    </nav>
</div>

<section id="tab-broadcast" class="tab-content">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white/5 border border-white/10 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-primary text-2xl">group</span>
                <p class="text-white/50 text-sm">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            </div>
            <p class="text-2xl font-bold text-white" id="stat-total">-</p>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-primary text-2xl">key</span>
                <p class="text-white/50 text-sm">–° –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏</p>
            </div>
            <p class="text-2xl font-bold text-white" id="stat-with-keys">-</p>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-red-400 text-2xl">key_off</span>
                <p class="text-white/50 text-sm">–° –∏—Å—Ç–µ–∫—à–∏–º–∏ –∫–ª—é—á–∞–º–∏</p>
            </div>
            <p class="text-2xl font-bold text-white" id="stat-expired-keys">-</p>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-primary text-2xl">card_giftcard</span>
                <p class="text-white/50 text-sm">–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–±–Ω—ã–π</p>
            </div>
            <p class="text-2xl font-bold text-white" id="stat-no-trial">-</p>
        </div>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-lg p-6 mb-6">
        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined">bar_chart</span>
            –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—Å—ã–ª–∫–∏
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚úÖ</span>
                <div>
                    <p class="text-white/50 text-sm">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
                    <p class="text-lg font-bold text-white" id="result-sent">0</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚ùå</span>
                <div>
                    <p class="text-white/50 text-sm">–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</p>
                    <p class="text-lg font-bold text-white" id="result-failed">0</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚è≠</span>
                <div>
                    <p class="text-white/50 text-sm">–ü—Ä–æ–ø—É—â–µ–Ω–æ (–∑–∞–±–∞–Ω–µ–Ω—ã)</p>
                    <p class="text-lg font-bold text-white" id="result-skipped">0</p>
                </div>
            </div>
        </div>
        <p class="text-white/50 text-xs mt-4" id="result-time">-</p>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h3 class="text-xl font-bold text-white mb-4">–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h3>

        <form id="broadcast-form">
            <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="mb-6">
                <label class="block text-white/70 text-sm font-medium mb-2">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                <textarea id="broadcast-text" rows="6"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                <p class="text-white/50 text-xs mt-1">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è HTML —Ç–µ–≥–∏: &lt;b&gt;, &lt;i&gt;, &lt;u&gt;, &lt;s&gt;, &lt;code&gt;, &lt;pre&gt;,
                    &lt;a href=""&gt;
                </p>
                <button type="button" id="btn-preview"
                    class="mt-2 px-4 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">visibility</span>
                    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </button>
            </div>

            <!-- –ú–µ–¥–∏–∞ –∏ –ö–Ω–æ–ø–∫–∏ –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- –ú–µ–¥–∏–∞ -->
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–ú–µ–¥–∏–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <div class="flex gap-2 items-start">
                        <button type="button" id="btn-upload-media"
                            class="px-4 py-2 rounded-lg bg-primary/20 text-primary hover:bg-primary/30 flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">upload</span>
                            –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/GIF
                        </button>
                        <input type="file" id="media-input" accept="image/*,video/*,.gif" class="hidden" />
                    </div>
                    <div id="media-preview" class="mt-4 hidden">
                        <div class="relative inline-block">
                            <img id="media-preview-img" src=""
                                class="max-w-xs max-h-64 rounded-lg border border-white/10 hidden" />
                            <video id="media-preview-video" controls
                                class="max-w-xs max-h-64 rounded-lg border border-white/10 hidden"></video>
                            <button type="button" id="btn-remove-media"
                                class="absolute top-2 right-2 px-2 py-1 rounded bg-red-500/80 text-white text-sm hover:bg-red-500">
                                <span class="material-symbols-outlined text-base">close</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–ö–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <p class="text-white/50 text-xs mb-2">URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://</p>
                    <div id="buttons-list" class="space-y-2 mb-2"></div>
                    <button type="button" id="btn-add-button"
                        class="px-4 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20 flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">add</span>
                        –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                    </button>
                </div>
            </div>

            <!-- –ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å - 2 –∫–æ–ª–æ–Ω–∫–∏ -->
            <div class="mb-6">
                <label class="block text-white/70 text-sm font-medium mb-3">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º -->
                    <label class="relative block cursor-pointer group">
                        <input type="radio" name="mode" value="test" class="peer sr-only" />
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all duration-200 peer-checked:bg-primary/10 peer-checked:border-primary/50 peer-checked:shadow-[0_0_15px_rgba(var(--primary-rgb),0.1)] peer-checked:[&_.radio-dot]:opacity-100">
                            <span class="text-xl">‚öôÔ∏è</span>
                            <span
                                class="text-white/70 text-sm font-medium group-hover:text-white transition-colors">–¢–µ—Å—Ç–æ–≤—ã–π
                                —Ä–µ–∂–∏–º (–∞–¥–º–∏–Ω)</span>
                            <div
                                class="ml-auto w-4 h-4 rounded-full border border-white/30 peer-checked:border-primary peer-checked:bg-primary flex items-center justify-center transition-colors">
                                <div
                                    class="radio-dot w-1.5 h-1.5 rounded-full bg-background-dark opacity-0 transition-opacity">
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- –° –∞–∫—Ç–∏–≤–Ω—ã–º –∫–ª—é—á–æ–º -->
                    <label class="relative block cursor-pointer group">
                        <input type="radio" name="mode" value="with_keys" class="peer sr-only" />
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all duration-200 peer-checked:bg-primary/10 peer-checked:border-primary/50 peer-checked:shadow-[0_0_15px_rgba(var(--primary-rgb),0.1)] peer-checked:[&_.radio-dot]:opacity-100">
                            <span class="text-xl">üîë</span>
                            <span class="text-white/70 text-sm font-medium group-hover:text-white transition-colors">–°
                                –∞–∫—Ç–∏–≤–Ω—ã–º –∫–ª—é—á–æ–º</span>
                            <div
                                class="ml-auto w-4 h-4 rounded-full border border-white/30 peer-checked:border-primary peer-checked:bg-primary flex items-center justify-center transition-colors">
                                <div
                                    class="radio-dot w-1.5 h-1.5 rounded-full bg-background-dark opacity-0 transition-opacity">
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- –° –∏—Å—Ç—ë–∫—à–∏–º –∫–ª—é—á–æ–º -->
                    <label class="relative block cursor-pointer group">
                        <input type="radio" name="mode" value="expired_keys" class="peer sr-only" />
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all duration-200 peer-checked:bg-primary/10 peer-checked:border-primary/50 peer-checked:shadow-[0_0_15px_rgba(var(--primary-rgb),0.1)] peer-checked:[&_.radio-dot]:opacity-100">
                            <span class="text-xl">‚è∞</span>
                            <span class="text-white/70 text-sm font-medium group-hover:text-white transition-colors">–°
                                –∏—Å—Ç—ë–∫—à–∏–º –∫–ª—é—á–æ–º</span>
                            <div
                                class="ml-auto w-4 h-4 rounded-full border border-white/30 peer-checked:border-primary peer-checked:bg-primary flex items-center justify-center transition-colors">
                                <div
                                    class="radio-dot w-1.5 h-1.5 rounded-full bg-background-dark opacity-0 transition-opacity">
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- –ë–µ–∑ –ø—Ä–æ–±–Ω–æ–≥–æ -->
                    <label class="relative block cursor-pointer group">
                        <input type="radio" name="mode" value="without_trial" class="peer sr-only" />
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all duration-200 peer-checked:bg-primary/10 peer-checked:border-primary/50 peer-checked:shadow-[0_0_15px_rgba(var(--primary-rgb),0.1)] peer-checked:[&_.radio-dot]:opacity-100">
                            <span class="text-xl">üéÅ</span>
                            <span class="text-white/70 text-sm font-medium group-hover:text-white transition-colors">–ë–µ–∑
                                –ø—Ä–æ–±–Ω–æ–≥–æ</span>
                            <div
                                class="ml-auto w-4 h-4 rounded-full border border-white/30 peer-checked:border-primary peer-checked:bg-primary flex items-center justify-center transition-colors">
                                <div
                                    class="radio-dot w-1.5 h-1.5 rounded-full bg-background-dark opacity-0 transition-opacity">
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–±–Ω—ã–π -->
                    <label class="relative block cursor-pointer group">
                        <input type="radio" name="mode" value="not_used_trial" class="peer sr-only" />
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all duration-200 peer-checked:bg-primary/10 peer-checked:border-primary/50 peer-checked:shadow-[0_0_15px_rgba(var(--primary-rgb),0.1)] peer-checked:[&_.radio-dot]:opacity-100">
                            <span class="text-xl">üéÅ</span>
                            <span class="text-white/70 text-sm font-medium group-hover:text-white transition-colors">–ù–µ
                                –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–±–Ω—ã–π</span>
                            <div
                                class="ml-auto w-4 h-4 rounded-full border border-white/30 peer-checked:border-primary peer-checked:bg-primary flex items-center justify-center transition-colors">
                                <div
                                    class="radio-dot w-1.5 h-1.5 rounded-full bg-background-dark opacity-0 transition-opacity">
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º -->
                    <label class="relative block cursor-pointer group">
                        <input type="radio" name="mode" value="all" checked class="peer sr-only" />
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all duration-200 peer-checked:bg-primary/10 peer-checked:border-primary/50 peer-checked:shadow-[0_0_15px_rgba(var(--primary-rgb),0.1)] peer-checked:[&_.radio-dot]:opacity-100">
                            <span class="text-xl">üë•</span>
                            <span
                                class="text-white/70 text-sm font-medium group-hover:text-white transition-colors">–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                –≤—Å–µ–º</span>
                            <div
                                class="ml-auto w-4 h-4 rounded-full border border-white/30 peer-checked:border-primary peer-checked:bg-primary flex items-center justify-center transition-colors">
                                <div
                                    class="radio-dot w-1.5 h-1.5 rounded-full bg-background-dark opacity-0 transition-opacity">
                                </div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <button type="submit" id="btn-send"
                class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-base">send</span>
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
            </button>
        </form>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Ä–∞—Å—Å—ã–ª–∫–∏ -->
        <div id="broadcast-progress-container" class="mt-6 hidden">
            <div class="bg-white/5 border border-white/10 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-white font-medium">–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏...</h4>
                    <span id="broadcast-progress-percent" class="text-primary font-bold">0%</span>
                </div>

                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden mb-3">
                    <div id="broadcast-progress-bar"
                        class="h-full bg-gradient-to-r from-primary to-green-400 rounded-full transition-all duration-300 ease-out"
                        style="width: 0%">
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="grid grid-cols-3 gap-3 text-center text-sm">
                    <div>
                        <p class="text-white/50">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
                        <p class="text-green-400 font-bold" id="broadcast-progress-sent">0</p>
                    </div>
                    <div>
                        <p class="text-white/50">–û—à–∏–±–æ–∫</p>
                        <p class="text-red-400 font-bold" id="broadcast-progress-failed">0</p>
                    </div>
                    <div>
                        <p class="text-white/50">–ü—Ä–æ–ø—É—â–µ–Ω–æ</p>
                        <p class="text-yellow-400 font-bold" id="broadcast-progress-skipped">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="tab-promo" class="tab-content hidden">
    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
    <div class="bg-white/5 border border-white/10 rounded-lg p-6 mb-6">
        <h3 class="text-xl font-bold text-white mb-4">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>

        <form id="promo-create-form">
            <!-- –°–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∫–æ–¥ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–°–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="code_mode" value="auto" checked
                                class="w-4 h-4 text-primary focus:ring-primary/50" />
                            <span class="text-white/70 text-sm">üé≤ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="code_mode" value="manual"
                                class="w-4 h-4 text-primary focus:ring-primary/50" />
                            <span class="text-white/70 text-sm">‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</span>
                        </label>
                    </div>
                </div>

                <div id="manual-code-field" class="hidden">
                    <label class="block text-white/70 text-sm font-medium mb-2">–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞</label>
                    <input type="text" name="code"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50 uppercase"
                        placeholder="PROMO2025" />
                    <p class="text-white/50 text-xs mt-1">–ë—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä</p>
                </div>
            </div>

            <!-- –¢–∏–ø –∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–¢–∏–ø —Å–∫–∏–¥–∫–∏ *</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="discount_type" value="percent" checked
                                class="w-4 h-4 text-primary focus:ring-primary/50" />
                            <span class="text-white/70 text-sm">% –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="discount_type" value="fixed"
                                class="w-4 h-4 text-primary focus:ring-primary/50" />
                            <span class="text-white/70 text-sm">‚ÇΩ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–ó–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ *</label>
                    <input type="number" name="discount_value" step="0.01" min="0" required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        placeholder="10" />
                </div>
            </div>

            <!-- –õ–∏–º–∏—Ç—ã –∏ –¥–∞—Ç—ã - 4 –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–û–±—â–∏–π –ª–∏–º–∏—Ç</label>
                    <input type="number" name="usage_limit_total" min="1"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        placeholder="‚àû" />
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–õ–∏–º–∏—Ç/–ø–æ–ª—å–∑.</label>
                    <input type="number" name="usage_limit_per_user" min="1"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        placeholder="‚àû" />
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–î–µ–π—Å—Ç–≤—É–µ—Ç —Å</label>
                    <input type="datetime-local" name="valid_from"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</label>
                    <input type="datetime-local" name="valid_until"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="mb-4">
                <label class="block text-white/70 text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea name="description" rows="2"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                    placeholder="–ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤..."></textarea>
            </div>

            <button type="submit"
                class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-base">add</span>
                –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
            </button>
        </form>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h3 class="text-xl font-bold text-white mb-4">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã</h3>

        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-white/5">
                    <tr>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ö–æ–¥</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–°–∫–∏–¥–∫–∞</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
                        </th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–õ–∏–º–∏—Ç—ã</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
                        </th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–°—Ç–∞—Ç—É—Å</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70 text-right">
                            –î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="promo-table-body" class="divide-y divide-white/10">
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-white/50">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
<div id="editPromoModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h5>
            <button onclick="closeModal('editPromoModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <form id="promo-edit-form">
                <input type="hidden" id="edit-promo-code" name="code" />

                <div class="mb-4">
                    <label class="block text-white/70 text-sm font-medium mb-2">–ö–æ–¥</label>
                    <input type="text" id="edit-code-display" readonly
                        class="w-full bg-white/10 border border-white/10 rounded-lg px-4 py-2.5 text-white/50 cursor-not-allowed" />
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–¢–∏–ø —Å–∫–∏–¥–∫–∏ *</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="edit_discount_type" value="percent"
                                    class="w-4 h-4 text-primary focus:ring-primary/50" />
                                <span class="text-white/70 text-sm">% –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="edit_discount_type" value="fixed"
                                    class="w-4 h-4 text-primary focus:ring-primary/50" />
                                <span class="text-white/70 text-sm">‚ÇΩ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–ó–Ω–∞—á–µ–Ω–∏–µ *</label>
                        <input type="number" name="edit_discount_value" step="0.01" min="0" required
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–û–±—â–∏–π –ª–∏–º–∏—Ç</label>
                        <input type="number" name="edit_usage_limit_total" min="1"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–õ–∏–º–∏—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="number" name="edit_usage_limit_per_user" min="1"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                        <input type="datetime-local" name="edit_valid_from"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input type="datetime-local" name="edit_valid_until"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-white/70 text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="edit_description" rows="2"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea>
                </div>

                <button type="submit"
                    class="w-full px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–æ–¥—ã Remnawave -->
<div id="deployNodeModal" class="modal-overlay">
    <div class="modal-content max-w-4xl">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">rocket_launch</span>
                –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ù–æ–¥—ã Remnawave - <span id="deploy-target-name"></span>
            </h5>
            <button onclick="closeModal('deployNodeModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6 max-h-[70vh] overflow-y-auto">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å —à–∞–≥–æ–≤ -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white/70 text-sm font-medium">–®–∞–≥ <span id="deploy-current-step">1</span> –∏–∑
                        5</span>
                    <span class="text-primary text-sm font-medium" id="deploy-step-name">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker</span>
                </div>
                <div class="w-full bg-white/10 rounded-full h-2 overflow-hidden">
                    <div id="deploy-progress-bar"
                        class="h-full bg-gradient-to-r from-primary to-green-400 transition-all duration-300"
                        style="width: 20%"></div>
                </div>
            </div>

            <!-- –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker -->
            <div id="deploy-step-1" class="deploy-step">
                <div class="bg-white/5 border border-white/10 rounded-lg p-4 mb-4">
                    <h6 class="text-white font-medium mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-400">package_2</span>
                        –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
                    </h6>
                    <p class="text-white/60 text-sm mb-2">
                        –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: <code
                            class="bg-black/30 px-2 py-1 rounded text-primary">sudo curl -fsSL https://get.docker.com | sh</code>
                    </p>
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 mb-4">
                        <p class="text-yellow-300 text-sm flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">schedule</span>
                            <span>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç <strong>2-5 –º–∏–Ω—É—Ç</strong>. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞,
                                –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</span>
                        </p>
                    </div>
                    <button id="btn-install-docker"
                        class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ -->
            <div id="deploy-step-2" class="deploy-step hidden">
                <div class="bg-white/5 border border-white/10 rounded-lg p-4 mb-4">
                    <h6 class="text-white font-medium mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-purple-400">folder</span>
                        –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
                    </h6>
                    <p class="text-white/60 text-sm mb-4">
                        –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: <code
                            class="bg-black/30 px-2 py-1 rounded text-primary">/opt/remnanode</code>
                    </p>
                    <button id="btn-create-directory"
                        class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">
                        –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ docker-compose.yml -->
            <div id="deploy-step-3" class="deploy-step hidden">
                <div class="bg-white/5 border border-white/10 rounded-lg p-4 mb-4">
                    <h6 class="text-white font-medium mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-yellow-400">edit_document</span>
                        –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ docker-compose.yml
                    </h6>
                    <p class="text-white/60 text-sm mb-4">
                        –í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ docker-compose.yml:
                    </p>
                    <textarea id="docker-compose-content" rows="12"
                        class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white font-mono text-sm placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        placeholder="version: '3.8'&#10;services:&#10;  remnanode:&#10;    image: remnawave/node:latest&#10;    container_name: remnanode&#10;    restart: always&#10;    network_mode: host&#10;    environment:&#10;      - PANEL_URL=https://your-panel.com&#10;      - PANEL_KEY=your-key"></textarea>
                    <div class="flex gap-3 mt-4">
                        <button id="btn-cancel-compose"
                            class="flex-1 px-6 py-3 rounded-lg bg-white/10 text-white hover:bg-white/20 font-medium transition-colors">
                            –ù–∞–∑–∞–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é
                        </button>
                        <button id="btn-save-compose"
                            class="flex-1 px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª
                        </button>
                    </div>
                </div>
            </div>

            <!-- –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ -->
            <div id="deploy-step-4" class="deploy-step hidden">
                <div class="bg-white/5 border border-white/10 rounded-lg p-4 mb-4">
                    <h6 class="text-white font-medium mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-400">play_circle</span>
                        –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
                    </h6>
                    <p class="text-white/60 text-sm mb-4">
                        –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: <code
                            class="bg-black/30 px-2 py-1 rounded text-primary">docker compose up -d</code>
                    </p>
                    <button id="btn-start-containers"
                        class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 5: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div id="deploy-step-5" class="deploy-step hidden">
                <div class="bg-white/5 border border-white/10 rounded-lg p-4 mb-4">
                    <h6 class="text-white font-medium mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-orange-400">settings</span>
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–æ–π
                    </h6>
                    <p class="text-white/60 text-sm mb-4">
                        –ù–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –µ—é:
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <button id="btn-view-compose"
                            class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 flex items-center gap-2 justify-center">
                            <span class="material-symbols-outlined text-sm">visibility</span>
                            –ü—Ä–æ—Å–º–æ—Ç—Ä compose
                        </button>
                        <button id="btn-restart-node"
                            class="px-4 py-2 rounded-lg bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 flex items-center gap-2 justify-center">
                            <span class="material-symbols-outlined text-sm">restart_alt</span>
                            –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
                        </button>
                        <button id="btn-view-logs"
                            class="px-4 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 flex items-center gap-2 justify-center">
                            <span class="material-symbols-outlined text-sm">description</span>
                            –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
                        </button>
                    </div>
                    <div class="mb-4">
                        <button id="btn-remove-all"
                            class="w-full px-4 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30 flex items-center gap-2 justify-center">
                            <span class="material-symbols-outlined text-sm">delete_forever</span>
                            –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–¥—ã –∏ Docker
                        </button>
                        <p class="text-red-400/70 text-xs mt-2 text-center">‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ! –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã
                            –≤—Å–µ –¥–∞–Ω–Ω—ã–µ Docker –∏ –Ω–æ–¥–∞.</p>
                    </div>
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                        <p class="text-green-400 font-medium flex items-center gap-2">
                            <span class="material-symbols-outlined">check_circle</span>
                            –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!
                        </p>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–Ω—Å–æ–ª—å –≤—ã–≤–æ–¥–∞ -->
            <div class="bg-black/80 border border-white/10 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white/70 text-sm font-medium">–í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥</span>
                    <button id="btn-clear-deploy-logs" class="text-white/50 hover:text-white text-sm">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                </div>
                <div id="deploy-output"
                    class="font-mono text-xs text-green-400 max-h-60 overflow-y-auto whitespace-pre-wrap">
                    –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è SWAP -->
<div id="swapModal" class="modal-overlay">
    <div class="modal-content max-w-md">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-purple-400">memory</span>
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SWAP - <span id="swap-target-name"></span>
            </h5>
            <button onclick="closeModal('swapModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div id="swap-loading" class="text-center py-8">
                <span
                    class="material-symbols-outlined animate-spin text-4xl text-purple-400 mb-2">progress_activity</span>
                <p class="text-white/50 text-sm">–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ SWAP...</p>
            </div>

            <!-- State: Not Installed -->
            <div id="swap-install-state" class="hidden">
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
                    <p class="text-yellow-300 text-sm flex items-center gap-2">
                        <span class="material-symbols-outlined">warning</span>
                        SWAP —Ñ–∞–π–ª –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω.
                    </p>
                </div>
                <form id="swap-install-form">
                    <label class="block text-white/70 text-sm font-medium mb-2">–†–∞–∑–º–µ—Ä SWAP (MB)</label>
                    <input type="number" name="size_mb" value="2048" min="512" step="512"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500/50 mb-4" />
                    <button type="submit" id="btn-swap-install"
                        class="w-full px-4 py-2 rounded-lg bg-purple-500 text-white font-bold hover:bg-purple-600 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">add_circle</span>
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SWAP
                    </button>
                </form>
            </div>

            <!-- State: Installed (Manage) -->
            <div id="swap-manage-state" class="hidden">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Size -->
                    <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                        <p class="text-white/50 text-xs mb-1">–†–∞–∑–º–µ—Ä</p>
                        <p class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-purple-400">storage</span>
                            <span id="swap-display-size">-</span>
                        </p>
                    </div>
                    <!-- Swappiness -->
                    <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                        <p class="text-white/50 text-xs mb-1">Swappiness</p>
                        <p class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-purple-400">tune</span>
                            <span id="swap-display-swappiness">-</span> %
                        </p>
                    </div>
                    <!-- SWAP Used -->
                    <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                        <p class="text-white/50 text-xs mb-1">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ (SWAP)</p>
                        <p class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-yellow-400">data_usage</span>
                            <span id="swap-display-used">-</span>
                        </p>
                    </div>
                    <!-- RAM Used -->
                    <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                        <p class="text-white/50 text-xs mb-1">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ (RAM)</p>
                        <p class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-blue-400">memory</span>
                            <span id="swap-display-ram">-</span>
                        </p>
                    </div>
                </div>

                <div class="space-y-4">
                    <!-- Resize -->
                    <form id="swap-resize-form" class="bg-white/5 rounded-lg p-3 border border-white/10">
                        <div class="flex items-center gap-2 mb-2">
                            <label class="text-white/70 text-xs font-medium">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä (MB)</label>
                            <div class="group relative flex items-center">
                                <span
                                    class="material-symbols-outlined text-white/30 text-[16px] cursor-help hover:text-white/70 transition-colors">info</span>
                                <div
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 border border-white/10 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 text-xs text-white/80 leading-relaxed">
                                    –£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–æ–¥–∫–∞—á–∫–∏ –≤ –º–µ–≥–∞–±–∞–π—Ç–∞—Ö (MB).
                                    <br><br>
                                    –°–∏—Å—Ç–µ–º–∞ —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
                                    <div
                                        class="absolute bottom-[-6px] left-1/2 -translate-x-1/2 w-3 h-3 bg-gray-900 border-r border-b border-white/10 rotate-45">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" name="size_mb" id="swap-resize-input" min="512" step="512"
                                class="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-1.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50" />
                            <button type="submit" id="btn-swap-resize"
                                class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-white text-xs font-medium transition-colors">
                                –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </form>

                    <!-- Swappiness -->
                    <form id="swap-swappiness-form" class="bg-white/5 rounded-lg p-3 border border-white/10">
                        <div class="flex items-center gap-2 mb-2">
                            <label class="text-white/70 text-xs font-medium">Swappiness (0-100%)</label>
                            <div class="group relative flex items-center">
                                <span
                                    class="material-symbols-outlined text-white/30 text-[16px] cursor-help hover:text-white/70 transition-colors">info</span>
                                <div
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-72 p-3 bg-gray-900 border border-white/10 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 text-xs text-white/80 leading-relaxed">
                                    –ü–∞—Ä–∞–º–µ—Ç—Ä –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ —á–∞—Å—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SWAP.
                                    <br><br>
                                    <span class="text-green-400 font-bold">–ù–∏–∑–∫–∏–π % (0-10):</span><br>
                                    –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–¥–∫–∞—á–∫—É, –ø–æ–∫–∞ RAM –Ω–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é.
                                    –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (MySQL, Postgres) –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
                                    <br><br>
                                    <span class="text-purple-400 font-bold">–í—ã—Å–æ–∫–∏–π % (60-100):</span><br>
                                    –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ SWAP, –æ—Å–≤–æ–±–æ–∂–¥–∞—è RAM –¥–ª—è —Ñ–∞–π–ª–æ–≤–æ–≥–æ
                                    –∫—ç—à–∞. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 60.
                                    <div
                                        class="absolute bottom-[-6px] left-1/2 -translate-x-1/2 w-3 h-3 bg-gray-900 border-r border-b border-white/10 rotate-45">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" name="swappiness" id="swap-swappiness-input" min="0" max="100"
                                class="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-1.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50" />
                            <button type="submit" id="btn-swap-swappiness"
                                class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-white text-xs font-medium transition-colors">
                                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </form>

                    <!-- Delete -->
                    <button type="button" id="btn-swap-delete"
                        class="w-full px-4 py-2 rounded-lg bg-red-500/20 text-red-400 font-medium hover:bg-red-500/30 border border-red-500/30 transition-colors flex items-center justify-center gap-2 mt-4">
                        <span class="material-symbols-outlined">delete_forever</span>
                        –£–¥–∞–ª–∏—Ç—å SWAP
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="confirmDeleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content max-w-lg">
        <div class="p-6">
            <div class="flex items-center justify-center mb-4">
                <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-4xl text-red-400">warning</span>
                </div>
            </div>

            <h3 class="text-2xl font-bold text-white text-center mb-2">‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!</h3>
            <p class="text-white/70 text-center mb-6">–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–æ–±—Ä–∞—Ç–∏–º—É—é –æ–ø–µ—Ä–∞—Ü–∏—é</p>

            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
                <p class="text-red-300 font-medium mb-3">–ë—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–æ:</p>
                <ul class="space-y-2 text-red-200 text-sm">
                    <li class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">close</span>
                        –ù–æ–¥–∞ Remnawave –∏ –≤—Å–µ –µ—ë –¥–∞–Ω–Ω—ã–µ
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">close</span>
                        Docker –ø–æ–ª–Ω–æ—Å—Ç—å—é (–≤—Å–µ –ø–∞–∫–µ—Ç—ã)
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">close</span>
                        –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –æ–±—Ä–∞–∑—ã –∏ —Ç–æ–º–∞
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">close</span>
                        –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã Docker
                    </li>
                </ul>
            </div>

            <div class="mb-6">
                <label class="text-white text-sm font-medium mb-2 block">
                    –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞: <span class="text-primary font-bold"
                        id="confirm-server-name"></span>
                </label>
                <input type="text" id="confirm-delete-input"
                    class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-red-500/50"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞">
                <p class="text-white/50 text-xs mt-2">–†–µ–≥–∏—Å—Ç—Ä –≤–∞–∂–µ–Ω. –í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫.</p>
            </div>

            <div class="flex gap-3">
                <button id="btn-cancel-delete"
                    class="flex-1 px-6 py-3 rounded-lg bg-white/10 text-white hover:bg-white/20 font-medium transition-colors">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="btn-confirm-delete"
                    class="flex-1 px-6 py-3 rounded-lg bg-red-500 text-white hover:bg-red-600 font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    –£–¥–∞–ª–∏—Ç—å –≤—Å—ë
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div id="confirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content max-w-md">
        <div class="p-6">
            <div class="flex items-center justify-center mb-4">
                <div id="confirm-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center">
                    <span id="confirm-icon" class="material-symbols-outlined text-4xl"></span>
                </div>
            </div>

            <h3 id="confirm-title" class="text-xl font-bold text-white text-center mb-2"></h3>
            <p id="confirm-message" class="text-white/70 text-center mb-6 whitespace-pre-line"></p>

            <div class="flex gap-3">
                <button id="btn-confirm-cancel"
                    class="flex-1 px-6 py-3 rounded-lg bg-white/10 text-white hover:bg-white/20 font-medium transition-colors">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="btn-confirm-ok" class="flex-1 px-6 py-3 rounded-lg font-bold transition-colors">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<section id="tab-remnawave" class="tab-content hidden">
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h3 class="text-xl font-bold text-white mb-4">Remnawave</h3>
        <p class="text-white/70 text-sm mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏ Remnawave</p>
        <div class="bg-white/[0.02] border border-white/10 rounded-lg p-8 text-center">
            <span class="material-symbols-outlined text-4xl text-white/30 mb-2">settings_applications</span>
            <p class="text-white/50">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Remnawave –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ</p>
        </div>
    </div>
</section>

<section id="tab-servers" class="tab-content hidden">
    <!-- –°–µ—Ä–≤–µ—Ä—ã Remnawave - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–ª–æ–∫ —Å–≤–µ—Ä—Ö—É -->
    <div class="mb-6">
        <div class="bg-white/5 border border-white/10 rounded-xl p-5">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-blue-400 text-xl">dns</span>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-lg">–°–µ—Ä–≤–µ—Ä—ã Remnawave</h3>
                        <p class="text-white/50 text-xs">–ü–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–æ–¥–∞–º–∏</p>
                    </div>
                </div>
                <span class="px-3 py-1.5 rounded-full bg-blue-500/20 text-blue-300 text-sm font-bold"
                    id="remna-hosts-count">0</span>
            </div>
            <div id="remna-hosts-list">
                <div class="text-center py-6 text-white/40">
                    <span class="material-symbols-outlined text-3xl mb-2">dns</span>
                    <p class="text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SSH-—Ü–µ–ª–∏ - —Å–µ—Ç–∫–∞ —Å–Ω–∏–∑—É -->
    <div class="bg-white/5 border border-white/10 rounded-xl p-5">
        <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-yellow-400 text-xl">terminal</span>
                </div>
                <div>
                    <h3 class="text-white font-bold text-lg">SSH-—Ü–µ–ª–∏</h3>
                    <p class="text-white/50 text-xs">–°–µ—Ä–≤–µ—Ä—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–æ–¥</p>
                </div>
            </div>
            <span class="px-3 py-1.5 rounded-full bg-yellow-500/20 text-yellow-300 text-sm font-bold"
                id="ssh-targets-count">0</span>
        </div>
        <div id="ssh-targets-list">
            <div class="text-center py-8 text-white/40">
                <span class="material-symbols-outlined text-4xl mb-2">terminal</span>
                <p class="text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>
</section>

<section id="tab-logs" class="tab-content hidden">
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-green-400">terminal</span>
                –õ–æ–≥–∏ –ë–æ—Ç–∞
            </h3>
            <div class="flex gap-2">
                <span class="flex items-center gap-2 text-white/50 text-xs px-2" id="logs-status">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span> Disconnected
                </span>
                <button type="button" id="btn-clear-logs"
                    class="px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 text-sm font-medium flex items-center gap-1">
                    <span class="material-symbols-outlined text-base">delete</span>
                    –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
                </button>
            </div>
        </div>

        <div class="bg-black/80 rounded-lg p-4 font-mono text-sm text-white/80 h-[500px] overflow-y-auto"
            id="logs-container">
            <div class="text-white/30 text-center mt-20">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–æ—Ç–æ–∫—É –ª–æ–≥–æ–≤...</div>
        </div>
        <p class="text-white/30 text-xs mt-2">–õ–æ–≥–∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (tail -f). –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ
            –∑–∞–ø–∏—Å–∏.</p>
    </div>
</section>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è WARP -->
<div id="warpModal" class="modal-overlay" style="z-index: 50;">
    <div class="modal-content max-w-2xl">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-400">vpn_lock</span>
                WARP (wireproxy) - <span id="warp-target-name"></span>
            </h5>
            <button onclick="closeModal('warpModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <!-- Loading State -->
            <div id="warp-loading" class="text-center py-8">
                <span class="material-symbols-outlined animate-spin text-4xl text-primary mb-2">progress_activity</span>
                <p class="text-white/50">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</p>
            </div>

            <!-- Install State -->
            <div id="warp-install-state" class="hidden">
                <div class="bg-white/5 border border-white/10 rounded-lg p-6 text-center mb-4">
                    <span class="material-symbols-outlined text-6xl text-white/20 mb-4">download</span>
                    <h3 class="text-xl font-bold text-white mb-2">WARP –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</h3>
                    <p class="text-white/50 text-sm mb-6">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ WARP –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SOCKS5 –ø—Ä–æ–∫—Å–∏ –Ω–∞ —ç—Ç–æ–º
                        —Å–µ—Ä–≤–µ—Ä–µ (–ø–æ—Ä—Ç 40000).</p>
                    <button id="btn-warp-install"
                        class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors flex items-center gap-2 mx-auto">
                        <span class="material-symbols-outlined">download</span>
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WARP
                    </button>
                    <p class="text-white/30 text-xs mt-4">–ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —Å–∫—Ä–∏–ø—Ç fscarmen/warp (auto-setup: 1, 1, 40000)
                    </p>
                </div>
            </div>

            <!-- Manage State -->
            <div id="warp-manage-state" class="hidden">
                <!-- Status & Actions -->
                <div class="flex items-center justify-between bg-white/5 border border-white/10 rounded-lg p-4 mb-6">
                    <div class="flex items-center gap-4">
                        <div id="warp-status-indicator" class="w-4 h-4 rounded-full bg-gray-500"></div>
                        <div>
                            <p class="text-white font-bold" id="warp-status-text">–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</p>
                            <p class="text-white/50 text-xs">Service: wireproxy</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-warp-toggle" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white"
                            title="–ó–∞–≥—Ä—É–∑–∫–∞...">
                            <span class="material-symbols-outlined">pending</span>
                        </button>
                        <button id="btn-warp-restart" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white"
                            title="–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞">
                            <span class="material-symbols-outlined">restart_alt</span>
                        </button>
                        <button id="btn-warp-uninstall"
                            class="p-2 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-400" title="–£–¥–∞–ª–∏—Ç—å WARP">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex gap-1 mb-4 border-b border-white/10">
                    <button
                        class="px-4 py-2 text-primary border-b-2 border-primary font-medium text-sm transition-colors"
                        id="btn-tab-warp-config" onclick="switchWarpTab('config')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button class="px-4 py-2 text-white/50 hover:text-white font-medium text-sm transition-colors"
                        id="btn-tab-warp-json" onclick="switchWarpTab('json')">Remnawave Config</button>
                    <button class="px-4 py-2 text-white/50 hover:text-white font-medium text-sm transition-colors"
                        id="btn-tab-warp-systemd" onclick="switchWarpTab('systemd')">Systemd Config</button>
                </div>

                <!-- Config Tab -->
                <div id="warp-content-config">
                    <form id="warp-config-form">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-white/70 text-sm font-medium mb-2">MemoryMax</label>
                                <div class="relative">
                                    <input type="text" name="memory_max" id="warp-memory-max"
                                        class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-1 focus:ring-primary"
                                        placeholder="800M">
                                </div>
                            </div>
                            <div>
                                <label class="block text-white/70 text-sm font-medium mb-2">MemoryHigh</label>
                                <div class="relative">
                                    <input type="text" name="memory_high" id="warp-memory-high"
                                        class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-1 focus:ring-primary"
                                        placeholder="1G">
                                </div>
                            </div>
                        </div>

                        <!-- Info Table -->
                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 mb-4">
                            <h6 class="text-blue-300 text-xs font-bold mb-2 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">info</span> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –û–ó–£
                            </h6>
                            <p class="text-xs text-blue-200/70 mb-3">
                                –î–ª—è 1GB RAM —Å–µ—Ä–≤–µ—Ä–æ–≤: <span class="text-blue-100">512M / 400M</span>.<br>
                                –î–ª—è 2+GB RAM —Å–µ—Ä–≤–µ—Ä–æ–≤: <span class="text-blue-100">800M / 1G</span> (50-150 –∫–ª–∏–µ–Ω—Ç–æ–≤).
                            </p>

                            <div class="overflow-x-auto">
                                <table class="w-full text-xs text-left text-blue-200/70">
                                    <thead class="text-blue-300 font-bold border-b border-blue-500/20">
                                        <tr>
                                            <th class="py-1 pr-2">–ö–ª–∏–µ–Ω—Ç–æ–≤</th>
                                            <th class="py-1 px-2">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</th>
                                            <th class="py-1 px-2 whitespace-nowrap">MemoryHigh</th>
                                            <th class="py-1 pl-2 whitespace-nowrap">MemoryMax</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-blue-500/10">
                                        <tr>
                                            <td class="py-1 pr-2">–î–æ 20</td>
                                            <td class="py-1 px-2">~13 MB</td>
                                            <td class="py-1 px-2 text-blue-100">300M</td>
                                            <td class="py-1 pl-2 text-blue-100">380M</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">20-50</td>
                                            <td class="py-1 px-2">~18 MB</td>
                                            <td class="py-1 px-2 text-blue-100">450M</td>
                                            <td class="py-1 pl-2 text-blue-100">560M</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">50-150</td>
                                            <td class="py-1 px-2">~33 MB</td>
                                            <td class="py-1 px-2 text-blue-100">800M</td>
                                            <td class="py-1 pl-2 text-blue-100">1G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">150-350</td>
                                            <td class="py-1 px-2">~65 MB</td>
                                            <td class="py-1 px-2 text-blue-100">1.2G</td>
                                            <td class="py-1 pl-2 text-blue-100">1.5G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">350-850</td>
                                            <td class="py-1 px-2">~138 MB</td>
                                            <td class="py-1 px-2 text-blue-100">2G</td>
                                            <td class="py-1 pl-2 text-blue-100">2.5G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">850-3k</td>
                                            <td class="py-1 px-2">~460 MB</td>
                                            <td class="py-1 px-2 text-blue-100">3.5G</td>
                                            <td class="py-1 pl-2 text-blue-100">4.3G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">3k-10k</td>
                                            <td class="py-1 px-2">~1.5 GB</td>
                                            <td class="py-1 px-2 text-blue-100">5.5G</td>
                                            <td class="py-1 pl-2 text-blue-100">6.9G</td>
                                        </tr>
                                        <tr>
                                            <td class="py-1 pr-2">10k-50k</td>
                                            <td class="py-1 px-2">~7.5 GB</td>
                                            <td class="py-1 px-2 text-blue-100">10G</td>
                                            <td class="py-1 pl-2 text-blue-100">12.5G</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <button type="submit" id="btn-warp-save"
                            class="w-full px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white font-medium transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">save</span>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
                        </button>
                    </form>
                </div>

                <!-- JSON Tab -->
                <div id="warp-content-json" class="hidden">
                    <p class="text-white/50 text-sm mb-2">–î–ª—è Remnawave –ü—Ä–æ—Ñ–∏–ª–µ–π (Outbound):</p>
                    <textarea readonly
                        class="w-full h-40 bg-black/30 border border-white/10 rounded-lg p-3 text-xs font-mono text-green-400 focus:outline-none selection:bg-green-500/30"
                        id="warp-json-output">
{
  "tag": "warp",
  "protocol": "socks",
  "settings": {
    "servers": [
      {
        "address": "127.0.0.1",
        "port": 40000
      }
    ]
  }
}
                    </textarea>
                    <button type="button"
                        onclick="navigator.clipboard.writeText(document.getElementById('warp-json-output').value); window.showToast('success', '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')"
                        class="mt-2 w-full px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">content_copy</span>
                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä
                    </button>
                </div>

                <div id="warp-content-systemd" class="hidden">
                    <p class="text-white/50 text-sm mb-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ systemd override –∫–æ–Ω—Ñ–∏–≥–∞ wireproxy:</p>
                    <textarea
                        class="w-full h-64 bg-black/30 border border-white/10 rounded-lg p-3 text-xs font-mono text-white focus:outline-none focus:ring-2 focus:ring-primary/50"
                        id="warp-systemd-textarea"
                        placeholder="[Service]&#10;Environment=&quot;WG_LOG_LEVEL=error&quot;&#10;StandardOutput=null&#10;StandardError=journal&#10;MemoryMax=800M&#10;MemoryHigh=1G"></textarea>
                    <button type="button" id="btn-warp-systemd-save"
                        class="mt-2 w-full px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">save</span>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>

                    <div class="mt-6 border-t border-white/10 pt-4">
                        <h6 class="text-white font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-yellow-400">description</span>
                            –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–æ–≤ Wireproxy
                        </h6>
                        <p class="text-white/50 text-xs mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ journalctl –ª–æ–≥–∞–º–∏ –¥–ª—è wireproxy.service</p>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-white/70 text-xs font-medium mb-1 flex items-center gap-1">
                                    Max Size (MB)
                                    <span class="group relative inline-block">
                                        <span
                                            class="material-symbols-outlined text-xs text-white/40 hover:text-white/70 cursor-help">info</span>
                                        <span
                                            class="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-black/90 text-white text-xs rounded-lg whitespace-nowrap z-50 border border-white/10">
                                            –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∂—É—Ä–Ω–∞–ª–∞
                                        </span>
                                    </span>
                                </label>
                                <input type="number" id="warp-log-max-size" min="0" placeholder="0"
                                    class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500/50">
                            </div>
                            <div>
                                <label class="block text-white/70 text-xs font-medium mb-1 flex items-center gap-1">
                                    Max Age (Days)
                                    <span class="group relative inline-block">
                                        <span
                                            class="material-symbols-outlined text-xs text-white/40 hover:text-white/70 cursor-help">info</span>
                                        <span
                                            class="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-black/90 text-white text-xs rounded-lg whitespace-nowrap z-50 border border-white/10">
                                            –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π
                                        </span>
                                    </span>
                                </label>
                                <input type="number" id="warp-log-max-age" min="0" placeholder="0"
                                    class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500/50">
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button type="button" id="btn-warp-check-log-usage"
                                class="flex-1 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">hard_drive</span>
                                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤
                            </button>
                            <button type="button" id="btn-warp-clean-logs"
                                class="flex-1 px-4 py-2 rounded-lg bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 text-sm font-bold transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">delete_sweep</span>
                                –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ Wireproxy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Console Output -->
            <div id="warp-logs-container"
                class="mt-4 hidden bg-black/80 border border-white/10 rounded-lg overflow-hidden">
                <div class="px-3 py-1 bg-white/5 text-xs text-white/50 border-b border-white/5">–õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                <div class="p-3 font-mono text-xs text-green-400 max-h-48 overflow-y-auto whitespace-pre-wrap"
                    id="warp-logs"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ================= GLOBALS & ELEMENTS =================
        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');
        const logsContainer = document.getElementById('logs-container');
        const logsStatus = document.getElementById('logs-status');
        const btnClearLogs = document.getElementById('btn-clear-logs');

        let logEventSource = null;

        // ================= UNIVERSAL CONFIRM DIALOG =================
        window.showConfirm = function ({
            title = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ',
            message = '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
            type = 'warning', // 'info', 'warning', 'danger'
            confirmText = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
            cancelText = '–û—Ç–º–µ–Ω–∞',
            onConfirm = null
        }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const iconContainer = document.getElementById('confirm-icon-container');
                const icon = document.getElementById('confirm-icon');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('btn-confirm-ok');
                const cancelBtn = document.getElementById('btn-confirm-cancel');

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                const styles = {
                    info: {
                        iconBg: 'bg-blue-500/20',
                        iconColor: 'text-blue-400',
                        iconName: 'info',
                        btnBg: 'bg-blue-500 hover:bg-blue-600 text-white'
                    },
                    warning: {
                        iconBg: 'bg-yellow-500/20',
                        iconColor: 'text-yellow-400',
                        iconName: 'warning',
                        btnBg: 'bg-yellow-500 hover:bg-yellow-600 text-white'
                    },
                    danger: {
                        iconBg: 'bg-red-500/20',
                        iconColor: 'text-red-400',
                        iconName: 'dangerous',
                        btnBg: 'bg-red-500 hover:bg-red-600 text-white'
                    }
                };

                const style = styles[type] || styles.warning;

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏
                iconContainer.className = `w-16 h-16 rounded-full flex items-center justify-center ${style.iconBg}`;
                icon.className = `material-symbols-outlined text-4xl ${style.iconColor}`;
                icon.textContent = style.iconName;
                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;

                if (!cancelText) {
                    cancelBtn.style.display = 'none';
                } else {
                    cancelBtn.style.display = '';
                }

                confirmBtn.className = `flex-1 px-6 py-3 rounded-lg font-bold transition-colors ${style.btnBg}`;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.style.display = 'flex';
                setTimeout(() => confirmBtn.focus(), 100);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                const handleConfirm = async () => {
                    modal.style.display = 'none';
                    cleanup();
                    if (onConfirm) await onConfirm();
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(false);
                };

                const handleKeyPress = (e) => {
                    if (e.key === 'Escape') handleCancel();
                    if (e.key === 'Enter') handleConfirm();
                };

                const cleanup = () => {
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    document.removeEventListener('keydown', handleKeyPress);
                };

                confirmBtn.onclick = handleConfirm;
                cancelBtn.onclick = handleCancel;
                document.addEventListener('keydown', handleKeyPress);
            });
        };

        // ================= LOGGING FUNCTIONS =================
        function updateLogStatus(connected) {
            if (!logsStatus) return;
            if (connected) {
                logsStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Live';
            } else {
                logsStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Disconnected';
            }
        }

        function appendLog(text) {
            if (!logsContainer) return;
            const line = document.createElement('div');
            line.className = 'whitespace-pre-wrap border-b border-white/5 pb-1 mb-1 hover:bg-white/5 transition-colors px-1';
            line.textContent = text;
            logsContainer.appendChild(line);

            // Auto scroll to bottom
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // Limit lines to prevent memory issues (keep last 1000)
            if (logsContainer.children.length > 1000) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        function startLogStream() {
            if (logEventSource) logEventSource.close();

            if (logsContainer) logsContainer.innerHTML = '';
            updateLogStatus(true);

            logEventSource = new EventSource('/other/logs/stream');

            logEventSource.onmessage = function (event) {
                appendLog(event.data);
            };

            logEventSource.onerror = function (err) {
                console.error("EventSource failed:", err);
                logEventSource.close();
                logEventSource = null;
                updateLogStatus(false);
                appendLog("[System] Connection lost. Reconnecting in 5s...");
                setTimeout(() => {
                    if (location.hash === '#logs') startLogStream();
                }, 5000);
            };
        }

        // ================= TAB FUNCTIONS =================
        function handleTabSwitch(tabId) {
            // Logs Logic
            if (tabId !== 'logs' && logEventSource) {
                logEventSource.close();
                logEventSource = null;
                updateLogStatus(false);
            } else if (tabId === 'logs' && !logEventSource) {
                startLogStream();
            }
        }

        function switchTab(tabId) {
            tabs.forEach(btn => {
                const isActive = btn.getAttribute('data-tab') === tabId;
                btn.classList.toggle('bg-primary', isActive);
                btn.classList.toggle('text-background-dark', isActive);
                btn.classList.toggle('text-white/70', !isActive);
                btn.classList.toggle('hover:bg-white/5', !isActive);
            });
            contents.forEach(content => {
                const isActive = content.id === 'tab-' + tabId;
                content.classList.toggle('hidden', !isActive);
            });

            history.replaceState(null, '', '#' + tabId);
            localStorage.setItem('remnawave_other_active_tab', tabId);

            handleTabSwitch(tabId);
        }

        // ================= EVENT LISTENERS =================
        tabs.forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
        });

        if (btnClearLogs) {
            btnClearLogs.addEventListener('click', async () => {
                const confirmed = await window.showConfirm({
                    title: '–û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ Docker',
                    message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏ Docker?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.',
                    type: 'danger',
                    confirmText: '–û—á–∏—Å—Ç–∏—Ç—å',
                    cancelText: '–û—Ç–º–µ–Ω–∞'
                });
                if (!confirmed) return;

                try {
                    const resp = await fetch('/other/logs/clear', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': window.getCsrfToken()
                        }
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        window.showToast('success', '–õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã');
                        if (logsContainer) logsContainer.innerHTML = '<div class="text-green-400 text-center my-4">--- –õ–æ–≥–∏ –±—ã–ª–∏ –æ—á–∏—â–µ–Ω—ã ---</div>';
                    } else {
                        window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                }
            });
        }

        // ================= INITIALIZATION =================
        // Priority: 1. URL Hash, 2. LocalStorage, 3. Default 'broadcast'
        let initialTab = location.hash.slice(1);
        if (!initialTab) {
            initialTab = localStorage.getItem('remnawave_other_active_tab');
        }

        const validTabs = ['broadcast', 'promo', 'servers', 'logs', 'remnawave'];
        if (!validTabs.includes(initialTab)) {
            initialTab = 'broadcast';
        }

        switchTab(initialTab);

        // ================= OTHER LOGIC =================
        let uploadedMediaFilename = null;
        let buttons = [];

        async function loadStats() {
            try {
                const resp = await fetch('/other/broadcast/stats');
                const data = await resp.json();
                if (data.ok) {
                    if (document.getElementById('stat-total')) document.getElementById('stat-total').textContent = data.total_users;
                    if (document.getElementById('stat-with-keys')) document.getElementById('stat-with-keys').textContent = data.users_with_keys;
                    if (document.getElementById('stat-expired-keys')) document.getElementById('stat-expired-keys').textContent = data.users_with_expired_keys || 0;
                    if (document.getElementById('stat-no-trial')) document.getElementById('stat-no-trial').textContent = data.users_without_trial;

                    if (data.last_results) {
                        if (document.getElementById('result-sent')) document.getElementById('result-sent').textContent = data.last_results.sent || 0;
                        if (document.getElementById('result-failed')) document.getElementById('result-failed').textContent = data.last_results.failed || 0;
                        if (document.getElementById('result-skipped')) document.getElementById('result-skipped').textContent = data.last_results.skipped || 0;
                        if (data.last_results.timestamp) {
                            const date = new Date(data.last_results.timestamp);
                            if (document.getElementById('result-time')) document.getElementById('result-time').textContent = `–ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–∞—Å—Å—ã–ª–∫–∞: ${date.toLocaleString('ru-RU')} `;
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        loadStats();

        document.getElementById('btn-upload-media').addEventListener('click', () => {
            document.getElementById('media-input').click();
        });

        document.getElementById('media-input').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            // Client-side file size validation (50MB limit)
            const maxSize = 50 * 1024 * 1024; // 50MB in bytes
            if (file.size > maxSize) {
                window.showToast('danger', `–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë. –†–∞–∑–º–µ—Ä –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞: ${(file.size / 1024 / 1024).toFixed(2)} –ú–ë`);
                e.target.value = ''; // Clear the input
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const loading = document.createElement('p');
                loading.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                loading.className = 'text-white/50 text-sm mt-2';
                e.target.parentElement.appendChild(loading);

                const resp = await fetch('/other/broadcast/upload', {
                    method: 'POST',
                    body: formData
                });

                loading.remove();

                // Handle HTTP errors before trying to parse JSON
                if (!resp.ok) {
                    if (resp.status === 413) {
                        window.showToast('danger', '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë');
                    } else {
                        window.showToast('danger', `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${resp.status} ${resp.statusText}`);
                    }
                    e.target.value = ''; // Clear the input
                    return;
                }

                const data = await resp.json();

                if (data.ok) {
                    uploadedMediaFilename = data.filename;
                    const preview = document.getElementById('media-preview');
                    const img = document.getElementById('media-preview-img');
                    const video = document.getElementById('media-preview-video');

                    preview.classList.remove('hidden');

                    if (data.media_type === 'photo' || data.media_type === 'animation') {
                        img.src = URL.createObjectURL(file);
                        img.classList.remove('hidden');
                        video.classList.add('hidden');
                    } else if (data.media_type === 'video') {
                        video.src = URL.createObjectURL(file);
                        video.classList.remove('hidden');
                        img.classList.add('hidden');
                    }

                    window.showToast('success', '–ú–µ–¥–∏–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞');
            }
        });

        document.getElementById('btn-remove-media').addEventListener('click', async () => {
            if (uploadedMediaFilename) {
                try {
                    await fetch(`/other/broadcast/delete-media/${uploadedMediaFilename}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': window.getCsrfToken()
                        }
                    });
                } catch (e) {
                    console.error('Failed to delete media:', e);
                }
                uploadedMediaFilename = null;
            }
            document.getElementById('media-preview').classList.add('hidden');
            document.getElementById('media-input').value = '';
        });

        function renderButtons() {
            const list = document.getElementById('buttons-list');
            list.innerHTML = '';
            buttons.forEach((btn, idx) => {
                const item = document.createElement('div');
                item.className = 'flex gap-2';
                item.innerHTML = `
                    <input type="text" value="${btn.text}" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" class="flex-1 bg-white/5 border border-white/10 rounded px-3 py-2 text-white text-sm" data-idx="${idx}" data-field="text" />
                    <input type="url" value="${btn.url}" placeholder="https://..." class="flex-1 bg-white/5 border border-white/10 rounded px-3 py-2 text-white text-sm" data-idx="${idx}" data-field="url" />
                    <button type="button" class="px-3 py-2 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30" data-remove="${idx}">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                `;
                list.appendChild(item);
            });

            list.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    const field = e.target.dataset.field;
                    buttons[idx][field] = e.target.value;
                });
            });

            list.querySelectorAll('[data-remove]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.closest('[data-remove]').dataset.remove);
                    buttons.splice(idx, 1);
                    renderButtons();
                });
            });
        }

        document.getElementById('btn-add-button').addEventListener('click', () => {
            if (buttons.length >= 6) {
                window.showToast('warning', '–ú–∞–∫—Å–∏–º—É–º 6 –∫–Ω–æ–ø–æ–∫');
                return;
            }
            buttons.push({ text: '', url: '' });
            renderButtons();
        });

        document.getElementById('btn-preview').addEventListener('click', async () => {
            const text = document.getElementById('broadcast-text').value.trim();
            if (!text) {
                window.showToast('warning', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('text', text);
            formData.append('buttons', JSON.stringify(buttons));
            if (uploadedMediaFilename) {
                formData.append('media_filename', uploadedMediaFilename);
            }

            try {
                const resp = await fetch('/other/broadcast/preview', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ –±–æ—Ç');
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
            }
        });

        document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const text = document.getElementById('broadcast-text').value.trim();
            if (!text) {
                window.showToast('warning', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            const mode = document.querySelector('input[name="mode"]:checked').value;

            const confirmed = await window.showConfirm({
                title: '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏',
                message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?',
                type: 'warning',
                confirmText: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
                cancelText: '–û—Ç–º–µ–Ω–∞'
            });
            if (!confirmed) return;

            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('text', text);
            formData.append('mode', mode);
            formData.append('buttons', JSON.stringify(buttons));
            if (uploadedMediaFilename) {
                formData.append('media_filename', uploadedMediaFilename);
            }

            const btn = document.getElementById('btn-send');
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –û—Ç–ø—Ä–∞–≤–∫–∞...`;

            try {
                const resp = await fetch('/other/broadcast/send', {
                    method: 'POST',
                    body: formData
                });

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–∞–π–º–∞—É—Ç –∏–ª–∏ –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
                if (!resp.ok) {
                    if (resp.status === 504) {
                        window.showToast('warning', '–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞, –Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ —É—Å–ø–µ–ª –æ—Ç–≤–µ—Ç–∏—Ç—å –≤–æ–≤—Ä–µ–º—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.');
                    } else {
                        window.showToast('danger', `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${resp.status}`);
                    }
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ—Ç–≤–µ—Ç - JSON
                const contentType = resp.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    window.showToast('danger', '–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç');
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
                    return;
                }

                const data = await resp.json();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å task_id
                if (data.ok && data.task_id) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    document.getElementById('broadcast-progress-container').classList.remove('hidden');

                    // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
                    const pollStatus = async (taskId) => {
                        try {
                            const statusResp = await fetch(`/other/broadcast/status/${taskId}`);
                            if (!statusResp.ok) return;

                            const statusData = await statusResp.json();
                            if (!statusData.ok) return;

                            const progress = statusData.progress;

                            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                            document.getElementById('broadcast-progress-bar').style.width = `${progress.progress}%`;
                            document.getElementById('broadcast-progress-percent').textContent = `${progress.progress}%`;
                            document.getElementById('broadcast-progress-sent').textContent = progress.sent || 0;
                            document.getElementById('broadcast-progress-failed').textContent = progress.failed || 0;
                            document.getElementById('broadcast-progress-skipped').textContent = progress.skipped || 0;

                            // –ï—Å–ª–∏ —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                            if (progress.status === 'completed') {
                                setTimeout(() => {
                                    document.getElementById('broadcast-progress-container').classList.add('hidden');
                                    btn.disabled = false;
                                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';

                                    window.showToast('success',
                                        `–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${progress.sent}, –û—à–∏–±–æ–∫: ${progress.failed}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${progress.skipped}`);

                                    loadStats();
                                    document.getElementById('broadcast-text').value = '';
                                    buttons = [];
                                    renderButtons();
                                    if (uploadedMediaFilename) {
                                        document.getElementById('media-preview').classList.add('hidden');
                                        uploadedMediaFilename = null;
                                    }
                                }, 2000);
                            } else {
                                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–æ—Å
                                setTimeout(() => pollStatus(taskId), 2000);
                            }
                        } catch (e) {
                            console.error('Error polling broadcast status:', e);
                        }
                    };

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">schedule</span> –†–∞—Å—Å—ã–ª–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';

                    // –ü–µ—Ä–≤—ã–π –æ–ø—Ä–æ—Å —Å—Ä–∞–∑—É
                    pollStatus(data.task_id);

                    window.showToast('info', `–ó–∞–ø—É—â–µ–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∞ –¥–ª—è ${data.total_users} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
                } else if (data.ok && data.results) {
                    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
                    window.showToast('success', `–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.results.sent}, –û—à–∏–±–æ–∫: ${data.results.failed}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${data.results.skipped}`);
                    loadStats();
                    document.getElementById('broadcast-text').value = '';
                    buttons = [];
                    renderButtons();
                    if (uploadedMediaFilename) {
                        document.getElementById('media-preview').classList.add('hidden');
                        uploadedMediaFilename = null;
                    }
                } else {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
                }
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
                window.showToast('danger', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
            }
        });

        // ==================== –ü—Ä–æ–º–æ–∫–æ–¥—ã ====================

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∞–≤—Ç–æ/—Ä—É—á–Ω—ã–º –≤–≤–æ–¥–æ–º –∫–æ–¥–∞
        document.querySelectorAll('input[name="code_mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const manualField = document.getElementById('manual-code-field');
                if (e.target.value === 'manual') {
                    manualField.classList.remove('hidden');
                } else {
                    manualField.classList.add('hidden');
                }
            });
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
        async function loadPromos() {
            try {
                const resp = await fetch('/other/promo/list');
                const data = await resp.json();

                if (data.ok && data.promos) {
                    renderPromos(data.promos);
                }
            } catch (e) {
                console.error('Failed to load promos:', e);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
        function renderPromos(promos) {
            const tbody = document.getElementById('promo-table-body');

            if (promos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-white/50">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</td></tr>';
                return;
            }

            tbody.innerHTML = promos.map(promo => {
                const discount = promo.discount_percent
                    ? `${promo.discount_percent}%`
                    : `${promo.discount_amount} ‚ÇΩ`;

                const used = promo.used_total || 0;
                const totalLimit = promo.usage_limit_total || '‚àû';
                const perUserLimit = promo.usage_limit_per_user || '‚àû';

                const validFrom = promo.valid_from ? new Date(promo.valid_from).toLocaleDateString('ru-RU') : '‚Äî';
                const validUntil = promo.valid_until ? new Date(promo.valid_until).toLocaleDateString('ru-RU') : '‚Äî';

                const isActive = promo.is_active;
                const statusColor = isActive ? 'text-green-400' : 'text-red-400';
                const statusText = isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                const toggleIcon = isActive ? 'toggle_on' : 'toggle_off';

                return `
                    <tr class="hover:bg-white/5">
                        <td class="px-4 py-3 text-white font-mono font-bold">${promo.code}</td>
                        <td class="px-4 py-3 text-white">${discount}</td>
                        <td class="px-4 py-3 text-white">${used} / ${totalLimit}</td>
                        <td class="px-4 py-3 text-white">${perUserLimit}</td>
                        <td class="px-4 py-3 text-white/70 text-sm">${validFrom} ‚Äî ${validUntil}</td>
                        <td class="px-4 py-3 ${statusColor}">${statusText}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="togglePromo('${promo.code}')" class="p-2 rounded hover:bg-white/10" title="–í–∫–ª/–í—ã–∫–ª">
                                    <span class="material-symbols-outlined ${statusColor}">${toggleIcon}</span>
                                </button>
                                <button onclick="editPromo('${promo.code}')" class="p-2 rounded hover:bg-white/10 text-primary" title="–ò–∑–º–µ–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏—è">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button onclick="deletePromo('${promo.code}')" class="p-2 rounded hover:bg-white/10 text-red-400" title="–£–¥–∞–ª–∏—Ç—å">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        document.getElementById('promo-create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            // –ï—Å–ª–∏ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º, —É–¥–∞–ª—è–µ–º –∫–æ–¥ –∏–∑ formData
            const codeMode = formData.get('code_mode');
            if (codeMode === 'auto') {
                formData.delete('code');
            }
            formData.delete('code_mode');

            try {
                const resp = await fetch('/other/promo/create', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `–ü—Ä–æ–º–æ–∫–æ–¥ ${data.code} —Å–æ–∑–¥–∞–Ω!`);
                    e.target.reset();
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        });

        // Toggle –ø—Ä–æ–º–æ–∫–æ–¥–∞
        window.togglePromo = async function (code) {
            try {
                const resp = await fetch(`/other/promo/toggle/${code}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `–ü—Ä–æ–º–æ–∫–æ–¥ ${data.is_active ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}`);
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        };

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        window.editPromo = async function (code) {
            try {
                const resp = await fetch('/other/promo/list');
                const data = await resp.json();

                if (data.ok) {
                    const promo = data.promos.find(p => p.code === code);
                    if (!promo) return;

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('edit-promo-code').value = promo.code;
                    document.getElementById('edit-code-display').value = promo.code;

                    const discountType = promo.discount_percent ? 'percent' : 'fixed';
                    document.querySelector(`input[name="edit_discount_type"][value="${discountType}"]`).checked = true;
                    document.querySelector('input[name="edit_discount_value"]').value = promo.discount_percent || promo.discount_amount;

                    document.querySelector('input[name="edit_usage_limit_total"]').value = promo.usage_limit_total || '';
                    document.querySelector('input[name="edit_usage_limit_per_user"]').value = promo.usage_limit_per_user || '';

                    if (promo.valid_from) {
                        const dt = new Date(promo.valid_from);
                        document.querySelector('input[name="edit_valid_from"]').value = dt.toISOString().slice(0, 16);
                    }
                    if (promo.valid_until) {
                        const dt = new Date(promo.valid_until);
                        document.querySelector('input[name="edit_valid_until"]').value = dt.toISOString().slice(0, 16);
                    }

                    document.querySelector('textarea[name="edit_description"]').value = promo.description || '';

                    openModal('editPromoModal');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        document.getElementById('promo-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const code = document.getElementById('edit-promo-code').value;
            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('discount_type', document.querySelector('input[name="edit_discount_type"]:checked').value);
            formData.append('discount_value', document.querySelector('input[name="edit_discount_value"]').value);
            formData.append('usage_limit_total', document.querySelector('input[name="edit_usage_limit_total"]').value);
            formData.append('usage_limit_per_user', document.querySelector('input[name="edit_usage_limit_per_user"]').value);
            formData.append('valid_from', document.querySelector('input[name="edit_valid_from"]').value);
            formData.append('valid_until', document.querySelector('input[name="edit_valid_until"]').value);
            formData.append('description', document.querySelector('textarea[name="edit_description"]').value);

            try {
                const resp = await fetch(`/other/promo/update/${code}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', '–ü—Ä–æ–º–æ–∫–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω');
                    closeModal('editPromoModal');
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        window.deletePromo = async function (code) {
            const confirmed = await window.showConfirm({
                title: '–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞',
                message: `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ "${code}"?`,
                type: 'danger',
                confirmText: '–£–¥–∞–ª–∏—Ç—å',
                cancelText: '–û—Ç–º–µ–Ω–∞'
            });
            if (!confirmed) return;

            try {
                const resp = await fetch(`/other/promo/delete/${code}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', '–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω');
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        const promoTab = document.querySelector('[data-tab="promo"]');
        if (promoTab) {
            promoTab.addEventListener('click', () => {
                loadPromos();
            });
        }

        // ==================== –°–µ—Ä–≤–µ—Ä–∞ ====================

        let serversAutoRefresh = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
        async function loadServers() {
            try {
                const resp = await fetch('/other/servers/list');
                const data = await resp.json();

                if (data.ok) {
                    renderHosts(data.hosts || []);
                    renderSshTargets(data.ssh_targets || []);
                }
            } catch (e) {
                console.error('Failed to load servers:', e);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ Remnawave
        function renderHosts(hosts) {
            const listEl = document.getElementById('remna-hosts-list');
            const countEl = document.getElementById('remna-hosts-count');

            countEl.textContent = hosts.length;

            if (hosts.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-6 text-blue-300/40">
                        <span class="material-symbols-outlined text-3xl mb-2">dns</span>
                        <p class="text-sm">–•–æ—Å—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                    </div>
                `;
                return;
            }

            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π grid –¥–ª—è Remna_hosts
            listEl.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                    ${hosts.map((host, idx) => `
                        <div class="bg-white/5 rounded-lg p-4 border border-white/10 hover:border-white/20 transition-all">
                            <div class="flex items-start gap-3 mb-3">
                                <div class="flex-shrink-0 mt-0.5">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-400 shadow-lg shadow-blue-500/50" id="host-status-${idx}"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="material-symbols-outlined text-blue-400 text-base">dns</span>
                                        <div class="text-white font-semibold text-sm truncate">${host.host_name}</div>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-1.5 text-white/60 text-xs">
                                            <span class="material-symbols-outlined text-white/40" style="font-size: 10px">link</span>
                                            <span class="truncate">${host.host_url || 'N/A'}</span>
                                        </div>
                                        <div class="flex items-center gap-1.5 text-white/60 text-xs">
                                            <span class="material-symbols-outlined text-white/40" style="font-size: 10px">storage</span>
                                            <span>${host.ssh_host || 'N/A'}:${host.ssh_port || 22}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3 text-xs bg-black/30 rounded p-2 border border-white/5" id="host-uptime-${idx}">
                                <div class="flex items-center gap-2 text-white/50">
                                    <span class="material-symbols-outlined animate-spin text-white/40" style="font-size: 12px">progress_activity</span>
                                    <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 pt-2 border-t border-white/10">
                                <button onclick="refreshHostUptime('${host.host_name}', ${idx})" 
                                    class="flex-1 px-2 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-xs font-medium flex items-center justify-center gap-1 transition-colors">
                                    <span class="material-symbols-outlined" style="font-size: 14px">refresh</span>
                                    –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                                <button onclick="rebootServer('host', '${host.host_name}')" 
                                    class="flex-1 px-2 py-1.5 rounded-md bg-red-500/20 hover:bg-red-500/30 text-red-400 text-xs font-medium flex items-center justify-center gap-1 transition-colors">
                                    <span class="material-symbols-outlined" style="font-size: 14px">restart_alt</span>
                                    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º uptime –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ—Å—Ç–∞
            hosts.forEach((host, idx) => {
                loadUptime('host', host.host_name, idx);
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ SSH-—Ü–µ–ª–µ–π
        function renderSshTargets(targets) {
            const listEl = document.getElementById('ssh-targets-list');
            const countEl = document.getElementById('ssh-targets-count');

            countEl.textContent = targets.length;

            if (targets.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-8 text-yellow-300/40">
                        <span class="material-symbols-outlined text-4xl mb-2">terminal</span>
                        <p class="text-sm">SSH-—Ü–µ–ª–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                    </div>
                `;
                return;
            }

            // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è SSH-—Ü–µ–ª–µ–π (1-4 –∫–æ–ª–æ–Ω–∫–∏)
            listEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    ${targets.map((target, idx) => `
                        <div class="bg-white/5 rounded-lg p-4 border border-white/10 hover:border-white/20 transition-all">
                            <div class="flex items-start gap-3 mb-3">
                                <div class="flex-shrink-0 mt-0.5">
                                    <div class="w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-lg shadow-yellow-500/50" id="target-status-${idx}"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="material-symbols-outlined text-yellow-400 text-base">terminal</span>
                                        <div class="text-white font-semibold text-sm truncate">${target.target_name}</div>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-1.5 text-white/60 text-xs">
                                            <span class="material-symbols-outlined text-white/40" style="font-size: 10px">storage</span>
                                            <span class="truncate">${target.ssh_host}:${target.ssh_port || 22}</span>
                                        </div>
                                        <div class="flex items-center gap-1.5 text-white/60 text-xs">
                                            <span class="material-symbols-outlined text-white/40" style="font-size: 10px">person</span>
                                            <span>${target.ssh_username || 'root'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3 text-xs bg-black/30 rounded p-2 border border-white/5" id="target-uptime-${idx}">
                                <div class="flex items-center gap-2 text-white/50">
                                    <span class="material-symbols-outlined animate-spin text-white/40" style="font-size: 12px">progress_activity</span>
                                    <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                            
                            <div class="space-y-2 pt-2 border-t border-white/10">
                                <button onclick="deployNodeWizard('${target.target_name}')" 
                                    class="w-full px-2 py-1.5 rounded-md bg-primary text-background-dark text-xs font-bold flex items-center justify-center gap-1 transition-colors hover:bg-primary/90">
                                    <span class="material-symbols-outlined" style="font-size: 14px">rocket_launch</span>
                                    –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–æ–¥—É
                                </button>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="refreshTargetUptime('${target.target_name}', ${idx})" 
                                        class="px-2 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-xs font-medium flex items-center justify-center gap-1 transition-colors">
                                        <span class="material-symbols-outlined" style="font-size: 14px">refresh</span>
                                        –û–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                    <button onclick="rebootServer('ssh', '${target.target_name}')" 
                                        class="px-2 py-1.5 rounded-md bg-red-500/20 hover:bg-red-500/30 text-red-400 text-xs font-medium flex items-center justify-center gap-1 transition-colors">
                                        <span class="material-symbols-outlined" style="font-size: 14px">restart_alt</span>
                                        –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mt-2 border-t border-white/5 pt-2">
                                    <button onclick="openWarpWizard('${target.target_name}')" 
                                        class="px-2 py-1.5 rounded-md bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 text-xs font-bold flex items-center justify-center gap-1 transition-colors">
                                        <span class="material-symbols-outlined" style="font-size: 14px">vpn_lock</span>
                                        WARP
                                    </button>
                                    <button onclick="openSwapModal('${target.target_name}')" 
                                        class="px-2 py-1.5 rounded-md bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 text-xs font-bold flex items-center justify-center gap-1 transition-colors">
                                        <span class="material-symbols-outlined" style="font-size: 14px">memory</span>
                                        SWAP
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º uptime –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏
            targets.forEach((target, idx) => {
                loadUptime('ssh', target.target_name, idx);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ uptime –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
        async function loadUptime(type, name, idx) {
            const uptimeEl = type === 'host' ? document.getElementById(`host-uptime-${idx}`) : document.getElementById(`target-uptime-${idx}`);
            const statusEl = type === 'host' ? document.getElementById(`host-status-${idx}`) : document.getElementById(`target-status-${idx}`);

            try {
                const resp = await fetch(`/other/servers/uptime/${type}/${encodeURIComponent(name)}`);
                const data = await resp.json();

                if (data.ok) {
                    if (uptimeEl) {
                        uptimeEl.innerHTML = `
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-white/40" style="font-size: 12px">schedule</span>
                                    <span class="text-white/80">Uptime: ${data.uptime_formatted}</span>
                                </div>
                            </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-white/40" style="font-size: 12px">memory</span>
                                    <span class="text-white/80">CPU: ${data.cpu_percent}% (${data.cpu_cores} —è–¥–µ—Ä${data.cpu_cores > 1 && data.cpu_cores < 5 ? '–∞' : ''})</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-white/40" style="font-size: 12px">developer_board</span>
                                    <span class="text-white/80">RAM: ${data.ram_percent}% (${data.ram_used} / ${data.ram_total} –ú–ë)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-white/40" style="font-size: 12px">swap_horiz</span>
                                    <span class="text-white/80">
                                        ${data.swap_total > 0
                                ? `SWAP: ${data.swap_percent}% (${data.swap_used} / ${data.swap_total} –ú–ë) –æ—Ç ${data.swappiness}%`
                                : `SWAP: –ù–ï–¢`
                            }
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                    if (statusEl) {
                        statusEl.className = 'w-2.5 h-2.5 rounded-full bg-green-500 shadow-lg shadow-green-500/50';
                    }
                } else {
                    if (uptimeEl) {
                        uptimeEl.innerHTML = `<div class="text-red-400 text-xs">–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}</div>`;
                    }
                    if (statusEl) {
                        statusEl.className = 'w-2.5 h-2.5 rounded-full bg-red-500 shadow-lg shadow-red-500/50';
                    }
                }
            } catch (e) {
                console.error('Failed to load uptime:', e);
                if (uptimeEl) {
                    uptimeEl.innerHTML = '<div class="text-red-400 text-xs">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
                if (statusEl) {
                    statusEl.className = 'w-2.5 h-2.5 rounded-full bg-red-500 shadow-lg shadow-red-500/50';
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ uptime –¥–ª—è —Ö–æ—Å—Ç–∞
        window.refreshHostUptime = function (name, idx) {
            loadUptime('host', name, idx);
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ uptime –¥–ª—è SSH-—Ü–µ–ª–∏
        window.refreshTargetUptime = function (name, idx) {
            loadUptime('ssh', name, idx);
        };

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
        window.rebootServer = async function (type, name) {
            const typeName = type === 'host' ? '—Å–µ—Ä–≤–µ—Ä' : 'SSH-—Ü–µ–ª—å';

            const confirmed = await window.showConfirm({
                title: '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
                message: `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ${typeName} "${name}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–∏—Å—Ç–µ–º—ã.`,
                type: 'warning',
                confirmText: '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å',
                cancelText: '–û—Ç–º–µ–Ω–∞'
            });
            if (!confirmed) return;

            try {
                const resp = await fetch(`/other/servers/reboot/${type}/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `–ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ ${name}`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        loadServers();
                    }, 5000);
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞');
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        const serversTab = document.querySelector('[data-tab="servers"]');
        if (serversTab) {
            serversTab.addEventListener('click', () => {
                loadServers();

                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
                if (serversAutoRefresh) {
                    clearInterval(serversAutoRefresh);
                }
                serversAutoRefresh = setInterval(() => {
                    loadServers();
                }, 60000);
            });
        }

        // ==================== –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ù–æ–¥—ã Remnawave ====================

        let currentDeployTarget = null;
        let currentDeployStep = 1;

        window.deployNodeWizard = async function (targetName) {
            currentDeployTarget = targetName;
            currentDeployStep = 1;

            document.getElementById('deploy-target-name').textContent = targetName;
            document.getElementById('deploy-output').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è...';
            document.getElementById('docker-compose-content').value = '';

            // –°–±—Ä–æ—Å —à–∞–≥–æ–≤
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`deploy-step-${i}`).classList.add('hidden');
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —à–∞–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            updateDeployStep(1);
            openModal('deployNodeModal');

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            setupDeployHandlers();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
            try {
                appendDeployOutput('[INFO] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è...');

                const resp = await fetch(`/other/servers/deploy/check-status/${encodeURIComponent(targetName)}`);
                if (!resp.ok) {
                    appendDeployOutput('[WARNING] –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ù–∞—á–∏–Ω–∞–µ–º —Å —à–∞–≥–∞ 1.');
                    return;
                }

                const data = await resp.json();
                if (data.ok && data.status) {
                    const status = data.status;

                    // –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç—É—Å
                    if (status.docker_installed) {
                        appendDeployOutput('[‚úì] Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    } else {
                        appendDeployOutput('[‚úó] Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    }

                    if (status.directory_exists) {
                        appendDeployOutput('[‚úì] –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /opt/remnanode —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                    } else if (status.docker_installed) {
                        appendDeployOutput('[‚úó] –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /opt/remnanode –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    }

                    if (status.compose_file_exists) {
                        appendDeployOutput('[‚úì] –§–∞–π–ª docker-compose.yml —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                    } else if (status.directory_exists) {
                        appendDeployOutput('[‚úó] –§–∞–π–ª docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }

                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–º—É —à–∞–≥—É
                    const suggestedStep = status.suggested_step || 1;
                    appendDeployOutput(`[INFO] –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É ${suggestedStep}...`);

                    // –ï—Å–ª–∏ —à–∞–≥ 5 (–≤—Å–µ –≥–æ—Ç–æ–≤–æ), –∑–∞–≥—Ä—É–∂–∞–µ–º docker-compose.yml
                    if (suggestedStep === 5) {
                        appendDeployOutput('[SUCCESS] –ù–æ–¥–∞ —É–∂–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞! –ú–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –µ—é.');
                        try {
                            const composeResp = await fetch(`/other/servers/deploy/view-compose/${encodeURIComponent(targetName)}`);
                            if (composeResp.ok) {
                                const composeData = await composeResp.json();
                                if (composeData.ok) {
                                    document.getElementById('docker-compose-content').value = composeData.content;
                                }
                            }
                        } catch (e) {
                            console.error('Failed to load docker-compose.yml:', e);
                        }
                    }

                    updateDeployStep(suggestedStep);
                } else {
                    appendDeployOutput('[WARNING] –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ù–∞—á–∏–Ω–∞–µ–º —Å —à–∞–≥–∞ 1.');
                }
            } catch (e) {
                console.error('Status check error:', e);
                appendDeployOutput('[WARNING] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –ù–∞—á–∏–Ω–∞–µ–º —Å —à–∞–≥–∞ 1.');
            }
        };

        function setupDeployHandlers() {
            // –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
            document.getElementById('btn-install-docker').onclick = async function () {
                await executeDeployStep('install-docker', this, async () => {
                    const resp = await fetch(`/other/servers/deploy/install-docker/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': window.getCsrfToken() }
                    });

                    if (!resp.ok) {
                        if (resp.status === 504) {
                            throw new Error('TIMEOUT_504: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∑–∞–Ω–∏–º–∞–µ—Ç 2-5 –º–∏–Ω—É—Ç. –û–ø–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.');
                        }
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 2);
            };

            // –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            document.getElementById('btn-create-directory').onclick = async function () {
                await executeDeployStep('create-directory', this, async () => {
                    const resp = await fetch(`/other/servers/deploy/create-directory/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': window.getCsrfToken() }
                    });

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 3);
            };

            // –®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ docker-compose.yml
            document.getElementById('btn-save-compose').onclick = async function () {
                const content = document.getElementById('docker-compose-content').value.trim();
                if (!content) {
                    window.showToast('warning', '–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ docker-compose.yml');
                    return;
                }

                await executeDeployStep('save-compose', this, async () => {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('content', content);

                    const resp = await fetch(`/other/servers/deploy/save-compose/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 4);
            };

            // –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            document.getElementById('btn-start-containers').onclick = async function () {
                await executeDeployStep('start-containers', this, async () => {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('action', 'start');

                    const resp = await fetch(`/other/servers/deploy/manage-containers/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    return await resp.json();
                }, 5);
            };

            // –®–∞–≥ 5: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–æ–π
            document.getElementById('btn-view-compose').onclick = async function () {
                try {
                    const resp = await fetch(`/other/servers/deploy/view-compose/${encodeURIComponent(currentDeployTarget)}`);
                    const data = await resp.json();

                    if (data.ok) {
                        document.getElementById('docker-compose-content').value = data.content;
                        updateDeployStep(3);
                        window.showToast('success', '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                    } else {
                        window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                }
            };

            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é" –≤ —à–∞–≥–µ 3
            document.getElementById('btn-cancel-compose').onclick = function () {
                updateDeployStep(5);
                window.showToast('info', '–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            };

            document.getElementById('btn-restart-node').onclick = async function () {
                const confirmed = await window.showConfirm({
                    title: '–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–æ–¥—ã',
                    message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É Remnawave?',
                    type: 'warning',
                    confirmText: '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å',
                    cancelText: '–û—Ç–º–µ–Ω–∞'
                });
                if (!confirmed) return;

                const btn = this;
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...';

                try {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('action', 'restart');

                    const resp = await fetch(`/other/servers/deploy/manage-containers/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        appendDeployOutput('[SUCCESS] ' + data.message);
                        if (data.output) appendDeployOutput(data.output);
                        window.showToast('success', '–ù–æ–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞');
                    } else {
                        appendDeployOutput('[ERROR] ' + (data.error || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞'));
                        if (data.output) appendDeployOutput(data.output);
                        window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –Ω–æ–¥—ã');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            };

            document.getElementById('btn-view-logs').onclick = async function () {
                const btn = this;
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –ó–∞–≥—Ä—É–∑–∫–∞...';

                try {
                    const formData = new FormData();
                    formData.append('csrf_token', window.getCsrfToken());
                    formData.append('action', 'logs');

                    const resp = await fetch(`/other/servers/deploy/manage-containers/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        appendDeployOutput('[LOGS]\n' + data.output);
                        window.showToast('success', '–õ–æ–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                    } else {
                        appendDeployOutput('[ERROR] ' + (data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤'));
                        window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤');
                    }
                } catch (e) {
                    console.error(e);
                    window.showToast('danger', '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            };

            document.getElementById('btn-clear-deploy-logs').onclick = function () {
                document.getElementById('deploy-output').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π...';
            };

            // –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–¥—ã –∏ Docker
            // –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–¥—ã –∏ Docker
            document.getElementById('btn-remove-all').onclick = function () {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                showDeleteConfirmation(currentDeployTarget);
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
        function showDeleteConfirmation(serverName) {
            const modal = document.getElementById('confirmDeleteModal');
            const input = document.getElementById('confirm-delete-input');
            const confirmBtn = document.getElementById('btn-confirm-delete');
            const cancelBtn = document.getElementById('btn-cancel-delete');
            const serverNameSpan = document.getElementById('confirm-server-name');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
            serverNameSpan.textContent = serverName;
            input.value = '';
            confirmBtn.disabled = true;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.style.display = 'flex';
            setTimeout(() => input.focus(), 100);

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            const validateInput = () => {
                confirmBtn.disabled = input.value !== serverName;
            };

            input.oninput = validateInput;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter
            input.onkeypress = (e) => {
                if (e.key === 'Enter' && !confirmBtn.disabled) {
                    confirmBtn.click();
                }
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
            const closeConfirmModal = () => {
                modal.style.display = 'none';
                input.value = '';
                input.oninput = null;
                input.onkeypress = null;
            };

            cancelBtn.onclick = closeConfirmModal;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
            confirmBtn.onclick = async () => {
                if (input.value !== serverName) {
                    window.showToast('warning', '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç');
                    return;
                }

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                closeConfirmModal();

                // –í—ã–ø–æ–ª–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
                const btn = document.getElementById('btn-remove-all');
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –£–¥–∞–ª–µ–Ω–∏–µ...';

                try {
                    appendDeployOutput('[WARNING] –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–¥—ã –∏ Docker...');

                    const resp = await fetch(`/other/servers/deploy/remove-all/${encodeURIComponent(currentDeployTarget)}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': window.getCsrfToken() }
                    });

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    const data = await resp.json();

                    if (data.ok) {
                        appendDeployOutput('[SUCCESS] ' + data.message);
                        if (data.output) appendDeployOutput(data.output);
                        window.showToast('success', '–ù–æ–¥–∞ –∏ Docker —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã');

                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            closeModal('deployNodeModal');
                        }, 2000);
                    } else {
                        appendDeployOutput('[ERROR] ' + (data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'));
                        if (data.output) appendDeployOutput(data.output);
                        window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (e) {
                    console.error('Remove all error:', e);
                    appendDeployOutput('[ERROR] ' + e.message);
                    window.showToast('danger', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            };
        }

        async function executeDeployStep(stepName, button, apiCall, nextStep) {
            button.disabled = true;
            const originalHtml = button.innerHTML;
            button.innerHTML = '<svg class="animate-spin h-5 w-5 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...';

            try {
                appendDeployOutput(`[INFO] –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${stepName}...`);
                const data = await apiCall();

                if (data.ok) {
                    appendDeployOutput('[SUCCESS] ' + data.message);
                    if (data.output) {
                        appendDeployOutput(data.output);
                    }

                    window.showToast('success', data.message || '–®–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    updateDeployStep(nextStep);
                } else {
                    appendDeployOutput('[ERROR] ' + (data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'));
                    if (data.output) {
                        appendDeployOutput(data.output);
                    }
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∞–≥–∞');
                }
            } catch (e) {
                console.error('Deploy step error:', e);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
                if (e.message && e.message.includes('TIMEOUT_504')) {
                    const cleanMessage = e.message.replace('TIMEOUT_504: ', '');
                    appendDeployOutput('[WARNING] ' + cleanMessage);
                    appendDeployOutput('[INFO] –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.');
                    window.showToast('warning', '–¢–∞–π–º–∞—É—Ç: ' + cleanMessage);
                } else if (e.message && e.message.includes('HTTP')) {
                    appendDeployOutput('[ERROR] ' + e.message);
                    window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + e.message);
                } else {
                    appendDeployOutput('[ERROR] –û—à–∏–±–∫–∞: ' + e.message);
                    window.showToast('danger', '–û—à–∏–±–∫–∞: ' + e.message);
                }
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }

        function updateDeployStep(step) {
            currentDeployStep = step;

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`deploy-step-${i}`).classList.add('hidden');
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥
            document.getElementById(`deploy-step-${step}`).classList.remove('hidden');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            document.getElementById('deploy-current-step').textContent = step;
            document.getElementById('deploy-progress-bar').style.width = `${step * 20}%`;

            const stepNames = [
                '',
                '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker',
                '–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏',
                '–°–æ–∑–¥–∞–Ω–∏–µ docker-compose.yml',
                '–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤',
                '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–æ–π'
            ];

            document.getElementById('deploy-step-name').textContent = stepNames[step] || '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
        }

        function appendDeployOutput(text) {
            const output = document.getElementById('deploy-output');
            const timestamp = new Date().toLocaleTimeString('ru-RU');

            if (output.textContent === '–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π...') {
                output.textContent = '';
            }

            output.textContent += `[${timestamp}] ${text}\n`;
            output.scrollTop = output.scrollHeight;
        }


        // ==================== WARP Wizard ====================
        let currentWarpTarget = null;

        window.openWarpWizard = function (targetName) {
            currentWarpTarget = targetName;
            document.getElementById('warp-target-name').textContent = targetName;

            openModal('warpModal');
            checkWarpStatus(targetName);

            // Reset state
            document.getElementById('warp-logs').textContent = '';
            document.getElementById('warp-logs-container').classList.add('hidden');
            switchWarpTab('config');
        }

        window.switchWarpTab = function (tab) {
            const btnConfig = document.getElementById('btn-tab-warp-config');
            const btnJson = document.getElementById('btn-tab-warp-json');
            const btnSystemd = document.getElementById('btn-tab-warp-systemd');

            const contentConfig = document.getElementById('warp-content-config');
            const contentJson = document.getElementById('warp-content-json');
            const contentSystemd = document.getElementById('warp-content-systemd');

            const activeClass = 'px-4 py-2 text-primary border-b-2 border-primary font-medium text-sm transition-colors';
            const inactiveClass = 'px-4 py-2 text-white/50 hover:text-white font-medium text-sm transition-colors';

            btnConfig.className = inactiveClass;
            btnJson.className = inactiveClass;
            btnSystemd.className = inactiveClass;
            contentConfig.classList.add('hidden');
            contentJson.classList.add('hidden');
            contentSystemd.classList.add('hidden');

            if (tab === 'config') {
                btnConfig.className = activeClass;
                contentConfig.classList.remove('hidden');
            } else if (tab === 'json') {
                btnJson.className = activeClass;
                contentJson.classList.remove('hidden');
            } else if (tab === 'systemd') {
                btnSystemd.className = activeClass;
                contentSystemd.classList.remove('hidden');
                loadWarpSystemdConfig();
            }
        }

        async function checkWarpStatus(targetName) {
            document.getElementById('warp-loading').classList.remove('hidden');
            document.getElementById('warp-install-state').classList.add('hidden');
            document.getElementById('warp-manage-state').classList.add('hidden');

            try {
                const resp = await fetch(`/other/servers/warp/status/${encodeURIComponent(targetName)}`);
                const data = await resp.json();

                document.getElementById('warp-loading').classList.add('hidden');

                if (data.ok && data.status) {
                    if (data.status.installed) {
                        document.getElementById('warp-manage-state').classList.remove('hidden');

                        // Update status indicator
                        const indicator = document.getElementById('warp-status-indicator');
                        const text = document.getElementById('warp-status-text');

                        if (data.status.active) {
                            indicator.className = 'w-4 h-4 rounded-full bg-green-500 shadow-lg shadow-green-500/50';
                            text.textContent = '–ê–∫—Ç–∏–≤–µ–Ω (Running)';
                            text.className = 'text-green-400 font-bold';

                            // Show STOP button
                            const btnToggle = document.getElementById('btn-warp-toggle');
                            if (btnToggle) {
                                btnToggle.title = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å';
                                btnToggle.className = 'p-2 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-400 transition-colors';
                                btnToggle.innerHTML = '<span class="material-symbols-outlined">stop_circle</span>';
                                btnToggle.dataset.action = 'stop';
                            }
                        } else {
                            indicator.className = 'w-4 h-4 rounded-full bg-red-500';
                            text.textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (Inactive)';
                            text.className = 'text-red-400 font-bold';

                            // Show START button
                            const btnToggle = document.getElementById('btn-warp-toggle');
                            if (btnToggle) {
                                btnToggle.title = '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å';
                                btnToggle.className = 'p-2 rounded-lg bg-green-500/20 hover:bg-green-500/30 text-green-400 transition-colors';
                                btnToggle.innerHTML = '<span class="material-symbols-outlined">play_circle</span>';
                                btnToggle.dataset.action = 'start';
                            }
                        }

                        // Fill inputs
                        document.getElementById('warp-memory-max').value = data.status.memory_max || '800M';
                        document.getElementById('warp-memory-high').value = data.status.memory_high || '1G';
                    } else {
                        document.getElementById('warp-install-state').classList.remove('hidden');
                    }
                } else {
                    window.showToast('danger', '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    closeModal('warpModal');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                closeModal('warpModal');
            }
        }

        async function loadWarpSystemdConfig() {
            if (!currentWarpTarget) return;

            const textarea = document.getElementById('warp-systemd-textarea');
            textarea.value = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const resp = await fetch(`/other/servers/warp/systemd/get/${encodeURIComponent(currentWarpTarget)}`);
                const data = await resp.json();

                if (data.ok) {
                    textarea.value = data.content || '';
                } else {
                    textarea.value = '';
                    window.showToast('warning', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥: ' + (data.error || 'Unknown'));
                }
            } catch (e) {
                console.error(e);
                textarea.value = '';
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞');
            }
        }

        document.getElementById('btn-warp-systemd-save').onclick = async function () {
            if (!currentWarpTarget) return;

            const btn = this;
            const textarea = document.getElementById('warp-systemd-textarea');
            const content = textarea.value;

            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            try {
                const formData = new FormData();
                formData.append('content', content);
                formData.append('csrf_token', window.getCsrfToken());

                const resp = await fetch(`/other/servers/warp/systemd/save/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        };

        document.getElementById('btn-warp-check-log-usage').onclick = async function () {
            if (!currentWarpTarget) return;

            const btn = this;
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –ü—Ä–æ–≤–µ—Ä–∫–∞...';

            try {
                const resp = await fetch(`/other/servers/warp/logs/usage/${encodeURIComponent(currentWarpTarget)}`);
                const data = await resp.json();

                if (data.ok) {
                    await window.showConfirm({
                        title: '–†–∞–∑–º–µ—Ä –∂—É—Ä–Ω–∞–ª–∞ (journalctl)',
                        message: data.usage || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                        type: 'info',
                        confirmText: 'OK',
                        cancelText: ''
                    });
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        };

        document.getElementById('btn-warp-clean-logs').onclick = async function () {
            if (!currentWarpTarget) return;

            const maxSize = document.getElementById('warp-log-max-size').value || '0';
            const maxAge = document.getElementById('warp-log-max-age').value || '0';

            if (maxSize === '0' && maxAge === '0') {
                window.showToast('warning', '–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä (—Ä–∞–∑–º–µ—Ä –∏–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç)');
                return;
            }

            const confirmed = await window.showConfirm({
                title: '–û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ Wireproxy',
                message: `–≠—Ç–æ —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ wireproxy.service.\n\n–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:\nMax Size: ${maxSize || '–Ω–µ —É–∫–∞–∑–∞–Ω'} MB\nMax Age: ${maxAge || '–Ω–µ —É–∫–∞–∑–∞–Ω'} –¥–Ω–µ–π`,
                type: 'warning',
                confirmText: '–û—á–∏—Å—Ç–∏—Ç—å',
                cancelText: '–û—Ç–º–µ–Ω–∞'
            });
            if (!confirmed) return;

            const btn = this;
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –û—á–∏—Å—Ç–∫–∞...';

            try {
                const formData = new FormData();
                formData.append('max_size', maxSize);
                formData.append('max_age', maxAge);
                formData.append('csrf_token', window.getCsrfToken());

                const resp = await fetch(`/other/servers/warp/logs/clean/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', data.message || '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
                    if (data.output) {
                        console.log('Clean logs output:', data.output);
                    }
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        };



        // Handlers
        document.getElementById('btn-warp-install').onclick = async function () {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –ñ–¥–∏—Ç–µ...';

            document.getElementById('warp-logs-container').classList.remove('hidden');
            appendWarpLog('–ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.');

            try {
                const resp = await fetch(`/other/servers/warp/install/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.getCsrfToken() }
                });
                const data = await resp.json();

                if (data.ok) {
                    appendWarpLog('–£—Å–ø–µ—à–Ω–æ: ' + data.message);
                    if (data.output) appendWarpLog(data.output);
                    window.showToast('success', 'WARP —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    appendWarpLog('–û—à–∏–±–∫–∞: ' + (data.error || 'Unknown'));
                    if (data.output) appendWarpLog(data.output);
                    window.showToast('danger', '–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏');
                }
            } catch (e) {
                appendWarpLog('Fatal error: ' + e.message);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">download</span> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WARP';
            }
        };

        document.getElementById('btn-warp-uninstall').onclick = async function () {
            if (!await window.showConfirm({
                title: '–£–¥–∞–ª–µ–Ω–∏–µ WARP',
                message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª–µ–Ω–∏—è.',
                type: 'danger',
                confirmText: '–£–¥–∞–ª–∏—Ç—å'
            })) return;

            const btn = this;
            btn.disabled = true;
            document.getElementById('warp-logs-container').classList.remove('hidden');
            appendWarpLog('–£–¥–∞–ª–µ–Ω–∏–µ WARP...');

            try {
                const resp = await fetch(`/other/servers/warp/uninstall/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.getCsrfToken() }
                });
                const data = await resp.json();

                if (data.ok) {
                    appendWarpLog('–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ');
                    window.showToast('success', 'WARP —É–¥–∞–ª–µ–Ω');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    appendWarpLog('–û—à–∏–±–∫–∞: ' + (data.error || 'Unknown'));
                    window.showToast('danger', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (e) {
                appendWarpLog('Error: ' + e.message);
            } finally {
                btn.disabled = false;
            }
        };

        const btnToggle = document.getElementById('btn-warp-toggle');
        if (btnToggle) {
            btnToggle.onclick = async function () {
                const btn = this;
                const action = btn.dataset.action; // 'start' or 'stop'
                const icon = btn.querySelector('.material-symbols-outlined');

                if (!action) return;

                btn.disabled = true;
                if (icon) icon.classList.add('animate-spin'); // Optional: spin logic or change checking

                try {
                    const resp = await fetch(`/other/servers/warp/${action}/${encodeURIComponent(currentWarpTarget)}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': window.getCsrfToken() }
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        window.showToast('success', action === 'start' ? '–°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω' : '–°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                        checkWarpStatus(currentWarpTarget);
                    } else {
                        window.showToast('danger', data.error || '–û—à–∏–±–∫–∞');
                    }
                } catch (e) {
                    window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
                } finally {
                    btn.disabled = false;
                    if (icon) icon.classList.remove('animate-spin');
                }
            };
        }

        document.getElementById('btn-warp-restart').onclick = async function () {
            const btn = this;
            const icon = btn.querySelector('.material-symbols-outlined');
            btn.disabled = true;
            if (icon) icon.classList.add('animate-spin');

            try {
                const resp = await fetch(`/other/servers/warp/restart/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.getCsrfToken() }
                });

                if (resp.ok) {
                    window.showToast('success', '–°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    window.showToast('danger', '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞');
                }
            } catch (e) {
                window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            } finally {
                btn.disabled = false;
                if (icon) icon.classList.remove('animate-spin');
            }
        };

        document.getElementById('warp-config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-warp-save');
            btn.disabled = true;
            btn.innerHTML = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const resp = await fetch(`/other/servers/warp/config/${encodeURIComponent(currentWarpTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
                    checkWarpStatus(currentWarpTarget);
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (e) {
                window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">save</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å';
            }
        });

        function appendWarpLog(text) {
            const logs = document.getElementById('warp-logs');
            logs.textContent += `[${new Date().toLocaleTimeString()}] ${text}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        // ==================== SWAP Manager ====================
        let currentSwapTarget = null;

        window.openSwapModal = function (targetName) {
            currentSwapTarget = targetName;
            document.getElementById('swap-target-name').textContent = targetName;
            openModal('swapModal');
            checkSwapStatus(targetName);
        };

        async function checkSwapStatus(targetName) {
            document.getElementById('swap-loading').classList.remove('hidden');
            document.getElementById('swap-install-state').classList.add('hidden');
            document.getElementById('swap-manage-state').classList.add('hidden');

            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º uptime endpoint —Ç.–∫. –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ—É –ø–æ SWAP
                const resp = await fetch(`/other/servers/uptime/ssh/${encodeURIComponent(targetName)}`);
                const data = await resp.json();

                document.getElementById('swap-loading').classList.add('hidden');

                if (data.ok) {
                    if (data.swap_total > 0) {
                        // Installed
                        document.getElementById('swap-manage-state').classList.remove('hidden');
                        document.getElementById('swap-display-size').textContent = `${data.swap_total} MB`;
                        document.getElementById('swap-display-swappiness').textContent = data.swappiness;
                        document.getElementById('swap-display-used').textContent = `${data.swap_used} MB (${data.swap_percent}%)`;
                        document.getElementById('swap-display-ram').textContent = `${data.ram_used} MB (${data.ram_percent}%)`;

                        document.getElementById('swap-resize-input').value = data.swap_total;
                        document.getElementById('swap-swappiness-input').value = data.swappiness;
                    } else {
                        // Not Installed
                        document.getElementById('swap-install-state').classList.remove('hidden');
                    }
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    closeModal('swapModal');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                closeModal('swapModal');
            }
        }

        // Install SWAP
        document.getElementById('swap-install-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-swap-install');
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –£—Å—Ç–∞–Ω–æ–≤–∫–∞...';

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const resp = await fetch(`/other/servers/swap/install/${encodeURIComponent(currentSwapTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'SWAP —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    checkSwapStatus(currentSwapTarget);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Ñ–æ–Ω–æ–º, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª–∞—Å—å –ø–ª–∞—à–∫–∞ (—Ö–æ—Ç—è —Ç–∞–º –Ω–∞–¥–æ –∂–¥–∞—Ç—å)
                    loadServers();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏');
                }
            } catch (e) {
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">add_circle</span> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SWAP';
            }
        });

        // Resize SWAP
        document.getElementById('swap-resize-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-swap-resize');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Wait...';

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                if (!await window.showConfirm({ title: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞', message: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç SWAP —Ñ–∞–π–ª. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?', type: 'warning' })) return;

                const resp = await fetch(`/other/servers/swap/resize/${encodeURIComponent(currentSwapTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', '–†–∞–∑–º–µ—Ä SWAP –∏–∑–º–µ–Ω–µ–Ω');
                    checkSwapStatus(currentSwapTarget);
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞');
                }
            } catch (e) {
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Update Swappiness
        document.getElementById('swap-swappiness-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-swap-swappiness');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '...';

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const resp = await fetch(`/other/servers/swap/swappiness/${encodeURIComponent(currentSwapTarget)}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'Swappiness –æ–±–Ω–æ–≤–ª–µ–Ω');
                    checkSwapStatus(currentSwapTarget);
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞');
                }
            } catch (e) {
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Delete SWAP
        document.getElementById('btn-swap-delete').onclick = async function () {
            if (!await window.showConfirm({ title: '–£–¥–∞–ª–µ–Ω–∏–µ SWAP', message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.', type: 'danger', confirmText: '–£–¥–∞–ª–∏—Ç—å' })) return;

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '–£–¥–∞–ª–µ–Ω–∏–µ...';

            try {
                const resp = await fetch(`/other/servers/swap/delete/${encodeURIComponent(currentSwapTarget)}`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': window.getCsrfToken() }
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', 'SWAP —É–¥–∞–ª–µ–Ω');
                    checkSwapStatus(currentSwapTarget);
                    loadServers();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞');
                }
            } catch (e) {
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">delete_forever</span> –£–¥–∞–ª–∏—Ç—å SWAP';
            }
        };

    });
</script>

{% endblock %}