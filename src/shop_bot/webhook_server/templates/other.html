{% extends "base.html" %}

{% block title %}–ü—Ä–æ—á–µ–µ - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white">–ü—Ä–æ—á–µ–µ</h2>
    <p class="text-white/50 text-sm">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
</div>

<div class="bg-white/5 border border-white/10 rounded-lg p-2 mb-6 overflow-x-auto">
    <nav class="flex gap-1 min-w-max" id="other-nav">
        <button type="button" data-tab="broadcast"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-primary text-background-dark transition-colors">–†–∞—Å—Å—ã–ª–∫–∞</button>
        <button type="button" data-tab="promo"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">–ü—Ä–æ–º–æ
            –∫–æ–¥—ã</button>
        <button type="button" data-tab="servers"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">–°–µ—Ä–≤–µ—Ä–∞</button>
        <button type="button" data-tab="remnawave"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Remnawave</button>
    </nav>
</div>

<section id="tab-broadcast" class="tab-content">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white/5 border border-white/10 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-primary text-2xl">group</span>
                <p class="text-white/50 text-sm">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            </div>
            <p class="text-2xl font-bold text-white" id="stat-total">-</p>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-primary text-2xl">key</span>
                <p class="text-white/50 text-sm">–° –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏</p>
            </div>
            <p class="text-2xl font-bold text-white" id="stat-with-keys">-</p>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-red-400 text-2xl">key_off</span>
                <p class="text-white/50 text-sm">–° –∏—Å—Ç–µ–∫—à–∏–º–∏ –∫–ª—é—á–∞–º–∏</p>
            </div>
            <p class="text-2xl font-bold text-white" id="stat-expired-keys">-</p>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-primary text-2xl">card_giftcard</span>
                <p class="text-white/50 text-sm">–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–±–Ω—ã–π</p>
            </div>
            <p class="text-2xl font-bold text-white" id="stat-no-trial">-</p>
        </div>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-lg p-6 mb-6">
        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined">bar_chart</span>
            –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—Å—ã–ª–∫–∏
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚úÖ</span>
                <div>
                    <p class="text-white/50 text-sm">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
                    <p class="text-lg font-bold text-white" id="result-sent">0</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚ùå</span>
                <div>
                    <p class="text-white/50 text-sm">–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</p>
                    <p class="text-lg font-bold text-white" id="result-failed">0</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚è≠</span>
                <div>
                    <p class="text-white/50 text-sm">–ü—Ä–æ–ø—É—â–µ–Ω–æ (–∑–∞–±–∞–Ω–µ–Ω—ã)</p>
                    <p class="text-lg font-bold text-white" id="result-skipped">0</p>
                </div>
            </div>
        </div>
        <p class="text-white/50 text-xs mt-4" id="result-time">-</p>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h3 class="text-xl font-bold text-white mb-4">–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h3>

        <form id="broadcast-form">
            <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="mb-6">
                <label class="block text-white/70 text-sm font-medium mb-2">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                <textarea id="broadcast-text" rows="6"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                <p class="text-white/50 text-xs mt-1">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è HTML —Ç–µ–≥–∏: &lt;b&gt;, &lt;i&gt;, &lt;u&gt;, &lt;s&gt;, &lt;code&gt;, &lt;pre&gt;,
                    &lt;a href=""&gt;
                </p>
                <button type="button" id="btn-preview"
                    class="mt-2 px-4 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">visibility</span>
                    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </button>
            </div>

            <!-- –ú–µ–¥–∏–∞ –∏ –ö–Ω–æ–ø–∫–∏ –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- –ú–µ–¥–∏–∞ -->
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–ú–µ–¥–∏–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <div class="flex gap-2 items-start">
                        <button type="button" id="btn-upload-media"
                            class="px-4 py-2 rounded-lg bg-primary/20 text-primary hover:bg-primary/30 flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">upload</span>
                            –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/GIF
                        </button>
                        <input type="file" id="media-input" accept="image/*,video/*,.gif" class="hidden" />
                    </div>
                    <div id="media-preview" class="mt-4 hidden">
                        <div class="relative inline-block">
                            <img id="media-preview-img" src=""
                                class="max-w-xs max-h-64 rounded-lg border border-white/10 hidden" />
                            <video id="media-preview-video" controls
                                class="max-w-xs max-h-64 rounded-lg border border-white/10 hidden"></video>
                            <button type="button" id="btn-remove-media"
                                class="absolute top-2 right-2 px-2 py-1 rounded bg-red-500/80 text-white text-sm hover:bg-red-500">
                                <span class="material-symbols-outlined text-base">close</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–ö–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <p class="text-white/50 text-xs mb-2">URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://</p>
                    <div id="buttons-list" class="space-y-2 mb-2"></div>
                    <button type="button" id="btn-add-button"
                        class="px-4 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20 flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">add</span>
                        –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                    </button>
                </div>
            </div>

            <!-- –ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å - 2 –∫–æ–ª–æ–Ω–∫–∏ -->
            <div class="mb-6">
                <label class="block text-white/70 text-sm font-medium mb-3">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="mode" value="test"
                            class="w-4 h-4 text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">‚öôÔ∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="mode" value="with_keys"
                            class="w-4 h-4 text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">üîë –° –∞–∫—Ç–∏–≤–Ω—ã–º –∫–ª—é—á–æ–º</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="mode" value="expired_keys"
                            class="w-4 h-4 text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">‚è∞ –° –∏—Å—Ç—ë–∫—à–∏–º –∫–ª—é—á–æ–º</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="mode" value="without_trial"
                            class="w-4 h-4 text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">üéÅ –ë–µ–∑ –ø—Ä–æ–±–Ω–æ–≥–æ</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer md:col-span-2">
                        <input type="radio" name="mode" value="all" checked
                            class="w-4 h-4 text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">üë• –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º</span>
                    </label>
                </div>
            </div>

            <button type="submit" id="btn-send"
                class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-base">send</span>
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
            </button>
        </form>
    </div>
</section>

<section id="tab-promo" class="tab-content hidden">
    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
    <div class="bg-white/5 border border-white/10 rounded-lg p-6 mb-6">
        <h3 class="text-xl font-bold text-white mb-4">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>

        <form id="promo-create-form">
            <!-- –°–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∫–æ–¥ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–°–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="code_mode" value="auto" checked
                                class="w-4 h-4 text-primary focus:ring-primary/50" />
                            <span class="text-white/70 text-sm">üé≤ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="code_mode" value="manual"
                                class="w-4 h-4 text-primary focus:ring-primary/50" />
                            <span class="text-white/70 text-sm">‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</span>
                        </label>
                    </div>
                </div>

                <div id="manual-code-field" class="hidden">
                    <label class="block text-white/70 text-sm font-medium mb-2">–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞</label>
                    <input type="text" name="code"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50 uppercase"
                        placeholder="PROMO2025" />
                    <p class="text-white/50 text-xs mt-1">–ë—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä</p>
                </div>
            </div>

            <!-- –¢–∏–ø –∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–¢–∏–ø —Å–∫–∏–¥–∫–∏ *</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="discount_type" value="percent" checked
                                class="w-4 h-4 text-primary focus:ring-primary/50" />
                            <span class="text-white/70 text-sm">% –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="discount_type" value="fixed"
                                class="w-4 h-4 text-primary focus:ring-primary/50" />
                            <span class="text-white/70 text-sm">‚ÇΩ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–ó–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ *</label>
                    <input type="number" name="discount_value" step="0.01" min="0" required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        placeholder="10" />
                </div>
            </div>

            <!-- –õ–∏–º–∏—Ç—ã –∏ –¥–∞—Ç—ã - 4 –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–û–±—â–∏–π –ª–∏–º–∏—Ç</label>
                    <input type="number" name="usage_limit_total" min="1"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        placeholder="‚àû" />
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–õ–∏–º–∏—Ç/–ø–æ–ª—å–∑.</label>
                    <input type="number" name="usage_limit_per_user" min="1"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                        placeholder="‚àû" />
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–î–µ–π—Å—Ç–≤—É–µ—Ç —Å</label>
                    <input type="datetime-local" name="valid_from"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</label>
                    <input type="datetime-local" name="valid_until"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="mb-4">
                <label class="block text-white/70 text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea name="description" rows="2"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"
                    placeholder="–ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤..."></textarea>
            </div>

            <button type="submit"
                class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-base">add</span>
                –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
            </button>
        </form>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h3 class="text-xl font-bold text-white mb-4">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã</h3>

        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-white/5">
                    <tr>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ö–æ–¥</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–°–∫–∏–¥–∫–∞</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
                        </th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–õ–∏–º–∏—Ç—ã</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
                        </th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70">–°—Ç–∞—Ç—É—Å</th>
                        <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider text-white/70 text-right">
                            –î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="promo-table-body" class="divide-y divide-white/10">
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-white/50">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
<div id="editPromoModal" class="modal-overlay">
    <div class="modal-content">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <h5 class="text-white font-bold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h5>
            <button onclick="closeModal('editPromoModal')" class="text-white/50 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <form id="promo-edit-form">
                <input type="hidden" id="edit-promo-code" name="code" />

                <div class="mb-4">
                    <label class="block text-white/70 text-sm font-medium mb-2">–ö–æ–¥</label>
                    <input type="text" id="edit-code-display" readonly
                        class="w-full bg-white/10 border border-white/10 rounded-lg px-4 py-2.5 text-white/50 cursor-not-allowed" />
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–¢–∏–ø —Å–∫–∏–¥–∫–∏ *</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="edit_discount_type" value="percent"
                                    class="w-4 h-4 text-primary focus:ring-primary/50" />
                                <span class="text-white/70 text-sm">% –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="edit_discount_type" value="fixed"
                                    class="w-4 h-4 text-primary focus:ring-primary/50" />
                                <span class="text-white/70 text-sm">‚ÇΩ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–ó–Ω–∞—á–µ–Ω–∏–µ *</label>
                        <input type="number" name="edit_discount_value" step="0.01" min="0" required
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–û–±—â–∏–π –ª–∏–º–∏—Ç</label>
                        <input type="number" name="edit_usage_limit_total" min="1"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–õ–∏–º–∏—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="number" name="edit_usage_limit_per_user" min="1"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                        <input type="datetime-local" name="edit_valid_from"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input type="datetime-local" name="edit_valid_until"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-white/70 text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="edit_description" rows="2"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea>
                </div>

                <button type="submit"
                    class="w-full px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </form>
        </div>
    </div>
</div>

<section id="tab-remnawave" class="tab-content hidden">
    <div class="bg-white/5 border border-white/10 rounded-lg p-6">
        <h3 class="text-xl font-bold text-white mb-4">Remnawave</h3>
        <p class="text-white/70 text-sm mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏ Remnawave</p>
        <div class="bg-white/[0.02] border border-white/10 rounded-lg p-8 text-center">
            <span class="material-symbols-outlined text-4xl text-white/30 mb-2">settings_applications</span>
            <p class="text-white/50">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Remnawave –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ</p>
        </div>
    </div>
</section>

<section id="tab-servers" class="tab-content hidden">
    <!-- –°–µ—Ç–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ –∏ SSH-—Ü–µ–ª—è–º–∏ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- –°–µ—Ä–≤–µ—Ä—ã Remnawave -->
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-white font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-400">dns</span>
                    –°–µ—Ä–≤–µ—Ä—ã (Remna_hosts)
                </h3>
                <span class="px-2 py-1 rounded-full bg-primary/20 text-primary text-xs font-medium"
                    id="remna-hosts-count">0</span>
            </div>
            <div id="remna-hosts-list" class="space-y-3">
                <div class="text-center py-8 text-white/40">
                    <span class="material-symbols-outlined text-4xl mb-2">dns</span>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>

        <!-- SSH-—Ü–µ–ª–∏ -->
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-white font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined text-yellow-400">terminal</span>
                    SSH-—Ü–µ–ª–∏
                </h3>
                <span class="px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400 text-xs font-medium"
                    id="ssh-targets-count">0</span>
            </div>
            <div id="ssh-targets-list" class="space-y-3">
                <div class="text-center py-8 text-white/40">
                    <span class="material-symbols-outlined text-4xl mb-2">terminal</span>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ -->
    <div class="mt-6 bg-gradient-to-r from-primary/10 to-blue-500/10 border border-primary/30 rounded-lg p-6">
        <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center flex-shrink-0">
                <span class="material-symbols-outlined text-2xl text-primary">construction</span>
            </div>
            <div class="flex-1">
                <h4 class="text-white font-bold text-lg mb-2 flex items-center gap-2">
                    üöß –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
                    <span class="px-2 py-0.5 rounded-full bg-primary/20 text-primary text-xs font-medium">–°–∫–æ—Ä–æ</span>
                </h4>
                <p class="text-white/70 text-sm mb-4">
                    –î–ª—è –∫–∞–∂–¥–æ–π SSH-—Ü–µ–ª–∏, –ù–æ–¥—ã Remnawave —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="flex items-center gap-2 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-base text-green-400">rocket_launch</span>
                        –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ù–æ–¥—ã
                    </div>
                    <div class="flex items-center gap-2 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-base text-blue-400">package_2</span>
                        –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
                    </div>
                    <div class="flex items-center gap-2 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-base text-purple-400">edit_document</span>
                        –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ docker-compose.yml
                    </div>
                    <div class="flex items-center gap-2 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-base text-yellow-400">description</span>
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞–º–∏ –ù–æ–¥—ã –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Xray
                    </div>
                    <div class="flex items-center gap-2 text-white/80 text-sm col-span-1 md:col-span-2">
                        <span class="material-symbols-outlined text-base text-orange-400">public</span>
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ geosite –∏ geoip Xray
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');

        function switchTab(tabId) {
            tabs.forEach(btn => {
                const isActive = btn.getAttribute('data-tab') === tabId;
                btn.classList.toggle('bg-primary', isActive);
                btn.classList.toggle('text-background-dark', isActive);
                btn.classList.toggle('text-white/70', !isActive);
                btn.classList.toggle('hover:bg-white/5', !isActive);
            });
            contents.forEach(content => {
                const isActive = content.id === 'tab-' + tabId;
                content.classList.toggle('hidden', !isActive);
            });
            history.replaceState(null, '', '#' + tabId);
        }

        tabs.forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
        });

        const hash = location.hash.slice(1) || 'broadcast';
        switchTab(hash);

        let uploadedMediaFilename = null;
        let buttons = [];

        async function loadStats() {
            try {
                const resp = await fetch('/other/broadcast/stats');
                const data = await resp.json();
                if (data.ok) {
                    document.getElementById('stat-total').textContent = data.total_users;
                    document.getElementById('stat-with-keys').textContent = data.users_with_keys;
                    document.getElementById('stat-expired-keys').textContent = data.users_with_expired_keys || 0;
                    document.getElementById('stat-no-trial').textContent = data.users_without_trial;

                    if (data.last_results) {
                        document.getElementById('result-sent').textContent = data.last_results.sent || 0;
                        document.getElementById('result-failed').textContent = data.last_results.failed || 0;
                        document.getElementById('result-skipped').textContent = data.last_results.skipped || 0;
                        if (data.last_results.timestamp) {
                            const date = new Date(data.last_results.timestamp);
                            document.getElementById('result-time').textContent = `–ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–∞—Å—Å—ã–ª–∫–∞: ${date.toLocaleString('ru-RU')} `;
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        loadStats();

        document.getElementById('btn-upload-media').addEventListener('click', () => {
            document.getElementById('media-input').click();
        });

        document.getElementById('media-input').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('csrf_token', window.getCsrfToken());

            try {
                const loading = document.createElement('p');
                loading.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                loading.className = 'text-white/50 text-sm mt-2';
                e.target.parentElement.appendChild(loading);

                const resp = await fetch('/other/broadcast/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                loading.remove();

                if (data.ok) {
                    uploadedMediaFilename = data.filename;
                    const preview = document.getElementById('media-preview');
                    const img = document.getElementById('media-preview-img');
                    const video = document.getElementById('media-preview-video');

                    preview.classList.remove('hidden');

                    if (data.media_type === 'photo' || data.media_type === 'animation') {
                        img.src = URL.createObjectURL(file);
                        img.classList.remove('hidden');
                        video.classList.add('hidden');
                    } else if (data.media_type === 'video') {
                        video.src = URL.createObjectURL(file);
                        video.classList.remove('hidden');
                        img.classList.add('hidden');
                    }

                    window.showToast('success', '–ú–µ–¥–∏–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞');
            }
        });

        document.getElementById('btn-remove-media').addEventListener('click', async () => {
            if (uploadedMediaFilename) {
                try {
                    await fetch(`/other/broadcast/delete-media/${uploadedMediaFilename}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': window.getCsrfToken()
                        }
                    });
                } catch (e) {
                    console.error('Failed to delete media:', e);
                }
                uploadedMediaFilename = null;
            }
            document.getElementById('media-preview').classList.add('hidden');
            document.getElementById('media-input').value = '';
        });

        function renderButtons() {
            const list = document.getElementById('buttons-list');
            list.innerHTML = '';
            buttons.forEach((btn, idx) => {
                const item = document.createElement('div');
                item.className = 'flex gap-2';
                item.innerHTML = `
                    <input type="text" value="${btn.text}" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" class="flex-1 bg-white/5 border border-white/10 rounded px-3 py-2 text-white text-sm" data-idx="${idx}" data-field="text" />
                    <input type="url" value="${btn.url}" placeholder="https://..." class="flex-1 bg-white/5 border border-white/10 rounded px-3 py-2 text-white text-sm" data-idx="${idx}" data-field="url" />
                    <button type="button" class="px-3 py-2 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30" data-remove="${idx}">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                `;
                list.appendChild(item);
            });

            list.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    const field = e.target.dataset.field;
                    buttons[idx][field] = e.target.value;
                });
            });

            list.querySelectorAll('[data-remove]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.closest('[data-remove]').dataset.remove);
                    buttons.splice(idx, 1);
                    renderButtons();
                });
            });
        }

        document.getElementById('btn-add-button').addEventListener('click', () => {
            if (buttons.length >= 6) {
                window.showToast('warning', '–ú–∞–∫—Å–∏–º—É–º 6 –∫–Ω–æ–ø–æ–∫');
                return;
            }
            buttons.push({ text: '', url: '' });
            renderButtons();
        });

        document.getElementById('btn-preview').addEventListener('click', async () => {
            const text = document.getElementById('broadcast-text').value.trim();
            if (!text) {
                window.showToast('warning', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('text', text);
            formData.append('buttons', JSON.stringify(buttons));

            try {
                const resp = await fetch('/other/broadcast/preview', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    window.showToast('success', '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ –±–æ—Ç');
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
            }
        });

        document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const text = document.getElementById('broadcast-text').value.trim();
            if (!text) {
                window.showToast('warning', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            const mode = document.querySelector('input[name="mode"]:checked').value;

            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) {
                return;
            }

            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('text', text);
            formData.append('mode', mode);
            formData.append('buttons', JSON.stringify(buttons));
            if (uploadedMediaFilename) {
                formData.append('media_filename', uploadedMediaFilename);
            }

            const btn = document.getElementById('btn-send');
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> –û—Ç–ø—Ä–∞–≤–∫–∞...`;

            try {
                const resp = await fetch('/other/broadcast/send', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';

                if (data.ok) {
                    window.showToast('success', `–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.results.sent}, –û—à–∏–±–æ–∫: ${data.results.failed}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${data.results.skipped}`);
                    loadStats();
                    document.getElementById('broadcast-text').value = '';
                    buttons = [];
                    renderButtons();
                    if (uploadedMediaFilename) {
                        document.getElementById('media-preview').classList.add('hidden');
                        uploadedMediaFilename = null;
                    }
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
                }
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-base">send</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
                window.showToast('danger', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
            }
        });

        // ==================== –ü—Ä–æ–º–æ–∫–æ–¥—ã ====================

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∞–≤—Ç–æ/—Ä—É—á–Ω—ã–º –≤–≤–æ–¥–æ–º –∫–æ–¥–∞
        document.querySelectorAll('input[name="code_mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const manualField = document.getElementById('manual-code-field');
                if (e.target.value === 'manual') {
                    manualField.classList.remove('hidden');
                } else {
                    manualField.classList.add('hidden');
                }
            });
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
        async function loadPromos() {
            try {
                const resp = await fetch('/other/promo/list');
                const data = await resp.json();

                if (data.ok && data.promos) {
                    renderPromos(data.promos);
                }
            } catch (e) {
                console.error('Failed to load promos:', e);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
        function renderPromos(promos) {
            const tbody = document.getElementById('promo-table-body');

            if (promos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-white/50">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</td></tr>';
                return;
            }

            tbody.innerHTML = promos.map(promo => {
                const discount = promo.discount_percent
                    ? `${promo.discount_percent}%`
                    : `${promo.discount_amount} ‚ÇΩ`;

                const used = promo.used_total || 0;
                const totalLimit = promo.usage_limit_total || '‚àû';
                const perUserLimit = promo.usage_limit_per_user || '‚àû';

                const validFrom = promo.valid_from ? new Date(promo.valid_from).toLocaleDateString('ru-RU') : '‚Äî';
                const validUntil = promo.valid_until ? new Date(promo.valid_until).toLocaleDateString('ru-RU') : '‚Äî';

                const isActive = promo.is_active;
                const statusColor = isActive ? 'text-green-400' : 'text-red-400';
                const statusText = isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                const toggleIcon = isActive ? 'toggle_on' : 'toggle_off';

                return `
                    <tr class="hover:bg-white/5">
                        <td class="px-4 py-3 text-white font-mono font-bold">${promo.code}</td>
                        <td class="px-4 py-3 text-white">${discount}</td>
                        <td class="px-4 py-3 text-white">${used} / ${totalLimit}</td>
                        <td class="px-4 py-3 text-white">${perUserLimit}</td>
                        <td class="px-4 py-3 text-white/70 text-sm">${validFrom} ‚Äî ${validUntil}</td>
                        <td class="px-4 py-3 ${statusColor}">${statusText}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="togglePromo('${promo.code}')" class="p-2 rounded hover:bg-white/10" title="–í–∫–ª/–í—ã–∫–ª">
                                    <span class="material-symbols-outlined ${statusColor}">${toggleIcon}</span>
                                </button>
                                <button onclick="editPromo('${promo.code}')" class="p-2 rounded hover:bg-white/10 text-primary" title="–ò–∑–º–µ–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏—è">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button onclick="deletePromo('${promo.code}')" class="p-2 rounded hover:bg-white/10 text-red-400" title="–£–¥–∞–ª–∏—Ç—å">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        document.getElementById('promo-create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            formData.append('csrf_token', window.getCsrfToken());

            // –ï—Å–ª–∏ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º, —É–¥–∞–ª—è–µ–º –∫–æ–¥ –∏–∑ formData
            const codeMode = formData.get('code_mode');
            if (codeMode === 'auto') {
                formData.delete('code');
            }
            formData.delete('code_mode');

            try {
                const resp = await fetch('/other/promo/create', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `–ü—Ä–æ–º–æ–∫–æ–¥ ${data.code} —Å–æ–∑–¥–∞–Ω!`);
                    e.target.reset();
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        });

        // Toggle –ø—Ä–æ–º–æ–∫–æ–¥–∞
        window.togglePromo = async function (code) {
            try {
                const resp = await fetch(`/other/promo/toggle/${code}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `–ü—Ä–æ–º–æ–∫–æ–¥ ${data.is_active ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}`);
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        };

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        window.editPromo = async function (code) {
            try {
                const resp = await fetch('/other/promo/list');
                const data = await resp.json();

                if (data.ok) {
                    const promo = data.promos.find(p => p.code === code);
                    if (!promo) return;

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('edit-promo-code').value = promo.code;
                    document.getElementById('edit-code-display').value = promo.code;

                    const discountType = promo.discount_percent ? 'percent' : 'fixed';
                    document.querySelector(`input[name="edit_discount_type"][value="${discountType}"]`).checked = true;
                    document.querySelector('input[name="edit_discount_value"]').value = promo.discount_percent || promo.discount_amount;

                    document.querySelector('input[name="edit_usage_limit_total"]').value = promo.usage_limit_total || '';
                    document.querySelector('input[name="edit_usage_limit_per_user"]').value = promo.usage_limit_per_user || '';

                    if (promo.valid_from) {
                        const dt = new Date(promo.valid_from);
                        document.querySelector('input[name="edit_valid_from"]').value = dt.toISOString().slice(0, 16);
                    }
                    if (promo.valid_until) {
                        const dt = new Date(promo.valid_until);
                        document.querySelector('input[name="edit_valid_until"]').value = dt.toISOString().slice(0, 16);
                    }

                    document.querySelector('textarea[name="edit_description"]').value = promo.description || '';

                    openModal('editPromoModal');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        document.getElementById('promo-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const code = document.getElementById('edit-promo-code').value;
            const formData = new FormData();
            formData.append('csrf_token', window.getCsrfToken());
            formData.append('discount_type', document.querySelector('input[name="edit_discount_type"]:checked').value);
            formData.append('discount_value', document.querySelector('input[name="edit_discount_value"]').value);
            formData.append('usage_limit_total', document.querySelector('input[name="edit_usage_limit_total"]').value);
            formData.append('usage_limit_per_user', document.querySelector('input[name="edit_usage_limit_per_user"]').value);
            formData.append('valid_from', document.querySelector('input[name="edit_valid_from"]').value);
            formData.append('valid_until', document.querySelector('input[name="edit_valid_until"]').value);
            formData.append('description', document.querySelector('textarea[name="edit_description"]').value);

            try {
                const resp = await fetch(`/other/promo/update/${code}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', '–ü—Ä–æ–º–æ–∫–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω');
                    closeModal('editPromoModal');
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }
            } catch (err) {
                console.error(err);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        window.deletePromo = async function (code) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ${code}?`)) return;

            try {
                const resp = await fetch(`/other/promo/delete/${code}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', '–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω');
                    loadPromos();
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        const promoTab = document.querySelector('[data-tab="promo"]');
        if (promoTab) {
            promoTab.addEventListener('click', () => {
                loadPromos();
            });
        }

        // ==================== –°–µ—Ä–≤–µ—Ä–∞ ====================

        let serversAutoRefresh = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
        async function loadServers() {
            try {
                const resp = await fetch('/other/servers/list');
                const data = await resp.json();

                if (data.ok) {
                    renderHosts(data.hosts || []);
                    renderSshTargets(data.ssh_targets || []);
                }
            } catch (e) {
                console.error('Failed to load servers:', e);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ Remnawave
        function renderHosts(hosts) {
            const listEl = document.getElementById('remna-hosts-list');
            const countEl = document.getElementById('remna-hosts-count');

            countEl.textContent = hosts.length;

            if (hosts.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-8 text-white/40">
                        <span class="material-symbols-outlined text-4xl mb-2">dns</span>
                        <p>–•–æ—Å—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = hosts.map((host, idx) => `
                <div class="bg-white/5 rounded-lg p-3 border border-white/10" data-host="${host.host_name}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-white/30" id="host-status-${idx}"></div>
                            <div>
                                <div class="text-white font-medium text-sm">${host.host_name}</div>
                                <div class="text-white/40 text-xs">${host.host_url || 'URL –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="refreshHostUptime('${host.host_name}', ${idx})" class="p-2 rounded bg-white/10 hover:bg-white/20 text-white/70" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
                                <span class="material-symbols-outlined text-sm">refresh</span>
                            </button>
                            <button onclick="rebootServer('host', '${host.host_name}')" class="p-2 rounded bg-red-500/20 hover:bg-red-500/30 text-red-400" title="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä">
                                <span class="material-symbols-outlined text-sm">restart_alt</span>
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-white/60" id="host-uptime-${idx}">
                        <div class="flex items-center gap-2 text-white/40">
                            <span class="material-symbols-outlined text-sm animate-spin">progress_activity</span>
                            –ó–∞–≥—Ä—É–∑–∫–∞ uptime...
                        </div>
                    </div>
                </div>
            `).join('');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º uptime –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ—Å—Ç–∞
            hosts.forEach((host, idx) => {
                loadUptime('host', host.host_name, idx);
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ SSH-—Ü–µ–ª–µ–π
        function renderSshTargets(targets) {
            const listEl = document.getElementById('ssh-targets-list');
            const countEl = document.getElementById('ssh-targets-count');

            countEl.textContent = targets.length;

            if (targets.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-8 text-white/40">
                        <span class="material-symbols-outlined text-4xl mb-2">terminal</span>
                        <p>SSH-—Ü–µ–ª–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = targets.map((target, idx) => `
                <div class="bg-white/5 rounded-lg p-3 border border-white/10" data-target="${target.target_name}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-white/30" id="target-status-${idx}"></div>
                            <div>
                                <div class="text-white font-medium text-sm">${target.target_name}</div>
                                <div class="text-white/40 text-xs">${target.ssh_host}:${target.ssh_port || 22}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="refreshTargetUptime('${target.target_name}', ${idx})" class="p-2 rounded bg-white/10 hover:bg-white/20 text-white/70" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
                                <span class="material-symbols-outlined text-sm">refresh</span>
                            </button>
                            <button onclick="rebootServer('ssh', '${target.target_name}')" class="p-2 rounded bg-red-500/20 hover:bg-red-500/30 text-red-400" title="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä">
                                <span class="material-symbols-outlined text-sm">restart_alt</span>
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-white/60" id="target-uptime-${idx}">
                        <div class="flex items-center gap-2 text-white/40">
                            <span class="material-symbols-outlined text-sm animate-spin">progress_activity</span>
                            –ó–∞–≥—Ä—É–∑–∫–∞ uptime...
                        </div>
                    </div>
                </div>
            `).join('');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º uptime –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏
            targets.forEach((target, idx) => {
                loadUptime('ssh', target.target_name, idx);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ uptime –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
        async function loadUptime(type, name, idx) {
            const uptimeEl = type === 'host' ? document.getElementById(`host-uptime-${idx}`) : document.getElementById(`target-uptime-${idx}`);
            const statusEl = type === 'host' ? document.getElementById(`host-status-${idx}`) : document.getElementById(`target-status-${idx}`);

            try {
                const resp = await fetch(`/other/servers/uptime/${type}/${encodeURIComponent(name)}`);
                const data = await resp.json();

                if (data.ok) {
                    if (uptimeEl) {
                        uptimeEl.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm text-blue-400">schedule</span>
                                <span class="text-white">Uptime: ${data.uptime_formatted}</span>
                            </div>
                        `;
                    }
                    if (statusEl) {
                        statusEl.className = 'w-2 h-2 rounded-full bg-green-500';
                    }
                } else {
                    if (uptimeEl) {
                        uptimeEl.innerHTML = `<div class="text-red-400 text-xs">–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}</div>`;
                    }
                    if (statusEl) {
                        statusEl.className = 'w-2 h-2 rounded-full bg-red-500';
                    }
                }
            } catch (e) {
                console.error('Failed to load uptime:', e);
                if (uptimeEl) {
                    uptimeEl.innerHTML = '<div class="text-red-400 text-xs">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
                if (statusEl) {
                    statusEl.className = 'w-2 h-2 rounded-full bg-red-500';
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ uptime –¥–ª—è —Ö–æ—Å—Ç–∞
        window.refreshHostUptime = function (name, idx) {
            loadUptime('host', name, idx);
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ uptime –¥–ª—è SSH-—Ü–µ–ª–∏
        window.refreshTargetUptime = function (name, idx) {
            loadUptime('ssh', name, idx);
        };

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
        window.rebootServer = async function (type, name) {
            const typeName = type === 'host' ? '—Å–µ—Ä–≤–µ—Ä' : 'SSH-—Ü–µ–ª—å';

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ${typeName} "${name}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–∏—Å—Ç–µ–º—ã.`)) {
                return;
            }

            try {
                const resp = await fetch(`/other/servers/reboot/${type}/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': window.getCsrfToken()
                    }
                });
                const data = await resp.json();

                if (data.ok) {
                    window.showToast('success', `–ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ ${name}`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        loadServers();
                    }, 5000);
                } else {
                    window.showToast('danger', data.error || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (e) {
                console.error(e);
                window.showToast('danger', '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞');
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        const serversTab = document.querySelector('[data-tab="servers"]');
        if (serversTab) {
            serversTab.addEventListener('click', () => {
                loadServers();

                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
                if (serversAutoRefresh) {
                    clearInterval(serversAutoRefresh);
                }
                serversAutoRefresh = setInterval(() => {
                    loadServers();
                }, 60000);
            });
        }
    });
</script>
{% endblock %}