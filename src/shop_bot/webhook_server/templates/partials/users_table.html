{% for user in users %}
<tr class="hover:bg-white/[0.02] transition-colors border-b border-white/5 last:border-0 group">
    <td class="px-6 py-4 whitespace-nowrap user-id">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-white">{{ user.telegram_id }}</span>
            {% if user.is_pinned %}
            <span class="material-symbols-outlined text-[16px] text-primary"
                title="Закрепленный пользователь">push_pin</span>
            {% endif %}
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap user-name">
        <span class="text-sm text-white">@{{ user.username or 'N/A' }}</span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
        {% if user.is_banned %}
        <span
            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-500/20 text-red-400">
            Забанен
        </span>
        {% else %}
        <span
            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/20 text-primary">
            Активен
        </span>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
        <div class="flex items-center justify-center gap-1.5 flex-wrap">
            {% if (user.keys_count or 0) > 0 %}
            <span
                class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-500/20 text-green-400">
                {{ user.keys_count }} шт.
            </span>
            {% else %}
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-white/10 text-white/50">
                —
            </span>
            {% endif %}
            {% if (user.total_months or 0) > 0 %}
            <span
                class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-500/20 text-blue-400">
                {{ user.total_months }} мес.
            </span>
            {% endif %}
            {% if (user.referral_count or 0) > 0 %}
            <span
                class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-500/20 text-yellow-400">
                {{ user.referral_count }} реф.
            </span>
            {% endif %}
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">{{ '%.2f'|format(user.balance or 0) }} ₽</td>
    <td class="px-6 py-4 whitespace-nowrap text-right">
        <div class="flex items-center justify-end gap-1.5 flex-wrap">
            <!-- Give Key -->
            <a href="{{ url_for('admin_keys_page') }}?user_id={{ user.telegram_id }}"
                class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-primary/20 text-primary hover:bg-primary/30 transition-colors"
                title="Выдать ключ">
                <span class="material-symbols-outlined text-base">key</span>
            </a>
            <!-- Add Balance -->
            <button type="button"
                class="btn-user-balance-sign inline-flex items-center justify-center w-8 h-8 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 transition-colors"
                data-uid="{{ user.telegram_id }}" data-username="{{ user.username or 'N/A' }}"
                data-balance="{{ '%.2f'|format(user.balance or 0) }}" data-sign="+" title="Начислить баланс">
                <span class="material-symbols-outlined text-base">add</span>
            </button>
            <!-- Subtract Balance -->
            <button type="button"
                class="btn-user-balance-sign inline-flex items-center justify-center w-8 h-8 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors"
                data-uid="{{ user.telegram_id }}" data-username="{{ user.username or 'N/A' }}"
                data-balance="{{ '%.2f'|format(user.balance or 0) }}" data-sign="-" title="Списать баланс">
                <span class="material-symbols-outlined text-base">remove</span>
            </button>
            <!-- Send Message -->
            <button type="button"
                class="btn-user-message inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition-colors"
                data-uid="{{ user.telegram_id }}" data-username="{{ user.username or 'N/A' }}"
                title="Отправить сообщение">
                <span class="material-symbols-outlined text-base">mail</span>
            </button>
            <!-- Toggle Keys -->
            <button type="button" data-toggle="keys" data-user="{{ user.telegram_id }}"
                class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-white/10 text-white/70 hover:bg-white/20 transition-colors"
                title="Ключи">
                <span class="material-symbols-outlined text-base">vpn_key</span>
            </button>
            <!-- Ban/Unban -->
            {% if user.is_banned %}
            <form action="{{ url_for('unban_user_route', user_id=user.telegram_id) }}" method="post"
                class="inline ajax-form" data-refresh="users-tbody" data-success-msg="Пользователь разбанен">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 transition-colors"
                    title="Разбанить">
                    <span class="material-symbols-outlined text-base">check_circle</span>
                </button>
            </form>
            {% else %}
            <form action="{{ url_for('ban_user_route', user_id=user.telegram_id) }}" method="post"
                class="inline ajax-form" data-confirm="Вы уверены, что хотите забанить этого пользователя?"
                data-refresh="users-tbody" data-success-msg="Пользователь забанен">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 transition-colors"
                    title="Бан">
                    <span class="material-symbols-outlined text-base">block</span>
                </button>
            </form>
            {% endif %}
            <!-- Revoke Keys -->
            {% if (user.keys_count or 0) > 0 %}
            <form action="{{ url_for('revoke_keys_route', user_id=user.telegram_id) }}" method="post"
                class="inline ajax-form"
                data-confirm="ВНИМАНИЕ! Это действие удалит ВСЕ ключи пользователя. Вы уверены?"
                data-refresh="users-tbody" data-success-msg="Ключи отозваны">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors"
                    title="Отозвать ключи">
                    <span class="material-symbols-outlined text-base">delete</span>
                </button>
            </form>
            {% endif %}
            <!-- Pin/Unpin -->
            <form action="{{ url_for('toggle_pin_user_route', user_id=user.telegram_id) }}" method="post"
                class="inline ajax-form" data-refresh="users-tbody">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg {{ 'bg-primary/20 text-primary border border-primary/20 shadow-lg shadow-primary/10' if user.is_pinned else 'bg-white/5 text-white/30 border border-white/5' }} hover:bg-primary/30 transition-all group"
                    title="{{ 'Открепить' if user.is_pinned else 'Закрепить' }}">
                    <span
                        class="material-symbols-outlined text-base {{ 'rotate-45' if user.is_pinned else 'group-hover:rotate-45' }} transition-transform">push_pin</span>
                </button>
            </form>
            <!-- Details -->
            <button type="button"
                class="btn-user-details inline-flex items-center gap-1 px-3 h-8 rounded-lg bg-white/10 text-white/70 hover:bg-white/20 transition-colors text-sm"
                data-uid="{{ user.telegram_id }}" title="Подробнее">
                <span class="material-symbols-outlined text-base">info</span>
                <span class="hidden sm:inline">Подробнее</span>
            </button>
        </div>
    </td>
</tr>
<!-- Keys row -->
<tr class="keys-row hidden" id="keys-{{ user.telegram_id }}"
    data-src="{{ url_for('user_keys_partial', user_id=user.telegram_id) }}">
    <td colspan="6" class="p-0">
        <div class="m-4 bg-white/5 border border-white/10 rounded-lg">
            <div class="p-3 border-b border-white/10 text-white font-bold text-sm">Ключи пользователя</div>
            <div class="p-3" data-lazy="keys"></div>
        </div>
    </td>
</tr>
{% endfor %}