{% extends "base.html" %}
{% block title %}Настройки{% endblock %}

{% block content %}

<div class="mb-6">
    <h2 class="text-2xl font-bold text-white">Настройки</h2>
    <p class="text-white/50 text-sm">Панель, боты, платежи, хосты и контент</p>
</div>


{% if all_settings_ok and support_settings_ok %}
<div class="mb-6 p-4 rounded-lg bg-primary/10 border border-primary/20 text-primary">
    ✅ Веб-панель и оба бота настроены. Можно запускать.
</div>
{% else %}
<div class="mb-6 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20 text-yellow-400">
    ⚠️ Запуск ботов недоступен: заполните обязательные поля.
    <div class="text-sm text-yellow-400/70 mt-1">
        Основной бот: {{ 'ок' if all_settings_ok else 'не хватает настроек' }} • Support-бот: {{ 'ок' if
        support_settings_ok else 'не хватает настроек' }}
    </div>
</div>
{% endif %}


<div class="bg-white/5 border border-white/10 rounded-lg p-2 mb-6 overflow-x-auto">
    <nav class="flex gap-1 min-w-max" id="settings-nav">
        <button type="button" data-tab="panel"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-primary text-background-dark transition-colors">Панель</button>
        <button type="button" data-tab="bot"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Бот</button>
        <button type="button" data-tab="support-bot"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Support-бот</button>
        <button type="button" data-tab="payments"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Платежи</button>
        <button type="button" data-tab="hosts"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Хосты</button>
        <button type="button" data-tab="referrals"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Рефералы</button>
        <button type="button" data-tab="trial"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Триал</button>
        <button type="button" data-tab="content"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Контент</button>
        <button type="button" data-tab="monitoring"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors">Мониторинг</button>
        <a href="{{ url_for('button_constructor_page') }}"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:bg-white/5 transition-colors flex items-center gap-2 no-underline">
            <span class="material-symbols-outlined text-sm">construction</span>
            Конструктор кнопок
        </a>
    </nav>
</div>

<form action="{{ url_for('settings_page') }}" method="post" id="settings-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="next_hash" id="settings-next-hash" value="panel" />


    <section id="tab-panel" class="tab-content">
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <h3 class="text-xl font-bold text-white mb-6">Настройки Панели</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Логин для входа в панель</label>
                    <input type="text" name="panel_login" value="{{ settings.panel_login or '' }}" required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Новый пароль (оставьте пустым)</label>
                    <input type="password" name="panel_password"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Автобэкап базы (каждые N дней)</label>
                    <input type="number" name="backup_interval_days" value="{{ settings.backup_interval_days or '1' }}"
                        min="0"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    <p class="text-white/50 text-xs mt-1">0 — отключить автобэкап</p>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-white/10">
                <h4 class="text-white font-bold mb-4">Резервное копирование</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="text-white/70 text-sm mb-2">Скачать текущую БД</p>
                        <button type="submit" formaction="{{ url_for('backup_db_route') }}"
                            class="px-4 py-2 rounded-lg bg-primary/20 text-primary font-medium hover:bg-primary/30 flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">download</span> Скачать бэкап БД
                        </button>
                    </div>
                    <div>
                        <p class="text-white/70 text-sm mb-2">Восстановить из готового архива</p>
                        <div class="flex gap-2 mb-2">
                            <select name="existing_backup" id="existing_backup"
                                class="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white">
                                <option value="">— Выберите архив —</option>
                                {% for b in backups %}
                                <option value="{{ b.name }}" data-mtime="{{ b.mtime }}">{{ b.name }}</option>
                                {% endfor %}
                            </select>
                            <span id="backup-date"
                                class="px-3 py-2 rounded-lg bg-white/5 text-white/50 text-sm">—</span>
                        </div>
                        <p class="text-white/50 text-xs mb-3">Или загрузите свой файл (.zip или .db)</p>
                        <div class="flex gap-2">
                            <button type="button" id="btn-pick-file"
                                class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 flex items-center gap-2">
                                <span class="material-symbols-outlined text-base">upload_file</span> Выбрать файл
                            </button>
                            <span id="picked-file-name"
                                class="flex-1 px-3 py-2 rounded-lg bg-white/5 text-white/50 text-sm truncate">Файл не
                                выбран</span>
                        </div>
                        <input type="file" id="db_file" name="db_file" accept=".zip,.db" class="hidden" />
                        <button type="submit" formaction="{{ url_for('restore_db_route') }}"
                            formenctype="multipart/form-data"
                            class="mt-3 px-4 py-2 rounded-lg bg-red-500/20 text-red-400 font-medium hover:bg-red-500/30 flex items-center gap-2"
                            data-confirm="Текущая БД будет заменена. Продолжить?">
                            <span class="material-symbols-outlined text-base">settings_backup_restore</span>
                            Восстановить БД
                        </button>
                        <p class="text-white/50 text-xs mt-2">Перед восстановлением текущая база автоматически
                            сохраняется.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <section id="tab-bot" class="tab-content hidden">
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <h3 class="text-xl font-bold text-white mb-6">Настройка Бота</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-white/70 text-sm font-medium mb-2">Токен бота</label>
                    <input type="password" name="telegram_bot_token" value="{{ settings.telegram_bot_token or '' }}"
                        required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Username бота (без @)</label>
                    <input type="text" name="telegram_bot_username" value="{{ settings.telegram_bot_username or '' }}"
                        required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Telegram ID Администратора</label>
                    <input type="text" name="admin_telegram_id" value="{{ settings.admin_telegram_id or '' }}" required
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
            </div>
        </div>
    </section>


    <section id="tab-support-bot" class="tab-content hidden">
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <h3 class="text-xl font-bold text-white mb-6">Настройки Support-бота</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-white/70 text-sm font-medium mb-2">Токен support-бота</label>
                    <input type="password" name="support_bot_token" value="{{ settings.support_bot_token or '' }}"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Username support-бота (без @)</label>
                    <input type="text" name="support_bot_username" value="{{ settings.support_bot_username or '' }}"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">ID саппорт-чата (forum chat id)</label>
                    <input type="text" name="support_forum_chat_id" value="{{ settings.support_forum_chat_id or '' }}"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    <p class="text-white/50 text-xs mt-1">Укажите ID forum-чата, если нужен вывод тикетов в обсуждения
                    </p>
                </div>
            </div>
        </div>
    </section>


    <section id="tab-payments" class="tab-content hidden">
        <div class="space-y-6">

            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">YooKassa</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Почта для чеков</label>
                        <input type="email" name="receipt_email" value="{{ settings.receipt_email or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">YooKassa Shop ID</label>
                        <input type="text" name="yookassa_shop_id" value="{{ settings.yookassa_shop_id or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">YooKassa Secret Key</label>
                        <input type="password" name="yookassa_secret_key"
                            value="{{ settings.yookassa_secret_key or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>
                <div class="form-check mt-4">
                    <input type="hidden" name="sbp_enabled" value="false" />
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="sbp_enabled" value="true" id="sbp_enabled" {% if
                            settings.sbp_enabled=='true' %}checked{% endif %}
                            class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">Включить оплату через СБП</span>
                    </label>
                </div>
            </div>


            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">CryptoBot</h3>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">CryptoBot Token</label>
                    <input type="password" name="cryptobot_token" value="{{ settings.cryptobot_token or '' }}"
                        class="w-full md:w-1/2 bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
            </div>


            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">Heleket</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Heleket Merchant ID</label>
                        <input type="text" name="heleket_merchant_id" value="{{ settings.heleket_merchant_id or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Heleket API Key</label>
                        <input type="password" name="heleket_api_key" value="{{ settings.heleket_api_key or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Ваш домен (для вебхуков, например
                        my-shop.com)</label>
                    <input type="text" name="domain" value="{{ settings.domain or '' }}" placeholder="my-shop.com"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
            </div>


            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">TonConnect</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Ton Wallet Address</label>
                        <input type="text" name="ton_wallet_address" value="{{ settings.ton_wallet_address or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">TonAPI Key</label>
                        <input type="password" name="tonapi_key" value="{{ settings.tonapi_key or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>
            </div>


            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">Telegram Stars</h3>
                <div class="mb-4">
                    <input type="hidden" name="stars_enabled" value="false" />
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="stars_enabled" value="true" id="stars_enabled" {% if
                            settings.stars_enabled=='true' %}checked{% endif %}
                            class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">Включить оплату Telegram Stars</span>
                    </label>
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Коэффициент конвертации (⭐ за 1
                        RUB)</label>
                    <input type="number" step="0.01" name="stars_per_rub" value="{{ settings.stars_per_rub or '1' }}"
                        class="w-full md:w-64 bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    <p class="text-white/50 text-xs mt-1">Например, 1.0 означает 1 звезду за 1 RUB; 2.5 — 2.5 звезды за
                        1 RUB</p>
                </div>
            </div>


            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">YooMoney (кошелёк)</h3>
                <div class="mb-4">
                    <input type="hidden" name="yoomoney_enabled" value="false" />
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="yoomoney_enabled" value="true" id="yoomoney_enabled" {% if
                            settings.yoomoney_enabled=='true' %}checked{% endif %}
                            class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">Включить YooMoney</span>
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Номер кошелька</label>
                        <input type="text" name="yoomoney_wallet" value="{{ settings.yoomoney_wallet or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Секрет HTTP-уведомлений</label>
                        <input type="password" name="yoomoney_secret" value="{{ settings.yoomoney_secret or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        <p class="text-white/50 text-xs mt-1">URL уведомлений: <code
                                class="text-primary/80">{{ request.url_root.rstrip('/') }}/yoomoney-webhook</code></p>
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">API Token (OAuth
                            access_token)</label>
                        <input type="password" name="yoomoney_api_token" value="{{ settings.yoomoney_api_token or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        <p class="text-white/50 text-xs mt-1">Используется для проверки account-info / operation-history
                        </p>
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Client ID (для OAuth)</label>
                        <input type="text" name="yoomoney_client_id" value="{{ settings.yoomoney_client_id or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Client Secret (если
                            требуется)</label>
                        <input type="password" name="yoomoney_client_secret"
                            value="{{ settings.yoomoney_client_secret or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Redirect URI (для OAuth)</label>
                        <input type="url" name="yoomoney_redirect_uri"
                            value="{{ settings.yoomoney_redirect_uri or '' }}"
                            placeholder="https://example.com/yoomoney/callback"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/30 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        <p class="text-white/50 text-xs mt-1">Если не заполнено — используется: {{
                            request.url_root.rstrip('/') }}/yoomoney/callback</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <a href="{{ url_for('yoomoney_connect_route') }}"
                        class="px-4 py-2 rounded-lg bg-primary/20 text-primary text-sm font-medium hover:bg-primary/30">
                        Подключить YooMoney (OAuth)
                    </a>
                    <button type="submit" formmethod="post" formaction="{{ url_for('yoomoney_check_route') }}"
                        class="px-4 py-2 rounded-lg bg-white/10 text-white text-sm font-medium hover:bg-white/20">
                        Проверить токен YooMoney
                    </button>
                </div>
            </div>


            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">Platega</h3>
                <div class="mb-4">
                    <input type="hidden" name="platega_enabled" value="false" />
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="platega_enabled" value="true" id="platega_enabled" {% if
                            settings.platega_enabled=='true' %}checked{% endif %}
                            class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                        <span class="text-white/70 text-sm">Включить Platega</span>
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Merchant ID</label>
                        <input type="text" name="platega_merchant_id" value="{{ settings.platega_merchant_id or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">API Key (Secret)</label>
                        <input type="password" name="platega_api_key" value="{{ settings.platega_api_key or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>
                <p class="text-white/50 text-xs mt-3">Callback URL: <code
                        class="text-primary/80">{{ request.url_root.rstrip('/') }}/platega-webhook</code></p>
            </div>


            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">TonConnect</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">Ton Wallet Address</label>
                        <input type="text" name="ton_wallet_address" value="{{ settings.ton_wallet_address or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">TonAPI Key</label>
                        <input type="password" name="tonapi_key" value="{{ settings.tonapi_key or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>
            </div>


        </div>
    </section>

</form>


<section id="tab-hosts" class="tab-content hidden">
    <div class="space-y-6">

        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <div class="flex items-center cursor-pointer" onclick="toggleAddHostForm()">
                <div class="flex items-center gap-2">
                    <h3 class="text-xl font-bold text-white">Добавить новый хост</h3>
                    <span id="add-host-icon"
                        class="material-symbols-outlined text-white/50 transition-transform">expand_more</span>
                </div>
            </div>
            <div id="add-host-form" class="hidden">
                <form action="{{ url_for('add_host_route') }}" method="post" class="mt-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white/70 text-sm font-medium mb-2">Название хоста</label>
                            <input type="text" name="host_name" placeholder="server1" required
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm font-medium mb-2">Базовый URL Remnawave</label>
                            <input type="url" name="remnawave_base_url" placeholder="https://panel.example.com" required
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm font-medium mb-2">API Token</label>
                            <input type="password" name="remnawave_api_token" required
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm font-medium mb-2">Squad UUID</label>
                            <input type="text" name="squad_uuid" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50" />
                        </div>
                    </div>
                    <button type="submit"
                        class="mt-4 px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">
                        Добавить хост
                    </button>
                </form>
            </div>
        </div>


        {% if hosts %}
        {% for host in hosts %}
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <div class="flex items-center justify-between mb-4 cursor-pointer"
                onclick="toggleHostContent('{{ host.host_name }}')">
                <div class="flex items-center gap-2">
                    <h4 class="text-lg font-bold text-white">{{ host.host_name }}</h4>
                    <span id="host-icon-{{ host.host_name }}"
                        class="material-symbols-outlined text-white/50 transition-transform">expand_more</span>
                </div>
                <form action="{{ url_for('delete_host_route', host_name=host.host_name) }}" method="post" class="inline"
                    data-confirm="Удалить хост {{ host.host_name }} и все его тарифы?"
                    onclick="event.stopPropagation();">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit"
                        class="px-3 py-1 rounded bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30">Удалить</button>
                </form>
            </div>

            <div id="host-content-{{ host.host_name }}" class="hidden">


                <form action="{{ url_for('update_host_url_route') }}" method="post" class="mb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                    <div class="flex gap-2">
                        <input type="text" name="host_url" value="{{ host.host_url or '' }}"
                            placeholder="URL панели Remnawave"
                            class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm" />
                        <button type="submit"
                            class="px-3 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20">Сохранить
                            URL</button>
                    </div>
                </form>


                <form action="{{ url_for('rename_host_route') }}" method="post" class="mb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="old_host_name" value="{{ host.host_name }}" />
                    <div class="flex gap-2">
                        <input type="text" name="new_host_name" value="{{ host.host_name }}" placeholder="Имя хоста"
                            class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm" />
                        <button type="submit"
                            class="px-3 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20">Переименовать</button>
                    </div>
                </form>


                <form action="{{ url_for('update_host_subscription_route') }}" method="post" class="mb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                    <div class="flex gap-2">
                        <input type="text" name="host_subscription_url" value="{{ host.subscription_url or '' }}"
                            placeholder="Ссылка подписки для этого хоста"
                            class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm" />
                        <button type="submit"
                            class="px-3 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20">Сохранить
                            ссылку</button>
                    </div>
                </form>


                <div class="bg-white/[0.02] border border-white/10 rounded-lg p-4 mb-4">
                    <h5 class="text-white font-medium mb-3">SSH для Speedtest</h5>
                    <form action="{{ url_for('update_host_ssh_route') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                            <div>
                                <label class="block text-white/50 text-xs mb-1">SSH Host</label>
                                <input type="text" name="ssh_host" value="{{ host.ssh_host or '' }}"
                                    placeholder="example.com"
                                    class="w-full bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm" />
                            </div>
                            <div>
                                <label class="block text-white/50 text-xs mb-1">Port</label>
                                <input type="number" name="ssh_port" value="{{ host.ssh_port or '' }}" placeholder="22"
                                    class="w-full bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm" />
                            </div>
                            <div>
                                <label class="block text-white/50 text-xs mb-1">User</label>
                                <input type="text" name="ssh_user" value="{{ host.ssh_user or '' }}" placeholder="root"
                                    class="w-full bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm" />
                            </div>
                            <div>
                                <label class="block text-white/50 text-xs mb-1">Пароль</label>
                                <input type="password" name="ssh_password" value="{{ host.ssh_password or '' }}"
                                    class="w-full bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm" />
                            </div>
                        </div>
                        <div class="flex gap-3 items-end">
                            <div class="flex-1">
                                <label class="block text-white/50 text-xs mb-1">Путь к приватному ключу</label>
                                <input type="text" name="ssh_key_path" value="{{ host.ssh_key_path or '' }}"
                                    placeholder="/app/keys/id_rsa"
                                    class="w-full bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm" />
                            </div>
                            <button type="submit"
                                class="px-3 py-1.5 rounded bg-primary/20 text-primary text-sm hover:bg-primary/30">Сохранить
                                SSH</button>
                        </div>
                    </form>
                    <form action="{{ url_for('auto_install_speedtest_route', host_name=host.host_name) }}" method="post"
                        class="mt-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit"
                            class="speedtest-loading-btn px-3 py-1.5 rounded bg-white/10 text-white text-sm hover:bg-white/20"
                            data-label="Автоустановка Speedtest">Автоустановка Speedtest</button>
                    </form>
                </div>


                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    <!-- HWID Device Limit -->
                    <div class="bg-white/[0.02] border border-white/10 rounded-lg p-4">
                        <h5 class="text-white font-medium mb-3">Лимит устройств (HWID Device Limit)</h5>
                        <form action="{{ url_for('update_host_hwid_limit_route') }}" method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="host_name" value="{{ host.host_name }}" />

                            <div class="mb-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="hidden" name="hwid_enabled" value="0" />
                                    <input type="checkbox" name="hwid_enabled" value="1"
                                        id="hwid-enabled-{{ host.host_name }}" {% if host.remnawave_hwid_enabled
                                        %}checked{% endif %}
                                        class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                                    <span class="text-white/70 text-sm">Включить ограничение устройств</span>
                                </label>
                                <p class="text-white/50 text-xs mt-1 ml-6">Если выключено, параметр hwidDeviceLimit не
                                    будет
                                    отправляться в API</p>
                            </div>

                            <div class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <label class="block text-white/50 text-xs mb-1">Лимит устройств</label>
                                    <input type="number" name="hwid_limit" value="{{ host.remnawave_limit_hwid or 0 }}"
                                        min="0" placeholder="0"
                                        class="w-full bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm" />
                                    <p class="text-white/50 text-xs mt-1">Максимальное количество устройств для одного
                                        пользователя (0 = без ограничений)</p>
                                </div>
                                <button type="submit"
                                    class="px-3 py-1.5 rounded bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                    style="margin-bottom: 22px;">Сохранить</button>
                            </div>
                        </form>
                    </div>

                    <!-- Traffic Limit -->
                    <div class="bg-white/[0.02] border border-white/10 rounded-lg p-4">
                        <h5 class="text-white font-medium mb-3">Лимит трафика (Traffic Limit)</h5>
                        <form action="{{ url_for('update_host_traffic_limit_route') }}" method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="host_name" value="{{ host.host_name }}" />

                            <!-- Placeholder for alignment -->
                            <div class="mb-3" style="height: 40px;"></div>

                            <div class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <label class="block text-white/50 text-xs mb-1">Лимит трафика (GB)</label>
                                    <input type="number" name="traffic_limit"
                                        value="{{ host.remnawave_limit_traffic or 0 }}" min="0" placeholder="0" step="1"
                                        class="w-full bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm" />
                                    <p class="text-white/50 text-xs mt-1">Лимит трафика в гигабайтах (0 = без
                                        ограничений)
                                    </p>
                                </div>
                                <button type="submit"
                                    class="px-3 py-1.5 rounded bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                    style="margin-bottom: 22px;">Сохранить</button>
                            </div>
                        </form>
                    </div>
                </div>


                <div class="bg-white/[0.02] border border-white/10 rounded-lg p-4">
                    <h5 class="text-white font-medium mb-3">Тарифы</h5>
                    {% if host.plans %}
                    <div class="grid gap-3 mb-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        {% for plan in host.plans %}
                        <div
                            class="relative bg-white/5 border border-white/10 rounded-lg p-3 hover:border-primary/30 transition-colors group">
                            <div class="flex flex-col gap-2">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h6 class="text-white font-bold text-sm">{{ plan.plan_name }}</h6>
                                        <p class="text-white/50 text-xs">{{ plan.months }} мес.</p>
                                    </div>
                                    <span class="text-primary font-bold text-sm">{{ plan.price|round(0) }}₽</span>
                                </div>

                                <div class="flex gap-1">
                                    <button type="button"
                                        class="plan-edit-btn flex-1 px-2 py-1 rounded bg-white/10 text-white/70 text-xs hover:bg-white/20 hover:text-white transition-colors flex items-center justify-center gap-1"
                                        data-plan-id="{{ plan.plan_id }}">
                                        <span class="material-symbols-outlined text-sm">edit</span>
                                        Изменить
                                    </button>
                                    <form action="{{ url_for('delete_plan_route', plan_id=plan.plan_id) }}"
                                        method="post" class="flex-1"
                                        data-confirm="Удалить тариф '{{ plan.plan_name }}'?">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                        <button type="submit"
                                            class="w-full px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs hover:bg-red-500/30 transition-colors flex items-center justify-center gap-1">
                                            <span class="material-symbols-outlined text-sm">delete</span>
                                            Удалить
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Edit Form -->
                            <div id="edit-plan-{{ plan.plan_id }}" class="hidden mt-3 pt-3 border-t border-white/10">
                                <form action="{{ url_for('update_plan_route', plan_id=plan.plan_id) }}" method="post"
                                    class="space-y-2">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <input type="text" name="plan_name" value="{{ plan.plan_name }}"
                                        placeholder="Название" required
                                        class="w-full bg-black/20 border border-white/10 rounded px-2 py-1.5 text-white text-xs" />
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" name="months" value="{{ plan.months }}" placeholder="Мес."
                                            required
                                            class="bg-black/20 border border-white/10 rounded px-2 py-1.5 text-white text-xs" />
                                        <input type="number" step="0.01" name="price" value="{{ plan.price }}"
                                            placeholder="Цена" required
                                            class="bg-black/20 border border-white/10 rounded px-2 py-1.5 text-white text-xs" />
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="submit"
                                            class="flex-1 px-2 py-1.5 rounded bg-primary/20 text-primary text-xs font-medium hover:bg-primary/30">Сохранить</button>
                                        <button type="button"
                                            class="plan-cancel-btn px-2 py-1.5 rounded bg-white/10 text-white/70 text-xs hover:bg-white/20"
                                            data-plan-id="{{ plan.plan_id }}">Отмена</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-white/50 text-sm mb-4">Тарифы не добавлены</p>
                    {% endif %}
                    <form action="{{ url_for('add_plan_route') }}" method="post" class="flex gap-2 flex-wrap">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                        <input type="text" name="plan_name" placeholder="Название" required
                            class="bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm w-32" />
                        <input type="number" name="months" placeholder="Мес." required
                            class="bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm w-20" />
                        <input type="number" step="0.01" name="price" placeholder="Цена" required
                            class="bg-white/5 border border-white/10 rounded px-2 py-1.5 text-white text-sm w-24" />
                        <button type="submit"
                            class="px-3 py-1.5 rounded bg-primary text-background-dark text-sm font-medium">+ Добавить
                            тариф</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="bg-white/5 border border-white/10 rounded-lg p-8 text-center">
            <span class="material-symbols-outlined text-4xl text-white/30 mb-2">dns</span>
            <p class="text-white/50">Хосты ещё не добавлены.</p>
        </div>
        {% endif %}


        <div class="border-t border-white/10 pt-6">
            <h3 class="text-xl font-bold text-white mb-4">SSH цели для Speedtest (не зависят от хостов)</h3>


            <div class="bg-white/5 border border-white/10 rounded-lg p-6 mb-4">
                <h4 class="text-white font-medium mb-4">Добавить SSH-цель</h4>
                <form action="{{ url_for('create_ssh_target_route') }}" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Название цели</label>
                            <input type="text" name="target_name" placeholder="Любое название" required
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">SSH Host</label>
                            <input type="text" name="ssh_host" placeholder="IP или домен" required
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Port</label>
                            <input type="number" name="ssh_port" value="22"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">User</label>
                            <input type="text" name="ssh_user" placeholder="root" value="root"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white" />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Password</label>
                            <input type="password" name="ssh_password"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Путь к приватному ключу</label>
                            <input type="text" name="ssh_key_path" placeholder="/app/keys/id_rsa"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Описание</label>
                            <input type="text" name="description" placeholder="Любое описание"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white" />
                        </div>
                    </div>
                    <button type="submit"
                        class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90">
                        Добавить SSH-цель
                    </button>
                </form>
            </div>


            {% if ssh_targets %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {% for t in ssh_targets %}
                <div
                    class="relative overflow-hidden bg-white/5 border border-white/10 rounded-xl p-4 hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5 transition-all duration-300 group">
                    <!-- Decorative glow -->
                    <div
                        class="absolute -top-12 -right-12 w-24 h-24 bg-primary/10 blur-[60px] rounded-full pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                    </div>

                    <div class="relative z-10">
                        <!-- Header -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-primary text-lg">dns</span>
                                    <h4 class="text-white font-bold text-sm truncate">{{ t.target_name }}</h4>
                                </div>
                                <p class="text-white/50 text-xs font-mono truncate">{{ t.ssh_host }}:{{ t.ssh_port
                                    or 22
                                    }}</p>
                            </div>
                        </div>

                        <!-- Description -->
                        {% if t.description %}
                        <p class="text-white/40 text-xs mb-3 line-clamp-2">{{ t.description }}</p>
                        {% endif %}

                        <!-- Actions -->
                        <div class="space-y-2">
                            <form action="{{ url_for('run_ssh_target_speedtest_route', target_name=t.target_name) }}"
                                method="post" class="w-full">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <button type="submit"
                                    class="speedtest-loading-btn w-full px-3 py-2 rounded-lg bg-blue-500/20 text-blue-400 text-sm font-medium hover:bg-blue-500/30 transition-colors flex items-center justify-center gap-2"
                                    data-label="Тест скорости">
                                    <span class="material-symbols-outlined text-base">speed</span>
                                    Тест скорости
                                </button>
                            </form>

                            <div class="grid grid-cols-2 gap-2">
                                <button type="button"
                                    class="ssh-edit-btn px-2 py-1.5 rounded-lg bg-white/10 text-white/70 text-xs hover:bg-white/20 hover:text-white transition-colors flex items-center justify-center gap-1"
                                    data-target="{{ t.target_name }}">
                                    <span class="material-symbols-outlined text-sm">edit</span>
                                    Изменить
                                </button>

                                <form action="{{ url_for('delete_ssh_target_route', target_name=t.target_name) }}"
                                    method="post" data-confirm="Удалить SSH-цель '{{ t.target_name }}'?">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <button type="submit"
                                        class="w-full px-2 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-xs hover:bg-red-500/30 transition-colors flex items-center justify-center gap-1">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                        Удалить
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Edit Form (Hidden by default) -->
                        <div id="edit-ssh-{{ t.target_name }}" class="hidden mt-3 pt-3 border-t border-white/10">
                            <form action="{{ url_for('update_ssh_target_route', target_name=t.target_name) }}"
                                method="post" class="space-y-2">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="text" name="new_target_name" value="{{ t.target_name }}"
                                    placeholder="Название цели" required
                                    class="w-full bg-black/20 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" />
                                <input type="text" name="ssh_host" value="{{ t.ssh_host or '' }}" placeholder="SSH Host"
                                    class="w-full bg-black/20 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" />
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" name="ssh_port" value="{{ t.ssh_port or '' }}"
                                        placeholder="Port"
                                        class="bg-black/20 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" />
                                    <input type="text" name="ssh_user" value="{{ t.ssh_user or '' }}" placeholder="User"
                                        class="bg-black/20 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" />
                                </div>
                                <input type="password" name="ssh_password" value="{{ t.ssh_password or '' }}"
                                    placeholder="Пароль"
                                    class="w-full bg-black/20 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" />
                                <input type="text" name="description" value="{{ t.description or '' }}"
                                    placeholder="Описание"
                                    class="w-full bg-black/20 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" />
                                <div class="flex gap-2">
                                    <button type="submit"
                                        class="flex-1 px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-xs font-medium hover:bg-primary/30">
                                        Сохранить
                                    </button>
                                    <button type="button"
                                        class="ssh-cancel-btn px-3 py-1.5 rounded-lg bg-white/10 text-white/70 text-xs hover:bg-white/20"
                                        data-target="{{ t.target_name }}">
                                        Отмена
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-3">
                            <form
                                action="{{ url_for('auto_install_speedtest_on_target_route', target_name=t.target_name) }}"
                                method="post">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <button type="submit"
                                    class="speedtest-loading-btn w-full px-3 py-2 rounded-lg bg-white/10 text-white/70 text-xs hover:bg-white/20 hover:text-white transition-colors flex items-center justify-center gap-1"
                                    data-label="Автоустановка">
                                    <span class="material-symbols-outlined text-sm">cloud_download</span>
                                    Автоустановка Speedtest
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-white/5 border border-white/10 rounded-lg p-8 text-center">
                <span class="material-symbols-outlined text-4xl text-white/30 mb-2">dns</span>
                <p class="text-white/50">SSH-цели не добавлены.</p>
            </div>
            {% endif %}
        </div>
    </div>
</section>


<form action="{{ url_for('settings_page') }}" method="post" id="settings-form-part2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="next_hash" id="settings-next-hash-part2" value="referrals" />


    <section id="tab-referrals" class="tab-content hidden">
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <h3 class="text-xl font-bold text-white mb-6">Реферальная система</h3>
            <label class="flex items-center gap-2 mb-6 cursor-pointer">
                <input type="hidden" name="enable_referrals" value="false" />
                <input type="checkbox" name="enable_referrals" value="true" {% if settings.enable_referrals=='true'
                    %}checked{% endif %}
                    class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                <span class="text-white font-medium">Включить реферальную систему</span>
            </label>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Тип начисления</label>
                    <select name="referral_reward_type" id="referral_reward_type"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white">
                        <option value="percent_purchase" {% if (settings.referral_reward_type or 'percent_purchase'
                            )=='percent_purchase' %}selected{% endif %}>Процент с покупки реферала</option>
                        <option value="fixed_purchase" {% if settings.referral_reward_type=='fixed_purchase'
                            %}selected{% endif %}>Фиксированная сумма за покупку</option>
                        <option value="fixed_start_referrer" {% if settings.referral_reward_type=='fixed_start_referrer'
                            %}selected{% endif %}>Бонус пригласившему при старте</option>
                    </select>
                    <p class="text-white/50 text-xs mt-1">Показываются только параметры, актуальные для выбранного типа.
                    </p>
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Минимальная сумма для вывода
                        (RUB)</label>
                    <input type="number" name="minimum_withdrawal" value="{{ settings.minimum_withdrawal or '10' }}"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <div data-ref-section="percent_purchase">
                    <label class="block text-white/70 text-sm font-medium mb-2">Процент вознаграждения
                        пригласившему</label>
                    <div class="flex">
                        <input type="number" name="referral_percentage"
                            value="{{ settings.referral_percentage or '10' }}"
                            class="flex-1 bg-white/5 border border-white/10 rounded-l-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        <span
                            class="px-4 py-2.5 bg-white/10 border border-white/10 border-l-0 rounded-r-lg text-white/70">%</span>
                    </div>
                    <p class="text-white/50 text-xs mt-1">Начисляется рефереру от суммы каждой покупки приглашённого.
                    </p>
                </div>


                <div data-ref-section="fixed_purchase">
                    <label class="block text-white/70 text-sm font-medium mb-2">Фиксированная сумма за покупку</label>
                    <div class="flex">
                        <input type="number" step="0.01" name="fixed_referral_bonus_amount"
                            value="{{ settings.fixed_referral_bonus_amount or '50' }}"
                            class="flex-1 bg-white/5 border border-white/10 rounded-l-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        <span
                            class="px-4 py-2.5 bg-white/10 border border-white/10 border-l-0 rounded-r-lg text-white/70">₽</span>
                    </div>
                    <p class="text-white/50 text-xs mt-1">Каждая покупка приглашённого начисляет рефереру фиксированную
                        сумму.</p>
                </div>


                <div data-ref-section="fixed_start_referrer">
                    <label class="block text-white/70 text-sm font-medium mb-2">Бонус пригласившему при старте</label>
                    <div class="flex">
                        <input type="number" step="0.01" name="referral_on_start_referrer_amount"
                            value="{{ settings.referral_on_start_referrer_amount or '20' }}"
                            class="flex-1 bg-white/5 border border-white/10 rounded-l-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        <span
                            class="px-4 py-2.5 bg-white/10 border border-white/10 border-l-0 rounded-r-lg text-white/70">₽</span>
                    </div>
                    <p class="text-white/50 text-xs mt-1">Единоразово начисляется пригласившему, когда новый
                        пользователь запускает бота по реферальной ссылке.</p>
                </div>


                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Скидка новому пользователю на первую
                        покупку</label>
                    <div class="flex">
                        <input type="number" name="referral_discount" value="{{ settings.referral_discount or '5' }}"
                            class="flex-1 bg-white/5 border border-white/10 rounded-l-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        <span
                            class="px-4 py-2.5 bg-white/10 border border-white/10 border-l-0 rounded-r-lg text-white/70">%</span>
                    </div>
                </div>
            </div>


            <input type="hidden" id="enable_fixed_referral_bonus" name="enable_fixed_referral_bonus"
                value="{% if settings.enable_fixed_referral_bonus == 'true' %}true{% else %}false{% endif %}" />
        </div>
    </section>


    <section id="tab-trial" class="tab-content hidden">
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <h3 class="text-xl font-bold text-white mb-6">Пробный период</h3>
            <label class="flex items-center gap-2 mb-6 cursor-pointer">
                <input type="hidden" name="trial_enabled" value="false" />
                <input type="checkbox" name="trial_enabled" value="true" {% if settings.trial_enabled=='true'
                    %}checked{% endif %}
                    class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                <span class="text-white font-medium">Включить пробный период</span>
            </label>
            <div class="w-full md:w-64">
                <label class="block text-white/70 text-sm font-medium mb-2">Длительность (дней)</label>
                <input type="number" name="trial_duration_days" value="{{ settings.trial_duration_days or '3' }}"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
            </div>
        </div>
    </section>


    <section id="tab-content" class="tab-content hidden">
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <h3 class="text-xl font-bold text-white mb-6">Настройки контента</h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Текст "О проекте"</label>
                    <textarea name="about_text" rows="3"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50">{{ settings.about_text or '' }}</textarea>
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Текст в разделе "Поддержка"</label>
                    <textarea name="support_text" rows="3"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50">{{ settings.support_text or '' }}</textarea>
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Текст главного меню</label>
                    <textarea name="main_menu_text" rows="3"
                        placeholder="🏠 <b>Главное меню</b>&#10;&#10;Выберите действие:"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50">{{ settings.main_menu_text or '' }}</textarea>
                </div>
                <div class="pt-4 border-t border-white/10">
                    <div class="flex items-center gap-2 mb-4">
                        <h4 class="text-white font-bold">Изображение главного меню</h4>
                        <button type="button" class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                            data-copy-text="ГЛАВНОЕ МЕНЮ" title="Скопировать заголовок">
                            <span class="material-symbols-outlined text-sm">content_copy</span>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-white/70 text-sm mb-2">Текущее изображение</label>
                            <input type="text" id="main_menu_image_url" value="{{ settings.main_menu_image or '' }}"
                                readonly
                                class="w-full bg-white/10 border border-white/10 rounded-lg px-4 py-2.5 text-white/70" />
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button"
                                class="btn-upload-menu-image px-4 py-2 rounded-lg bg-primary/20 text-primary font-medium hover:bg-primary/30 flex items-center gap-2"
                                data-section="main_menu">
                                <span class="material-symbols-outlined text-base">upload</span> Загрузить
                            </button>
                            <button type="button"
                                class="btn-delete-menu-image px-4 py-2 rounded-lg bg-red-500/20 text-red-400 font-medium hover:bg-red-500/30 flex items-center gap-2"
                                data-section="main_menu">
                                <span class="material-symbols-outlined text-base">delete</span> Удалить
                            </button>
                        </div>

                        <input type="file" id="main_menu_image_file" accept=".jpg,.jpeg,.png,.gif" class="hidden"
                            data-section="main_menu" />
                        <p class="text-white/50 text-xs">Форматы: JPG, PNG, GIF. Макс. размер: 10 МБ</p>
                    </div>
                </div>

                <div class="pt-4 border-t border-white/10">
                    <h4 class="text-white font-bold mb-4">Изображения разделов меню</h4>
                    <p class="text-white/50 text-sm mb-4">Загрузите изображения для каждого раздела бота. Вы можете
                        настроить изображение для каждого шага взаимодействия с пользователем.</p>

                    <div class="space-y-6">


                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <h5
                                class="text-white/90 font-semibold mb-3 border-b border-white/10 pb-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-sm">info</span>
                                Главное меню / Инфо
                            </h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Мой профиль</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ВАШ ПРОФИЛЬ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Отображается при нажатии кнопки "👤 Мой
                                        профиль"</p>
                                    <input type="text" id="profile_image_url" value="{{ settings.profile_image or '' }}"
                                        readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="profile">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="profile">Удалить</button>
                                    </div>
                                    <input type="file" id="profile_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="profile" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Поддержка</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ТЕХ ПОДДЕРЖКА" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Отображается при нажатии кнопки "🆘 Поддержка"
                                    </p>
                                    <input type="text" id="support_image_url" value="{{ settings.support_image or '' }}"
                                        readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="support">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="support">Удалить</button>
                                    </div>
                                    <input type="file" id="support_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="support" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">О проекте</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="О СЕРВИСЕ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Отображается при нажатии кнопки "ℹ️ О боте"
                                    </p>
                                    <input type="text" id="about_image_url" value="{{ settings.about_image or '' }}"
                                        readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="about">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="about">Удалить</button>
                                    </div>
                                    <input type="file" id="about_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="about" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Скорость
                                            (Speedtest)</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ПРОВЕРКА СКОРОСТИ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Отображается в разделе проверки скорости</p>
                                    <input type="text" id="speedtest_image_url"
                                        value="{{ settings.speedtest_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="speedtest">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="speedtest">Удалить</button>
                                    </div>
                                    <input type="file" id="speedtest_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="speedtest" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Как использовать
                                            (HowTo)</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ИНСТРУКЦИЯ ПО ПОДКЛЮЧЕНИЮ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Отображается в инструкциях по подключению</p>
                                    <input type="text" id="howto_image_url" value="{{ settings.howto_image or '' }}"
                                        readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="howto">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="howto">Удалить</button>
                                    </div>
                                    <input type="file" id="howto_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="howto" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Реферальная
                                            программа</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ПАРТНЕРСКАЯ ПРОГРАММА" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Отображается при нажатии "🤝 Реферальная
                                        система"</p>
                                    <input type="text" id="referral_image_url"
                                        value="{{ settings.referral_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="referral">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="referral">Удалить</button>
                                    </div>
                                    <input type="file" id="referral_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="referral" />
                                </div>
                            </div>
                        </div>


                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <h5
                                class="text-white/90 font-semibold mb-3 border-b border-white/10 pb-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-green-400 text-sm">shopping_cart</span>
                                Процесс покупки (Purchase)
                            </h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Выбор сервера</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ВЫБОР ЛОКАЦИИ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Шаг 1: Когда пользователь нажал "Купить ключ"
                                        и выбирает страну/сервер.</p>
                                    <input type="text" id="buy_server_image_url"
                                        value="{{ settings.buy_server_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="buy_server">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="buy_server">Удалить</button>
                                    </div>
                                    <input type="file" id="buy_server_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="buy_server" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Выбор тарифа</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ВЫБОР ТАРИФА" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Шаг 2: Когда пользователь выбрал сервер и
                                        выбирает длительность (1 мес, 3 мес...)</p>
                                    <input type="text" id="buy_plan_image_url"
                                        value="{{ settings.buy_plan_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="buy_plan">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="buy_plan">Удалить</button>
                                    </div>
                                    <input type="file" id="buy_plan_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="buy_plan" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Запрос Email</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ВВОД EMAIL" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Шаг 3: Когда бота просит ввести Email для
                                        чека.</p>
                                    <input type="text" id="enter_email_image_url"
                                        value="{{ settings.enter_email_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="enter_email">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="enter_email">Удалить</button>
                                    </div>
                                    <input type="file" id="enter_email_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="enter_email" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Выбор метода
                                            оплаты</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ВЫБОР СПОСОБА ОПЛАТЫ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Процесс покупки / Процесс пополнения баланса
                                    </p>
                                    <input type="text" id="payment_method_image_url"
                                        value="{{ settings.payment_method_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="payment_method">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="payment_method">Удалить</button>
                                    </div>
                                    <input type="file" id="payment_method_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="payment_method" />
                                </div>
                            </div>
                        </div>


                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <h5
                                class="text-white/90 font-semibold mb-3 border-b border-white/10 pb-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-blue-400 text-sm">vpn_key</span>
                                Ключи (Keys)
                            </h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Список ключей</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="МОИ ПОДПИСКИ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Отображается в разделе "🔑 Мои ключи" (список
                                        ваших подписок).</p>
                                    <input type="text" id="keys_list_image_url"
                                        value="{{ settings.keys_list_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="keys_list">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="keys_list">Удалить</button>
                                    </div>
                                    <input type="file" id="keys_list_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="keys_list" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Детали ключа</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ИНФОРМАЦИЯ О ПОДПИСКЕ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Отображается при просмотре конкретного ключа
                                        (Инструкции, Подключение).</p>
                                    <input type="text" id="key_info_image_url"
                                        value="{{ settings.key_info_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="key_info">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="key_info">Удалить</button>
                                    </div>
                                    <input type="file" id="key_info_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="key_info" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Продление ключа</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ПРОДЛЕНИЕ ПОДПИСКИ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Экран выбора тарифа при нажатии "Продлить".
                                    </p>
                                    <input type="text" id="extend_plan_image_url"
                                        value="{{ settings.extend_plan_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="extend_plan">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="extend_plan">Удалить</button>
                                    </div>
                                    <input type="file" id="extend_plan_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="extend_plan" />
                                </div>
                            </div>
                        </div>


                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <h5
                                class="text-white/90 font-semibold mb-3 border-b border-white/10 pb-2 flex items-center gap-2">
                                <span
                                    class="material-symbols-outlined text-yellow-500 text-sm">account_balance_wallet</span>
                                Пополнение баланса (Top Up)
                            </h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Меню пополнения</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ПОПОЛНЕНИЕ БАЛАНСА" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Основной экран раздела "💰 Пополнить баланс".
                                    </p>
                                    <input type="text" id="topup_image_url" value="{{ settings.topup_image or '' }}"
                                        readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="topup">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="topup">Удалить</button>
                                    </div>
                                    <input type="file" id="topup_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="topup" />
                                </div>

                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Ввод суммы</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="ВВОД СУММЫ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Экран "Введите сумму пополнения в рублях".</p>
                                    <input type="text" id="topup_amount_image_url"
                                        value="{{ settings.topup_amount_image or '' }}" readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="topup_amount">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="topup_amount">Удалить</button>
                                    </div>
                                    <input type="file" id="topup_amount_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="topup_amount" />
                                </div>


                                <div class="bg-white/5 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-white/70 text-sm font-medium">Счет на оплату
                                            (Инвойс)</label>
                                        <button type="button"
                                            class="text-white/30 hover:text-primary transition-colors btn-copy-text"
                                            data-copy-text="СЧЕТ НА ОПЛАТУ" title="Скопировать">
                                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                        </button>
                                    </div>
                                    <p class="text-white/30 text-xs mb-2">Финальный экран с кнопкой "Оплатить" (Pay).
                                    </p>
                                    <input type="text" id="payment_image_url" value="{{ settings.payment_image or '' }}"
                                        readonly
                                        class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-white/70 text-sm mb-2" />
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="btn-upload-menu-image px-3 py-1.5 rounded-lg bg-primary/20 text-primary text-sm hover:bg-primary/30"
                                            data-section="payment">Загрузить</button>
                                        <button type="button"
                                            class="btn-delete-menu-image px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30"
                                            data-section="payment">Удалить</button>
                                    </div>
                                    <input type="file" id="payment_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="payment" />
                                </div>
                            </div>
                        </div>

                    </div>
                    <p class="text-white/50 text-xs mt-3">Форматы: JPG, PNG, GIF. Макс. размер: 10 МБ</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">URL поддержки</label>
                        <input type="text" name="support_user" value="{{ settings.support_user or '' }}"
                            placeholder="https://t.me/support"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">URL Telegram-канала</label>
                        <input type="url" name="channel_url" value="{{ settings.channel_url or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">URL "Условия использования"</label>
                        <input type="url" name="terms_url" value="{{ settings.terms_url or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm font-medium mb-2">URL "Политика
                            конфиденциальности"</label>
                        <input type="url" name="privacy_url" value="{{ settings.privacy_url or '' }}"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                </div>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="hidden" name="force_subscription" value="false" />
                    <input type="checkbox" name="force_subscription" value="true" {% if
                        settings.force_subscription=='true' %}checked{% endif %}
                        class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                    <span class="text-white/70 text-sm">Требовать подписку на канал</span>
                </label>


                <div class="pt-6 border-t border-white/10">
                    <h4 class="text-white font-bold mb-4">Тексты кнопок (главное меню)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Попробовать бесплатно»</label>
                            <input type="text" name="btn_trial_text" value="{{ settings.btn_trial_text or '' }}"
                                placeholder="🎁 Попробовать бесплатно"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Мой профиль»</label>
                            <input type="text" name="btn_profile_text" value="{{ settings.btn_profile_text or '' }}"
                                placeholder="👤 Мой профиль"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Мои ключи»</label>
                            <input type="text" name="btn_my_keys_text" value="{{ settings.btn_my_keys_text or '' }}"
                                placeholder="🔑 Мои ключи"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Купить ключ»</label>
                            <input type="text" name="btn_buy_key_text" value="{{ settings.btn_buy_key_text or '' }}"
                                placeholder="🛒 Купить ключ"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Пополнить баланс»</label>
                            <input type="text" name="btn_topup_text" value="{{ settings.btn_topup_text or '' }}"
                                placeholder="💳 Пополнить баланс"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Реферальная программа»</label>
                            <input type="text" name="btn_referral_text" value="{{ settings.btn_referral_text or '' }}"
                                placeholder="🤝 Реферальная программа"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Поддержка»</label>
                            <input type="text" name="btn_support_text" value="{{ settings.btn_support_text or '' }}"
                                placeholder="🆘 Поддержка"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«О проекте»</label>
                            <input type="text" name="btn_about_text" value="{{ settings.btn_about_text or '' }}"
                                placeholder="ℹ️ О проекте"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Как использовать»</label>
                            <input type="text" name="btn_howto_text" value="{{ settings.btn_howto_text or '' }}"
                                placeholder="❓ Как использовать"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Скорость»</label>
                            <input type="text" name="btn_speed_text" value="{{ settings.btn_speed_text or '' }}"
                                placeholder="⚡ Скорость"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Админка»</label>
                            <input type="text" name="btn_admin_text" value="{{ settings.btn_admin_text or '' }}"
                                placeholder="⚙️ Админка"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">«Назад в меню»</label>
                            <input type="text" name="btn_back_to_menu_text"
                                value="{{ settings.btn_back_to_menu_text or '' }}" placeholder="⬅️ Назад в меню"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                        </div>
                    </div>
                </div>


                <div class="pt-6 border-t border-white/10">
                    <h4 class="text-white font-bold mb-4">Инструкции по подключению</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Вступительный текст</label>
                            <textarea name="howto_intro_text" rows="2"
                                placeholder="Выберите вашу платформу для инструкции по подключению:"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">{{ settings.howto_intro_text or '' }}</textarea>
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Инструкция для Android</label>
                            <textarea name="howto_android_text" rows="4"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">{{ settings.howto_android_text or '' }}</textarea>
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Инструкция для iOS</label>
                            <textarea name="howto_ios_text" rows="4"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">{{ settings.howto_ios_text or '' }}</textarea>
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Инструкция для Windows</label>
                            <textarea name="howto_windows_text" rows="4"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">{{ settings.howto_windows_text or '' }}</textarea>
                        </div>
                        <div>
                            <label class="block text-white/70 text-sm mb-1">Инструкция для Linux</label>
                            <textarea name="howto_linux_text" rows="4"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">{{ settings.howto_linux_text or '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <section id="tab-monitoring" class="tab-content hidden">
        <div class="bg-white/5 border border-white/10 rounded-lg p-6">
            <h3 class="text-xl font-bold text-white mb-6">Мониторинг ресурсов</h3>
            <label class="flex items-center gap-2 mb-6 cursor-pointer">
                <input type="hidden" name="monitoring_enabled" value="false" />
                <input type="checkbox" name="monitoring_enabled" value="true" {% if (settings.monitoring_enabled
                    or 'true' )=='true' %}checked{% endif %}
                    class="w-4 h-4 bg-white/10 border-white/20 rounded text-primary focus:ring-primary/50" />
                <span class="text-white font-medium">Включить мониторинг и алерты</span>
            </label>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Интервал сбора (сек)</label>
                    <input type="number" name="monitoring_interval_sec"
                        value="{{ settings.monitoring_interval_sec or '300' }}" min="30"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    <p class="text-white/50 text-xs mt-1">Как часто собирать метрики</p>
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Кулдаун алертов (сек)</label>
                    <input type="number" name="monitoring_alert_cooldown_sec"
                        value="{{ settings.monitoring_alert_cooldown_sec or '3600' }}" min="60"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    <p class="text-white/50 text-xs mt-1">Пауза между повторами алертов</p>
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Порог CPU (%)</label>
                    <input type="number" name="monitoring_cpu_threshold"
                        value="{{ settings.monitoring_cpu_threshold or '90' }}" min="10" max="100"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Порог RAM (%)</label>
                    <input type="number" name="monitoring_mem_threshold"
                        value="{{ settings.monitoring_mem_threshold or '90' }}" min="10" max="100"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
                <div>
                    <label class="block text-white/70 text-sm font-medium mb-2">Порог диска (%)</label>
                    <input type="number" name="monitoring_disk_threshold"
                        value="{{ settings.monitoring_disk_threshold or '90' }}" min="10" max="100"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary/50" />
                </div>
            </div>
        </div>
    </section>


    <div class="mt-6">
        <button type="button" id="save-all-settings-btn"
            class="px-6 py-3 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">
            Сохранить все настройки
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');
        const hashInput = document.getElementById('settings-next-hash');
        const hashInput2 = document.getElementById('settings-next-hash-part2');

        function switchTab(tabId) {
            tabs.forEach(btn => {
                const isActive = btn.getAttribute('data-tab') === tabId;
                btn.classList.toggle('bg-primary', isActive);
                btn.classList.toggle('text-background-dark', isActive);
                btn.classList.toggle('text-white/70', !isActive);
                btn.classList.toggle('hover:bg-white/5', !isActive);
            });
            contents.forEach(content => {
                const isActive = content.id === 'tab-' + tabId;
                content.classList.toggle('hidden', !isActive);
            });
            if (hashInput) hashInput.value = tabId;
            if (hashInput2) hashInput2.value = tabId;
            history.replaceState(null, '', '#' + tabId);
        }

        tabs.forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
        });

        const hash = location.hash.slice(1) || 'panel';
        switchTab(hash);

        // Toast notification function
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${isError ? 'bg-red-500 text-white' : 'bg-primary text-background-dark'} font-medium`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // AJAX form submission handler
        function submitFormAjax(form, successMessage = 'Настройки сохранены') {
            const formData = new FormData(form);
            const currentHash = location.hash.slice(1) || 'panel';

            // Ensure next_hash is set to current tab
            formData.set('next_hash', currentHash);

            return fetch(form.action, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.redirected) {
                        // If redirected, fetch the redirected page to check for flash messages
                        return fetch(response.url).then(r => r.text()).then(html => {
                            // Check if there's an error or success message
                            if (html.includes('alert') || html.includes('error')) {
                                // Try to extract message from HTML
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const alertDiv = doc.querySelector('.alert, [class*="alert"], [class*="error"]');
                                if (alertDiv) {
                                    showToast(alertDiv.textContent.trim(), true);
                                } else {
                                    showToast(successMessage);
                                }
                            } else {
                                showToast(successMessage);
                            }
                            return { ok: true };
                        });
                    }
                    return response.json().catch(() => {
                        return { ok: response.ok };
                    });
                })
                .then(data => {
                    if (data.ok !== false) {
                        showToast(successMessage);
                    } else if (data.error) {
                        showToast(data.error, true);
                    } else {
                        showToast('Произошла ошибка', true);
                    }
                    return data;
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Ошибка соединения', true);
                });
        }

        // Backup date display
        const backupSelect = document.getElementById('existing_backup');
        const backupDateSpan = document.getElementById('backup-date');
        if (backupSelect && backupDateSpan) {
            backupSelect.addEventListener('change', () => {
                const opt = backupSelect.options[backupSelect.selectedIndex];
                const mtime = opt.getAttribute('data-mtime');
                backupDateSpan.textContent = mtime || '—';
            });
        }

        // File picker
        const fileInput = document.getElementById('db_file');
        const pickBtn = document.getElementById('btn-pick-file');
        const fileNameSpan = document.getElementById('picked-file-name');
        if (pickBtn && fileInput && fileNameSpan) {
            pickBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                fileNameSpan.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'Файл не выбран';
            });
        }

        // Plan edit toggle
        document.querySelectorAll('.plan-edit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const planId = btn.getAttribute('data-plan-id');
                const editDiv = document.getElementById('edit-plan-' + planId);
                if (editDiv) editDiv.classList.toggle('hidden');
            });
        });

        // Referral reward type conditional fields
        const refTypeSelect = document.getElementById('referral_reward_type');
        const refSections = document.querySelectorAll('[data-ref-section]');
        function updateRefSections() {
            const selected = refTypeSelect ? refTypeSelect.value : 'percent_purchase';
            refSections.forEach(section => {
                const sectionType = section.getAttribute('data-ref-section');
                if (sectionType === selected) {
                    section.style.display = '';
                } else {
                    section.style.display = 'none';
                }
            });
        }
        if (refTypeSelect) {
            refTypeSelect.addEventListener('change', updateRefSections);
            updateRefSections(); // Initial call
        }

        document.querySelectorAll('.btn-copy-text').forEach(btn => {
            btn.addEventListener('click', function () {
                const textToCopy = this.getAttribute('data-copy-text');
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        const originalIcon = this.innerHTML;
                        this.innerHTML = '<span class="material-symbols-outlined text-green-400 text-[16px]">check</span>';
                        setTimeout(() => {
                            this.innerHTML = originalIcon;
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                }
            });
        });

        // Save all settings - AJAX submission
        const saveAllBtn = document.getElementById('save-all-settings-btn');
        if (saveAllBtn) {
            saveAllBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const form1 = document.getElementById('settings-form');
                const form2 = document.getElementById('settings-form-part2');

                // Create a new FormData that combines both forms
                const combinedData = new FormData();

                // Add data from form1
                if (form1) {
                    const formData1 = new FormData(form1);
                    for (const [key, value] of formData1.entries()) {
                        combinedData.append(key, value);
                    }
                }

                // Add data from form2 (skip csrf_token since we already have it)
                if (form2) {
                    const formData2 = new FormData(form2);
                    for (const [key, value] of formData2.entries()) {
                        if (key !== 'csrf_token') {
                            combinedData.append(key, value);
                        }
                    }
                }

                // Update next_hash with current tab
                const currentHash = location.hash.slice(1) || 'panel';
                combinedData.set('next_hash', currentHash);

                // Submit via AJAX
                const action = form2 ? form2.action : form1.action;
                fetch(action, {
                    method: 'POST',
                    body: combinedData
                })
                    .then(response => response.text())
                    .then(html => {
                        showToast('Настройки сохранены');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Ошибка при сохранении', true);
                    });
            });
        }

        // Intercept ALL form submissions in Hosts tab and other tabs
        document.querySelectorAll('form').forEach(form => {
            // Skip the main settings forms as they're handled separately
            if (form.id === 'settings-form' || form.id === 'settings-form-part2') {
                return;
            }

            // Skip forms with formaction (backup/restore) as they need different handling
            const hasSpecialAction = Array.from(form.querySelectorAll('button[type="submit"]')).some(btn =>
                btn.hasAttribute('formaction') &&
                (btn.getAttribute('formaction').includes('backup') || btn.getAttribute('formaction').includes('restore'))
            );

            if (hasSpecialAction) {
                return; // Let these forms work normally (download/upload)
            }

            form.addEventListener('submit', function (e) {
                e.preventDefault();

                // Check if form has data-confirm attribute
                const confirmMsg = form.getAttribute('data-confirm');
                if (confirmMsg && !confirm(confirmMsg)) {
                    return;
                }

                const actionUrl = this.action;
                const successMessage = getSuccessMessage(actionUrl);

                submitFormAjax(this, successMessage).then(() => {
                    // Reload page content after successful submission to show updated data
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                });
            });
        });

        // Also intercept button clicks with formaction
        document.querySelectorAll('button[formaction]').forEach(button => {
            // Skip backup/restore buttons
            if (button.getAttribute('formaction').includes('backup') ||
                button.getAttribute('formaction').includes('restore')) {
                return;
            }

            button.addEventListener('click', function (e) {
                const form = this.closest('form');
                if (form) {
                    e.preventDefault();
                    const originalAction = form.action;
                    form.action = this.getAttribute('formaction');

                    const successMessage = getSuccessMessage(form.action);
                    submitFormAjax(form, successMessage).then(() => {
                        form.action = originalAction;
                    });
                }
            });
        });

        // Helper function to get success message based on action URL
        function getSuccessMessage(actionUrl) {
            if (actionUrl.includes('add_host')) return 'Хост добавлен';
            if (actionUrl.includes('delete_host')) return 'Хост удалён';
            if (actionUrl.includes('update_host_url')) return 'URL сохранён';
            if (actionUrl.includes('rename_host')) return 'Хост переименован';
            if (actionUrl.includes('update_host_subscription')) return 'Ссылка сохранена';
            if (actionUrl.includes('update_host_ssh')) return 'SSH настройки сохранены';
            if (actionUrl.includes('add_plan')) return 'Тариф добавлен';
            if (actionUrl.includes('delete_plan')) return 'Тариф удалён';
            if (actionUrl.includes('update_plan')) return 'Тариф обновлён';
            if (actionUrl.includes('create_ssh_target')) return 'SSH-цель добавлена';
            if (actionUrl.includes('delete_ssh_target')) return 'SSH-цель удалена';
            if (actionUrl.includes('update_ssh_target')) return 'SSH-цель обновлена';
            if (actionUrl.includes('speedtest')) return 'Тест запущен';
            if (actionUrl.includes('auto_install_speedtest')) return 'Установка запущена';
            if (actionUrl.includes('yoomoney_check')) return 'Проверка выполнена';
            return 'Сохранено';
        }

        // Speedtest buttons - show loading on form submit
        const speedtestBtns = document.querySelectorAll('.speedtest-loading-btn');
        speedtestBtns.forEach(btn => {
            const form = btn.closest('form');
            if (form) {
                form.addEventListener('submit', function (e) {
                    const label = btn.dataset.label || 'Выполняется';
                    btn.innerHTML = '<span class="inline-flex items-center gap-1"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ' + label + '...</span>';
                    btn.disabled = true;
                });
            }
        });



        // === Обработчики для изображений разделов меню ===
        document.querySelectorAll('.btn-upload-menu-image').forEach(btn => {
            btn.addEventListener('click', function () {
                const section = this.dataset.section;
                const fileInput = document.getElementById(section + '_image_file');
                if (fileInput) fileInput.click();
            });
        });

        document.querySelectorAll('input[type="file"][data-section]').forEach(fileInput => {
            fileInput.addEventListener('change', async function () {
                if (!this.files || !this.files[0]) return;
                const section = this.dataset.section;
                const urlInput = document.getElementById(section + '_image_url');
                const btn = document.querySelector('.btn-upload-menu-image[data-section="' + section + '"]');

                if (btn) btn.disabled = true;
                const formData = new FormData();
                formData.append('file', this.files[0]);

                try {
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                    const resp = await fetch('/upload-menu-image/' + section, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken },
                        body: formData
                    });
                    const data = await resp.json();
                    if (data.ok) {
                        if (urlInput) urlInput.value = data.path;
                        showToast('Изображение загружено', 'success');
                    } else {
                        showToast(data.error || 'Ошибка загрузки', 'error');
                    }
                } catch (e) {
                    showToast('Ошибка загрузки: ' + e.message, 'error');
                } finally {
                    if (btn) btn.disabled = false;
                    this.value = '';
                }
            });
        });

        document.querySelectorAll('.btn-delete-menu-image').forEach(btn => {
            btn.addEventListener('click', async function () {
                const section = this.dataset.section;
                const urlInput = document.getElementById(section + '_image_url');

                if (!urlInput || !urlInput.value) {
                    showToast('Изображение не установлено', 'warning');
                    return;
                }
                if (!confirm('Удалить изображение?')) return;

                this.disabled = true;
                try {
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                    const resp = await fetch('/delete-menu-image/' + section, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await resp.json();
                    if (data.ok) {
                        urlInput.value = '';
                        showToast('Изображение удалено', 'success');
                    } else {
                        showToast(data.error || 'Ошибка удаления', 'error');
                    }
                } catch (e) {
                    showToast('Ошибка удаления: ' + e.message, 'error');
                } finally {
                    this.disabled = false;
                }
            });
        });

        // SSH Target Edit handlers
        document.querySelectorAll('.ssh-edit-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const targetName = this.dataset.target;
                const editForm = document.getElementById('edit-ssh-' + targetName);
                if (editForm) {
                    editForm.classList.toggle('hidden');
                }
            });
        });

        document.querySelectorAll('.ssh-cancel-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const targetName = this.dataset.target;
                const editForm = document.getElementById('edit-ssh-' + targetName);
                if (editForm) {
                    editForm.classList.add('hidden');
                }
            });
        });

        document.querySelectorAll('.plan-cancel-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const planId = this.dataset.planId;
                const editForm = document.getElementById('edit-plan-' + planId);
                if (editForm) {
                    editForm.classList.add('hidden');
                }
            });
        });
    });

    // Toggle Add Host Form
    function toggleAddHostForm() {
        const form = document.getElementById('add-host-form');
        const icon = document.getElementById('add-host-icon');
        if (form && icon) {
            form.classList.toggle('hidden');
            const isHidden = form.classList.contains('hidden');

            // Save state to localStorage
            localStorage.setItem('addHostFormCollapsed', isHidden ? 'true' : 'false');

            if (isHidden) {
                icon.style.transform = 'rotate(0deg)';
            } else {
                icon.style.transform = 'rotate(180deg)';
            }
        }
    }

    // Toggle Host Content
    function toggleHostContent(hostName) {
        const content = document.getElementById('host-content-' + hostName);
        const icon = document.getElementById('host-icon-' + hostName);
        if (content && icon) {
            content.classList.toggle('hidden');
            const isHidden = content.classList.contains('hidden');

            // Save state to localStorage
            localStorage.setItem('hostCollapsed_' + hostName, isHidden ? 'true' : 'false');

            if (isHidden) {
                icon.style.transform = 'rotate(0deg)';
            } else {
                icon.style.transform = 'rotate(180deg)';
            }
        }
    }

    // Restore states on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Restore Add Host Form state
        const addHostForm = document.getElementById('add-host-form');
        const addHostIcon = document.getElementById('add-host-icon');
        const addHostCollapsed = localStorage.getItem('addHostFormCollapsed');

        if (addHostCollapsed === 'false' && addHostForm && addHostIcon) {
            addHostForm.classList.remove('hidden');
            addHostIcon.style.transform = 'rotate(180deg)';
        }

        // Restore all host states
        document.querySelectorAll('[id^="host-content-"]').forEach(content => {
            const hostName = content.id.replace('host-content-', '');
            const icon = document.getElementById('host-icon-' + hostName);
            const isCollapsed = localStorage.getItem('hostCollapsed_' + hostName);

            if (isCollapsed === 'false' && icon) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            }
        });
    });
</script>

<style>
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}