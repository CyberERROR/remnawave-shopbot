{% extends "base.html" %}
{% block title %}Настройки{% endblock %}

{% block head %}
<style>
</style>
{% endblock %}

{% block content %}

<!-- ===== ЗАГОЛОВОК СТРАНИЦЫ ===== -->
<!-- Название раздела и краткое подзаголовок -->
<div class="mb-8 flex items-center justify-between">
    <div class="space-y-1">
        <h2 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
            Настройки
            <span
                class="px-2 py-0.5 rounded-md bg-primary/10 text-primary text-[10px] font-semibold uppercase tracking-widest border border-primary/20">Система</span>
        </h2>
        <p class="text-white/40 text-xs font-medium uppercase tracking-[0.2em] ml-1">Центр управления ботами и контентом
        </p>
    </div>

    <button type="button" id="save-all-settings-btn"
        class="group relative z-0 px-5 py-2.5 rounded-xl bg-primary/10 border border-primary/20 text-primary font-semibold text-xs uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all flex items-center gap-2 overflow-hidden">
        <div class="absolute inset-0 bg-primary/20 translate-y-full group-hover:translate-y-0 transition-transform">
        </div>
        <span class="material-symbols-outlined text-sm relative z-10">save</span>
        <span class="relative z-10">Сохранить</span>
    </button>
</div>
<!-- ===== Конец заголовка страницы ===== -->


<!-- ===== СТАТУС НАСТРОЕК ===== -->
<!-- Уведомление о готовности ботов к работе -->
<div class="mb-8 p-1.5 rounded-3xl bg-white/5 border border-white/10 backdrop-blur-xl shadow-2xl">
    <div class="flex flex-col md:flex-row items-stretch md:items-center gap-4 p-4 pr-6">
        {% if all_settings_ok and support_settings_ok %}
        <div
            class="w-14 h-14 rounded-2xl bg-primary/10 border border-primary/20 flex items-center justify-center text-primary relative overflow-hidden group">
            <div class="absolute inset-0 bg-primary/10 animate-pulse"></div>
            <span class="material-symbols-outlined text-3xl relative z-10">check_circle</span>
        </div>
        <div class="flex-1">
            <h4 class="text-white font-semibold text-sm tracking-tight">Боты готовы к запуску</h4>
            <div class="flex items-center gap-4 mt-1.5">
                <div class="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-primary/5 border border-primary/10">
                    <div class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></div>
                    <span class="text-[9px] font-semibold text-primary/80 uppercase tracking-widest">Основной бот</span>
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-primary/5 border border-primary/10">
                    <div class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></div>
                    <span class="text-[9px] font-semibold text-primary/80 uppercase tracking-widest">Support бот</span>
                </div>
            </div>
        </div>
        {% else %}
        <div
            class="w-14 h-14 rounded-2xl bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center text-yellow-400 relative">
            <span class="material-symbols-outlined text-3xl">warning</span>
        </div>
        <div class="flex-1">
            <h4 class="text-white font-semibold text-sm tracking-tight text-yellow-500/90">Требуется донастройка</h4>
            <div class="flex items-center gap-4 mt-1.5">
                <div
                    class="flex items-center gap-1.5 px-2 py-1 rounded-lg {{ 'bg-primary/5 border border-primary/10 text-primary/80' if all_settings_ok else 'bg-red-500/5 border border-red-500/10 text-red-400/80' }}">
                    <div
                        class="w-1.5 h-1.5 rounded-full {{ 'bg-primary animate-pulse' if all_settings_ok else 'bg-red-500' }}">
                    </div>
                    <span class="text-[9px] font-semibold uppercase tracking-widest">Основной бот</span>
                </div>
                <div
                    class="flex items-center gap-1.5 px-2 py-1 rounded-lg {{ 'bg-primary/5 border border-primary/10 text-primary/80' if support_settings_ok else 'bg-red-500/5 border border-red-500/10 text-red-400/80' }}">
                    <div
                        class="w-1.5 h-1.5 rounded-full {{ 'bg-primary animate-pulse' if support_settings_ok else 'bg-red-500' }}">
                    </div>
                    <span class="text-[9px] font-semibold uppercase tracking-widest">Support бот</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
<!-- ===== Конец статуса настроек ===== -->


<!-- ===== НАВИГАЦИЯ ПО ВКЛАДКАМ ===== -->
<!-- Верхнее меню управления разделами настроек -->
<div class="relative mb-10">
    <div
        class="bg-white/5 border border-white/10 rounded-2xl p-1.5 shadow-2xl backdrop-blur-xl overflow-x-auto no-scrollbar">
        <nav class="flex items-center gap-1 min-w-max" id="settings-nav">
            {% for item in [
            {'id': 'panel', 'label': 'Панель', 'icon': 'dashboard'},
            {'id': 'bot', 'label': 'Боты', 'icon': 'smart_toy'},
            {'id': 'payments', 'label': 'Платежи', 'icon': 'payments'},
            {'id': 'hosts', 'label': 'Хосты', 'icon': 'dns'},
            {'id': 'referrals', 'label': 'Рефералы', 'icon': 'group'},
            {'id': 'content', 'label': 'Контент', 'icon': 'article'}
            ] %}
            <button type="button" data-tab="{{ item.id }}"
                class="tab-btn px-6 py-3 rounded-xl text-[11px] font-bold uppercase tracking-widest transition-all duration-300 flex items-center gap-2.5">
                <span class="material-symbols-outlined text-lg">{{ item.icon }}</span>
                {{ item.label }}
            </button>
            {% endfor %}
            <div class="w-px h-6 bg-white/10 mx-2"></div>
            <a href="{{ url_for('button_constructor_page') }}"
                class="px-6 py-3 rounded-xl text-[11px] font-bold uppercase tracking-widest text-white/40 hover:text-white/80 hover:bg-white/5 transition-all flex items-center gap-2.5 no-underline">
                <span class="material-symbols-outlined text-lg">construction</span>
                Конструктор кнопок
            </a>
        </nav>
    </div>
</div>
<!-- ===== Конец навигации ===== -->

<form action="{{ url_for('settings_page') }}" method="post" id="settings-form" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="next_hash" id="settings-next-hash" value="panel" />


    <section id="tab-panel" class="tab-content">
        <div class="space-y-6">
            <!-- Header Card -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                        <span class="material-symbols-outlined text-3xl">admin_panel_settings</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white tracking-tight">Настройки Панели</h3>
                        <p class="text-white/60 text-xs font-medium">Управление доступом, базой данных и системными
                            функциями</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                <!-- Access & Global Settings -->
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">security</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Доступ и Глобальные настройки</h4>
                    </div>

                    <div class="space-y-4">
                        <!-- Top Inputs Row -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Логин</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">person</span>
                                    <input type="text" name="panel_login" value="{{ settings.panel_login or '' }}"
                                        required autocomplete="off"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Новый
                                    пароль</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">lock</span>
                                    <input type="password" name="panel_password" id="panel_pass" placeholder="••••••••"
                                        autocomplete="new-password"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-10 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                    <button type="button" onclick="togglePasswordVisibility('panel_pass')"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-white/20 hover:text-white transition-colors">
                                        <span class="material-symbols-outlined text-sm">visibility</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Автобэкап
                                    (дни)</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">history</span>
                                    <input type="number" name="backup_interval_days"
                                        value="{{ settings.backup_interval_days or '1' }}" min="0"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                                <p class="text-[9px] text-white/40 mt-1 ml-1 leading-tight">0 — выключить автобэкап</p>
                            </div>
                        </div>

                        <!-- WAL Mode Full Width -->
                        <div class="pt-2">
                            <div class="bg-black/20 border border-white/5 rounded-xl px-4 py-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-primary/70">
                                            <span class="material-symbols-outlined text-sm">terminal</span>
                                        </div>
                                        <div>
                                            <span
                                                class="text-xs font-bold text-white uppercase tracking-wider block">WAL
                                                режим БД</span>
                                            <p
                                                class="text-[9px] text-white/50 uppercase tracking-tighter leading-tight mt-0.5">
                                                WAL вкл — для HDD, выкл — для SSD/NVMe (быстрее)</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="hidden" name="enable_wal_mode" value="0" />
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" name="enable_wal_mode" value="1" {% if
                                                settings.enable_wal_mode=='1' %}checked{% endif %}
                                                class="sr-only peer" />
                                            <div
                                                class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Auto Start Bot -->
                        <div class="pt-2">
                            <div class="bg-black/20 border border-white/5 rounded-xl px-4 py-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-primary/70">
                                            <span class="material-symbols-outlined text-sm">power_settings_new</span>
                                        </div>
                                        <div>
                                            <span
                                                class="text-xs font-bold text-white uppercase tracking-wider block">Автозапуск
                                                бота</span>
                                            <p
                                                class="text-[9px] text-white/50 uppercase tracking-tighter leading-tight mt-0.5">
                                                Автоматический запуск после перезагрузки сервера</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="hidden" name="auto_start_bot" value="0" />
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" name="auto_start_bot" value="1" {% if
                                                other_settings.auto_start_bot=='1' %}checked{% endif %}
                                                class="sr-only peer" />
                                            <div
                                                class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup Management Card -->
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">database</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Резервное копирование</h4>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 h-full">
                        <div class="space-y-3">
                            <div
                                class="bg-black/20 border border-white/5 rounded-xl p-3 flex flex-col justify-between h-full">
                                <div>
                                    <span
                                        class="text-[10px] font-bold text-white/30 uppercase tracking-widest block mb-2">Текущая
                                        база</span>
                                    <p class="text-[11px] text-white/50 leading-relaxed mb-3">Скачать полный дамп базы
                                        данных прямо сейчас</p>
                                </div>
                                <button type="submit" formaction="{{ url_for('backup_db_route') }}"
                                    class="w-full px-4 py-2.5 rounded-xl bg-primary/20 text-primary text-xs font-bold uppercase tracking-widest hover:bg-primary/30 transition-all border border-primary/20 flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined text-sm">download</span>
                                    Скачать .DB
                                </button>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="bg-black/20 border border-white/5 rounded-xl p-3">
                                <span
                                    class="text-[10px] font-bold text-white/30 uppercase tracking-widest block mb-2">Из
                                    имеющихся</span>
                                <div class="soft-select" data-target="existing_backup">
                                    <button type="button"
                                        class="soft-select-toggle w-full text-left bg-black/30 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 truncate"
                                        id="existing_backup_toggle">
                                        — Выберите архив —
                                    </button>
                                    <div class="soft-select-menu"></div>
                                    <select name="existing_backup" id="existing_backup" class="hidden">
                                        <option value="">— Выберите архив —</option>
                                        {% for b in backups %}
                                        <option value="{{ b.name }}" data-mtime="{{ b.mtime }}">{{ b.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="bg-black/20 border border-white/5 rounded-xl p-3">
                                <span
                                    class="text-[10px] font-bold text-white/30 uppercase tracking-widest block mb-2">Загрузить
                                    файл</span>
                                <div class="flex gap-2">
                                    <button type="button" id="btn-pick-file"
                                        class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-[10px] font-bold hover:bg-white/20 transition-all shrink-0">ВЫБРАТЬ</button>
                                    <span id="picked-file-name"
                                        class="flex-1 flex items-center px-2 rounded-lg bg-black/40 text-white/30 text-[9px] truncate">Нет
                                        файла</span>
                                </div>
                                <input type="file" id="db_file" name="db_file" accept=".zip,.db" class="hidden" />
                            </div>

                            <button type="submit" formaction="{{ url_for('restore_db_route') }}"
                                formenctype="multipart/form-data"
                                class="w-full py-2.5 rounded-xl bg-red-500/20 text-red-500 hover:bg-red-500/30 text-[10px] font-bold uppercase tracking-widest transition-all border border-red-500/10 flex items-center justify-center gap-2"
                                data-confirm="Все текущие данные будут заменены данными из бэкапа. Продолжить?">
                                <span class="material-symbols-outlined text-sm">settings_backup_restore</span>
                                Восстановить базу
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Trial Period Card -->
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col">
                    <div class="flex items-center justify-between gap-2 mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-lg">timer</span>
                            </div>
                            <h4 class="text-white font-bold text-sm">Пробный период</h4>
                        </div>
                        <div class="flex items-center gap-2 bg-black/20 rounded-xl px-3 py-1.5 border border-white/5">
                            <input type="hidden" name="trial_enabled" value="false" />
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="trial_enabled" value="true" {% if
                                    settings.trial_enabled=='true' %}checked{% endif %} class="sr-only peer" />
                                <div
                                    class="w-9 h-5 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label
                                    class="block text-white/40 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Дней</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">calendar_today</span>
                                    <input type="number" name="trial_duration_days"
                                        value="{{ settings.trial_duration_days or '3' }}"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/40 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Трафик
                                    (ГБ)</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">speed</span>
                                    <input type="number" name="trial_traffic_limit_gb"
                                        value="{{ settings.trial_traffic_limit_gb or '0' }}"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/40 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Лимит
                                    HWID</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">fingerprint</span>
                                    <input type="number" name="trial_hwid_limit"
                                        value="{{ settings.trial_hwid_limit or '0' }}"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                        </div>

                        <div>
                            <label
                                class="block text-white/40 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Сервер
                                для триала</label>
                            <div class="soft-select" data-target="trial_host_id">
                                <button type="button"
                                    class="soft-select-toggle w-full text-left bg-black/30 border border-white/10 rounded-xl px-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 transition-all font-medium"
                                    id="trial_host_id_toggle">
                                    {% if settings.trial_host_id %}{{ settings.trial_host_id }}{% else %}Выборочно
                                    (пользователь выбирает){% endif %}
                                </button>
                                <div class="soft-select-menu" id="trial_host_id_menu"></div>
                                <select name="trial_host_id" id="trial_host_id" class="hidden">
                                    <option value="">Выборочно (пользователь выбирает)</option>
                                    {% for host in hosts %}
                                    <option value="{{ host.host_name }}" {% if settings.trial_host_id==host.host_name
                                        %}selected{% endif %}>{{ host.host_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resource Monitoring Card -->
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col">
                    <div class="flex items-center justify-between gap-2 mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-lg">monitoring</span>
                            </div>
                            <h4 class="text-white font-bold text-sm">Мониторинг ресурсов</h4>
                        </div>
                        <div class="flex items-center gap-2 bg-black/20 rounded-xl px-3 py-1.5 border border-white/5">
                            <input type="hidden" name="monitoring_enabled" value="false" />
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="monitoring_enabled" value="true" {% if
                                    (settings.monitoring_enabled or 'true' )=='true' %}checked{% endif %}
                                    class="sr-only peer" />
                                <div
                                    class="w-9 h-5 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-white/40 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Интервал
                                    (сек)</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">timer</span>
                                    <input type="number" name="monitoring_interval_sec"
                                        value="{{ settings.monitoring_interval_sec or '300' }}" min="30"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/40 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Кулдаун
                                    (сек)</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">update_disabled</span>
                                    <input type="number" name="monitoring_alert_cooldown_sec"
                                        value="{{ settings.monitoring_alert_cooldown_sec or '3600' }}" min="60"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                        </div>

                        <div class="bg-black/20 border border-white/5 rounded-xl p-3">
                            <span
                                class="text-[10px] font-bold text-white/30 uppercase tracking-widest block mb-3">Пороги
                                уведомлений (%)</span>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="space-y-1">
                                    <label class="text-[9px] text-white/40 font-bold ml-1 uppercase">CPU</label>
                                    <input type="number" name="monitoring_cpu_threshold"
                                        value="{{ settings.monitoring_cpu_threshold or '90' }}" min="10" max="100"
                                        class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs text-center focus:border-primary/50 outline-none" />
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[9px] text-white/40 font-bold ml-1 uppercase">RAM</label>
                                    <input type="number" name="monitoring_mem_threshold"
                                        value="{{ settings.monitoring_mem_threshold or '90' }}" min="10" max="100"
                                        class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs text-center focus:border-primary/50 outline-none" />
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[9px] text-white/40 font-bold ml-1 uppercase">Disk</label>
                                    <input type="number" name="monitoring_disk_threshold"
                                        value="{{ settings.monitoring_disk_threshold or '90' }}" min="10" max="100"
                                        class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs text-center focus:border-primary/50 outline-none" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section><!-- ===== Конец мониторинга ресурсов ===== -->


    <section id="tab-bot" class="tab-content hidden">
        <div class="space-y-6">
            <!-- Header Card -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                        <span class="material-symbols-outlined text-3xl">smart_toy</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white tracking-tight">Настройки ботов</h3>
                        <p class="text-white/60 text-xs font-medium">Конфигурация основного бота и службы поддержки</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                <!-- Main Bot Card -->
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">robot_2</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Основной бот</h4>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Токен
                                бота</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">key</span>
                                <input type="password" name="telegram_bot_token" id="bot_token_main"
                                    value="{{ settings.telegram_bot_token or '' }}" required autocomplete="new-password"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-10 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                <button type="button" onclick="togglePasswordVisibility('bot_token_main')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-white/20 hover:text-white transition-colors">
                                    <span class="material-symbols-outlined text-sm">visibility</span>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Username
                                    (без @)</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">alternate_email</span>
                                    <input type="text" name="telegram_bot_username"
                                        value="{{ settings.telegram_bot_username or '' }}" required autocomplete="off"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">ID
                                    Администратора</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">badge</span>
                                    <input type="text" name="admin_telegram_id"
                                        value="{{ settings.admin_telegram_id or '' }}" required autocomplete="off"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Support Bot Card -->
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">support_agent</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Support-бот</h4>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Токен
                                support-бота</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">key</span>
                                <input type="password" name="support_bot_token" id="bot_token_support"
                                    value="{{ settings.support_bot_token or '' }}" autocomplete="new-password"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-10 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                <button type="button" onclick="togglePasswordVisibility('bot_token_support')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-white/20 hover:text-white transition-colors">
                                    <span class="material-symbols-outlined text-sm">visibility</span>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Username
                                    (без @)</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">alternate_email</span>
                                    <input type="text" name="support_bot_username"
                                        value="{{ settings.support_bot_username or '' }}" autocomplete="off"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">ID
                                    саппорт-чата</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">forum</span>
                                    <input type="text" name="support_forum_chat_id"
                                        value="{{ settings.support_forum_chat_id or '' }}" autocomplete="off"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                                <p class="text-[9px] text-white/40 mt-1 ml-1 leading-tight">Для вывода тикетов в
                                    обсуждения (forum)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <section id="tab-payments" class="tab-content hidden">
        {% set base_url = ('https://' + settings.domain) if settings.domain else request.url_root.replace('http://',
        'https://') %}
        {% set base_url = base_url.rstrip('/') %}
        <div class="space-y-6">
            <!-- Header Card -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                        <span class="material-symbols-outlined text-3xl">account_balance_wallet</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white tracking-tight">Платежные системы</h3>
                        <p class="text-white/60 text-xs font-medium">Настройка методов оплаты и параметров транзакций
                        </p>
                    </div>
                </div>
            </div>

            <!-- Настройка полей комментариев и общие настройки -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-lg">settings_suggest</span>
                    </div>
                    <h4 class="text-white font-bold text-sm">Данные и Общие настройки</h4>
                </div>

                <div class="space-y-6">
                    <div>
                        <label
                            class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-2 ml-1">Данные
                            в комментариях к платежам</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                            <label
                                class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-xl bg-black/20 border border-white/5 hover:bg-white/5 transition-all group">
                                <span class="text-white/70 text-xs font-medium group-hover:text-white">ID
                                    пользователя</span>
                                <div class="relative inline-flex items-center">
                                    <input type="checkbox" name="pay_info_id" value="1" data-field="id" {% if
                                        pay_info.id==1 %}checked{% endif %} class="sr-only peer pay-info-toggle">
                                    <div
                                        class="w-9 h-5 bg-white/10 rounded-full peer peer-checked:bg-primary transition-all after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full">
                                    </div>
                                </div>
                            </label>

                            <label
                                class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-xl bg-black/20 border border-white/5 hover:bg-white/5 transition-all group">
                                <span class="text-white/70 text-xs font-medium group-hover:text-white">Username</span>
                                <div class="relative inline-flex items-center">
                                    <input type="checkbox" name="pay_info_username" value="1" data-field="username" {%
                                        if pay_info.username==1 %}checked{% endif %}
                                        class="sr-only peer pay-info-toggle">
                                    <div
                                        class="w-9 h-5 bg-white/10 rounded-full peer peer-checked:bg-primary transition-all after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full">
                                    </div>
                                </div>
                            </label>

                            <label
                                class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-xl bg-black/20 border border-white/5 hover:bg-white/5 transition-all group">
                                <span class="text-white/70 text-xs font-medium group-hover:text-white">Имя</span>
                                <div class="relative inline-flex items-center">
                                    <input type="checkbox" name="pay_info_first_name" value="1" data-field="first_name"
                                        {% if pay_info.first_name==1 %}checked{% endif %}
                                        class="sr-only peer pay-info-toggle">
                                    <div
                                        class="w-9 h-5 bg-white/10 rounded-full peer peer-checked:bg-primary transition-all after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full">
                                    </div>
                                </div>
                            </label>

                            <label
                                class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-xl bg-black/20 border border-white/5 hover:bg-white/5 transition-all group">
                                <span class="text-white/70 text-xs font-medium group-hover:text-white">Хост</span>
                                <div class="relative inline-flex items-center">
                                    <input type="checkbox" name="pay_info_host_name" value="1" data-field="host_name" {%
                                        if pay_info.host_name==1 %}checked{% endif %}
                                        class="sr-only peer pay-info-toggle">
                                    <div
                                        class="w-9 h-5 bg-white/10 rounded-full peer peer-checked:bg-primary transition-all after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full">
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-white/5">
                        <div class="flex items-center justify-between p-4 bg-black/20 border border-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">mail_off</span>
                                </div>
                                <div>
                                    <p class="text-white text-sm font-bold">Пропускать ввод email</p>
                                    <p class="text-white/40 text-[11px] leading-tight">Пользователи сразу переходят к
                                        выбору оплаты</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input type="hidden" name="skip_email" value="0" />
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="skip_email" value="1" id="skip_email" {% if
                                        settings.skip_email=='1' %}checked{% endif %} class="sr-only peer" />
                                    <div
                                        class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grid Container for Payment Gateways -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 items-start">

                <!-- YooKassa -->
                <div
                    class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col h-full">
                    <div class="flex items-center justify-between gap-2 mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-lg">account_balance</span>
                            </div>
                            <h4 class="text-white font-bold text-sm">YooKassa</h4>
                        </div>
                        <div class="flex items-center gap-2 bg-black/20 rounded-xl px-3 py-1.5 border border-white/5">
                            <input type="hidden" name="sbp_enabled" value="false" />
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="sbp_enabled" value="true" id="sbp_enabled" {% if
                                    settings.sbp_enabled=='true' %}checked{% endif %} class="sr-only peer" />
                                <div
                                    class="w-9 h-5 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                </div>
                            </label>
                            <span class="text-[10px] font-bold text-white/60 uppercase ml-1">СБП</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Почта
                                    для чеков</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">mail</span>
                                    <input type="email" name="receipt_email" value="{{ settings.receipt_email or '' }}"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Shop
                                        ID</label>
                                    <div class="relative group">
                                        <span
                                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">pin</span>
                                        <input type="text" name="yookassa_shop_id"
                                            value="{{ settings.yookassa_shop_id or '' }}"
                                            class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Secret
                                        Key</label>
                                    <div class="relative group">
                                        <span
                                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">key</span>
                                        <input type="password" name="yookassa_secret_key"
                                            value="{{ settings.yookassa_secret_key or '' }}"
                                            class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Platega -->
                <div
                    class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col h-full">
                    <div class="flex items-center justify-between gap-2 mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-lg">credit_card</span>
                            </div>
                            <h4 class="text-white font-bold text-sm">Platega</h4>
                        </div>
                        <div class="flex items-center gap-2 bg-black/20 rounded-xl px-3 py-1.5 border border-white/5">
                            <input type="hidden" name="platega_enabled" value="false" />
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="platega_enabled" value="true" id="platega_enabled" {% if
                                    settings.platega_enabled=='true' %}checked{% endif %} class="sr-only peer" />
                                <div
                                    class="w-9 h-5 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                </div>
                            </label>
                            <span class="text-[10px] font-bold text-white/60 uppercase ml-1">ВКЛ</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Merchant
                                    ID</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">pin</span>
                                    <input type="text" name="platega_merchant_id"
                                        value="{{ settings.platega_merchant_id or '' }}"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">API
                                    Key</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">key</span>
                                    <input type="password" name="platega_api_key"
                                        value="{{ settings.platega_api_key or '' }}"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                        </div>
                        <div class="bg-black/20 rounded-lg px-3 py-2 border border-white/5">
                            <p class="text-[9px] text-white/40 uppercase tracking-widest leading-tight">Callback:</p>
                            <p class="text-[10px] text-primary/80 font-mono mt-0.5 truncate">{{ base_url
                                }}/platega-webhook</p>
                        </div>
                    </div>
                </div>

                <!-- Heleket -->
                <div
                    class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col h-full">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">payments</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Heleket</h4>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Merchant
                                    ID</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">pin</span>
                                    <input type="text" name="heleket_merchant_id"
                                        value="{{ settings.heleket_merchant_id or '' }}"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">API
                                    Key</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">key</span>
                                    <input type="password" name="heleket_api_key"
                                        value="{{ settings.heleket_api_key or '' }}"
                                        class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                </div>
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Ваш
                                домен</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">link</span>
                                <input type="text" name="domain" value="{{ settings.domain or '' }}"
                                    placeholder="my-shop.com"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TonConnect -->
                <div
                    class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col h-full">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">TonConnect</h4>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Ton
                                Wallet Address</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">wallet</span>
                                <input type="text" name="ton_wallet_address"
                                    value="{{ settings.ton_wallet_address or '' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">TonAPI
                                Key</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">key</span>
                                <input type="password" name="tonapi_key" value="{{ settings.tonapi_key or '' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Telegram Stars -->
                <div
                    class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col h-full">
                    <div class="flex items-center justify-between gap-2 mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-lg">star</span>
                            </div>
                            <h4 class="text-white font-bold text-sm">Telegram Stars</h4>
                        </div>
                        <div class="flex items-center gap-2 bg-black/20 rounded-xl px-3 py-1.5 border border-white/5">
                            <input type="hidden" name="stars_enabled" value="false" />
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="stars_enabled" value="true" id="stars_enabled" {% if
                                    settings.stars_enabled=='true' %}checked{% endif %} class="sr-only peer" />
                                <div
                                    class="w-9 h-5 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                </div>
                            </label>
                            <span class="text-[10px] font-bold text-white/60 uppercase ml-1">ВКЛ</span>
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Коэффициент
                            (⭐ за 1 RUB)</label>
                        <div class="relative group">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">calculate</span>
                            <input type="number" step="0.01" name="stars_per_rub"
                                value="{{ settings.stars_per_rub or '1' }}"
                                class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                        </div>
                        <p class="text-[9px] text-white/40 mt-1 ml-1 leading-tight">Пример: 2.5 = 2.5 звезды за 1 RUB
                        </p>
                    </div>
                </div>

                <!-- CryptoBot -->
                <div
                    class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col h-full">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">currency_bitcoin</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">CryptoBot</h4>
                    </div>
                    <div>
                        <label
                            class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">CryptoBot
                            Token</label>
                        <div class="relative group">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">key</span>
                            <input type="password" name="cryptobot_token" value="{{ settings.cryptobot_token or '' }}"
                                class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                        </div>
                    </div>
                </div>

            </div> <!-- End Grid -->

            <!-- YooMoney Full Width -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md">
                <div class="flex items-center justify-between gap-2 mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">YooMoney (кошелёк)</h4>
                    </div>
                    <div class="flex items-center gap-2 bg-black/20 rounded-xl px-3 py-1.5 border border-white/5">
                        <input type="hidden" name="yoomoney_enabled" value="false" />
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="yoomoney_enabled" value="true" id="yoomoney_enabled" {% if
                                settings.yoomoney_enabled=='true' %}checked{% endif %} class="sr-only peer" />
                            <div
                                class="w-9 h-5 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                            </div>
                        </label>
                        <span class="text-[10px] font-bold text-white/60 uppercase ml-1">ВКЛ</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Номер
                                кошелька</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">credit_card</span>
                                <input type="text" name="yoomoney_wallet" value="{{ settings.yoomoney_wallet or '' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Секрет
                                HTTP-уведомлений</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">security</span>
                                <input type="password" name="yoomoney_secret"
                                    value="{{ settings.yoomoney_secret or '' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">API
                                Token (OAuth)</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">token</span>
                                <input type="password" name="yoomoney_api_token"
                                    value="{{ settings.yoomoney_api_token or '' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Client
                                ID</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">badge</span>
                                <input type="text" name="yoomoney_client_id"
                                    value="{{ settings.yoomoney_client_id or '' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Client
                                Secret</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">vpn_key</span>
                                <input type="password" name="yoomoney_client_secret"
                                    value="{{ settings.yoomoney_client_secret or '' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Redirect
                                URI</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/20 text-sm group-focus-within:text-primary transition-colors">link</span>
                                <input type="url" name="yoomoney_redirect_uri"
                                    value="{{ settings.yoomoney_redirect_uri or '' }}" placeholder="https://..."
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-10 pr-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-3 pt-4 border-t border-white/5">
                        <a href="{{ url_for('yoomoney_connect_route') }}"
                            class="px-5 py-2 rounded-xl bg-primary text-background-dark text-xs font-bold uppercase tracking-widest hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">link</span>
                            Подключить OAuth
                        </a>
                        <button type="submit" formmethod="post" formaction="{{ url_for('yoomoney_check_route') }}"
                            class="px-5 py-2 rounded-xl bg-white/5 text-white/70 text-xs font-bold uppercase tracking-widest hover:bg-white/10 transition-all border border-white/10 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">verified_user</span>
                            Проверить токен
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div class="bg-black/20 rounded-lg px-3 py-2 border border-white/5">
                            <p class="text-[9px] text-white/40 uppercase tracking-widest leading-tight">Webhook URL:</p>
                            <p class="text-[10px] text-primary/80 font-mono mt-0.5 truncate">{{ base_url
                                }}/yoomoney-webhook</p>
                        </div>
                        <div class="bg-black/20 rounded-lg px-3 py-2 border border-white/5">
                            <p class="text-[9px] text-white/40 uppercase tracking-widest leading-tight">Callback URI:
                            </p>
                            <p class="text-[10px] text-primary/80 font-mono mt-0.5 truncate">{{ base_url
                                }}/yoomoney/callback</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    </section>

</form>


<section id="tab-hosts" class="tab-content hidden">
    <div class="space-y-6">

        <!-- ===== ДОБАВЛЕНИЕ НОВОГО ХОСТА ===== -->
        <!-- Форма для подключения новой панели Remnawave -->
        <div
            class="bg-white/5 border border-white/10 rounded-xl overflow-hidden shadow-2xl backdrop-blur-md transition-all">
            <div class="flex items-center justify-between px-6 py-4 cursor-pointer hover:bg-white/[0.02] active:bg-white/[0.05] transition-colors"
                onclick="toggleAddHostForm()">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-2xl">add_circle</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white leading-none">Добавить новый хост</h3>
                        <p class="text-white/40 text-xs mt-1">Подключите ещё одну панель Remnawave в ваш бот</p>
                    </div>
                </div>
                <span id="add-host-icon"
                    class="material-symbols-outlined text-white/30 transition-transform duration-300 transform">expand_more</span>
            </div>

            <div id="add-host-form" class="hidden border-t border-white/10 bg-black/20">
                <form action="{{ url_for('add_host_route') }}" method="post" class="p-6">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1.5">
                            <label class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Название
                                хоста</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">badge</span>
                                <input type="text" name="host_name" placeholder="server1" required
                                    class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Базовый
                                URL Remnawave</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">link</span>
                                <input type="url" name="remnawave_base_url" placeholder="https://panel.example.com"
                                    required autocomplete="off"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">API
                                Token</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">key</span>
                                <input type="password" name="remnawave_api_token" placeholder="••••••••••••••••"
                                    required autocomplete="new-password"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Squad
                                UUID (опционально)</label>
                            <div class="relative group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">grid_view</span>
                                <input type="text" name="squad_uuid" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit"
                            class="group relative px-8 py-3 rounded-xl bg-primary text-background-dark font-bold overflow-hidden transition-all hover:scale-[1.02] active:scale-[0.98]">
                            <span class="relative z-10 flex items-center gap-2">
                                <span class="material-symbols-outlined text-lg">add</span>
                                Сохранить хост
                            </span>
                            <div
                                class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- ===== Конец добавления хоста ===== -->


        <div id="hosts-grid-container" class="space-y-4">
            {% if hosts %}
            {% for host in hosts %}
            <div class="host-card group relative bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-xl backdrop-blur-md"
                draggable="true" data-host-name="{{ host.host_name }}">

                <!-- Card Header -->
                <div class="flex items-center justify-between px-6 py-4 bg-white/[0.02] border-b border-white/10">
                    <div class="flex items-center gap-4 cursor-pointer flex-1"
                        onclick="toggleHostContent('{{ host.host_name }}')">
                        <div class="flex items-center gap-2">
                            <span
                                class="material-symbols-outlined text-white/20 cursor-grab active:cursor-grabbing hover:text-white/60 drag-handle transition-colors"
                                onclick="event.stopPropagation()">drag_indicator</span>
                            <div
                                class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary group-hover:bg-primary/20 transition-colors">
                                <span class="material-symbols-outlined">dns</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="text-lg font-bold text-white tracking-tight">{{ host.host_name }}</h4>
                                <span id="host-icon-{{ host.host_name }}"
                                    class="material-symbols-outlined text-white/30 text-sm transition-transform duration-300">expand_more</span>
                            </div>
                            <p class="text-white/40 text-[10px] uppercase font-bold tracking-widest mt-0.5">Remnawave
                                Host</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-2" onclick="event.stopPropagation();">
                        <form action="{{ url_for('toggle_host_visibility_route', host_name=host.host_name) }}"
                            method="post" class="inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            {% if host.see is none or host.see == 1 %}
                            <input type="hidden" name="visible" value="0" />
                            <button type="submit"
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-yellow-500/10 text-yellow-500 text-xs font-bold hover:bg-yellow-500/20 transition-all">
                                <span class="material-symbols-outlined text-sm">visibility_off</span>
                                Скрыть
                            </button>
                            {% else %}
                            <input type="hidden" name="visible" value="1" />
                            <button type="submit"
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-500/10 text-green-500 text-xs font-bold hover:bg-green-500/20 transition-all">
                                <span class="material-symbols-outlined text-sm">visibility</span>
                                Показать
                            </button>
                            {% endif %}
                        </form>
                        <form action="{{ url_for('delete_host_route', host_name=host.host_name) }}" method="post"
                            class="inline" data-confirm="Удалить хост {{ host.host_name }} и все его тарифы?">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit"
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-500/10 text-red-500 text-xs font-bold hover:bg-red-500/20 transition-all">
                                <span class="material-symbols-outlined text-sm">delete</span>
                                Удалить
                            </button>
                        </form>
                    </div>
                </div>

                <div id="host-content-{{ host.host_name }}" class="hidden p-6 space-y-6 bg-black/20">


                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- URL Panel -->
                        <form action="{{ url_for('update_host_url_route') }}" method="post"
                            class="bg-white/5 border border-white/10 rounded-xl p-4 flex flex-col justify-between group/tile">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                            <div class="flex items-center gap-2 mb-3">
                                <span class="material-symbols-outlined text-primary text-sm">link</span>
                                <label class="text-white/70 text-[10px] font-bold uppercase tracking-wider">URL
                                    Панели</label>
                            </div>
                            <div class="space-y-2 mt-auto">
                                <input type="text" name="host_url" value="{{ host.host_url or '' }}"
                                    placeholder="https://panel.example.com"
                                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 focus:outline-none transition-all" />
                                <button type="submit"
                                    class="w-full py-2 rounded-lg bg-white/5 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all">Сохранить</button>
                            </div>
                        </form>

                        <!-- Rename Host -->
                        <form action="{{ url_for('rename_host_route') }}" method="post"
                            class="bg-white/5 border border-white/10 rounded-xl p-4 flex flex-col justify-between group/tile">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="old_host_name" value="{{ host.host_name }}" />
                            <div class="flex items-center gap-2 mb-3">
                                <span class="material-symbols-outlined text-primary text-sm">badge</span>
                                <label class="text-white/70 text-[10px] font-bold uppercase tracking-wider">Имя
                                    хоста</label>
                            </div>
                            <div class="space-y-2 mt-auto">
                                <input type="text" name="new_host_name" value="{{ host.host_name }}"
                                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 focus:outline-none transition-all" />
                                <button type="submit"
                                    class="w-full py-2 rounded-lg bg-white/5 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all">Сменить
                                    имя</button>
                            </div>
                        </form>

                        <!-- Subscription URL -->
                        <form action="{{ url_for('update_host_subscription_route') }}" method="post"
                            class="bg-white/5 border border-white/10 rounded-xl p-4 flex flex-col justify-between group/tile">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                            <div class="flex items-center gap-2 mb-3">
                                <span class="material-symbols-outlined text-primary text-sm">notifications</span>
                                <label class="text-white/70 text-[10px] font-bold uppercase tracking-wider">URL
                                    Подписки</label>
                            </div>
                            <div class="space-y-2 mt-auto">
                                <input type="text" name="host_subscription_url"
                                    value="{{ host.subscription_url or '' }}" placeholder="URL для подписки"
                                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 focus:outline-none transition-all" />
                                <button type="submit"
                                    class="w-full py-2 rounded-lg bg-white/5 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all">Сохранить</button>
                            </div>
                        </form>

                        <!-- Traffic Strategy -->
                        <form action="{{ url_for('update_host_traffic_settings_route') }}" method="post"
                            class="bg-white/5 border border-white/10 rounded-xl p-4 flex flex-col justify-between group/tile">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                            <input type="hidden" name="traffic_limit_strategy"
                                id="traffic_limit_strategy_input_{{ host.host_name }}"
                                value="{{ host.default_traffic_strategy }}" />

                            <div class="flex items-center gap-2 mb-3">
                                <span class="material-symbols-outlined text-primary text-sm">restart_alt</span>
                                <label class="text-white/70 text-[10px] font-bold uppercase tracking-wider">Сброс
                                    трафика</label>
                            </div>

                            <div class="space-y-2 mt-auto">
                                <div class="relative w-full group/select" tabindex="0">
                                    {% set current_strategy = host.default_traffic_strategy or 'NO_RESET' %}
                                    {% set strategy_labels = {'NO_RESET': 'Никогда', 'DAY': 'Ежедневно', 'WEEK':
                                    'Еженедельно', 'MONTH': 'Ежемесячно'} %}
                                    <div
                                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-xs flex items-center justify-between cursor-pointer hover:bg-white/10">
                                        <span id="strategy_label_{{ host.host_name }}">{{
                                            strategy_labels[current_strategy] }}</span>
                                        <span
                                            class="material-symbols-outlined text-white/30 text-[16px]">expand_more</span>
                                    </div>
                                    <div
                                        class="absolute z-50 bottom-full left-0 right-0 mb-1 bg-[#1a2f24] border border-white/10 rounded-xl shadow-2xl overflow-hidden hidden group-focus-within/select:block">
                                        <div class="p-1">
                                            {% for key, lbl in strategy_labels.items() %}
                                            <div onclick="selectTrafficStrategy('{{ host.host_name }}', '{{ key }}', '{{ lbl }}')"
                                                class="px-3 py-2 rounded-lg text-white text-xs hover:bg-primary hover:text-background-dark cursor-pointer transition-colors">
                                                {{ lbl }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <button type="submit"
                                    class="w-full py-2 rounded-lg bg-white/5 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all">Применить</button>
                            </div>
                        </form>
                    </div>


                    <!-- SSH for Speedtest -->
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                                <span class="material-symbols-outlined text-lg">terminal</span>
                            </div>
                            <h5 class="text-white font-bold text-sm tracking-tight">SSH Настройки (Speedtest)</h5>
                        </div>

                        <form action="{{ url_for('update_host_ssh_route') }}" method="post" class="space-y-4">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="block text-white/40 text-[10px] uppercase font-bold tracking-wider ml-1">Host</label>
                                    <input type="text" name="ssh_host" value="{{ host.ssh_host or '' }}"
                                        placeholder="example.com" autocomplete="off"
                                        class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                </div>
                                <div class="space-y-1">
                                    <label
                                        class="block text-white/40 text-[10px] uppercase font-bold tracking-wider ml-1">Port</label>
                                    <input type="number" name="ssh_port" value="{{ host.ssh_port or '' }}"
                                        placeholder="22"
                                        class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                </div>
                                <div class="space-y-1">
                                    <label
                                        class="block text-white/40 text-[10px] uppercase font-bold tracking-wider ml-1">User</label>
                                    <input type="text" name="ssh_user" value="{{ host.ssh_user or '' }}"
                                        placeholder="root" autocomplete="off"
                                        class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                </div>
                                <div class="space-y-1">
                                    <label
                                        class="block text-white/40 text-[10px] uppercase font-bold tracking-wider ml-1">Password</label>
                                    <input type="password" name="ssh_password" value="{{ host.ssh_password or '' }}"
                                        placeholder="••••••" autocomplete="new-password"
                                        class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                </div>
                            </div>
                            <div class="flex flex-col md:flex-row gap-4 items-end">
                                <div class="flex-1 w-full space-y-1">
                                    <label
                                        class="block text-white/40 text-[10px] uppercase font-bold tracking-wider ml-1">Путь
                                        к ключу</label>
                                    <input type="text" name="ssh_key_path" value="{{ host.ssh_key_path or '' }}"
                                        placeholder="/app/keys/id_rsa"
                                        class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                </div>
                                <button type="submit"
                                    class="w-full md:w-auto px-6 py-2.5 rounded-xl bg-primary/20 text-primary text-xs font-bold uppercase tracking-widest hover:bg-primary/30 transition-all border border-primary/20">Сохранить</button>
                            </div>
                        </form>
                        <form action="{{ url_for('auto_install_speedtest_route', host_name=host.host_name) }}"
                            method="post" class="mt-4 pt-4 border-t border-white/5">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit"
                                class="speedtest-loading-btn w-full md:w-auto px-5 py-2 rounded-lg bg-white/5 text-white/50 text-[10px] font-bold uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all border border-white/10"
                                data-label="Автоустановка Speedtest">
                                <span class="flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined text-sm">rocket_launch</span>
                                    Автоустановка Speedtest
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- Description -->
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-5">
                        <label class="flex items-center justify-between cursor-pointer group/toggle">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400">
                                    <span class="material-symbols-outlined text-lg">description</span>
                                </div>
                                <div>
                                    <h5 class="text-white font-bold text-sm tracking-tight">Свое описание (HTML)</h5>
                                    <p class="text-white/40 text-[10px]">Отображается в меню выбора тарифа</p>
                                </div>
                            </div>
                            <div class="relative inline-flex items-center">
                                <input type="checkbox" id="toggle-description-{{ host.host_name }}"
                                    onchange="toggleDescriptionForm('{{ host.host_name }}')" class="sr-only peer" {% if
                                    host.description %}checked{% endif %} />
                                <div
                                    class="w-9 h-5 bg-white/10 rounded-full peer peer-checked:bg-primary transition-all after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full">
                                </div>
                            </div>
                        </label>
                        <div id="description-form-{{ host.host_name }}"
                            class="{% if not host.description %}hidden{% endif %} mt-4 pt-4 border-t border-white/5">
                            <form action="{{ url_for('update_host_description_route') }}" method="post"
                                class="space-y-3">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="host_name" value="{{ host.host_name }}" />
                                <textarea name="host_description" rows="3"
                                    placeholder="Введите HTML-описание для этого хоста..."
                                    class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white text-xs focus:outline-none focus:ring-1 focus:ring-primary/40 transition-all font-mono">{{ host.description or '' }}</textarea>
                                <div class="flex justify-end">
                                    <button type="submit"
                                        class="px-5 py-2 rounded-xl bg-white/5 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-primary hover:text-background-dark transition-all border border-white/10">Сохранить
                                        описание</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Plans -->
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-5">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center text-green-400">
                                    <span class="material-symbols-outlined text-lg">category</span>
                                </div>
                                <h5 class="text-white font-bold text-sm tracking-tight">Тарифы хоста</h5>
                            </div>
                            <span
                                class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-white/40 text-[10px] font-bold">{{
                                host.plans|length }} тарифа(ов)</span>
                        </div>

                        {% if host.plans %}
                        <div id="plans-grid-{{ host.host_name }}"
                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                            {% for plan in host.plans %}
                            <div id="plan-card-{{ plan.plan_id }}"
                                class="bg-black/30 border border-white/10 rounded-2xl p-4 group/plan relative overflow-hidden">


                                <!-- View State -->
                                <div id="view-plan-{{ plan.plan_id }}" class="flex flex-col h-full relative z-10">
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-3">
                                            <h6
                                                class="text-white font-bold text-sm leading-tight pr-2 group-hover/plan:text-primary transition-colors">
                                                {{ plan.plan_name }}</h6>
                                            <div
                                                class="px-2 py-1 rounded-lg bg-primary/10 text-primary font-bold text-xs ring-1 ring-primary/20">
                                                {{ plan.price|round(0) }}₽
                                            </div>
                                        </div>
                                        <div class="flex flex-wrap gap-x-2 gap-y-1 justify-center">
                                            <div
                                                class="flex items-center gap-1 text-white/40 text-[10px] font-bold uppercase tracking-tight bg-white/5 px-1.5 py-0.5 rounded-md">
                                                <span
                                                    class="material-symbols-outlined text-[12px]">calendar_today</span>
                                                {{ plan.months }} м
                                            </div>
                                            <div
                                                class="flex items-center gap-1 text-white/40 text-[10px] font-bold uppercase tracking-tight bg-white/5 px-1.5 py-0.5 rounded-md">
                                                <span class="material-symbols-outlined text-[12px]">data_usage</span>
                                                {{ plan.traffic_limit_gb or '∞' }} G
                                            </div>
                                            <div
                                                class="flex items-center gap-1 text-white/40 text-[10px] font-bold uppercase tracking-tight bg-white/5 px-1.5 py-0.5 rounded-md">
                                                <span class="material-symbols-outlined text-[12px]">devices</span>
                                                {{ plan.hwid_limit or '∞' }} HWID
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-2 mt-4 pt-4 border-t border-white/5">
                                        <button type="button"
                                            class="px-2 py-2 rounded-xl bg-white/5 text-white/60 text-[10px] font-bold uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all"
                                            onclick="document.getElementById('view-plan-{{ plan.plan_id }}').classList.add('hidden'); document.getElementById('edit-plan-{{ plan.plan_id }}').classList.remove('hidden')">
                                            Изменить
                                        </button>
                                        <form action="{{ url_for('delete_plan_route', plan_id=plan.plan_id) }}"
                                            method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                            <button type="submit"
                                                class="w-full px-2 py-2 rounded-xl bg-red-500/10 text-red-500/70 text-[10px] font-bold uppercase tracking-widest hover:bg-red-500/20 hover:text-red-500 transition-all">
                                                Удалить
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                <!-- Edit State -->
                                <div id="edit-plan-{{ plan.plan_id }}"
                                    class="hidden flex flex-col h-full relative z-10">
                                    <form action="{{ url_for('update_plan_route', plan_id=plan.plan_id) }}"
                                        method="post" class="flex flex-col h-full gap-2">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                        <div class="space-y-1">
                                            <input type="text" name="plan_name" value="{{ plan.plan_name }}"
                                                placeholder="Название" required
                                                class="w-full bg-black/40 border border-white/10 rounded-lg px-2 py-1.5 text-white text-[11px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <input type="number" name="months" value="{{ plan.months }}"
                                                placeholder="Мес." required
                                                class="bg-black/40 border border-white/10 rounded-lg px-2 py-1.5 text-white text-[11px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                            <input type="number" name="price" value="{{ plan.price }}"
                                                placeholder="Цена" required
                                                class="bg-black/40 border border-white/10 rounded-lg px-2 py-1.5 text-white text-[11px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <input type="number" name="traffic_limit_gb"
                                                value="{{ plan.traffic_limit_gb }}" placeholder="GB (0=∞)"
                                                class="bg-black/40 border border-white/10 rounded-lg px-2 py-1.5 text-white text-[11px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                            <input type="number" name="hwid_limit" value="{{ plan.hwid_limit }}"
                                                placeholder="HWID"
                                                class="bg-black/40 border border-white/10 rounded-lg px-2 py-1.5 text-white text-[11px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 mt-auto pt-2">
                                            <button type="submit"
                                                class="py-1.5 rounded-lg bg-primary text-background-dark text-[10px] font-bold uppercase tracking-widest hover:scale-[1.02] transition-all">ОК</button>
                                            <button type="button"
                                                class="py-1.5 rounded-lg bg-white/10 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-white/20 transition-all"
                                                onclick="document.getElementById('edit-plan-{{ plan.plan_id }}').classList.add('hidden'); document.getElementById('view-plan-{{ plan.plan_id }}').classList.remove('hidden')">Отмена</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="bg-white/[0.02] border border-white/5 rounded-2xl p-8 text-center mb-6">
                            <span class="material-symbols-outlined text-white/10 text-4xl mb-2">inventory_2</span>
                            <p class="text-white/30 text-xs tracking-wide">Для этого хоста пока нет тарифов</p>
                        </div>
                        {% endif %}

                        <!-- Add Plan Form -->
                        <div class="bg-white/[0.03] border border-white/5 rounded-2xl p-5 border-dashed">
                            <form action="{{ url_for('add_plan_route') }}" method="post"
                                class="flex flex-col lg:flex-row items-end gap-4">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="host_name" value="{{ host.host_name }}" />

                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 flex-1 w-full">
                                    <div class="space-y-1">
                                        <label
                                            class="text-white/30 text-[9px] font-bold uppercase tracking-wider ml-1">Название</label>
                                        <input type="text" name="plan_name" placeholder="Pro Plan" required
                                            class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-2 focus:ring-primary/40 focus:outline-none transition-all placeholder:text-white/10" />
                                    </div>
                                    <div class="space-y-1">
                                        <label
                                            class="text-white/30 text-[9px] font-bold uppercase tracking-wider ml-1">Месяцев</label>
                                        <input type="number" name="months" placeholder="12" required
                                            class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-2 focus:ring-primary/40 focus:outline-none transition-all placeholder:text-white/10" />
                                    </div>
                                    <div class="space-y-1">
                                        <label
                                            class="text-white/30 text-[9px] font-bold uppercase tracking-wider ml-1">Цена
                                            (₽)</label>
                                        <input type="number" name="price" placeholder="500" required
                                            class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-2 focus:ring-primary/40 focus:outline-none transition-all placeholder:text-white/10" />
                                    </div>
                                    <div class="space-y-1">
                                        <label
                                            class="text-white/30 text-[9px] font-bold uppercase tracking-wider ml-1">Трафик
                                            (GB)</label>
                                        <input type="number" name="traffic_limit_gb" placeholder="100"
                                            class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-2 focus:ring-primary/40 focus:outline-none transition-all placeholder:text-white/10" />
                                    </div>
                                    <div class="space-y-1">
                                        <label
                                            class="text-white/30 text-[9px] font-bold uppercase tracking-wider ml-1">HWID</label>
                                        <input type="number" name="hwid_limit" placeholder="1"
                                            class="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-2 focus:ring-primary/40 focus:outline-none transition-all placeholder:text-white/10" />
                                    </div>
                                </div>

                                <button type="submit"
                                    class="h-[38px] px-6 rounded-xl bg-primary text-background-dark font-bold text-[10px] uppercase tracking-widest hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center gap-2 whitespace-nowrap">
                                    <span class="material-symbols-outlined text-sm">add</span>
                                    Добавить
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="bg-white/5 border border-white/10 rounded-lg p-8 text-center">
                <span class="material-symbols-outlined text-4xl text-white/30 mb-2">dns</span>
                <p class="text-white/50">Хосты ещё не добавлены.</p>
            </div>
            {% endif %}
        </div>


        <div class="border-t border-white/10 pt-6">
            <h3 class="text-xl font-bold text-white mb-4">SSH цели для Speedtest & Ноды <span
                    class="text-white/30 text-xs ml-2 font-normal">(не зависят от хостов)</span></h3>


            <!-- ===== ДОБАВЛЕНИЕ НОВОЙ SSH-ЦЕЛИ ===== -->
            <div
                class="bg-white/5 border border-white/10 rounded-xl overflow-hidden shadow-2xl backdrop-blur-md transition-all mb-6">
                <div class="flex items-center justify-between px-6 py-4 cursor-pointer hover:bg-white/[0.02] active:bg-white/[0.05] transition-colors"
                    onclick="document.getElementById('add-ssh-form').classList.toggle('hidden'); document.getElementById('add-ssh-icon').classList.toggle('rotate-180')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                            <span class="material-symbols-outlined text-2xl">terminal</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white leading-none">Добавить SSH-цель</h3>
                            <p class="text-white/40 text-xs mt-1">Подключите сервер для тестирования скорости Speedtest
                            </p>
                        </div>
                    </div>
                    <span id="add-ssh-icon"
                        class="material-symbols-outlined text-white/30 transition-transform duration-300 transform">expand_more</span>
                </div>

                <div id="add-ssh-form" class="hidden border-t border-white/10 bg-black/20">
                    <form action="{{ url_for('create_ssh_target_route') }}" method="post" class="p-6">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                            <div class="space-y-1.5">
                                <label
                                    class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Название
                                    цели</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">label</span>
                                    <input type="text" name="target_name" placeholder="Server 1" required
                                        class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                                </div>
                            </div>
                            <div class="space-y-1.5">
                                <label class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">SSH
                                    Host</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">dns</span>
                                    <input type="text" name="ssh_host" placeholder="1.2.3.4" required autocomplete="off"
                                        class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                                </div>
                            </div>
                            <div class="space-y-1.5">
                                <label
                                    class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Порт</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">settings_ethernet</span>
                                    <input type="number" name="ssh_port" value="22" required
                                        class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                                </div>
                            </div>
                            <div class="space-y-1.5">
                                <label
                                    class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Пользователь</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">person</span>
                                    <input type="text" name="ssh_user" value="root" required autocomplete="off"
                                        class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                                </div>
                            </div>
                            <div class="space-y-1.5">
                                <label
                                    class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Пароль
                                    (опционально)</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">key</span>
                                    <input type="password" name="ssh_password" placeholder="••••••••"
                                        autocomplete="new-password"
                                        class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                                </div>
                            </div>
                            <div class="space-y-1.5 md:col-span-2 lg:col-span-2">
                                <label class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Путь
                                    к ключу (опционально)</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">vpn_key</span>
                                    <input type="text" name="ssh_key_path" placeholder="/app/keys/id_rsa"
                                        class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                                </div>
                            </div>
                            <div class="space-y-1.5 lg:col-span-1">
                                <label
                                    class="block text-white/70 text-xs font-bold uppercase tracking-wider ml-1">Описание</label>
                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-primary transition-colors text-sm">description</span>
                                    <input type="text" name="description" placeholder="Европа"
                                        class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white text-sm placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all" />
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button type="submit"
                                class="group relative px-8 py-3 rounded-xl bg-primary text-background-dark font-bold overflow-hidden transition-all hover:scale-[1.02] active:scale-[0.98]">
                                <span class="relative z-10 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">add</span>
                                    Создать SSH-цель
                                </span>
                                <div
                                    class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                </div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- ===== КОНЕЦ ДОБАВЛЕНИЯ SSH-ЦЕЛИ ===== -->


            {% if ssh_targets %}
            <div id="ssh-targets-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {% for t in ssh_targets %}
                <div class="ssh-target-card relative bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-xl backdrop-blur-md group flex flex-col h-full"
                    draggable="true" data-target-name="{{ t.target_name }}">

                    <!-- Card Header -->
                    <div class="flex items-center justify-between px-4 py-2 bg-white/[0.02] border-b border-white/10">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <span
                                class="material-symbols-outlined text-white/20 cursor-grab active:cursor-grabbing hover:text-white/60 drag-handle transition-colors"
                                onclick="event.stopPropagation()">drag_indicator</span>
                            <div class="min-w-0">
                                <h4 class="text-xs font-bold text-white truncate">{{ t.target_name }}</h4>
                                <p class="text-[8px] text-white/30 uppercase font-bold tracking-widest">SSH Target</p>
                            </div>
                        </div>

                        <form action="{{ url_for('delete_ssh_target_route', target_name=t.target_name) }}" method="post"
                            data-confirm="Удалить SSH-цель '{{ t.target_name }}'?" class="ml-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit"
                                class="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-500/10 text-red-500/50 hover:text-red-500 transition-all">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </form>
                    </div>

                    <div class="p-4 flex-1 flex flex-col justify-between bg-black/10">
                        <!-- Info Grid -->
                        <div class="space-y-2">
                            <div class="bg-black/20 border border-white/5 rounded-xl p-2.5">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <span class="material-symbols-outlined text-primary text-[12px]">dns</span>
                                    <label
                                        class="text-white/30 text-[8px] font-bold uppercase tracking-wider">Host:Port</label>
                                </div>
                                <p class="text-white/90 text-[11px] font-mono ml-5 truncate">{{ t.ssh_host }}:{{
                                    t.ssh_port or 22 }}</p>
                            </div>

                            {% if t.description %}
                            <div class="bg-black/20 border border-white/5 rounded-xl p-2.5">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <span class="material-symbols-outlined text-primary text-[12px]">description</span>
                                    <label
                                        class="text-white/30 text-[8px] font-bold uppercase tracking-wider">Описание</label>
                                </div>
                                <p class="text-white/60 text-[11px] ml-5 truncate">{{ t.description }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Actions -->
                        <div class="space-y-1.5 pt-4 mt-auto">
                            <form action="{{ url_for('run_ssh_target_speedtest_route', target_name=t.target_name) }}"
                                method="post" class="w-full">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <button type="submit"
                                    class="speedtest-loading-btn w-full px-4 py-2 rounded-xl bg-blue-500/20 text-blue-400 text-[10px] font-bold uppercase tracking-widest hover:bg-blue-500/30 transition-all flex items-center justify-center gap-2 border border-blue-500/10"
                                    data-label="Тест">
                                    <span class="material-symbols-outlined text-sm">speed</span>
                                    Тест скорости
                                </button>
                            </form>

                            <div class="grid grid-cols-2 gap-1.5">
                                <button type="button"
                                    class="ssh-edit-btn px-3 py-1.5 rounded-xl bg-white/5 text-white/50 text-[9px] font-bold uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all border border-white/5"
                                    data-target="{{ t.target_name }}">
                                    <span class="flex items-center justify-center gap-1">
                                        <span class="material-symbols-outlined text-xs">edit</span>
                                        Правка
                                    </span>
                                </button>
                                <form
                                    action="{{ url_for('auto_install_speedtest_on_target_route', target_name=t.target_name) }}"
                                    method="post">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <button type="submit"
                                        class="speedtest-loading-btn w-full px-3 py-1.5 rounded-xl bg-white/5 text-white/40 text-[9px] font-bold uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all border border-white/5"
                                        data-label="Setup">
                                        <span class="flex items-center justify-center gap-1">
                                            <span class="material-symbols-outlined text-xs">settings</span>
                                            Setup Seed
                                        </span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Edit Form (Hidden by default) -->
                        <div id="edit-ssh-{{ t.target_name }}" class="hidden pt-3 border-t border-white/5">
                            <form action="{{ url_for('update_ssh_target_route', target_name=t.target_name) }}"
                                method="post" class="space-y-2">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="col-span-2 space-y-1">
                                        <input type="text" name="new_target_name" value="{{ t.target_name }}"
                                            placeholder="Имя" required
                                            class="w-full bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                    </div>
                                    <div class="col-span-2 space-y-1">
                                        <input type="text" name="ssh_host" value="{{ t.ssh_host or '' }}"
                                            placeholder="IP" required autocomplete="off"
                                            class="w-full bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                    </div>
                                    <input type="number" name="ssh_port" value="{{ t.ssh_port or '' }}"
                                        placeholder="Порт"
                                        class="bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px]" />
                                    <input type="text" name="ssh_user" value="{{ t.ssh_user or '' }}" placeholder="Юзер"
                                        autocomplete="off"
                                        class="bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px]" />
                                    <div class="col-span-2 relative">
                                        <input type="password" name="ssh_password" id="pass-{{ t.target_name }}"
                                            value="{{ t.ssh_password or '' }}" placeholder="Пароль"
                                            autocomplete="new-password"
                                            class="w-full bg-black/30 border border-white/10 rounded-xl pl-2 pr-8 py-1.5 text-white text-[10px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                        <button type="button"
                                            onclick="togglePasswordVisibility('pass-{{ t.target_name }}')"
                                            class="absolute right-2 top-1/2 -translate-y-1/2 text-white/30 hover:text-white transition-colors">
                                            <span class="material-symbols-outlined text-[14px]">visibility</span>
                                        </button>
                                    </div>
                                    <div class="col-span-2 space-y-1">
                                        <input type="text" name="description" value="{{ t.description or '' }}"
                                            placeholder="Описание"
                                            class="w-full bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 pt-1 border-t border-white/5">
                                    <button type="submit"
                                        class="py-1.5 rounded-lg bg-primary text-background-dark text-[10px] font-bold uppercase tracking-widest hover:scale-[1.02] transition-all">ОК</button>
                                    <button type="button"
                                        class="ssh-cancel-btn py-1.5 rounded-lg bg-white/10 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-white/20 transition-all"
                                        data-target="{{ t.target_name }}">Отмена</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-white/5 border border-white/10 rounded-lg p-8 text-center">
                <span class="material-symbols-outlined text-4xl text-white/30 mb-2">dns</span>
                <p class="text-white/50">SSH-цели не добавлены.</p>
            </div>
            {% endif %}
        </div>
</section>


<form action="{{ url_for('settings_page') }}" method="post" id="settings-form-part2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="next_hash" id="settings-next-hash-part2" value="referrals" />


    <section id="tab-referrals" class="tab-content hidden">
        <div class="space-y-6">
            <!-- Header Card -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                            <span class="material-symbols-outlined text-3xl">group_add</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white tracking-tight">Реферальная система</h3>
                            <p class="text-white/60 text-xs font-medium">Управляйте условиями партнерской программы</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-black/20 rounded-xl px-4 py-2 border border-white/5">
                        <span class="text-xs font-bold uppercase tracking-widest text-white/60">Статус системы</span>
                        <input type="hidden" name="enable_referrals" value="false" />
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="enable_referrals" value="true" id="enable_referrals" {% if
                                settings.enable_referrals=='true' %}checked{% endif %} class="sr-only peer" />
                            <div
                                class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Main Settings Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Reward Logic Card -->
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">payments</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Логика вознаграждения</h4>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Тип
                                начисления</label>
                            <div class="soft-select" data-target="referral_reward_type">
                                <button type="button"
                                    class="soft-select-toggle w-full text-left bg-black/30 border border-white/10 rounded-xl px-3 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 transition-all font-medium"
                                    id="referral_reward_type_toggle">
                                    {% set ref_type = settings.referral_reward_type or 'percent_purchase' %}
                                    {% if ref_type == 'percent_purchase' %}Процент с покупки
                                    {% elif ref_type == 'fixed_purchase' %}Фиксированная сумма
                                    {% elif ref_type == 'fixed_start_referrer' %}Бонус за старт
                                    {% endif %}
                                </button>
                                <div class="soft-select-menu" id="referral_reward_type_menu"></div>
                                <select name="referral_reward_type" id="referral_reward_type" class="hidden">
                                    <option value="percent_purchase" {% if (settings.referral_reward_type
                                        or 'percent_purchase' )=='percent_purchase' %}selected{% endif %}>Процент с
                                        покупки реферала</option>
                                    <option value="fixed_purchase" {% if settings.referral_reward_type=='fixed_purchase'
                                        %}selected{% endif %}>Фиксированная сумма за покупку</option>
                                    <option value="fixed_start_referrer" {% if
                                        settings.referral_reward_type=='fixed_start_referrer' %}selected{% endif %}>
                                        Бонус пригласившему при старте</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Мин.
                                сумма вывода</label>
                            <div class="relative group">
                                <input type="number" name="minimum_withdrawal"
                                    value="{{ settings.minimum_withdrawal or '10' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-3 pr-10 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 text-xs font-bold">RUB</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Values Card -->
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">trending_up</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Параметры и Бонусы</h4>
                    </div>

                    <div class="space-y-4">
                        <!-- Dynamic Section: Percent -->
                        <div data-ref-section="percent_purchase">
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Процент
                                рефереру</label>
                            <div class="relative group">
                                <input type="number" name="referral_percentage"
                                    value="{{ settings.referral_percentage or '10' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-3 pr-8 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 text-xs font-bold">%</span>
                            </div>
                        </div>

                        <!-- Dynamic Section: Fixed -->
                        <div data-ref-section="fixed_purchase">
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Бонус
                                за оплату</label>
                            <div class="relative group">
                                <input type="number" step="0.01" name="fixed_referral_bonus_amount"
                                    value="{{ settings.fixed_referral_bonus_amount or '50' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-3 pr-10 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 text-xs font-bold">RUB</span>
                            </div>
                        </div>

                        <!-- Dynamic Section: Start Bonus -->
                        <div data-ref-section="fixed_start_referrer">
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Бонус
                                за запуск</label>
                            <div class="relative group">
                                <input type="number" step="0.01" name="referral_on_start_referrer_amount"
                                    value="{{ settings.referral_on_start_referrer_amount or '20' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-3 pr-10 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 text-xs font-bold">RUB</span>
                            </div>
                        </div>

                        <!-- Discount for newbie (Always shown or only for purchase types?) - showing always as requested -->
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Скидка
                                рефералу</label>
                            <div class="relative group">
                                <input type="number" name="referral_discount"
                                    value="{{ settings.referral_discount or '5' }}"
                                    class="w-full bg-black/30 border border-white/10 rounded-xl pl-3 pr-8 py-2.5 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 text-xs font-bold">%</span>
                            </div>
                            <p class="text-[9px] text-white/40 mt-1 ml-1 leading-tight">Скидка новому пользователю на
                                первую покупку</p>
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" id="enable_fixed_referral_bonus" name="enable_fixed_referral_bonus"
                value="{% if settings.enable_fixed_referral_bonus == 'true' %}true{% else %}false{% endif %}" />
        </div>
    </section>
    </section>





    <section id="tab-content" class="tab-content hidden">
        <div class="space-y-6">
            <!-- Header Card -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10">
                        <span class="material-symbols-outlined text-3xl">article</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white tracking-tight">Настройки контента</h3>
                        <p class="text-white/60 text-xs font-medium">Управление текстами и медиафайлами в боте</p>
                    </div>
                </div>
            </div>

            <!-- Text Content Cards -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">edit_note</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Текстовые блоки</h4>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Текст
                                "О проекте"</label>
                            <textarea name="about_text" rows="3"
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all placeholder:text-white/10">{{ settings.about_text or '' }}</textarea>
                        </div>
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Текст
                                в разделе "Поддержка"</label>
                            <textarea name="support_text" rows="3"
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all placeholder:text-white/10">{{ settings.support_text or '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md flex flex-col">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">home</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Главное меню</h4>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-1.5 ml-1">Текст
                                главного меню</label>
                            <textarea name="main_menu_text" rows="3"
                                placeholder="🏠 <b>Главное меню</b>&#10;&#10;Выберите действие:"
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white text-sm focus:ring-1 focus:ring-primary/40 outline-none transition-all placeholder:text-white/10">{{ settings.main_menu_text or '' }}</textarea>
                        </div>

                        <div class="pt-2 border-t border-white/5">
                            <div class="flex items-center justify-between mb-3">
                                <label
                                    class="block text-white/60 text-[10px] uppercase font-bold tracking-wider ml-1">Изображение
                                    меню</label>
                                <button type="button"
                                    class="text-white/30 hover:text-primary transition-colors btn-copy-text flex items-center gap-1"
                                    data-copy-text="ГЛАВНОЕ МЕНЮ">
                                    <span class="material-symbols-outlined text-xs">content_copy</span>
                                    <span class="text-[9px] uppercase font-bold">Copy Tag</span>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <input type="text" id="main_menu_image_url" value="{{ settings.main_menu_image or '' }}"
                                    readonly
                                    class="w-full bg-black/50 border border-white/5 rounded-xl px-3 py-2 text-white/40 text-[10px] font-mono" />
                                <div class="flex gap-2">
                                    <button type="button"
                                        class="btn-upload-menu-image flex-1 py-2 rounded-xl bg-primary/20 text-primary text-[10px] font-bold uppercase tracking-widest hover:bg-primary/30 transition-all border border-primary/10 flex items-center justify-center gap-2"
                                        data-section="main_menu">
                                        <span class="material-symbols-outlined text-sm">upload</span> UP
                                    </button>
                                    <button type="button"
                                        class="btn-delete-menu-image flex-1 py-2 rounded-xl bg-red-500/10 text-red-500/70 text-[10px] font-bold uppercase tracking-widest hover:bg-red-500/20 transition-all border border-red-500/10 flex items-center justify-center gap-2"
                                        data-section="main_menu">
                                        <span class="material-symbols-outlined text-sm">delete</span> DEL
                                    </button>
                                </div>
                                <input type="file" id="main_menu_image_file" accept=".jpg,.jpeg,.png,.gif"
                                    class="hidden" data-section="main_menu" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Media Sections -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined">image</span>
                    </div>
                    <div>
                        <h4 class="text-white font-bold text-lg leading-none">Изображения разделов</h4>
                        <p class="text-white/40 text-xs mt-1">Визуальное оформление каждого этапа взаимодействия</p>
                    </div>
                </div>

                <div class="space-y-8">
                    <!-- Media Categories -->
                    {% set categories = [
                    {
                    'title': 'Инфо и Профиль',
                    'icon': 'info',
                    'color': 'primary',
                    'media': [
                    {'id': 'profile', 'label': 'Профиль', 'tag': 'ВАШ ПРОФИЛЬ', 'desc': 'Отображается при нажатии кнопки
                    "👤 Мой профиль"'},
                    {'id': 'support', 'label': 'Поддержка', 'tag': 'ТЕХ ПОДДЕРЖКА', 'desc': 'Отображается при нажатии
                    кнопки "🆘 Поддержка"'},
                    {'id': 'about', 'label': 'О проекте', 'tag': 'О СЕРВИСЕ', 'desc': 'Отображается при нажатии кнопки
                    "ℹ️ О боте"'},
                    {'id': 'speedtest', 'label': 'Speedtest', 'tag': 'ПРОВЕРКА СКОРОСТИ', 'desc': 'Экран замера скорости
                    (Speedtest)'},
                    {'id': 'howto', 'label': 'Инструкция', 'tag': 'ИНСТРУКЦИЯ ПО ПОДКЛЮЧЕНИЮ', 'desc': 'Инструкции для
                    разных устройств'},
                    {'id': 'referral', 'label': 'Рефералы', 'tag': 'ПАРТНЕРСКАЯ ПРОГРАММА', 'desc': 'Отображается при
                    нажатии "🤝 Реферальная система"'},
                    {'id': 'key_comments', 'label': 'Комменты', 'tag': 'КОММЕНТАРИИ К КЛЮЧУ', 'desc': 'Отображается в
                    меню комментариев к ключу'}
                    ]
                    },
                    {
                    'title': 'Процесс покупки',
                    'icon': 'shopping_cart',
                    'color': 'green-400',
                    'media': [
                    {'id': 'buy_server', 'label': 'Локации', 'tag': 'ВЫБОР ЛОКАЦИИ', 'desc': 'Шаг 1: Когда пользователь
                    нажал "Купить ключ" и выбирает страну/сервер'},
                    {'id': 'buy_plan', 'label': 'Тарифы', 'tag': 'ВЫБОР ТАРИФА', 'desc': 'Шаг 2: Когда пользователь
                    выбрал сервер и выбирает длительность (1 мес, 3 мес...)'},
                    {'id': 'enter_email', 'label': 'Email', 'tag': 'ВВОД EMAIL', 'desc': 'Шаг 3: Когда бот просит ввести
                    Email для чека'},
                    {'id': 'payment_method', 'label': 'Оплата', 'tag': 'ВЫБОР СПОСОБА ОПЛАТЫ', 'desc': 'Процесс покупки
                    / Процесс пополнения баланса'}
                    ]
                    },
                    {
                    'title': 'Ключи и Пополнение',
                    'icon': 'vpn_key',
                    'color': 'blue-400',
                    'media': [
                    {'id': 'keys_list', 'label': 'Мои ключи', 'tag': 'МОИ ПОДПИСКИ', 'desc': 'Отображается в разделе "🔑
                    Мои ключи" (список ваших подписок)'},
                    {'id': 'key_ready', 'label': 'Готов', 'tag': 'КЛЮЧ ГОТОВ', 'desc': 'Отправляется с сообщением о
                    готовности ключа'},
                    {'id': 'key_info', 'label': 'Детали', 'tag': 'ИНФОРМАЦИЯ О ПОДПИСКЕ', 'desc': 'Отображается при
                    просмотре конкретного ключа (Инструкции, Подключение)'},
                    {'id': 'extend_plan', 'label': 'Продление', 'tag': 'ПРОВЕРКА СКОРОСТИ', 'desc': 'Экран выбора тарифа
                    при нажатии "Продлить"'},
                    {'id': 'topup', 'label': 'Пополнение', 'tag': 'ПОПОЛНЕНИЕ БАЛАНСА', 'desc': 'Основной экран раздела
                    "💰 Пополнить баланс"'},
                    {'id': 'topup_amount', 'label': 'Сумма', 'tag': 'ВВОД СУММЫ', 'desc': 'Экран "Введите сумму
                    пополнения в рублях"'},
                    {'id': 'waiting_payment', 'label': 'Ожидание', 'tag': 'ОЖИДАНИЕ ОПЛАТЫ', 'desc': 'Сообщение до
                    подтверждения оплаты'},
                    {'id': 'payment', 'label': 'СЧЕТ НА ОПЛАТУ', 'tag': 'СЧЕТ НА ОПЛАТУ', 'desc': 'Финальный экран с
                    кнопкой "Оплатить" (Pay)'},
                    {'id': 'payment_success', 'label': 'Успех', 'tag': 'ОПЛАТА ПОЛУЧЕНА', 'desc': 'Финальное сообщение
                    об успехе'}
                    ]
                    }
                    ] %}

                    {% for cat in categories %}
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 px-1">
                            <div class="w-6 h-6 rounded bg-primary/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary text-[14px]">{{ cat.icon }}</span>
                            </div>
                            <h5 class="text-white/80 text-[11px] font-bold uppercase tracking-widest">{{ cat.title }}
                            </h5>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {% for item in cat.media %}
                            <div
                                class="group/media relative bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-xl backdrop-blur-md transition-all hover:border-primary/20 flex flex-col h-full">
                                <!-- Card Header -->
                                <div
                                    class="px-4 py-3 bg-white/[0.02] border-b border-white/10 flex items-center justify-between">
                                    <div class="flex items-center gap-2.5 min-w-0">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary group-hover/media:bg-primary/20 transition-colors">
                                            <span class="material-symbols-outlined text-base">{{ cat.icon }}</span>
                                        </div>
                                        <div class="min-w-0">
                                            <h6
                                                class="text-white font-bold text-xs truncate group-hover/media:text-primary transition-colors">
                                                {{ item.label }}</h6>
                                            <p class="text-[8px] text-primary/50 uppercase font-bold tracking-tighter">
                                                Отображение в боте</p>
                                        </div>
                                    </div>
                                    <button type="button"
                                        class="w-7 h-7 flex items-center justify-center rounded-lg text-white/20 hover:text-primary hover:bg-primary/10 transition-all btn-copy-text"
                                        data-copy-text="{{ item.tag }}" title="Копировать тег">
                                        <span class="material-symbols-outlined text-sm">content_copy</span>
                                    </button>
                                </div>

                                <!-- Card Body -->
                                <div class="p-4 bg-black/40 flex-1 flex flex-col space-y-4">
                                    <div class="space-y-1.5">
                                        <div class="flex items-center gap-1.5 ml-1">
                                            <span
                                                class="material-symbols-outlined text-[10px] text-primary/40">visibility</span>
                                            <label
                                                class="text-[8px] text-white/40 font-bold uppercase tracking-widest">Место
                                                показа</label>
                                        </div>
                                        <div class="bg-white/5 border border-white/5 rounded-xl px-3 py-2">
                                            <p class="text-white/70 text-[10px] leading-tight">{{ item.desc }}</p>
                                        </div>
                                    </div>

                                    <div class="space-y-1.5">
                                        <div class="flex items-center gap-1.5 ml-1">
                                            <span
                                                class="material-symbols-outlined text-[10px] text-primary/40">link</span>
                                            <label
                                                class="text-[8px] text-white/40 font-bold uppercase tracking-widest">URL
                                                изображения</label>
                                        </div>
                                        <input type="text" id="{{ item.id }}_image_url"
                                            value="{{ settings[item.id + '_image'] or '' }}" readonly
                                            class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-white/50 text-[9px] font-mono truncate focus:outline-none focus:border-primary/40 transition-all" />
                                    </div>

                                    <div class="grid grid-cols-2 gap-2 mt-auto">
                                        <button type="button"
                                            class="btn-upload-menu-image py-2 rounded-xl bg-primary/10 text-primary text-[9px] font-bold uppercase tracking-wider hover:bg-primary/20 transition-all border border-primary/10 flex items-center justify-center gap-1.5"
                                            data-section="{{ item.id }}">
                                            <span class="material-symbols-outlined text-sm">upload</span>
                                            Загрузить
                                        </button>
                                        <button type="button"
                                            class="btn-delete-menu-image py-2 rounded-xl bg-white/5 text-white/30 text-[9px] font-bold uppercase tracking-wider hover:bg-red-500/10 hover:text-red-500 transition-all border border-white/10 flex items-center justify-center gap-1.5"
                                            data-section="{{ item.id }}">
                                            <span class="material-symbols-outlined text-sm">delete</span>
                                            Удалить
                                        </button>
                                    </div>
                                    <input type="file" id="{{ item.id }}_image_file" accept=".jpg,.jpeg,.png,.gif"
                                        class="hidden" data-section="{{ item.id }}" />
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- External Links -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-lg">link</span>
                        </div>
                        <h4 class="text-white font-bold text-sm">Внешние ссылки и Доступ</h4>
                    </div>

                    <div class="flex items-center gap-3 bg-black/20 rounded-xl px-4 py-2 border border-white/5">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-white/60">Обязательная
                            подписка</span>
                        <input type="hidden" name="force_subscription" value="false" />
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="force_subscription" value="true" id="force_subscription" {% if
                                settings.force_subscription=='true' %}checked{% endif %} class="sr-only peer" />
                            <div
                                class="w-9 h-5 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {% for field in [
                    {'n': 'support_user', 'l': 'URL поддержки', 'p': 'https://t.me/support'},
                    {'n': 'channel_url', 'l': 'Телеграм канал', 'p': 'https://t.me/channel'},
                    {'n': 'terms_url', 'l': 'Условия (Terms)', 'p': ''},
                    {'n': 'privacy_url', 'l': 'Приватность', 'p': ''}
                    ] %}
                    <div class="space-y-1">
                        <label class="block text-white/40 text-[9px] uppercase font-bold tracking-wider ml-1">{{ field.l
                            }}</label>
                        <input type="text" name="{{ field.n }}" value="{{ settings[field.n] or '' }}"
                            placeholder="{{ field.p }}"
                            class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Button Texts -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-lg">radio_button_checked</span>
                    </div>
                    <h4 class="text-white font-bold text-sm">Тексты кнопок меню</h4>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    {% for f in [
                    {'n': 'btn_trial_text', 'l': 'Пробный', 'p': '🎁 Пробный'},
                    {'n': 'btn_profile_text', 'l': 'Профиль', 'p': '👤 Профиль'},
                    {'n': 'btn_my_keys_text', 'l': 'Ключи', 'p': '🔑 Ключи'},
                    {'n': 'btn_buy_key_text', 'l': 'Купить', 'p': '🛒 Купить'},
                    {'n': 'btn_topup_text', 'l': 'Баланс', 'p': '💳 Баланс'},
                    {'n': 'btn_referral_text', 'l': 'Рефералы', 'p': '🤝 Рефералы'},
                    {'n': 'btn_support_text', 'l': 'Помощь', 'p': '🆘 Помощь'},
                    {'n': 'btn_about_text', 'l': 'О боте', 'p': 'ℹ️ О боте'},
                    {'n': 'btn_howto_text', 'l': 'FAQ', 'p': '❓ Помощь'},
                    {'n': 'btn_speed_text', 'l': 'Скорость', 'p': '⚡ Скорость'},
                    {'n': 'btn_admin_text', 'l': 'Админ', 'p': '⚙️ Админ'},
                    {'n': 'btn_back_to_menu_text', 'l': 'Назад', 'p': '⬅️ Назад'}
                    ] %}
                    <div class="space-y-1">
                        <label class="block text-white/30 text-[8px] uppercase font-bold tracking-[0.1em] ml-1">{{ f.l
                            }}</label>
                        <input type="text" name="{{ f.n }}" value="{{ settings[f.n] or '' }}" placeholder="{{ f.p }}"
                            class="w-full bg-black/30 border border-white/5 rounded-xl px-2 py-1.5 text-white text-[10px] focus:ring-1 focus:ring-primary/40 outline-none transition-all" />
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-lg">description</span>
                    </div>
                    <h4 class="text-white font-bold text-sm">Инструкции по подключению</h4>
                </div>
                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-white/40 text-[9px] uppercase font-bold tracking-wider mb-1.5 ml-1">Вступительный
                            текст</label>
                        <textarea name="howto_intro_text" rows="2" placeholder="..."
                            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white text-xs focus:ring-1 focus:ring-primary/40 outline-none transition-all">{{ settings.howto_intro_text or '' }}</textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for f in [{'n': 'howto_android_text', 'l': 'Android'}, {'n': 'howto_ios_text', 'l': 'iOS'},
                        {'n': 'howto_windows_text', 'l': 'Windows'}, {'n': 'howto_linux_text', 'l': 'Linux'}] %}
                        <div class="bg-black/20 rounded-2xl p-4 border border-white/5">
                            <label
                                class="block text-white/60 text-[10px] uppercase font-bold tracking-wider mb-2 ml-1">{{
                                f.l }}</label>
                            <textarea name="{{ f.n }}" rows="4"
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 text-white text-xs focus:ring-1 focus:ring-primary/40 outline-none transition-all">{{ settings[f.n] or '' }}</textarea>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    </div>
</form>
{% endblock %}

{% block scripts %}
<script>

    // ===== ИНИЦИАЛИЗАЦИЯ =====
    // Выполнение базовых настроек при загрузке документа
    document.addEventListener('DOMContentLoaded', () => { initGlobalLogic(); initInteractiveElements(); });
    // ===== Конец инизиализации =====

    // ===== ГЛОБАЛЬНАЯ ЛОГИКА =====
    // Логика, которая не требует переинициализации при обновлении контента
    function initGlobalLogic() {
        const tabs = document.querySelectorAll('.tab-btn'), contents = document.querySelectorAll('.tab-content');
        const hashInput = document.getElementById('settings-next-hash'), hashInput2 = document.getElementById('settings-next-hash-part2');

        function switchTab(tabId) {
            tabs.forEach(btn => {
                const isActive = btn.getAttribute('data-tab') === tabId;
                if (isActive) {
                    btn.classList.add('bg-primary', 'text-background-dark', 'shadow-[0_0_15px_rgba(var(--primary-rgb,14,165,233),0.3)]');
                    btn.classList.remove('text-white/40', 'hover:bg-white/5');
                } else {
                    btn.classList.remove('bg-primary', 'text-background-dark', 'shadow-[0_0_15px_rgba(var(--primary-rgb,14,165,233),0.3)]');
                    btn.classList.add('text-white/40', 'hover:bg-white/5');
                }
            });
            contents.forEach(content => content.classList.toggle('hidden', content.id !== 'tab-' + tabId));
            if (hashInput) hashInput.value = tabId; if (hashInput2) hashInput2.value = tabId;
            history.replaceState(null, '', '#' + tabId);
        }

        tabs.forEach(btn => btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab'))));
        switchTab(location.hash.slice(1) || 'panel');

        // New Host Handler function
        async function handleHostForm(form) {
            const formData = new FormData(form);
            const action = form.action;

            try {
                const res = await sendRequest(action, 'POST', formData);

                if (res.ok) {
                    // Specific handling based on action
                    if (action.includes('/delete-host')) {
                        const hostName = decodeURIComponent(action.split('/delete-host/')[1]);
                        const card = document.querySelector(`.host-card[data-host-name="${hostName}"]`);
                        if (card) {
                            card.remove();
                            showToast('success', res.message || 'Хост удален');
                        } else {
                            // If card not found (weird), reload
                            showToast('success', res.message || 'Хост удален');
                            setTimeout(() => window.location.reload(), 500);
                        }
                    } else if (action.includes('/toggle-host-visibility')) {
                        const hostName = decodeURIComponent(action.split('/toggle-host-visibility/')[1]);
                        const btn = form.querySelector('button');
                        const hiddenInput = form.querySelector('input[name="visible"]');

                        if (hiddenInput && btn) {
                            const newVal = hiddenInput.value === '1' ? '0' : '1';
                            hiddenInput.value = newVal;

                            // Update UI immediately
                            if (newVal === '1') {
                                btn.className = "flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-500/10 text-green-500 text-xs font-bold hover:bg-green-500/20 transition-all";
                                btn.innerHTML = '<span class="material-symbols-outlined text-sm">visibility</span> Показать';
                            } else {
                                btn.className = "flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-yellow-500/10 text-yellow-500 text-xs font-bold hover:bg-yellow-500/20 transition-all";
                                btn.innerHTML = '<span class="material-symbols-outlined text-sm">visibility_off</span> Скрыть';
                            }
                            showToast('success', res.message || 'Видимость обновлена');
                        } else {
                            // Fallback
                            showToast('success', res.message || 'Видимость обновлена');
                        }
                    } else {
                        // For updates (URL, Subscription, Traffic, Description, SSH, Speedtest) - Just Toast
                        // This also now covers add-host and rename-host
                        showToast('success', res.message || 'Настройки сохранены');
                    }
                } else {
                    showToast('danger', res.error || 'Ошибка');
                }
            } catch (e) {
                console.error(e);
                showToast('danger', 'Ошибка отправки формы');
            }
        }

        // Глобальный перехватчик форм тарифов и SSH целей
        document.addEventListener('submit', async (e) => {
            const form = e.target;

            // Тарифы
            if (form.action && (form.action.includes('/add-plan') || form.action.includes('/update-plan') || form.action.includes('/delete-plan'))) {
                e.preventDefault();
                e.stopPropagation();

                const isDelete = form.action.includes('delete-plan');
                if (isDelete) {
                    const confirmed = await showCustomConfirm('Удалить тариф?');
                    if (!confirmed) return;
                }

                await handlePlanForm(form, form.action.includes('update'), isDelete);
            }
            // SSH Цели
            else if (form.action && (form.action.includes('/ssh-targets/create') || form.action.includes('/ssh-targets/') && (form.action.includes('/update') || form.action.includes('/delete')))) {
                // Исключаем формы speedtest (они внутри action имеют speedtest, но URL может содержать update/delete если не аккуратно)
                // Наши URL:
                // /admin/ssh-targets/create
                // /admin/ssh-targets/<name>/update
                // /admin/ssh-targets/<name>/delete
                // /admin/ssh-targets/<name>/speedtest/run -> тут нет update/delete
                // /admin/ssh-targets/<name>/speedtest/install -> тут нет update/delete

                e.preventDefault();
                e.stopPropagation();

                const isDelete = form.action.includes('/delete');
                const isUpdate = form.action.includes('/update');

                if (isDelete) {
                    const targetName = decodeURIComponent(form.action.split('/ssh-targets/')[1].split('/')[0]);
                    const confirmed = await showCustomConfirm(`Удалить SSH-цель '${targetName}'?`);
                    if (!confirmed) return;
                }

                await handleSSHTargetForm(form, isUpdate, isDelete);
            }
            // HOSTS (Added for fix)
            else if (form.action && (
                form.action.includes('/add-host') ||
                form.action.includes('/delete-host') ||
                form.action.includes('/rename-host') ||
                form.action.includes('/toggle-host-visibility') ||
                form.action.includes('/update-host-') ||
                form.action.includes('/admin/hosts/ssh/update') ||
                form.action.includes('/speedtest/install')
            )) {
                e.preventDefault();
                e.stopPropagation();

                const isDelete = form.action.includes('/delete-host');
                if (isDelete) {
                    const hostName = decodeURIComponent(form.action.split('/delete-host/')[1]);
                    const confirmed = await showCustomConfirm(`Удалить хост '${hostName}' и все его тарифы?`);
                    if (!confirmed) return;
                }

                await handleHostForm(form);
            }
        }, true); // true = capture phase (перехват до всплытия)

        window.toggleAddHostForm = () => toggleElementState('add-host', 'addHostFormCollapsed');
        window.toggleHostContent = (name) => toggleElementState(name, 'hostCollapsed_' + name);
        window.selectTrafficStrategy = (host, val, label) => {
            document.getElementById('traffic_limit_strategy_input_' + host).value = val;
            document.getElementById('strategy_label_' + host).textContent = label;
            document.activeElement.blur();
        };
        window.toggleDescriptionForm = async (host) => {
            const chk = document.getElementById('toggle-description-' + host), frm = document.getElementById('description-form-' + host);
            if (chk && frm) {
                frm.classList.toggle('hidden', !chk.checked);
                if (!chk.checked) {
                    const formData = new FormData();
                    formData.append('host_name', host);
                    formData.append('host_description', '');
                    const res = await sendRequest(frm.querySelector('form').action, 'POST', formData);
                    if (res.ok) showToast('Описание сброшено');
                }
            }
        };

        if (localStorage.getItem('addHostFormCollapsed') === 'false') window.toggleAddHostForm();
        restoreHostStates();
    }
    // ===== Конец глобальной логики =====

    // ===== ВОССТАНОВЛЕНИЕ СОСТОЯНИЯ =====
    // Проверка сохраненных состояний свернутых элементов
    function restoreHostStates() {
        document.querySelectorAll('[id^="host-content-"]').forEach(el => {
            const name = el.id.replace('host-content-', '');
            if (localStorage.getItem('hostCollapsed_' + name) === 'false') {
                el.classList.remove('hidden');
                const icon = document.getElementById('host-icon-' + name);
                if (icon) icon.style.transform = 'rotate(180deg)';
            }
        });
    }
    // ===== Конец восстановления состояния =====

    // ===== ПЕРЕКЛЮЧЕНИЕ СОСТОЯНИЯ ЭЛЕМЕНТА =====
    // Смена видимости и сохранение состояния в локальное хранилище
    function toggleElementState(id, storageKey) {
        const el = document.getElementById(id.startsWith('add-host') ? 'add-host-form' : 'host-content-' + id);
        const icon = document.getElementById(id.startsWith('add-host') ? 'add-host-icon' : 'host-icon-' + id);
        if (el) {
            el.classList.toggle('hidden');
            const isHidden = el.classList.contains('hidden');
            if (storageKey) localStorage.setItem(storageKey, isHidden);
            if (icon) icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    }
    // ===== Конец переключения состояния =====

    // ===== ИНТЕРАКТИВНЫЕ ЭЛЕМЕНТЫ =====
    // Инициализация обработчиков для динамических элементов
    function initInteractiveElements() {
        initForms();
        initDragAndDrop('hosts-grid-container', 'host-card', '/other/servers/hosts/reorder', 'data-host-name');
        initDragAndDrop('ssh-targets-grid-container', 'ssh-target-card', '/other/servers/ssh/reorder', 'data-target-name');

        if (window.initSoftSelect) {
            window.initSoftSelect('existing_backup', '— Выберите архив —');
            window.initSoftSelect('trial_host_id', 'Выборочно (пользователь выбирает)');
            window.initSoftSelect('referral_reward_type', 'Выберите тип начисления...');
        }

        const refTypeSelect = document.getElementById('referral_reward_type');
        if (refTypeSelect) {
            const updateRefSections = () => {
                const val = refTypeSelect.value || 'percent_purchase';
                document.querySelectorAll('[data-ref-section]').forEach(s => s.style.display = s.dataset.refSection === val ? '' : 'none');
            };
            refTypeSelect.addEventListener('change', updateRefSections); updateRefSections();
        }

        const backupSelect = document.getElementById('existing_backup');
        if (backupSelect) backupSelect.addEventListener('change', () => document.getElementById('backup-date').textContent = backupSelect.options[backupSelect.selectedIndex].getAttribute('data-mtime') || '—');

        const dbFileBtn = document.getElementById('btn-pick-file'), dbFileInput = document.getElementById('db_file');
        if (dbFileBtn && dbFileInput) {
            dbFileBtn.onclick = () => dbFileInput.click();
            dbFileInput.onchange = () => document.getElementById('picked-file-name').textContent = dbFileInput.files[0]?.name || 'Файл не выбран';
        }

        initImageUploaders();

        document.querySelectorAll('.pay-info-toggle').forEach(t => {
            t.onchange = async function () {
                const res = await sendRequest('/api/settings/update-pay-info', 'POST', { field: this.dataset.field, value: this.checked }, true);
                if (res.status === 'success') showToast('success', 'Настройки обновлены');
                else { showToast('danger', res.message || 'Ошибка'); this.checked = !this.checked; }
            };
        });

        document.querySelectorAll('.btn-copy-text').forEach(btn => {
            btn.onclick = function () {
                navigator.clipboard.writeText(this.dataset.copyText).then(() => {
                    const original = this.innerHTML;
                    this.innerHTML = '<span class="material-symbols-outlined text-green-400 text-[16px]">check</span>';
                    setTimeout(() => this.innerHTML = original, 2000);
                });
            };
        });

        document.querySelectorAll('.speedtest-loading-btn').forEach(btn => {
            const form = btn.closest('form');
            if (form) form.addEventListener('submit', () => {
                btn.innerHTML = `<span class="inline-flex items-center gap-1"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${btn.dataset.label || 'Выполняется'}...</span>`;
                btn.disabled = true;
            });
        });

        // Обработчики для SSH целей
        document.querySelectorAll('.ssh-edit-btn').forEach(btn => {
            btn.onclick = () => {
                const target = btn.dataset.target;
                const form = document.getElementById('edit-ssh-' + target);
                if (form) form.classList.toggle('hidden');
            };
        });
        document.querySelectorAll('.ssh-cancel-btn').forEach(btn => {
            btn.onclick = () => {
                const target = btn.dataset.target;
                const form = document.getElementById('edit-ssh-' + target);
                if (form) form.classList.add('hidden');
            };
        });

        // Переключение видимости пароля
        window.togglePasswordVisibility = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            const isPass = el.type === 'password';
            el.type = isPass ? 'text' : 'password';
            const btn = el.nextElementSibling;
            if (btn && btn.tagName === 'BUTTON') {
                const icon = btn.querySelector('.material-symbols-outlined');
                if (icon) icon.textContent = isPass ? 'visibility_off' : 'visibility';
            }
        };

        const saveAllBtn = document.getElementById('save-all-settings-btn');
        if (saveAllBtn) {
            saveAllBtn.onclick = async (e) => {
                e.preventDefault(); const formData = new FormData();
                [document.getElementById('settings-form'), document.getElementById('settings-form-part2')].forEach(f => {
                    if (f) new FormData(f).forEach((v, k) => { if (k !== 'csrf_token') formData.append(k, v); });
                });
                formData.append('csrf_token', document.querySelector('input[name="csrf_token"]')?.value);
                formData.set('next_hash', location.hash.slice(1) || 'panel');
                const result = await sendRequest(document.getElementById('settings-form').action, 'POST', formData);
                if (result.ok) showToast('success', 'Все настройки сохранены'); else showToast('danger', result.error || 'Ошибка сохранения');
            };
        }
    }
    // ===== Конец интерактивных элементов =====

    // ===== УМНОЕ ОБНОВЛЕНИЕ =====
    // Перезагрузка контента без обновления страницы
    // Перезагрузка контента без обновления страницы
    async function reloadContent() {
        try {
            const res = await fetch(window.location.href, {
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'Cache-Control': 'no-cache' },
                credentials: 'include'
            });
            const html = await res.text();

            if (html.includes('id="login-identifier-v2"')) {
                console.warn('[DEBUG] reloadContent detected Login Page! Refresh prevented.');
                showToast('warning', 'Не удалось обновить список: требуется авторизация');
                return;
            }

            const doc = new DOMParser().parseFromString(html, 'text/html');
            const newContentFound = false;
            document.querySelectorAll('.tab-content').forEach(old => {
                const newContent = doc.getElementById(old.id);
                if (newContent) {
                    old.innerHTML = newContent.innerHTML;
                }
            });
            initInteractiveElements();
            restoreHostStates();
        } catch (e) { console.error('Smart Refresh failed:', e); }
    }
    // ===== Конец умного обновления =====

    // ===== ИНИЦИАЛИЗАЦИЯ ФОРМ =====
    // Настройка обработчиков отправки для всех форм
    function initForms() {
        document.querySelectorAll('form').forEach(form => {
            if (form.getAttribute('data-processed')) return; form.setAttribute('data-processed', 'true');
            if (['settings-form', 'settings-form-part2'].includes(form.id)) return;



            form.onsubmit = async function (e) {
                e.preventDefault();
                e.stopPropagation();
                const confirmMsg = this.getAttribute('data-confirm');

                if (confirmMsg) {
                    const confirmed = await showCustomConfirm(confirmMsg);
                    if (!confirmed) return;
                }

                if (form.querySelector('[formaction]')) return;

                let msg = 'Сохранено'; const action = this.action;
                if (action.includes('add_host')) msg = 'Хост добавлен';
                else if (action.includes('delete_host')) msg = 'Хост удалён';
                else if (action.includes('rename_host')) msg = 'Хост переименован';
                else if (action.includes('speedtest') || action.includes('auto_install')) msg = 'Задача запущена';
                else if (action.includes('create_ssh_target')) msg = 'SSH-цель добавлена';
                else if (action.includes('delete_ssh_target')) msg = 'SSH-цель удалена';
                handleFormSubmit(this, msg, true);
            };
        });

        document.querySelectorAll('button[formaction]').forEach(btn => {
            if (btn.getAttribute('data-processed')) return; btn.setAttribute('data-processed', 'true');
            if (btn.getAttribute('formaction').match(/backup|restore/)) return;
            btn.onclick = function (e) {
                e.preventDefault(); const form = this.closest('form'), originalAction = form.action;
                form.action = this.getAttribute('formaction');
                handleFormSubmit(form, 'Выполнено', false).then(() => form.action = originalAction);
            };
        });
    }
    // ===== Конец инициализации форм =====


    // ===== ОТПРАВКА ЗАПРОСОВ =====
    // Универсальная функция для AJAX-взаимодействия с сервером
    async function sendRequest(url, method = 'POST', body = null, isJson = false) {
        try {
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
            const headers = { 'X-CSRFToken': csrfToken || '', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' };
            if (isJson) headers['Content-Type'] = 'application/json';
            const options = { method, headers }; if (body) options.body = isJson ? JSON.stringify(body) : body;
            const res = await fetch(url, options);
            if (res.redirected) return { ok: true, redirected: true, url: res.url };
            try { return await res.json(); } catch { return { ok: res.ok }; }
        } catch (e) { console.error(e); return { ok: false, error: e.message }; }
    }
    // ===== Конец отправки запросов =====

    // ===== ОБРАБОТКА ОТПРАВКИ ФОРМЫ =====
    // Обработка результата отправки и запуск обновления при необходимости
    async function handleFormSubmit(form, successMsg, useSmartRefresh = false) {
        const formData = new FormData(form); if (form.id === 'settings-form' || form.id === 'settings-form-part2') formData.set('next_hash', location.hash.slice(1) || 'panel');
        const result = await sendRequest(form.action, 'POST', formData);
        if (result.ok) { showToast('success', result.message || successMsg); if (useSmartRefresh) await reloadContent(); }
        else showToast('danger', result.error || 'Ошибка');
    }
    // ===== Конец обработки отправки =====

    // ===== ОБРАБОТКА ТАРИФОВ =====
    // Специальная логика добавления, обновления и удаления планов
    async function handlePlanForm(form, isUpdate = false, isDelete = false) {
        const formData = new FormData(form);
        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
        const headers = { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken || '' };
        try {
            const res = await fetch(form.action, { method: 'POST', headers, body: formData });
            const data = await res.json();
            if (data.ok) {
                const msg = isDelete ? 'Тариф удалён' : (isUpdate ? 'Тариф обновлён' : 'Тариф добавлен');
                showToast('success', msg);

                if (isDelete) {
                    const planId = form.action.split('/delete-plan/')[1];
                    const card = document.getElementById('plan-card-' + planId);
                    if (card) card.remove();
                } else if (data.plan) {
                    const plan = data.plan;
                    const cardHtml = renderPlanCard(plan, csrfToken);

                    if (isUpdate) {
                        const oldCard = document.getElementById('plan-card-' + plan.plan_id);
                        if (oldCard) {
                            oldCard.outerHTML = cardHtml;
                            const viewDiv = document.getElementById('view-plan-' + plan.plan_id);
                            const editDiv = document.getElementById('edit-plan-' + plan.plan_id);
                            if (viewDiv) viewDiv.classList.remove('hidden');
                            if (editDiv) editDiv.classList.add('hidden');
                        }
                    } else {
                        const hostName = formData.get('host_name');
                        const gridId = 'plans-grid-' + hostName;
                        let grid = document.querySelector('[id="' + CSS.escape(gridId) + '"]');

                        if (!grid) {
                            const hostSection = form.closest('.bg-white\\/5');
                            if (hostSection) {
                                grid = hostSection.querySelector('[id^="plans-grid-"]');
                            }
                        }

                        if (!grid) {
                            const hostSection = form.closest('.bg-white\\/5');
                            const emptyDiv = hostSection?.querySelector('.bg-white\\/\\[0\\.02\\]');
                            if (emptyDiv) {
                                const newGrid = document.createElement('div');
                                newGrid.id = gridId;
                                newGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-4';
                                emptyDiv.replaceWith(newGrid);
                                grid = newGrid;
                            }
                        }

                        if (grid) {
                            grid.insertAdjacentHTML('beforeend', cardHtml);
                        }
                        form.reset();
                    }
                }
            } else {
                showToast('danger', 'Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        } catch (e) { showToast('danger', 'Ошибка: ' + e.message); }
    }

    function renderPlanCard(plan, csrfToken) {
        const traffic = plan.traffic_limit_gb || '∞';
        const hwid = plan.hwid_limit || '∞';
        const price = Math.round(plan.price);
        return `
        <div id="plan-card-${plan.plan_id}" class="bg-black/30 border border-white/10 rounded-2xl p-4 group/plan relative overflow-hidden">
            <div id="view-plan-${plan.plan_id}" class="flex flex-col h-full relative z-10">
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-white font-bold text-sm truncate pr-2">${plan.plan_name}</h4>
                        <div class="flex items-center gap-1">
                             <button type="button" 
                                onclick="document.getElementById('edit-plan-${plan.plan_id}').classList.remove('hidden'); document.getElementById('view-plan-${plan.plan_id}').classList.add('hidden')"
                                class="w-6 h-6 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-white flex items-center justify-center transition-all">
                                <span class="material-symbols-outlined text-[14px]">edit</span>
                            </button>
                            <form action="/delete-plan/${plan.plan_id}" method="post" data-confirm="Удалить тариф '${plan.plan_name}'?">
                                <input type="hidden" name="csrf_token" value="${csrfToken}" />
                                <button type="submit" class="w-6 h-6 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-500/60 hover:text-red-500 flex items-center justify-center transition-all">
                                    <span class="material-symbols-outlined text-[14px]">delete</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                 <div class="space-y-1 mb-3">
                    <div class="flex justify-between text-[10px] text-white/40">
                        <span>Цена:</span>
                        <span class="text-white font-mono">${price} ₽</span>
                    </div>
                     <div class="flex justify-between text-[10px] text-white/40">
                        <span>Срок:</span>
                        <span class="text-white font-mono">${plan.months} мес.</span>
                    </div>
                    <div class="flex justify-between text-[10px] text-white/40">
                        <span>Трафик:</span>
                        <span class="text-white font-mono">${traffic} GB</span>
                    </div>
                     <div class="flex justify-between text-[10px] text-white/40">
                        <span>Лимит:</span>
                        <span class="text-white font-mono">${hwid} dev</span>
                    </div>
                </div>
            </div>
             <!-- Edit Form -->
            <div id="edit-plan-${plan.plan_id}" class="hidden absolute inset-0 bg-black/90 z-20 p-4 flex flex-col justify-center">
                 <form action="/update-plan/${plan.plan_id}" method="post" class="space-y-2">
                    <input type="hidden" name="csrf_token" value="${csrfToken}" />
                    <input type="text" name="plan_name" value="${plan.plan_name}" required class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-white text-xs" placeholder="Name">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" name="months" value="${plan.months}" required class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-white text-xs" placeholder="Months">
                         <input type="number" name="price" value="${price}" required class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-white text-xs" placeholder="Price">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <input type="number" name="traffic_limit_gb" value="${plan.traffic_limit_gb || ''}" class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-white text-xs" placeholder="Traffic">
                        <input type="number" name="hwid_limit" value="${plan.hwid_limit || ''}" class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-white text-xs" placeholder="HWID">
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button type="submit" class="py-1.5 rounded-lg bg-primary text-background-dark text-[10px] font-bold uppercase tracking-widest hover:scale-[1.02] transition-all flex-1">Save</button>
                        <button type="button" onclick="document.getElementById('edit-plan-${plan.plan_id}').classList.add('hidden'); document.getElementById('view-plan-${plan.plan_id}').classList.remove('hidden')" class="py-1.5 rounded-lg bg-white/10 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-white/20 transition-all flex-1">Cancel</button>
                    </div>
                </form>
            </div>
        </div>`;
    }

    // ===== ОБРАБОТКА SSH ЦЕЛЕЙ =====
    // Аналогичная логика для SSH целей, чтобы избежать reloadContent
    async function handleSSHTargetForm(form, isUpdate = false, isDelete = false) {
        const formData = new FormData(form);
        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
        const headers = { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken || '' };

        try {
            const res = await fetch(form.action, { method: 'POST', headers, body: formData });

            let data;
            try {
                data = await res.json();
            } catch (e) {
                // Если сервер вернул не JSON (например редирект), считаем что все ок, но без данных
                if (res.ok && res.redirected) {
                    // Fallback: если редирект, придется перезагрузить, но это именно то что мы хотели избежать.
                    // Но мы обновили сервер, так что он должен вернуть JSON.
                    console.warn('SSH Target response was a redirect, expected JSON.');
                    window.location.reload();
                    return;
                }
                throw new Error('Invalid JSON response');
            }

            if (data.ok) {
                const msg = isDelete ? 'SSH-цель удалена' : (isUpdate ? 'SSH-цель обновлена' : 'SSH-цель добавлена');
                showToast('success', msg);

                if (isDelete) {
                    const parts = form.action.split('/ssh-targets/');
                    if (parts.length > 1) {
                        const targetName = decodeURIComponent(parts[1].split('/')[0]);
                        const card = document.querySelector(`.ssh-target-card[data-target-name="${targetName}"]`);
                        if (card) card.remove();
                    }
                } else {

                    const targetData = {
                        target_name: formData.get('target_name') || formData.get('new_target_name'),
                        ssh_host: formData.get('ssh_host'),
                        ssh_port: formData.get('ssh_port') || 22,
                        ssh_user: formData.get('ssh_user'),
                        ssh_password: formData.get('ssh_password'),
                        description: formData.get('description'),
                        // Для сохранения старого имени при переименовании
                        old_target_name: isUpdate ? decodeURIComponent(form.action.split('/ssh-targets/')[1].split('/')[0]) : null
                    };

                    // Если update и имя изменилось, старая карточка не найдет по новому имени.
                    const cardHtml = renderSSHTargetCard(targetData, csrfToken);

                    if (isUpdate) {
                        // Находим по старому имени
                        const oldName = targetData.old_target_name;
                        const oldCard = document.querySelector(`.ssh-target-card[data-target-name="${oldName}"]`);
                        if (oldCard) {
                            oldCard.outerHTML = cardHtml;
                            // Re-init events for the new card if needed (drag and drop etc is global, but buttons need handlers)
                            initInteractiveElements();
                        }
                    } else {
                        // Create
                        let grid = document.getElementById('ssh-targets-grid-container');
                        if (!grid) {
                            const emptyDiv = document.querySelector('#tab-hosts .bg-white\\/5.text-center'); // roughly searching for empty state
                            if (emptyDiv && emptyDiv.innerText.includes('SSH-цели')) {
                                const newGrid = document.createElement('div');
                                newGrid.id = 'ssh-targets-grid-container';
                                newGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4';
                                emptyDiv.replaceWith(newGrid);
                                grid = newGrid;
                            }
                        }
                        if (grid) {
                            grid.insertAdjacentHTML('beforeend', cardHtml);
                            initInteractiveElements();
                        }
                        form.reset();
                    }
                }
            } else {
                showToast('danger', 'Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        } catch (e) { showToast('danger', 'Ошибка: ' + e.message); }
    }

    function renderSSHTargetCard(t, csrfToken) {
        // Construct URL for actions
        const deleteUrl = `/admin/ssh-targets/${t.target_name}/delete`;
        const testUrl = `/admin/ssh-targets/${t.target_name}/speedtest/run`;
        const updateUrl = `/admin/ssh-targets/${t.target_name}/update`;
        const installUrl = `/admin/ssh-targets/${t.target_name}/speedtest/install`;

        return `
         <div class="ssh-target-card relative bg-white/5 border border-white/10 rounded-2xl overflow-hidden shadow-xl backdrop-blur-md group flex flex-col h-full"
                    draggable="true" data-target-name="${t.target_name}">

                    <!-- Card Header -->
                    <div class="flex items-center justify-between px-4 py-2 bg-white/[0.02] border-b border-white/10">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <span class="material-symbols-outlined text-white/20 cursor-grab active:cursor-grabbing hover:text-white/60 drag-handle transition-colors" onclick="event.stopPropagation()">drag_indicator</span>
                            <div class="min-w-0">
                                <h4 class="text-xs font-bold text-white truncate">${t.target_name}</h4>
                                <p class="text-[8px] text-white/30 uppercase font-bold tracking-widest">SSH Target</p>
                            </div>
                        </div>

                        <form action="${deleteUrl}" method="post" data-confirm="Удалить SSH-цель '${t.target_name}'?" class="ml-2">
                            <input type="hidden" name="csrf_token" value="${csrfToken}" />
                            <button type="submit" class="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-500/10 text-red-500/50 hover:text-red-500 transition-all">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </form>
                    </div>

                    <div class="p-4 flex-1 flex flex-col justify-between bg-black/10">
                        <!-- Info Grid -->
                        <div class="space-y-2">
                            <div class="bg-black/20 border border-white/5 rounded-xl p-2.5">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <span class="material-symbols-outlined text-primary text-[12px]">dns</span>
                                    <label class="text-white/30 text-[8px] font-bold uppercase tracking-wider">Host:Port</label>
                                </div>
                                <p class="text-white/90 text-[11px] font-mono ml-5 truncate">${t.ssh_host}:${t.ssh_port || 22}</p>
                            </div>

                            ${t.description ? `
                            <div class="bg-black/20 border border-white/5 rounded-xl p-2.5">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <span class="material-symbols-outlined text-primary text-[12px]">description</span>
                                    <label class="text-white/30 text-[8px] font-bold uppercase tracking-wider">Описание</label>
                                </div>
                                <p class="text-white/60 text-[11px] ml-5 truncate">${t.description}</p>
                            </div>` : ''}
                        </div>

                        <!-- Actions -->
                        <div class="space-y-1.5 pt-4 mt-auto">
                            <form action="${testUrl}" method="post" class="w-full">
                                <input type="hidden" name="csrf_token" value="${csrfToken}" />
                                <button type="submit" class="speedtest-loading-btn w-full px-4 py-2 rounded-xl bg-blue-500/20 text-blue-400 text-[10px] font-bold uppercase tracking-widest hover:bg-blue-500/30 transition-all flex items-center justify-center gap-2 border border-blue-500/10" data-label="Тест">
                                    <span class="material-symbols-outlined text-sm">speed</span>
                                    Тест скорости
                                </button>
                            </form>

                            <div class="grid grid-cols-2 gap-1.5">
                                <button type="button" class="ssh-edit-btn px-3 py-1.5 rounded-xl bg-white/5 text-white/50 text-[9px] font-bold uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all border border-white/5" data-target="${t.target_name}">
                                    <span class="flex items-center justify-center gap-1">
                                        <span class="material-symbols-outlined text-xs">edit</span>
                                        Правка
                                    </span>
                                </button>
                                <form action="${installUrl}" method="post">
                                    <input type="hidden" name="csrf_token" value="${csrfToken}" />
                                    <button type="submit" class="speedtest-loading-btn w-full px-3 py-1.5 rounded-xl bg-white/5 text-white/40 text-[9px] font-bold uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all border border-white/5" data-label="Setup">
                                        <span class="flex items-center justify-center gap-1">
                                            <span class="material-symbols-outlined text-xs">settings</span>
                                            Setup Seed
                                        </span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Edit Form (Hidden by default) -->
                        <div id="edit-ssh-${t.target_name}" class="hidden pt-3 border-t border-white/5">
                            <form action="${updateUrl}" method="post" class="space-y-2">
                                <input type="hidden" name="csrf_token" value="${csrfToken}" />
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="col-span-2 space-y-1">
                                        <input type="text" name="new_target_name" value="${t.target_name}" placeholder="Имя" required class="w-full bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                    </div>
                                    <div class="col-span-2 space-y-1">
                                        <input type="text" name="ssh_host" value="${t.ssh_host || ''}" placeholder="IP" required autocomplete="off" class="w-full bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                    </div>
                                    <input type="number" name="ssh_port" value="${t.ssh_port || ''}" placeholder="Порт" class="bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px]" />
                                    <input type="text" name="ssh_user" value="${t.ssh_user || ''}" placeholder="Юзер" autocomplete="off" class="bg-black/30 border border-white/10 rounded-xl px-2 py-1.5 text-white text-[10px]" />
                                    <div class="col-span-2 relative">
                                        <input type="password" name="ssh_password" id="pass-${t.target_name}" value="${t.ssh_password || ''}" placeholder="Пароль" autocomplete="new-password" class="w-full bg-black/30 border border-white/10 rounded-xl pl-2 pr-8 py-1.5 text-white text-[10px] focus:ring-1 focus:ring-primary/40 focus:outline-none" />
                                        <button type="button" onclick="window.togglePasswordVisibility('pass-${t.target_name}')" class="absolute right-2 top-1/2 -translate-y-1/2 text-white/30 hover:text-white transition-colors">
                                            <span class="material-symbols-outlined text-[14px]">visibility</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 pt-1 border-t border-white/5">
                                    <button type="submit" class="py-1.5 rounded-lg bg-primary text-background-dark text-[10px] font-bold uppercase tracking-widest hover:scale-[1.02] transition-all">ОК</button>
                                    <button type="button" class="ssh-cancel-btn py-1.5 rounded-lg bg-white/10 text-white/70 text-[10px] font-bold uppercase tracking-widest hover:bg-white/20 transition-all" data-target="${t.target_name}" onclick="document.getElementById('edit-ssh-${t.target_name}').classList.add('hidden')">Отмена</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>`;
    }
    // ===== Конец обработки тарифов =====

    // ===== ЗАГРУЗКА ИЗОБРАЖЕНИЙ =====
    // Обработка загрузки и удаления медиафайлов для меню
    function initImageUploaders() {
        document.querySelectorAll('input[type="file"][data-section]').forEach(input => {
            if (input.getAttribute('data-processed')) return; input.setAttribute('data-processed', 'true');
            input.onchange = async function () {
                if (!this.files[0]) return; const formData = new FormData(); formData.append('file', this.files[0]);
                const result = await sendRequest('/upload-menu-image/' + this.dataset.section, 'POST', formData);
                if (result.ok) { const urlInput = document.getElementById(this.dataset.section + '_image_url'); if (urlInput) urlInput.value = result.path; showToast('success', 'Изображение загружено'); } else showToast('danger', result.error || 'Ошибка загрузки');
            };
        });
        document.querySelectorAll('.btn-delete-menu-image').forEach(btn => {
            if (btn.getAttribute('data-processed')) return; btn.setAttribute('data-processed', 'true');
            btn.onclick = async function () {
                if (!await showCustomConfirm('Удалить изображение?')) return;
                const result = await sendRequest('/delete-menu-image/' + this.dataset.section, 'POST', null, true);
                if (result.ok) { const urlInput = document.getElementById(this.dataset.section + '_image_url'); if (urlInput) urlInput.value = ''; showToast('success', 'Изображение удалено'); } else showToast('danger', result.error || 'Ошибка удаления');
            };
        });
        document.querySelectorAll('.btn-upload-menu-image').forEach(btn => {
            if (btn.getAttribute('data-processed')) return; btn.setAttribute('data-processed', 'true');
            btn.onclick = () => document.getElementById(btn.dataset.section + '_image_file')?.click();
        });
    }
    // ===== Конец загрузки изображений =====

    // ===== ПЕРЕМЕЩЕНИЕ ЭЛЕМЕНТОВ =====
    // Реализация Drag & Drop для изменения порядка
    function initDragAndDrop(containerId, itemClass, url, dataAttr) {
        const container = document.getElementById(containerId); if (!container) return;
        let dragged = null;
        container.ondragstart = e => {
            const card = e.target.closest('.' + itemClass);
            if (card && card.getAttribute('draggable') === 'true') { dragged = card; e.dataTransfer.effectAllowed = 'move'; setTimeout(() => card.classList.add('opacity-50', 'scale-95'), 0); } else e.preventDefault();
        };
        container.ondragend = () => { if (dragged) { dragged.classList.remove('opacity-50', 'scale-95'); dragged = null; saveOrder(); } };
        container.ondragover = e => {
            e.preventDefault(); const target = e.target.closest('.' + itemClass);
            if (target && target !== dragged && dragged) { const sibs = [...container.querySelectorAll('.' + itemClass)]; container.insertBefore(dragged, sibs.indexOf(dragged) < sibs.indexOf(target) ? target.nextSibling : target); }
        };
        container.onmousedown = e => e.target.closest('.' + itemClass)?.setAttribute('draggable', !!e.target.closest('.drag-handle'));
        async function saveOrder() { const order = [...container.querySelectorAll('.' + itemClass)].map(el => el.getAttribute(dataAttr)); await sendRequest(url, 'POST', { order }, true); }
    }
    // ===== Конец перемещения элементов =====
</script>

<style>
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Улучшение выпадающих списков */
    .tab-content .grid>div {
        position: relative;
        z-index: 1;
    }

    .tab-content .grid>div:has(.soft-select.open) {
        z-index: 50;
    }

    .soft-select.open {
        position: relative;
        z-index: 60;
    }

    .soft-select-menu {
        z-index: 100 !important;
    }

    [data-target="trial_host_id"] .soft-select-menu {
        top: auto !important;
        bottom: 100% !important;
        margin-top: 0 !important;
        margin-bottom: 0.5rem !important;
    }
</style>
{% endblock %}