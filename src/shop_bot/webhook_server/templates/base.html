<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <!-- ===== МАСШТАБ СТРАНИЦЫ ===== -->
    <!-- Управление начальным зумом сайта через viewport -->
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <!-- ===== Конец блока масштабирования ===== -->
    <title>{% block title %}Панель управления Ботом{% endblock %}</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon-32x32.png') }}" />
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/favicon-16x16.png') }}" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon-32x32.png') }}" />
    <meta name="theme-color" content="#13ec80" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />


    <script>
        // Блокировка предупреждения Tailwind CSS о продакшене
        (function () {
            const originalWarn = console.warn;
            console.warn = function (...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com should not be used in production')) return;
                originalWarn.apply(console, args);
            };
        })();
    </script>

    <script src="https://unpkg.com/tailwindcss-cdn@3.4.10/tailwindcss.js"></script>

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec80",
                        "background-light": "#f6f8f7",
                        "background-dark": "#000000",
                    },
                    fontFamily: {
                        "display": ["Inter", "ui-sans-serif", "system-ui", "Apple Color Emoji", "Segoe UI Emoji", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        };
        // Инициализация темы перед рендерингом
        (function () {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        })();
    </script>

    <style>
        /* ========================================== */
        /* ИЗМЕНЕНИЕ ЗУМА ВСЕГО САЙТА */
        /* ========================================== */
        /* Используйте CSS-переменную --site-scale для изменения масштаба */
        /* Этот метод корректно работает с диаграммами и модальными окнами */

        :root {
            --site-scale: 0.85;
        }

        html {
            font-size: calc(15px * var(--site-scale));
        }

        /* Force Emoji Font for Inputs */
        input,
        textarea,
        select {
            font-family: "Inter", "Apple Color Emoji", "Segoe UI Emoji", sans-serif !important;
        }

        canvas {
            font-size: 15px;
        }

        /* ИНСТРУКЦИЯ ПО ИЗМЕНЕНИЮ МАСШТАБА: */
        /* 1. Измените значение --site-scale в блоке :root выше */
        /* 2. Доступные значения: */
        /*    0.85 - уменьшить сайт до 85% */
        /*    0.9  - уменьшить сайт до 90% */
        /*    1.0  - стандартный масштаб 100% (по умолчанию) */
        /*    1.1  - увеличить сайт до 110% */
        /*    1.15 - увеличить сайт до 115% */
        /* 3. Сохраните файл и обновите страницу */
        /* ========================================== */

        .max-w-7xl {
            max-width: 90rem !important;
        }

        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-content {
            background: rgba(16, 34, 25, 0.95);
            /* #102219 with opacity */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            color: #e0e0e0;
        }

        .dark .modal-content {
            background: rgba(0, 0, 0, 0.95);
            /* #000000 with opacity */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            color: #e0e0e0;
        }

        .modal-xl .modal-content {
            max-width: 1000px;
        }

        .modal-about-scale .modal-content {
            max-width: 700px;
            /* Было 600px, стало шире */
            transform-origin: center;
            zoom: 1.1;
            /* Приближаем масштаб на 10% */
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: toastIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-width: 400px;
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            border: 1px solid transparent;
        }

        .toast-success {
            background: rgba(19, 236, 128, 0.15);
            border-color: rgba(19, 236, 128, 0.2);
            color: #4ade80;
        }

        .toast-danger {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .toast-warning {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .soft-select {
            position: relative;
        }

        .soft-select-toggle {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            cursor: pointer;
        }

        .soft-select-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .soft-select-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background: #1a2f24;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
        }

        .soft-select.open {
            z-index: 60;
            position: relative;
        }

        .soft-select.open .soft-select-menu {
            display: block;
        }

        .dark .soft-select-menu,
        .dark .modal-content {
            background: rgba(0, 0, 0, 0.98) !important;
            backdrop-filter: blur(20px) !important;
        }

        .soft-select-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
        }

        .soft-select-item:hover,
        .soft-select-item.is-active {
            background: rgba(19, 236, 128, 0.1);
            color: #13ec80;
        }

        .soft-select select {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-dot-animated {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes glow-pulse {

            0%,
            100% {
                opacity: 1;
                filter: drop-shadow(0 0 5px rgba(19, 236, 128, 0.8));
            }

            50% {
                opacity: 0.6;
                filter: drop-shadow(0 0 15px rgba(19, 236, 128, 0.4));
            }
        }

        .animate-glow-pulse {
            animation: glow-pulse 1.5s infinite ease-in-out;
        }

        @keyframes spin-slow {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }

        @keyframes bg-pulse-warning {

            0%,
            0% {
                background-color: #13ec80;
                color: #000;
            }

            33% {
                background-color: #fbbf24;
                color: #000;
            }

            66% {
                background-color: #ffffff;
                color: #000;
            }

            100% {
                background-color: #13ec80;
                color: #000;
            }
        }

        .animate-bg-pulse {
            animation: bg-pulse-warning 0.9s infinite ease-in-out;
        }

        /* Global Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02) !important;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(19, 236, 128, 0.2) !important;
            border-radius: 10px !important;
            transition: background 0.3s ease !important;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(19, 236, 128, 0.4) !important;
        }

        /* Firefox */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: rgba(19, 236, 128, 0.2) rgba(255, 255, 255, 0.02) !important;
        }
    </style>
    {% block head %}{% endblock %}
</head>

<body class="bg-[#102219] dark:bg-black font-display text-[#e0e0e0] transition-colors duration-300">
    <div class="relative flex min-h-screen w-full flex-col">
        <header
            class="w-full bg-[#102219] dark:bg-black border-b border-white/10 p-4 lg:p-6 sticky top-0 z-50 transition-colors duration-300">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <a href="{{ url_for('dashboard_page') }}"
                            class="flex items-center gap-3 hover:opacity-90 transition-opacity">
                            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo"
                                class="h-9 w-auto object-contain drop-shadow-md" onerror="this.style.display='none'" />
                            <h1 id="brand-title" class="text-xl font-bold text-white tracking-wide"
                                data-refresh-part="brand">{{ brand_title or 'Admin Panel' }}</h1>
                        </a>

                        <div class="h-5 w-px bg-white/10 mx-1 hidden sm:block"></div>

                        <div class="flex items-center gap-1">
                            <button type="button" id="brand-edit"
                                class="w-9 h-9 rounded-lg flex items-center justify-center text-white/40 hover:text-white hover:bg-white/5 transition-all"
                                title="Сменить название">
                                <span class="material-symbols-outlined text-xl">edit</span>
                            </button>
                            <button type="button" id="about-info-btn"
                                class="w-9 h-9 rounded-lg flex items-center justify-center text-white/40 hover:text-white hover:bg-white/5 transition-all relative"
                                title="О проекте">
                                <span class="material-symbols-outlined text-xl">info</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        {% macro header_icon_btn(url, icon, title, text_class='text-white/70',
                        hover_class='hover:text-white', is_form=true, confirm=none, action_color='bg-white/5') %}
                        {% if is_form %}
                        <form action="{{ url }}" method="post" class="inline" {% if confirm
                            %}data-confirm="{{ confirm }}" {% endif %}>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" title="{{ title }}"
                                class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center transition-all duration-300 group hover:bg-white/10 {{ action_color }}">
                                <span
                                    class="material-symbols-outlined text-xl {{ text_class }} {{ hover_class }} group-hover:scale-110 transition-transform">{{
                                    icon }}</span>
                            </button>
                        </form>
                        {% else %}
                        <button type="button" id="{{ url }}" title="{{ title }}"
                            class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center transition-all duration-300 group hover:bg-white/10 {{ action_color }}">
                            <span
                                class="material-symbols-outlined text-xl {{ text_class }} {{ hover_class }} group-hover:scale-110 transition-transform">{{
                                icon }}</span>
                        </button>
                        {% endif %}
                        {% endmacro %}

                        {% if main_running or support_running %}
                        {{ header_icon_btn(url_for('stop_both_bots_route'), 'stop_circle', 'Остановить систему',
                        'text-red-400', 'group-hover:text-red-300', confirm='Остановить работу всех модулей?') }}
                        {% elif all_settings_ok and support_settings_ok %}
                        {{ header_icon_btn(url_for('start_both_bots_route'), 'play_circle', 'Запустить систему',
                        'text-primary', 'group-hover:text-primary') }}
                        {% endif %}

                        {{ header_icon_btn('btn-restart-bot', 'restart_alt', 'Полная перезагрузка', 'text-blue-400',
                        'group-hover:text-blue-300', is_form=false) }}
                        {{ header_icon_btn(url_for('logout_page'), 'logout', 'Выйти', 'text-white/40',
                        'group-hover:text-white') }}

                        <button type="button" id="theme-toggle-btn" title="Переключить тему"
                            class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center transition-all duration-300 group hover:bg-white/10 ml-1">
                            <span class="material-symbols-outlined text-xl text-white/50 dark:hidden">dark_mode</span>
                            <span
                                class="material-symbols-outlined text-xl text-primary hidden dark:block">light_mode</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between mt-4">
                    <nav class="flex items-center w-full gap-2 pb-1 relative">
                        <div
                            class="flex items-center gap-2 overflow-x-auto flex-1 md:flex-none no-scrollbar mask-gradient-right">
                            {% macro nav_link(endpoint, label, icon, group=[]) %}
                            {% set is_active = request.endpoint == endpoint or request.endpoint in group %}
                            <a href="{{ url_for(endpoint) }}"
                                class="flex items-center gap-2 px-4 py-2.5 rounded-xl transition-all duration-300 whitespace-nowrap flex-shrink-0 {{ 'bg-white/10 text-white shadow-lg shadow-white/5' if is_active else 'text-white/50 hover:text-white hover:bg-white/5' }}">
                                <span
                                    class="material-symbols-outlined text-[20px] {{ 'text-primary' if is_active else '' }}">{{
                                    icon }}</span>
                                <span class="text-sm font-semibold tracking-wide">{{ label }}</span>
                                <!-- Lazy loaded badge -->
                                {% if endpoint == 'support_list_page' %}
                                <span id="sidebar-support-badge"
                                    class="hidden ml-1 w-5 h-5 rounded-full bg-primary text-background-dark text-[10px] font-bold flex items-center justify-center"></span>
                                {% endif %}
                            </a>
                            {% endmacro %}

                            {{ nav_link('dashboard_page', 'Главная', 'home') }}
                            {{ nav_link('users_page', 'Пользователи', 'group') }}
                            {{ nav_link('admin_keys_page', 'Ключи', 'key') }}
                            {{ nav_link('support_list_page', 'Поддержка', 'support_agent', ['support_ticket_page']) }}
                            {{ nav_link('settings_page', 'Настройки', 'settings') }}
                        </div>

                        <div
                            class="relative group shrink-0 ml-1 pl-2 border-l border-white/5 md:border-0 md:ml-0 md:pl-0">
                            {% set is_other_active = request.endpoint in ['other_page', 'monitor_page',
                            'button_constructor_page'] %}
                            <div
                                class="flex items-center gap-2 px-4 py-2.5 rounded-xl transition-all duration-300 cursor-pointer whitespace-nowrap {{ 'bg-white/10 text-white shadow-lg shadow-white/5 border border-white/10' if is_other_active else 'text-white/70 hover:text-white hover:bg-white/5' }}">
                                <span
                                    class="material-symbols-outlined text-[20px] {{ 'text-primary' if is_other_active else '' }}">more_horiz</span>
                                <span class="text-sm font-bold tracking-tight hidden sm:inline">Прочее</span>
                                <span
                                    class="material-symbols-outlined text-[16px] opacity-50 group-hover:rotate-180 transition-transform">expand_more</span>
                            </div>

                            <!-- Dropdown Overlay -->
                            <div
                                class="absolute right-0 top-full pt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible z-[9999]">
                                <div
                                    class="w-[180px] bg-[#102219]/40 dark:bg-[#000000]/40 backdrop-blur-md border border-white/10 rounded-2xl p-1.5 shadow-[0_25px_50px_-12px_rgba(0,0,0,0.8)] flex flex-col gap-0.5">
                                    <a href="{{ url_for('monitor_page') }}"
                                        class="flex items-center gap-2.5 px-2.5 py-1.5 rounded-xl text-[#06bd5d] hover:bg-white/5 transition-all group/item">
                                        <span class="material-symbols-outlined text-[16px]">monitoring</span>
                                        <span class="text-[12px] font-semibold">Мониторинг</span>
                                    </a>
                                    <a href="{{ url_for('button_constructor_page') }}"
                                        class="flex items-center gap-2.5 px-2.5 py-1.5 rounded-xl text-[#06bd5d] hover:bg-white/5 transition-all">
                                        <span class="material-symbols-outlined text-[16px]">build</span>
                                        <span class="text-[12px] font-semibold">Конструктор кнопок</span>
                                    </a>
                                    <div class="h-px bg-white/5 my-1 mx-2"></div>
                                    <a href="{{ url_for('other_page') }}?tab=broadcast"
                                        data-base-url="{{ url_for('other_page') }}"
                                        onclick="handleOtherPageNav(event, 'broadcast')"
                                        class="flex items-center gap-2.5 px-2.5 py-1.5 rounded-xl text-white/40 hover:text-white hover:bg-white/5 transition-all">
                                        <span class="material-symbols-outlined text-[16px]">send</span>
                                        <span class="text-[12px] font-semibold">Рассылка</span>
                                    </a>
                                    <a href="{{ url_for('other_page') }}?tab=promo"
                                        data-base-url="{{ url_for('other_page') }}"
                                        onclick="handleOtherPageNav(event, 'promo')"
                                        class="flex items-center gap-2.5 px-2.5 py-1.5 rounded-xl text-white/40 hover:text-white hover:bg-white/5 transition-all">
                                        <span class="material-symbols-outlined text-[16px]">confirmation_number</span>
                                        <span class="text-[12px] font-semibold">Промо коды</span>
                                    </a>
                                    <a href="{{ url_for('other_page') }}?tab=servers"
                                        data-base-url="{{ url_for('other_page') }}"
                                        onclick="handleOtherPageNav(event, 'servers')"
                                        class="flex items-center gap-2.5 px-2.5 py-1.5 rounded-xl text-white/40 hover:text-white hover:bg-white/5 transition-all">
                                        <span class="material-symbols-outlined text-[16px]">dns</span>
                                        <span class="text-[12px] font-semibold">Сервера</span>
                                    </a>
                                    <a href="{{ url_for('other_page') }}?tab=logs"
                                        data-base-url="{{ url_for('other_page') }}"
                                        onclick="handleOtherPageNav(event, 'logs')"
                                        class="flex items-center gap-2.5 px-2.5 py-1.5 rounded-xl text-white/40 hover:text-white hover:bg-white/5 transition-all">
                                        <span class="material-symbols-outlined text-[16px]">article</span>
                                        <span class="text-[12px] font-semibold">Логи Бота</span>
                                    </a>
                                    {% if webapp_exists %}
                                    <a href="{{ url_for('other_page') }}?tab=webapp"
                                        data-base-url="{{ url_for('other_page') }}"
                                        onclick="handleOtherPageNav(event, 'webapp')"
                                        class="flex items-center gap-2.5 px-2.5 py-1.5 rounded-xl text-white/40 hover:text-white hover:bg-white/5 transition-all">
                                        <span class="material-symbols-outlined text-[16px]">language</span>
                                        <span class="text-[12px] font-semibold">WebApp</span>
                                    </a>
                                    {% endif %}
                                    <a href="{{ url_for('other_page') }}?tab=remnawave"
                                        data-base-url="{{ url_for('other_page') }}"
                                        onclick="handleOtherPageNav(event, 'remnawave')"
                                        class="flex items-center gap-2.5 px-2.5 py-1.5 rounded-xl text-white/40 hover:text-white hover:bg-white/5 transition-all">
                                        <span class="material-symbols-outlined text-[16px]">graphic_eq</span>
                                        <span class="text-[12px] font-semibold">Remnawave</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div class="items-center gap-3 hidden lg:flex pl-4 border-l border-white/10 ml-4">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-white/30">Status</span>
                        {% macro status_indicator(color, label, pulse=false) %}
                        <div
                            class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-{{ color }}/10 border border-{{ color }}/20">
                            <span class="relative flex h-2 w-2">
                                {% if pulse %}<span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-{{ color }} opacity-75"></span>{%
                                endif %}
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-{{ color }}"></span>
                            </span>
                            <span class="text-xs font-bold text-{{ color }} uppercase tracking-wider">{{ label }}</span>
                        </div>
                        {% endmacro %}

                        {% if main_running and support_running %}
                        {{ status_indicator('primary', 'Live', true) }}
                        {% elif main_running or support_running %}
                        {{ status_indicator('yellow-400', 'Limited', true) }}
                        {% else %}
                        {{ status_indicator('red-500', 'Stopped') }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <div id="brandModal" class="modal-overlay">
        <div class="modal-content p-6 max-w-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">edit</span>
                    Название панели
                </h3>
                <button onclick="closeModal('brandModal')"
                    class="w-8 h-8 rounded-lg flex items-center justify-center text-white/30 hover:text-white hover:bg-white/10 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form data-ajax="true" data-refresh="page" action="{{ url_for('update_brand_title_route') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="mb-6">
                    <label
                        class="block text-xs font-bold text-white/50 uppercase tracking-widest mb-2">Заголовок</label>
                    <input type="text" id="brand-input" name="title" placeholder="Введите название проекта..."
                        class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder:text-white/20 focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all outline-none" />
                    <p class="text-white/30 text-xs mt-2 ml-1">Это название будет отображаться в левом верхнем углу
                        шапки.</p>
                </div>

                <div class="flex gap-3 justify-end pt-4 border-t border-white/5">
                    <button type="button" onclick="closeModal('brandModal')"
                        class="px-5 py-2.5 rounded-xl text-sm font-bold text-white/60 hover:text-white hover:bg-white/5 transition-all">Отмена</button>
                    <button type="submit"
                        class="px-5 py-2.5 rounded-xl bg-primary text-background-dark text-sm font-bold hover:bg-primary/90 shadow-[0_0_15px_rgba(var(--primary-rgb),0.3)] transition-all">Сохранить
                        изменения</button>
                </div>
            </form>
        </div>
    </div>

    <div id="aboutModal" class="modal-overlay">
        <div class="modal-content modal-about-scale p-0 overflow-hidden">
            <div class="p-6 border-b border-white/5 flex items-center justify-between bg-white/[0.02]">
                <h3 class="text-xl font-bold text-white/90 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">info</span>
                    О проекте <span class="px-2 py-0.5 rounded-md bg-white/5 text-white/40 text-xs font-mono ml-2">v{{
                        project_info.version }}</span>
                </h3>
                <button onclick="closeModal('aboutModal')"
                    class="w-8 h-8 rounded-lg flex items-center justify-center text-white/30 hover:text-white hover:bg-white/10 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-6 space-y-6">
                <div id="update-notification"
                    class="hidden relative overflow-hidden rounded-2xl bg-gradient-to-br from-primary/20 via-primary/10 to-transparent border border-primary/30 p-5 shadow-[0_0_30px_-10px_rgba(19,236,128,0.3)] group transition-all duration-500 hover:shadow-[0_0_40px_-5px_rgba(19,236,128,0.4)] backdrop-blur-xl">
                    <div
                        class="absolute -right-10 -top-10 w-32 h-32 bg-primary/20 rounded-full blur-3xl group-hover:bg-primary/30 transition-all duration-700">
                    </div>
                    <div class="relative flex items-center gap-5">
                        <div
                            class="flex-shrink-0 w-12 h-12 rounded-2xl bg-primary/20 flex items-center justify-center text-primary shadow-inner border border-primary/20">
                            <span class="material-symbols-outlined text-3xl animate-spin-slow">sync</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="text-white font-black text-lg tracking-tight">Новая версия!
                                </h4>
                                <span id="latest-version"
                                    class="ml-3 px-3 py-1 rounded-full bg-primary text-[#1a2f24] text-sm font-black uppercase ring-1 ring-[#1a2f24]/20"></span>
                            </div>
                            <p class="text-white/60 text-xs leading-relaxed mb-0">Стабильное
                                обновление готово к
                                установке</p>
                        </div>
                        <a href="{{ project_info.links.repository }}" target="_blank"
                            class="flex-shrink-0 w-12 h-12 rounded-2xl bg-primary text-background-dark flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95 shadow-lg shadow-primary/30">
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </a>
                    </div>

                    <!-- Install Command Block -->
                    <div
                        class="mt-4 p-3 rounded-xl bg-black/40 border border-white/5 font-mono text-[10px] space-y-2 group/cmd relative">
                        <div class="flex items-center justify-between text-white/30 mb-1">
                            <span class="flex items-center gap-1.5 uppercase tracking-widest font-bold">
                                <span class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
                                Terminal
                            </span>
                        </div>
                        <div class="text-primary/70 mb-1"># Запустить установщик (загружает свежую версию)</div>
                        <div class="text-white/90 break-all select-all pr-8">curl -sSL
                            https://raw.githubusercontent.com/CyberERROR/remnawave-shopbot/main/install.sh | bash</div>
                        <button
                            onclick="navigator.clipboard.writeText('curl -sSL https://raw.githubusercontent.com/CyberERROR/remnawave-shopbot/main/install.sh | bash'); showToast('success', 'Команда скопирована')"
                            class="absolute right-3 bottom-3 text-white/20 hover:text-primary transition-colors p-1.5 rounded-lg hover:bg-white/5">
                            <span class="material-symbols-outlined text-sm">content_copy</span>
                        </button>
                    </div>
                </div>

                <div class="space-y-3">
                    {% set links = [
                    (project_info.links.repository, 'code', 'Репозиторий проекта', 'Исходный код и документация',
                    'text-white', 'text-white/50'),
                    (project_info.links.releases, 'deployed_code', 'Список изменений', 'История версий и релизы',
                    'text-blue-400', 'text-blue-400/50'),
                    (project_info.links.telegram, 'groups', 'Telegram сообщество', 'Чат поддержки и обсуждения',
                    'text-sky-400', 'text-sky-400/50'),
                    (project_info.links.developer, 'person', 'Разработчик', 'Автор проекта', 'text-purple-400',
                    'text-purple-400/50')
                    ] %}
                    {% for url, icon, title, desc, icon_color, desc_color in links %}
                    <a href="{{ url }}" target="_blank"
                        class="flex items-center gap-4 p-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 transition-all group">
                        <div
                            class="w-10 h-10 rounded-xl bg-black/20 flex items-center justify-center {{ icon_color }} group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined">{{ icon }}</span>
                        </div>
                        <div class="flex-1">
                            <h5 class="text-white font-bold text-sm">{{ title }}</h5>
                            <p class="text-xs {{ desc_color }}">{{ desc }}</p>
                        </div>
                        <span
                            class="material-symbols-outlined text-white/20 group-hover:text-white transition-colors">chevron_right</span>
                    </a>
                    {% endfor %}
                </div>
            </div>

            <div class="p-4 bg-black/20 text-center border-t border-white/5">
                <p class="text-xs font-bold text-white/20 uppercase tracking-widest">Designed by {{
                    project_info.author
                    }}</p>
            </div>
        </div>
    </div>

    <!-- Global Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="modal-overlay">
        <div class="modal-content p-6 max-w-md text-center">
            <div
                class="w-16 h-16 rounded-2xl bg-red-500/10 flex items-center justify-center text-red-500 mx-auto mb-4 border border-red-500/10 shadow-[0_0_30px_rgba(239,68,68,0.15)]">
                <span class="material-symbols-outlined text-3xl">warning</span>
            </div>
            <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-2">Вы уверены?</h3>
            <p id="confirm-modal-text" class="text-white/60 text-sm leading-relaxed mb-8">Это действие необратимо.
                Пожалуйста, подтвердите выполнение.</p>

            <div class="grid grid-cols-2 gap-3">
                <button type="button" onclick="closeConfirmModal(false)"
                    class="px-5 py-3 rounded-xl bg-white/5 text-white font-bold hover:bg-white/10 transition-all border border-white/5">
                    Отмена
                </button>
                <button type="button" onclick="closeConfirmModal(true)"
                    class="px-5 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 shadow-lg shadow-red-500/20 transition-all">
                    Да, выполнить
                </button>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <script id="flash-messages" type="application/json">{{ messages|tojson }}</script>
    {% endif %}
    {% endwith %}

    <script>
        // ===== УВЕДОМЛЕНИЯ TOAST =====
        // Функция для отображения всплывающих сообщений
        window.showToast = function (type, message, duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-70">×</button>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };
        // ===== Конец функции showToast =====

        // ===== ОБРАБОТКА СИСТЕМНЫХ СООБЩЕНИЙ =====
        // Вывод уведомлений от сервера при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            const flashEl = document.getElementById('flash-messages');
            if (flashEl) try {
                JSON.parse(flashEl.textContent || '[]').forEach(item => {
                    const type = item[0] === 'danger' ? 'danger' : (item[0] === 'success' ? 'success' : 'warning');
                    window.showToast(type, item[1] || '');
                });
            } catch (e) { }
        });
        // ===== Конец обработки сообщений =====

        // ===== УПРАВЛЕНИЕ МОДАЛЬНЫМИ ОКНАМИ =====
        // Функции открытия, закрытия и обработки кликов вне окон
        window.openModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('open');
        };

        window.getCsrfToken = function () {
            return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                document.querySelector('input[name="csrf_token"]')?.value || "";
        };

        window.closeModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('open');
        };

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) e.target.classList.remove('open');
        });
        // ===== Конец блока модальных окон =====

        // ===== ГЛОБАЛЬНЫЕ ОБРАБОТЧИКИ КЛАВИАТУРЫ =====
        // Закрытие всех активных окон по клавише Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
        });
        // ===== Конец обработчиков клавиатуры =====

        // ===== НАВИГАЦИЯ DROPDOWN =====
        // ===== НАВИГАЦИЯ DROPDOWN =====
        function handleOtherPageNav(e, tab) {
            const baseUrl = e.currentTarget.dataset.baseUrl;
            const currentPath = window.location.pathname;

            // Если мы УЖЕ на странице "Прочее", просто переключаем вкладку без перезагрузки
            if (currentPath === baseUrl || currentPath === baseUrl + '/') {
                e.preventDefault();
                const tabBtn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
                if (tabBtn) {
                    tabBtn.click();
                    // Закрываем выпадающее меню
                    document.querySelectorAll('[id*="dropdown"]').forEach(m => m.classList.add('hidden'));
                }
                // Обновляем URL без перезагрузки
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('tab', tab);
                window.history.pushState({}, '', newUrl);
            }
            // Если мы на другой странице, ссылка отработает штатно (redirect с ?tab=...)
        }

        window.getCsrfToken = function () {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        };

        // ===== ФУНКЦИЯ: Асинхронное обновление бейджей =====
        // Загружает количество тикетов без перезагрузки всей страницы
        const updateGlobalBadges = async () => {
            try {
                const badge = document.getElementById('sidebar-support-badge');
                if (!badge) return;

                const res = await fetch("{{ url_for('support_badge_counts_json') }}");

                if (res.ok) {
                    const data = await res.json();
                    if (data.ok && data.open_count > 0) {
                        badge.textContent = data.open_count;
                        badge.classList.remove('hidden');
                        badge.style.display = 'flex';

                        // Анимация если есть ожидающие
                        if (data.waiting_tickets_count > 0) {
                            badge.classList.add('animate-bg-pulse');
                        } else {
                            badge.classList.remove('animate-bg-pulse');
                        }
                    } else {
                        badge.classList.add('hidden');
                        badge.style.display = 'none';
                    }
                }
            } catch (e) { console.error('Badge update error:', e); }
        };

        // Запускаем сразу и периодически обновляем
        document.addEventListener('DOMContentLoaded', () => {
            updateGlobalBadges();
            // Обновляем раз в 2 минуты (120000 мс), чтобы не спамить БД
            setInterval(updateGlobalBadges, 120000);
        });
        window.isLoginPage = (html, url) => {
            if (url && url.includes('/login')) return true;
            return typeof html === 'string' && html.includes('id' + '="login-identifier-v2"');
        };

        window.handleSessionExpiry = function () {
            if (window._isExpiring) return;
            window._isExpiring = true;
            showToast('danger', 'Сессия прервана. Нужна повторная авторизация.', 10000);
            setTimeout(() => { window.location.href = '/login'; }, 1500);
        };

        // ===== ГЛОБАЛЬНЫЙ ПЕРЕХВАТ FETCH =====
        const originalFetch = window.fetch;
        window.fetch = async function (...args) {
            let response;
            try {
                response = await originalFetch.apply(this, args);
            } catch (err) {
                throw err;
            }

            if (response.status === 401 || response.status === 403) {
                if (window.handleSessionExpiry) window.handleSessionExpiry();
                return response;
            }

            // Перехват HTML-ответа с авторизацией (если бэкенд возвращает 200 OK со страницей входа)
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                const clone = response.clone();
                try {
                    const text = await clone.text();
                    if (window.isLoginPage && window.isLoginPage(text, response.url)) {
                        if (window.handleSessionExpiry) window.handleSessionExpiry();
                        return new Response('Session expired', { status: 401, statusText: 'Unauthorized' });
                    }
                } catch (e) {
                    console.error('Fetch intercept error:', e);
                }
            }
            return response;
        };

        // ===== СЕТЕВЫЕ ЗАПРОСЫ API =====
        // Универсальная функция для выполнения HTTP-запросов с CSRF
        window.apiRequest = async function (url, options = {}) {
            const defaults = {
                method: options.body ? 'POST' : 'GET',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': getCsrfToken() }
            };
            const config = { ...defaults, ...options };
            if (config.body && typeof config.body === 'object' && !(config.body instanceof FormData)) {
                const fd = new FormData();
                fd.append('csrf_token', getCsrfToken());
                for (const k in config.body) fd.append(k, config.body[k]);
                config.body = fd;
            }
            const resp = await fetch(url, config);
            if (!resp.ok) {
                if (resp.status === 401) { handleSessionExpiry(); return null; }
                throw new Error(resp.statusText);
            }
            const contentType = resp.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) return await resp.json();
            const text = await resp.text();
            if (isLoginPage(text, resp.url)) { handleSessionExpiry(); return null; }
            return text;
        };
        // ===== Конец функции apiRequest =====

        // ===== ДИАЛОГ ПОДТВЕРЖДЕНИЯ (MODAL) =====
        let confirmResolver = null;
        window.showCustomConfirm = function (message, title = 'Вы уверены?') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                const titleEl = document.getElementById('confirm-modal-title');
                const textEl = document.getElementById('confirm-modal-text');
                if (titleEl) titleEl.textContent = title;
                if (textEl) textEl.textContent = message;
                modal.classList.add('open');
                confirmResolver = resolve;
            });
        }
        window.closeConfirmModal = function (result) {
            const modal = document.getElementById('custom-confirm-modal');
            modal.classList.remove('open');
            if (confirmResolver) confirmResolver(result);
            confirmResolver = null;
        }


        window.showConfirmModal = async function (titleOrMessage, messageOrCallback, callback) {
            let title = 'Подтверждение';
            let message = '';
            let cb = null;

            if (typeof messageOrCallback === 'function') {
                // Вызов: showConfirmModal(message, callback)
                message = titleOrMessage;
                cb = messageOrCallback;
            } else {
                // Вызов: showConfirmModal(title, message, callback)
                title = titleOrMessage;
                message = messageOrCallback;
                cb = callback;
            }

            const confirmed = await showCustomConfirm(message, title);
            if (confirmed && cb) cb();
        };

        document.addEventListener('submit', async (e) => {
            const form = e.target;
            const action = form.action || '';
            const isBotControl = action.includes('/stop-both-bots') || action.includes('/start-both-bots');

            if (isBotControl) {
                e.preventDefault();
                e.stopPropagation();

                const confirmMsg = form.getAttribute('data-confirm');
                if (confirmMsg) {
                    const confirmed = await showCustomConfirm(confirmMsg);
                    if (!confirmed) return;
                }

                try {
                    const formData = new FormData(form);
                    const res = await fetch(action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });

                    const data = await res.json();
                    const messageType = data.ok ? 'success' : 'warning';
                    showToast(messageType, data.message || 'Выполнено');

                    if (data.ok) {
                        setTimeout(() => window.location.reload(), 500);
                    }
                } catch (err) {
                    console.error(err);
                    showToast('danger', 'Ошибка отправки');
                }
                return;
            }
            // Если у формы есть свой confirm в onclick или она сама обрабатывает AJAX - не трогаем
            if (form.classList.contains('ajax-form') || form.getAttribute('data-ajax') === 'true') return;
            if (form.querySelector('[onclick*="confirm("]')) return;

            const confirmMsg = form.getAttribute('data-confirm');
            if (confirmMsg && !form.__standard_confirmed) {
                e.preventDefault();
                const confirmed = await showCustomConfirm(confirmMsg);
                if (confirmed) {
                    form.__standard_confirmed = true;
                    form.submit();
                }
            }
        });
        // ===== Конец блока подтверждения =====

        // ===== КАСТОМНЫЙ SELECT =====
        // Инициализация стилизованного выпадающего списка
        window.initSoftSelect = function (selectId, placeholder) {
            const sel = document.getElementById(selectId);
            const wrap = document.querySelector(`.soft-select[data-target="${selectId}"]`);
            if (!sel || !wrap) return;
            const toggle = wrap.querySelector('.soft-select-toggle');
            const menu = wrap.querySelector('.soft-select-menu');
            if (!toggle || !menu) return;
            function render() {
                menu.innerHTML = '';
                Array.from(sel.options || []).forEach(opt => {
                    const div = document.createElement('div');
                    div.className = 'soft-select-item' + (opt.selected ? ' is-active' : '');
                    div.dataset.value = opt.value;
                    div.textContent = opt.textContent || '';
                    div.addEventListener('click', () => {
                        sel.value = opt.value;
                        menu.querySelectorAll('.soft-select-item').forEach(el => el.classList.remove('is-active'));
                        div.classList.add('is-active');
                        const textSpan = toggle.querySelector('.soft-select-text');
                        if (textSpan) textSpan.textContent = opt.textContent || placeholder || '';
                        else toggle.textContent = opt.textContent || placeholder || '';
                        wrap.classList.remove('open');
                        sel.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                    menu.appendChild(div);
                });
                const selOpt = Array.from(sel.options || []).find(o => o.selected) || sel.options[0];
                const textSpan = toggle.querySelector('.soft-select-text');
                if (textSpan) textSpan.textContent = (selOpt && selOpt.textContent) || placeholder || '';
                else toggle.textContent = (selOpt && selOpt.textContent) || placeholder || '';
            }
            render();
            if (wrap.dataset.initialized === 'true') return;
            sel.addEventListener('change', render);
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                wrap.classList.toggle('open');
            });
            document.addEventListener('click', (e) => {
                if (!wrap.contains(e.target)) wrap.classList.remove('open');
            });
            wrap.dataset.initialized = 'true';
        };
        // ===== Конец инициализации select =====

        // ===== ОБНОВЛЕНИЕ КОНТЕЙНЕРОВ ДАННЫХ =====
        // Функция для динамической перезагрузки контента по ID
        window.refreshContainerById = async function (id) {
            const el = document.getElementById(id);
            if (!el || !el.getAttribute('data-fetch-url')) return;
            try {
                const html = await apiRequest(el.getAttribute('data-fetch-url'), { headers: { 'Accept': 'text/html' } });
                if (html) el.innerHTML = html;
            } catch (e) { }
        };
        // ===== Конец функции обновления =====

        // ===== УПРАВЛЕНИЕ НАЗВАНИЕМ ПАНЕЛИ =====
        // Скрипт для редактирования и сохранения заголовка сайта
        (function () {
            const titleEl = document.getElementById('brand-title'), editBtn = document.getElementById('brand-edit'), inputEl = document.getElementById('brand-input');
            if (!titleEl || !editBtn) return;
            editBtn.addEventListener('click', () => {
                if (inputEl) inputEl.value = titleEl.textContent.trim();
                openModal('brandModal');
            });
        })();
        // ===== Конец блока названия =====

        // ===== ПРОВЕРКА ОБНОВЛЕНИЙ =====
        // Запрос к серверу для поиска новых версий проекта
        (function () {
            const aboutBtn = document.getElementById('about-info-btn');
            if (!aboutBtn) return;
            const icon = aboutBtn.querySelector('.material-symbols-outlined');

            async function checkForUpdates() {
                if (icon) icon.classList.add('animate-spin-slow');
                try {
                    const data = await apiRequest('/update/check');
                    const updateNotification = document.getElementById('update-notification');
                    const latestVersionSpan = document.getElementById('latest-version');

                    if (data && data.update_available) {
                        aboutBtn.classList.remove('text-white/40', 'hover:text-white');
                        aboutBtn.classList.add('text-primary', 'animate-glow-pulse');
                        if (updateNotification && latestVersionSpan) {
                            latestVersionSpan.textContent = data.latest_version;
                            updateNotification.classList.remove('hidden');
                        }
                    } else {
                        aboutBtn.classList.add('text-white/40', 'hover:text-white');
                        aboutBtn.classList.remove('text-primary', 'animate-glow-pulse');
                        if (updateNotification) updateNotification.classList.add('hidden');
                    }
                } catch (e) {
                    console.error('Update check failed:', e);
                } finally {
                    if (icon) setTimeout(() => icon.classList.remove('animate-spin-slow'), 500);
                }
            }
            checkForUpdates();
            aboutBtn.addEventListener('click', async () => {
                openModal('aboutModal');
                await checkForUpdates();
            });
        })();
        // ===== Конец блока обновлений =====

        // ===== ПЕРЕЗАГРУЗКА СЕРВИСОВ =====
        // Функция для полного перезапуска бота
        (function () {
            const btn = document.getElementById('btn-restart-bot');
            if (!btn) return;
            btn.addEventListener('click', async () => {
                if (await showCustomConfirm('Перезагрузить систему? Это действие прервет работу бота на 10-20 секунд.')) {
                    try {
                        const data = await apiRequest('/other/restart', { method: 'POST' });
                        if (data && data.ok) {
                            showToast('success', data.message || 'Перезапуск инициирован');
                            btn.disabled = true; btn.classList.add('opacity-50');
                        } else { showToast('danger', (data && data.error) || 'Ошибка при перезагрузке'); }
                    } catch (e) { showToast('danger', 'Ошибка при попытке связи с сервером'); }
                }
            });
        })();

        // ===== УНИВЕРСАЛЬНЫЙ AJAX ОБРАБОТЧИК =====
        // Позволяет отправлять формы без перезагрузки страницы
        async function handleGlobalAjax(e) {
            const form = e.target.closest('form[data-ajax="true"], form.ajax-form');
            if (!form) return;

            // Блокируем всплытие, чтобы другие обработчики (например, в users.html) не перехватили запрос без подтверждения
            e.stopImmediatePropagation();

            // Проверка на подтверждение
            const confirmMsg = form.getAttribute('data-confirm');
            if (confirmMsg && !form.__confirmed) {
                e.preventDefault();
                (async () => {
                    const confirmed = await showCustomConfirm(confirmMsg);
                    if (confirmed) {
                        form.__confirmed = true;
                        form.dispatchEvent(new Event('submit', { bubbles: true }));
                        form.__confirmed = false;
                    }
                })();
                return;
            }

            e.preventDefault();
            const btn = form.querySelector('button[type="submit"]');
            const originalContent = btn ? btn.innerHTML : null;

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">sync</span>';
            }

            try {
                const formData = new FormData(form);
                if (e.submitter && e.submitter.name) {
                    formData.append(e.submitter.name, e.submitter.value);
                }
                const response = await fetch(form.action, {
                    method: form.method || 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCsrfToken() }
                });

                const contentType = response.headers.get('content-type');
                const isJson = contentType && contentType.includes('application/json');
                const data = isJson ? await response.json() : null;
                const htmlStr = !isJson ? await response.text() : null;

                if (htmlStr && isLoginPage(htmlStr, response.url)) {
                    handleSessionExpiry();
                    return;
                }

                if (response.ok) {
                    const successMsg = form.getAttribute('data-success-msg') || form.getAttribute('data-success') || (data && (data.message || data.msg)) || 'Выполнено';
                    showToast('success', successMsg);

                    // Обновление контента
                    const refreshPart = form.getAttribute('data-refresh') || form.getAttribute('data-refresh-target');
                    if (refreshPart === 'page') {
                        const res = await fetch(window.location.href);
                        const html = await res.text();
                        if (isLoginPage(html, res.url)) { handleSessionExpiry(); return; }
                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        document.querySelectorAll('[data-refresh-part]').forEach(el => {
                            const partId = el.getAttribute('data-refresh-part');
                            const newEl = doc.querySelector(`[data-refresh-part="${partId}"]`);
                            if (newEl) el.innerHTML = newEl.innerHTML;
                        });
                    } else if (refreshPart) {
                        const target = document.getElementById(refreshPart);
                        if (target && target.getAttribute('data-fetch-url')) {
                            const res = await fetch(target.getAttribute('data-fetch-url'));
                            if (res.ok) {
                                const contentType = res.headers.get('content-type');
                                if (contentType && contentType.includes('application/json')) {
                                    const json = await res.json();
                                    if (json.table_html) {
                                        target.innerHTML = json.table_html;
                                        // Если есть пагинация рядом - обновляем и её
                                        const pagId = target.id.replace('tbody', 'pagination').replace('list', 'pagination');
                                        const pagEl = document.getElementById(pagId);
                                        if (pagEl && json.pagination_html) pagEl.innerHTML = json.pagination_html;
                                    }
                                } else {
                                    const html = await res.text();
                                    if (isLoginPage(html, res.url)) { handleSessionExpiry(); return; }
                                    target.innerHTML = html;
                                }
                            }
                        }
                    }

                    // Закрытие модалок
                    if (!form.hasAttribute('data-keep-modal')) {
                        const modal = form.closest('.modal-overlay');
                        if (modal) closeModal(modal.id);
                    }

                    if (form.hasAttribute('data-reset')) form.reset();

                    // Вызов кастомного колбэка если есть
                    const callback = form.getAttribute('data-callback');
                    if (callback && typeof window[callback] === 'function') window[callback](data);

                } else {
                    const errorMsg = (data && (data.error || data.message)) || 'Ошибка сервера';
                    showToast('danger', errorMsg);
                }
            } catch (err) {
                console.error('AJAX Error:', err);
                showToast('danger', 'Ошибка сети');
            } finally {
                if (btn && originalContent !== null) {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            }
        }

        // ===== ПЕРЕКЛЮЧЕНИЕ ТЕМЫ =====
        (function () {
            const btn = document.getElementById('theme-toggle-btn');
            if (!btn) return;
            btn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        })();

        document.addEventListener('submit', handleGlobalAjax);
        // ===== Конец AJAX обработчика =====
    </script>

    {% block scripts %}{% endblock %}
</body>

</html>