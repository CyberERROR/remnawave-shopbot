<!DOCTYPE html>
<html class="dark" lang="ru">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>{% block title %}Панель управления Ботом{% endblock %}</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon-32x32.png') }}" />
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/favicon-16x16.png') }}" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon-32x32.png') }}" />
    <meta name="theme-color" content="#13ec80" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec80",
                        "background-light": "#f6f8f7",
                        "background-dark": "#102219",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>

    <style>
        .max-w-7xl {
            max-width: 90rem !important;
        }

        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-content {
            background: #102219;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.2s ease-out;
        }

        .modal-xl .modal-content {
            max-width: 1000px;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: toastIn 0.3s ease-out;
            max-width: 400px;
        }

        .toast-success {
            background: rgba(19, 236, 128, 0.9);
            color: #102219;
        }

        .toast-danger {
            background: rgba(229, 62, 62, 0.9);
        }

        .toast-warning {
            background: rgba(245, 158, 11, 0.9);
            color: #102219;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .soft-select {
            position: relative;
        }

        .soft-select-toggle {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            cursor: pointer;
        }

        .soft-select-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .soft-select-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background: #1a2f24;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
        }

        .soft-select.open .soft-select-menu {
            display: block;
        }

        .soft-select-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
        }

        .soft-select-item:hover,
        .soft-select-item.is-active {
            background: rgba(19, 236, 128, 0.1);
            color: #13ec80;
        }

        .soft-select select {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-dot-animated {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
    {% block head %}{% endblock %}
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#e0e0e0]">
    <div class="relative flex min-h-screen w-full flex-col">
        <header class="w-full bg-background-dark border-b border-white/10 p-4 lg:p-6 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2">
                        <a href="{{ url_for('dashboard_page') }}" class="flex items-center gap-2">
                            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Логотип" class="h-8"
                                onerror="this.style.display='none'" />
                            <h1 id="brand-title" class="text-2xl font-bold text-white">{{ brand_title or 'Admin Panel'
                                }}</h1>
                        </a>
                        <button type="button" id="brand-edit" class="text-white/40 hover:text-white transition-colors"
                            title="Сменить название">
                            <span class="material-symbols-outlined text-lg">edit</span>
                        </button>
                        <button type="button" id="about-info-btn"
                            class="text-white/40 hover:text-white transition-colors" title="О проекте">
                            <span class="material-symbols-outlined text-lg">info</span>
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        {% set main_running = bot_status and bot_status.is_running %}
                        {% set support_running = support_bot_status and support_bot_status.is_running %}
                        {% if main_running or support_running %}
                        <form action="{{ url_for('stop_both_bots_route') }}" method="post" class="inline"
                            data-confirm="Вы уверены, что хотите остановить бота?">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" title="Остановить"
                                class="flex min-w-[40px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 bg-[#e53e3e]/80 hover:bg-[#e53e3e] text-white transition-colors duration-200">
                                <span class="material-symbols-outlined text-xl">stop_circle</span>
                            </button>
                        </form>
                        {% else %}
                        {% if all_settings_ok and support_settings_ok %}
                        <form action="{{ url_for('start_both_bots_route') }}" method="post" class="inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" title="Запустить"
                                class="flex min-w-[40px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 bg-primary/80 hover:bg-primary text-background-dark transition-colors duration-200">
                                <span class="material-symbols-outlined text-xl">play_circle</span>
                            </button>
                        </form>
                        {% endif %}
                        {% endif %}
                        <button type="button" id="btn-restart-bot" title="Полный перезапуск бота"
                            class="flex min-w-[40px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 bg-blue-500/80 hover:bg-blue-500 text-white transition-colors duration-200">
                            <span class="material-symbols-outlined text-xl">restart_alt</span>
                        </button>
                        <form action="{{ url_for('logout_page') }}" method="post" class="inline">
                            <button type="submit" title="Выход"
                                class="flex min-w-[40px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 bg-white/10 hover:bg-white/20 text-white transition-colors duration-200">
                                <span class="material-symbols-outlined text-xl">logout</span>
                            </button>
                        </form>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <nav class="flex items-center gap-1.5 overflow-x-auto">
                        <a class="flex items-center gap-2 px-3 py-2 rounded-lg {% if request.endpoint == 'dashboard_page' %}bg-primary/20 text-primary{% else %}text-white/70 hover:bg-white/5 hover:text-white{% endif %} transition-colors duration-200 flex-shrink-0"
                            href="{{ url_for('dashboard_page') }}">
                            <span
                                class="material-symbols-outlined {% if request.endpoint == 'dashboard_page' %}text-primary{% endif %} text-base">home</span>
                            <p class="text-sm font-medium leading-normal">Главная</p>
                        </a>
                        <a class="flex items-center gap-2 px-3 py-2 rounded-lg {% if request.endpoint == 'users_page' %}bg-primary/20 text-primary{% else %}text-white/70 hover:bg-white/5 hover:text-white{% endif %} transition-colors duration-200 flex-shrink-0"
                            href="{{ url_for('users_page') }}">
                            <span
                                class="material-symbols-outlined {% if request.endpoint == 'users_page' %}text-primary{% endif %} text-base">group</span>
                            <p class="text-sm font-medium leading-normal">Пользователи</p>
                        </a>
                        <a class="flex items-center gap-2 px-3 py-2 rounded-lg {% if request.endpoint == 'admin_keys_page' %}bg-primary/20 text-primary{% else %}text-white/70 hover:bg-white/5 hover:text-white{% endif %} transition-colors duration-200 flex-shrink-0"
                            href="{{ url_for('admin_keys_page') }}">
                            <span
                                class="material-symbols-outlined {% if request.endpoint == 'admin_keys_page' %}text-primary{% endif %} text-base">key</span>
                            <p class="text-sm font-medium leading-normal">Ключи</p>
                        </a>
                        <a class="flex items-center gap-2 px-3 py-2 rounded-lg {% if request.endpoint in ['support_list_page', 'support_ticket_page'] %}bg-primary/20 text-primary{% else %}text-white/70 hover:bg-white/5 hover:text-white{% endif %} transition-colors duration-200 flex-shrink-0"
                            href="{{ url_for('support_list_page') }}">
                            <span
                                class="material-symbols-outlined {% if request.endpoint in ['support_list_page', 'support_ticket_page'] %}text-primary{% endif %} text-base">support_agent</span>
                            <p class="text-sm font-medium leading-normal">Поддержка</p>
                            {% if open_tickets_count and open_tickets_count > 0 %}
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-primary/20 text-primary">
                                {{ open_tickets_count }}
                            </span>
                            {% endif %}
                        </a>
                        <a class="flex items-center gap-2 px-3 py-2 rounded-lg {% if request.endpoint == 'settings_page' %}bg-primary/20 text-primary{% else %}text-white/70 hover:bg-white/5 hover:text-white{% endif %} transition-colors duration-200 flex-shrink-0"
                            href="{{ url_for('settings_page') }}">
                            <span
                                class="material-symbols-outlined {% if request.endpoint == 'settings_page' %}text-primary{% endif %} text-base">settings</span>
                            <p class="text-sm font-medium leading-normal">Настройки</p>
                        </a>
                        <a class="flex items-center gap-2 px-3 py-2 rounded-lg {% if request.endpoint == 'monitor_page' %}bg-primary/20 text-primary{% else %}text-white/70 hover:bg-white/5 hover:text-white{% endif %} transition-colors duration-200 flex-shrink-0"
                            href="{{ url_for('monitor_page') }}">
                            <span
                                class="material-symbols-outlined {% if request.endpoint == 'monitor_page' %}text-primary{% endif %} text-base">monitoring</span>
                            <p class="text-sm font-medium leading-normal">Мониторинг</p>
                        </a>
                        <a class="flex items-center gap-2 px-3 py-2 rounded-lg {% if request.endpoint == 'other_page' %}bg-primary/20 text-primary{% else %}text-white/70 hover:bg-white/5 hover:text-white{% endif %} transition-colors duration-200 flex-shrink-0"
                            href="{{ url_for('other_page') }}">
                            <span
                                class="material-symbols-outlined {% if request.endpoint == 'other_page' %}text-primary{% endif %} text-base">more_horiz</span>
                            <p class="text-sm font-medium leading-normal">Прочее</p>
                        </a>
                    </nav>
                    <div class="items-center gap-4 hidden sm:flex ml-4">
                        <p class="text-white text-base font-medium flex-shrink-0">Статус:</p>
                        {% if main_running and support_running %}
                        <span class="flex items-center gap-2 text-primary font-bold">
                            <span class="relative flex h-3 w-3">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-primary"></span>
                            </span>
                            Запущен
                        </span>
                        {% elif main_running or support_running %}
                        <span class="flex items-center gap-2 text-yellow-400 font-bold">
                            <span class="relative flex h-3 w-3">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-400"></span>
                            </span>
                            Частично
                        </span>
                        {% else %}
                        <span class="flex items-center gap-2 text-red-400 font-bold">
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-red-400"></span>
                            Остановлен
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <div id="brandModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">Сменить название в шапке</h3>
                <button onclick="closeModal('brandModal')"
                    class="text-white/50 hover:text-white text-xl">&times;</button>
            </div>
            <input type="text" id="brand-input" placeholder="Введите название"
                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder:text-white/50 mb-2" />
            <p class="text-white/50 text-sm mb-4">Название сохранится на сервере и будет показано в шапке.</p>
            <div class="flex gap-3 justify-end">
                <button onclick="closeModal('brandModal')"
                    class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 transition-colors">Отмена</button>
                <button id="brand-save"
                    class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-primary/90 transition-colors">Сохранить</button>
            </div>
        </div>
    </div>

    <div id="aboutModal" class="modal-overlay">
        <div class="modal-content p-6" style="max-width: 500px;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">info</span>
                    О проекте - V{{ project_info.version }}
                </h3>
                <button onclick="closeModal('aboutModal')"
                    class="text-white/50 hover:text-white text-2xl transition-colors">&times;</button>
            </div>

            <div class="space-y-4">
                <a href="{{ project_info.links.repository }}" target="_blank"
                    class="flex items-center gap-3 p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors group">
                    <div
                        class="flex-shrink-0 w-10 h-10 bg-primary/20 rounded-lg flex items-center justify-center group-hover:bg-primary/30 transition-colors">
                        <span class="material-symbols-outlined text-primary">code</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium">Репозиторий / Обновления</p>
                        <p class="text-white/50 text-sm truncate">{{ project_info.links.repository.replace('https://',
                            '') }}</p>
                    </div>
                    <span
                        class="material-symbols-outlined text-white/30 group-hover:text-white/50 transition-colors">arrow_forward</span>
                </a>

                <a href="{{ project_info.links.releases }}" target="_blank"
                    class="flex items-center gap-3 p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors group">
                    <div
                        class="flex-shrink-0 w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center group-hover:bg-blue-500/30 transition-colors">
                        <span class="material-symbols-outlined text-blue-400">new_releases</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium">Релизы</p>
                        <p class="text-white/50 text-sm truncate">{{ project_info.links.releases.replace('https://',
                            '').replace('/remnawave-shopbot', '/...') }}</p>
                    </div>
                    <span
                        class="material-symbols-outlined text-white/30 group-hover:text-white/50 transition-colors">arrow_forward</span>
                </a>

                <a href="{{ project_info.links.telegram }}" target="_blank"
                    class="flex items-center gap-3 p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors group">
                    <div
                        class="flex-shrink-0 w-10 h-10 bg-cyan-500/20 rounded-lg flex items-center justify-center group-hover:bg-cyan-500/30 transition-colors">
                        <span class="material-symbols-outlined text-cyan-400">groups</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium">Telegram группа</p>
                        <p class="text-white/50 text-sm truncate">Сообщество и поддержка</p>
                    </div>
                    <span
                        class="material-symbols-outlined text-white/30 group-hover:text-white/50 transition-colors">arrow_forward</span>
                </a>

                <a href="{{ project_info.links.developer }}" target="_blank"
                    class="flex items-center gap-3 p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors group">
                    <div
                        class="flex-shrink-0 w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center group-hover:bg-purple-500/30 transition-colors">
                        <span class="material-symbols-outlined text-purple-400">person</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium">Разработчик</p>
                        <p class="text-white/50 text-sm truncate">{{ project_info.links.developer.replace('https://',
                            '') }}</p>
                    </div>
                    <span
                        class="material-symbols-outlined text-white/30 group-hover:text-white/50 transition-colors">arrow_forward</span>
                </a>
            </div>

            <div class="mt-6 pt-4 border-t border-white/10 text-center">
                <p class="text-white/40 text-sm">© By {{ project_info.author }}</p>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content p-6" style="max-width: 400px;">
            <h3 class="text-lg font-bold text-white mb-3">Подтверждение</h3>
            <p id="confirmationMessage" class="text-white/70 mb-6">Вы уверены?</p>
            <div class="flex gap-3 justify-end">
                <button onclick="closeModal('confirmationModal')"
                    class="px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 transition-colors">Отмена</button>
                <button id="confirmBtn"
                    class="px-4 py-2 rounded-lg bg-red-500 text-white font-bold hover:bg-red-600 transition-colors">Да</button>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <script id="flash-messages" type="application/json">{{ messages|tojson }}</script>
    {% endif %}
    {% endwith %}

    <script>
        window.showToast = function (type, message, duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-70">×</button>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };

        document.addEventListener('DOMContentLoaded', function () {
            const flashEl = document.getElementById('flash-messages');
            if (flashEl) {
                try {
                    const messages = JSON.parse(flashEl.textContent || '[]');
                    messages.forEach(function (item) {
                        const category = item[0] || 'secondary';
                        const message = item[1] || '';
                        const type = category === 'danger' ? 'danger' : (category === 'success' ? 'success' : 'warning');
                        window.showToast(type, message);
                    });
                } catch (e) { }
            }
        });

        window.openModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('open');
        };

        window.closeModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('open');
        };

        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('open');
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
            }
        });

        window.getCsrfToken = function () {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        };

        let confirmCallback = null;

        window.showConfirmModal = function (message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            const msgEl = document.getElementById('confirmationMessage');
            const btn = document.getElementById('confirmBtn');

            if (msgEl) msgEl.textContent = message;

            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.addEventListener('click', function () {
                closeModal('confirmationModal');
                if (onConfirm) onConfirm();
            });

            openModal('confirmationModal');
        };

        document.addEventListener('submit', function (e) {
            const form = e.target;
            const confirmMsg = form.getAttribute('data-confirm');
            if (confirmMsg) {
                e.preventDefault();
                showConfirmModal(confirmMsg, () => {
                    form.submit();
                });
            }
        });

        window.initSoftSelect = function (selectId, placeholder) {
            const sel = document.getElementById(selectId);
            const wrap = document.querySelector(`.soft-select[data-target="${selectId}"]`);
            if (!sel || !wrap) return;

            const toggle = wrap.querySelector('.soft-select-toggle');
            const menu = wrap.querySelector('.soft-select-menu');
            if (!toggle || !menu) return;

            function render() {
                menu.innerHTML = '';
                Array.from(sel.options || []).forEach(opt => {
                    const div = document.createElement('div');
                    div.className = 'soft-select-item' + (opt.selected ? ' is-active' : '');
                    div.dataset.value = opt.value;
                    div.textContent = opt.textContent || '';
                    div.addEventListener('click', () => {
                        sel.value = opt.value;
                        menu.querySelectorAll('.soft-select-item').forEach(el => el.classList.remove('is-active'));
                        div.classList.add('is-active');
                        toggle.textContent = opt.textContent || placeholder || '';
                        wrap.classList.remove('open');
                        sel.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                    menu.appendChild(div);
                });
                const selOpt = Array.from(sel.options || []).find(o => o.selected) || sel.options[0];
                toggle.textContent = (selOpt && selOpt.textContent) || placeholder || '';
            }

            render();
            sel.addEventListener('change', render);

            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                wrap.classList.toggle('open');
            });

            document.addEventListener('click', (e) => {
                if (!wrap.contains(e.target)) wrap.classList.remove('open');
            });
        };

        window.refreshContainerById = async function (id) {
            const el = document.getElementById(id);
            if (!el) return;
            const url = el.getAttribute('data-fetch-url');
            if (!url) return;
            try {
                const resp = await fetch(url, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
                if (resp.ok) {
                    const html = await resp.text();
                    if (html) el.innerHTML = html;
                }
            } catch (e) { }
        };

        (function () {
            const titleEl = document.getElementById('brand-title');
            const editBtn = document.getElementById('brand-edit');
            const inputEl = document.getElementById('brand-input');
            const saveBtn = document.getElementById('brand-save');
            if (!titleEl || !editBtn) return;

            editBtn.addEventListener('click', () => {
                if (inputEl) inputEl.value = titleEl.textContent.trim();
                openModal('brandModal');
            });

            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    const val = (inputEl.value || '').trim();
                    if (!val) {
                        showToast('warning', 'Введите название');
                        return;
                    }
                    try {
                        const fd = new FormData();
                        fd.append('csrf_token', getCsrfToken());
                        fd.append('title', val);
                        const resp = await fetch('{{ url_for("update_brand_title_route") }}', { method: 'POST', body: fd, credentials: 'same-origin' });
                        if (resp.ok) {
                            titleEl.textContent = val;
                            showToast('success', 'Название сохранено');
                            closeModal('brandModal');
                        } else {
                            showToast('danger', 'Не удалось сохранить название');
                        }
                    } catch (e) {
                        showToast('danger', 'Ошибка сети');
                    }
                });
            }
        })();

        (function () {
            const aboutBtn = document.getElementById('about-info-btn');
            if (!aboutBtn) return;

            aboutBtn.addEventListener('click', () => {
                openModal('aboutModal');
            });
        })();

        (function () {
            const btn = document.getElementById('btn-restart-bot');
            if (!btn) return;

            btn.addEventListener('click', async () => {
                showConfirmModal('Вы уверены, что хотите полностью перезагрузить бота (контейнер)? Это займет 10-20 секунд.', async () => {
                    executeRestart();
                });
            });

            async function executeRestart() {
                try {
                    const fd = new FormData();
                    fd.append('csrf_token', getCsrfToken());

                    const resp = await fetch('/other/restart', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCsrfToken() },
                        body: fd
                    });

                    const data = await resp.json();

                    if (data.ok) {
                        showToast('success', data.message || 'Перезагрузка...');
                        btn.disabled = true;
                        btn.classList.add('opacity-50');
                    } else {
                        showToast('danger', data.error || 'Ошибка перезагрузки');
                    }
                } catch (e) {
                    showToast('danger', 'Ошибка соединения с сервером (возможно перезагрузка уже идет)');
                }
            }
        })();
    </script>

    {% block scripts %}{% endblock %}
</body>

</html>