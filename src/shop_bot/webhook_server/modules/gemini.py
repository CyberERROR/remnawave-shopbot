from flask import Blueprint, request, jsonify, render_template
from shop_bot.data_manager.database import get_setting, update_setting, get_other_setting, update_other_setting
import logging
import httpx

logger = logging.getLogger(__name__)

# –ü–æ–ª–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç –ø—Ä–æ–º—Ç–∞)
DEFAULT_KNOWLEDGE_BASE = (
    "–¢—ã –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ VPN-—Å–µ—Ä–≤–∏—Å–∞.\n\n"
    "=== –°–¢–†–£–ö–¢–£–†–ê –°–ï–†–í–ò–°–ê ===\n"
    "–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–¥–µ–ª—ã:\n"
    "- üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é - –≤–æ–∑–≤—Ä–∞—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é\n"
    "- üë§ –ü—Ä–æ—Ñ–∏–ª—å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ –∏ –ø–æ–¥–ø–∏—Å–∫–µ\n"
    "- üõí –ö—É–ø–∏—Ç—å - –ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–∫—É–ø–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏\n"
    "- üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞ - –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É\n"
    "- üîë –ú–æ–∏ –∫–ª—é—á–∏ - –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
    "- ‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ\n\n"
    
    "=== –ü–û–ö–£–ü–ö–ê –ù–û–í–û–ì–û –ö–õ–Æ–ß–ê ===\n"
    "–†–∞–∑–¥–µ–ª '–ö—É–ø–∏—Ç—å' ‚Üí –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞ ‚Üí –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞\n"
    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ:\n"
    "1. –í—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∏–ø —Å–µ—Ä–≤–µ—Ä–∞ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤)\n"
    "2. –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–∞ –Ω—É–∂–Ω—ã–π —Å—Ä–æ–∫ (–¥–æ—Å—Ç—É–ø–Ω—ã —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏)\n\n"
    
    "=== –ü–†–û–î–õ–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ö–õ–Æ–ß–ê ===\n"
    "–†–∞–∑–¥–µ–ª '–ú–æ–∏ –∫–ª—é—á–∏' ‚Üí –í—ã–±–æ—Ä –∫–ª—é—á–∞ ‚Üí '–ü—Ä–æ–¥–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á'\n"
    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–∞ –Ω—É–∂–Ω—ã–π —Å—Ä–æ–∫ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.\n\n"
    
    "–†–ê–ó–î–ï–õ '–ú–û–ò –ö–õ–Æ–ß–ò' (–ú–û–ò –ü–û–î–ü–ò–°–ö–ò):\n"
    "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
    "- –ù–æ–º–µ—Ä –∫–ª—é—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, #1, #2)\n"
    "- –¢–∏–ø —Å–µ—Ä–≤–µ—Ä–∞\n"
    "- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤ –¥–Ω—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: 30 –¥–Ω–µ–π)\n"
    "- –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (‚úÖ –∞–∫—Ç–∏–≤–µ–Ω)\n"
    "–î–µ–π—Å—Ç–≤–∏—è:\n"
    "- üõí –ö—É–ø–∏—Ç—å –∫–ª—é—á - –ø–æ–∫—É–ø–∫–∞ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏\n"
    "- üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é\n\n"
    
    "–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–î–ü–ò–°–ö–ï (–ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª—é—á–∞):\n"
    "- üîë –ù–æ–º–µ—Ä –∫–ª—é—á–∞\n"
    "- üìÖ –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω: –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\n"
    "- ‚è± –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\n"
    "- üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É\n"
    "–î–µ–π—Å—Ç–≤–∏—è —Å –∫–ª—é—á–æ–º:\n"
    "- üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
    "- ‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏\n"
    "- üì± –ü–æ–∫–∞–∑–∞—Ç—å QR-–∫–æ–¥ - QR –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
    "- üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º\n"
    "- üîô –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–ª—é—á–µ–π\n\n"
    
    "–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Æ:\n"
    "–í—ã–±–æ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n"
    "- üì± Android\n"
    "- üçé iOS\n"
    "- üíª Windows\n"
    "- üêß Linux\n"
    "–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ VLESS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
    "- üîô –ù–∞–∑–∞–¥ –∫ –∫–ª—é—á—É\n\n"
    
    "–†–ê–ó–î–ï–õ '–ü–†–û–§–ò–õ–¨' –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:\n"
    "- üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (username)\n"
    "- üí∞ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ (–≤ RUB)\n"
    "- üìÖ –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ –º–µ—Å—è—Ü–µ–≤ (–æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)\n"
    "- ‚úÖ –°—Ç–∞—Ç—É—Å VPN (–ê–∫—Ç–∏–≤–µ–Ω/–ù–µ–∞–∫—Ç–∏–≤–µ–Ω)\n"
    "- ‚è± –û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–Ω–∏ –∏ —á–∞—Å—ã)\n"
    "- üíé –û—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å (–≤ RUB)\n"
    "- ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤)\n"
    "- üíµ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ —Ä–µ—Ñ–µ—Ä—Ä–∞–ª–∫–µ (–≤—Å–µ–≥–æ –≤ RUB)\n"
    "–î–µ–π—Å—Ç–≤–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ:\n"
    "- üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å - –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–æ–∫\n"
    "- ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n"
    "- üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é\n\n"
    
    "–ü–û–ü–û–õ–ù–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê:\n"
    "- –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: 200 RUB\n"
    "- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π\n"
    "- –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã - –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (–°–ë–ü/–ö–∞—Ä—Ç–∞, –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞, Telegram Stars)\n"
    "- –°—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ\n\n"
    
    "–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –ì–ï–ù–ï–†–ê–¶–ò–ò –û–¢–í–ï–¢–ê:\n"
    "1. –≠–¢–û –û–¢–í–ï–¢ –¢–ï–•–ù–ò–ß–ï–°–ö–û–ô –ü–û–î–î–ï–†–ñ–ö–ò –í TELEGRAM –ß–ê–¢–ï.\n"
    "2. –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ö–†–ê–¢–ö–û–°–¢–¨. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ–π ‚Äî –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –ù–ï –õ–ï–ô –í–û–î–£.\n"
    "3. –ù–ï –ü–û–í–¢–û–†–Ø–ô–°–Ø. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–∂–µ –ø—Ä–∏–Ω—è—Ç ‚Äî –Ω–µ –ø–∏—à–∏ —ç—Ç–æ —Å–Ω–æ–≤–∞.\n"
    "4. –°–¢–†–û–ì–û –ë–ï–ó Markdown (bold, italic) –∏ HTML. –ü–ò–®–ò –ü–†–û–°–¢–´–ú –¢–ï–ö–°–¢–û–ú.\n"
    "5. –°–¢–ò–õ–¨: –ñ–ò–í–û–ô, –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô, –ù–û –ü–†–û–°–¢–û–ô.\n"
    "6. –ò–ó–ë–ï–ì–ê–ô '–ò–ò-–ú–ê–†–ö–ï–†–û–í'.\n"
    "7. –≠–ú–û–î–ó–ò: —É–º–µ—Ä–µ–Ω–Ω–æ (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)."
)

def _build_final_prompt(db_prompt, messages, current_draft):
    """
    –°—Ç—Ä–æ–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è Gemini.
    –ï—Å–ª–∏ db_prompt –∑–∞–¥–∞–Ω -> –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –±–∞–∑—É (–ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç—Å—è, —á—Ç–æ –∞–¥–º–∏–Ω —Å–∞–º –Ω–∞—Å—Ç—Ä–æ–∏–ª –ø—Ä–∞–≤–∏–ª–∞).
    –ï—Å–ª–∏ db_prompt –ø—É—Å—Ç -> –∏—Å–ø–æ–ª—å–∑—É–µ–º DEFAULT_KNOWLEDGE_BASE (—Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏).
    –í –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∏—Å—Ç–æ—Ä–∏—é –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.
    """
    
    # 1. –í—ã–±–∏—Ä–∞–µ–º –±–∞–∑—É
    if db_prompt and db_prompt.strip():
        base_system_content = db_prompt.strip()
    else:
        base_system_content = DEFAULT_KNOWLEDGE_BASE

    # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
    if not messages:
        history_text = "–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –ø—É—Å—Ç–∞."
    else:
        history_lines = []
        for m in messages:
            sender = "Admin" if m['sender'] == 'admin' else "User"
            content = m['content'] or ""
            history_lines.append(f"{sender}: {content}")
        history_text = "\n".join(history_lines)

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∑–∞–¥–∞—á–µ
    instruction_part = "–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–æ—Ç –∏–º–µ–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏) –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞."
    user_input_part = ""

    if current_draft:
        user_input_part = f"–í–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: \"{current_draft}\""
        instruction_part = "–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –û–¢–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ —ç—Ç–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫. –ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ –∏ —Å–¥–µ–ª–∞–π –µ–≥–æ –≤–µ–∂–ª–∏–≤–µ–µ, –Ω–æ –°–¢–†–û–ì–û –°–û–•–†–ê–ù–ò –ö–†–ê–¢–ö–û–°–¢–¨ –ò –°–ú–´–°–õ."

    # 4. –ü—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    has_admin_reply = any(m.get('sender') == 'admin' for m in messages)
    greeting_rule = "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—á–Ω–∏ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è." if not has_admin_reply else "–ë–µ–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π."

    # 5. –°–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º—Ç–∞
    final_prompt = (
        f"{base_system_content}\n\n"
        f"=== –ö–û–ù–¢–ï–ö–°–¢ ===\n"
        f"–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞:\n{history_text}\n\n"
        f"{user_input_part}\n"
        f"{instruction_part}\n"
        f"–ü—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: {greeting_rule}"
    )
    
    return final_prompt

def _call_gemini_api(api_key, prompt):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Gemini API.
    """
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={api_key}"
    payload = {
        "contents": [{
            "parts": [{"text": prompt}]
        }]
    }
    
    with httpx.Client(timeout=30.0) as client:
        resp = client.post(url, json=payload)
    
    if resp.status_code != 200:
        logger.error(f"Gemini API Error: {resp.status_code} {resp.text}")
        raise Exception(f"Gemini API Error: {resp.status_code}")
    
    resp_data = resp.json()
    try:
        candidates = resp_data.get('candidates', [])
        if not candidates:
            raise Exception("No candidates returned from AI")
        
        parts = candidates[0].get('content', {}).get('parts', [])
        if not parts:
            raise Exception("No parts in AI response")
            
        return parts[0].get('text', '')
    except Exception as e:
        logger.error(f"Error parsing Gemini response: {e}")
        raise Exception("Failed to parse AI response")

def register_gemini_routes(app, login_required):
    """
    Registers the routes for Gemini API key management and generation.
    """
    
    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ (GET/POST)
    def handle_server_gemini_settings():
        try:
            if request.method == 'POST':
                data = request.get_json(silent=True)
                if not data:
                     return jsonify({'ok': False, 'error': 'No data provided'}), 400
                
                new_key = data.get('key')
                new_prompt = data.get('prompt')

                if new_key is not None:
                    update_setting('key_gemini', new_key)
                if new_prompt is not None:
                    update_other_setting('sg_promt', new_prompt)
                    
                return jsonify({'ok': True})
            else:
                key = get_setting('key_gemini')
                prompt = get_other_setting('sg_promt', "")
                return jsonify({'ok': True, 'key': key, 'prompt': prompt})
        except Exception as e:
            logger.error(f"Error in Gemini settings: {e}")
            return jsonify({'ok': False, 'error': str(e)}), 500

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –µ–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ä–∞–∑–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    app.route('/admin/gemini/settings', methods=['GET', 'POST'], endpoint='gemini_settings')(login_required(handle_server_gemini_settings))
    app.route('/admin/gemini/key', methods=['GET', 'POST'], endpoint='gemini_key')(login_required(handle_server_gemini_settings))

    @app.route('/admin/gemini/generate', methods=['POST'])
    @login_required
    def generate_gemini_response():
        try:
            data = request.get_json(silent=True)
            if not data or 'ticket_id' not in data:
                return jsonify({'ok': False, 'error': 'Missing ticket_id'}), 400
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á
            api_key = get_setting('key_gemini')
            if not api_key:
                 return jsonify({'ok': False, 'error': 'API Key not configured'}), 400
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
            from shop_bot.data_manager.database import get_ticket_messages
            messages = get_ticket_messages(data['ticket_id'])
            
            # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–º—Ç–∞
            db_prompt = get_other_setting('sg_promt')
            
            # –°—Ç—Ä–æ–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç
            final_prompt = _build_final_prompt(
                db_prompt=db_prompt,
                messages=messages,
                current_draft=data.get('current_text', '')
            )
            
            # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
            generated_text = _call_gemini_api(api_key, final_prompt)
            return jsonify({'ok': True, 'response': generated_text})

        except Exception as e:
            logger.error(f"Error generating Gemini response: {e}")
            return jsonify({'ok': False, 'error': str(e)}), 500
