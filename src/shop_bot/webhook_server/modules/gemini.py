from flask import Blueprint, request, jsonify, render_template
from shop_bot.data_manager.database import get_setting, update_setting
import logging

logger = logging.getLogger(__name__)

def register_gemini_routes(app, login_required):
    """
    Registers the routes for Gemini API key management.
    """
    
    @app.route('/admin/gemini/key', methods=['GET'])
    @login_required
    def get_gemini_key():
        try:
            key = get_setting('key_gemini')
            return jsonify({'ok': True, 'key': key})
        except Exception as e:
            logger.error(f"Error fetching Gemini key: {e}")
            return jsonify({'ok': False, 'error': str(e)}), 500

    @app.route('/admin/gemini/key', methods=['POST'])
    @login_required
    def update_gemini_key():
        try:
            data = request.get_json(silent=True)
            if not data:
                 return jsonify({'ok': False, 'error': 'No data provided'}), 400
            
            new_key = data.get('key')
            if new_key is None:
                return jsonify({'ok': False, 'error': 'Missing key'}), 400

            update_setting('key_gemini', new_key)
            return jsonify({'ok': True})
        except Exception as e:
            logger.error(f"Error updating Gemini key: {e}")
            return jsonify({'ok': False, 'error': str(e)}), 500

    @app.route('/admin/gemini/generate', methods=['POST'])
    @login_required
    def generate_gemini_response():
        try:
            data = request.get_json(silent=True)
            if not data or 'ticket_id' not in data:
                return jsonify({'ok': False, 'error': 'Missing ticket_id'}), 400
            
            ticket_id = data['ticket_id']
            from shop_bot.data_manager.database import get_ticket_messages
            
            messages = get_ticket_messages(ticket_id)
            if not messages:
                history_text = "–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –ø—É—Å—Ç–∞."
            else:
                history_lines = []
                for m in messages:
                    sender = "Admin" if m['sender'] == 'admin' else "User"
                    content = m['content'] or ""
                    history_lines.append(f"{sender}: {content}")
                history_text = "\n".join(history_lines)

            current_text = data.get('current_text', '')

            api_key = get_setting('key_gemini')
            if not api_key:
                 return jsonify({'ok': False, 'error': 'API Key not configured'}), 400

            instruction_part = "–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–æ—Ç –∏–º–µ–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏) –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞."
            user_input_part = ""

            if current_text:
                user_input_part = f"–í–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: \"{current_text}\""
                instruction_part = "–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –û–¢–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ —ç—Ç–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫. –ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ –∏ —Å–¥–µ–ª–∞–π –µ–≥–æ –≤–µ–∂–ª–∏–≤—ã–º, –Ω–æ –°–¢–†–û–ì–û –°–û–•–†–ê–ù–ò –ö–†–ê–¢–ö–û–°–¢–¨ –ò –°–ú–´–°–õ. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —á–µ—Ä–Ω–æ–≤–∏–∫–µ."

            
            has_admin_reply = any(m.get('sender') == 'admin' for m in messages)
            
            greeting_rule = ""
            if not has_admin_reply:
                greeting_rule = "3. –≠–¢–û –ü–ï–†–í–´–ô –û–¢–í–ï–¢ –ê–î–ú–ò–ù–ê. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞—á–Ω–∏ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!' –∏–ª–∏ '–î–æ–±—Ä—ã–π –¥–µ–Ω—å!'."
            else:
                greeting_rule = "3. –ù–ò–ö–ê–ö–ò–• –ü–†–ò–í–ï–¢–°–¢–í–ò–ô (–ü—Ä–∏–≤–µ—Ç, –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ –∏ —Ç.–¥.) ‚Äî —Å—Ä–∞–∑—É –∫ –¥–µ–ª—É, —Ç–∞–∫ –∫–∞–∫ –¥–∏–∞–ª–æ–≥ —É–∂–µ –∏–¥–µ—Ç."

            system_prompt = (
                "–¢—ã –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ VPN-—Å–µ—Ä–≤–∏—Å–∞. "
                "–í–æ—Ç –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞:\n"
                f"{history_text}\n\n"
                
                "=== –°–¢–†–£–ö–¢–£–†–ê –°–ï–†–í–ò–°–ê ===\n"
                "–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–¥–µ–ª—ã:\n"
                "- üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é - –≤–æ–∑–≤—Ä–∞—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é\n"
                "- üë§ –ü—Ä–æ—Ñ–∏–ª—å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ –∏ –ø–æ–¥–ø–∏—Å–∫–µ\n"
                "- üõí –ö—É–ø–∏—Ç—å - –ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–∫—É–ø–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏\n"
                "- üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞ - –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É\n"
                "- üîë –ú–æ–∏ –∫–ª—é—á–∏ - –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
                "- ‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ\n\n"
                
                "=== –ü–û–ö–£–ü–ö–ê –ù–û–í–û–ì–û –ö–õ–Æ–ß–ê ===\n"
                "–†–∞–∑–¥–µ–ª '–ö—É–ø–∏—Ç—å' ‚Üí –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞ ‚Üí –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞\n"
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ:\n"
                "1. –í—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∏–ø —Å–µ—Ä–≤–µ—Ä–∞ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤)\n"
                "2. –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–∞ –Ω—É–∂–Ω—ã–π —Å—Ä–æ–∫ (–¥–æ—Å—Ç—É–ø–Ω—ã —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏)\n\n"
                
                "=== –ü–†–û–î–õ–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ö–õ–Æ–ß–ê ===\n"
                "–†–∞–∑–¥–µ–ª '–ú–æ–∏ –∫–ª—é—á–∏' ‚Üí –í—ã–±–æ—Ä –∫–ª—é—á–∞ ‚Üí '–ü—Ä–æ–¥–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á'\n"
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–∞ –Ω—É–∂–Ω—ã–π —Å—Ä–æ–∫ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.\n\n"
                
                "–†–ê–ó–î–ï–õ '–ú–û–ò –ö–õ–Æ–ß–ò' (–ú–û–ò –ü–û–î–ü–ò–°–ö–ò):\n"
                "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
                "- –ù–æ–º–µ—Ä –∫–ª—é—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, #1, #2)\n"
                "- –¢–∏–ø —Å–µ—Ä–≤–µ—Ä–∞\n"
                "- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤ –¥–Ω—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: 30 –¥–Ω–µ–π)\n"
                "- –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (‚úÖ –∞–∫—Ç–∏–≤–µ–Ω)\n"
                "–î–µ–π—Å—Ç–≤–∏—è:\n"
                "- üõí –ö—É–ø–∏—Ç—å –∫–ª—é—á - –ø–æ–∫—É–ø–∫–∞ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏\n"
                "- üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é\n\n"
                
                "–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–î–ü–ò–°–ö–ï (–ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª—é—á–∞):\n"
                "- üîë –ù–æ–º–µ—Ä –∫–ª—é—á–∞\n"
                "- üìÖ –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω: –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\n"
                "- ‚è± –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\n"
                "- üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É\n"
                "–î–µ–π—Å—Ç–≤–∏—è —Å –∫–ª—é—á–æ–º:\n"
                "- üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
                "- ‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏\n"
                "- üì± –ü–æ–∫–∞–∑–∞—Ç—å QR-–∫–æ–¥ - QR –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
                "- üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º\n"
                "- üîô –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–ª—é—á–µ–π\n\n"
                
                "–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Æ:\n"
                "–í—ã–±–æ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n"
                "- üì± Android\n"
                "- üçé iOS\n"
                "- üíª Windows\n"
                "- üêß Linux\n"
                "–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ VLESS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
                "- üîô –ù–∞–∑–∞–¥ –∫ –∫–ª—é—á—É\n\n"
                
                "–†–ê–ó–î–ï–õ '–ü–†–û–§–ò–õ–¨' –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:\n"
                "- üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (username)\n"
                "- üí∞ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ (–≤ RUB)\n"
                "- üìÖ –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ –º–µ—Å—è—Ü–µ–≤ (–æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)\n"
                "- ‚úÖ –°—Ç–∞—Ç—É—Å VPN (–ê–∫—Ç–∏–≤–µ–Ω/–ù–µ–∞–∫—Ç–∏–≤–µ–Ω)\n"
                "- ‚è± –û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–Ω–∏ –∏ —á–∞—Å—ã)\n"
                "- üíé –û—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å (–≤ RUB)\n"
                "- ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤)\n"
                "- üíµ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ —Ä–µ—Ñ–µ—Ä—Ä–∞–ª–∫–µ (–≤—Å–µ–≥–æ –≤ RUB)\n"
                "–î–µ–π—Å—Ç–≤–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ:\n"
                "- üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å - –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–æ–∫\n"
                "- ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n"
                "- üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é\n\n"
                
                "–ü–û–ü–û–õ–ù–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê:\n"
                "- –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: 200 RUB\n"
                "- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π\n"
                "- –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã - –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (–°–ë–ü/–ö–∞—Ä—Ç–∞, –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞, Telegram Stars)\n"
                "- –°—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ\n\n"
                
                f"{user_input_part}\n"
                f"{instruction_part}\n"
                "–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –ì–ï–ù–ï–†–ê–¶–ò–ò –û–¢–í–ï–¢–ê:\n"
                "1. –≠–¢–û –û–¢–í–ï–¢ –¢–ï–•–ù–ò–ß–ï–°–ö–û–ô –ü–û–î–î–ï–†–ñ–ö–ò –í TELEGRAM –ß–ê–¢–ï. –£—á–∏—Ç—ã–≤–∞–π —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –æ–±—â–µ–Ω–∏—è –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.\n"
                "2. –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ö–†–ê–¢–ö–û–°–¢–¨. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ–π ‚Äî –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –ù–ï –õ–ï–ô –í–û–î–£.\n"
                "3. –ù–ï –ü–û–í–¢–û–†–Ø–ô–°–Ø. –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –≤—ã—à–µ —É–∂–µ —Å–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç/–æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚Äî –Ω–µ –ø–∏—à–∏ —ç—Ç–æ —Å–Ω–æ–≤–∞. –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å—É—Ç–∏.\n"
                f"{greeting_rule}\n"
                "5. –°–¢–†–û–ì–û –ë–ï–ó –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown (**bold**, *italic*), HTML —Ç–µ–≥–∏. –ü–ò–®–ò –ü–†–û–°–¢–´–ú –¢–ï–ö–°–¢–û–ú.\n"
                "6. –°–¢–ò–õ–¨: –ñ–ò–í–û–ô, –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô, –ù–û –ü–†–û–°–¢–û–ô. –ü–∏—à–∏ –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ –∫–∞–∫ —Ä–æ–±–æ—Ç.\n"
                "7. –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–†–ò–°–õ–ê–õ –¢–ï–ö–°–¢ –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø: –ù–ï –£–í–ï–õ–ò–ß–ò–í–ê–ô –ï–ì–û –û–ë–™–ï–ú. –ü—Ä–æ—Å—Ç–æ –∏—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ –∏ —Å–¥–µ–ª–∞–π –≤–µ–∂–ª–∏–≤–µ–µ, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –∫—Ä–∞—Ç–∫–æ—Å—Ç—å.\n"
                "8. –ò–ó–ë–ï–ì–ê–ô '–ò–ò-–ú–ê–†–ö–ï–†–û–í': –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª–∏–Ω–Ω—ã–µ —Ç–∏—Ä–µ (‚Äî), —Å–ª–æ–∂–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã, –ª–∏—à–Ω–∏–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞.\n"
                "9. –≠–ú–û–î–ó–ò: –∏—Å–ø–æ–ª—å–∑—É–π —É–º–µ—Ä–µ–Ω–Ω–æ (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ), —Ç–æ–ª—å–∫–æ —Ç–∞–º –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ."
            )

            import httpx
            
            url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={api_key}"
            payload = {
                "contents": [{
                    "parts": [{"text": system_prompt}]
                }]
            }
            
            with httpx.Client(timeout=30.0) as client:
                resp = client.post(url, json=payload)
            
            if resp.status_code != 200:
                logger.error(f"Gemini API Error: {resp.status_code} {resp.text}")
                return jsonify({'ok': False, 'error': f'Gemini API Error: {resp.status_code}'}), 500
            
            resp_data = resp.json()
            
            try:
                candidates = resp_data.get('candidates', [])
                if not candidates:
                    return jsonify({'ok': False, 'error': 'No candidates returned'}), 500
                
                parts = candidates[0].get('content', {}).get('parts', [])
                if not parts:
                    return jsonify({'ok': False, 'error': 'No parts in content'}), 500
                    
                generated_text = parts[0].get('text', '')
                return jsonify({'ok': True, 'response': generated_text})
            except Exception as e:
                 logger.error(f"Error parsing Gemini response: {e}")
                 return jsonify({'ok': False, 'error': 'Failed to parse API response'}), 500

        except Exception as e:
            logger.error(f"Error generating Gemini response: {e}")
            return jsonify({'ok': False, 'error': str(e)}), 500
